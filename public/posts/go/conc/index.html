<!DOCTYPE html>
<html lang="zh-hans">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#494f5c">
	<meta name="msapplication-TileColor" content="#494f5c">
<meta itemprop="name" content="å‘ç°concå¹¶å‘åº“ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜">
<meta itemprop="description" content="ä¸Šå‘¨çœ‹åˆ°ä¸€ä¸ªæ–°åº“concï¼Œ
 better structured concurrency for go
 è¿™ä¸ªåº“çš„ç›®æ ‡æ˜¯ï¼Œ
 æ›´éš¾å‡ºç°goroutineæ³„æ¼ ä¼˜é›…å¤„ç†panic ä½¿å¹¶å‘çš„ä»£ç æ›´æ˜“è¯»  æˆ‘ä»¬ä¸€æ¡æ¡ç»†è¯´ã€‚
Make it harder to leak goroutines goroutineæ³„æ¼è¿˜æ˜¯å¾ˆå¸¸è§çš„ã€‚
æ—¥å¸¸æˆ‘ä»¬ä½¿ç”¨goçš„æ—¶å€™ç›´æ¥go funcå¼€å¯ä¸€ä¸ªgoroutineï¼Œå†™ä¸Šå¯¹åº”çš„é€»è¾‘ï¼Œgä¼šè¿›å…¥åˆ°æŸä¸ªpçš„æœ¬åœ°é˜Ÿåˆ—ï¼Œæœ€ç»ˆç”±pç»‘å®šçš„mæ‰§è¡Œè¿™ä¸ªgoroutineã€‚
ä½ èƒ½ä¿è¯ä¸€ä¸ªgoroutineåœ¨æŸä¸ªæ—¶åˆ»ä¸€å®šä¼šç»“æŸå®ƒçš„ç”Ÿå‘½å‘¨æœŸå—ï¼Ÿ
æœäº†ä¸‹è‘—åå¼€æºé¡¹ç›®etcdï¼Œgoroutine leakè¿˜çœŸä¸å°‘ã€‚
çœ‹å…¶ä¸­ä¸€ä¸ªç®€å•çš„æ³„æ¼bugã€‚
doneæ˜¯ä¸€ä¸ªæ— ç¼“å†²çš„chanï¼Œä¸€å¼€å§‹æ¥æ”¶åŠ¨ä½œåœ¨æœ€ä¸‹é¢ï¼Œå› ä¸ºä¸­é—´è¿˜æœ‰ä¸€äº›æ²¡å±•å¼€çš„ä»£ç å¯èƒ½ä¼šå¯¼è‡´ç¨‹åºä¸ä¼šæ‰§è¡Œåˆ°&lt;-doneï¼Œç„¶ågoroutineå°±ä¼šå‘ç”Ÿæ³„æ¼ï¼Œè§£å†³æ–¹æ³•å°±æ˜¯é€šè¿‡deferä¿è¯ä¸€å®šä¼šæ‰§è¡Œ&lt;-doneã€‚
é‚£ä¹ˆconcæ˜¯å¦‚ä½•åšçš„ï¼Ÿ
package main import ( &#34;fmt&#34; &#34;github.com/sourcegraph/conc&#34; ) func main() { var wg conc.WaitGroup wg.Go(func() { fmt.Println(&#34;g1&#34;) }) wg.Go(func() { fmt.Println(&#34;g2&#34;) }) wg.Wait() } ps:è¿™ä¸ªç»“æ„æ˜¯ä¸æ˜¯è¶…çº§ç†Ÿæ‚‰ã€‚
concçš„ç†å¿µæ˜¯ç¨‹åºä¸­çš„æ¯ä¸€ä¸ªgoroutineç”±ä¸€ä¸ªowneråˆ›å»ºï¼Œå½’å±äºownerã€‚ä¸€ä¸ªownerç¡®ä¿å®ƒæ‹¥æœ‰çš„æ‰€æœ‰goroutineæ­£å¸¸é€€å‡ºï¼Œè¿™é‡Œçš„ownerä¹Ÿå°±æ˜¯conc.WaitGroupã€‚
ä½†æ˜¯è¿™çœŸçš„èƒ½åƒä»–è¯´çš„é‚£æ ·Make it harder to leak goroutineså—ï¼Ÿ
goroutineçš„æ³„æ¼é—®é¢˜å–å†³äºç”¨æˆ·å¯¹goroutineèƒ½æ­£ç¡®é€€å‡ºçš„é€»è¾‘ä¿è¯ï¼Œå’Œä½ å¦‚ä½•å°è£…æ²¡å…³ç³»å§ï¼Ÿ
åœ¨æˆ‘çœ‹æ¥concå’Œæ ‡å‡†åº“çš„sync.WaitGroupä¸€æ ·ï¼Œç­‰å¾…æ‰€æœ‰goroutineæ‰§è¡Œå®Œæ¯•ï¼Œå¯ä»¥æ£€æµ‹åˆ°è¿™ä¸ªè¡Œä¸ºã€‚
è¦æ˜¯goroutineé‡Œé¢å«æœ‰æ³„æ¼çš„bugï¼Œè¯¥æ³„æ¼è¿˜å¾—æ³„æ¼ï¼ŒWaitè¯¥ç­‰å¾…è¿˜å¾—è€å®ç­‰å¾…ã€‚
Handle panics gracefully å¦‚æœç›´æ¥ä½¿ç”¨go func,é‚£ä¹ˆå¯èƒ½æ¯ä¸€ä¸ªgoroutineéƒ½å¾—å†™ä¸Šrecoverï¼Œæ‰€ä»¥ä¸€èˆ¬æˆ‘ä»¬åœ¨ä½¿ç”¨goroutineçš„æ—¶å€™ï¼Œéƒ½æ˜¯è‡ªå·±å°è£…ä¸€ä¸ªGoSafeå‡½æ•°ã€‚è¿™æ ·å°±å¯ä»¥åœ¨é‡Œé¢ç»Ÿä¸€æ•è·panicï¼Œç„¶åæ‰“åŒ…è°ƒç”¨æ ˆä¸€äº›ä¿¡æ¯ï¼Œè¿›ä¸€æ­¥å¤„ç†ã€‚
concé‡Œé¢å› ä¸ºæ¯ä¸ªgoroutineæœ‰owneræ¦‚å¿µï¼Œæ‰€ä»¥æ˜¯ç”±owneræ•è·goroutineçš„panicã€‚"><meta itemprop="datePublished" content="2023-01-10T18:23:51+08:00" />
<meta itemprop="dateModified" content="2023-01-10T18:23:51+08:00" />
<meta itemprop="wordCount" content="464">
<meta itemprop="keywords" content="go,conc," /><meta property="og:title" content="å‘ç°concå¹¶å‘åº“ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜" />
<meta property="og:description" content="ä¸Šå‘¨çœ‹åˆ°ä¸€ä¸ªæ–°åº“concï¼Œ
 better structured concurrency for go
 è¿™ä¸ªåº“çš„ç›®æ ‡æ˜¯ï¼Œ
 æ›´éš¾å‡ºç°goroutineæ³„æ¼ ä¼˜é›…å¤„ç†panic ä½¿å¹¶å‘çš„ä»£ç æ›´æ˜“è¯»  æˆ‘ä»¬ä¸€æ¡æ¡ç»†è¯´ã€‚
Make it harder to leak goroutines goroutineæ³„æ¼è¿˜æ˜¯å¾ˆå¸¸è§çš„ã€‚
æ—¥å¸¸æˆ‘ä»¬ä½¿ç”¨goçš„æ—¶å€™ç›´æ¥go funcå¼€å¯ä¸€ä¸ªgoroutineï¼Œå†™ä¸Šå¯¹åº”çš„é€»è¾‘ï¼Œgä¼šè¿›å…¥åˆ°æŸä¸ªpçš„æœ¬åœ°é˜Ÿåˆ—ï¼Œæœ€ç»ˆç”±pç»‘å®šçš„mæ‰§è¡Œè¿™ä¸ªgoroutineã€‚
ä½ èƒ½ä¿è¯ä¸€ä¸ªgoroutineåœ¨æŸä¸ªæ—¶åˆ»ä¸€å®šä¼šç»“æŸå®ƒçš„ç”Ÿå‘½å‘¨æœŸå—ï¼Ÿ
æœäº†ä¸‹è‘—åå¼€æºé¡¹ç›®etcdï¼Œgoroutine leakè¿˜çœŸä¸å°‘ã€‚
çœ‹å…¶ä¸­ä¸€ä¸ªç®€å•çš„æ³„æ¼bugã€‚
doneæ˜¯ä¸€ä¸ªæ— ç¼“å†²çš„chanï¼Œä¸€å¼€å§‹æ¥æ”¶åŠ¨ä½œåœ¨æœ€ä¸‹é¢ï¼Œå› ä¸ºä¸­é—´è¿˜æœ‰ä¸€äº›æ²¡å±•å¼€çš„ä»£ç å¯èƒ½ä¼šå¯¼è‡´ç¨‹åºä¸ä¼šæ‰§è¡Œåˆ°&lt;-doneï¼Œç„¶ågoroutineå°±ä¼šå‘ç”Ÿæ³„æ¼ï¼Œè§£å†³æ–¹æ³•å°±æ˜¯é€šè¿‡deferä¿è¯ä¸€å®šä¼šæ‰§è¡Œ&lt;-doneã€‚
é‚£ä¹ˆconcæ˜¯å¦‚ä½•åšçš„ï¼Ÿ
package main import ( &#34;fmt&#34; &#34;github.com/sourcegraph/conc&#34; ) func main() { var wg conc.WaitGroup wg.Go(func() { fmt.Println(&#34;g1&#34;) }) wg.Go(func() { fmt.Println(&#34;g2&#34;) }) wg.Wait() } ps:è¿™ä¸ªç»“æ„æ˜¯ä¸æ˜¯è¶…çº§ç†Ÿæ‚‰ã€‚
concçš„ç†å¿µæ˜¯ç¨‹åºä¸­çš„æ¯ä¸€ä¸ªgoroutineç”±ä¸€ä¸ªowneråˆ›å»ºï¼Œå½’å±äºownerã€‚ä¸€ä¸ªownerç¡®ä¿å®ƒæ‹¥æœ‰çš„æ‰€æœ‰goroutineæ­£å¸¸é€€å‡ºï¼Œè¿™é‡Œçš„ownerä¹Ÿå°±æ˜¯conc.WaitGroupã€‚
ä½†æ˜¯è¿™çœŸçš„èƒ½åƒä»–è¯´çš„é‚£æ ·Make it harder to leak goroutineså—ï¼Ÿ
goroutineçš„æ³„æ¼é—®é¢˜å–å†³äºç”¨æˆ·å¯¹goroutineèƒ½æ­£ç¡®é€€å‡ºçš„é€»è¾‘ä¿è¯ï¼Œå’Œä½ å¦‚ä½•å°è£…æ²¡å…³ç³»å§ï¼Ÿ
åœ¨æˆ‘çœ‹æ¥concå’Œæ ‡å‡†åº“çš„sync.WaitGroupä¸€æ ·ï¼Œç­‰å¾…æ‰€æœ‰goroutineæ‰§è¡Œå®Œæ¯•ï¼Œå¯ä»¥æ£€æµ‹åˆ°è¿™ä¸ªè¡Œä¸ºã€‚
è¦æ˜¯goroutineé‡Œé¢å«æœ‰æ³„æ¼çš„bugï¼Œè¯¥æ³„æ¼è¿˜å¾—æ³„æ¼ï¼ŒWaitè¯¥ç­‰å¾…è¿˜å¾—è€å®ç­‰å¾…ã€‚
Handle panics gracefully å¦‚æœç›´æ¥ä½¿ç”¨go func,é‚£ä¹ˆå¯èƒ½æ¯ä¸€ä¸ªgoroutineéƒ½å¾—å†™ä¸Šrecoverï¼Œæ‰€ä»¥ä¸€èˆ¬æˆ‘ä»¬åœ¨ä½¿ç”¨goroutineçš„æ—¶å€™ï¼Œéƒ½æ˜¯è‡ªå·±å°è£…ä¸€ä¸ªGoSafeå‡½æ•°ã€‚è¿™æ ·å°±å¯ä»¥åœ¨é‡Œé¢ç»Ÿä¸€æ•è·panicï¼Œç„¶åæ‰“åŒ…è°ƒç”¨æ ˆä¸€äº›ä¿¡æ¯ï¼Œè¿›ä¸€æ­¥å¤„ç†ã€‚
concé‡Œé¢å› ä¸ºæ¯ä¸ªgoroutineæœ‰owneræ¦‚å¿µï¼Œæ‰€ä»¥æ˜¯ç”±owneræ•è·goroutineçš„panicã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.syst.top/posts/go/conc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-10T18:23:51+08:00" />
<meta property="article:modified_time" content="2023-01-10T18:23:51+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="å‘ç°concå¹¶å‘åº“ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜"/>
<meta name="twitter:description" content="ä¸Šå‘¨çœ‹åˆ°ä¸€ä¸ªæ–°åº“concï¼Œ
 better structured concurrency for go
 è¿™ä¸ªåº“çš„ç›®æ ‡æ˜¯ï¼Œ
 æ›´éš¾å‡ºç°goroutineæ³„æ¼ ä¼˜é›…å¤„ç†panic ä½¿å¹¶å‘çš„ä»£ç æ›´æ˜“è¯»  æˆ‘ä»¬ä¸€æ¡æ¡ç»†è¯´ã€‚
Make it harder to leak goroutines goroutineæ³„æ¼è¿˜æ˜¯å¾ˆå¸¸è§çš„ã€‚
æ—¥å¸¸æˆ‘ä»¬ä½¿ç”¨goçš„æ—¶å€™ç›´æ¥go funcå¼€å¯ä¸€ä¸ªgoroutineï¼Œå†™ä¸Šå¯¹åº”çš„é€»è¾‘ï¼Œgä¼šè¿›å…¥åˆ°æŸä¸ªpçš„æœ¬åœ°é˜Ÿåˆ—ï¼Œæœ€ç»ˆç”±pç»‘å®šçš„mæ‰§è¡Œè¿™ä¸ªgoroutineã€‚
ä½ èƒ½ä¿è¯ä¸€ä¸ªgoroutineåœ¨æŸä¸ªæ—¶åˆ»ä¸€å®šä¼šç»“æŸå®ƒçš„ç”Ÿå‘½å‘¨æœŸå—ï¼Ÿ
æœäº†ä¸‹è‘—åå¼€æºé¡¹ç›®etcdï¼Œgoroutine leakè¿˜çœŸä¸å°‘ã€‚
çœ‹å…¶ä¸­ä¸€ä¸ªç®€å•çš„æ³„æ¼bugã€‚
doneæ˜¯ä¸€ä¸ªæ— ç¼“å†²çš„chanï¼Œä¸€å¼€å§‹æ¥æ”¶åŠ¨ä½œåœ¨æœ€ä¸‹é¢ï¼Œå› ä¸ºä¸­é—´è¿˜æœ‰ä¸€äº›æ²¡å±•å¼€çš„ä»£ç å¯èƒ½ä¼šå¯¼è‡´ç¨‹åºä¸ä¼šæ‰§è¡Œåˆ°&lt;-doneï¼Œç„¶ågoroutineå°±ä¼šå‘ç”Ÿæ³„æ¼ï¼Œè§£å†³æ–¹æ³•å°±æ˜¯é€šè¿‡deferä¿è¯ä¸€å®šä¼šæ‰§è¡Œ&lt;-doneã€‚
é‚£ä¹ˆconcæ˜¯å¦‚ä½•åšçš„ï¼Ÿ
package main import ( &#34;fmt&#34; &#34;github.com/sourcegraph/conc&#34; ) func main() { var wg conc.WaitGroup wg.Go(func() { fmt.Println(&#34;g1&#34;) }) wg.Go(func() { fmt.Println(&#34;g2&#34;) }) wg.Wait() } ps:è¿™ä¸ªç»“æ„æ˜¯ä¸æ˜¯è¶…çº§ç†Ÿæ‚‰ã€‚
concçš„ç†å¿µæ˜¯ç¨‹åºä¸­çš„æ¯ä¸€ä¸ªgoroutineç”±ä¸€ä¸ªowneråˆ›å»ºï¼Œå½’å±äºownerã€‚ä¸€ä¸ªownerç¡®ä¿å®ƒæ‹¥æœ‰çš„æ‰€æœ‰goroutineæ­£å¸¸é€€å‡ºï¼Œè¿™é‡Œçš„ownerä¹Ÿå°±æ˜¯conc.WaitGroupã€‚
ä½†æ˜¯è¿™çœŸçš„èƒ½åƒä»–è¯´çš„é‚£æ ·Make it harder to leak goroutineså—ï¼Ÿ
goroutineçš„æ³„æ¼é—®é¢˜å–å†³äºç”¨æˆ·å¯¹goroutineèƒ½æ­£ç¡®é€€å‡ºçš„é€»è¾‘ä¿è¯ï¼Œå’Œä½ å¦‚ä½•å°è£…æ²¡å…³ç³»å§ï¼Ÿ
åœ¨æˆ‘çœ‹æ¥concå’Œæ ‡å‡†åº“çš„sync.WaitGroupä¸€æ ·ï¼Œç­‰å¾…æ‰€æœ‰goroutineæ‰§è¡Œå®Œæ¯•ï¼Œå¯ä»¥æ£€æµ‹åˆ°è¿™ä¸ªè¡Œä¸ºã€‚
è¦æ˜¯goroutineé‡Œé¢å«æœ‰æ³„æ¼çš„bugï¼Œè¯¥æ³„æ¼è¿˜å¾—æ³„æ¼ï¼ŒWaitè¯¥ç­‰å¾…è¿˜å¾—è€å®ç­‰å¾…ã€‚
Handle panics gracefully å¦‚æœç›´æ¥ä½¿ç”¨go func,é‚£ä¹ˆå¯èƒ½æ¯ä¸€ä¸ªgoroutineéƒ½å¾—å†™ä¸Šrecoverï¼Œæ‰€ä»¥ä¸€èˆ¬æˆ‘ä»¬åœ¨ä½¿ç”¨goroutineçš„æ—¶å€™ï¼Œéƒ½æ˜¯è‡ªå·±å°è£…ä¸€ä¸ªGoSafeå‡½æ•°ã€‚è¿™æ ·å°±å¯ä»¥åœ¨é‡Œé¢ç»Ÿä¸€æ•è·panicï¼Œç„¶åæ‰“åŒ…è°ƒç”¨æ ˆä¸€äº›ä¿¡æ¯ï¼Œè¿›ä¸€æ­¥å¤„ç†ã€‚
concé‡Œé¢å› ä¸ºæ¯ä¸ªgoroutineæœ‰owneræ¦‚å¿µï¼Œæ‰€ä»¥æ˜¯ç”±owneræ•è·goroutineçš„panicã€‚"/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>å‘ç°concå¹¶å‘åº“ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜</title>
	<link rel="stylesheet" href="https://www.syst.top/css/style.min.cb0663fd19952012fdb4a1345792a808ae19eb828578bde6eeae217ff1fb1e8b.css">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp faster">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://www.syst.top">æ˜¯ä¸æ˜¯å¾ˆé…·</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					<a href="https://www.syst.top/posts/">æ–‡ç« </a>
					<a href="https://www.syst.top/leetcode/">åˆ·é¢˜</a>
					<a href="https://www.syst.top/lives/">ç”Ÿæ´»</a>
					<a href="https://www.syst.top/readings/">è¯»ä¹¦ç¬”è®°</a>
					<a href="https://www.syst.top/friends/">æœ‹å‹</a>
					<a href="https://go.aabbccm.com">grpc-shop</a>
				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<button id="toc-btn" class="hdr-btn desktop-only-ib" title="Table of Contents"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-list"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3" y2="6"></line><line x1="3" y1="12" x2="3" y2="12"></line><line x1="3" y1="18" x2="3" y2="18"></line></svg></button><span class="hdr-social hide-in-mobile"><a href="https://github.com/wuqinqiang" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></span><button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://www.syst.top/posts/">æ–‡ç« </a></li>
			<li><a href="https://www.syst.top/tags/">æ ‡ç­¾</a></li>
			<li><a href="https://www.syst.top/about/">å…³äº</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Jan 10, 2023</span></div>
				<h1>å‘ç°concå¹¶å‘åº“ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜</h1>
			</header>
			<div class="content">
				<p>ä¸Šå‘¨çœ‹åˆ°ä¸€ä¸ªæ–°åº“concï¼Œ</p>
<blockquote>
<p>better structured concurrency for go</p>
</blockquote>
<p>è¿™ä¸ªåº“çš„ç›®æ ‡æ˜¯ï¼Œ</p>
<ul>
<li>æ›´éš¾å‡ºç°goroutineæ³„æ¼</li>
<li>ä¼˜é›…å¤„ç†panic</li>
<li>ä½¿å¹¶å‘çš„ä»£ç æ›´æ˜“è¯»</li>
</ul>
<p>æˆ‘ä»¬ä¸€æ¡æ¡ç»†è¯´ã€‚</p>
<h4 id="make-it-harder-to-leak-goroutines">Make it harder to leak goroutines<a href="#make-it-harder-to-leak-goroutines" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>goroutineæ³„æ¼è¿˜æ˜¯å¾ˆå¸¸è§çš„ã€‚</p>
<p>æ—¥å¸¸æˆ‘ä»¬ä½¿ç”¨goçš„æ—¶å€™ç›´æ¥go funcå¼€å¯ä¸€ä¸ªgoroutineï¼Œå†™ä¸Šå¯¹åº”çš„é€»è¾‘ï¼Œgä¼šè¿›å…¥åˆ°æŸä¸ªpçš„æœ¬åœ°é˜Ÿåˆ—ï¼Œæœ€ç»ˆç”±pç»‘å®šçš„mæ‰§è¡Œè¿™ä¸ªgoroutineã€‚</p>
<p>ä½ èƒ½ä¿è¯ä¸€ä¸ªgoroutineåœ¨æŸä¸ªæ—¶åˆ»ä¸€å®šä¼šç»“æŸå®ƒçš„ç”Ÿå‘½å‘¨æœŸå—ï¼Ÿ</p>
<p>æœäº†ä¸‹è‘—åå¼€æºé¡¹ç›®etcdï¼Œgoroutine leakè¿˜çœŸä¸å°‘ã€‚</p>
<p><img src="https://cdn.syst.top/conc1.png" alt="conc"></p>
<p>çœ‹å…¶ä¸­ä¸€ä¸ªç®€å•çš„æ³„æ¼bugã€‚</p>
<p><img src="https://cdn.syst.top/conc2.png" alt="conc"></p>
<p>doneæ˜¯ä¸€ä¸ªæ— ç¼“å†²çš„chanï¼Œä¸€å¼€å§‹æ¥æ”¶åŠ¨ä½œåœ¨æœ€ä¸‹é¢ï¼Œå› ä¸ºä¸­é—´è¿˜æœ‰ä¸€äº›æ²¡å±•å¼€çš„ä»£ç å¯èƒ½ä¼šå¯¼è‡´ç¨‹åºä¸ä¼šæ‰§è¡Œåˆ°&lt;-doneï¼Œç„¶ågoroutineå°±ä¼šå‘ç”Ÿæ³„æ¼ï¼Œè§£å†³æ–¹æ³•å°±æ˜¯é€šè¿‡deferä¿è¯ä¸€å®šä¼šæ‰§è¡Œ&lt;-doneã€‚</p>
<p>é‚£ä¹ˆconcæ˜¯å¦‚ä½•åšçš„ï¼Ÿ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/sourcegraph/conc&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">wg</span> <span class="nx">conc</span><span class="p">.</span><span class="nx">WaitGroup</span>
</span></span><span class="line"><span class="cl">	<span class="nx">wg</span><span class="p">.</span><span class="nf">Go</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;g1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">wg</span><span class="p">.</span><span class="nf">Go</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;g2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ps:è¿™ä¸ªç»“æ„æ˜¯ä¸æ˜¯è¶…çº§ç†Ÿæ‚‰ã€‚</p>
<p>concçš„ç†å¿µæ˜¯ç¨‹åºä¸­çš„æ¯ä¸€ä¸ªgoroutineç”±ä¸€ä¸ªowneråˆ›å»ºï¼Œå½’å±äºownerã€‚ä¸€ä¸ªownerç¡®ä¿å®ƒæ‹¥æœ‰çš„æ‰€æœ‰goroutineæ­£å¸¸é€€å‡ºï¼Œè¿™é‡Œçš„ownerä¹Ÿå°±æ˜¯conc.WaitGroupã€‚</p>
<p>ä½†æ˜¯è¿™çœŸçš„èƒ½åƒä»–è¯´çš„é‚£æ ·Make it harder to leak goroutineså—ï¼Ÿ</p>
<p>goroutineçš„æ³„æ¼é—®é¢˜å–å†³äºç”¨æˆ·å¯¹goroutineèƒ½æ­£ç¡®é€€å‡ºçš„é€»è¾‘ä¿è¯ï¼Œå’Œä½ å¦‚ä½•å°è£…æ²¡å…³ç³»å§ï¼Ÿ</p>
<p>åœ¨æˆ‘çœ‹æ¥concå’Œæ ‡å‡†åº“çš„sync.WaitGroupä¸€æ ·ï¼Œç­‰å¾…æ‰€æœ‰goroutineæ‰§è¡Œå®Œæ¯•ï¼Œå¯ä»¥æ£€æµ‹åˆ°è¿™ä¸ªè¡Œä¸ºã€‚</p>
<p>è¦æ˜¯goroutineé‡Œé¢å«æœ‰æ³„æ¼çš„bugï¼Œè¯¥æ³„æ¼è¿˜å¾—æ³„æ¼ï¼ŒWaitè¯¥ç­‰å¾…è¿˜å¾—è€å®ç­‰å¾…ã€‚</p>
<h4 id="handle-panics-gracefully">Handle panics gracefully<a href="#handle-panics-gracefully" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>å¦‚æœç›´æ¥ä½¿ç”¨go func,é‚£ä¹ˆå¯èƒ½æ¯ä¸€ä¸ªgoroutineéƒ½å¾—å†™ä¸Šrecoverï¼Œæ‰€ä»¥ä¸€èˆ¬æˆ‘ä»¬åœ¨ä½¿ç”¨goroutineçš„æ—¶å€™ï¼Œéƒ½æ˜¯è‡ªå·±å°è£…ä¸€ä¸ªGoSafeå‡½æ•°ã€‚è¿™æ ·å°±å¯ä»¥åœ¨é‡Œé¢ç»Ÿä¸€æ•è·panicï¼Œç„¶åæ‰“åŒ…è°ƒç”¨æ ˆä¸€äº›ä¿¡æ¯ï¼Œè¿›ä¸€æ­¥å¤„ç†ã€‚</p>
<p>concé‡Œé¢å› ä¸ºæ¯ä¸ªgoroutineæœ‰owneræ¦‚å¿µï¼Œæ‰€ä»¥æ˜¯ç”±owneræ•è·goroutineçš„panicã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Catcher</span><span class="p">)</span> <span class="nf">tryRecover</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">val</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">();</span> <span class="nx">val</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rp</span> <span class="o">:=</span> <span class="nf">NewRecoveredPanic</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">p</span><span class="p">.</span><span class="nx">recovered</span><span class="p">.</span><span class="nf">CompareAndSwap</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">rp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>åªä¼šè®°å½•ç¬¬ä¸€ä¸ªpanicçš„goroutineå †æ ˆä¿¡æ¯ã€‚ç„¶ååœ¨Waitæ“ä½œçš„æ—¶å€™ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">WaitGroup</span><span class="p">)</span> <span class="nf">Wait</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">h</span><span class="p">.</span><span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Propagate a panic if we caught one from a child goroutine.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">h</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nf">Repanic</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Catcher</span><span class="p">)</span> <span class="nf">Repanic</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">val</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">Recovered</span><span class="p">();</span> <span class="nx">val</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nb">panic</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¶…çº§ç²—æš´ã€‚å½“conc.WaitGroupé‡Œé¢ä»»ä½•ä¸€ä¸ªgoroutineå‘ç”Ÿpanicï¼Œè°ƒç”¨wg.Wait()çš„æ—¶å€™å°±ä¼španicï¼ŒæŠŠgoroutine panicçš„å †æ ˆä¿¡æ¯ä½œä¸ºpanicçš„å€¼ã€‚</p>
<p>å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™å·²ç»çœ‹åˆ°ä»–ä»¬åœ¨issueä¸Šè®¨è®ºæ·»åŠ ä¸€ä¸ªç±»ä¼¼WaitSafe()å‡½æ•°äº†ã€‚</p>
<h4 id="make-concurrent-code-easier-to-read">Make concurrent code easier to read<a href="#make-concurrent-code-easier-to-read" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>è¿™ä¸ªè¿˜æ˜¯èŠ‚çœäº†ä¸€äº›å·¥ä½œçš„ï¼Œä½œè€…ç»™äº†å‡ ä¸ªä¾‹å­ã€‚</p>
<p>ä¸Šé¢æˆ‘ä»¬çœ‹åˆ°çš„WaitGroupï¼Œä¸å†éœ€è¦ç”¨æˆ·æ‰§è¡ŒAddå’ŒDoneæ“ä½œäº†ã€‚åŒæ—¶å†…éƒ¨æ•è·panicï¼Œè™½ç„¶å¤„ç†æœ‰ç‚¹ç²—æš´ã€‚</p>
<p><img src="https://cdn.syst.top/conc3.png" alt="conc"></p>
<p>æ¯”å¦‚æ§åˆ¶å¹¶å‘goroutineæ•°é‡æ¥å¹¶å‘å¤„ç†æ‰¹é‡æ•°æ®çš„ä¾‹å­ã€‚</p>
<p><img src="https://cdn.syst.top/conc4.png" alt="conc"></p>
<p><img src="https://cdn.syst.top/conc5.png" alt="conc"></p>
<p>å¯ä»¥çœ‹å‡ºï¼Œç¡®å®çœäº†å¾ˆå¤šçš„æ“ä½œï¼Œå…¶ä»–ä¾‹å­å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹ã€‚</p>
<p>ä¸Šé¢æˆ‘ä»¬è¯´åˆ°poolï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªå¹¶å‘æ‰§è¡Œä»»åŠ¡çš„workeræ± ï¼Œä¹‹å‰æ–‡ç« ä¹Ÿä»‹ç»è¿‡è¿™ç§æ¨¡å¼ã€‚</p>
<p>concé‡Œé¢æœ‰å‡ ä¸ªç±»å‹çš„pool:ContextPoolï¼ŒErrorPoolï¼ŒResultPoolï¼ŒResultContextPoolï¼ŒResultErrorPoolã€‚</p>
<p>å®ƒä»¬éƒ½åŸºäºæœ€åŸºç¡€çš„Poolç»“æ„ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Pool</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">handle</span>   <span class="nx">conc</span><span class="p">.</span><span class="nx">WaitGroup</span>
</span></span><span class="line"><span class="cl">	<span class="nx">limiter</span>  <span class="nx">limiter</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tasks</span>    <span class="kd">chan</span> <span class="kd">func</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">initOnce</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Once</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>limiterå°±æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„ç”¨chanæ§åˆ¶worker goroutineæ•°é‡ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">limiter</span> <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="nx">limiter</span><span class="p">)</span> <span class="nf">limit</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">cap</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="nx">limiter</span><span class="p">)</span> <span class="nf">release</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">l</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="o">&lt;-</span><span class="nx">l</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æ ¸å¿ƒé€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Pool</span><span class="p">)</span> <span class="nf">Go</span><span class="p">(</span><span class="nx">f</span> <span class="kd">func</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">p</span><span class="p">.</span><span class="nf">init</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">limiter</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// No limit on the number of goroutines.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">p</span><span class="p">.</span><span class="nx">tasks</span> <span class="o">&lt;-</span> <span class="nx">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// A goroutine was available to handle the task.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// No goroutine was available to handle the task.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// Spawn a new one and send it the task.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">p</span><span class="p">.</span><span class="nx">handle</span><span class="p">.</span><span class="nf">Go</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">worker</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">p</span><span class="p">.</span><span class="nx">tasks</span> <span class="o">&lt;-</span> <span class="nx">f</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">p</span><span class="p">.</span><span class="nx">limiter</span> <span class="o">&lt;-</span> <span class="kd">struct</span><span class="p">{}{}:</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// If we are below our limit, spawn a new worker rather
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// than waiting for one to become available.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">p</span><span class="p">.</span><span class="nx">handle</span><span class="p">.</span><span class="nf">Go</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">worker</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// We know there is at least one worker running, so wait
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// for it to become available. This ensures we never spawn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// more workers than the number of tasks.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">p</span><span class="p">.</span><span class="nx">tasks</span> <span class="o">&lt;-</span> <span class="nx">f</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">p</span><span class="p">.</span><span class="nx">tasks</span> <span class="o">&lt;-</span> <span class="nx">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// A worker is available and has accepted the task.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å¦‚æœæ²¡æœ‰è®¾ç½®limiterï¼Œé‚£ä¹ˆä¼˜å…ˆæ‰¾ç©ºé—²çš„workerã€‚å¦åˆ™å°±åˆ›å»ºä¸€ä¸ªæ–°workerï¼Œç„¶åæŠ•é€’ä»»åŠ¡è¿›å»ã€‚</p>
<p>è®¾ç½®äº†limiterï¼Œ</p>
<p>å¦‚æœè¾¾åˆ°äº†limter workeræ•°é‡ä¸Šé™ï¼Œé‚£å°±åªèƒ½æŠŠä»»åŠ¡æŠ•é€’ç»™ç©ºé—²çš„workerï¼Œæ²¡æœ‰ç©ºé—²å°±é˜»å¡ç­‰ç€ã€‚</p>
<p>æ²¡æœ‰è¾¾åˆ°ä¸Šé™ï¼Œç©ºé—²workerä¹Ÿå­˜åœ¨ï¼Œé‚£å°±ç”±selectéšæœºé€‰æ‹©ï¼Œå¦åˆ™çš„è¯å°±åˆ›å»ºä¸€ä¸ªæ–°çš„workerã€‚</p>
<h4 id="å½©è›‹">å½©è›‹<a href="#å½©è›‹" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>çœ‹ä»£ç çš„æ—¶å€™å‘ç°è¿™é‡Œé¢æœ‰ä¸ªé—®é¢˜ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Pool</span><span class="p">)</span> <span class="nf">deref</span><span class="p">()</span> <span class="nx">Pool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">Pool</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">limiter</span><span class="p">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">limiter</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¿™ä¸ªå‡½æ•°ä¼šè¿”å›ä¸€ä¸ªæ–°çš„Poolï¼Œä¸Šé¢æˆ‘è¯´è¿‡limiteræ˜¯ä¸€ä¸ªchanç»“æ„ï¼Œåœ¨goä¸­chanæ˜¯ä¸€ä¸ªå¼•ç”¨ç±»å‹ï¼Œæ‰€ä»¥è¿™é‡Œå¯¹limiterå°±æ˜¯ä¸€ä¸ªæµ…æ‹·è´ã€‚</p>
<p>å› æ­¤ï¼Œä¸‹é¢è¿™æ®µä»£ç ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">TestErrorPool</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">p</span> <span class="o">:=</span> <span class="nf">New</span><span class="p">().</span><span class="nf">WithMaxGoroutines</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">p</span><span class="p">.</span><span class="nf">Go</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{})</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//p.limiteré•¿åº¦æ˜¯1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">require</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">limiter</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">  <span class="c1">//æ–°çš„ErrorPool:é‡Œé¢çš„poolæ˜¯è°ƒç”¨p.derefå¾—åˆ°çš„.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">ep</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">WithErrors</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">require</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">ep</span><span class="p">.</span><span class="nx">pool</span><span class="p">.</span><span class="nx">limiter</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">  <span class="c1">//è¿™é‡Œçš„ep.limiterçš„é•¿åº¦ä¹Ÿæ˜¯1ï¼Œå°½ç®¡epæ²¡æœ‰è°ƒç”¨ä¸€æ¬¡ep.Go()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>æ­£å› ä¸ºè¿™ç§â€œç‰¹æ€§â€,å¦‚æœæˆ‘ä»¬å†™äº†ä¸‹é¢çš„ä»£ç ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">p</span> <span class="o">:=</span> <span class="nx">pool</span><span class="p">.</span><span class="nf">New</span><span class="p">().</span><span class="nf">WithMaxGoroutines</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">p</span><span class="p">.</span><span class="nf">Go</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;g1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">p</span><span class="p">.</span><span class="nf">Go</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;g2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//p.Wait()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">ep</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">WithErrors</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ep</span><span class="p">.</span><span class="nf">Go</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//è¿™æ®µä»£ç æ°¸è¿œæ²¡æœºä¼šæ‰§è¡Œ,æ³„æ¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;with err &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ep</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// å¦‚æœæˆ‘ä»¬æŠŠp.Wait() æ”¾åœ¨ep.Wait()ä¹‹å
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">p</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ep.Goé‡Œé¢çš„é€»è¾‘æ°¸è¿œéƒ½æ²¡æœºä¼šæ‰§è¡Œã€‚</p>
<p>åŸå› å°±åœ¨äºï¼Œç¬¬ä¸€ä¸ªloopåˆ›å»ºçš„æ—¶å€™é™åˆ¶äº†goroutineæ•°é‡ã€‚ç„¶åæ‰§è¡Œä¸¤æ¬¡p.Goï¼Œè¿™æ ·å°±ä¼šåˆ›å»ºä¸¤ä¸ªåªå±äºpçš„workersï¼ŒåŒæ—¶ä¹Ÿè®©limiteråˆ°è¾¾é™åˆ¶æ•°ã€‚</p>
<p>å½“epæƒ³è¦æ‰§è¡Œep.Goçš„æ—¶å€™ï¼Œåªèƒ½æ‰§è¡Œp.tasks &lt;- fï¼Œä½†æ˜¯è¿™æ—¶å€™epè¿˜æ²¡æœ‰æœºä¼šåˆ›å»ºå±äºè‡ªå·±çš„workerï¼Œæ‰€ä»¥ä¼šé˜»å¡åˆ°æ­»ã€‚</p>
<p>æˆ‘æäº†ä¸€ä¸ªprï¼Œå…¶å®å°±æ˜¯æŠŠä¸Šé¢çš„æµ…æ‹·è´æ¢æˆæ·±æ‹·è´ã€‚</p>
<p><img src="https://cdn.syst.top/conc6.png" alt="conc"></p>
<p>ä½†æ˜¯ä½œè€…å›å¤è¯´ï¼Œ</p>
<blockquote>
<p>Currently calling any configuration methods on the pool after calling pool.Go() is unsupported because the configuration methods take ownership of and mutate the pool. This might not be ideal though since ownership can&rsquo;t actually be enforced with Go. It would be less of a footgun to just return a fully copy each time.</p>
</blockquote>
<p>æˆ‘ç†è§£çš„æ„æ€å°±æ˜¯ç›®å‰ä¸æ”¯æŒæˆ‘è¿™ä¹ˆç©ï¼Œç®€å•çš„è¯´ä¸æ”¯æŒåœ¨æ‰§è¡Œpool.Go()åè°ƒç”¨è¿™äº›æ“ä½œğŸ˜‚ã€‚</p>

			</div>
			<div class="content"><br><img src="https://cdn.syst.top/wechat2.png"></div>
			<hr class="post-end">
			<footer class="post-info">
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://www.syst.top/tags/go">go</a></span><span class="tag"><a href="https://www.syst.top/tags/conc">conc</a></span>
				</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>464 Words</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2023-01-10 18:23 &#43;0800</p>
			</footer>
		</article>
		<aside id="toc" class="show-toc">
			<div class="toc-title">Table of Contents</div>
			<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>
</nav>
		</aside>
		<div class="post-nav thin">
			<a class="next-post" href="https://www.syst.top/posts/go/helloword/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;Newer</span><br><span>HelloWordä¸€ä¸ªgoå¼€å‘çš„å­¦ä¹ è‹±è¯­å•è¯å·¥å…·</span>
			</a>
			<a class="prev-post" href="https://www.syst.top/posts/go/evio/">
				<span class="post-nav-label">Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>evioåŸç†è§£æï½æœ‰å½©è›‹</span>
			</a>
		</div>
		<div id="comments" class="thin">
			<script src="https://utteranc.es/client.js"
        repo="wuqinqiang/blog"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
		</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2018 - 2024 <a href="https://www.syst.top">Remember</a> &#183; <a href="http://beian.miit.gov.cn/">æµ™ICPå¤‡18028603å·-2</a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://www.syst.top/post/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>


	<script src="https://www.syst.top/js/main.min.c8a831e54547e9c081939713d77308bf58ae5fed99a75acbcaaa14c5ce45bf89.js"></script>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-166045776-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</body>

</html>

<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
	<channel>
		<title>Posts on æ˜¯ä¸æ˜¯å¾ˆé…·</title>
		<link>https://www.syst.top/posts/</link>
		<description>Recent content in Posts on æ˜¯ä¸æ˜¯å¾ˆé…·</description>
		<generator>Hugo -- gohugo.io</generator>
		<language>zh-hans</language>
		<copyright>This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</copyright>
		<lastBuildDate>Thu, 23 Feb 2023 23:23:51 +0800</lastBuildDate>
		<atom:link href="https://www.syst.top/posts/index.xml" rel="self" type="application/rss+xml" />
		
		<item>
			<title>nbioåŸç†è§£æ</title>
			<link>https://www.syst.top/posts/go/nbio/</link>
			<pubDate>Thu, 23 Feb 2023 23:23:51 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/nbio/</guid>
			<description>ä¹‹å‰æ›´æ–°çš„ä¸€ç³»åˆ—ï¼Œå¥½ä¹…æ²¡æ›´æ–°äº†ï¼Œå·®ç‚¹çƒ‚å°¾ï¼Œæˆ‘ä¸å…è®¸è¿™æ ·çš„äº‹æƒ…åœ¨æˆ‘èº«ä¸Šå‘ç”Ÿ(è™½ç„¶å·²ç»çƒ‚å°¾å¥½å‡ æ¬¡äº†ğŸ˜­)ã€‚
ä¸Šä¸€ç¯‡æ–‡ç« æˆ‘ä»¬ä»‹ç»äº†evioï¼Œå®ƒåº”è¯¥æ˜¯æœ€æ—©åŸºäºepollå®ç°çš„Go Netpollæ¡†æ¶ï¼Œæˆ‘ä»¬ä¹Ÿæåˆ°å®ƒå­˜åœ¨çš„ä¸€äº›é—®é¢˜ï¼Œè¿™ç¯‡æ–‡ç« æˆ‘ä»¬ç»§ç»­åˆ†æå…¶ä»–çš„å®ç°æ¡†æ¶: nbioã€‚
nbioé¡¹ç›®é‡Œä¹ŸåŒ…å«äº†åœ¨nbioä¹‹ä¸Šæ„å»ºçš„nbhttpï¼Œè¿™ä¸ªä¸åœ¨æˆ‘ä»¬è®¨è®ºèŒƒå›´ã€‚
nbioä½¿ç”¨çš„ä¹Ÿæ˜¯ç»å…¸çš„Reactoræ¨¡å¼ï¼Œgoçš„è¿™å‡ ä¸ªå¼‚æ­¥ç½‘ç»œæ¡†æ¶éƒ½æ˜¯Reactoræ¨¡å¼ã€‚
è€è§„çŸ©ï¼Œå…ˆè¿è¡Œnbioç¨‹åºä»£ç ï¼Œ
Server:
package main import ( &amp;#34;fmt&amp;#34; &amp;#34;github.com/lesismal/nbio&amp;#34; ) func main() { g := nbio.NewGopher(nbio.Config{ Network: &amp;#34;tcp&amp;#34;, Addrs: []string{&amp;#34;:8888&amp;#34;}, MaxWriteBufferSize: 6 * 1024 * 1024, }) g.OnData(func(c *nbio.Conn, data []byte) { c.Write(append([]byte{}, data...)) }) err := g.Start() if err != nil { fmt.Printf(&amp;#34;nbio.Start failed: %v\n&amp;#34;, err) return } defer g.Stop() g.Wait() } ä½¿ç”¨nbio.NewGopher()å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„Engineå®ä¾‹ã€‚ä¼ å…¥nbio.Configç»“æ„ä½“æ¥é…ç½® Engine å®ä¾‹ï¼ŒåŒ…æ‹¬ï¼š
 Network: ä½¿ç”¨çš„ç½‘ç»œç±»å‹ï¼Œè¿™é‡Œæ˜¯tcpã€‚ Addrs: æœåŠ¡å™¨è¦ç›‘å¬çš„åœ°å€å’Œç«¯å£ï¼Œè¿™é‡Œæ˜¯ &amp;ldquo;:8888&amp;rdquo;ï¼ˆå³ç›‘å¬æœ¬æœºçš„8888ç«¯å£ï¼‰ã€‚ MaxWriteBufferSize: å†™ç¼“å†²åŒºçš„æœ€å¤§å¤§å°ï¼Œè¿™é‡Œè®¾ç½®ä¸º 6MBã€‚  å…¶ä»–é…ç½®å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹ã€‚ç„¶åä½¿ç”¨g.</description>
			<content type="html"><![CDATA[<p>ä¹‹å‰æ›´æ–°çš„ä¸€ç³»åˆ—ï¼Œå¥½ä¹…æ²¡æ›´æ–°äº†ï¼Œå·®ç‚¹çƒ‚å°¾ï¼Œæˆ‘ä¸å…è®¸è¿™æ ·çš„äº‹æƒ…åœ¨æˆ‘èº«ä¸Šå‘ç”Ÿ(è™½ç„¶å·²ç»çƒ‚å°¾å¥½å‡ æ¬¡äº†ğŸ˜­)ã€‚</p>
<p>ä¸Šä¸€ç¯‡æ–‡ç« æˆ‘ä»¬ä»‹ç»äº†evioï¼Œå®ƒåº”è¯¥æ˜¯æœ€æ—©åŸºäºepollå®ç°çš„Go Netpollæ¡†æ¶ï¼Œæˆ‘ä»¬ä¹Ÿæåˆ°å®ƒå­˜åœ¨çš„ä¸€äº›é—®é¢˜ï¼Œè¿™ç¯‡æ–‡ç« æˆ‘ä»¬ç»§ç»­åˆ†æå…¶ä»–çš„å®ç°æ¡†æ¶: nbioã€‚</p>
<p>nbioé¡¹ç›®é‡Œä¹ŸåŒ…å«äº†åœ¨nbioä¹‹ä¸Šæ„å»ºçš„nbhttpï¼Œè¿™ä¸ªä¸åœ¨æˆ‘ä»¬è®¨è®ºèŒƒå›´ã€‚</p>
<p>nbioä½¿ç”¨çš„ä¹Ÿæ˜¯ç»å…¸çš„Reactoræ¨¡å¼ï¼Œgoçš„è¿™å‡ ä¸ªå¼‚æ­¥ç½‘ç»œæ¡†æ¶éƒ½æ˜¯Reactoræ¨¡å¼ã€‚</p>
<p>è€è§„çŸ©ï¼Œå…ˆè¿è¡Œnbioç¨‹åºä»£ç ï¼Œ</p>
<p>Server:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/lesismal/nbio&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">g</span> <span class="o">:=</span> <span class="nx">nbio</span><span class="p">.</span><span class="nf">NewGopher</span><span class="p">(</span><span class="nx">nbio</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Network</span><span class="p">:</span>            <span class="s">&#34;tcp&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Addrs</span><span class="p">:</span>              <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;:8888&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">MaxWriteBufferSize</span><span class="p">:</span> <span class="mi">6</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">g</span><span class="p">.</span><span class="nf">OnData</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">nbio</span><span class="p">.</span><span class="nx">Conn</span><span class="p">,</span> <span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nb">append</span><span class="p">([]</span><span class="kt">byte</span><span class="p">{},</span> <span class="nx">data</span><span class="o">...</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">g</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;nbio.Start failed: %v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">g</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">g</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ä½¿ç”¨nbio.NewGopher()å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„Engineå®ä¾‹ã€‚ä¼ å…¥nbio.Configç»“æ„ä½“æ¥é…ç½® Engine å®ä¾‹ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>Network: ä½¿ç”¨çš„ç½‘ç»œç±»å‹ï¼Œè¿™é‡Œæ˜¯tcpã€‚</li>
<li>Addrs: æœåŠ¡å™¨è¦ç›‘å¬çš„åœ°å€å’Œç«¯å£ï¼Œè¿™é‡Œæ˜¯ &ldquo;:8888&rdquo;ï¼ˆå³ç›‘å¬æœ¬æœºçš„8888ç«¯å£ï¼‰ã€‚</li>
<li>MaxWriteBufferSize: å†™ç¼“å†²åŒºçš„æœ€å¤§å¤§å°ï¼Œè¿™é‡Œè®¾ç½®ä¸º 6MBã€‚</li>
</ul>
<p>å…¶ä»–é…ç½®å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹ã€‚ç„¶åä½¿ç”¨g.OnData()æ–¹æ³•ä¸º Engineå®ä¾‹æ³¨å†Œä¸€ä¸ªæ•°æ®æ¥æ”¶å›è°ƒå‡½æ•°ã€‚è¿™ä¸ªå›è°ƒå‡½æ•°åœ¨æ”¶åˆ°æ•°æ®æ—¶è¢«è°ƒç”¨ã€‚å›è°ƒå‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼šè¿æ¥å¯¹è±¡cå’Œæ”¶åˆ°çš„æ•°æ® dataã€‚åœ¨å›è°ƒå‡½æ•°å†…éƒ¨ï¼Œæˆ‘ä»¬ä½¿ç”¨c.Write()æ–¹æ³•å°†æ”¶åˆ°çš„æ•°æ®åŸæ ·å†™å›ç»™å®¢æˆ·ç«¯ã€‚</p>
<p>Client:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;bytes&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;math/rand&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/lesismal/nbio&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/lesismal/nbio/logging&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ret</span>    <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">		<span class="nx">buf</span>    <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">addr</span>   <span class="p">=</span> <span class="s">&#34;localhost:8888&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ctx</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="mi">60</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">logging</span><span class="p">.</span><span class="nf">SetLevel</span><span class="p">(</span><span class="nx">logging</span><span class="p">.</span><span class="nx">LevelInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">rand</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">g</span> <span class="o">:=</span> <span class="nx">nbio</span><span class="p">.</span><span class="nf">NewGopher</span><span class="p">(</span><span class="nx">nbio</span><span class="p">.</span><span class="nx">Config</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">done</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">g</span><span class="p">.</span><span class="nf">OnData</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">nbio</span><span class="p">.</span><span class="nx">Conn</span><span class="p">,</span> <span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ret</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">ret</span><span class="p">,</span> <span class="nx">data</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">ret</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="nx">ret</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nb">close</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">g</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Start failed: %v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">g</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">nbio</span><span class="p">.</span><span class="nf">Dial</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Dial failed: %v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">g</span><span class="p">.</span><span class="nf">AddConn</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">		<span class="nx">logging</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;timeout&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">done</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">logging</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;success&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ä¹ä¸€çœ‹æœ‰ç‚¹éº»çƒ¦ã€‚å…¶å®æ˜¯æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å…±ç”¨äº†ä¸€å¥—ç»“æ„ã€‚</p>
<p>å®¢æˆ·ç«¯é€šè¿‡nbio.Dialè¿æ¥æœåŠ¡ç«¯ï¼Œè¿æ¥æˆåŠŸå°è£…æˆnbio.Connï¼Œè¿™é‡Œçš„nbio.Connæ˜¯å®ç°äº†æ ‡å‡†åº“çš„net.Conn æ¥å£çš„ã€‚æœ€åAddConnè¿™ä¸ªconnã€‚è°ƒç”¨Writeå¾€æœåŠ¡ç«¯å†™æ•°æ®ï¼Œå½“æœåŠ¡ç«¯æ¥æ”¶åˆ°æ•°æ®åï¼ŒServerç«¯çš„å¤„ç†é€»è¾‘æ˜¯æŠŠæ•°æ®åŸæ ·å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå½“å®¢æˆ·ç«¯æ¥æ”¶åˆ°æ•°æ®ä¸€æ ·OnDataä¼šè¢«å›è°ƒï¼Œä¸Šé¢OnDataåˆ¤æ–­æ¥å—åˆ°çš„æ•°æ®å’Œå‘é€çš„æ•°æ®æ˜¯ä¸æ˜¯é•¿åº¦ä¸€æ ·ï¼Œæœ€åå®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­è¿™ä¸ªè¿æ¥ã€‚</p>
<p>ä¸‹é¢æ¥çœ‹å‡ ä¸ªä¸»è¦ç»“æ„ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Engine</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">//..
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//..
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="nx">mux</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">wgConn</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">network</span>   <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nx">addrs</span>     <span class="p">[]</span><span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nx">listen</span>    <span class="kd">func</span><span class="p">(</span><span class="nx">network</span><span class="p">,</span> <span class="nx">addr</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">pollerNum</span>                    <span class="kt">int</span>
</span></span><span class="line"><span class="cl">	<span class="nx">readBufferSize</span>               <span class="kt">int</span>
</span></span><span class="line"><span class="cl">	<span class="nx">maxWriteBufferSize</span>           <span class="kt">int</span>
</span></span><span class="line"><span class="cl">	<span class="nx">maxConnReadTimesPerEventLoop</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">	<span class="nx">udpReadTimeout</span>               <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>
</span></span><span class="line"><span class="cl">	<span class="nx">epollMod</span>                     <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span><span class="p">..</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">connsStd</span>  <span class="kd">map</span><span class="p">[</span><span class="o">*</span><span class="nx">Conn</span><span class="p">]</span><span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">connsUnix</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Conn</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">listeners</span> <span class="p">[]</span><span class="o">*</span><span class="nx">poller</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pollers</span>   <span class="p">[]</span><span class="o">*</span><span class="nx">poller</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">onOpen</span>            <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">onClose</span>           <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">onRead</span>            <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">onData</span>            <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">,</span> <span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">onReadBufferAlloc</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">	<span class="nx">onReadBufferFree</span>  <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">,</span> <span class="nx">buffer</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>Engineæœ¬è´¨ä¸Šå°±æ˜¯æ ¸å¿ƒç®¡ç†å™¨ã€‚ä¼šç®¡ç†æ‰€æœ‰çš„listener poller å’Œworker pollerã€‚</p>
<p>è¿™ä¸¤ç§polleræœ‰ä»€ä¹ˆåŒºåˆ«å—ï¼Ÿ</p>
<p>åŒºåˆ«åœ¨èŒè´£ä¸Šã€‚</p>
<p>listener polleråªè´Ÿè´£acceptæ–°çš„è¿æ¥ï¼Œå½“ä¸€ä¸ªæ–°çš„å®¢æˆ·ç«¯connåˆ°æ¥æ—¶ï¼Œä¼šä»pollersæŒ‘é€‰ä¸€ä¸ªworker pollerï¼Œç„¶åæŠŠconnåŠ å…¥åˆ°å¯¹åº”çš„worker pollerï¼Œä¹‹åworker pollerè´Ÿè´£å¤„ç†æ­¤connçš„è¯»å†™äº‹ä»¶ã€‚</p>
<p>æ‰€ä»¥å½“æˆ‘ä»¬å¯åŠ¨ç¨‹åºçš„æ—¶å€™ï¼Œå¦‚æœåªç›‘å¬ä¸€ä¸ªåœ°å€çš„æƒ…å†µä¸‹ï¼Œé‚£ä¹ˆç¨‹åºçš„pollæ•°= 1(listener poller) + pollerNumã€‚</p>
<p>ä»ä¸Šé¢çš„å­—æ®µä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œä½ å¯ä»¥è‡ªå®šä¹‰ä¸€äº›é…ç½®å’Œå›è°ƒã€‚æ¯”å¦‚ä½ å¯ä»¥è®¾ç½®å½“æ–°è¿æ¥åˆ°æ¥æ—¶çš„å›è°ƒå‡½æ•°onOpenï¼Œä¹Ÿå¯ä»¥è®¾ç½®ä¸€ä¸ªconnæ•°æ®åˆ°æ¥æ—¶çš„å›è°ƒå‡½æ•°onDataç­‰ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Conn</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">mux</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">p</span> <span class="o">*</span><span class="nx">poller</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">fd</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="nx">writeBuffer</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">typ</span>      <span class="nx">ConnType</span>
</span></span><span class="line"><span class="cl">	<span class="nx">closed</span>   <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">	<span class="nx">isWAdded</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">	<span class="nx">closeErr</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">lAddr</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Addr</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rAddr</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Addr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">ReadBuffer</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl"><span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="nx">DataHandler</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">,</span> <span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Connç»“æ„ä½“ï¼Œç”¨äºè¡¨ç¤ºä¸€ä¸ªç½‘ç»œè¿æ¥ã€‚ä¸€ä¸ªconnåªå±äºä¸€ä¸ªpollerã€‚å¯¹åº”çš„writeBuffer:å½“æ•°æ®ä¸€æ¬¡æ²¡å†™å®Œæ—¶ï¼Œå‰©ä¸‹çš„å…ˆå­˜åœ¨writeBufferï¼Œç­‰å¾…ä¸‹æ¬¡å¯å†™äº‹ä»¶åˆ°æ¥ç»§ç»­å†™å…¥ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">poller</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">g</span> <span class="o">*</span><span class="nx">Engine</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">epfd</span>  <span class="kt">int</span>
</span></span><span class="line"><span class="cl">	<span class="nx">evtfd</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">index</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">shutdown</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">listener</span>     <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span>
</span></span><span class="line"><span class="cl">	<span class="nx">isListener</span>   <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">	<span class="nx">unixSockAddr</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">ReadBuffer</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">pollType</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è‡³äºpollerç»“æ„ï¼Œè¿™é‡Œå°±æ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µï¼Œç”¨äºç®¡ç†åº•å±‚çš„å¤šè·¯å¤ç”¨ I/Oï¼ˆå¦‚linuxçš„epollã€darwinä¸Šçš„kqueue ç­‰ï¼‰</p>
<p>æ³¨æ„è¿™é‡Œçš„pollTypeï¼Œnbioé»˜è®¤epollé‡‡ç”¨çš„æ˜¯æ°´å¹³è§¦å‘(LT)ï¼Œå½“ç„¶ç”¨æˆ·ä¹Ÿå¯ä»¥è®¾ç½®æˆè¾¹ç¼˜è§¦å‘(ET)ã€‚</p>
<p>ä»‹ç»å®ŒåŸºæœ¬çš„ç»“æ„ï¼Œæ¥ä¸‹æ¥è¿›å…¥ä»£ç çš„æµç¨‹ã€‚</p>
<p>ä¸Šé¢æœåŠ¡ç«¯çš„ä»£ç ï¼Œå½“ä½ è°ƒç”¨Startå¯åŠ¨ç¨‹åºï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">g</span> <span class="o">*</span><span class="nx">Engine</span><span class="p">)</span> <span class="nf">Start</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">//....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">switch</span> <span class="nx">g</span><span class="p">.</span><span class="nx">network</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">//ç¬¬ä¸€éƒ¨åˆ† åˆå§‹åŒ–listener
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">case</span> <span class="s">&#34;unix&#34;</span><span class="p">,</span> <span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="s">&#34;tcp4&#34;</span><span class="p">,</span> <span class="s">&#34;tcp6&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">g</span><span class="p">.</span><span class="nx">addrs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// listener poller
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">ln</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">newPoller</span><span class="p">(</span><span class="nx">g</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">for</span> <span class="nx">j</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="p">&lt;</span> <span class="nx">i</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">g</span><span class="p">.</span><span class="nx">listeners</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nf">stop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">g</span><span class="p">.</span><span class="nx">addrs</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">ln</span><span class="p">.</span><span class="nx">listener</span><span class="p">.</span><span class="nf">Addr</span><span class="p">().</span><span class="nf">String</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">g</span><span class="p">.</span><span class="nx">listeners</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">listeners</span><span class="p">,</span> <span class="nx">ln</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">    <span class="c1">//.....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">   <span class="c1">//ç¬¬äºŒéƒ¨åˆ† åˆå§‹åŒ–ä¸€å®šæ•°é‡poller
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">g</span><span class="p">.</span><span class="nx">pollerNum</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// rw poller
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">newPoller</span><span class="p">(</span><span class="nx">g</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="nx">j</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nx">listeners</span><span class="p">);</span> <span class="nx">j</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">g</span><span class="p">.</span><span class="nx">listeners</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nf">stop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="nx">j</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="p">&lt;</span> <span class="nx">i</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">g</span><span class="p">.</span><span class="nx">pollers</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nf">stop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">g</span><span class="p">.</span><span class="nx">pollers</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">p</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//ç¬¬ä¸‰éƒ¨åˆ† å¯åŠ¨æ‰€æœ‰çš„worker poller
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">g</span><span class="p">.</span><span class="nx">pollerNum</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">g</span><span class="p">.</span><span class="nx">pollers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">ReadBuffer</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">g</span><span class="p">.</span><span class="nx">readBufferSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">g</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">g</span><span class="p">.</span><span class="nx">pollers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nf">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ç¬¬å››éƒ¨åˆ† å¯åŠ¨æ‰€æœ‰çš„listenr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">l</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">g</span><span class="p">.</span><span class="nx">listeners</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">g</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">l</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//...å¿½ç•¥udp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// ....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>ä»£ç è¿˜æ˜¯æ˜“æ‡‚çš„ï¼Œæ•´ä½“çœ‹å°±å››ä¸ªéƒ¨åˆ†ã€‚</p>
<p><strong>ç¬¬ä¸€éƒ¨åˆ†ï¼šåˆå§‹åŒ– listener</strong></p>
<p>æ ¹æ® <code>g.network</code> çš„å€¼ï¼ˆå¦‚ &ldquo;unix&rdquo;, &ldquo;tcp&rdquo;, &ldquo;tcp4&rdquo;, &ldquo;tcp6&rdquo;ï¼‰ï¼Œä¸ºæ¯ä¸ªè¦ç›‘å¬çš„åœ°å€ï¼ˆ<code>g.addrs</code>ï¼‰åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>poller</code>ã€‚è¿™é‡Œçš„ <code>poller</code>ä¸»è¦ç”¨äºç®¡ç†ç›‘å¬å¥—æ¥å­—ä¸Šçš„äº‹ä»¶ã€‚å¦‚æœåˆ›å»º <code>poller</code> æ—¶å‡ºé”™ï¼Œå°†åœæ­¢ä¹‹å‰åˆ›å»ºçš„æ‰€æœ‰ç›‘å¬å™¨å¹¶è¿”å›é”™è¯¯ã€‚</p>
<p><strong>ç¬¬äºŒéƒ¨åˆ†ï¼šåˆå§‹åŒ–ä¸€å®šæ•°é‡çš„ poller</strong></p>
<p>æ ¹æ®pollerNumåˆ›å»ºå¯¹åº”ä¸ªæ•°çš„worker pollerã€‚è¿™äº› <code>poller</code> ç”¨äºå¤„ç†å·²è¿æ¥å¥—æ¥å­—ä¸Šçš„è¯»/å†™äº‹ä»¶ã€‚å¦‚æœåœ¨åˆ›å»ºè¿‡ç¨‹ä¸­é‡åˆ°é”™è¯¯ï¼Œå°†åœæ­¢æ‰€æœ‰ç›‘å¬å™¨å’Œä¹‹å‰åˆ›å»ºçš„å·¥ä½œ <code>poller</code>ï¼Œç„¶åè¿”å›é”™è¯¯ã€‚</p>
<p><strong>ç¬¬ä¸‰éƒ¨åˆ†ï¼šå¯åŠ¨æ‰€æœ‰çš„ worker poller</strong></p>
<p>ä¸ºæ¯ä¸ªå·¥ä½œ <code>poller</code> åˆ†é…ä¸€ä¸ªè¯»ç¼“å†²åŒºï¼ˆç”± <code>g.readBufferSize</code> å†³å®šå¤§å°ï¼‰ï¼Œå¹¶å‘åœ°å¯åŠ¨è¿™äº› <code>poller</code>ã€‚</p>
<p><strong>ç¬¬å››éƒ¨åˆ†ï¼šå¯åŠ¨æ‰€æœ‰çš„ listener</strong></p>
<p>å¯åŠ¨æ‰€æœ‰ä¹‹å‰åˆ›å»ºçš„ç›‘å¬å™¨ã€‚å¼€å§‹ç›‘å¬å¯¹åº”åœ°å€çš„è¿æ¥è¯·æ±‚ã€‚</p>
<p>è‡³äºpollerçš„å¯åŠ¨ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">poller</span><span class="p">)</span> <span class="nf">start</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">isListener</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">p</span><span class="p">.</span><span class="nf">acceptorLoop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">syscall</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">epfd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">syscall</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">evtfd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">p</span><span class="p">.</span><span class="nf">readWriteLoop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>åˆ†ä¸ºä¸¤ç§ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªlistener pollerï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">poller</span><span class="p">)</span> <span class="nf">acceptorLoop</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//å¦‚æœæƒ³è¦å½“å‰gä¸è¢«è°ƒåº¦åˆ°å…¶ä»–çš„æ“ä½œçº¿ç¨‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">lockListener</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">runtime</span><span class="p">.</span><span class="nf">LockOSThread</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">runtime</span><span class="p">.</span><span class="nf">UnlockOSThread</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">p</span><span class="p">.</span><span class="nx">shutdown</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">!</span><span class="nx">p</span><span class="p">.</span><span class="nx">shutdown</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">listener</span><span class="p">.</span><span class="nf">Accept</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="kd">var</span> <span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">NBConn</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">conn</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">pollers</span><span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nf">Hash</span><span class="p">()</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">pollers</span><span class="p">)].</span><span class="nf">addConn</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="kd">var</span> <span class="nx">ne</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Error</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">As</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">ne</span><span class="p">);</span> <span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="nx">ne</span><span class="p">.</span><span class="nf">Timeout</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">logging</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;NBIO[%v][%v_%v] Accept failed: temporary error, retrying...&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">pollType</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">/</span> <span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">!</span><span class="nx">p</span><span class="p">.</span><span class="nx">shutdown</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">logging</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;NBIO[%v][%v_%v] Accept failed: %v, exit...&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">pollType</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">index</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>listener poller å°±æ˜¯ç­‰å¾…æ–°è¿æ¥ï¼Œç„¶åé€šè¿‡NBConnå°è£…æˆnbio connç»“æ„ï¼Œæœ€åé€šè¿‡å–æ¨¡æ“ä½œè·å–å…¶ä¸­ä¸€ä¸ªwoker pollerã€‚æŠŠè¿æ¥åŠ å…¥åˆ°å¯¹åº”çš„pollerä¸­ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">poller</span><span class="p">)</span> <span class="nf">addConn</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">c</span><span class="p">.</span><span class="nx">p</span> <span class="p">=</span> <span class="nx">p</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">typ</span> <span class="o">!=</span> <span class="nx">ConnTypeUDPServer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nf">onOpen</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="nx">fd</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">fd</span>
</span></span><span class="line"><span class="cl">   <span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">connsUnix</span><span class="p">[</span><span class="nx">fd</span><span class="p">]</span> <span class="p">=</span> <span class="nx">c</span>
</span></span><span class="line"><span class="cl">   <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">addRead</span><span class="p">(</span><span class="nx">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">connsUnix</span><span class="p">[</span><span class="nx">fd</span><span class="p">]</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">      <span class="nx">c</span><span class="p">.</span><span class="nf">closeWithError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">logging</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;[%v] add read event failed: %v&#34;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">fd</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¿™é‡Œä¸€ä¸ªæœ‰è¶£çš„è®¾è®¡ï¼Œåœ¨ç®¡ç†connsä¸Šï¼Œç»“æ„æ˜¯sliceï¼Œä½œè€…ç›´æ¥ä½¿ç”¨çš„connçš„fdæ¥ä½œä¸ºä¸‹æ ‡ã€‚</p>
<p>è¿™æ ·è¿˜æ˜¯æœ‰å¥½å¤„çš„,</p>
<ul>
<li>è¿æ¥è¶…å¤šçš„æƒ…å†µä¸‹ï¼ŒGCçš„æ—¶å€™è´Ÿæ‹…ä¼šæ¯”mapå°ã€‚</li>
<li>èƒ½é˜²æ­¢ä¸²å·é—®é¢˜ã€‚</li>
</ul>
<p>æœ€åé€šè¿‡è°ƒç”¨addReadæŠŠå¯¹åº”çš„conn fdåŠ å…¥åˆ°epollã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">poller</span><span class="p">)</span> <span class="nf">addRead</span><span class="p">(</span><span class="nx">fd</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">epollMod</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">EPOLLET</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">syscall</span><span class="p">.</span><span class="nf">EpollCtl</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">epfd</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EPOLL_CTL_ADD</span><span class="p">,</span> <span class="nx">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">EpollEvent</span><span class="p">{</span><span class="nx">Fd</span><span class="p">:</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">fd</span><span class="p">),</span> <span class="nx">Events</span><span class="p">:</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EPOLLERR</span> <span class="p">|</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EPOLLHUP</span> <span class="p">|</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EPOLLRDHUP</span> <span class="p">|</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EPOLLPRI</span> <span class="p">|</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EPOLLIN</span> <span class="p">|</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EPOLLET</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">syscall</span><span class="p">.</span><span class="nf">EpollCtl</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">epfd</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EPOLL_CTL_ADD</span><span class="p">,</span> <span class="nx">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">EpollEvent</span><span class="p">{</span><span class="nx">Fd</span><span class="p">:</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">fd</span><span class="p">),</span> <span class="nx">Events</span><span class="p">:</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EPOLLERR</span> <span class="p">|</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EPOLLHUP</span> <span class="p">|</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EPOLLRDHUP</span> <span class="p">|</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EPOLLPRI</span> <span class="p">|</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EPOLLIN</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¿™é‡Œæ²¡æœ‰æ³¨å†Œå†™äº‹ä»¶æ˜¯åˆç†çš„ï¼Œå› ä¸ºåœ¨æ–°è¿æ¥ä¸Šè¿˜æ²¡æœ‰æ”¶åˆ°ä»»ä½•æ•°æ®ï¼Œæ‰€ä»¥æš‚æ—¶æ²¡æœ‰éœ€è¦å‘é€çš„æ•°æ®ã€‚è¿™ç§åšæ³•å¯ä»¥é¿å…ä¸€äº›ä¸å¿…è¦çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä»è€Œæé«˜ç¨‹åºçš„æ€§èƒ½ã€‚</p>
<p>å¦‚æœæ˜¯worker pollerçš„å¯åŠ¨ï¼Œå®ƒçš„å·¥ä½œå°±æ˜¯ç­‰å¾…åŠ å…¥çš„é‚£äº›connsçš„äº‹ä»¶åˆ°æ¥ï¼Œè¿›è¡Œå¯¹åº”çš„å¤„ç†ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">poller</span><span class="p">)</span> <span class="nf">readWriteLoop</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">//....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">msec</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">  <span class="nx">events</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">EpollEvent</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ......
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">for</span> <span class="p">!</span><span class="nx">p</span><span class="p">.</span><span class="nx">shutdown</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">syscall</span><span class="p">.</span><span class="nf">EpollWait</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">epfd</span><span class="p">,</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">msec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">errors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EINTR</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">n</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">msec</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// runtime.Gosched()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="k">continue</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="nx">msec</span> <span class="p">=</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="c1">// éå†äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ev</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">events</span><span class="p">[:</span><span class="nx">n</span><span class="p">]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">fd</span> <span class="o">:=</span> <span class="nb">int</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">Fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="k">switch</span> <span class="nx">fd</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">case</span> <span class="nx">p</span><span class="p">.</span><span class="nx">evtfd</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">         <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nx">c</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">getConn</span><span class="p">(</span><span class="nx">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">c</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="k">if</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">Events</span><span class="o">&amp;</span><span class="nx">epollEventsError</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="nx">c</span><span class="p">.</span><span class="nf">closeWithError</span><span class="p">(</span><span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                  <span class="k">continue</span>
</span></span><span class="line"><span class="cl">               <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">               <span class="c1">// è¯´æ˜å¯å†™ åˆ·æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>               <span class="k">if</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">Events</span><span class="o">&amp;</span><span class="nx">epollEventsWrite</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="nx">c</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">               <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">               <span class="c1">//è¯»äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>               <span class="k">if</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">Events</span><span class="o">&amp;</span><span class="nx">epollEventsRead</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">onRead</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                     <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">maxConnReadTimesPerEventLoop</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">buffer</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nf">borrow</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">rc</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">ReadAndGetConn</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="nx">n</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                           <span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nf">onData</span><span class="p">(</span><span class="nx">rc</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">[:</span><span class="nx">n</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nf">payback</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="k">if</span> <span class="nx">n</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                           <span class="k">break</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                     <span class="p">}</span>
</span></span><span class="line"><span class="cl">                  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                     <span class="nx">p</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nf">onRead</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                  <span class="p">}</span>
</span></span><span class="line"><span class="cl">               <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="nx">syscall</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">               <span class="c1">// p.deleteEvent(fd)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¿™æ®µä»£ç ä¹Ÿå¾ˆå¥½ç†è§£ã€‚ç­‰å¾…äº‹ä»¶åˆ°æ¥ï¼Œéå†å¯¹åº”çš„äº‹ä»¶åˆ—è¡¨ï¼Œåˆ¤æ–­äº‹ä»¶ç±»å‹ï¼Œç›¸å¯¹åº”çš„å¤„ç†ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">EpollWait</span><span class="p">(</span><span class="nx">epfd</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">events</span> <span class="p">[]</span><span class="nx">EpollEvent</span><span class="p">,</span> <span class="nx">msec</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span></code></pre></div><p>EpollWaitä¸­åªæœ‰msecæ˜¯å¯ä»¥ç”¨æˆ·åŠ¨æ€ä¿®æ”¹çš„ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸»åŠ¨è°ƒç”¨EpollWaitéƒ½ä¼šè®¾ç½®msec=-1ï¼Œmsce=-1ä¼šä½¿å¾—å‡½æ•°ä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°è‡³å°‘æœ‰ä¸€ä¸ªäº‹ä»¶å‘ç”Ÿï¼Œå¦åˆ™çš„è¯ä¸€ç›´é˜»å¡ã€‚è¿™ç§æ–¹æ³•åœ¨äº‹ä»¶å‘ç”Ÿè¾ƒå°‘çš„æƒ…å†µä¸‹éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒå¯ä»¥æœ€å¤§é™åº¦åœ°å‡å°‘ CPUå ç”¨ç‡ã€‚</p>
<p>å¦‚æœå¸Œæœ›å°½å¯èƒ½å¿«é€Ÿå“åº”äº‹ä»¶ï¼Œå¯ä»¥å°†msecè®¾ç½®ä¸º 0ã€‚è¿™å°†ä½¿ EpollWaitç«‹å³è¿”å›ï¼Œä¸ç­‰å¾…ä»»ä½•äº‹ä»¶ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œä½ çš„ç¨‹åºå¯èƒ½ä¼šæ›´é¢‘ç¹åœ°è°ƒç”¨EpollWaitï¼Œä½†èƒ½å¤Ÿåœ¨äº‹ä»¶å‘ç”Ÿåç«‹å³å¤„ç†å®ƒä»¬ã€‚å½“ç„¶ï¼Œè¿™å°±ä¼šå¯¼è‡´CPUå ç”¨ç‡è¾ƒé«˜ã€‚</p>
<p>å¦‚æœä½ çš„ç¨‹åºå¯ä»¥æ‰¿å—ä¸€å®šçš„å»¶è¿Ÿï¼Œå¹¶å¸Œæœ›å‡å°‘ CPUå ç”¨ç‡ï¼Œå¯ä»¥å°†msecè®¾ç½®ä¸ºä¸€ä¸ªæ­£æ•°ã€‚è¿™å°†ä½¿å¾—EpollWaitåœ¨æŒ‡å®šçš„æ—¶é—´å†…ç­‰å¾…äº‹ä»¶ã€‚å¦‚æœåœ¨è¿™æ®µæ—¶é—´å†…æ²¡æœ‰äº‹ä»¶å‘ç”Ÿï¼Œå‡½æ•°å°†è¿”å›ï¼Œä½ å¯ä»¥é€‰æ‹©åœ¨ç¨åå†æ¬¡è°ƒç”¨EpollWaitã€‚è¿™ç§æ–¹æ³•å¯ä»¥é™ä½ CPUå ç”¨ç‡ï¼Œä½†å¯èƒ½ä¼šå¯¼è‡´è¾ƒé•¿çš„å“åº”æ—¶é—´ã€‚</p>
<p>nbioå¯¹åº”è¿™ä¸ªå€¼çš„è°ƒæ•´ç­–ç•¥æ˜¯:å½“äº‹ä»¶æ•°é‡å¤§äº0æ—¶ï¼Œmsec=20(è¿™ä¸ª20åº”è¯¥æ˜¯ä½œè€…æµ‹è¯•åç»¼åˆè€ƒé‡?)ã€‚</p>
<p>å­—èŠ‚è·³åŠ¨çš„netpollä»£ç æ˜¯è¿™æ ·çš„ï¼Œå¦‚æœäº‹ä»¶æ•°é‡å¤§äº0ï¼Œä¼šè®¾ç½®msecä¸º0ã€‚å¦‚æœäº‹ä»¶å°äºç­‰äº0ï¼Œè®¾ç½®msec=-1ï¼Œç„¶åè°ƒç”¨Gosched()ä½¿å¾—å½“å‰Goroutineä¸»åŠ¨è®©å‡ºPã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">msec</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">syscall</span><span class="p">.</span><span class="nf">EpollWait</span><span class="p">(</span><span class="nx">epfd</span><span class="p">,</span> <span class="nx">events</span><span class="p">,</span> <span class="nx">msec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">n</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">msec</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">      <span class="nx">runtime</span><span class="p">.</span><span class="nf">Gosched</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="k">continue</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="nx">msec</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">   <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ç„¶è€Œï¼Œnbio ä¸­ä¸»åŠ¨åˆ‡æ¢çš„ä»£ç å·²ç»è¢«æ³¨é‡Šæ‰äº†ã€‚æ ¹æ®ä½œè€…åœ¨ issue ä¸­çš„è§£é‡Šï¼Œæœ€åˆä»–å‚è€ƒäº†å­—èŠ‚çš„æ–¹æ³•åŠ å…¥äº†ä¸»åŠ¨åˆ‡æ¢ã€‚</p>
<p>ä½†åœ¨å¯¹ nbio è¿›è¡Œæ€§èƒ½æµ‹è¯•æ—¶ï¼Œå‘ç°åŠ å…¥ä¸ä¸åŠ å…¥ä¸»åŠ¨åˆ‡æ¢å¯¹æ€§èƒ½æ²¡æœ‰æ˜æ˜¾åŒºåˆ«ï¼Œå› æ­¤æœ€ç»ˆå†³å®šå°†å…¶ç§»é™¤ã€‚</p>
<p>äº‹ä»¶çš„å¤„ç†éƒ¨åˆ†ï¼Œ</p>
<p>å¦‚æœæ˜¯å¯è¯»äº‹ä»¶ï¼Œä½ å¯ä»¥é€šè¿‡å†…ç½®æˆ–è€…è‡ªå®šä¹‰çš„å†…å­˜åˆ†é…å™¨æ¥å¾—åˆ°ç›¸åº”çš„bufferï¼Œç„¶åè°ƒç”¨ReadAndGetConnè¯»å–æ•°æ®ï¼Œè€Œä¸éœ€è¦æ¯æ¬¡éƒ½ç”³è¯·ä¸€ébufferã€‚</p>
<p>å¦‚æœæ˜¯å¯å†™äº‹ä»¶çš„è¯ï¼Œä¼šè°ƒç”¨flushæŠŠbufferé‡Œæœªå‘é€çš„æ•°æ®å‘é€å‡ºå»ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">)</span> <span class="nf">flush</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//.....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">old</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">writeBuffer</span>
</span></span><span class="line"><span class="cl">	<span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">doWrite</span><span class="p">(</span><span class="nx">old</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">errors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EINTR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">errors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//.....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">n</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">n</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">left</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">old</span><span class="p">)</span> <span class="o">-</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// è¯´æ˜æ²¡å†™å®Œï¼ŒæŠŠå‰©ä¸‹çš„å­˜è¿›writeBufferä¸‹æ¬¡å†™
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">left</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">n</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">writeBuffer</span> <span class="p">=</span> <span class="nx">mempool</span><span class="p">.</span><span class="nf">Malloc</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nb">copy</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">,</span> <span class="nx">old</span><span class="p">[</span><span class="nx">n</span><span class="p">:])</span>
</span></span><span class="line"><span class="cl">			<span class="nx">mempool</span><span class="p">.</span><span class="nf">Free</span><span class="p">(</span><span class="nx">old</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// c.modWrite()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">mempool</span><span class="p">.</span><span class="nf">Free</span><span class="p">(</span><span class="nx">old</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">writeBuffer</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">wTimer</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">wTimer</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">wTimer</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¯´æ˜å†™å®Œäº†ï¼Œå…ˆæŠŠconné‡ç½®ä¸ºåªæœ‰è¯»äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">c</span><span class="p">.</span><span class="nf">resetRead</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nx">mux</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼Œå†™å¤šå°‘æ˜¯å¤šå°‘ï¼Œå†™ä¸è¿›å»æŠŠå‰©ä¸‹çš„é‡æ–°æ”¾å…¥writeBufferï¼Œä¸‹è½®epollWaitè§¦å‘å†å†™ã€‚</p>
<p>å¦‚æœå†™å®Œäº†ï¼Œé‚£å°±æ²¡æ•°æ®å¯å†™äº†ï¼Œé‡ç½®è¿™ä¸ªconnçš„äº‹ä»¶ä¸ºè¯»äº‹ä»¶ã€‚</p>
<p>ä¸»é€»è¾‘å°±å·®ä¸å¤šæ˜¯è¿™æ ·äº†ã€‚</p>
<p>ç­‰ç­‰ï¼Œæˆ‘ä»¬ä¸€å¼€å§‹è¯´ä¸€ä¸ªæ–°è¿æ¥è¿›æ¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯¹ä¸€ä¸ªè¿æ¥åªæ³¨å†Œäº†è¯»äº‹ä»¶ï¼Œæ²¡æ³¨å†Œå†™äº‹ä»¶ï¼Œå†™äº‹ä»¶æ˜¯ä»€ä¹ˆæ—¶å€™æ³¨å†Œçš„ï¼Ÿ</p>
<p>å½“ç„¶æ˜¯ä½ è°ƒç”¨conn.Writeçš„æ—¶å€™ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">g</span> <span class="o">:=</span> <span class="nx">nbio</span><span class="p">.</span><span class="nf">NewGopher</span><span class="p">(</span><span class="nx">nbio</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Network</span><span class="p">:</span>            <span class="s">&#34;tcp&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Addrs</span><span class="p">:</span>              <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;:8888&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">MaxWriteBufferSize</span><span class="p">:</span> <span class="mi">6</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">g</span><span class="p">.</span><span class="nf">OnData</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">nbio</span><span class="p">.</span><span class="nx">Conn</span><span class="p">,</span> <span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nb">append</span><span class="p">([]</span><span class="kt">byte</span><span class="p">{},</span> <span class="nx">data</span><span class="o">...</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span></code></pre></div><p>å½“connçš„æ•°æ®åˆ°æ¥æ—¶ï¼Œåº•å±‚è¯»å®Œæ•°æ®ï¼Œä¼šå›è°ƒOnDataå‡½æ•°ï¼Œæ­¤æ—¶ä½ å¯ä»¥è°ƒç”¨Writeå‘å¯¹ç«¯å‘é€æ•°æ®ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">)</span> <span class="nf">Write</span><span class="p">(</span><span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">errors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EINTR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">errors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//.....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">wTimer</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">wTimer</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">wTimer</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¯´æ˜è¿˜æœ‰æ•°æ®æ²¡å†™å®Œï¼ŒåŠ å…¥å†™äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">c</span><span class="p">.</span><span class="nf">modWrite</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//.....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Conn</span><span class="p">)</span> <span class="nf">write</span><span class="p">(</span><span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">doWrite</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">errors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EINTR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">errors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//.....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">		<span class="nx">left</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">-</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//è¿˜æ²¡å†™å®Œï¼Œå‰©ä¸‹çš„æ”¾å…¥writeBuffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">left</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">typ</span> <span class="o">==</span> <span class="nx">ConnTypeTCP</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">writeBuffer</span> <span class="p">=</span> <span class="nx">mempool</span><span class="p">.</span><span class="nf">Malloc</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nb">copy</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">,</span> <span class="nx">b</span><span class="p">[</span><span class="nx">n</span><span class="p">:])</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nf">modWrite</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å¦‚æœæœ¬èº«writeBufferè¿˜æœ‰æ•°æ®æ²¡å†™å…¥ï¼Œé‚£æ–°çš„æ•°æ®ä¹Ÿappendè¿›æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">c</span><span class="p">.</span><span class="nx">writeBuffer</span> <span class="p">=</span> <span class="nx">mempool</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">,</span> <span class="nx">b</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å½“æ•°æ®æ²¡å†™å®Œï¼Œå°±æŠŠå‰©ä½™æ•°æ®æ”¾å…¥åˆ°writeBufferï¼Œè¿™æ ·å°±ä¼šè§¦å‘æ‰§è¡ŒmodWriteï¼Œå°±ä¼šæŠŠconnçš„å†™äº‹ä»¶æ³¨å†Œåˆ°epollä¸­ã€‚</p>
<p>æ€»ç»“</p>
<p>ç›¸è¾ƒäºevioï¼Œnbioä¸ä¼šå‡ºç°æƒŠç¾¤æ•ˆåº”ã€‚</p>
<p>evioæ˜¯é€šè¿‡ä¸æ–­æ— æ•ˆçš„å”¤é†’epollï¼Œæ¥è¾¾åˆ°é€»è¾‘çš„æ­£ç¡®æ€§ã€‚è€Œnbioæ˜¯å°½å¯èƒ½çš„å‡å°‘ç³»ç»Ÿè°ƒç”¨ï¼Œå‡å°‘æ— è°“çš„å¼€é”€ã€‚</p>
<p>æ˜“ç”¨æ€§ä¸Šï¼Œnbioå®ç°äº†æ ‡å‡†åº“net.Connï¼ŒåŒæ—¶å¾ˆå¤šè®¾ç½®å¯é…ç½®åŒ–ï¼Œç”¨æˆ·å¯ä»¥è‡ªç”±å®šåˆ¶ï¼Œè‡ªç”±åº¦è¾ƒé«˜ã€‚</p>
<p>è¯»å†™ä¸Šä¼šä½¿ç”¨é¢„å…ˆåˆ†é…çš„bufferï¼Œæé«˜åº”ç”¨æ€§èƒ½ã€‚</p>
<p>æ€»ä¹‹ï¼Œnbioæ˜¯ä¸€æ¬¾ä¸é”™çš„é«˜æ€§èƒ½éé˜»å¡çš„ç½‘ç»œæ¡†æ¶ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>HelloWordä¸€ä¸ªgoå¼€å‘çš„å­¦ä¹ è‹±è¯­å•è¯å·¥å…·</title>
			<link>https://www.syst.top/posts/go/helloword/</link>
			<pubDate>Tue, 21 Feb 2023 18:23:51 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/helloword/</guid>
			<description>å›¾ç‰‡æ‹æ‘„äº2023å¹´02æœˆ19æ—¥ æ­å·ç‰é¸Ÿé›†
èƒŒæ™¯ Hello Wordæ˜¯æˆ‘åœ¨èƒŒå•è¯è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸€ä¸ªæƒ³æ³•ã€‚
åœ¨å­¦ä¹ è‹±è¯­æ—¶ï¼Œè¯æ±‡é‡æ˜¯éå¸¸é‡è¦çš„ã€‚ä½†æ˜¯ä»…ä»…æ­»è®°ç¡¬èƒŒå•è¯ï¼Œæ²¡æœ‰è¯­å¢ƒæ„Ÿï¼Œæ•ˆç‡æ˜¯å¾ˆä½çš„ã€‚
è™½ç„¶ä¸€äº›åº”ç”¨ç¨‹åºå¯ä»¥æ ¹æ®å•è¯çš„å¤šä¸ªè¯ä¹‰ä¸ºå•è¯ç»„æˆä¸€å°æ®µå¥å­ï¼Œç¨å¾®å¢å¼ºè¯­å¢ƒæ„Ÿã€‚ä½†æ˜¯å•è¯ä»ç„¶è¿‡äºé›¶æ•£ã€‚
å› æ­¤ï¼Œæˆ‘ä»¬æ˜¯å¦å¯ä»¥å°†æ¯å¤©èƒŒè¯µçš„å¤šä¸ªå•è¯ç»„åˆæˆä¸€æ®µå°çŸ­æ–‡ï¼Œä»¥ä¾¿å¤ä¹ è¿™ä¸€æ‰¹å•è¯å‘¢ï¼Ÿè¿™å°±æ˜¯Hello Wordçš„åˆè¡·ã€‚
å½“ç„¶ï¼ŒChatGPT APIæš‚æ—¶æ˜¯å®ç°è¿™ä¸ªæƒ³æ³•çš„å·¥å…·ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œç¨‹åºè¿˜é…å¥—äº†å‡ ä¸ªå‘¨è¾¹å°æ¸¸æˆã€‚
å•è¯çŸ­è¯­æ¨é€å™¨ æŒ‡å®šå•è¯æ•°é‡ï¼Œéšæœºé€‰æ‹©å•è¯ï¼Œç”Ÿæˆä¸€æ®µå°çŸ­æ–‡ï¼Œæ¨é€åˆ°ç”¨æˆ·æŒ‡å®šå¹³å°ã€‚
è¿™ä¸ªè„šæœ¬æœ‰ä»¥ä¸‹å¯é€‰é¡¹ï¼š
 filesï¼šé»˜è®¤å¯¼å…¥ CET4.txt å•è¯æ–‡ä»¶ï¼Œä½ å¯ä»¥é€šè¿‡é€—å·åŒæ—¶å¯¼å…¥å¤šä¸ªå•è¯æ–‡ä»¶ï¼Œå®ƒä»¬éƒ½å­˜å‚¨åœ¨ library æ–‡ä»¶å¤¹ä¸‹ã€‚ specï¼šè¡¨ç¤ºæ¨é€é¢‘ç‡è®¾ç½®ï¼Œé»˜è®¤ä¸ºæ¯å°æ—¶ç”Ÿæˆä¸€ä¸ªæ–°çš„çŸ­è¯­ï¼Œå…·ä½“æ—¶é—´è§„åˆ™ä½¿ç”¨çš„æ˜¯ robif/cron åº“ï¼Œè¯·å‚è€ƒè¯¥åº“çš„æ–‡æ¡£è‡ªè¡Œè®¾ç½®ã€‚ word-numberï¼šè¡¨ç¤ºç”Ÿæˆä¸€æ¬¡çŸ­è¯­ä½¿ç”¨çš„å•è¯æ•°é‡ï¼Œé»˜è®¤ä¸º 5 ä¸ªï¼Œæœ€å¤šä¸è¶…è¿‡ 10 ä¸ª  æ•ˆæœ
å•è¯é€‰æ‹©è§„åˆ™ï¼Œ
 é»˜è®¤:éšæœº æœ€è¿‘æœ€å°‘æ¨é€(todo)  å•è¯æ¸¸æˆ å•è¯æ¥é¾™ è¿™æ˜¯ä¸€ä¸ªå•è¯æ¥é¾™æ¸¸æˆï¼Œæ¸¸æˆå¼€å§‹æ—¶ç³»ç»Ÿä¼šéšæœºé€‰æ‹©ä¸€ä¸ªå•è¯ã€‚ç©å®¶éœ€è¦ä»¥è¯¥å•è¯çš„æœ€åä¸€ä¸ªå­—æ¯ä¸ºå¼€å¤´è¾“å…¥ä¸€ä¸ªæ–°å•è¯ï¼Œæ¥ç€ç¨‹åºåˆä»¥ç©å®¶è¾“å…¥å•è¯çš„æœ€åä¸€ä¸ªå­—æ¯ä¸ºå¼€å¤´è¾“å‡ºæ–°å•è¯ã€‚æ¸¸æˆä¼šæŒç»­è¿›è¡Œï¼Œç›´åˆ°æœ‰ä¸€æ–¹å‡ºç°é”™è¯¯ã€‚
åœ¨ä¸€å±€æ¸¸æˆä¸­ï¼Œæ¯ä¸ªå•è¯åªèƒ½è¢«ä½¿ç”¨ä¸€æ¬¡ã€‚
ä½¿ç”¨
æ•ˆæœ
åç»­è§„åˆ’
 å•è¯æ­£ç¡®æ€§æ ¡éªŒï¼Œæ˜¯å¦æ˜¯åˆæ³•çš„è‹±è¯­å•è¯(todo) è¶…æ—¶æ§åˆ¶ï¼Œç”¨æˆ·æ¯ä¸ªå›åˆæŒ‡å®šæ—¶é—´å†…æœªè¾“å‡ºï¼Œæ¸¸æˆç»“æŸ(todo) é”™è¯¯æœºä¼šï¼Œä¸€å±€æ¸¸æˆå¯ä»¥é”™è¯¯æ¬¡æ•°(todo)  å…¶ä»–æ¸¸æˆ å•è¯æ‹¼å†™(todo)ã€å•è¯å¡«ç©º(todo) é¡¹ç›®åœ°å€åœ¨: https://github.com/wuqinqiang/helloword
è§‰å¾—ä¸é”™å¯ä»¥ç‚¹ä¸ªstarï¼Œæ„Ÿå…´è¶£å¯ä»¥ä¸€èµ·å¼€å‘ã€‚</description>
			<content type="html"><![CDATA[<p><img src="https://cdn.syst.top/WechatIMG92.jpeg" alt="img"></p>
<p>å›¾ç‰‡æ‹æ‘„äº2023å¹´02æœˆ19æ—¥ æ­å·ç‰é¸Ÿé›†</p>
<h3 id="èƒŒæ™¯">èƒŒæ™¯</h3>
<p><a href="https://github.com/wuqinqiang/helloword">Hello Word</a>æ˜¯æˆ‘åœ¨èƒŒå•è¯è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸€ä¸ªæƒ³æ³•ã€‚</p>
<p>åœ¨å­¦ä¹ è‹±è¯­æ—¶ï¼Œè¯æ±‡é‡æ˜¯éå¸¸é‡è¦çš„ã€‚ä½†æ˜¯ä»…ä»…æ­»è®°ç¡¬èƒŒå•è¯ï¼Œæ²¡æœ‰è¯­å¢ƒæ„Ÿï¼Œæ•ˆç‡æ˜¯å¾ˆä½çš„ã€‚</p>
<p>è™½ç„¶ä¸€äº›åº”ç”¨ç¨‹åºå¯ä»¥æ ¹æ®å•è¯çš„å¤šä¸ªè¯ä¹‰ä¸ºå•è¯ç»„æˆä¸€å°æ®µå¥å­ï¼Œç¨å¾®å¢å¼ºè¯­å¢ƒæ„Ÿã€‚ä½†æ˜¯å•è¯ä»ç„¶è¿‡äºé›¶æ•£ã€‚</p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬æ˜¯å¦å¯ä»¥å°†æ¯å¤©èƒŒè¯µçš„å¤šä¸ªå•è¯ç»„åˆæˆä¸€æ®µå°çŸ­æ–‡ï¼Œä»¥ä¾¿å¤ä¹ è¿™ä¸€æ‰¹å•è¯å‘¢ï¼Ÿè¿™å°±æ˜¯Hello Wordçš„åˆè¡·ã€‚</p>
<p>å½“ç„¶ï¼ŒChatGPT APIæš‚æ—¶æ˜¯å®ç°è¿™ä¸ªæƒ³æ³•çš„å·¥å…·ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œç¨‹åºè¿˜é…å¥—äº†å‡ ä¸ªå‘¨è¾¹å°æ¸¸æˆã€‚</p>
<h3 id="å•è¯çŸ­è¯­æ¨é€å™¨">å•è¯çŸ­è¯­æ¨é€å™¨</h3>
<p>æŒ‡å®šå•è¯æ•°é‡ï¼Œéšæœºé€‰æ‹©å•è¯ï¼Œç”Ÿæˆä¸€æ®µå°çŸ­æ–‡ï¼Œæ¨é€åˆ°ç”¨æˆ·æŒ‡å®šå¹³å°ã€‚</p>
<p><img src="https://cdn.syst.top/hello1.png" alt="img"></p>
<p>è¿™ä¸ªè„šæœ¬æœ‰ä»¥ä¸‹å¯é€‰é¡¹ï¼š</p>
<ul>
<li>filesï¼šé»˜è®¤å¯¼å…¥ CET4.txt å•è¯æ–‡ä»¶ï¼Œä½ å¯ä»¥é€šè¿‡é€—å·åŒæ—¶å¯¼å…¥å¤šä¸ªå•è¯æ–‡ä»¶ï¼Œå®ƒä»¬éƒ½å­˜å‚¨åœ¨ library æ–‡ä»¶å¤¹ä¸‹ã€‚</li>
<li>specï¼šè¡¨ç¤ºæ¨é€é¢‘ç‡è®¾ç½®ï¼Œé»˜è®¤ä¸ºæ¯å°æ—¶ç”Ÿæˆä¸€ä¸ªæ–°çš„çŸ­è¯­ï¼Œå…·ä½“æ—¶é—´è§„åˆ™ä½¿ç”¨çš„æ˜¯ robif/cron åº“ï¼Œè¯·å‚è€ƒè¯¥åº“çš„æ–‡æ¡£è‡ªè¡Œè®¾ç½®ã€‚</li>
<li>word-numberï¼šè¡¨ç¤ºç”Ÿæˆä¸€æ¬¡çŸ­è¯­ä½¿ç”¨çš„å•è¯æ•°é‡ï¼Œé»˜è®¤ä¸º 5 ä¸ªï¼Œæœ€å¤šä¸è¶…è¿‡ 10 ä¸ª</li>
</ul>
<p>æ•ˆæœ</p>
<p><img src="https://cdn.syst.top/hello2.png" alt="img"></p>
<p>å•è¯é€‰æ‹©è§„åˆ™ï¼Œ</p>
<ul>
<li>é»˜è®¤:éšæœº</li>
<li>æœ€è¿‘æœ€å°‘æ¨é€(todo)</li>
</ul>
<h3 id="å•è¯æ¸¸æˆ">å•è¯æ¸¸æˆ</h3>
<h3 id="å•è¯æ¥é¾™">å•è¯æ¥é¾™</h3>
<p>è¿™æ˜¯ä¸€ä¸ªå•è¯æ¥é¾™æ¸¸æˆï¼Œæ¸¸æˆå¼€å§‹æ—¶ç³»ç»Ÿä¼šéšæœºé€‰æ‹©ä¸€ä¸ªå•è¯ã€‚ç©å®¶éœ€è¦ä»¥è¯¥å•è¯çš„æœ€åä¸€ä¸ªå­—æ¯ä¸ºå¼€å¤´è¾“å…¥ä¸€ä¸ªæ–°å•è¯ï¼Œæ¥ç€ç¨‹åºåˆä»¥ç©å®¶è¾“å…¥å•è¯çš„æœ€åä¸€ä¸ªå­—æ¯ä¸ºå¼€å¤´è¾“å‡ºæ–°å•è¯ã€‚æ¸¸æˆä¼šæŒç»­è¿›è¡Œï¼Œç›´åˆ°æœ‰ä¸€æ–¹å‡ºç°é”™è¯¯ã€‚</p>
<p>åœ¨ä¸€å±€æ¸¸æˆä¸­ï¼Œæ¯ä¸ªå•è¯åªèƒ½è¢«ä½¿ç”¨ä¸€æ¬¡ã€‚</p>
<p>ä½¿ç”¨</p>
<p><img src="https://cdn.syst.top/hello3.png" alt="img"></p>
<p>æ•ˆæœ</p>
<p><img src="https://cdn.syst.top/hello4.png" alt="img"></p>
<p>åç»­è§„åˆ’</p>
<ul>
<li>å•è¯æ­£ç¡®æ€§æ ¡éªŒï¼Œæ˜¯å¦æ˜¯åˆæ³•çš„è‹±è¯­å•è¯(todo)</li>
<li>è¶…æ—¶æ§åˆ¶ï¼Œç”¨æˆ·æ¯ä¸ªå›åˆæŒ‡å®šæ—¶é—´å†…æœªè¾“å‡ºï¼Œæ¸¸æˆç»“æŸ(todo)</li>
<li>é”™è¯¯æœºä¼šï¼Œä¸€å±€æ¸¸æˆå¯ä»¥é”™è¯¯æ¬¡æ•°(todo)</li>
</ul>
<h3 id="å…¶ä»–æ¸¸æˆ">å…¶ä»–æ¸¸æˆ</h3>
<h3 id="å•è¯æ‹¼å†™todoå•è¯å¡«ç©ºtodo">å•è¯æ‹¼å†™(todo)ã€å•è¯å¡«ç©º(todo)</h3>
<p>é¡¹ç›®åœ°å€åœ¨: <a href="https://github.com/wuqinqiang/helloword">https://github.com/wuqinqiang/helloword</a></p>
<p>è§‰å¾—ä¸é”™å¯ä»¥ç‚¹ä¸ªstarï¼Œæ„Ÿå…´è¶£å¯ä»¥ä¸€èµ·å¼€å‘ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>å‘ç°concå¹¶å‘åº“ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜</title>
			<link>https://www.syst.top/posts/go/conc/</link>
			<pubDate>Tue, 10 Jan 2023 18:23:51 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/conc/</guid>
			<description>ä¸Šå‘¨çœ‹åˆ°ä¸€ä¸ªæ–°åº“concï¼Œ
 better structured concurrency for go
 è¿™ä¸ªåº“çš„ç›®æ ‡æ˜¯ï¼Œ
 æ›´éš¾å‡ºç°goroutineæ³„æ¼ ä¼˜é›…å¤„ç†panic ä½¿å¹¶å‘çš„ä»£ç æ›´æ˜“è¯»  æˆ‘ä»¬ä¸€æ¡æ¡ç»†è¯´ã€‚
Make it harder to leak goroutines goroutineæ³„æ¼è¿˜æ˜¯å¾ˆå¸¸è§çš„ã€‚
æ—¥å¸¸æˆ‘ä»¬ä½¿ç”¨goçš„æ—¶å€™ç›´æ¥go funcå¼€å¯ä¸€ä¸ªgoroutineï¼Œå†™ä¸Šå¯¹åº”çš„é€»è¾‘ï¼Œgä¼šè¿›å…¥åˆ°æŸä¸ªpçš„æœ¬åœ°é˜Ÿåˆ—ï¼Œæœ€ç»ˆç”±pç»‘å®šçš„mæ‰§è¡Œè¿™ä¸ªgoroutineã€‚
ä½ èƒ½ä¿è¯ä¸€ä¸ªgoroutineåœ¨æŸä¸ªæ—¶åˆ»ä¸€å®šä¼šç»“æŸå®ƒçš„ç”Ÿå‘½å‘¨æœŸå—ï¼Ÿ
æœäº†ä¸‹è‘—åå¼€æºé¡¹ç›®etcdï¼Œgoroutine leakè¿˜çœŸä¸å°‘ã€‚
çœ‹å…¶ä¸­ä¸€ä¸ªç®€å•çš„æ³„æ¼bugã€‚
doneæ˜¯ä¸€ä¸ªæ— ç¼“å†²çš„chanï¼Œä¸€å¼€å§‹æ¥æ”¶åŠ¨ä½œåœ¨æœ€ä¸‹é¢ï¼Œå› ä¸ºä¸­é—´è¿˜æœ‰ä¸€äº›æ²¡å±•å¼€çš„ä»£ç å¯èƒ½ä¼šå¯¼è‡´ç¨‹åºä¸ä¼šæ‰§è¡Œåˆ°&amp;lt;-doneï¼Œç„¶ågoroutineå°±ä¼šå‘ç”Ÿæ³„æ¼ï¼Œè§£å†³æ–¹æ³•å°±æ˜¯é€šè¿‡deferä¿è¯ä¸€å®šä¼šæ‰§è¡Œ&amp;lt;-doneã€‚
é‚£ä¹ˆconcæ˜¯å¦‚ä½•åšçš„ï¼Ÿ
package main import ( &amp;#34;fmt&amp;#34; &amp;#34;github.com/sourcegraph/conc&amp;#34; ) func main() { var wg conc.WaitGroup wg.Go(func() { fmt.Println(&amp;#34;g1&amp;#34;) }) wg.Go(func() { fmt.Println(&amp;#34;g2&amp;#34;) }) wg.Wait() } ps:è¿™ä¸ªç»“æ„æ˜¯ä¸æ˜¯è¶…çº§ç†Ÿæ‚‰ã€‚
concçš„ç†å¿µæ˜¯ç¨‹åºä¸­çš„æ¯ä¸€ä¸ªgoroutineç”±ä¸€ä¸ªowneråˆ›å»ºï¼Œå½’å±äºownerã€‚ä¸€ä¸ªownerç¡®ä¿å®ƒæ‹¥æœ‰çš„æ‰€æœ‰goroutineæ­£å¸¸é€€å‡ºï¼Œè¿™é‡Œçš„ownerä¹Ÿå°±æ˜¯conc.WaitGroupã€‚
ä½†æ˜¯è¿™çœŸçš„èƒ½åƒä»–è¯´çš„é‚£æ ·Make it harder to leak goroutineså—ï¼Ÿ
goroutineçš„æ³„æ¼é—®é¢˜å–å†³äºç”¨æˆ·å¯¹goroutineèƒ½æ­£ç¡®é€€å‡ºçš„é€»è¾‘ä¿è¯ï¼Œå’Œä½ å¦‚ä½•å°è£…æ²¡å…³ç³»å§ï¼Ÿ
åœ¨æˆ‘çœ‹æ¥concå’Œæ ‡å‡†åº“çš„sync.WaitGroupä¸€æ ·ï¼Œç­‰å¾…æ‰€æœ‰goroutineæ‰§è¡Œå®Œæ¯•ï¼Œå¯ä»¥æ£€æµ‹åˆ°è¿™ä¸ªè¡Œä¸ºã€‚
è¦æ˜¯goroutineé‡Œé¢å«æœ‰æ³„æ¼çš„bugï¼Œè¯¥æ³„æ¼è¿˜å¾—æ³„æ¼ï¼ŒWaitè¯¥ç­‰å¾…è¿˜å¾—è€å®ç­‰å¾…ã€‚
Handle panics gracefully å¦‚æœç›´æ¥ä½¿ç”¨go func,é‚£ä¹ˆå¯èƒ½æ¯ä¸€ä¸ªgoroutineéƒ½å¾—å†™ä¸Šrecoverï¼Œæ‰€ä»¥ä¸€èˆ¬æˆ‘ä»¬åœ¨ä½¿ç”¨goroutineçš„æ—¶å€™ï¼Œéƒ½æ˜¯è‡ªå·±å°è£…ä¸€ä¸ªGoSafeå‡½æ•°ã€‚è¿™æ ·å°±å¯ä»¥åœ¨é‡Œé¢ç»Ÿä¸€æ•è·panicï¼Œç„¶åæ‰“åŒ…è°ƒç”¨æ ˆä¸€äº›ä¿¡æ¯ï¼Œè¿›ä¸€æ­¥å¤„ç†ã€‚
concé‡Œé¢å› ä¸ºæ¯ä¸ªgoroutineæœ‰owneræ¦‚å¿µï¼Œæ‰€ä»¥æ˜¯ç”±owneræ•è·goroutineçš„panicã€‚</description>
			<content type="html"><![CDATA[<p>ä¸Šå‘¨çœ‹åˆ°ä¸€ä¸ªæ–°åº“concï¼Œ</p>
<blockquote>
<p>better structured concurrency for go</p>
</blockquote>
<p>è¿™ä¸ªåº“çš„ç›®æ ‡æ˜¯ï¼Œ</p>
<ul>
<li>æ›´éš¾å‡ºç°goroutineæ³„æ¼</li>
<li>ä¼˜é›…å¤„ç†panic</li>
<li>ä½¿å¹¶å‘çš„ä»£ç æ›´æ˜“è¯»</li>
</ul>
<p>æˆ‘ä»¬ä¸€æ¡æ¡ç»†è¯´ã€‚</p>
<h4 id="make-it-harder-to-leak-goroutines">Make it harder to leak goroutines</h4>
<p>goroutineæ³„æ¼è¿˜æ˜¯å¾ˆå¸¸è§çš„ã€‚</p>
<p>æ—¥å¸¸æˆ‘ä»¬ä½¿ç”¨goçš„æ—¶å€™ç›´æ¥go funcå¼€å¯ä¸€ä¸ªgoroutineï¼Œå†™ä¸Šå¯¹åº”çš„é€»è¾‘ï¼Œgä¼šè¿›å…¥åˆ°æŸä¸ªpçš„æœ¬åœ°é˜Ÿåˆ—ï¼Œæœ€ç»ˆç”±pç»‘å®šçš„mæ‰§è¡Œè¿™ä¸ªgoroutineã€‚</p>
<p>ä½ èƒ½ä¿è¯ä¸€ä¸ªgoroutineåœ¨æŸä¸ªæ—¶åˆ»ä¸€å®šä¼šç»“æŸå®ƒçš„ç”Ÿå‘½å‘¨æœŸå—ï¼Ÿ</p>
<p>æœäº†ä¸‹è‘—åå¼€æºé¡¹ç›®etcdï¼Œgoroutine leakè¿˜çœŸä¸å°‘ã€‚</p>
<p><img src="https://cdn.syst.top/conc1.png" alt="conc"></p>
<p>çœ‹å…¶ä¸­ä¸€ä¸ªç®€å•çš„æ³„æ¼bugã€‚</p>
<p><img src="https://cdn.syst.top/conc2.png" alt="conc"></p>
<p>doneæ˜¯ä¸€ä¸ªæ— ç¼“å†²çš„chanï¼Œä¸€å¼€å§‹æ¥æ”¶åŠ¨ä½œåœ¨æœ€ä¸‹é¢ï¼Œå› ä¸ºä¸­é—´è¿˜æœ‰ä¸€äº›æ²¡å±•å¼€çš„ä»£ç å¯èƒ½ä¼šå¯¼è‡´ç¨‹åºä¸ä¼šæ‰§è¡Œåˆ°&lt;-doneï¼Œç„¶ågoroutineå°±ä¼šå‘ç”Ÿæ³„æ¼ï¼Œè§£å†³æ–¹æ³•å°±æ˜¯é€šè¿‡deferä¿è¯ä¸€å®šä¼šæ‰§è¡Œ&lt;-doneã€‚</p>
<p>é‚£ä¹ˆconcæ˜¯å¦‚ä½•åšçš„ï¼Ÿ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/sourcegraph/conc&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">wg</span> <span class="nx">conc</span><span class="p">.</span><span class="nx">WaitGroup</span>
</span></span><span class="line"><span class="cl">	<span class="nx">wg</span><span class="p">.</span><span class="nf">Go</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;g1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">wg</span><span class="p">.</span><span class="nf">Go</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;g2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ps:è¿™ä¸ªç»“æ„æ˜¯ä¸æ˜¯è¶…çº§ç†Ÿæ‚‰ã€‚</p>
<p>concçš„ç†å¿µæ˜¯ç¨‹åºä¸­çš„æ¯ä¸€ä¸ªgoroutineç”±ä¸€ä¸ªowneråˆ›å»ºï¼Œå½’å±äºownerã€‚ä¸€ä¸ªownerç¡®ä¿å®ƒæ‹¥æœ‰çš„æ‰€æœ‰goroutineæ­£å¸¸é€€å‡ºï¼Œè¿™é‡Œçš„ownerä¹Ÿå°±æ˜¯conc.WaitGroupã€‚</p>
<p>ä½†æ˜¯è¿™çœŸçš„èƒ½åƒä»–è¯´çš„é‚£æ ·Make it harder to leak goroutineså—ï¼Ÿ</p>
<p>goroutineçš„æ³„æ¼é—®é¢˜å–å†³äºç”¨æˆ·å¯¹goroutineèƒ½æ­£ç¡®é€€å‡ºçš„é€»è¾‘ä¿è¯ï¼Œå’Œä½ å¦‚ä½•å°è£…æ²¡å…³ç³»å§ï¼Ÿ</p>
<p>åœ¨æˆ‘çœ‹æ¥concå’Œæ ‡å‡†åº“çš„sync.WaitGroupä¸€æ ·ï¼Œç­‰å¾…æ‰€æœ‰goroutineæ‰§è¡Œå®Œæ¯•ï¼Œå¯ä»¥æ£€æµ‹åˆ°è¿™ä¸ªè¡Œä¸ºã€‚</p>
<p>è¦æ˜¯goroutineé‡Œé¢å«æœ‰æ³„æ¼çš„bugï¼Œè¯¥æ³„æ¼è¿˜å¾—æ³„æ¼ï¼ŒWaitè¯¥ç­‰å¾…è¿˜å¾—è€å®ç­‰å¾…ã€‚</p>
<h4 id="handle-panics-gracefully">Handle panics gracefully</h4>
<p>å¦‚æœç›´æ¥ä½¿ç”¨go func,é‚£ä¹ˆå¯èƒ½æ¯ä¸€ä¸ªgoroutineéƒ½å¾—å†™ä¸Šrecoverï¼Œæ‰€ä»¥ä¸€èˆ¬æˆ‘ä»¬åœ¨ä½¿ç”¨goroutineçš„æ—¶å€™ï¼Œéƒ½æ˜¯è‡ªå·±å°è£…ä¸€ä¸ªGoSafeå‡½æ•°ã€‚è¿™æ ·å°±å¯ä»¥åœ¨é‡Œé¢ç»Ÿä¸€æ•è·panicï¼Œç„¶åæ‰“åŒ…è°ƒç”¨æ ˆä¸€äº›ä¿¡æ¯ï¼Œè¿›ä¸€æ­¥å¤„ç†ã€‚</p>
<p>concé‡Œé¢å› ä¸ºæ¯ä¸ªgoroutineæœ‰owneræ¦‚å¿µï¼Œæ‰€ä»¥æ˜¯ç”±owneræ•è·goroutineçš„panicã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Catcher</span><span class="p">)</span> <span class="nf">tryRecover</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">val</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">();</span> <span class="nx">val</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rp</span> <span class="o">:=</span> <span class="nf">NewRecoveredPanic</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">p</span><span class="p">.</span><span class="nx">recovered</span><span class="p">.</span><span class="nf">CompareAndSwap</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">rp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>åªä¼šè®°å½•ç¬¬ä¸€ä¸ªpanicçš„goroutineå †æ ˆä¿¡æ¯ã€‚ç„¶ååœ¨Waitæ“ä½œçš„æ—¶å€™ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">WaitGroup</span><span class="p">)</span> <span class="nf">Wait</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">h</span><span class="p">.</span><span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Propagate a panic if we caught one from a child goroutine.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">h</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nf">Repanic</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Catcher</span><span class="p">)</span> <span class="nf">Repanic</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">val</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">Recovered</span><span class="p">();</span> <span class="nx">val</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nb">panic</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¶…çº§ç²—æš´ã€‚å½“conc.WaitGroupé‡Œé¢ä»»ä½•ä¸€ä¸ªgoroutineå‘ç”Ÿpanicï¼Œè°ƒç”¨wg.Wait()çš„æ—¶å€™å°±ä¼španicï¼ŒæŠŠgoroutine panicçš„å †æ ˆä¿¡æ¯ä½œä¸ºpanicçš„å€¼ã€‚</p>
<p>å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™å·²ç»çœ‹åˆ°ä»–ä»¬åœ¨issueä¸Šè®¨è®ºæ·»åŠ ä¸€ä¸ªç±»ä¼¼WaitSafe()å‡½æ•°äº†ã€‚</p>
<h4 id="make-concurrent-code-easier-to-read">Make concurrent code easier to read</h4>
<p>è¿™ä¸ªè¿˜æ˜¯èŠ‚çœäº†ä¸€äº›å·¥ä½œçš„ï¼Œä½œè€…ç»™äº†å‡ ä¸ªä¾‹å­ã€‚</p>
<p>ä¸Šé¢æˆ‘ä»¬çœ‹åˆ°çš„WaitGroupï¼Œä¸å†éœ€è¦ç”¨æˆ·æ‰§è¡ŒAddå’ŒDoneæ“ä½œäº†ã€‚åŒæ—¶å†…éƒ¨æ•è·panicï¼Œè™½ç„¶å¤„ç†æœ‰ç‚¹ç²—æš´ã€‚</p>
<p><img src="https://cdn.syst.top/conc3.png" alt="conc"></p>
<p>æ¯”å¦‚æ§åˆ¶å¹¶å‘goroutineæ•°é‡æ¥å¹¶å‘å¤„ç†æ‰¹é‡æ•°æ®çš„ä¾‹å­ã€‚</p>
<p><img src="https://cdn.syst.top/conc4.png" alt="conc"></p>
<p><img src="https://cdn.syst.top/conc5.png" alt="conc"></p>
<p>å¯ä»¥çœ‹å‡ºï¼Œç¡®å®çœäº†å¾ˆå¤šçš„æ“ä½œï¼Œå…¶ä»–ä¾‹å­å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹ã€‚</p>
<p>ä¸Šé¢æˆ‘ä»¬è¯´åˆ°poolï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªå¹¶å‘æ‰§è¡Œä»»åŠ¡çš„workeræ± ï¼Œä¹‹å‰æ–‡ç« ä¹Ÿä»‹ç»è¿‡è¿™ç§æ¨¡å¼ã€‚</p>
<p>concé‡Œé¢æœ‰å‡ ä¸ªç±»å‹çš„pool:ContextPoolï¼ŒErrorPoolï¼ŒResultPoolï¼ŒResultContextPoolï¼ŒResultErrorPoolã€‚</p>
<p>å®ƒä»¬éƒ½åŸºäºæœ€åŸºç¡€çš„Poolç»“æ„ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Pool</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">handle</span>   <span class="nx">conc</span><span class="p">.</span><span class="nx">WaitGroup</span>
</span></span><span class="line"><span class="cl">	<span class="nx">limiter</span>  <span class="nx">limiter</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tasks</span>    <span class="kd">chan</span> <span class="kd">func</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">initOnce</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Once</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>limiterå°±æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„ç”¨chanæ§åˆ¶worker goroutineæ•°é‡ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">limiter</span> <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="nx">limiter</span><span class="p">)</span> <span class="nf">limit</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">cap</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="nx">limiter</span><span class="p">)</span> <span class="nf">release</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">l</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="o">&lt;-</span><span class="nx">l</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æ ¸å¿ƒé€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Pool</span><span class="p">)</span> <span class="nf">Go</span><span class="p">(</span><span class="nx">f</span> <span class="kd">func</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">p</span><span class="p">.</span><span class="nf">init</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">limiter</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// No limit on the number of goroutines.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">p</span><span class="p">.</span><span class="nx">tasks</span> <span class="o">&lt;-</span> <span class="nx">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// A goroutine was available to handle the task.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// No goroutine was available to handle the task.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// Spawn a new one and send it the task.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">p</span><span class="p">.</span><span class="nx">handle</span><span class="p">.</span><span class="nf">Go</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">worker</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">p</span><span class="p">.</span><span class="nx">tasks</span> <span class="o">&lt;-</span> <span class="nx">f</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">p</span><span class="p">.</span><span class="nx">limiter</span> <span class="o">&lt;-</span> <span class="kd">struct</span><span class="p">{}{}:</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// If we are below our limit, spawn a new worker rather
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// than waiting for one to become available.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">p</span><span class="p">.</span><span class="nx">handle</span><span class="p">.</span><span class="nf">Go</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">worker</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// We know there is at least one worker running, so wait
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// for it to become available. This ensures we never spawn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// more workers than the number of tasks.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">p</span><span class="p">.</span><span class="nx">tasks</span> <span class="o">&lt;-</span> <span class="nx">f</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">p</span><span class="p">.</span><span class="nx">tasks</span> <span class="o">&lt;-</span> <span class="nx">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// A worker is available and has accepted the task.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å¦‚æœæ²¡æœ‰è®¾ç½®limiterï¼Œé‚£ä¹ˆä¼˜å…ˆæ‰¾ç©ºé—²çš„workerã€‚å¦åˆ™å°±åˆ›å»ºä¸€ä¸ªæ–°workerï¼Œç„¶åæŠ•é€’ä»»åŠ¡è¿›å»ã€‚</p>
<p>è®¾ç½®äº†limiterï¼Œ</p>
<p>å¦‚æœè¾¾åˆ°äº†limter workeræ•°é‡ä¸Šé™ï¼Œé‚£å°±åªèƒ½æŠŠä»»åŠ¡æŠ•é€’ç»™ç©ºé—²çš„workerï¼Œæ²¡æœ‰ç©ºé—²å°±é˜»å¡ç­‰ç€ã€‚</p>
<p>æ²¡æœ‰è¾¾åˆ°ä¸Šé™ï¼Œç©ºé—²workerä¹Ÿå­˜åœ¨ï¼Œé‚£å°±ç”±selectéšæœºé€‰æ‹©ï¼Œå¦åˆ™çš„è¯å°±åˆ›å»ºä¸€ä¸ªæ–°çš„workerã€‚</p>
<h4 id="å½©è›‹">å½©è›‹</h4>
<p>çœ‹ä»£ç çš„æ—¶å€™å‘ç°è¿™é‡Œé¢æœ‰ä¸ªé—®é¢˜ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Pool</span><span class="p">)</span> <span class="nf">deref</span><span class="p">()</span> <span class="nx">Pool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">Pool</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">limiter</span><span class="p">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">limiter</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¿™ä¸ªå‡½æ•°ä¼šè¿”å›ä¸€ä¸ªæ–°çš„Poolï¼Œä¸Šé¢æˆ‘è¯´è¿‡limiteræ˜¯ä¸€ä¸ªchanç»“æ„ï¼Œåœ¨goä¸­chanæ˜¯ä¸€ä¸ªå¼•ç”¨ç±»å‹ï¼Œæ‰€ä»¥è¿™é‡Œå¯¹limiterå°±æ˜¯ä¸€ä¸ªæµ…æ‹·è´ã€‚</p>
<p>å› æ­¤ï¼Œä¸‹é¢è¿™æ®µä»£ç ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">TestErrorPool</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">p</span> <span class="o">:=</span> <span class="nf">New</span><span class="p">().</span><span class="nf">WithMaxGoroutines</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">p</span><span class="p">.</span><span class="nf">Go</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{})</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//p.limiteré•¿åº¦æ˜¯1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">require</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">limiter</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">  <span class="c1">//æ–°çš„ErrorPool:é‡Œé¢çš„poolæ˜¯è°ƒç”¨p.derefå¾—åˆ°çš„.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">ep</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">WithErrors</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">require</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">ep</span><span class="p">.</span><span class="nx">pool</span><span class="p">.</span><span class="nx">limiter</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">  <span class="c1">//è¿™é‡Œçš„ep.limiterçš„é•¿åº¦ä¹Ÿæ˜¯1ï¼Œå°½ç®¡epæ²¡æœ‰è°ƒç”¨ä¸€æ¬¡ep.Go()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>æ­£å› ä¸ºè¿™ç§â€œç‰¹æ€§â€,å¦‚æœæˆ‘ä»¬å†™äº†ä¸‹é¢çš„ä»£ç ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">p</span> <span class="o">:=</span> <span class="nx">pool</span><span class="p">.</span><span class="nf">New</span><span class="p">().</span><span class="nf">WithMaxGoroutines</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">p</span><span class="p">.</span><span class="nf">Go</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;g1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">p</span><span class="p">.</span><span class="nf">Go</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;g2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//p.Wait()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">ep</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">WithErrors</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ep</span><span class="p">.</span><span class="nf">Go</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//è¿™æ®µä»£ç æ°¸è¿œæ²¡æœºä¼šæ‰§è¡Œ,æ³„æ¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;with err &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ep</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// å¦‚æœæˆ‘ä»¬æŠŠp.Wait() æ”¾åœ¨ep.Wait()ä¹‹å
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">p</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ep.Goé‡Œé¢çš„é€»è¾‘æ°¸è¿œéƒ½æ²¡æœºä¼šæ‰§è¡Œã€‚</p>
<p>åŸå› å°±åœ¨äºï¼Œç¬¬ä¸€ä¸ªloopåˆ›å»ºçš„æ—¶å€™é™åˆ¶äº†goroutineæ•°é‡ã€‚ç„¶åæ‰§è¡Œä¸¤æ¬¡p.Goï¼Œè¿™æ ·å°±ä¼šåˆ›å»ºä¸¤ä¸ªåªå±äºpçš„workersï¼ŒåŒæ—¶ä¹Ÿè®©limiteråˆ°è¾¾é™åˆ¶æ•°ã€‚</p>
<p>å½“epæƒ³è¦æ‰§è¡Œep.Goçš„æ—¶å€™ï¼Œåªèƒ½æ‰§è¡Œp.tasks &lt;- fï¼Œä½†æ˜¯è¿™æ—¶å€™epè¿˜æ²¡æœ‰æœºä¼šåˆ›å»ºå±äºè‡ªå·±çš„workerï¼Œæ‰€ä»¥ä¼šé˜»å¡åˆ°æ­»ã€‚</p>
<p>æˆ‘æäº†ä¸€ä¸ªprï¼Œå…¶å®å°±æ˜¯æŠŠä¸Šé¢çš„æµ…æ‹·è´æ¢æˆæ·±æ‹·è´ã€‚</p>
<p><img src="https://cdn.syst.top/conc6.png" alt="conc"></p>
<p>ä½†æ˜¯ä½œè€…å›å¤è¯´ï¼Œ</p>
<blockquote>
<p>Currently calling any configuration methods on the pool after calling pool.Go() is unsupported because the configuration methods take ownership of and mutate the pool. This might not be ideal though since ownership can&rsquo;t actually be enforced with Go. It would be less of a footgun to just return a fully copy each time.</p>
</blockquote>
<p>æˆ‘ç†è§£çš„æ„æ€å°±æ˜¯ç›®å‰ä¸æ”¯æŒæˆ‘è¿™ä¹ˆç©ï¼Œç®€å•çš„è¯´ä¸æ”¯æŒåœ¨æ‰§è¡Œpool.Go()åè°ƒç”¨è¿™äº›æ“ä½œğŸ˜‚ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>evioåŸç†è§£æï½æœ‰å½©è›‹</title>
			<link>https://www.syst.top/posts/go/evio/</link>
			<pubDate>Fri, 06 Jan 2023 19:23:51 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/evio/</guid>
			<description>ä¹‹å‰åˆ†æè¿‡goè‡ªå¸¦çš„netpollï¼Œä»¥åŠè‡ªå»ºçš„ç½‘ç»œæ¡†æ¶gnetã€‚
å½“ç„¶è¿™ç±»æ¡†æ¶è¿˜æœ‰:evioã€gevã€nbioã€cloudwego/netpoll(å­—èŠ‚çš„)ã€‚
ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¹ˆå¤šè‡ªå»ºæ¡†æ¶?
æˆ‘è§‰å¾—é€ƒä¸è¿‡ä¸‰ç‚¹ï¼Œ
  è‡ªå¸¦çš„netpollæ»¡è¶³ä¸äº†ä¸€äº›ç‰¹æ®Šåœºæ™¯ã€‚
  å…¶ä»–å®ç°è®¾è®¡å­˜åœ¨å±€é™æ€§ï¼Œå­˜åœ¨ä¼˜åŒ–ç©ºé—´ã€‚
  ç¨‹åºå‘˜éƒ½å–œæ¬¢è‡ªå·±é€ è½®å­ã€‚
  å¦å¤–ï¼Œè¿™ç±»æ¡†æ¶éƒ½æ˜¯åŸºäºsyscall epollå®ç°çš„äº‹ä»¶é©±åŠ¨æ¡†æ¶ã€‚ä¸»è¦åŒºåˆ«æˆ‘è§‰å¾—åœ¨äºï¼Œ
 å¯¹è¿æ¥connçš„ç®¡ç† å¯¹è¯»å†™æ•°æ®ç®¡ç†  å¸¦ç€è¿™äº›é—®é¢˜ï¼Œæˆ‘æ‰“ç®—æŠŠè¿™äº›æ¡†æ¶éƒ½çœ‹ä¸€éã€‚å­¦ä¹ é‡Œé¢ä¼˜ç§€çš„è®¾è®¡ä»¥åŠå¯¹æ¯”ä»–ä»¬çš„ä¸åŒç‚¹ï¼Œå¯ä»¥çš„è¯ï¼Œåšä¸ªæ•´ä½“çš„æ€§èƒ½æµ‹è¯•ã€‚
è¿™å‡ ä¸ªæ¡†æ¶ä¸­ï¼Œevioæ˜¯æœ€æ—©çš„å¼€æºå®ç°ï¼Œå¼€æºäº2017å¹´ã€‚
æœ‰æ„æ€çš„æ˜¯ï¼Œçœ‹åˆ°å‡ ç¯‡æ–‡ç« è¯´evioå­˜åœ¨å½“loopWriteåœ¨å†…æ ¸ç¼“å†²åŒºæ»¡ï¼Œæ— æ³•ä¸€æ¬¡å†™å…¥æ—¶ï¼Œä¼šå‡ºç°å†™å…¥æ•°æ®ä¸¢å¤±çš„bugã€‚
ä»”ç»†é˜…è¯»äº†ä»£ç ï¼Œevioå¹¶ä¸å­˜åœ¨è¿™ä¸ªbugã€‚ä¹Ÿä¸å­˜åœ¨æ˜¯ä½œè€…åæ¥ä¿®å¤äº†è¿™ä¸ªbugï¼Œè€Œæ˜¯evioæœ¬èº«ä¸å­˜åœ¨è¿™ä¸ªbugã€‚
ä¸‹é¢ä¼šè¯´æ˜ã€‚
åŸç†è§£æ æ ¹æ®ä»£ç ç”»äº†ä¸ªç®€æ˜“æ¶æ„å›¾è¯´æ˜evioæ¶æ„ã€‚
ç®€å•è§£é‡Šä¸€ä¸‹ï¼Œevioå¯åŠ¨çš„æ—¶å€™å¯ä»¥æŒ‡å®šloopsä¸ªæ•°ï¼Œå³å¤šå°‘ä¸ªepollå®ä¾‹ã€‚åŒæ—¶å¯ä»¥å¯åŠ¨å¤šä¸ªç›‘å¬åœ°å€ï¼Œæ¯”å¦‚å›¾ä¸­ç›‘å¬äº†ä¸¤ä¸ªç«¯å£ã€‚
ç¨‹åºä¼šæŠŠæ¯ä¸ªListener fdåŠ å…¥åˆ°æ¯ä¸ªepollå¹¶æ³¨å†Œè¿™äº›fdçš„è¯»äº‹ä»¶ã€‚æ¯ä¸ªepollä¼šå¼€å¯ä¸€ä¸ªgoroutineç­‰å¾…äº‹ä»¶åˆ°æ¥ã€‚
å½“å®¢æˆ·ç«¯å‘èµ·å¯¹åº”ç«¯å£è¿æ¥ï¼Œç¨‹åºä¼šæ ¹æ®ç­–ç•¥é€‰æ‹©ä¸€ä¸ªepollï¼Œå¹¶æŠŠconn fd ä¹ŸåŠ å…¥åˆ°æ­¤epollå¹¶æ³¨å†Œè¯»å†™äº‹ä»¶ã€‚
å½“ä¸€ä¸ªconn fdè¯»äº‹ä»¶readyï¼Œé‚£ä¹ˆå¯¹åº”çš„epollä¼šè¢«å”¤é†’ï¼Œç„¶åæ‰§è¡Œç›¸åº”çš„æ“ä½œã€‚
ä»¥ä¸Šå°±æ˜¯æ•´ç†çš„æµç¨‹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥æ·±å…¥ä¸€äº›ç»†èŠ‚ã€‚
åœ¨æ­¤ä¹‹å‰ï¼Œæ ¹æ®ä¸Šé¢æ‰€æè¿°çš„ï¼Œéœ€è¦å…ˆæå‡ ä¸ªé—®é¢˜ï¼Œ
 å½“ä¸€ä¸ªæ–°çš„å®¢æˆ·ç«¯è¿æ¥åˆ°æ¥æ—¶ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ è¯»å†™æ•°æ®æ˜¯å¦‚ä½•æµåŠ¨çš„ï¼Ÿ åŒä¸€ä¸ªepollé‡Œå¤šä¸ªfdè¯»å†™äº‹ä»¶readyï¼Œç¨‹åºæ˜¯å¦‚ä½•å¤„ç†çš„ï¼Ÿ  çœ‹å®Œä¸‹é¢ï¼Œå†å›æ¥å›ç­”è¿™ä¸‰ä¸ªé—®é¢˜ã€‚
ä»£ç ç»†èŠ‚ è¿è¡Œä¸€ä¸ªç®€å•demoï¼Œ
package main import ( &amp;#34;fmt&amp;#34; &amp;#34;github.com/tidwall/evio&amp;#34; &amp;#34;log&amp;#34; ) func main() { var events evio.Events events.NumLoops = 3 events.Serving = func(srv evio.Server) (action evio.Action) { log.</description>
			<content type="html"><![CDATA[<p>ä¹‹å‰åˆ†æè¿‡goè‡ªå¸¦çš„netpollï¼Œä»¥åŠè‡ªå»ºçš„ç½‘ç»œæ¡†æ¶gnetã€‚</p>
<p>å½“ç„¶è¿™ç±»æ¡†æ¶è¿˜æœ‰:evioã€gevã€nbioã€cloudwego/netpoll(å­—èŠ‚çš„)ã€‚</p>
<p>ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¹ˆå¤šè‡ªå»ºæ¡†æ¶?</p>
<p>æˆ‘è§‰å¾—é€ƒä¸è¿‡ä¸‰ç‚¹ï¼Œ</p>
<ul>
<li>
<p>è‡ªå¸¦çš„netpollæ»¡è¶³ä¸äº†ä¸€äº›ç‰¹æ®Šåœºæ™¯ã€‚</p>
</li>
<li>
<p>å…¶ä»–å®ç°è®¾è®¡å­˜åœ¨å±€é™æ€§ï¼Œå­˜åœ¨ä¼˜åŒ–ç©ºé—´ã€‚</p>
</li>
<li>
<p>ç¨‹åºå‘˜éƒ½å–œæ¬¢è‡ªå·±é€ è½®å­ã€‚</p>
</li>
</ul>
<p>å¦å¤–ï¼Œè¿™ç±»æ¡†æ¶éƒ½æ˜¯åŸºäºsyscall epollå®ç°çš„äº‹ä»¶é©±åŠ¨æ¡†æ¶ã€‚ä¸»è¦åŒºåˆ«æˆ‘è§‰å¾—åœ¨äºï¼Œ</p>
<ul>
<li>å¯¹è¿æ¥connçš„ç®¡ç†</li>
<li>å¯¹è¯»å†™æ•°æ®ç®¡ç†</li>
</ul>
<p>å¸¦ç€è¿™äº›é—®é¢˜ï¼Œæˆ‘æ‰“ç®—æŠŠè¿™äº›æ¡†æ¶éƒ½çœ‹ä¸€éã€‚å­¦ä¹ é‡Œé¢ä¼˜ç§€çš„è®¾è®¡ä»¥åŠå¯¹æ¯”ä»–ä»¬çš„ä¸åŒç‚¹ï¼Œå¯ä»¥çš„è¯ï¼Œåšä¸ªæ•´ä½“çš„æ€§èƒ½æµ‹è¯•ã€‚</p>
<p>è¿™å‡ ä¸ªæ¡†æ¶ä¸­ï¼Œevioæ˜¯æœ€æ—©çš„å¼€æºå®ç°ï¼Œå¼€æºäº2017å¹´ã€‚</p>
<p>æœ‰æ„æ€çš„æ˜¯ï¼Œçœ‹åˆ°å‡ ç¯‡æ–‡ç« è¯´evioå­˜åœ¨å½“loopWriteåœ¨å†…æ ¸ç¼“å†²åŒºæ»¡ï¼Œæ— æ³•ä¸€æ¬¡å†™å…¥æ—¶ï¼Œä¼šå‡ºç°å†™å…¥æ•°æ®ä¸¢å¤±çš„bugã€‚</p>
<p><img src="https://cdn.syst.top/evio3.png" alt=""></p>
<p>ä»”ç»†é˜…è¯»äº†ä»£ç ï¼Œevioå¹¶ä¸å­˜åœ¨è¿™ä¸ªbugã€‚ä¹Ÿä¸å­˜åœ¨æ˜¯ä½œè€…åæ¥ä¿®å¤äº†è¿™ä¸ªbugï¼Œè€Œæ˜¯evioæœ¬èº«ä¸å­˜åœ¨è¿™ä¸ªbugã€‚</p>
<p>ä¸‹é¢ä¼šè¯´æ˜ã€‚</p>
<h4 id="åŸç†è§£æ">åŸç†è§£æ</h4>
<p>æ ¹æ®ä»£ç ç”»äº†ä¸ªç®€æ˜“æ¶æ„å›¾è¯´æ˜evioæ¶æ„ã€‚</p>
<p><img src="https://cdn.syst.top/evio1.png" alt=""></p>
<p>ç®€å•è§£é‡Šä¸€ä¸‹ï¼Œevioå¯åŠ¨çš„æ—¶å€™å¯ä»¥æŒ‡å®šloopsä¸ªæ•°ï¼Œå³å¤šå°‘ä¸ªepollå®ä¾‹ã€‚åŒæ—¶å¯ä»¥å¯åŠ¨å¤šä¸ªç›‘å¬åœ°å€ï¼Œæ¯”å¦‚å›¾ä¸­ç›‘å¬äº†ä¸¤ä¸ªç«¯å£ã€‚</p>
<p>ç¨‹åºä¼šæŠŠæ¯ä¸ªListener fdåŠ å…¥åˆ°æ¯ä¸ªepollå¹¶æ³¨å†Œè¿™äº›fdçš„è¯»äº‹ä»¶ã€‚æ¯ä¸ªepollä¼šå¼€å¯ä¸€ä¸ªgoroutineç­‰å¾…äº‹ä»¶åˆ°æ¥ã€‚</p>
<p>å½“å®¢æˆ·ç«¯å‘èµ·å¯¹åº”ç«¯å£è¿æ¥ï¼Œç¨‹åºä¼šæ ¹æ®ç­–ç•¥é€‰æ‹©ä¸€ä¸ªepollï¼Œå¹¶æŠŠconn fd ä¹ŸåŠ å…¥åˆ°æ­¤epollå¹¶æ³¨å†Œè¯»å†™äº‹ä»¶ã€‚</p>
<p>å½“ä¸€ä¸ªconn fdè¯»äº‹ä»¶readyï¼Œé‚£ä¹ˆå¯¹åº”çš„epollä¼šè¢«å”¤é†’ï¼Œç„¶åæ‰§è¡Œç›¸åº”çš„æ“ä½œã€‚</p>
<p>ä»¥ä¸Šå°±æ˜¯æ•´ç†çš„æµç¨‹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥æ·±å…¥ä¸€äº›ç»†èŠ‚ã€‚</p>
<p>åœ¨æ­¤ä¹‹å‰ï¼Œæ ¹æ®ä¸Šé¢æ‰€æè¿°çš„ï¼Œéœ€è¦å…ˆæå‡ ä¸ªé—®é¢˜ï¼Œ</p>
<ul>
<li>å½“ä¸€ä¸ªæ–°çš„å®¢æˆ·ç«¯è¿æ¥åˆ°æ¥æ—¶ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</li>
<li>è¯»å†™æ•°æ®æ˜¯å¦‚ä½•æµåŠ¨çš„ï¼Ÿ</li>
<li>åŒä¸€ä¸ªepollé‡Œå¤šä¸ªfdè¯»å†™äº‹ä»¶readyï¼Œç¨‹åºæ˜¯å¦‚ä½•å¤„ç†çš„ï¼Ÿ</li>
</ul>
<p>çœ‹å®Œä¸‹é¢ï¼Œå†å›æ¥å›ç­”è¿™ä¸‰ä¸ªé—®é¢˜ã€‚</p>
<h5 id="ä»£ç ç»†èŠ‚">ä»£ç ç»†èŠ‚</h5>
<p>è¿è¡Œä¸€ä¸ªç®€å•demoï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/tidwall/evio&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">events</span> <span class="nx">evio</span><span class="p">.</span><span class="nx">Events</span>
</span></span><span class="line"><span class="cl">	<span class="nx">events</span><span class="p">.</span><span class="nx">NumLoops</span> <span class="p">=</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">	<span class="nx">events</span><span class="p">.</span><span class="nx">Serving</span> <span class="p">=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">srv</span> <span class="nx">evio</span><span class="p">.</span><span class="nx">Server</span><span class="p">)</span> <span class="p">(</span><span class="nx">action</span> <span class="nx">evio</span><span class="p">.</span><span class="nx">Action</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;echo server started&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">events</span><span class="p">.</span><span class="nx">Data</span> <span class="p">=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="nx">evio</span><span class="p">.</span><span class="nx">Conn</span><span class="p">,</span> <span class="nx">in</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">out</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">action</span> <span class="nx">evio</span><span class="p">.</span><span class="nx">Action</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;receiver data:&#34;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">in</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="nx">out</span> <span class="p">=</span> <span class="nx">in</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">evio</span><span class="p">.</span><span class="nf">Serve</span><span class="p">(</span><span class="nx">events</span><span class="p">,</span> <span class="s">&#34;tcp://:8089&#34;</span><span class="p">,</span> <span class="s">&#34;tcp://:8088&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬æŒ‡å®šNumLoopsçš„æ•°é‡æ˜¯3ï¼Œç„¶åä¼ å…¥äº†ä¸¤ä¸ªåœ°å€ã€‚</p>
<p>ä¸Šé¢è¿˜æœ‰ä¸¤ä¸ªé—­åŒ…å‡½æ•°ï¼Œå½“æœåŠ¡å¯åŠ¨çš„æ—¶å€™ä¼šå›è°ƒevents.Servingå‡½æ•°ï¼Œç„¶åè¿”å›ä¸€ä¸ªActionã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// None indicates that no action should occur following an event.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">None</span> <span class="nx">Action</span> <span class="p">=</span> <span class="kc">iota</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Detach detaches a connection. Not available for UDP connections.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Detach</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Close closes the connection.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Close</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Shutdown shutdowns the server.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Shutdown</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><p>æ¯”å¦‚å½“ä½ è¿”å›ä¸€ä¸ªShutdownçš„actionï¼Œé‚£ä¹ˆç¨‹åºå°±ç›´æ¥é€€å‡ºäº†ã€‚</p>
<p>å½“æœ‰å®¢æˆ·ç«¯æ•°æ®åˆ°æ¥æ—¶ï¼Œå›è°ƒevents.Dataå‡½æ•°ï¼Œè¿”å›outå’Œactionï¼Œoutè¡¨ç¤ºè¦å‘é€çš„æ•°æ®ã€‚</p>
<p>æœ€ç»ˆè°ƒç”¨ evio.Serveå‡½æ•°ï¼Œä¼ å…¥ä¸¤ä¸ªåœ°å€ï¼Œå¯åŠ¨æœåŠ¡ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Serve</span><span class="p">(</span><span class="nx">events</span> <span class="nx">Events</span><span class="p">,</span> <span class="nx">addr</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">lns</span> <span class="p">[]</span><span class="o">*</span><span class="nx">listener</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ln</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">lns</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ln</span><span class="p">.</span><span class="nb">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">addr</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">addr</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="nx">ln</span> <span class="nx">listener</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ln</span><span class="p">.</span><span class="nx">network</span><span class="p">,</span> <span class="nx">ln</span><span class="p">.</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">ln</span><span class="p">.</span><span class="nx">opts</span><span class="p">,</span> <span class="nx">_</span><span class="p">=</span> <span class="nf">parseAddr</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">ln</span><span class="p">.</span><span class="nx">network</span> <span class="o">==</span> <span class="s">&#34;unix&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">os</span><span class="p">.</span><span class="nf">RemoveAll</span><span class="p">(</span><span class="nx">ln</span><span class="p">.</span><span class="nx">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">ln</span><span class="p">.</span><span class="nx">network</span> <span class="o">==</span> <span class="s">&#34;udp&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">ln</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">reusePort</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">ln</span><span class="p">.</span><span class="nx">pconn</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">reuseportListenPacket</span><span class="p">(</span><span class="nx">ln</span><span class="p">.</span><span class="nx">network</span><span class="p">,</span> <span class="nx">ln</span><span class="p">.</span><span class="nx">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">ln</span><span class="p">.</span><span class="nx">pconn</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">ListenPacket</span><span class="p">(</span><span class="nx">ln</span><span class="p">.</span><span class="nx">network</span><span class="p">,</span> <span class="nx">ln</span><span class="p">.</span><span class="nx">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">ln</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">reusePort</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">ln</span><span class="p">.</span><span class="nx">ln</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">reuseportListen</span><span class="p">(</span><span class="nx">ln</span><span class="p">.</span><span class="nx">network</span><span class="p">,</span> <span class="nx">ln</span><span class="p">.</span><span class="nx">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">ln</span><span class="p">.</span><span class="nx">ln</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="nx">ln</span><span class="p">.</span><span class="nx">network</span><span class="p">,</span> <span class="nx">ln</span><span class="p">.</span><span class="nx">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">ln</span><span class="p">.</span><span class="nx">pconn</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ln</span><span class="p">.</span><span class="nx">lnaddr</span> <span class="p">=</span> <span class="nx">ln</span><span class="p">.</span><span class="nx">pconn</span><span class="p">.</span><span class="nf">LocalAddr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ln</span><span class="p">.</span><span class="nx">lnaddr</span> <span class="p">=</span> <span class="nx">ln</span><span class="p">.</span><span class="nx">ln</span><span class="p">.</span><span class="nf">Addr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">lns</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">lns</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">ln</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">serve</span><span class="p">(</span><span class="nx">events</span><span class="p">,</span> <span class="nx">lns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æˆ‘åˆ é™¤äº†ä¸€äº›æ— å…³ä»£ç ã€‚</p>
<p>Serve å‡½æ•°é‡Œé¢éå†ä¼ å…¥çš„åœ°å€è¯†åˆ«åè®®ï¼Œæ‰§è¡Œå¯¹åº”listenæ“ä½œã€‚udpè¿”å›ä¸€ä¸ªPacketConnï¼Œè€Œtcpè¿”å›ä¸€ä¸ªListenerã€‚æœ€ç»ˆç”¨è‡ªå®šä¹‰çš„listenerç»Ÿä¸€è¡¨ç¤ºã€‚æœ€ç»ˆè°ƒç”¨serveã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">serve</span><span class="p">(</span><span class="nx">events</span> <span class="nx">Events</span><span class="p">,</span> <span class="nx">listeners</span> <span class="p">[]</span><span class="o">*</span><span class="nx">listener</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// figure out the correct number of loops/goroutines to use.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">numLoops</span> <span class="o">:=</span> <span class="nx">events</span><span class="p">.</span><span class="nx">NumLoops</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">numLoops</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">numLoops</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">numLoops</span> <span class="p">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">numLoops</span> <span class="p">=</span> <span class="nx">runtime</span><span class="p">.</span><span class="nf">NumCPU</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">s</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">server</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">events</span> <span class="p">=</span> <span class="nx">events</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">lns</span> <span class="p">=</span> <span class="nx">listeners</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">cond</span> <span class="p">=</span> <span class="nx">sync</span><span class="p">.</span><span class="nf">NewCond</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">balance</span> <span class="p">=</span> <span class="nx">events</span><span class="p">.</span><span class="nx">LoadBalance</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">tch</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//println(&#34;-- server starting&#34;)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">Serving</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="nx">svr</span> <span class="nx">Server</span>
</span></span><span class="line"><span class="cl">		<span class="nx">svr</span><span class="p">.</span><span class="nx">NumLoops</span> <span class="p">=</span> <span class="nx">numLoops</span>
</span></span><span class="line"><span class="cl">		<span class="nx">svr</span><span class="p">.</span><span class="nx">Addrs</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">net</span><span class="p">.</span><span class="nx">Addr</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">listeners</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">ln</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">listeners</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">svr</span><span class="p">.</span><span class="nx">Addrs</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">ln</span><span class="p">.</span><span class="nx">lnaddr</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">action</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nf">Serving</span><span class="p">(</span><span class="nx">svr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">switch</span> <span class="nx">action</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">Shutdown</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// wait on a signal for shutdown
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">s</span><span class="p">.</span><span class="nf">waitForShutdown</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// notify all loops to close by closing all listeners
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">l</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span><span class="p">.</span><span class="nx">loops</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">l</span><span class="p">.</span><span class="nx">poll</span><span class="p">.</span><span class="nf">Trigger</span><span class="p">(</span><span class="nx">errClosing</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// wait on all loops to complete reading events
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">s</span><span class="p">.</span><span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// close loops and all outstanding connections
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">l</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span><span class="p">.</span><span class="nx">loops</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">c</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">l</span><span class="p">.</span><span class="nx">fdconns</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nf">loopCloseConn</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">l</span><span class="p">.</span><span class="nx">poll</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//println(&#34;-- server stopped&#34;)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// create loops locally and bind the listeners.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">numLoops</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">l</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">loop</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">idx</span><span class="p">:</span>     <span class="nx">i</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">poll</span><span class="p">:</span>    <span class="nx">internal</span><span class="p">.</span><span class="nf">OpenPoll</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">			<span class="nx">packet</span><span class="p">:</span>  <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fdconns</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="o">*</span><span class="nx">conn</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ln</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">listeners</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">l</span><span class="p">.</span><span class="nx">poll</span><span class="p">.</span><span class="nf">AddRead</span><span class="p">(</span><span class="nx">ln</span><span class="p">.</span><span class="nx">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">s</span><span class="p">.</span><span class="nx">loops</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">loops</span><span class="p">,</span> <span class="nx">l</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// start loops in background
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">s</span><span class="p">.</span><span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">loops</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">l</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span><span class="p">.</span><span class="nx">loops</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nf">loopRun</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">l</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¿™ä¸ªå‡½æ•°é€»è¾‘:</p>
<p>1.å…ˆåˆå§‹åŒ–ä¸€ä¸ªè‡ªå®šä¹‰serverç»“æ„ï¼Œç¡®å®šè´Ÿè½½å‡è¡¡ç®—æ³•ã€‚</p>
<p>2.å›è°ƒè‡ªå®šä¹‰çš„servingé—­åŒ…å‡½æ•°ã€‚</p>
<p>3.æ ¹æ®numloopså€¼ï¼Œåˆ›å»ºå¯¹åº”æ•°é‡çš„epollå°è£…åœ¨è‡ªå®šä¹‰ç»“æ„loopä¸­ã€‚å¹¶æŠŠæ¯ä¸€ä¸ªlistenerå¯¹åº”çš„fdåŠ å…¥åˆ°æ¯ä¸€ä¸ªepollåŒæ—¶æ³¨å†Œfdçš„è¯»äº‹ä»¶ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ln</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">listeners</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">l</span><span class="p">.</span><span class="nx">poll</span><span class="p">.</span><span class="nf">AddRead</span><span class="p">(</span><span class="nx">ln</span><span class="p">.</span><span class="nx">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Poll</span><span class="p">)</span> <span class="nf">AddRead</span><span class="p">(</span><span class="nx">fd</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">syscall</span><span class="p">.</span><span class="nf">EpollCtl</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">fd</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EPOLL_CTL_ADD</span><span class="p">,</span> <span class="nx">fd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="o">&amp;</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">EpollEvent</span><span class="p">{</span><span class="nx">Fd</span><span class="p">:</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">fd</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Events</span><span class="p">:</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EPOLLIN</span><span class="p">,</span> <span class="c1">//è¯»äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>4.éå†loops,æ¯ä¸ªloopéƒ½ç”¨ä¸€ä¸ªgæ‰§è¡ŒloopRunå‡½æ•°ã€‚</p>
<p>è‡³äºloopRunå‡½æ•°ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">loopRun</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">server</span><span class="p">,</span> <span class="nx">l</span> <span class="o">*</span><span class="nx">loop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//fmt.Println(&#34;-- loop stopped --&#34;, l.idx)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">s</span><span class="p">.</span><span class="nf">signalShutdown</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">s</span><span class="p">.</span><span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">idx</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">Tick</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nf">loopTicker</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">l</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//fmt.Println(&#34;-- loop started --&#34;, l.idx)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">l</span><span class="p">.</span><span class="nx">poll</span><span class="p">.</span><span class="nf">Wait</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">fd</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">note</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">fd</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nf">loopNote</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">note</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">fdconns</span><span class="p">[</span><span class="nx">fd</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="k">switch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">c</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nf">loopAccept</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="p">!</span><span class="nx">c</span><span class="p">.</span><span class="nx">opened</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nf">loopOpened</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">out</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nf">loopWrite</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">c</span><span class="p">.</span><span class="nx">action</span> <span class="o">!=</span> <span class="nx">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nf">loopAction</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nf">loopRead</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æ¯ä¸ªloopéƒ½ä¼šè°ƒç”¨epoll.Waitå‡½æ•°é˜»å¡ç­‰å¾…äº‹ä»¶åˆ°æ¥ï¼Œå‚æ•°æ—¶ä¸€ä¸ªé—­åŒ…å‡½æ•°ï¼Œæ¯ä¸€ä¸ªåˆ°è¾¾çš„äº‹ä»¶éƒ½ä¼šå›è°ƒæ­¤é—­åŒ…æ‰§è¡Œç›¸åº”æ“ä½œã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Poll</span><span class="p">)</span> <span class="nf">Wait</span><span class="p">(</span><span class="nx">iter</span> <span class="kd">func</span><span class="p">(</span><span class="nx">fd</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">note</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">events</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">EpollEvent</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç­‰å¾…äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">syscall</span><span class="p">.</span><span class="nf">EpollWait</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">fd</span><span class="p">,</span> <span class="nx">events</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EINTR</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nf">ForEach</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">note</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nf">iter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">note</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// æ­£å¸¸çš„å®¢æˆ·ç«¯fd
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">fd</span> <span class="o">:=</span> <span class="nb">int</span><span class="p">(</span><span class="nx">events</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Fd</span><span class="p">);</span> <span class="nx">fd</span> <span class="o">!=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">wfd</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">iter</span><span class="p">(</span><span class="nx">fd</span><span class="p">,</span> <span class="kc">nil</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">fd</span> <span class="o">==</span> <span class="nx">p</span><span class="p">.</span><span class="nx">wfd</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="kd">var</span> <span class="nx">data</span> <span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">				<span class="nx">syscall</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">wfd</span><span class="p">,</span> <span class="nx">data</span><span class="p">[:])</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å›åˆ°ä¸Šä¸€æ­¥ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">l</span><span class="p">.</span><span class="nx">poll</span><span class="p">.</span><span class="nf">Wait</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">fd</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">note</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">fd</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nf">loopNote</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">note</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">fdconns</span><span class="p">[</span><span class="nx">fd</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="k">switch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">c</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nf">loopAccept</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="p">!</span><span class="nx">c</span><span class="p">.</span><span class="nx">opened</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nf">loopOpened</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">out</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nf">loopWrite</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">c</span><span class="p">.</span><span class="nx">action</span> <span class="o">!=</span> <span class="nx">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nf">loopAction</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nf">loopRead</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span></code></pre></div><p>æ³¨æ„è¿™é‡Œæ˜¯æ¯ä¸ªloopéƒ½ä¼šè°ƒç”¨è‡ªå·±çš„epoll.Waitã€‚å½“å¯¹åº”çš„Listeneræ¥äº†ä¸€ä¸ªæ–°å®¢æˆ·ç«¯è¿æ¥ï¼Œæ‰€æœ‰çš„epolléƒ½ä¼šè¢«â€œæƒŠé†’â€ï¼Œè¿™å°±æ˜¯æƒŠç¾¤æ•ˆåº”ã€‚</p>
<blockquote>
<p>æƒŠç¾¤æ•ˆåº”ï¼ˆthundering herdï¼‰æ˜¯æŒ‡å¤šè¿›ç¨‹ï¼ˆå¤šçº¿ç¨‹ï¼‰åœ¨åŒæ—¶é˜»å¡ç­‰å¾…åŒä¸€ä¸ªäº‹ä»¶çš„æ—¶å€™ï¼ˆä¼‘çœ çŠ¶æ€ï¼‰ï¼Œå¦‚æœç­‰å¾…çš„è¿™ä¸ªäº‹ä»¶å‘ç”Ÿï¼Œé‚£ä¹ˆå®ƒå°±ä¼šå”¤é†’ç­‰å¾…çš„æ‰€æœ‰è¿›ç¨‹ï¼ˆæˆ–è€…çº¿ç¨‹ï¼‰</p>
</blockquote>
<p>ç„¶åæ‰€æœ‰çš„loopéƒ½ä¼šæ‰§è¡ŒloopAcceptå‡½æ•°ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">loopAccept</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">server</span><span class="p">,</span> <span class="nx">l</span> <span class="o">*</span><span class="nx">loop</span><span class="p">,</span> <span class="nx">fd</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">ln</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span><span class="p">.</span><span class="nx">lns</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// ç¡®å®æ˜¯å“ªä¸ªlistener fd äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="nx">ln</span><span class="p">.</span><span class="nx">fd</span> <span class="o">==</span> <span class="nx">fd</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">loops</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">switch</span> <span class="nx">s</span><span class="p">.</span><span class="nx">balance</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nx">LeastConnections</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">               <span class="nx">n</span> <span class="o">:=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">LoadInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">l</span><span class="p">.</span><span class="nx">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">               <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">lp</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span><span class="p">.</span><span class="nx">loops</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="c1">// å¯¹æ¯”å…¶ä»–çš„loopï¼Œæœ‰æ¯”è‡ªå·±è¿æ¥æ•°å°‘çš„ï¼Œè‡ªå·±å°±ä¸è¿æ¥äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                  <span class="k">if</span> <span class="nx">lp</span><span class="p">.</span><span class="nx">idx</span> <span class="o">!=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">idx</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                     <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">LoadInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lp</span><span class="p">.</span><span class="nx">count</span><span class="p">)</span> <span class="p">&lt;</span> <span class="nx">n</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="kc">nil</span> <span class="c1">// do not accept
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                     <span class="p">}</span>
</span></span><span class="line"><span class="cl">                  <span class="p">}</span>
</span></span><span class="line"><span class="cl">               <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nx">RoundRobin</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">               <span class="nx">idx</span> <span class="o">:=</span> <span class="nb">int</span><span class="p">(</span><span class="nx">atomic</span><span class="p">.</span><span class="nf">LoadUintptr</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">s</span><span class="p">.</span><span class="nx">accepted</span><span class="p">))</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">loops</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">               <span class="c1">//è¿˜æ²¡è½®åˆ°æˆ‘ï¼Œä¹Ÿä¸èƒ½è¿æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>               <span class="k">if</span> <span class="nx">idx</span> <span class="o">!=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">idx</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="k">return</span> <span class="kc">nil</span> <span class="c1">// do not accept
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>               <span class="p">}</span>
</span></span><span class="line"><span class="cl">               <span class="nx">atomic</span><span class="p">.</span><span class="nf">AddUintptr</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">s</span><span class="p">.</span><span class="nx">accepted</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="c1">// udp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="k">if</span> <span class="nx">ln</span><span class="p">.</span><span class="nx">pconn</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nf">loopUDPRead</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="nx">nfd</span><span class="p">,</span> <span class="nx">sa</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">syscall</span><span class="p">.</span><span class="nf">Accept</span><span class="p">(</span><span class="nx">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EAGAIN</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="c1">//è®¾ç½® conn fd ä¸ºéé˜»å¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">syscall</span><span class="p">.</span><span class="nf">SetNonblock</span><span class="p">(</span><span class="nx">nfd</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="nx">c</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">conn</span><span class="p">{</span><span class="nx">fd</span><span class="p">:</span> <span class="nx">nfd</span><span class="p">,</span> <span class="nx">sa</span><span class="p">:</span> <span class="nx">sa</span><span class="p">,</span> <span class="nx">lnidx</span><span class="p">:</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">loop</span><span class="p">:</span> <span class="nx">l</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="nx">c</span><span class="p">.</span><span class="nx">out</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">         <span class="nx">l</span><span class="p">.</span><span class="nx">fdconns</span><span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">fd</span><span class="p">]</span> <span class="p">=</span> <span class="nx">c</span>
</span></span><span class="line"><span class="cl">         <span class="c1">//æŠŠconn fd æ³¨å†Œåˆ°æ­¤epollï¼Œä¸”ç›‘å¬è¯»å†™äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="nx">l</span><span class="p">.</span><span class="nx">poll</span><span class="p">.</span><span class="nf">AddReadWrite</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="nx">atomic</span><span class="p">.</span><span class="nf">AddInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">l</span><span class="p">.</span><span class="nx">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="k">break</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>loopAcceptåšäº†å‡ ä»¶äº‹ï¼š</p>
<p>1.ç¡®å®šå°±ç»ªçš„fdæ˜¯å“ªä¸ªlistener</p>
<p>2.å¦‚æœloopså¤§äº1ï¼Œé€šè¿‡ç­–ç•¥é€‰æ‹©å…¶ä¸­ä¸€ä¸ªloop,åŒ…è£…conn fdä¸”è®¾ç½®conn fdä¸ºéé˜»å¡(æ€è€ƒä¸‹å¦‚æœè®©conn fdä¿æŒé˜»å¡çŠ¶æ€ï¼Œä¼šå½±å“åˆ°ä»€ä¹ˆï¼Ÿ)</p>
<p>3.æœ€åæŠŠè¿™ä¸ªconn fdåŠ å…¥åˆ°å½“å‰epollå¹¶ä¸”æ³¨å†Œè¯»å†™äº‹ä»¶</p>
<p>å› æ­¤å½“ä¸€ä¸ªæ–°çš„å®¢æˆ·ç«¯è¿æ¥åˆ°æ¥æ—¶ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p>
<p>ä¼šäº§ç”ŸæƒŠç¾¤æ•ˆåº”ã€‚</p>
<p>é‚£å¦‚æœæ˜¯å·²å­˜åœ¨çš„conn fdçš„å¯è¯»äº‹ä»¶ï¼Œä¼šå‘ç”ŸæƒŠç¾¤æ•ˆåº”å—ï¼Ÿ</p>
<p>ä¸ä¼šï¼Œå› ä¸ºä¸€ä¸ªconn fdåªä¼šåŠ å…¥åˆ°å…¶ä¸­ä¸€ä¸ªepollä¸­ã€‚</p>
<p>å› ä¸ºevioåˆ›å»ºepollçš„æ—¶å€™é»˜è®¤æ˜¯æ°´å¹³è§¦å‘LT(level-triggered)ï¼Œå½“åŠ å…¥çš„conn fdåŒ…å«å†™äº‹ä»¶æ—¶ï¼Œå¦‚æœæ­¤æ—¶å†…æ ¸å†™ç¼“å†²åŒºç©ºé—´æœªæ»¡ï¼Œé‚£ä¹ˆepollä¼šå†æ¬¡è¢«å”¤é†’ã€‚æ­¤æ—¶é€šè¿‡f.fdconns[fd]ä¼šæ‰¾åˆ°å¯¹åº”çš„connï¼Œç”±äºè¿æ¥åˆå§‹åŒ–å¹¶æœªè®¾ç½®openedçš„ç›´ï¼Œå› æ­¤ä¼šè¿›å…¥loopOpenedå‡½æ•°ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">loopOpened</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">server</span><span class="p">,</span> <span class="nx">l</span> <span class="o">*</span><span class="nx">loop</span><span class="p">,</span> <span class="nx">c</span> <span class="o">*</span><span class="nx">conn</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nx">opened</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nx">addrIndex</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">lnidx</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nx">localAddr</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">lns</span><span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">lnidx</span><span class="p">].</span><span class="nx">lnaddr</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nx">remoteAddr</span> <span class="p">=</span> <span class="nx">internal</span><span class="p">.</span><span class="nf">SockaddrToAddr</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">sa</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">Opened</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">out</span><span class="p">,</span> <span class="nx">opts</span><span class="p">,</span> <span class="nx">action</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nf">Opened</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">out</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">out</span> <span class="p">=</span> <span class="nb">append</span><span class="p">([]</span><span class="kt">byte</span><span class="p">{},</span> <span class="nx">out</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">action</span> <span class="p">=</span> <span class="nx">action</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">reuse</span> <span class="p">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">ReuseInputBuffer</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">TCPKeepAlive</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">lns</span><span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">lnidx</span><span class="p">].</span><span class="nx">ln</span><span class="p">.(</span><span class="o">*</span><span class="nx">net</span><span class="p">.</span><span class="nx">TCPListener</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">internal</span><span class="p">.</span><span class="nf">SetKeepAlive</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">fd</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">TCPKeepAlive</span><span class="o">/</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// æ²¡æœ‰å¯å†™çš„æ•°æ®ï¼Œå¹¶ä¸”ä¹Ÿæœªè®¾ç½®è¿æ¥çš„actionï¼Œé‡æ–°ä¿®æ”¹æ­¤connåªæœ‰readäº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">action</span> <span class="o">==</span> <span class="nx">None</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">l</span><span class="p">.</span><span class="nx">poll</span><span class="p">.</span><span class="nf">ModRead</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æ— éæ˜¯ä¸€äº›ç®€å•èµ‹å€¼æ“ä½œï¼Œå¦‚æœè®¾ç½®äº†Openedé—­åŒ…å‡½æ•°ï¼Œé‚£ä¹ˆå›è°ƒå®ƒã€‚</p>
<p>æœ€åå¦‚æœoutæ²¡æœ‰å¯å‘é€çš„äº‹ä»¶ï¼Œé‚£ä¹ˆå°±é‡æ–°æŠŠæ­¤conn fdä¿®æ”¹æˆè¯»äº‹ä»¶ã€‚</p>
<p>æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœåœ¨æ²¡æœ‰å¯å†™æ•°æ®çš„æƒ…å†µä¸‹ï¼ŒåŠ å…¥epollçš„conn fdæ³¨å†Œå«æœ‰å†™äº‹ä»¶ï¼Œé‚£ä¹ˆåªè¦å†…æ ¸å†™ç¼“å­˜åŒºæœªæ»¡ï¼Œæ­¤epollä¼šä¸æ–­è¢«å”¤é†’ï¼Œæˆ‘ç§°å®ƒæ˜¯ç©ºè½¬ã€‚</p>
<p>å¦‚æœä¸Šé¢ä½ è®¾ç½®äº†Openedé—­åŒ…å‡½æ•°ä¸”æœ€ç»ˆactionè®¾ç½®äº†å€¼ï¼Œé‚£ä¹ˆå°±è¿˜æ˜¯ä¿æŒæ­¤conn fdçš„è¯»å†™äº‹ä»¶ã€‚</p>
<p>è¿™æ—¶å€™å†æ¬¡å”¤é†’çš„epollä¼šæ‰§è¡ŒloopActionï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">loopAction</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">server</span><span class="p">,</span> <span class="nx">l</span> <span class="o">*</span><span class="nx">loop</span><span class="p">,</span> <span class="nx">c</span> <span class="o">*</span><span class="nx">conn</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">switch</span> <span class="nx">c</span><span class="p">.</span><span class="nx">action</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="nx">c</span><span class="p">.</span><span class="nx">action</span> <span class="p">=</span> <span class="nx">None</span>
</span></span><span class="line"><span class="cl">   <span class="k">case</span> <span class="nx">Close</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nf">loopCloseConn</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">case</span> <span class="nx">Shutdown</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">errClosing</span>
</span></span><span class="line"><span class="cl">   <span class="k">case</span> <span class="nx">Detach</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nf">loopDetachConn</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">action</span> <span class="o">==</span> <span class="nx">None</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">l</span><span class="p">.</span><span class="nx">poll</span><span class="p">.</span><span class="nf">ModRead</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ä¸Šé¢ä»£ç å¾ˆç®€å•ã€‚</p>
<p>å½“clientå‘é€æ•°æ®ï¼Œepollè¢«å”¤é†’ï¼Œæ‰§è¡ŒloopReadã€‚</p>
<pre tabindex="0"><code>func loopRead(s *server, l *loop, c *conn) error {
   var in []byte
   // è¯»æ•°æ®
   n, err := syscall.Read(c.fd, l.packet)
   if n == 0 || err != nil {
      if err == syscall.EAGAIN {
         return nil
      }
      return loopCloseConn(s, l, c, err)
   }
   in = l.packet[:n]
   if !c.reuse {
      in = append([]byte{}, in...)
   }
   // å›è°ƒdataé—­åŒ…å‡½æ•°
   if s.events.Data != nil {
      out, action := s.events.Data(c, in)
      c.action = action
      // è¡¨ç¤ºè¦å‘é€çš„æ•°æ®
      if len(out) &gt; 0 {
         c.out = append(c.out[:0], out...)
      }
   }
   // è¯´æ˜æœ‰æ•°æ®è¦å‘é€ï¼Œé‡æ–°æ³¨å†Œè¯»å†™äº‹ä»¶
   if len(c.out) != 0 || c.action != None {
      l.poll.ModReadWrite(c.fd)
   }
   return nil
}
</code></pre><p>å…ˆè¯»å–æ•°æ®ï¼Œå¦‚æœæœ‰æ•°æ®è¦å‘é€ï¼Œåˆä¼šä¿®æ”¹conn fdä¸ºè¯»å†™äº‹ä»¶ã€‚å½“epollå†æ¬¡è¢«å”¤é†’ï¼Œä¸”c.outä¸ä¸ºç©ºæ—¶ï¼Œæ‰§è¡ŒloopWriteã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">loopWrite</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">server</span><span class="p">,</span> <span class="nx">l</span> <span class="o">*</span><span class="nx">loop</span><span class="p">,</span> <span class="nx">c</span> <span class="o">*</span><span class="nx">conn</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">PreWrite</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">s</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nf">PreWrite</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">syscall</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">fd</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">EAGAIN</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">loopCloseConn</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// è¯´æ˜ä¸€æ¬¡å°±å†™å®Œæ•°æ®äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">n</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">out</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// release the connection output page if it goes over page size,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// otherwise keep reusing existing page.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// ä¸è®©outæ— é™å¢é•¿ç©ºé—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nb">cap</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">out</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">4096</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">out</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// é‡ç½®nilï¼Œå¤ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">c</span><span class="p">.</span><span class="nx">out</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">out</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//æ²¡å†™å®Œï¼Œç•™ç€åé¢æ²¡å†™çš„éƒ¨åˆ†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">c</span><span class="p">.</span><span class="nx">out</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">out</span><span class="p">[</span><span class="nx">n</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// å…¨å†™å®Œäº†ï¼Œé‡æ–°è°ƒæ•´ä¸ºè¯»äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">action</span> <span class="o">==</span> <span class="nx">None</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">l</span><span class="p">.</span><span class="nx">poll</span><span class="p">.</span><span class="nf">ModRead</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å¦‚æœä¸€æ¬¡å†™å®Œæ•°æ®ï¼Œé‚£ä¹ˆè¯´æ˜æš‚æ—¶æ²¡æœ‰å¯å†™çš„æ•°æ®äº†ï¼Œé‡æ–°ä¿®æ”¹conn fdä¸ºè¯»äº‹ä»¶ã€‚</p>
<p>å¦‚æœä¸€æ¬¡æ²¡å†™å®Œï¼Œé‚£ä¹ˆä¿ç•™æœªå†™å®Œçš„æ•°æ®ï¼Œä¸‹æ¬¡epollå”¤é†’çš„æ—¶å€™ç»§ç»­å†™ã€‚</p>
<p>ä¸Šé¢æåˆ°ï¼Œä¸€äº›æ–‡ç« æåˆ°ï¼Œevioå­˜åœ¨ loopWriteåœ¨å†…æ ¸ç¼“å†²åŒºæ»¡ï¼Œæ— æ³•ä¸€æ¬¡å†™å…¥æ—¶ï¼Œä¼šå‡ºç°å†™å…¥æ•°æ®ä¸¢å¤±çš„bugã€‚</p>
<p>ç»™çš„ç†ç”±æ˜¯ï¼Œå½“å†…æ ¸å†™ç¼“å†²åŒºæ»¡äº†ï¼Œå¯æ•°æ®å¹¶æœªå†™å®Œã€‚æ­¤æ—¶å¦ä¸€ä¸ªconnè¯»äº‹ä»¶readyï¼Œä¼šæ‰§è¡ŒloopReadã€‚</p>
<p>loopReadæœ‰è¿™ä¹ˆä¸€æ®µä»£ç ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">Data</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">out</span><span class="p">,</span> <span class="nx">action</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nf">Data</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">in</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">action</span> <span class="p">=</span> <span class="nx">action</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// è¡¨ç¤ºè¦å‘é€çš„æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">out</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// ä¹‹å‰è¿™é‡Œæ˜¯:c.out = append([]byte{}, out...)ï¼Œæ•ˆæœæ˜¯ä¸€æ ·çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">c</span><span class="p">.</span><span class="nx">out</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">out</span><span class="p">[:</span><span class="mi">0</span><span class="p">],</span> <span class="nx">out</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span></code></pre></div><p>é‚£ä¹ˆæ­¤æ—¶ä¹‹å‰æœªå‘é€å®Œçš„æ•°æ®å°±ä¼šè¢«è¦†ç›–ï¼Œå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚</p>
<p>ä½†æ˜¯æˆ‘ä»”ç»†çœ‹äº†ä»£ç ï¼Œå¹¶ä¸å­˜åœ¨è¿™ä¸ªbugã€‚</p>
<p>å› ä¸ºå¦‚æœç¬¬ä¸€æ¬¡æ²¡å†™å®Œï¼Œå‡è®¾æ­¤æ—¶åŒä¸€ä¸ªepollä¸‹çš„å¦ä¸€ä¸ªconnè¯»äº‹ä»¶readyï¼Œç”±äºoutè¿˜æœ‰æœªå†™å®Œçš„æ•°æ®ï¼Œåªä¼šæ‰§è¡ŒloopWriteåˆ†æ”¯ï¼Œ å¹¶ä¸ä¼šèµ°åˆ°é»˜è®¤åˆ†æ”¯loopReadï¼Œä¹Ÿå°±ä¸å­˜åœ¨å†™æ•°æ®è¢«è¦†ç›–å¯¼è‡´ä¸¢å¤±çš„é—®é¢˜äº†ã€‚</p>
<p>æœ‰è¶£çš„æ˜¯ï¼Œè¿™æ ·çš„æƒ…å†µä¼šå¯¼è‡´ç©ºè½¬ã€‚å› ä¸ºæ‰§è¡ŒloopWriteé€»è¾‘ï¼Œç”±äºå†…æ ¸å†™ç¼“å†²åŒºå·²æ»¡ï¼Œå¯¼è‡´å†™ä¸è¿›å»æ•°æ®ï¼Œä¼šå‡ºç°syscall.EAGAINç›´æ¥è¿”å›ã€‚åˆå› æ­¤æ—¶è¿˜æœ‰å¯è¯»çš„æ•°æ®æ²¡è¯»ï¼Œä¼šä¸æ–­å”¤é†’epollã€‚</p>
<p>è°ƒç”¨epoll_waitä¼šé™·å…¥å†…æ ¸æ€ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´ä¸æ–­çš„åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€åˆ‡æ¢ã€‚ç›´åˆ°å†™å®Œæ•°æ®ï¼Œæ‰èƒ½è¯»å…¶ä»–connæ•°æ®ã€‚</p>
<p>åˆ°è¿™é‡Œï¼Œæ ¸å¿ƒçš„ä»£ç å·²ç»åˆ†æå®Œäº†ã€‚</p>
<h4 id="evioå­˜åœ¨çš„é—®é¢˜">Evioå­˜åœ¨çš„é—®é¢˜</h4>
<p><strong>æƒŠç¾¤æ•ˆåº”</strong>ã€‚</p>
<p><strong>ä¸²è¡ŒåŒ–</strong></p>
<p>ä»ä¸Šé¢çš„åˆ†æå¯ä»¥çœ‹å‡ºï¼Œå¦‚æœä¸€ä¸ªepollæœ‰ä¸¤ä¸ªfdå¯è¯»äº‹ä»¶readyï¼Œé‚£ä¹ˆç¬¬äºŒä¸ªfdå¿…é¡»ç­‰ç¬¬ä¸€ä¸ªæ‰§è¡Œå®Œæ¯•ï¼Œæ‰å¼€å§‹æ‰§è¡Œã€‚</p>
<p>æ¢å¥è¯è¯´ï¼Œå¦‚æœè¿™ä¸ªé—­åŒ…å‡½æ•°é‡Œæœ‰å¤–éƒ¨ä¾èµ–è°ƒç”¨ï¼Œç¬¬äºŒä¸ªå°±å¾—ä¸€ç›´ç­‰ã€‚</p>
<p>ä¸èƒ½åœ¨Dataå‡½æ•°é‡Œç”¨go funcå—ï¼Ÿ</p>
<p>è¿˜çœŸä¸èƒ½ï¼Œè¦æ˜¯è¿™æ ·çš„è¯åˆä¼šæ¶‰åŠåˆ°æ•°æ®å¹¶å‘é—®é¢˜ï¼Œæ•°æ®ä¼šå‘ç”Ÿé”™ä¹±ã€‚</p>
<p>åŒä¸€ä¸ªepollä¸‹çš„connæ˜¯å…±äº«æ•°æ®ç»“æ„çš„ï¼Œå¦‚æœä½¿ç”¨å¼‚æ­¥ï¼Œå¿…ç„¶åˆæ¶‰åŠåˆ°é”çš„é—®é¢˜ã€‚</p>
<p><strong>æ•°æ®copyé—®é¢˜</strong></p>
<p>evioé‡‡ç”¨çš„æ˜¯åŒæ­¥å¤„ç†bufferæ•°æ®ï¼Œç›´æ¥é€šè¿‡syscallè¯»å†™æ“ä½œå­˜åœ¨copyå¼€é”€ï¼Œè¿™æ˜¯cpuç›´æ¥å‚ä¸çš„ã€‚çœ‹å­—èŠ‚çš„netpollä½¿ç”¨çš„zero-copyçš„æŠ€æœ¯ï¼Œåé¢å†çœ‹æºç ã€‚</p>
<p><strong>é¢‘ç¹å”¤é†’epoll</strong></p>
<p>evioä¼šé€šè¿‡ä¸æ–­ä¿®æ”¹conn fdçš„äº‹ä»¶æ¥å”¤é†’epollï¼Œè¾¾åˆ°é€»è¾‘ä¸Šçš„æ­£ç¡®æ€§ã€‚é¢‘ç¹å”¤é†’çš„æ–¹å¼å¹¶ä¸æ˜¯å¾ˆå¦¥ï¼Œè¿™ç§æ–¹å¼æ˜¯å­˜åœ¨å¼€é”€çš„ã€‚</p>
<p>è¿™ç¯‡æ–‡ç« åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œåˆ†æå®Œgoè‡ªå»ºnetpoll &ldquo;é¼»ç¥–&rdquo; evioï¼Œä»¥åŠå®ƒå­˜åœ¨å±€é™æ€§ï¼Œå°±å¯ä»¥ç»§ç»­å­¦ä¹ åç»­å…¶ä»–æ¡†æ¶çš„è®¾è®¡äº†ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>easycaræ›´æ–°æ—¥è®°</title>
			<link>https://www.syst.top/posts/go/easycar2/</link>
			<pubDate>Sun, 06 Nov 2022 10:11:22 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/easycar2/</guid>
			<description>å¼€ç¯‡ åˆæ‹–æ›´äº†ä¸€ä¸ªå¤šæœˆï¼Œåœ¨æ€è€ƒäººç”Ÿçš„æ„ä¹‰ã€‚
ä¸Šä¸€æ¬¡ä»‹ç»äº†æ–°å¼€å‘çš„ä¸€ä¸ªåˆ†å¸ƒå¼çš„äº‹åŠ¡æ¡†æ¶easycarï¼Œè¿™ç¯‡å°±å½“æ˜¯å¯¹easycarçš„æ›´æ–°æ—¥è®°äº†ã€‚
æœåŠ¡æ³¨å†Œä¸å‘ç°
ç”±äºeasycaråº•å±‚åŸºäºgRPC, é€šè¿‡è‡ªå®šä¹‰Resolveræ¥å£è¿˜æ˜¯å¾ˆå®¹æ˜“å®ç°çš„ã€‚
è´Ÿè½½å‡è¡¡
å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ï¼Œç›®å‰æ”¯æŒ
  round-robin
  random
  power of 2 random choice
  consistent hash
  ip-hash
  least-load
  æ¶æ„å›¾
ä¸Šæ¬¡æåˆ°ï¼Œå‚ä¸çš„ä¸€ç»„åˆ†å¸ƒå¼äº‹åŠ¡å¯èƒ½éƒ¨åˆ†æ“ä½œå­˜åœ¨å…ˆåé¡ºåºçš„é—®é¢˜ã€‚
æˆ‘ä¸¾äº†ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯å¿…é¡»å…ˆæ‰§è¡Œaccountæ‰£å‡ä½™é¢å’Œstockæ‰£å‡åº“å­˜æœåŠ¡æˆåŠŸåï¼Œæ‰èƒ½åˆ›å»ºè®¢å•orderçš„æœåŠ¡ã€‚åŒæ—¶accountå’ŒstockæœåŠ¡å¹¶ä¸éœ€è¦ä¿è¯ä»–ä»¬çš„æ‰§è¡Œé¡ºåºã€‚ä¸‹å›¾ï¼Œ
ä»¥è¿™ä¸ªä¾‹å­ï¼Œé‚£ä¹ˆå®é™…åœ¨easycarä¸­æ•´ä¸ªæµç¨‹ï¼Œ
æˆåŠŸ
å¤±è´¥
åœ¨easycarä¸­ï¼Œclientè´Ÿè´£å’Œeasycar(TC)ç«¯äº¤äº’ã€‚ä¸»è¦è´Ÿè´£æ³¨å†Œåˆ†æ”¯ï¼Œè§¦å‘æ‰§è¡Œåˆ†å¸ƒå¼äº‹åŠ¡ä»¥åŠæŸ¥çœ‹çŠ¶æ€ç­‰ã€‚
å®ƒå¹¶ä¸ä¼šå’ŒRMäº§ç”Ÿè”ç³»ã€‚ä¹Ÿå°±æ˜¯è¯´å®ƒä¸ä¼šè´Ÿè´£å»è¯·æ±‚RMçš„ç¬¬ä¸€é˜¶æ®µï¼Œè¿™æ˜¯å’Œå…¶ä»–å¹³å°ä¸åŒçš„ä¸€ç‚¹ã€‚
TCå…¨ç¨‹æ¥ç®¡å’Œæ›´æ–°RMçŠ¶æ€ã€‚
åˆ†æ”¯çŠ¶æ€
é¡¹ç›®åœ°å€:
Easycar: https://github.com/wuqinqiang/easycar
Client-go: https://github.com/easycar/client-go
Examplesï¼š https://github.com/easycar/examples</description>
			<content type="html"><![CDATA[<h4 id="å¼€ç¯‡">å¼€ç¯‡</h4>
<p>åˆæ‹–æ›´äº†ä¸€ä¸ªå¤šæœˆï¼Œåœ¨æ€è€ƒäººç”Ÿçš„æ„ä¹‰ã€‚</p>
<p>ä¸Šä¸€æ¬¡ä»‹ç»äº†æ–°å¼€å‘çš„ä¸€ä¸ªåˆ†å¸ƒå¼çš„äº‹åŠ¡æ¡†æ¶easycarï¼Œè¿™ç¯‡å°±å½“æ˜¯å¯¹easycarçš„æ›´æ–°æ—¥è®°äº†ã€‚</p>
<p><strong>æœåŠ¡æ³¨å†Œä¸å‘ç°</strong></p>
<p>ç”±äºeasycaråº•å±‚åŸºäºgRPC, é€šè¿‡è‡ªå®šä¹‰Resolveræ¥å£è¿˜æ˜¯å¾ˆå®¹æ˜“å®ç°çš„ã€‚</p>
<p><strong>è´Ÿè½½å‡è¡¡</strong></p>
<p>å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ï¼Œç›®å‰æ”¯æŒ</p>
<ul>
<li>
<p><code>round-robin</code></p>
</li>
<li>
<p><code>random</code></p>
</li>
<li>
<p><code>power of 2 random choice</code></p>
</li>
<li>
<p><code>consistent hash</code></p>
</li>
<li>
<p><code>ip-hash</code></p>
</li>
<li>
<p><code>least-load</code></p>
</li>
</ul>
<p>æ¶æ„å›¾</p>
<p><img src="https://cdn.syst.top/easycar2.jpg" alt="easycar"></p>
<p>ä¸Šæ¬¡æåˆ°ï¼Œå‚ä¸çš„ä¸€ç»„åˆ†å¸ƒå¼äº‹åŠ¡å¯èƒ½éƒ¨åˆ†æ“ä½œå­˜åœ¨å…ˆåé¡ºåºçš„é—®é¢˜ã€‚</p>
<p>æˆ‘ä¸¾äº†ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯å¿…é¡»å…ˆæ‰§è¡Œaccountæ‰£å‡ä½™é¢å’Œstockæ‰£å‡åº“å­˜æœåŠ¡æˆåŠŸåï¼Œæ‰èƒ½åˆ›å»ºè®¢å•orderçš„æœåŠ¡ã€‚åŒæ—¶accountå’ŒstockæœåŠ¡å¹¶ä¸éœ€è¦ä¿è¯ä»–ä»¬çš„æ‰§è¡Œé¡ºåºã€‚ä¸‹å›¾ï¼Œ</p>
<p><img src="https://cdn.syst.top/servers.png" alt="global">ä»¥è¿™ä¸ªä¾‹å­ï¼Œé‚£ä¹ˆå®é™…åœ¨easycarä¸­æ•´ä¸ªæµç¨‹ï¼Œ</p>
<p><strong>æˆåŠŸ</strong></p>
<p><img src="https://cdn.syst.top/success2.png" alt="success"></p>
<p><strong>å¤±è´¥</strong></p>
<p><img src="https://cdn.syst.top/failed2.png" alt="failed"></p>
<p>åœ¨easycarä¸­ï¼Œclientè´Ÿè´£å’Œeasycar(TC)ç«¯äº¤äº’ã€‚ä¸»è¦è´Ÿè´£æ³¨å†Œåˆ†æ”¯ï¼Œè§¦å‘æ‰§è¡Œåˆ†å¸ƒå¼äº‹åŠ¡ä»¥åŠæŸ¥çœ‹çŠ¶æ€ç­‰ã€‚</p>
<p>å®ƒå¹¶ä¸ä¼šå’ŒRMäº§ç”Ÿè”ç³»ã€‚ä¹Ÿå°±æ˜¯è¯´å®ƒä¸ä¼šè´Ÿè´£å»è¯·æ±‚RMçš„ç¬¬ä¸€é˜¶æ®µï¼Œè¿™æ˜¯å’Œå…¶ä»–å¹³å°ä¸åŒçš„ä¸€ç‚¹ã€‚</p>
<p>TCå…¨ç¨‹æ¥ç®¡å’Œæ›´æ–°RMçŠ¶æ€ã€‚</p>
<p>åˆ†æ”¯çŠ¶æ€</p>
<p><img src="https://cdn.syst.top/state3.png" alt="global"></p>
<p>é¡¹ç›®åœ°å€:</p>
<p>Easycar: <a href="https://github.com/wuqinqiang/easycar">https://github.com/wuqinqiang/easycar</a></p>
<p>Client-go: <a href="https://github.com/easycar/client-go">https://github.com/easycar/client-go</a></p>
<p>Examplesï¼š <a href="https://github.com/easycar/examples">https://github.com/easycar/examples</a></p>
]]></content>
		</item>
		
		<item>
			<title>ä¸€ä¸ªç”¨goå®ç°çš„åˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶</title>
			<link>https://www.syst.top/posts/go/easycar/</link>
			<pubDate>Mon, 12 Sep 2022 18:11:22 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/easycar/</guid>
			<description>å¼€ç¯‡ å¯¹åˆ†å¸ƒå¼äº‹åŠ¡ä¸€ç›´æ„Ÿå…´è¶£ï¼Œä¹‹å‰ä¸€ç›´è¢«å…¶ä»–äº‹æƒ…(æ‡’)è€½æäº†ï¼Œæœ€è¿‘ç»ˆäºåŠ¨æ‰‹äº†ã€‚
easycaræ˜¯ä»€ä¹ˆ easycar æ˜¯ä¸€ä¸ªç”¨goå®ç°çš„æ”¯æŒä¸¤é˜¶æ®µæäº¤åè®®çš„åˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶ã€‚ç›®å‰è¿˜åªæ”¯æŒTCC,SAGA æ¨¡å¼ï¼Œå…¶ä»–æ¨¡å¼å¾…å¼€å‘ã€‚
åœ¨ä»‹ç»easycar ä¹‹å‰ï¼Œå…ˆç®€å•ä»‹ç»å‡ ä¸ªè§’è‰²ã€‚
Transaction Coordinator(TC) è´Ÿè´£å…¨å±€äº‹åŠ¡çš„ç®¡ç†ï¼Œæ‰€æœ‰å‚ä¸åˆ†å¸ƒå¼äº‹åŠ¡çš„åˆ†æ”¯éƒ½ä¼šæ³¨å†Œåˆ°coordinatorï¼Œå›ç»™æ¯ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡åˆ†é…ä¸€ä¸ªå”¯ä¸€idï¼Œ
å½“ç„¶è¿˜åŒ…æ‹¬é©±åŠ¨å…¨å±€ begin / commit /abort(æˆ‘å–œæ¬¢ç§°rollback)ã€‚
Transaction Manager (TM) æœ‰äº›æ—¶å€™ä¹Ÿå« Transaction Clientï¼Œå½“ç„¶ä¸åŒçš„å®ç°ä¹Ÿè®¸éƒ½ä¼šæ¢ä¸ªåå­—ï¼Œä½†æ˜¯èŒè´£éƒ½å¤§å·®ä¸å·®ã€‚
ä¸€èˆ¬é€šè¿‡TMå¯¹æ¯ä¸ªå‚ä¸çš„RMå‘èµ·ä¸€é˜¶æ®µçš„è¯·æ±‚ï¼Œå¦‚æœä¸€é˜¶æ®µçš„RMå…¨éƒ¨æˆåŠŸï¼Œé‚£ä¹ˆTMä¼šå‘TCå‘èµ·commitè¯·æ±‚ï¼Œå¦åˆ™å‘èµ·rollbackã€‚
Resource Manager(RM) ç”¨æˆ·ç»´åº¦çš„è§’è‰²ï¼Œç®¡ç†æœ¬åœ°äº‹åŠ¡å¤„ç†çš„èµ„æºã€‚å…¶å®ä½ å¯ä»¥è¿™ä¹ˆç†è§£ï¼Œå‡è®¾ä½ çš„è®¢å•æœåŠ¡éƒ¨åˆ†æ¥å£å‚ä¸äº†åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œæ— è®ºæ˜¯ç¬¬ä¸€é˜¶æ®µTMè°ƒç”¨æ¥å£ï¼Œè¿˜æ˜¯TCç¬¬äºŒé˜¶æ®µè°ƒç”¨æ¥å£ï¼Œä½ çš„è®¢å•æœåŠ¡éƒ½ä¼šå»è´Ÿè´£æœ¬åœ°çš„äº‹åŠ¡ä¿®æ”¹ã€‚
é‚£ä¹ˆ easycar ä¸Šè¿°è§’è‰²æœ‰ä»€ä¹ˆä¸åŒå—ï¼Ÿ
æœ‰çš„ã€‚æ—¢ç„¶TCè´Ÿè´£çš„å°±æ˜¯å…¨å±€äº‹åŠ¡çš„ç®¡ç†ï¼Œé‚£ä¹ˆæˆ‘æŠŠèŒè´£éƒ½ç»™äº†å®ƒã€‚å³ç”±TCåƒæ¯ä¸ªå‚ä¸çš„RMå‘èµ·ä¸€é˜¶æ®µçš„è¯·æ±‚ï¼Œç„¶åå†æ ¹æ®ä¸€é˜¶æ®µçš„ç»“æœï¼Œå‘èµ·äºŒé˜¶æ®µçš„è¯·æ±‚ã€‚ç”±TCæ¥ç®¡æ•´ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡çš„ç”Ÿå‘½å‘¨æœŸã€‚
æ˜¯çš„ï¼Œæˆ‘å¼±åŒ–äº†ä¸Šé¢TMçš„èƒ½åŠ›ã€‚åœ¨æˆ‘çœ¼é‡Œï¼ŒTMæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯åªéœ€è¦åšä¸€äº›æ•°æ®å°è£…ï¼Œç®€ä¾¿åŒ–æ“ä½œå³å¯ã€‚æ‰€ä»¥å³ä½¿æ²¡æœ‰å®¢æˆ·ç«¯ï¼Œå…¶ä»–è¯­è¨€çš„ç”¨æˆ·ä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡httpè¯·æ±‚easycaræœåŠ¡æ¥å£ã€‚
æ‰€ä»¥ç†è®ºä¸Šï¼Œå¤§éƒ¨åˆ†æ¨¡å¼ä¸‹ï¼Œä¸éœ€è¦å®¢æˆ·ç«¯ä¹Ÿæ˜¯å¯ä»¥ç›´æ¥ä½¿ç”¨easycaræœåŠ¡çš„ã€‚
æ”¯æŒåè®®å’Œäº‹åŠ¡æ¨¡å¼åŒæ—¶æ··ç”¨ å‚ä¸åˆ†å¸ƒå¼äº‹åŠ¡çš„æœåŠ¡å¾€å¾€ç”±ä¸åŒçš„å¤šä¸ªéƒ¨é—¨ç»´æŠ¤ï¼Œæˆ–è€…éƒ¨åˆ†æ–°è€é¡¹ç›®äº¤é”™ï¼Œå¯èƒ½æ— æ³•ä¿è¯æœåŠ¡çš„åè®®æ˜¯ä¸€è‡´çš„ã€‚
å¦å¤–ï¼Œä¸åŒçš„æœåŠ¡æ‰€é‡‡ç”¨çš„äº‹åŠ¡æ¨¡å¼å…·ä½“æ˜¯ç”±ï¼šä¸šåŠ¡åœºæ™¯ä»¥åŠæ„é€ çš„æˆæœ¬æ¥å†³å®šçš„ã€‚æ‰€ä»¥å‚ä¸åˆ†å¸ƒå¼äº‹åŠ¡ä¹‹é—´æ‰€ä½¿ç”¨çš„äº‹åŠ¡æ¨¡å¼ä¸ä¸€å®šæ˜¯ç»Ÿä¸€çš„ã€‚
åœ¨è¿™äº›åŸºç¡€ä¸Šï¼Œeasycaræ”¯æŒåè®®æ··ç”¨(ç›®å‰æ”¯æŒhttpå’ŒåŸç”Ÿçš„grpcæœåŠ¡)ï¼Œæ”¯æŒéƒ¨åˆ†äº‹åŠ¡æ¨¡å¼æ··ç”¨(ç›®å‰æ”¯æŒTCC,Saga)ã€‚
æ”¯æŒå¹¶å‘æ‰§è¡Œ å‡å¦‚ç°åœ¨æœ‰ orderï¼Œaccountä»¥åŠstockä¸‰ä¸ªæœåŠ¡ã€‚
ç”±è¿™ä¸‰ä¸ªæœåŠ¡ç»„æˆä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡ã€‚ å½“ç”¨æˆ·ä¸‹å•æ—¶ï¼Œéœ€è¦ç»è¿‡è¿™ä¸‰ä¸ªæœåŠ¡ä¸­å†…éƒ¨ä¸€äº›æ¥å£(account æ‰£é’±ï¼Œstockå‡åº“å­˜ï¼Œorder åˆ›å»ºè®¢å•)ã€‚
å¦‚æœåªæ˜¯åŒæ­¥æ‰§è¡Œç¬¬ä¸€é˜¶æ®µï¼Œé‚£ä¹ˆç¬¬ä¸€é˜¶æ®µæ€»æ‰§è¡Œæ—¶é—´= (account+stock+order)ã€‚
å¾ˆå¤šåœºæ™¯ä¸‹ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡ä¹‹é—´å¹¶ä¸ä¼šå­˜åœ¨æ‰§è¡Œä¾èµ–å…ˆåçš„å…³ç³»ã€‚æ‰€ä»¥å¤šä¸ªå­äº‹åŠ¡ä¸€é˜¶æ®µå¯ä»¥åŒæ—¶å¹¶å‘æ‰§è¡Œã€‚
æµç¨‹å°±åƒè¿™æ ·ï¼š
ä¸Šå›¾æˆ‘ä»¬éœ€è¦ä¿è¯åˆ›å»ºè®¢å•å‰å¿…é¡»å…ˆæ‰§è¡Œaccountæ‰£å‡ä½™é¢å’Œstockæ‰£å‡åº“å­˜æœåŠ¡ï¼Œæ‰èƒ½åˆ›å»ºè®¢å•orderçš„æœåŠ¡ã€‚åŒæ—¶accountå’ŒstockæœåŠ¡å¹¶ä¸éœ€è¦ä¿è¯ä»–ä»¬çš„æ‰§è¡Œé¡ºåºã€‚
é‚£ä¹ˆæˆ‘ä»¬ä¸€é˜¶æ®µæ€»æ‰§è¡Œè€—æ—¶å¯ä»¥ç²—ç•¥=max(account,stock)+orderã€‚
å› æ­¤ï¼Œeasycaræ˜¯æ”¯æŒåˆ†å±‚å¹¶å‘æ‰§è¡Œçš„ã€‚ å¯¹å‚ä¸çš„RMé€šè¿‡è®¾ç½®çš„æƒé‡åšåˆ†å±‚ï¼ŒåŒä¸€å±‚çš„RMå¯ä»¥å¹¶å‘è°ƒç”¨ï¼Œä¸€å±‚å¤„ç†å®Œæ¯•å†æ¥ä¸‹ä¸€å±‚ã€‚åœ¨è¿™ä¸ªåŸºç¡€ä¸Šï¼Œå½“æŸä¸ªRMå‘ç”Ÿè°ƒç”¨é”™è¯¯æ—¶ï¼Œé‚£ä¹ˆåé¢ä¸€å±‚ä¹Ÿä¸ä¼šæ‰§è¡Œäº†ï¼Œæ•´ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡éœ€è¦å›æ»šã€‚
å¼‚å¸¸å¤„ç† åˆ†å¸ƒå¼äº‹åŠ¡ä¸­ä¼šå‡ºç°ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚
  ç©ºè¡¥å¿ï¼š Cancelè¯·æ±‚åˆ°æ¥æ—¶ï¼ŒTryè¿˜æ²¡æœ‰æ‰§è¡Œï¼Œè¿™æ—¶å€™è¿™æ ·çš„è¯·æ±‚æˆ‘ä»¬ä¸èƒ½æ‰§è¡Œï¼Œç†åº”ç›´æ¥è¿”å›ã€‚
  æ‚¬æŒ‚ï¼š Tryæ‰§è¡Œæ—¶ï¼ŒCancelå·²æ‰§è¡Œå®Œæˆï¼Œä¸èƒ½æ‰§è¡Œï¼Œç›´æ¥è¿”å›ã€‚
  å¹‚ç­‰ï¼š æ‰€æœ‰æ“ä½œçš„æ¥å£éƒ½å­˜åœ¨è¿™ä¸ªé—®é¢˜ã€‚
  è¿™äº›é—®é¢˜éœ€è¦ç”¨æˆ·è‡ªå·±å»è§£å†³ï¼Œæ¡†æ¶ä¸ä¼šè‡ªåŠ¨å¸®ä½ å¤„ç†ã€‚
åœ¨æˆ‘çœ‹æ¥ï¼Œè¿™äº›é—®é¢˜æœ¬èº«å°±æ˜¯æœåŠ¡çš„å¿…è¦å·¥ä½œï¼Œè€Œä¸æ˜¯é€šè¿‡å¤–éƒ¨æœåŠ¡æ¥å¸®ä½ ä¿è¯ã€‚
æ¢å¥è¯è¯´ï¼Œå‰ç«¯è¯´å®ƒå‚æ•°åšäº†æ ¡éªŒï¼Œéš¾é“åç«¯å°±ä¸æ ¡éªŒæ¥å£äº†å—ï¼Ÿ</description>
			<content type="html"><![CDATA[<h3 id="å¼€ç¯‡">å¼€ç¯‡</h3>
<p>å¯¹åˆ†å¸ƒå¼äº‹åŠ¡ä¸€ç›´æ„Ÿå…´è¶£ï¼Œä¹‹å‰ä¸€ç›´è¢«å…¶ä»–äº‹æƒ…(æ‡’)è€½æäº†ï¼Œæœ€è¿‘ç»ˆäºåŠ¨æ‰‹äº†ã€‚</p>
<h3 id="easycaræ˜¯ä»€ä¹ˆ">easycaræ˜¯ä»€ä¹ˆ</h3>
<p>easycar æ˜¯ä¸€ä¸ªç”¨goå®ç°çš„æ”¯æŒä¸¤é˜¶æ®µæäº¤åè®®çš„åˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶ã€‚ç›®å‰è¿˜åªæ”¯æŒTCC,SAGA æ¨¡å¼ï¼Œå…¶ä»–æ¨¡å¼å¾…å¼€å‘ã€‚</p>
<p>åœ¨ä»‹ç»easycar ä¹‹å‰ï¼Œå…ˆç®€å•ä»‹ç»å‡ ä¸ªè§’è‰²ã€‚</p>
<h4 id="transaction-coordinatortc">Transaction Coordinator(TC)</h4>
<p>è´Ÿè´£å…¨å±€äº‹åŠ¡çš„ç®¡ç†ï¼Œæ‰€æœ‰å‚ä¸åˆ†å¸ƒå¼äº‹åŠ¡çš„åˆ†æ”¯éƒ½ä¼šæ³¨å†Œåˆ°coordinatorï¼Œå›ç»™æ¯ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡åˆ†é…ä¸€ä¸ªå”¯ä¸€idï¼Œ</p>
<p>å½“ç„¶è¿˜åŒ…æ‹¬é©±åŠ¨å…¨å±€ begin / commit /abort(æˆ‘å–œæ¬¢ç§°rollback)ã€‚</p>
<h4 id="transaction-manager-tm">Transaction Manager (TM)</h4>
<p>æœ‰äº›æ—¶å€™ä¹Ÿå« Transaction Clientï¼Œå½“ç„¶ä¸åŒçš„å®ç°ä¹Ÿè®¸éƒ½ä¼šæ¢ä¸ªåå­—ï¼Œä½†æ˜¯èŒè´£éƒ½å¤§å·®ä¸å·®ã€‚</p>
<p>ä¸€èˆ¬é€šè¿‡TMå¯¹æ¯ä¸ªå‚ä¸çš„RMå‘èµ·ä¸€é˜¶æ®µçš„è¯·æ±‚ï¼Œå¦‚æœä¸€é˜¶æ®µçš„RMå…¨éƒ¨æˆåŠŸï¼Œé‚£ä¹ˆTMä¼šå‘TCå‘èµ·commitè¯·æ±‚ï¼Œå¦åˆ™å‘èµ·rollbackã€‚</p>
<h4 id="resource-managerrm">Resource Manager(RM)</h4>
<p>ç”¨æˆ·ç»´åº¦çš„è§’è‰²ï¼Œç®¡ç†æœ¬åœ°äº‹åŠ¡å¤„ç†çš„èµ„æºã€‚å…¶å®ä½ å¯ä»¥è¿™ä¹ˆç†è§£ï¼Œå‡è®¾ä½ çš„è®¢å•æœåŠ¡éƒ¨åˆ†æ¥å£å‚ä¸äº†åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œæ— è®ºæ˜¯ç¬¬ä¸€é˜¶æ®µTMè°ƒç”¨æ¥å£ï¼Œè¿˜æ˜¯TCç¬¬äºŒé˜¶æ®µè°ƒç”¨æ¥å£ï¼Œä½ çš„è®¢å•æœåŠ¡éƒ½ä¼šå»è´Ÿè´£æœ¬åœ°çš„äº‹åŠ¡ä¿®æ”¹ã€‚</p>
<p>é‚£ä¹ˆ easycar ä¸Šè¿°è§’è‰²æœ‰ä»€ä¹ˆä¸åŒå—ï¼Ÿ</p>
<p>æœ‰çš„ã€‚æ—¢ç„¶TCè´Ÿè´£çš„å°±æ˜¯å…¨å±€äº‹åŠ¡çš„ç®¡ç†ï¼Œé‚£ä¹ˆæˆ‘æŠŠèŒè´£éƒ½ç»™äº†å®ƒã€‚å³ç”±TCåƒæ¯ä¸ªå‚ä¸çš„RMå‘èµ·ä¸€é˜¶æ®µçš„è¯·æ±‚ï¼Œç„¶åå†æ ¹æ®ä¸€é˜¶æ®µçš„ç»“æœï¼Œå‘èµ·äºŒé˜¶æ®µçš„è¯·æ±‚ã€‚ç”±TCæ¥ç®¡æ•´ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡çš„ç”Ÿå‘½å‘¨æœŸã€‚</p>
<p>æ˜¯çš„ï¼Œæˆ‘å¼±åŒ–äº†ä¸Šé¢TMçš„èƒ½åŠ›ã€‚åœ¨æˆ‘çœ¼é‡Œï¼ŒTMæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯åªéœ€è¦åšä¸€äº›æ•°æ®å°è£…ï¼Œç®€ä¾¿åŒ–æ“ä½œå³å¯ã€‚æ‰€ä»¥å³ä½¿æ²¡æœ‰å®¢æˆ·ç«¯ï¼Œå…¶ä»–è¯­è¨€çš„ç”¨æˆ·ä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡httpè¯·æ±‚easycaræœåŠ¡æ¥å£ã€‚</p>
<p>æ‰€ä»¥ç†è®ºä¸Šï¼Œå¤§éƒ¨åˆ†æ¨¡å¼ä¸‹ï¼Œä¸éœ€è¦å®¢æˆ·ç«¯ä¹Ÿæ˜¯å¯ä»¥ç›´æ¥ä½¿ç”¨easycaræœåŠ¡çš„ã€‚</p>
<h4 id="æ”¯æŒåè®®å’Œäº‹åŠ¡æ¨¡å¼åŒæ—¶æ··ç”¨">æ”¯æŒåè®®å’Œäº‹åŠ¡æ¨¡å¼åŒæ—¶æ··ç”¨</h4>
<p>å‚ä¸åˆ†å¸ƒå¼äº‹åŠ¡çš„æœåŠ¡å¾€å¾€ç”±ä¸åŒçš„å¤šä¸ªéƒ¨é—¨ç»´æŠ¤ï¼Œæˆ–è€…éƒ¨åˆ†æ–°è€é¡¹ç›®äº¤é”™ï¼Œå¯èƒ½æ— æ³•ä¿è¯æœåŠ¡çš„åè®®æ˜¯ä¸€è‡´çš„ã€‚</p>
<p>å¦å¤–ï¼Œä¸åŒçš„æœåŠ¡æ‰€é‡‡ç”¨çš„äº‹åŠ¡æ¨¡å¼å…·ä½“æ˜¯ç”±ï¼šä¸šåŠ¡åœºæ™¯ä»¥åŠæ„é€ çš„æˆæœ¬æ¥å†³å®šçš„ã€‚æ‰€ä»¥å‚ä¸åˆ†å¸ƒå¼äº‹åŠ¡ä¹‹é—´æ‰€ä½¿ç”¨çš„äº‹åŠ¡æ¨¡å¼ä¸ä¸€å®šæ˜¯ç»Ÿä¸€çš„ã€‚</p>
<p>åœ¨è¿™äº›åŸºç¡€ä¸Šï¼Œeasycaræ”¯æŒåè®®æ··ç”¨(ç›®å‰æ”¯æŒhttpå’ŒåŸç”Ÿçš„grpcæœåŠ¡)ï¼Œæ”¯æŒéƒ¨åˆ†äº‹åŠ¡æ¨¡å¼æ··ç”¨(ç›®å‰æ”¯æŒTCC,Saga)ã€‚</p>
<h4 id="æ”¯æŒå¹¶å‘æ‰§è¡Œ">æ”¯æŒå¹¶å‘æ‰§è¡Œ</h4>
<p>å‡å¦‚ç°åœ¨æœ‰ orderï¼Œaccountä»¥åŠstockä¸‰ä¸ªæœåŠ¡ã€‚</p>
<p>ç”±è¿™ä¸‰ä¸ªæœåŠ¡ç»„æˆä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡ã€‚
å½“ç”¨æˆ·ä¸‹å•æ—¶ï¼Œéœ€è¦ç»è¿‡è¿™ä¸‰ä¸ªæœåŠ¡ä¸­å†…éƒ¨ä¸€äº›æ¥å£(account æ‰£é’±ï¼Œstockå‡åº“å­˜ï¼Œorder åˆ›å»ºè®¢å•)ã€‚</p>
<p>å¦‚æœåªæ˜¯åŒæ­¥æ‰§è¡Œç¬¬ä¸€é˜¶æ®µï¼Œé‚£ä¹ˆç¬¬ä¸€é˜¶æ®µæ€»æ‰§è¡Œæ—¶é—´= (account+stock+order)ã€‚</p>
<p>å¾ˆå¤šåœºæ™¯ä¸‹ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡ä¹‹é—´å¹¶ä¸ä¼šå­˜åœ¨æ‰§è¡Œä¾èµ–å…ˆåçš„å…³ç³»ã€‚æ‰€ä»¥å¤šä¸ªå­äº‹åŠ¡ä¸€é˜¶æ®µå¯ä»¥åŒæ—¶å¹¶å‘æ‰§è¡Œã€‚</p>
<p>æµç¨‹å°±åƒè¿™æ ·ï¼š</p>
<p><img src="https://cdn.syst.top/servers.png" alt="global"></p>
<p>ä¸Šå›¾æˆ‘ä»¬éœ€è¦ä¿è¯åˆ›å»ºè®¢å•å‰å¿…é¡»å…ˆæ‰§è¡Œaccountæ‰£å‡ä½™é¢å’Œstockæ‰£å‡åº“å­˜æœåŠ¡ï¼Œæ‰èƒ½åˆ›å»ºè®¢å•orderçš„æœåŠ¡ã€‚åŒæ—¶accountå’ŒstockæœåŠ¡å¹¶ä¸éœ€è¦ä¿è¯ä»–ä»¬çš„æ‰§è¡Œé¡ºåºã€‚</p>
<p>é‚£ä¹ˆæˆ‘ä»¬ä¸€é˜¶æ®µæ€»æ‰§è¡Œè€—æ—¶å¯ä»¥ç²—ç•¥=max(account,stock)+orderã€‚</p>
<p>å› æ­¤ï¼Œeasycaræ˜¯æ”¯æŒåˆ†å±‚å¹¶å‘æ‰§è¡Œçš„ã€‚ å¯¹å‚ä¸çš„RMé€šè¿‡è®¾ç½®çš„æƒé‡åšåˆ†å±‚ï¼ŒåŒä¸€å±‚çš„RMå¯ä»¥å¹¶å‘è°ƒç”¨ï¼Œä¸€å±‚å¤„ç†å®Œæ¯•å†æ¥ä¸‹ä¸€å±‚ã€‚åœ¨è¿™ä¸ªåŸºç¡€ä¸Šï¼Œå½“æŸä¸ªRMå‘ç”Ÿè°ƒç”¨é”™è¯¯æ—¶ï¼Œé‚£ä¹ˆåé¢ä¸€å±‚ä¹Ÿä¸ä¼šæ‰§è¡Œäº†ï¼Œæ•´ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡éœ€è¦å›æ»šã€‚</p>
<h4 id="å¼‚å¸¸å¤„ç†">å¼‚å¸¸å¤„ç†</h4>
<p>åˆ†å¸ƒå¼äº‹åŠ¡ä¸­ä¼šå‡ºç°ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚</p>
<ul>
<li>
<p><strong>ç©ºè¡¥å¿ï¼š</strong> Cancelè¯·æ±‚åˆ°æ¥æ—¶ï¼ŒTryè¿˜æ²¡æœ‰æ‰§è¡Œï¼Œè¿™æ—¶å€™è¿™æ ·çš„è¯·æ±‚æˆ‘ä»¬ä¸èƒ½æ‰§è¡Œï¼Œç†åº”ç›´æ¥è¿”å›ã€‚</p>
</li>
<li>
<p><strong>æ‚¬æŒ‚ï¼š</strong> Tryæ‰§è¡Œæ—¶ï¼ŒCancelå·²æ‰§è¡Œå®Œæˆï¼Œä¸èƒ½æ‰§è¡Œï¼Œç›´æ¥è¿”å›ã€‚</p>
</li>
<li>
<p><strong>å¹‚ç­‰ï¼š</strong> æ‰€æœ‰æ“ä½œçš„æ¥å£éƒ½å­˜åœ¨è¿™ä¸ªé—®é¢˜ã€‚</p>
</li>
</ul>
<p>è¿™äº›é—®é¢˜éœ€è¦ç”¨æˆ·è‡ªå·±å»è§£å†³ï¼Œæ¡†æ¶ä¸ä¼šè‡ªåŠ¨å¸®ä½ å¤„ç†ã€‚</p>
<p>åœ¨æˆ‘çœ‹æ¥ï¼Œè¿™äº›é—®é¢˜æœ¬èº«å°±æ˜¯æœåŠ¡çš„å¿…è¦å·¥ä½œï¼Œè€Œä¸æ˜¯é€šè¿‡å¤–éƒ¨æœåŠ¡æ¥å¸®ä½ ä¿è¯ã€‚</p>
<p>æ¢å¥è¯è¯´ï¼Œå‰ç«¯è¯´å®ƒå‚æ•°åšäº†æ ¡éªŒï¼Œéš¾é“åç«¯å°±ä¸æ ¡éªŒæ¥å£äº†å—ï¼Ÿ</p>
<h4 id="é‡è¯•">é‡è¯•</h4>
<p>è¿™ä¸€å—æš‚æ—¶è¿˜æ²¡å†³å®šæœ€ç»ˆæ–¹æ¡ˆã€‚</p>
<p>æˆ‘çœ¼ä¸­çš„é‡è¯•æœ‰ä¸¤ç§æ¨¡å¼ï¼šåŒæ­¥å’Œå¼‚æ­¥ã€‚</p>
<p>åŒæ­¥çš„æ„æ€æ˜¯è¯´ï¼Œå½“è¯·æ±‚RMæœåŠ¡å‘ç”Ÿé”™è¯¯çš„æ—¶å€™(ç½‘ç»œã€æœåŠ¡æœ¬èº«æŒ‚äº†ã€æˆ–è€…æœåŠ¡é‡Œçš„ä¸­é—´ä»¶æŒ‚äº†)ï¼Œé€šè¿‡å›ºå®šæ¬¡æ•°å›ºå®šæ—¶é—´é‡è¯•ï¼Œè¿™ä¸ªæ—¶é—´é€šå¸¸å¾ˆçŸ­ï¼Œæ¯”å¦‚ä¸€ç§’ã€‚é—®é¢˜æ˜¯æœåŠ¡æŒ‚çš„æƒ…å†µä¸‹ï¼ŒçŸ­æ—¶é—´å¤§æ¦‚ç‡å¥½ä¸äº†ï¼Œé‡è¯•å‡ ä¹å¯èƒ½æ˜¯æ— ç”¨åŠŸã€‚æ•´ä¸ªè¿‡ç¨‹ï¼Œå®¢æˆ·ç«¯æ˜¯é˜»å¡ç­‰å¾…çš„ï¼Œç™½ç™½è€—è´¹æ—¶é—´ã€‚</p>
<p>å¼‚æ­¥é‡è¯•é‡‡ç”¨æŒ‡æ•°é€€é¿ç®—æ³•ä¹‹ç±»çš„é€»è¾‘ï¼Œæ¯”å¦‚ç¬¬ä¸€æ¬¡é‡è¯•1åˆ†é’Ÿåï¼Œç¬¬äºŒæ¬¡2åˆ†é’Ÿ&hellip;..ï¼Œé™åˆ¶ä¸€ä¸ªä¸Šé™å€¼ï¼Œæ¯”å¦‚æœ€å¤šå»¶è¿Ÿä¸€ä¸ªå°æ—¶è¿˜æ˜¯ä¸è¡Œçš„è¯ï¼Œé‚£åªèƒ½å‘å‘Šè­¦ï¼Œçº¿ä¸‹å¤„ç†äº†ã€‚</p>
<p>è¿™æ ·çš„å¼Šç«¯æ˜¯ï¼Œ</p>
<ul>
<li>é¦–å…ˆç”¨æˆ·ä¸èƒ½å®æ—¶è·å–æœ¬æ¬¡åˆ†å¸ƒå¼äº‹åŠ¡ç»“æœäº†(æ­£åœ¨é‡è¯•ä¸­)ï¼Œåªèƒ½ç­‰åˆ°çœŸæ­£æ‰§è¡Œå®Œæ¯•çš„æ—¶å€™é€šè¿‡å›è°ƒçš„æ–¹å¼å¼‚æ­¥é€šçŸ¥ç”¨æˆ·åˆ†å¸ƒå¼äº‹åŠ¡æœ€ç»ˆç»“æœã€‚</li>
<li>é€€é¿æ—¶é—´è¶Šé•¿ï¼Œå°±æ„å‘³ç€æ•°æ®ä¸ä¸€è‡´çš„æ—¶é—´è¶Šé•¿ã€‚ä½†æ˜¯å¦‚æœäººå·¥ç›´æ¥å¹²é¢„åˆå­˜åœ¨æå¤§çš„é£é™©ã€‚æ¯”å¦‚åœ¨ä½ äººå·¥å¹²é¢„çš„åŒæ—¶ï¼Œæ­£å¥½é€»è¾‘å·²ç»å¼€å§‹æ‰§è¡Œäº†ï¼Œå¯èƒ½ä¼šé€ æˆæ–°çš„æ•°æ®ä¸ä¸€è‡´ã€‚</li>
</ul>
<h4 id="çŠ¶æ€æµè½¬å›¾">çŠ¶æ€æµè½¬å›¾</h4>
<p>global çŠ¶æ€æµè½¬å›¾</p>
<p><img src="https://cdn.syst.top/global.png" alt="global"></p>
<h3 id="æœ€å">æœ€å</h3>
<p>easycar å¼€å‘ä¸æ˜¯å¾ˆä¹…ï¼Œå®ƒè¿˜æœ‰å¥½å¤šå·¥ä½œéœ€è¦å»å®Œæˆã€‚æ„Ÿå…´è¶£çš„å¯ä»¥ä¸€èµ·åŠ å…¥ã€‚</p>
<p>é¡¹ç›®åœ°å€ï¼šhttps://github.com/wuqinqiang/easycar</p>
]]></content>
		</item>
		
		<item>
			<title>GnetåŸç†è§£æ</title>
			<link>https://www.syst.top/posts/go/gnet/</link>
			<pubDate>Tue, 07 Jun 2022 16:23:51 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/gnet/</guid>
			<description>è·ç¦»ä¸Šæ¬¡å†™æ–‡ç« è¿‡äº†ä¸€æœˆæœ‰ä½™ï¼Œè¿™æ®µæ—¶é—´ç€å®å¤ªèººäº†ã€‚ä»¥è‡³äºæ˜¨æ™šåšäº†ä¸€ä¸ªå™©æ¢¦ï¼Œé†’æ¥çš„æ—¶å€™ç‹ ç‹ çš„æŠ½äº†è‡ªå·±ä¸¤å·´æŒï¼Œä¸èƒ½è¿™ä¹ˆèººäº†ã€‚
ä¸Šé¢å½“ç„¶æ˜¯ä¸ªç¬‘è¯ã€‚
å¼€ç¯‡ ä¸Šä¸€ç¯‡æˆ‘ä»¬åˆ†æäº†GoåŸç”Ÿç½‘ç»œæ¨¡å‹ä»¥åŠéƒ¨åˆ†æºç ï¼Œç»å¤§éƒ¨åˆ†åœºæ™¯ä¸‹(99%)ï¼Œä½¿ç”¨åŸç”Ÿnetpollå·²ç»è¶³å¤Ÿäº†ã€‚
ä½†æ˜¯åœ¨ä¸€äº›æµ·é‡å¹¶å‘è¿æ¥ä¸‹ï¼ŒåŸç”Ÿnetpollä¼šä¸ºæ¯ä¸€ä¸ªè¿æ¥éƒ½å¼€å¯ä¸€ä¸ªgoroutineå¤„ç†ï¼Œä¹Ÿå°±æ˜¯1åƒä¸‡çš„è¿æ¥å°±ä¼šåˆ›å»ºä¸€åƒä¸‡ä¸ªgoroutineã€‚è¿™å°±ç»™äº†è¿™äº›ç‰¹æ®Šåœºæ™¯ä¸‹çš„ä¼˜åŒ–ç©ºé—´ï¼Œè¿™ä¹Ÿæ˜¯åƒgnetå’Œcloudwego/netpollè¯ç”Ÿçš„åŸå› ä¹‹ä¸€å§ã€‚
æœ¬è´¨ä¸Šä»–ä»¬çš„åº•å±‚æ ¸å¿ƒéƒ½æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯åŸºäºepoll(linux)å®ç°çš„ã€‚
åªæ˜¯å¯¹äº‹ä»¶å‘ç”Ÿåï¼Œæ¯ä¸ªåº“çš„å¤„ç†æ–¹å¼ä¼šæœ‰æ‰€ä¸åŒã€‚
æœ¬ç¯‡æ–‡ç« ä¸»è¦åˆ†ægnetçš„ã€‚è‡³äºä½¿ç”¨å§¿åŠ¿å°±ä¸å‘äº†ï¼Œgnetæœ‰å¯¹åº”çš„demoåº“ï¼Œå¯ä»¥è‡ªè¡Œä½“éªŒã€‚
æ¶æ„ ç›´æ¥å¼•ç”¨gnetå®˜ç½‘çš„ä¸€å¼ å›¾
gneté‡‡ç”¨çš„æ˜¯ã€ä¸»ä»å¤š Reactorsã€ã€‚ä¹Ÿå°±æ˜¯ä¸€ä¸ªä¸»çº¿ç¨‹è´Ÿè´£ç›‘å¬ç«¯å£è¿æ¥ï¼Œå½“ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥åˆ°æ¥æ—¶ï¼Œå°±æŠŠè¿™ä¸ªè¿æ¥æ ¹æ®è´Ÿè½½å‡è¡¡ç®—æ³•åˆ†é…ç»™å…¶ä¸­ä¸€ä¸ªsubçº¿ç¨‹ï¼Œç”±å¯¹åº”çš„subçº¿ç¨‹å»å¤„ç†è¿™ä¸ªè¿æ¥çš„è¯»å†™äº‹ä»¶ä»¥åŠç®¡ç†å®ƒçš„æ­»äº¡ã€‚
ä¸‹é¢è¿™å¼ å›¾å°±æ›´æ¸…æ™°äº†ã€‚
æ ¸å¿ƒç»“æ„ æˆ‘ä»¬å…ˆè§£é‡Šgnetçš„ä¸€äº›æ ¸å¿ƒç»“æ„ã€‚
engineå°±æ˜¯ç¨‹åºæœ€ä¸Šå±‚çš„ç»“æ„äº†ã€‚
  lnå¯¹åº”çš„listenerå°±æ˜¯æœåŠ¡å¯åŠ¨åå¯¹åº”ç›‘å¬ç«¯å£çš„ç›‘å¬å™¨ã€‚
  lbå¯¹åº”çš„loadBalancerå°±æ˜¯è´Ÿè½½å‡è¡¡å™¨ã€‚ä¹Ÿå°±æ˜¯å½“å®¢æˆ·ç«¯è¿æ¥æœåŠ¡æ—¶ï¼Œè´Ÿè½½å‡è¡¡å™¨ä¼šé€‰æ‹©ä¸€ä¸ªsubçº¿ç¨‹ï¼ŒæŠŠè¿æ¥äº¤ç»™æ­¤çº¿ç¨‹å¤„ç†ã€‚
  mainLoop å°±æ˜¯æˆ‘ä»¬çš„ä¸»çº¿ç¨‹äº†ï¼Œå¯¹åº”çš„ç»“æ„eventloopã€‚å½“ç„¶æˆ‘ä»¬çš„subçº¿ç¨‹ç»“æ„ä¹Ÿæ˜¯eventloopã€‚ç»“æ„ç›¸åŒï¼Œä¸åŒçš„æ˜¯èŒè´£ã€‚ä¸»çº¿ç¨‹è´Ÿè´£çš„æ˜¯ç›‘å¬ç«¯å£å‘ç”Ÿçš„å®¢æˆ·ç«¯è¿æ¥äº‹ä»¶ï¼Œç„¶åå†ç”±è´Ÿè½½å‡è¡¡å™¨æŠŠè¿æ¥åˆ†é…ç»™ä¸€ä¸ªsubçº¿ç¨‹ã€‚è€Œsubçº¿ç¨‹è´Ÿè´£çš„æ˜¯ç»‘å®šåˆ†é…ç»™ä»–çš„è¿æ¥(ä¸æ­¢ä¸€ä¸ª)ï¼Œä¸”ç­‰å¾…è‡ªå·±ç®¡ç†çš„æ‰€æœ‰è¿æ¥åç»­è¯»å†™äº‹ä»¶ï¼Œå¹¶è¿›è¡Œå¤„ç†ã€‚
  æ¥ç€çœ‹eventloopã€‚
 netpoll.Poller:æ¯ä¸€ä¸ª eventloopéƒ½å¯¹åº”ä¸€ä¸ªepollæˆ–è€…kqueueã€‚ bufferç”¨æ¥ä½œä¸ºè¯»æ¶ˆæ¯çš„ç¼“å†²åŒºã€‚ connCounè®°å½•å½“å‰eventloopå­˜å‚¨çš„tcpè¿æ¥æ•°ã€‚ udpSocketså’Œconnetcionsåˆ†åˆ«ç®¡ç†ç€è¿™ä¸ªeventloopä¸‹æ‰€æœ‰çš„udp socketå’Œtcpè¿æ¥ï¼Œæ³¨æ„ä»–ä»¬çš„ç»“æ„mapã€‚è¿™é‡Œçš„intç±»å‹å­˜å‚¨çš„å°±æ˜¯fdã€‚  å¯¹åº”connç»“æ„ï¼Œ
è¿™é‡Œé¢æœ‰å‡ ä¸ªå­—æ®µä»‹ç»ä¸‹ï¼Œ
 buffer:å­˜å‚¨å½“å‰connå¯¹ç«¯(client)å‘é€çš„æœ€æ–°æ•°æ®ï¼Œæ¯”å¦‚å‘é€äº†ä¸‰æ¬¡ï¼Œé‚£ä¸ªæ­¤æ—¶bufferå­˜å‚¨çš„æ˜¯ç¬¬ä¸‰æ¬¡çš„æ•°æ®,ä»£ç é‡Œæœ‰ã€‚ inboundBuffer:å­˜å‚¨å¯¹ç«¯å‘é€çš„ä¸”æœªè¢«ç”¨æˆ·è¯»å–çš„å‰©ä½™æ•°æ®ï¼Œè¿˜æ˜¯ä¸ªRing Bufferã€‚ outboundBuffer:å­˜å‚¨è¿˜æœªå‘é€ç»™å¯¹ç«¯çš„æ•°æ®ã€‚(æ¯”å¦‚æœåŠ¡ç«¯å“åº”å®¢æˆ·ç«¯çš„æ•°æ®ï¼Œç”±äºconn fdæ˜¯ä¸é˜»å¡çš„ï¼Œè°ƒç”¨writeè¿”å›ä¸å¯å†™çš„æ—¶å€™ï¼Œå°±å¯ä»¥å…ˆæŠŠæ•°æ®æ”¾åˆ°è¿™é‡Œ)  connç›¸å½“äºæ¯ä¸ªè¿æ¥éƒ½ä¼šæœ‰è‡ªå·±ç‹¬ç«‹çš„ç¼“å­˜ç©ºé—´ã€‚è¿™æ ·åšæ˜¯ä¸ºäº†å‡å°‘é›†ä¸­å¼ç®¡ç†å†…å­˜å¸¦æ¥çš„é”é—®é¢˜ã€‚ä½¿ç”¨Ring bufferæ˜¯ä¸ºäº†å¢åŠ ç©ºé—´çš„å¤ç”¨æ€§ã€‚
æ•´ä½“ç»“æ„å°±è¿™äº›ã€‚
æ ¸å¿ƒé€»è¾‘ å½“ç¨‹åºå¯åŠ¨æ—¶ï¼Œ
ä¼šæ ¹æ®ç”¨æˆ·è®¾ç½®çš„optionsæ˜ç¡®eventloopå¾ªç¯çš„æ•°é‡ï¼Œä¹Ÿå°±æ˜¯æœ‰å¤šå°‘ä¸ªsubçº¿ç¨‹ã€‚å†è¿›ä¸€æ­¥è¯´ï¼Œåœ¨linuxç¯å¢ƒå°±æ˜¯ä¼šåˆ›å»ºå¤šå°‘ä¸ªepollå¯¹è±¡ã€‚
é‚£ä¹ˆæ•´ä¸ªç¨‹åºçš„epollå¯¹è±¡å°±æ˜¯count(sub)+1(main Listener)ã€‚
ä¸Šå›¾å°±æ˜¯æˆ‘è¯´çš„ï¼Œä¼šæ ¹æ®è®¾ç½®çš„æ•°é‡åˆ›å»ºå¯¹åº”çš„eventloop,æŠŠå¯¹åº”çš„eventloop æ³¨å†Œåˆ°è´Ÿè½½å‡è¡¡å™¨ä¸­ã€‚
å½“æ–°è¿æ¥åˆ°æ¥æ—¶ï¼Œå°±å¯ä»¥æ ¹æ®ä¸€å®šçš„ç®—æ³•(gnetæä¾›äº†è½®è¯¢ã€æœ€å°‘è¿æ¥ä»¥åŠhash)æŒ‘é€‰å…¶ä¸­ä¸€ä¸ªeventloopæŠŠè¿æ¥åˆ†é…ç»™å®ƒã€‚
æˆ‘ä»¬å…ˆæ¥çœ‹ä¸»çº¿ç¨‹ï¼Œ(ç”±äºæˆ‘ä½¿ç”¨çš„æ˜¯mac,æ‰€ä»¥åé¢å…³äºIOå¤šè·¯å¤ç”¨ï¼Œå®ç°éƒ¨åˆ†å°±æ˜¯kqueueä»£ç äº†ï¼Œå½“ç„¶åŸç†æ˜¯ä¸€æ ·çš„)
Pollingå°±æ˜¯ç­‰å¾…ç½‘ç»œäº‹ä»¶åˆ°æ¥ï¼Œä¼ é€’äº†ä¸€ä¸ªé—­åŒ…å‚æ•°ï¼Œæ›´ç¡®åˆ‡çš„è¯´æ˜¯ä¸€ä¸ªäº‹ä»¶åˆ°æ¥æ—¶çš„å›è°ƒå‡½æ•°ï¼Œä»åå­—å¯ä»¥çœ‹å‡ºï¼Œå°±æ˜¯å¤„ç†æ–°è¿æ¥çš„ã€‚
è‡³äºPollingå‡½æ•°ï¼Œ
é€»è¾‘å¾ˆç®€å•ï¼Œä¸€ä¸ªforå¾ªç¯ç­‰å¾…äº‹ä»¶åˆ°æ¥ï¼Œç„¶åå¤„ç†äº‹ä»¶ã€‚
ä¸»çº¿ç¨‹çš„äº‹ä»¶åˆ†ä¸¤ç§ï¼Œ
ä¸€ç§æ˜¯æ­£å¸¸çš„fdå‘ç”Ÿç½‘ç»œè¿æ¥äº‹ä»¶ï¼Œ
ä¸€ç§æ˜¯é€šè¿‡NOTE_TRIGGERç«‹å³æ¿€æ´»çš„äº‹ä»¶ã€‚
é€šè¿‡NOTE_TRIGGERè§¦å‘å‘Šè¯‰ä½ é˜Ÿåˆ—é‡Œæœ‰taskä»»åŠ¡ï¼Œå»æ‰§è¡Œtaskä»»åŠ¡ã€‚
å¦‚æœæ˜¯æ­£å¸¸çš„ç½‘ç»œäº‹ä»¶åˆ°æ¥ï¼Œå°±å¤„ç†é—­åŒ…å‡½æ•°ï¼Œä¸»çº¿ç¨‹å¤„ç†çš„å°±æ˜¯ä¸Šé¢çš„acceptè¿æ¥å‡½æ•°ã€‚
acceptè¿æ¥é€»è¾‘å¾ˆç®€å•ï¼Œæ‹¿åˆ°è¿æ¥çš„fdã€‚è®¾ç½®fdéé˜»å¡æ¨¡å¼(æƒ³æƒ³è¿æ¥æ˜¯é˜»å¡çš„ä¼šå’‹ä¹ˆæ ·?),ç„¶åæ ¹æ®è´Ÿè½½å‡è¡¡ç®—æ³•é€‰æ‹©ä¸€ä¸ªsub çº¿ç¨‹ï¼Œé€šè¿‡registerå‡½æ•°æŠŠæ­¤è¿æ¥åˆ†é…ç»™å®ƒã€‚
registeråšäº†ä¸¤ä»¶äº‹ï¼Œé¦–å…ˆéœ€è¦æŠŠå½“å‰è¿æ¥æ³¨å†Œåˆ°å½“å‰sub çº¿ç¨‹çš„epoll or kqueue å¯¹è±¡ä¸­,æ–°å¢readçš„flagã€‚</description>
			<content type="html"><![CDATA[<p>è·ç¦»ä¸Šæ¬¡å†™æ–‡ç« è¿‡äº†ä¸€æœˆæœ‰ä½™ï¼Œè¿™æ®µæ—¶é—´ç€å®å¤ªèººäº†ã€‚ä»¥è‡³äºæ˜¨æ™šåšäº†ä¸€ä¸ªå™©æ¢¦ï¼Œé†’æ¥çš„æ—¶å€™ç‹ ç‹ çš„æŠ½äº†è‡ªå·±ä¸¤å·´æŒï¼Œä¸èƒ½è¿™ä¹ˆèººäº†ã€‚</p>
<p>ä¸Šé¢å½“ç„¶æ˜¯ä¸ªç¬‘è¯ã€‚</p>
<h3 id="å¼€ç¯‡">å¼€ç¯‡</h3>
<p>ä¸Šä¸€ç¯‡æˆ‘ä»¬åˆ†æäº†GoåŸç”Ÿç½‘ç»œæ¨¡å‹ä»¥åŠéƒ¨åˆ†æºç ï¼Œç»å¤§éƒ¨åˆ†åœºæ™¯ä¸‹(99%)ï¼Œä½¿ç”¨åŸç”Ÿnetpollå·²ç»è¶³å¤Ÿäº†ã€‚</p>
<p>ä½†æ˜¯åœ¨ä¸€äº›æµ·é‡å¹¶å‘è¿æ¥ä¸‹ï¼ŒåŸç”Ÿnetpollä¼šä¸ºæ¯ä¸€ä¸ªè¿æ¥éƒ½å¼€å¯ä¸€ä¸ªgoroutineå¤„ç†ï¼Œä¹Ÿå°±æ˜¯1åƒä¸‡çš„è¿æ¥å°±ä¼šåˆ›å»ºä¸€åƒä¸‡ä¸ªgoroutineã€‚è¿™å°±ç»™äº†è¿™äº›ç‰¹æ®Šåœºæ™¯ä¸‹çš„ä¼˜åŒ–ç©ºé—´ï¼Œè¿™ä¹Ÿæ˜¯åƒgnetå’Œcloudwego/netpollè¯ç”Ÿçš„åŸå› ä¹‹ä¸€å§ã€‚</p>
<p>æœ¬è´¨ä¸Šä»–ä»¬çš„åº•å±‚æ ¸å¿ƒéƒ½æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯åŸºäºepoll(linux)å®ç°çš„ã€‚</p>
<p>åªæ˜¯å¯¹äº‹ä»¶å‘ç”Ÿåï¼Œæ¯ä¸ªåº“çš„å¤„ç†æ–¹å¼ä¼šæœ‰æ‰€ä¸åŒã€‚</p>
<p>æœ¬ç¯‡æ–‡ç« ä¸»è¦åˆ†ægnetçš„ã€‚è‡³äºä½¿ç”¨å§¿åŠ¿å°±ä¸å‘äº†ï¼Œgnetæœ‰å¯¹åº”çš„demoåº“ï¼Œå¯ä»¥è‡ªè¡Œä½“éªŒã€‚</p>
<h3 id="æ¶æ„">æ¶æ„</h3>
<p>ç›´æ¥å¼•ç”¨gnetå®˜ç½‘çš„ä¸€å¼ å›¾</p>
<p><img src="https://cdn.syst.top/net1.png" alt="æˆªå±2022-06-02 15.03.18"></p>
<p>gneté‡‡ç”¨çš„æ˜¯ã€ä¸»ä»å¤š Reactorsã€ã€‚ä¹Ÿå°±æ˜¯ä¸€ä¸ªä¸»çº¿ç¨‹è´Ÿè´£ç›‘å¬ç«¯å£è¿æ¥ï¼Œå½“ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥åˆ°æ¥æ—¶ï¼Œå°±æŠŠè¿™ä¸ªè¿æ¥æ ¹æ®è´Ÿè½½å‡è¡¡ç®—æ³•åˆ†é…ç»™å…¶ä¸­ä¸€ä¸ªsubçº¿ç¨‹ï¼Œç”±å¯¹åº”çš„subçº¿ç¨‹å»å¤„ç†è¿™ä¸ªè¿æ¥çš„è¯»å†™äº‹ä»¶ä»¥åŠç®¡ç†å®ƒçš„æ­»äº¡ã€‚</p>
<p>ä¸‹é¢è¿™å¼ å›¾å°±æ›´æ¸…æ™°äº†ã€‚</p>
<p><img src="https://cdn.syst.top/net2.png" alt="å›¾ç‰‡æ¥æºgnetå®˜ç½‘"></p>
<h3 id="æ ¸å¿ƒç»“æ„">æ ¸å¿ƒç»“æ„</h3>
<p>æˆ‘ä»¬å…ˆè§£é‡Šgnetçš„ä¸€äº›æ ¸å¿ƒç»“æ„ã€‚</p>
<p><img src="https://cdn.syst.top/net4.png" alt="image-20220602153051260"></p>
<p>engineå°±æ˜¯ç¨‹åºæœ€ä¸Šå±‚çš„ç»“æ„äº†ã€‚</p>
<ul>
<li>
<p>lnå¯¹åº”çš„listenerå°±æ˜¯æœåŠ¡å¯åŠ¨åå¯¹åº”ç›‘å¬ç«¯å£çš„ç›‘å¬å™¨ã€‚</p>
</li>
<li>
<p>lbå¯¹åº”çš„loadBalancerå°±æ˜¯è´Ÿè½½å‡è¡¡å™¨ã€‚ä¹Ÿå°±æ˜¯å½“å®¢æˆ·ç«¯è¿æ¥æœåŠ¡æ—¶ï¼Œè´Ÿè½½å‡è¡¡å™¨ä¼šé€‰æ‹©ä¸€ä¸ªsubçº¿ç¨‹ï¼ŒæŠŠè¿æ¥äº¤ç»™æ­¤çº¿ç¨‹å¤„ç†ã€‚</p>
</li>
<li>
<p>mainLoop å°±æ˜¯æˆ‘ä»¬çš„ä¸»çº¿ç¨‹äº†ï¼Œå¯¹åº”çš„ç»“æ„eventloopã€‚å½“ç„¶æˆ‘ä»¬çš„subçº¿ç¨‹ç»“æ„ä¹Ÿæ˜¯eventloopã€‚ç»“æ„ç›¸åŒï¼Œä¸åŒçš„æ˜¯èŒè´£ã€‚ä¸»çº¿ç¨‹è´Ÿè´£çš„æ˜¯ç›‘å¬ç«¯å£å‘ç”Ÿçš„å®¢æˆ·ç«¯è¿æ¥äº‹ä»¶ï¼Œç„¶åå†ç”±è´Ÿè½½å‡è¡¡å™¨æŠŠè¿æ¥åˆ†é…ç»™ä¸€ä¸ªsubçº¿ç¨‹ã€‚è€Œsubçº¿ç¨‹è´Ÿè´£çš„æ˜¯ç»‘å®šåˆ†é…ç»™ä»–çš„è¿æ¥(ä¸æ­¢ä¸€ä¸ª)ï¼Œä¸”ç­‰å¾…è‡ªå·±ç®¡ç†çš„æ‰€æœ‰è¿æ¥åç»­è¯»å†™äº‹ä»¶ï¼Œå¹¶è¿›è¡Œå¤„ç†ã€‚</p>
</li>
</ul>
<p>æ¥ç€çœ‹eventloopã€‚</p>
<p><img src="https://cdn.syst.top/net5.png" alt="image-20220602154501439"></p>
<ul>
<li>netpoll.Poller:æ¯ä¸€ä¸ª eventloopéƒ½å¯¹åº”ä¸€ä¸ªepollæˆ–è€…kqueueã€‚</li>
<li>bufferç”¨æ¥ä½œä¸ºè¯»æ¶ˆæ¯çš„ç¼“å†²åŒºã€‚</li>
<li>connCounè®°å½•å½“å‰eventloopå­˜å‚¨çš„tcpè¿æ¥æ•°ã€‚</li>
<li>udpSocketså’Œconnetcionsåˆ†åˆ«ç®¡ç†ç€è¿™ä¸ªeventloopä¸‹æ‰€æœ‰çš„udp socketå’Œtcpè¿æ¥ï¼Œæ³¨æ„ä»–ä»¬çš„ç»“æ„mapã€‚è¿™é‡Œçš„intç±»å‹å­˜å‚¨çš„å°±æ˜¯fdã€‚</li>
</ul>
<p>å¯¹åº”connç»“æ„ï¼Œ</p>
<p><img src="https://cdn.syst.top/net5-1.png" alt="image-20220608175339906"></p>
<p>è¿™é‡Œé¢æœ‰å‡ ä¸ªå­—æ®µä»‹ç»ä¸‹ï¼Œ</p>
<ul>
<li>buffer:å­˜å‚¨å½“å‰connå¯¹ç«¯(client)å‘é€çš„æœ€æ–°æ•°æ®ï¼Œæ¯”å¦‚å‘é€äº†ä¸‰æ¬¡ï¼Œé‚£ä¸ªæ­¤æ—¶bufferå­˜å‚¨çš„æ˜¯ç¬¬ä¸‰æ¬¡çš„æ•°æ®,ä»£ç é‡Œæœ‰ã€‚</li>
<li>inboundBuffer:å­˜å‚¨å¯¹ç«¯å‘é€çš„ä¸”æœªè¢«ç”¨æˆ·è¯»å–çš„å‰©ä½™æ•°æ®ï¼Œè¿˜æ˜¯ä¸ªRing Bufferã€‚</li>
<li>outboundBuffer:å­˜å‚¨è¿˜æœªå‘é€ç»™å¯¹ç«¯çš„æ•°æ®ã€‚(æ¯”å¦‚æœåŠ¡ç«¯å“åº”å®¢æˆ·ç«¯çš„æ•°æ®ï¼Œç”±äºconn fdæ˜¯ä¸é˜»å¡çš„ï¼Œè°ƒç”¨writeè¿”å›ä¸å¯å†™çš„æ—¶å€™ï¼Œå°±å¯ä»¥å…ˆæŠŠæ•°æ®æ”¾åˆ°è¿™é‡Œ)</li>
</ul>
<p>connç›¸å½“äºæ¯ä¸ªè¿æ¥éƒ½ä¼šæœ‰è‡ªå·±ç‹¬ç«‹çš„ç¼“å­˜ç©ºé—´ã€‚è¿™æ ·åšæ˜¯ä¸ºäº†å‡å°‘é›†ä¸­å¼ç®¡ç†å†…å­˜å¸¦æ¥çš„é”é—®é¢˜ã€‚ä½¿ç”¨Ring bufferæ˜¯ä¸ºäº†å¢åŠ ç©ºé—´çš„å¤ç”¨æ€§ã€‚</p>
<p>æ•´ä½“ç»“æ„å°±è¿™äº›ã€‚</p>
<h3 id="æ ¸å¿ƒé€»è¾‘">æ ¸å¿ƒé€»è¾‘</h3>
<p>å½“ç¨‹åºå¯åŠ¨æ—¶ï¼Œ</p>
<p><img src="https://cdn.syst.top/net3.png" alt="net3"></p>
<p>ä¼šæ ¹æ®ç”¨æˆ·è®¾ç½®çš„optionsæ˜ç¡®eventloopå¾ªç¯çš„æ•°é‡ï¼Œä¹Ÿå°±æ˜¯æœ‰å¤šå°‘ä¸ªsubçº¿ç¨‹ã€‚å†è¿›ä¸€æ­¥è¯´ï¼Œåœ¨linuxç¯å¢ƒå°±æ˜¯ä¼šåˆ›å»ºå¤šå°‘ä¸ªepollå¯¹è±¡ã€‚</p>
<p>é‚£ä¹ˆæ•´ä¸ªç¨‹åºçš„epollå¯¹è±¡å°±æ˜¯count(sub)+1(main Listener)ã€‚</p>
<p><img src="https://cdn.syst.top/net6.png" alt="image-20220608164415565"></p>
<p>ä¸Šå›¾å°±æ˜¯æˆ‘è¯´çš„ï¼Œä¼šæ ¹æ®è®¾ç½®çš„æ•°é‡åˆ›å»ºå¯¹åº”çš„eventloop,æŠŠå¯¹åº”çš„eventloop æ³¨å†Œåˆ°è´Ÿè½½å‡è¡¡å™¨ä¸­ã€‚</p>
<p>å½“æ–°è¿æ¥åˆ°æ¥æ—¶ï¼Œå°±å¯ä»¥æ ¹æ®ä¸€å®šçš„ç®—æ³•(gnetæä¾›äº†è½®è¯¢ã€æœ€å°‘è¿æ¥ä»¥åŠhash)æŒ‘é€‰å…¶ä¸­ä¸€ä¸ªeventloopæŠŠè¿æ¥åˆ†é…ç»™å®ƒã€‚</p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸»çº¿ç¨‹ï¼Œ(ç”±äºæˆ‘ä½¿ç”¨çš„æ˜¯mac,æ‰€ä»¥åé¢å…³äºIOå¤šè·¯å¤ç”¨ï¼Œå®ç°éƒ¨åˆ†å°±æ˜¯kqueueä»£ç äº†ï¼Œå½“ç„¶åŸç†æ˜¯ä¸€æ ·çš„)</p>
<p><img src="https://cdn.syst.top/net7.png" alt="image-20220608165350443"></p>
<p>Pollingå°±æ˜¯ç­‰å¾…ç½‘ç»œäº‹ä»¶åˆ°æ¥ï¼Œä¼ é€’äº†ä¸€ä¸ªé—­åŒ…å‚æ•°ï¼Œæ›´ç¡®åˆ‡çš„è¯´æ˜¯ä¸€ä¸ªäº‹ä»¶åˆ°æ¥æ—¶çš„å›è°ƒå‡½æ•°ï¼Œä»åå­—å¯ä»¥çœ‹å‡ºï¼Œå°±æ˜¯å¤„ç†æ–°è¿æ¥çš„ã€‚</p>
<p>è‡³äºPollingå‡½æ•°ï¼Œ</p>
<p><img src="https://cdn.syst.top/net8.png" alt="image-20220608170912204"></p>
<p>é€»è¾‘å¾ˆç®€å•ï¼Œä¸€ä¸ªforå¾ªç¯ç­‰å¾…äº‹ä»¶åˆ°æ¥ï¼Œç„¶åå¤„ç†äº‹ä»¶ã€‚</p>
<p>ä¸»çº¿ç¨‹çš„äº‹ä»¶åˆ†ä¸¤ç§ï¼Œ</p>
<p>ä¸€ç§æ˜¯æ­£å¸¸çš„fdå‘ç”Ÿç½‘ç»œè¿æ¥äº‹ä»¶ï¼Œ</p>
<p>ä¸€ç§æ˜¯é€šè¿‡NOTE_TRIGGERç«‹å³æ¿€æ´»çš„äº‹ä»¶ã€‚</p>
<p><img src="https://cdn.syst.top/net9.png" alt="image-20220608171537730"></p>
<p>é€šè¿‡NOTE_TRIGGERè§¦å‘å‘Šè¯‰ä½ é˜Ÿåˆ—é‡Œæœ‰taskä»»åŠ¡ï¼Œå»æ‰§è¡Œtaskä»»åŠ¡ã€‚</p>
<p>å¦‚æœæ˜¯æ­£å¸¸çš„ç½‘ç»œäº‹ä»¶åˆ°æ¥ï¼Œå°±å¤„ç†é—­åŒ…å‡½æ•°ï¼Œä¸»çº¿ç¨‹å¤„ç†çš„å°±æ˜¯ä¸Šé¢çš„acceptè¿æ¥å‡½æ•°ã€‚</p>
<p><img src="https://cdn.syst.top/net10.png" alt="image-20220608172333749"></p>
<p>acceptè¿æ¥é€»è¾‘å¾ˆç®€å•ï¼Œæ‹¿åˆ°è¿æ¥çš„fdã€‚è®¾ç½®fdéé˜»å¡æ¨¡å¼(æƒ³æƒ³è¿æ¥æ˜¯é˜»å¡çš„ä¼šå’‹ä¹ˆæ ·?),ç„¶åæ ¹æ®è´Ÿè½½å‡è¡¡ç®—æ³•é€‰æ‹©ä¸€ä¸ªsub çº¿ç¨‹ï¼Œé€šè¿‡registerå‡½æ•°æŠŠæ­¤è¿æ¥åˆ†é…ç»™å®ƒã€‚</p>
<p><img src="https://cdn.syst.top/net11.png" alt="image-20220608173157607"></p>
<p>registeråšäº†ä¸¤ä»¶äº‹ï¼Œé¦–å…ˆéœ€è¦æŠŠå½“å‰è¿æ¥æ³¨å†Œåˆ°å½“å‰sub çº¿ç¨‹çš„epoll or kqueue å¯¹è±¡ä¸­,æ–°å¢readçš„flagã€‚</p>
<p>æ¥ç€å°±æ˜¯æŠŠå½“å‰è¿æ¥æ”¾å…¥åˆ°connectionsçš„mapç»“æ„ä¸­ fd-&gt;connã€‚</p>
<p>è¿™æ ·å½“å¯¹åº”çš„subçº¿ç¨‹äº‹ä»¶åˆ°æ¥æ—¶ï¼Œå¯ä»¥é€šè¿‡äº‹ä»¶çš„fdæ‰¾åˆ°æ˜¯å“ªä¸ªè¿æ¥ï¼Œè¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚</p>
<p><img src="https://cdn.syst.top/net12.png" alt="image-20220608174647390"></p>
<p>å¦‚æœæ˜¯å¯è¯»äº‹ä»¶ï¼Œ</p>
<p><img src="https://cdn.syst.top/net13.png" alt="image-20220608182813931"></p>
<p>åˆ°è¿™é‡Œåˆ†æå·®ä¸å¤šå°±ç»“æŸäº†ã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>åœ¨gneté‡Œé¢ï¼Œä½ å¯ä»¥çœ‹åˆ°ï¼ŒåŸºæœ¬ä¸Šæ‰€æœ‰çš„æ“ä½œéƒ½æ— é”çš„ã€‚</p>
<p>é‚£æ˜¯å› ä¸ºäº‹ä»¶åˆ°æ¥æ—¶ï¼Œé‡‡å–çš„éƒ½æ˜¯éé˜»å¡çš„æ“ä½œï¼Œä¸”æ˜¯ä¸²è¡Œå¤„ç†å¯¹åº”çš„æ¯ä¸ªfd(conn)ã€‚æ¯ä¸ªconnæ“ä½œçš„éƒ½æ˜¯è‡ªèº«æŒæœ‰çš„ç¼“å­˜ç©ºé—´ã€‚åŒæ—¶å¤„ç†å®Œä¸€è½®è§¦å‘çš„æ‰€æœ‰äº‹ä»¶æ‰ä¼šå¾ªç¯è¿›å…¥ä¸‹ä¸€æ¬¡ç­‰å¾…ï¼Œåœ¨æ­¤å±‚é¢ä¸Šè§£å†³äº†å¹¶å‘é—®é¢˜ã€‚</p>
<p>å½“ç„¶è¿™æ ·ç”¨æˆ·åœ¨ä½¿ç”¨çš„æ—¶å€™ä¹Ÿéœ€è¦æ³¨æ„ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚ç”¨æˆ·åœ¨è‡ªå®šä¹‰EventHandlerä¸­ï¼Œå¦‚æœè¦å¼‚æ­¥å¤„ç†é€»è¾‘ï¼Œå°±ä¸èƒ½åƒä¸‹é¢è¿™æ ·å¼€ä¸€ä¸ªgç„¶ååœ¨é‡Œé¢è·å–æœ¬æ¬¡æ•°æ®ï¼Œ</p>
<p><img src="https://cdn.syst.top/net14.png" alt="image-20220608184718192"></p>
<p>è€Œåº”è¯¥å…ˆæ‹¿åˆ°æ•°æ®ï¼Œå†å¼‚æ­¥å¤„ç†ã€‚</p>
<p><img src="https://cdn.syst.top/net15.png" alt="image-20220608184937855"></p>
<p>issuesä¸Šæœ‰æåˆ°ï¼Œè¿æ¥æ˜¯ä½¿ç”¨map[int]*connå­˜å‚¨çš„ã€‚gnetæœ¬èº«çš„åœºæ™¯å°±æ˜¯æµ·é‡å¹¶å‘è¿æ¥ï¼Œå†…å­˜ä¼šå¾ˆå¤§ã€‚è¿›è€Œbig mapå­˜æŒ‡é’ˆä¼šå¯¹ GCé€ æˆå¾ˆå¤§çš„è´Ÿæ‹…ï¼Œæ¯•ç«Ÿå®ƒä¸åƒæ•°ç»„ä¸€æ ·ï¼Œæ˜¯è¿ç»­å†…å­˜ç©ºé—´ï¼Œæ˜“äºGCæ‰«æã€‚</p>
<p>è¿˜æœ‰ä¸€ç‚¹ï¼Œåœ¨å¤„ç†bufferæ•°æ®çš„æ—¶å€™ï¼Œå°±åƒä¸Šé¢çœ‹åˆ°çš„ï¼Œæœ¬è´¨ä¸Šæ˜¯å°†bufferæ•°æ®copyç»™ç”¨æˆ·ä¸€ä»½ï¼Œé‚£ä¹ˆå°±å­˜åœ¨å¤§é‡copyå¼€é”€,åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œå­—èŠ‚çš„netpollå®ç°äº†Nocopy Bufferï¼Œæ”¹å¤©ç ”ç©¶ä¸€ä¸‹ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>Go netpollå¤§è§£æ</title>
			<link>https://www.syst.top/posts/go/netpoll/</link>
			<pubDate>Thu, 14 Apr 2022 10:23:51 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/netpoll/</guid>
			<description>å¼€ç¯‡ ä¹‹å‰ç®€å•çœ‹è¿‡ä¸€ç‚¹goåŸç”Ÿnetpollï¼Œæ²¡æ³¨æ„å¤ªå¤šç»†èŠ‚ã€‚æœ€è¿‘ä»å¤´åˆ°å°¾çœ‹äº†ä¸€éï¼Œç‰¹å†™ç¯‡æ–‡ç« è®°å½•ä¸‹ã€‚æ–‡ç« å¾ˆé•¿ï¼Œè¯·è€å¿ƒçœ‹å®Œï¼Œä¸€å®šæœ‰æ‰€æ”¶è·ã€‚
ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ åœ¨linuxä¸­ï¼Œç»å¸¸èƒ½çœ‹åˆ°ä¸¤ä¸ªè¯è¯­:User space(ç”¨æˆ·ç©ºé—´)å’ŒKernel space (å†…æ ¸ç©ºé—´)ã€‚
ç®€å•çš„è¯´ï¼Œ Kernel spaceæ˜¯linuxå†…æ ¸è¿è¡Œçš„ç©ºé—´ï¼ŒUser spaceæ˜¯ç”¨æˆ·ç¨‹åºè¿è¡Œçš„ç©ºé—´ã€‚å®ƒä»¬ä¹‹é—´æ˜¯ç›¸äº’éš”ç¦»çš„ã€‚
ç°ä»£æ“ä½œç³»ç»Ÿéƒ½æ˜¯é‡‡ç”¨è™šæ‹Ÿå­˜å‚¨å™¨ã€‚é‚£ä¹ˆå¯¹32ä½æ“ä½œç³»ç»Ÿè€Œè¨€ï¼Œå®ƒçš„å¯»å€ç©ºé—´ï¼ˆè™šæ‹Ÿå­˜å‚¨ç©ºé—´ï¼‰ä¸º4Gï¼ˆ2çš„32æ¬¡æ–¹ï¼‰ã€‚æ“ä½œç³»ç»Ÿçš„æ ¸å¿ƒæ˜¯å†…æ ¸ï¼Œç‹¬ç«‹äºæ™®é€šçš„åº”ç”¨ç¨‹åºï¼Œå¯ä»¥è®¿é—®å—ä¿æŠ¤çš„å†…å­˜ç©ºé—´ï¼Œä¹Ÿæœ‰è®¿é—®åº•å±‚ç¡¬ä»¶è®¾å¤‡çš„æ‰€æœ‰æƒé™ã€‚ä¸ºäº†ä¿è¯ç”¨æˆ·è¿›ç¨‹ä¸èƒ½ç›´æ¥æ“ä½œå†…æ ¸ï¼Œä¿è¯å†…æ ¸çš„å®‰å…¨ï¼Œæ“å¿ƒç³»ç»Ÿå°†è™šæ‹Ÿç©ºé—´åˆ’åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†ä¸ºå†…æ ¸ç©ºé—´ï¼Œä¸€éƒ¨åˆ†ä¸ºç”¨æˆ·ç©ºé—´ã€‚é’ˆå¯¹linuxæ“ä½œç³»ç»Ÿè€Œè¨€ï¼Œå°†æœ€é«˜çš„1Gå­—èŠ‚ï¼ˆä»è™šæ‹Ÿåœ°å€0xC0000000åˆ°0xFFFFFFFFï¼‰ï¼Œä¾›å†…æ ¸ä½¿ç”¨ï¼Œç§°ä¸ºå†…æ ¸ç©ºé—´ï¼Œè€Œå°†è¾ƒä½çš„3Gå­—èŠ‚ï¼ˆä»è™šæ‹Ÿåœ°å€0x00000000åˆ°0xBFFFFFFFï¼‰ï¼Œä¾›å„ä¸ªè¿›ç¨‹ä½¿ç”¨ï¼Œç§°ä¸ºç”¨æˆ·ç©ºé—´ã€‚ç©ºé—´åˆ†é…å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
Kernel spaceå¯ä»¥è°ƒç”¨ç³»ç»Ÿçš„ä¸€åˆ‡èµ„æºã€‚User space ä¸èƒ½ç›´æ¥è°ƒç”¨ç³»ç»Ÿèµ„æºï¼Œåœ¨ Linuxç³»ç»Ÿä¸­ï¼Œæ‰€æœ‰çš„ç³»ç»Ÿèµ„æºç®¡ç†éƒ½æ˜¯åœ¨å†…æ ¸ç©ºé—´ä¸­å®Œæˆçš„ã€‚æ¯”å¦‚è¯»å†™ç£ç›˜æ–‡ä»¶ã€åˆ†é…å›æ”¶å†…å­˜ã€ä»ç½‘ç»œæ¥å£è¯»å†™æ•°æ®ç­‰ç­‰ã€‚åº”ç”¨ç¨‹åºæ— æ³•ç›´æ¥è¿›è¡Œè¿™æ ·çš„æ“ä½œï¼Œä½†æ˜¯ç”¨æˆ·ç¨‹åºå¯ä»¥é€šè¿‡å†…æ ¸æä¾›çš„æ¥å£æ¥å®Œæˆè¿™æ ·çš„ä»»åŠ¡ã€‚æ¯”å¦‚åƒä¸‹é¢è¿™æ ·ï¼Œ
åº”ç”¨ç¨‹åºè¦è¯»å–ç£ç›˜ä¸Šçš„ä¸€ä¸ªæ–‡ä»¶ï¼Œå®ƒå¯ä»¥å‘å†…æ ¸å‘èµ·ä¸€ä¸ª â€œç³»ç»Ÿè°ƒç”¨â€ å‘Šè¯‰å†…æ ¸ï¼šâ€æˆ‘è¦è¯»å–ç£ç›˜ä¸Šçš„æŸæŸæ–‡ä»¶â€ã€‚å…¶å®å°±æ˜¯é€šè¿‡ä¸€ä¸ªç‰¹æ®Šçš„æŒ‡ä»¤è®©è¿›ç¨‹ä»ç”¨æˆ·æ€è¿›å…¥åˆ°å†…æ ¸æ€ï¼Œåœ¨å†…æ ¸ç©ºé—´ä¸­ï¼ŒCPU å¯ä»¥æ‰§è¡Œä»»ä½•çš„æŒ‡ä»¤ï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬ä»ç£ç›˜ä¸Šè¯»å–æ•°æ®ã€‚å…·ä½“è¿‡ç¨‹æ˜¯å…ˆæŠŠæ•°æ®è¯»å–åˆ°å†…æ ¸ç©ºé—´ä¸­ï¼Œç„¶åå†æŠŠæ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´å¹¶ä»å†…æ ¸æ€åˆ‡æ¢åˆ°ç”¨æˆ·æ€ã€‚æ­¤æ—¶åº”ç”¨ç¨‹åºå·²ç»ä»ç³»ç»Ÿè°ƒç”¨ä¸­è¿”å›å¹¶ä¸”æ‹¿åˆ°äº†æƒ³è¦çš„æ•°æ®ï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œç”¨æˆ·ç©ºé—´æ‰§è¡Œé€»è¾‘ã€‚
è¿™æ ·çš„è¯ï¼Œä¸€æ—¦æ¶‰åŠåˆ°å¯¹I/Oçš„å¤„ç†ï¼Œå°±å¿…ç„¶ä¼šæ¶‰åŠåˆ°åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´æ¥å›åˆ‡æ¢ã€‚
ioæ¨¡å‹ ç½‘ä¸Šæœ‰å¤ªå¤šå…³äºI/Oæ¨¡å‹çš„æ–‡ç« ï¼Œçœ‹ç€çœ‹ç€æœ‰å¯èƒ½å°±è·‘åäº†ï¼Œæ‰€ä»¥æˆ‘è¿˜æ˜¯ä» &amp;laquo;UNIX ç½‘ç»œç¼–ç¨‹&amp;raquo; ä¸­æ€»ç»“çš„5ä¸­I/Oæ¨¡å‹è¯´èµ·å§ã€‚
Unixå¯ç”¨çš„5ç§I/Oæ¨¡å‹ã€‚
 é˜»å¡I/O éé˜»å¡I/O I/Oå¤ç”¨ ä¿¡å·é©±åŠ¨å¼I/O(SIGIO) å¼‚æ­¥I/O(POSIXçš„aio_ç³»åˆ—å‡½æ•°)  é˜»å¡I/O é˜»å¡å¼I/Oä¸‹ï¼Œè¿›ç¨‹è°ƒç”¨recvfromï¼Œç›´åˆ°æ•°æ®åˆ°è¾¾ä¸”è¢«å¤åˆ¶åˆ°åº”ç”¨ç¨‹åºçš„ç¼“å†²åŒºä¸­æˆ–è€…å‘ç”Ÿé”™è¯¯æ‰è¿”å›ï¼Œåœ¨æ•´ä¸ªè¿‡ç¨‹è¿›ç¨‹éƒ½æ˜¯è¢«é˜»å¡çš„ã€‚
éé˜»å¡I/O ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œå‰ä¸‰æ¬¡è°ƒç”¨recvfromä¸­æ²¡æœ‰æ•°æ®å¯è¿”å›ï¼Œå› æ­¤å†…æ ¸è½¬è€Œç«‹å³è¿”å›ä¸€ä¸ªEWOULDBLOCKé”™è¯¯ã€‚ç¬¬å››æ¬¡è°ƒç”¨recvfromæ—¶å·²æœ‰ä¸€ä¸ªæ•°æ®æŠ¥å‡†å¤‡å¥½ï¼Œå®ƒè¢«å¤åˆ¶åˆ°åº”ç”¨ç¨‹åºç¼“å†²åŒºï¼Œäºæ˜¯recvfromæˆåŠŸè¿”å›ã€‚
å½“ä¸€ä¸ªåº”ç”¨ç¨‹åºåƒè¿™æ ·å¯¹ä¸€ä¸ªéé˜»å¡æè¿°ç¬¦å¾ªç¯è°ƒç”¨recvfromæ—¶ï¼Œæˆ‘ä»¬é€šå¸¸ç§°ä¸ºè½®è¯¢(polling)ï¼ŒæŒç»­è½®è¯¢å†…æ ¸ï¼Œä»¥è¿™ç§æ–¹å¼æŸ¥çœ‹æŸä¸ªæ“ä½œæ˜¯å¦å°±ç»ªã€‚
I/Oå¤šè·¯å¤ç”¨ æœ‰äº†I/Oå¤šè·¯å¤ç”¨(I/O multiplexing)ï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨ select æˆ–è€… pollï¼Œé˜»å¡åœ¨è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ä¸­çš„æŸä¸€ä¸ªä¹‹ä¸Šï¼Œè€Œä¸æ˜¯é˜»å¡åœ¨çœŸæ­£çš„I/Oç³»ç»Ÿè°ƒç”¨ä¸Šã€‚
ä¸Šé¢è¿™å¥è¯éš¾ç†è§£æ˜¯å§ï¼Œè¯´ç™½äº†è¿™é‡ŒæŒ‡çš„æ˜¯ï¼Œåœ¨ç¬¬ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯é˜»å¡åœ¨selectè°ƒç”¨ä¸Šï¼Œç›´åˆ°æ•°æ®æŠ¥å¥—æ¥å­—å˜ä¸ºå¯è¯»ï¼Œè¿”å›å¯è¯»æ¡ä»¶ï¼Œè¿™é‡Œå¹¶æ²¡æœ‰å‘ç”ŸI/Oäº‹ä»¶ï¼Œæ‰€ä»¥è¯´è¿™ä¸€æ­¥ï¼Œå¹¶æ²¡æœ‰é˜»å¡åœ¨çœŸæ­£çš„I/Oç³»ç»Ÿè°ƒç”¨ä¸Šã€‚
å…¶ä»–ä¸¤ç§å°±ä¸è¿‡å¤šä»‹ç»äº†ã€‚
è¿˜æœ‰ä¸€ç‚¹ï¼Œæˆ‘ä»¬ä¼šç»å¸¸æåˆ°åŒæ­¥I/Oå’Œå¼‚æ­¥I/Oã€‚
POSIX æŠŠè¿™ä¸¤ç§æœ¯è¯­å®šä¹‰å¦‚ä¸‹:
 åŒæ­¥I/Oæ“ä½œ(synchronous I/O opetation) å¯¼è‡´è¯·æ±‚è¿›ç¨‹è¢«é˜»å¡ï¼Œç›´åˆ°I/Oæ“ä½œå®Œæˆã€‚ å¼‚æ­¥I/O(asynchronous opetation) ä¸å¯¼è‡´è¯·æ±‚è¿›ç¨‹è¢«é˜»å¡ã€‚  åŸºäºä¸Šé¢çš„å®šä¹‰ï¼Œ
å¼‚æ­¥I/Oçš„å…³é”®åœ¨äºç¬¬äºŒæ­¥çš„recrfromæ˜¯å¦ä¼šé˜»å¡ä½ç”¨æˆ·è¿›ç¨‹ï¼Œå¦‚æœä¸é˜»å¡ï¼Œé‚£å®ƒå°±æ˜¯å¼‚æ­¥I/Oã€‚ä»ä¸Šé¢æ±‡æ€»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œåªæœ‰å¼‚æ­¥I/Oæ»¡è¶³POSIXä¸­å¯¹å¼‚æ­¥I/Oçš„å®šä¹‰ã€‚
Go netpoller Go netpoller åº•å±‚å°±æ˜¯å¯¹I/Oå¤šè·¯å¤ç”¨çš„å°è£…ã€‚ä¸åŒå¹³å°å¯¹I/Oå¤šè·¯å¤ç”¨æœ‰ä¸åŒçš„å®ç°æ–¹å¼ã€‚æ¯”å¦‚Linuxçš„selectã€pollå’Œepoll(å…·ä½“å·®åˆ«ä¸æ˜¯å¾ˆæ˜ç™½å¯ä»¥çœ‹è¿™ç¯‡)ã€‚åœ¨MacOSåˆ™æ˜¯kqueue,è€ŒWindowsæ˜¯åŸºäºå¼‚æ­¥I/Oå®ç°çš„icop&amp;hellip;&amp;hellip;ï¼ŒåŸºäºè¿™äº›èƒŒæ™¯ï¼ŒGoé’ˆå¯¹ä¸åŒçš„å¹³å°è°ƒç”¨å®ç°äº†å¤šç‰ˆæœ¬çš„netpollerã€‚
ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªdemoå¼€å§‹è®²è§£ã€‚
å¾ˆç®€å•ä¸€ä¸ªdemoï¼Œå¼€å¯ä¸€ä¸ªtcpæœåŠ¡ã€‚ç„¶åæ¯æ¥ä¸€ä¸ªè¿æ¥ï¼Œå°±å¯åŠ¨ä¸€ä¸ªgå»å¤„ç†è¿æ¥ã€‚å¤„ç†å®Œæ¯•ï¼Œå…³é—­è¿æ¥ã€‚
è€Œä¸”æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯åŒæ­¥çš„æ¨¡å¼å»ç¼–å†™å¼‚æ­¥çš„é€»è¾‘ï¼Œä¸€ä¸ªè¿æ¥å¯¹åº”ä¸€ä¸ªgå¤„ç†ï¼Œæå…¶ç®€å•å’Œæ˜“äºç†è§£ã€‚goæ ‡å‡†åº“ä¸­çš„http.serverä¹Ÿæ˜¯è¿™ä¹ˆå¹²çš„ã€‚</description>
			<content type="html"><![CDATA[<h3 id="å¼€ç¯‡">å¼€ç¯‡</h3>
<p>ä¹‹å‰ç®€å•çœ‹è¿‡ä¸€ç‚¹goåŸç”Ÿnetpollï¼Œæ²¡æ³¨æ„å¤ªå¤šç»†èŠ‚ã€‚æœ€è¿‘ä»å¤´åˆ°å°¾çœ‹äº†ä¸€éï¼Œç‰¹å†™ç¯‡æ–‡ç« è®°å½•ä¸‹ã€‚æ–‡ç« å¾ˆé•¿ï¼Œè¯·è€å¿ƒçœ‹å®Œï¼Œä¸€å®šæœ‰æ‰€æ”¶è·ã€‚</p>
<h3 id="ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´">ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´</h3>
<p>åœ¨linuxä¸­ï¼Œç»å¸¸èƒ½çœ‹åˆ°ä¸¤ä¸ªè¯è¯­:User space(ç”¨æˆ·ç©ºé—´)å’ŒKernel space (å†…æ ¸ç©ºé—´)ã€‚</p>
<p>ç®€å•çš„è¯´ï¼Œ Kernel spaceæ˜¯linuxå†…æ ¸è¿è¡Œçš„ç©ºé—´ï¼ŒUser spaceæ˜¯ç”¨æˆ·ç¨‹åºè¿è¡Œçš„ç©ºé—´ã€‚å®ƒä»¬ä¹‹é—´æ˜¯ç›¸äº’éš”ç¦»çš„ã€‚</p>
<p>ç°ä»£æ“ä½œç³»ç»Ÿéƒ½æ˜¯é‡‡ç”¨è™šæ‹Ÿå­˜å‚¨å™¨ã€‚é‚£ä¹ˆå¯¹32ä½æ“ä½œç³»ç»Ÿè€Œè¨€ï¼Œå®ƒçš„å¯»å€ç©ºé—´ï¼ˆè™šæ‹Ÿå­˜å‚¨ç©ºé—´ï¼‰ä¸º4Gï¼ˆ2çš„32æ¬¡æ–¹ï¼‰ã€‚æ“ä½œç³»ç»Ÿçš„æ ¸å¿ƒæ˜¯å†…æ ¸ï¼Œç‹¬ç«‹äºæ™®é€šçš„åº”ç”¨ç¨‹åºï¼Œå¯ä»¥è®¿é—®å—ä¿æŠ¤çš„å†…å­˜ç©ºé—´ï¼Œä¹Ÿæœ‰è®¿é—®åº•å±‚ç¡¬ä»¶è®¾å¤‡çš„æ‰€æœ‰æƒé™ã€‚ä¸ºäº†ä¿è¯ç”¨æˆ·è¿›ç¨‹ä¸èƒ½ç›´æ¥æ“ä½œå†…æ ¸ï¼Œä¿è¯å†…æ ¸çš„å®‰å…¨ï¼Œæ“å¿ƒç³»ç»Ÿå°†è™šæ‹Ÿç©ºé—´åˆ’åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†ä¸ºå†…æ ¸ç©ºé—´ï¼Œä¸€éƒ¨åˆ†ä¸ºç”¨æˆ·ç©ºé—´ã€‚é’ˆå¯¹linuxæ“ä½œç³»ç»Ÿè€Œè¨€ï¼Œå°†æœ€é«˜çš„1Gå­—èŠ‚ï¼ˆä»è™šæ‹Ÿåœ°å€0xC0000000åˆ°0xFFFFFFFFï¼‰ï¼Œä¾›å†…æ ¸ä½¿ç”¨ï¼Œç§°ä¸ºå†…æ ¸ç©ºé—´ï¼Œè€Œå°†è¾ƒä½çš„3Gå­—èŠ‚ï¼ˆä»è™šæ‹Ÿåœ°å€0x00000000åˆ°0xBFFFFFFFï¼‰ï¼Œä¾›å„ä¸ªè¿›ç¨‹ä½¿ç”¨ï¼Œç§°ä¸ºç”¨æˆ·ç©ºé—´ã€‚ç©ºé—´åˆ†é…å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://cdn.syst.top/19223008-e9e63cbdacf24562a462656c7985f638.png" alt="19223008-e9e63cbdacf24562a462656c7985f638"></p>
<p>Kernel spaceå¯ä»¥è°ƒç”¨ç³»ç»Ÿçš„ä¸€åˆ‡èµ„æºã€‚User space ä¸èƒ½ç›´æ¥è°ƒç”¨ç³»ç»Ÿèµ„æºï¼Œåœ¨ Linuxç³»ç»Ÿä¸­ï¼Œæ‰€æœ‰çš„ç³»ç»Ÿèµ„æºç®¡ç†éƒ½æ˜¯åœ¨å†…æ ¸ç©ºé—´ä¸­å®Œæˆçš„ã€‚æ¯”å¦‚è¯»å†™ç£ç›˜æ–‡ä»¶ã€åˆ†é…å›æ”¶å†…å­˜ã€ä»ç½‘ç»œæ¥å£è¯»å†™æ•°æ®ç­‰ç­‰ã€‚åº”ç”¨ç¨‹åºæ— æ³•ç›´æ¥è¿›è¡Œè¿™æ ·çš„æ“ä½œï¼Œä½†æ˜¯ç”¨æˆ·ç¨‹åºå¯ä»¥é€šè¿‡å†…æ ¸æä¾›çš„æ¥å£æ¥å®Œæˆè¿™æ ·çš„ä»»åŠ¡ã€‚<img src="https://cdn.syst.top/bg2016120201-2.png" alt="bg2016120201-2"></p>
<p>æ¯”å¦‚åƒä¸‹é¢è¿™æ ·ï¼Œ</p>
<p><img src="https://cdn.syst.top/20220414115147.png" alt="æˆªå±2022-04-14 ä¸‹åˆ11.51.47"></p>
<p>åº”ç”¨ç¨‹åºè¦è¯»å–ç£ç›˜ä¸Šçš„ä¸€ä¸ªæ–‡ä»¶ï¼Œå®ƒå¯ä»¥å‘å†…æ ¸å‘èµ·ä¸€ä¸ª â€œç³»ç»Ÿè°ƒç”¨â€ å‘Šè¯‰å†…æ ¸ï¼šâ€æˆ‘è¦è¯»å–ç£ç›˜ä¸Šçš„æŸæŸæ–‡ä»¶â€ã€‚å…¶å®å°±æ˜¯é€šè¿‡ä¸€ä¸ªç‰¹æ®Šçš„æŒ‡ä»¤è®©è¿›ç¨‹ä»ç”¨æˆ·æ€è¿›å…¥åˆ°å†…æ ¸æ€ï¼Œåœ¨å†…æ ¸ç©ºé—´ä¸­ï¼ŒCPU å¯ä»¥æ‰§è¡Œä»»ä½•çš„æŒ‡ä»¤ï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬ä»ç£ç›˜ä¸Šè¯»å–æ•°æ®ã€‚å…·ä½“è¿‡ç¨‹æ˜¯å…ˆæŠŠæ•°æ®è¯»å–åˆ°å†…æ ¸ç©ºé—´ä¸­ï¼Œç„¶åå†æŠŠæ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´å¹¶ä»å†…æ ¸æ€åˆ‡æ¢åˆ°ç”¨æˆ·æ€ã€‚æ­¤æ—¶åº”ç”¨ç¨‹åºå·²ç»ä»ç³»ç»Ÿè°ƒç”¨ä¸­è¿”å›å¹¶ä¸”æ‹¿åˆ°äº†æƒ³è¦çš„æ•°æ®ï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œç”¨æˆ·ç©ºé—´æ‰§è¡Œé€»è¾‘ã€‚</p>
<p>è¿™æ ·çš„è¯ï¼Œä¸€æ—¦æ¶‰åŠåˆ°å¯¹I/Oçš„å¤„ç†ï¼Œå°±å¿…ç„¶ä¼šæ¶‰åŠåˆ°åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´æ¥å›åˆ‡æ¢ã€‚</p>
<h3 id="ioæ¨¡å‹">ioæ¨¡å‹</h3>
<p>ç½‘ä¸Šæœ‰å¤ªå¤šå…³äºI/Oæ¨¡å‹çš„æ–‡ç« ï¼Œçœ‹ç€çœ‹ç€æœ‰å¯èƒ½å°±è·‘åäº†ï¼Œæ‰€ä»¥æˆ‘è¿˜æ˜¯ä» &laquo;UNIX ç½‘ç»œç¼–ç¨‹&raquo; ä¸­æ€»ç»“çš„5ä¸­I/Oæ¨¡å‹è¯´èµ·å§ã€‚</p>
<p>Unixå¯ç”¨çš„5ç§I/Oæ¨¡å‹ã€‚</p>
<ul>
<li>é˜»å¡I/O</li>
<li>éé˜»å¡I/O</li>
<li>I/Oå¤ç”¨</li>
<li>ä¿¡å·é©±åŠ¨å¼I/O(SIGIO)</li>
<li>å¼‚æ­¥I/O(POSIXçš„aio_ç³»åˆ—å‡½æ•°)</li>
</ul>
<h5 id="é˜»å¡io">é˜»å¡I/O</h5>
<p><img src="https://cdn.syst.top/20220409102931.png" alt="æˆªå±2022-04-09 ä¸Šåˆ10.29.31"></p>
<p>é˜»å¡å¼I/Oä¸‹ï¼Œè¿›ç¨‹è°ƒç”¨recvfromï¼Œç›´åˆ°æ•°æ®åˆ°è¾¾ä¸”è¢«å¤åˆ¶åˆ°åº”ç”¨ç¨‹åºçš„ç¼“å†²åŒºä¸­æˆ–è€…å‘ç”Ÿé”™è¯¯æ‰è¿”å›ï¼Œåœ¨æ•´ä¸ªè¿‡ç¨‹è¿›ç¨‹éƒ½æ˜¯è¢«é˜»å¡çš„ã€‚</p>
<h5 id="éé˜»å¡io">éé˜»å¡I/O</h5>
<p><img src="https://cdn.syst.top/20220409103942.png" alt="æˆªå±2022-04-09 ä¸Šåˆ10.39.42"></p>
<p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œå‰ä¸‰æ¬¡è°ƒç”¨recvfromä¸­æ²¡æœ‰æ•°æ®å¯è¿”å›ï¼Œå› æ­¤å†…æ ¸è½¬è€Œç«‹å³è¿”å›ä¸€ä¸ªEWOULDBLOCKé”™è¯¯ã€‚ç¬¬å››æ¬¡è°ƒç”¨recvfromæ—¶å·²æœ‰ä¸€ä¸ªæ•°æ®æŠ¥å‡†å¤‡å¥½ï¼Œå®ƒè¢«å¤åˆ¶åˆ°åº”ç”¨ç¨‹åºç¼“å†²åŒºï¼Œäºæ˜¯recvfromæˆåŠŸè¿”å›ã€‚</p>
<p>å½“ä¸€ä¸ªåº”ç”¨ç¨‹åºåƒè¿™æ ·å¯¹ä¸€ä¸ªéé˜»å¡æè¿°ç¬¦å¾ªç¯è°ƒç”¨recvfromæ—¶ï¼Œæˆ‘ä»¬é€šå¸¸ç§°ä¸ºè½®è¯¢(polling)ï¼ŒæŒç»­è½®è¯¢å†…æ ¸ï¼Œä»¥è¿™ç§æ–¹å¼æŸ¥çœ‹æŸä¸ªæ“ä½œæ˜¯å¦å°±ç»ªã€‚</p>
<h5 id="ioå¤šè·¯å¤ç”¨">I/Oå¤šè·¯å¤ç”¨</h5>
<p><img src="https://cdn.syst.top/20220409103948.png" alt="æˆªå±2022-04-09 ä¸Šåˆ10.39.48"></p>
<p>æœ‰äº†I/Oå¤šè·¯å¤ç”¨(I/O multiplexing)ï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨ select æˆ–è€… pollï¼Œé˜»å¡åœ¨è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ä¸­çš„æŸä¸€ä¸ªä¹‹ä¸Šï¼Œè€Œä¸æ˜¯é˜»å¡åœ¨çœŸæ­£çš„I/Oç³»ç»Ÿè°ƒç”¨ä¸Šã€‚</p>
<p>ä¸Šé¢è¿™å¥è¯éš¾ç†è§£æ˜¯å§ï¼Œè¯´ç™½äº†è¿™é‡ŒæŒ‡çš„æ˜¯ï¼Œåœ¨ç¬¬ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯é˜»å¡åœ¨selectè°ƒç”¨ä¸Šï¼Œç›´åˆ°æ•°æ®æŠ¥å¥—æ¥å­—å˜ä¸ºå¯è¯»ï¼Œè¿”å›å¯è¯»æ¡ä»¶ï¼Œè¿™é‡Œå¹¶æ²¡æœ‰å‘ç”ŸI/Oäº‹ä»¶ï¼Œæ‰€ä»¥è¯´è¿™ä¸€æ­¥ï¼Œå¹¶æ²¡æœ‰é˜»å¡åœ¨çœŸæ­£çš„I/Oç³»ç»Ÿè°ƒç”¨ä¸Šã€‚</p>
<p>å…¶ä»–ä¸¤ç§å°±ä¸è¿‡å¤šä»‹ç»äº†ã€‚</p>
<p>è¿˜æœ‰ä¸€ç‚¹ï¼Œæˆ‘ä»¬ä¼šç»å¸¸æåˆ°åŒæ­¥I/Oå’Œå¼‚æ­¥I/Oã€‚</p>
<p>POSIX æŠŠè¿™ä¸¤ç§æœ¯è¯­å®šä¹‰å¦‚ä¸‹:</p>
<ul>
<li>åŒæ­¥I/Oæ“ä½œ(synchronous I/O opetation) å¯¼è‡´è¯·æ±‚è¿›ç¨‹è¢«é˜»å¡ï¼Œç›´åˆ°I/Oæ“ä½œå®Œæˆã€‚</li>
<li>å¼‚æ­¥I/O(asynchronous opetation) ä¸å¯¼è‡´è¯·æ±‚è¿›ç¨‹è¢«é˜»å¡ã€‚</li>
</ul>
<p>åŸºäºä¸Šé¢çš„å®šä¹‰ï¼Œ</p>
<p><img src="https://cdn.syst.top/20220409110643.png" alt="æˆªå±2022-04-09 ä¸Šåˆ11.06.43"></p>
<p>å¼‚æ­¥I/Oçš„å…³é”®åœ¨äºç¬¬äºŒæ­¥çš„recrfromæ˜¯å¦ä¼šé˜»å¡ä½ç”¨æˆ·è¿›ç¨‹ï¼Œå¦‚æœä¸é˜»å¡ï¼Œé‚£å®ƒå°±æ˜¯å¼‚æ­¥I/Oã€‚ä»ä¸Šé¢æ±‡æ€»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œåªæœ‰å¼‚æ­¥I/Oæ»¡è¶³POSIXä¸­å¯¹å¼‚æ­¥I/Oçš„å®šä¹‰ã€‚</p>
<h3 id="go-netpoller">Go netpoller</h3>
<p>Go netpoller åº•å±‚å°±æ˜¯å¯¹I/Oå¤šè·¯å¤ç”¨çš„å°è£…ã€‚ä¸åŒå¹³å°å¯¹I/Oå¤šè·¯å¤ç”¨æœ‰ä¸åŒçš„å®ç°æ–¹å¼ã€‚æ¯”å¦‚Linuxçš„selectã€pollå’Œepoll(å…·ä½“å·®åˆ«ä¸æ˜¯å¾ˆæ˜ç™½å¯ä»¥çœ‹è¿™ç¯‡)ã€‚åœ¨MacOSåˆ™æ˜¯kqueue,è€ŒWindowsæ˜¯åŸºäºå¼‚æ­¥I/Oå®ç°çš„icop&hellip;&hellip;ï¼ŒåŸºäºè¿™äº›èƒŒæ™¯ï¼ŒGoé’ˆå¯¹ä¸åŒçš„å¹³å°è°ƒç”¨å®ç°äº†å¤šç‰ˆæœ¬çš„netpollerã€‚</p>
<p><img src="https://cdn.syst.top/2022040983928.png" alt="æˆªå±2022-04-09 ä¸‹åˆ8.39.28"></p>
<p>ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªdemoå¼€å§‹è®²è§£ã€‚</p>
<p><img src="https://cdn.syst.top/demo.png" alt="demo"></p>
<p>å¾ˆç®€å•ä¸€ä¸ªdemoï¼Œå¼€å¯ä¸€ä¸ªtcpæœåŠ¡ã€‚ç„¶åæ¯æ¥ä¸€ä¸ªè¿æ¥ï¼Œå°±å¯åŠ¨ä¸€ä¸ªgå»å¤„ç†è¿æ¥ã€‚å¤„ç†å®Œæ¯•ï¼Œå…³é—­è¿æ¥ã€‚</p>
<p>è€Œä¸”æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯åŒæ­¥çš„æ¨¡å¼å»ç¼–å†™å¼‚æ­¥çš„é€»è¾‘ï¼Œä¸€ä¸ªè¿æ¥å¯¹åº”ä¸€ä¸ªgå¤„ç†ï¼Œæå…¶ç®€å•å’Œæ˜“äºç†è§£ã€‚goæ ‡å‡†åº“ä¸­çš„http.serverä¹Ÿæ˜¯è¿™ä¹ˆå¹²çš„ã€‚</p>
<p><img src="https://cdn.syst.top/carbon14.png" alt="carbon (14)"></p>
<p>é’ˆå¯¹ä¸Šé¢çš„tcpæœåŠ¡demoï¼Œæˆ‘ä»¬éœ€è¦å…³æ³¨è¿™æ®µä»£ç åº•å±‚éƒ½å‘ç”Ÿäº†ä»€ä¹ˆã€‚</p>
<p>ä¸Šé¢ä»£ç ä¸­ä¸»è¦æ¶‰åŠåº•å±‚çš„ä¸€äº›ç»“æ„ã€‚</p>
<p><img src="https://cdn.syst.top/2022040982429.png" alt="æˆªå±2022-04-09 ä¸‹åˆ8.24.29"></p>
<p>å…ˆç®€å•è§£é‡Šä¸€æ³¢ã€‚</p>
<ul>
<li>TCPListener:æˆ‘ä»¬å¼€å¯çš„æ˜¯ä¸€ä¸ªTCPæœåŠ¡ï¼Œé‚£å½“ç„¶å°±æ˜¯TCPæœåŠ¡çš„ç½‘ç»œç›‘å¬å™¨ã€‚</li>
<li>netFD:ç½‘ç»œæè¿°ç¬¦ã€‚Goä¸­æ‰€æœ‰çš„ç½‘ç»œæ“ä½œéƒ½æ˜¯ä»¥netFDå®ç°çš„ï¼Œå®ƒå’Œåº•å±‚FDåšç»‘å®šã€‚</li>
<li>FD:æ–‡ä»¶æè¿°ç¬¦ã€‚netå’ŒosåŒ…æŠŠè¿™ä¸ªç±»å‹ä½œä¸ºä¸€ä¸ªç½‘ç»œè¿æ¥æˆ–è€…æ“ä½œç³»ç»Ÿæ–‡ä»¶ã€‚å…¶ä¸­é‡Œé¢ä¸€ä¸ªå­—æ®µSysfdå°±æ˜¯å…·ä½“æ–‡ä»¶æè¿°ç¬¦å€¼ã€‚</li>
<li>pollDesc:I/Oè½®è¯¢å™¨ã€‚è¯´ç™½äº†å®ƒå°±æ˜¯åº•å±‚äº‹ä»¶é©±åŠ¨çš„å°è£…ã€‚å…¶ä¸­çš„runtimeCtxæ˜¯ä¸€ä¸ªæŒ‡é’ˆç±»å‹ï¼Œå…·ä½“æŒ‡å‘runtime/netpoll ä¸­çš„pollDesc.</li>
</ul>
<p>å½“ç„¶å›¾ä¸Šé¢ç»“æ„å­—æ®µéƒ½æ˜¯é˜‰å‰²ç‰ˆçš„ï¼Œä½†æ˜¯ä¸å½±å“æˆ‘ä»¬è¿™ç¯‡æ–‡ç« ã€‚</p>
<p>è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆç»“æ„ä¸Šéœ€è¦ä¸€å±‚ä¸€å±‚åµŒå…¥å‘¢ï¼Ÿ</p>
<p>æˆ‘çš„ç†è§£æ˜¯æ¯ä¸‹ä¸€å±‚éƒ½æ˜¯æ›´åŠ æŠ½è±¡çš„ä¸€å±‚ã€‚å®ƒæ˜¯å¯ä»¥ä½œä¸ºä¸Šä¸€å±‚å…·ä½“çš„ä¸€ç§åº”ç”¨ä½“ç°ã€‚</p>
<p>æ˜¯ä¸æ˜¯è·Ÿæ²¡è¯´ä¸€æ ·ï¼Ÿå“ˆå“ˆã€‚</p>
<p>ä¸¾ä¾‹ï¼Œæ¯”å¦‚è¿™é‡Œçš„netFDè¡¨ç¤ºç½‘ç»œæè¿°ç¬¦ã€‚</p>
<p>å®ƒçš„ä¸Šä¸€å±‚å¯ä»¥æ˜¯ç”¨äºTCPçš„ç½‘ç»œç›‘å¬å™¨TCPListenerï¼Œé‚£ä¹ˆå¯¹åº”çš„æ¥å£æˆ‘ä»¬èƒ½æƒ³åˆ°çš„æœ‰ä¸¤ä¸ªAcceptä»¥åŠcloseã€‚</p>
<p>å¯¹äºAccept åŠ¨ä½œï¼Œä¸€å®šæ˜¯è¿”å›ä¸€ä¸ªè¿æ¥ç±»å‹ Conn ï¼Œé’ˆå¯¹è¿™ä¸ªè¿æ¥ï¼Œå®ƒæœ¬èº«ä¹Ÿå­˜åœ¨ä¸€ä¸ªè‡ªå·±çš„netFDï¼Œé‚£ä¹ˆå¯æƒ³è€ŒçŸ¥ä¸€å®šä¼šæœ‰ Writeå’ŒReadä¸¤ä¸ªæ“ä½œã€‚</p>
<p>è€Œæ‰€æœ‰çš„ç½‘ç»œæ“ä½œéƒ½æ˜¯ä»¥netFDå®ç°çš„ã€‚è¿™æ ·ï¼ŒnetFDåœ¨è¿™é‡Œå°±æœ‰ä¸¤ç§ä¸ç”¨çš„ä¸Šå±‚åº”ç”¨ä½“ç°äº†ã€‚</p>
<p>å¥½äº†,æˆ‘ä»¬éœ€è¦ææ¸…æ¥šå‡ ä»¶äº‹ï¼š</p>
<ul>
<li>ä¸€èˆ¬æˆ‘ä»¬ç”¨å…¶ä»–è¯­è¨€å†™ä¸€ä¸ªtcpæœåŠ¡ï¼Œå¿…ç„¶ä¼šå†™è¿™å‡ æ­¥ï¼šsocket-&gt;bind-&gt;listenï¼Œä½†æ˜¯Goå°±ä¸€ä¸ªListenï¼Œé‚£å°±æ„å‘³ç€åº•å±‚åŒ…è£…äº†è¿™äº›æ“ä½œã€‚å®ƒæ˜¯åœ¨å“ªä¸€æ­¥å®Œæˆçš„ï¼Ÿ</li>
<li>Goæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™åˆå§‹åŒ–netpollçš„ï¼Œæ¯”å¦‚linuxä¸‹åˆå§‹åŒ–epollå®ä¾‹ã€‚</li>
<li>å½“å¯¹åº”fdæ²¡æœ‰å¯è¯»æˆ–è€…å¯å†™çš„IOäº‹ä»¶è€Œå¯¹åº”è¢«æŒ‚èµ·çš„gï¼Œæ˜¯å¦‚ä½•çŸ¥é“fdä¸Šçš„I/Oäº‹ä»¶å·²readyï¼Œåˆæ˜¯å¦‚ä½•å”¤é†’å¯¹åº”çš„gçš„ï¼Ÿ</li>
</ul>
<h3 id="listenè§£æ">Listenè§£æ</h3>
<p>å¸¦ç€è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬æ¥ç€çœ‹æµç¨‹ã€‚</p>
<p><img src="https://cdn.syst.top/Xnip2022-04-11_22-02-31.jpg" alt="Xnip2022-04-11_22-02-31"></p>
<p>ä¸Šå›¾å·²ç»æŠŠå½“ä½ è°ƒç”¨Listenæ“ä½œçš„å®Œæ•´æµç¨‹å…¨éƒ¨ç½—åˆ—å‡ºæ¥äº†ã€‚å°±åƒæˆ‘ä¸Šé¢åˆ—å‡ºçš„ç»“æ„å…³ç³»ä¸€æ ·ï¼Œä»ç»“æ„å±‚æ¬¡æ¥è¯´ï¼Œæ¯è°ƒç”¨ä¸‹ä¸€å±‚ï¼Œéƒ½æ˜¯ä¸ºäº†åˆ›å»ºå¹¶è·å–ä¸‹ä¸€å±‚çš„ä¾èµ–ï¼Œå› ä¸ºå†…éƒ¨çš„é«˜åº¦æŠ½è±¡ä¸å°è£…ï¼Œæ‰ä½¿å¾—ä½¿ç”¨è€…å¾€å¾€åªéœ€è°ƒç”¨æå°‘æ•°ç®€å•çš„APIæ¥å£ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»çŸ¥é“äº‹ä¾‹ä»£ç æ¶‰åŠåˆ°çš„ç»“æ„ä»¥åŠå¯¹åº”æµç¨‹äº†ã€‚</p>
<p>åœ¨ä¼ ç»Ÿå°è±¡ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªç½‘ç»œæœåŠ¡ã€‚éœ€è¦ç»è¿‡:åˆ›å»ºä¸€ä¸ªsocketã€bind ã€listenè¿™åŸºæœ¬çš„ä¸‰å¤§æ­¥ã€‚</p>
<p>å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼ŒGoä¸­æ‰€æœ‰çš„ç½‘ç»œæ“ä½œéƒ½æ˜¯ä»¥netFDå®ç°çš„ã€‚goä¹Ÿæ˜¯åœ¨è¿™ä¸€å±‚å°è£…è¿™ä¸‰å¤§æ­¥çš„ã€‚æ‰€ä»¥æˆ‘ä»¬ç›´æ¥ä»netFDé€»è¾‘å¼€å§‹è¯´ã€‚</p>
<p>ä¸Šå›¾æ˜¯åœ¨è°ƒç”¨socketå‡½æ•°è¿™ä¸€æ­¥è¿”å›çš„netFDï¼Œå¯æƒ³è€Œä¹‹æ ¸å¿ƒé€»è¾‘éƒ½åœ¨è¿™é‡Œé¢ã€‚</p>
<p><img src="https://cdn.syst.top/2022041294936.png" alt="æˆªå±2022-04-12 ä¸‹åˆ9.49.36"></p>
<p>æˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªå‡½æ•°æ ¸å¿ƒç‚¹çœ‹æˆä¸‰æ­¥ã€‚</p>
<ul>
<li>è°ƒç”¨sysSocketå‡½æ•°åˆ›å»ºä¸€ä¸ªsocketï¼Œè¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦(file descriptor)ï¼Œç®€ç§°fdä¸‹æ–‡ã€‚</li>
<li>é€šè¿‡sysSocketè¿”å›çš„fdï¼Œè°ƒç”¨newFDå‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„netFDã€‚</li>
<li>è°ƒç”¨netFDè‡ªèº«çš„æ–¹æ³•listenStreamå‡½æ•°ï¼Œåšåˆå§‹åŒ–åŠ¨ä½œï¼Œå…·ä½“è¯¦æƒ…ä¸‹é¢å†è¯´ã€‚</li>
</ul>
<p>åœ¨sysSocketå‡½æ•°ä¸­ï¼Œé¦–å…ˆä¼šé€šè¿‡socketFuncæ¥åˆ›å»ºä¸€ä¸ªsocketï¼Œé€šè¿‡å±‚å±‚æŸ¥çœ‹ï¼Œæœ€ç»ˆæ˜¯é€šè¿‡system callæ¥å®Œæˆè¿™ä¸€æ­¥ã€‚å½“è·å–åˆ°å¯¹åº”fdæ—¶ï¼Œä¼šé€šè¿‡syscall.SetNonblockå‡½æ•°æŠŠå½“å‰è¿™ä¸ªfdè®¾ç½®æˆéé˜»å¡æ¨¡å¼ï¼Œè¿™æ ·å½“è¿™ä¸ªListenerè°ƒç”¨acceptå‡½æ•°å°±ä¸ä¼šè¢«é˜»å¡äº†ã€‚</p>
<p><img src="https://cdn.syst.top/Xnip2022-04-12_21-38-10.jpg" alt="Xnip2022-04-12_21-38-10"></p>
<p>ç¬¬äºŒæ­¥ï¼Œé€šè¿‡ç¬¬ä¸€æ­¥åˆ›å»ºsocketæ‹¿åˆ°çš„fdï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„netFDã€‚è¿™æ®µä»£ç æ²¡å•¥å¥½è§£é‡Šçš„ã€‚</p>
<p>ç¬¬ä¸‰æ­¥ï¼Œä¹Ÿå°±æ˜¯æœ€æ ¸å¿ƒçš„ä¸€æ­¥ï¼Œè°ƒç”¨netFDè‡ªèº«çš„listenStreamæ–¹æ³•ã€‚</p>
<p><img src="https://cdn.syst.top/20220412101207.png" alt="æˆªå±2022-04-12 ä¸‹åˆ10.12.07"></p>
<p>listenStreamé‡Œé¢ä¹Ÿæœ‰æ ¸å¿ƒçš„ä¸‰æ­¥:</p>
<ul>
<li>é€šè¿‡syscall.Bind å®Œæˆç»‘å®š</li>
<li>é€šè¿‡listenFunc å®Œæˆç›‘å¬</li>
<li>è°ƒç”¨netFDè‡ªèº«initå®Œæˆåˆå§‹åŒ–æ“ä½œ:netFD.init -&gt;poll.FD.init-&gt;FD.pollDesc.init</li>
</ul>
<p>æˆ‘ä»¬ä¸»è¦çœ‹fd.inité€»è¾‘ã€‚</p>
<p><img src="https://cdn.syst.top/Xnip2022-04-12_22-32-11.jpg" alt="Xnip2022-04-12_22-32-11"></p>
<p>æœ€ç»ˆæ˜¯è°ƒç”¨çš„pollDescçš„initå‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°æœ‰é‡è¦çš„ä¸¤æ­¥ã€‚</p>
<ul>
<li>runtime_pollServerInitï¼šä¸»è¦ä¼šæ ¹æ®ä¸åŒçš„å¹³å°å»è°ƒç”¨å¯¹åº”å¹³å°çš„netpollInitå‡½æ•°æ¥åˆ›å»ºI/Oå¤šè·¯å¤ç”¨çš„å®ä¾‹ã€‚æ¯”å¦‚linuxä¸‹åˆ›å»ºepollã€‚</li>
<li>runtime_pollOpen(uintptr(fd.Sysfd))ï¼šä¸»è¦å°†å·²ç»åˆ›å»ºå®Œçš„Listener fdæ³¨å†Œåˆ°ä¸Šè¿°å®ä¾‹å½“ä¸­ï¼Œæ¯”å¦‚å°†fdæ³¨å†Œåˆ°epollä¸­ï¼Œåº•å±‚é€šè¿‡syscallè°ƒç”¨epoll_ctlã€‚</li>
</ul>
<p>æ›´å…·ä½“çš„æµç¨‹ï¼Œ</p>
<p>é¦–å…ˆserviceInit.Do ä¿è¯å½“ä¸­çš„runtime_pollServerInitåªä¼šåˆå§‹åŒ–ä¸€æ¬¡ã€‚è¿™å¾ˆå¥½ç†è§£ï¼Œç±»ä¼¼epollå®ä¾‹å…¨å±€åˆå§‹åŒ–ä¸€æ¬¡å³å¯ã€‚</p>
<p>æ¥ç€æˆ‘ä»¬çœ‹ä¸‹runtime_pollServerInitå‡½æ•°ï¼Œ</p>
<p><img src="https://cdn.syst.top/20220412104034.png" alt="æˆªå±2022-04-12 ä¸‹åˆ10.40.34"></p>
<p>è¿™æ˜¯å’‹å›äº‹ï¼Œå’Œæˆ‘ä»¬å¹³å¸¸çœ‹è¿‡çš„å‡½æ•°é•¿çš„ä¸å¤ªä¸€æ ·ï¼Œæ‰§è¡Œä½“å‘¢ï¼Ÿ</p>
<p>å…¶å®è¿™ä¸ªå‡½æ•°æ˜¯é€šè¿‡ <strong>go:linkname</strong>è¿æ¥åˆ°å…·ä½“å®ç°çš„å‡½æ•°poll_runtime_pollServerInitã€‚æ‰¾èµ·æ¥ä¹Ÿå¾ˆç®€å•ï¼Œ</p>
<p><img src="https://cdn.syst.top/20220412104257.png" alt="æˆªå±2022-04-12 ä¸‹åˆ10.42.57"></p>
<p>çœ‹åˆ°poll_runtime_pollServerInit()ä¸Šé¢çš„ <strong>//go:linkname xxx</strong> äº†å—ï¼Ÿä¸äº†è§£çš„å¯ä»¥çœ‹çœ‹Goå®˜æ–¹æ–‡æ¡£`go:linknameã€‚</p>
<p>æ‰€ä»¥æœ€ç»ˆruntime_pollServerInitè°ƒç”¨çš„æ˜¯ï¼Œ</p>
<p><img src="https://cdn.syst.top/20220412104719.png" alt="æˆªå±2022-04-12 ä¸‹åˆ10.47.19"></p>
<p>é€šè¿‡è°ƒç”¨poll_runtime_pollServerInit-&gt;netpollGenericInitï¼ŒnetpollGenericInité‡Œè°ƒç”¨netpollinitå‡½æ•°å®Œæˆåˆå§‹åŒ–ã€‚</p>
<p>æ³¨æ„ã€‚è¿™é‡Œçš„netpollinitï¼Œæ˜¯åŸºäºå½“å‰ç³»ç»Ÿæ¥è°ƒç”¨å¯¹åº”ç³»ç»Ÿçš„netpollinitå‡½æ•°çš„ã€‚</p>
<p>ä»€ä¹ˆæ„æ€ï¼Ÿ</p>
<p>æ–‡ç« å¼€å§‹æœ‰æåˆ°Goåº•å±‚ç½‘ç»œæ¨¡å‹æ˜¯åŸºäºI/Oå¤šè·¯å¤ç”¨ã€‚</p>
<p>ä¸åŒå¹³å°å¯¹I/Oå¤šè·¯å¤ç”¨æœ‰ä¸åŒçš„å®ç°æ–¹å¼ã€‚æ¯”å¦‚Linuxçš„epollï¼ŒMacOSçš„kqueue,è€ŒWindowsçš„icopã€‚</p>
<p>æ‰€ä»¥å¯¹åº”ï¼Œå¦‚æœä½ å½“å‰æ˜¯Linuxï¼Œé‚£ä¹ˆæœ€ç»ˆè°ƒç”¨çš„æ˜¯<code>src/runtime/netpoll_epoll.go</code>ä¸‹çš„ netpollinitå‡½æ•°ï¼Œç„¶åä¼šåˆ›å»ºä¸€ä¸ªepollå®ä¾‹ï¼Œå¹¶æŠŠå€¼èµ‹ç»™epfdï¼Œä½œä¸ºæ•´ä¸ªruntimeä¸­å”¯ä¸€çš„event-loopä½¿ç”¨ã€‚</p>
<p><img src="https://cdn.syst.top/2022041393222.png" alt="æˆªå±2022-04-13 ä¸‹åˆ9.32.22"></p>
<p>å…¶ä»–çš„ï¼Œæ¯”å¦‚MacOSä¸‹çš„kqueue,ä¹Ÿå­˜åœ¨netpollinitå‡½æ•°ã€‚</p>
<p><img src="https://cdn.syst.top/20220412110331.png" alt="æˆªå±2022-04-12 ä¸‹åˆ11.03.31"></p>
<p>ä»¥åŠWindowsä¸‹çš„icopã€‚</p>
<p><img src="https://cdn.syst.top/20220412110441.png" alt="æˆªå±2022-04-12 ä¸‹åˆ11.04.41"></p>
<p>æˆ‘ä»¬å›åˆ°pollDesc.init æ“ä½œï¼Œ</p>
<!-- raw HTML omitted -->
<p>å®Œæˆç¬¬ä¸€æ­¥åˆå§‹åŒ–æ“ä½œåï¼Œç¬¬äºŒæ­¥å°±æ˜¯è°ƒç”¨runtime_pollOpenã€‚</p>
<p>è€å¥—è·¯é€šè¿‡**//go:linkname**æ‰¾åˆ°å¯¹åº”çš„å®ç°ï¼Œå®é™…ä¸Šæ˜¯è°ƒç”¨çš„poll_runtime_pollOpenå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°é‡Œé¢å†è°ƒç”¨netpollopenå‡½æ•°ï¼Œnetpollopenå‡½æ•°å’Œä¸Šé¢çš„netpollinitå‡½æ•°ä¸€æ ·ï¼Œä¸åŒå¹³å°éƒ½æœ‰å®ƒçš„å®ç°ã€‚linuxå¹³å°ä¸‹ï¼Œ</p>
<p><img src="https://cdn.syst.top/20220413945402.png" alt="æˆªå±2022-04-13 ä¸‹åˆ9.45.40 2"></p>
<p>netpollopenå‡½æ•°ï¼Œé¦–å…ˆä¼šé€šè¿‡æŒ‡é’ˆæŠŠpollDescä¿å­˜åˆ°epolleventçš„ä¸€ä¸ªå­—èŠ‚æ•°ç»„dataé‡Œã€‚</p>
<p>ç„¶åä¼šæŠŠä¼ é€’è¿›æ¥çš„fd(åˆšæ‰åˆå§‹åŒ–å®Œæˆçš„é‚£ä¸ªListenerç›‘å¬å™¨)æ³¨å†Œåˆ°epollå½“ä¸­ï¼Œä¸”é€šè¿‡æŒ‡å®š _EPOLLETå°†epollè®¾ç½®ä¸ºè¾¹ç¼˜è§¦å‘(Edge Triggered)æ¨¡å¼ã€‚å¦‚æœè®©æˆ‘ç”¨ä¸€å¥è¯æ¥è¯´æ˜epollæ°´å¹³è§¦å‘å’Œè¾¹ç¼˜è§¦å‘çš„åŒºåˆ«ï¼Œé‚£å°±æ˜¯,</p>
<p>æ°´å¹³è§¦å‘ä¸‹epoll_waitåœ¨æ–‡ä»¶æè¿°ç¬¦æ²¡æœ‰è¯»å†™å®Œä¼šä¸€ç›´è§¦å‘ï¼Œè€Œè¾¹ç¼˜è§¦å‘åªåœ¨æ˜¯åœ¨å˜æˆå¯è¯»å†™æ—¶è§¦å‘ä¸€æ¬¡ã€‚</p>
<p>åˆ°è¿™é‡Œæ•´ä¸ªListen åŠ¨ä½œä¹Ÿå°±ç»“æŸäº†ï¼Œç„¶åå±‚å±‚è¿”å›ã€‚æœ€ç»ˆåˆ°ä¸šåŠ¡è¿”å›çš„æ˜¯ä¸€ä¸ª Listenerï¼ŒæŒ‰ç…§æœ¬ç¯‡çš„ä¾‹å­ï¼Œæœ¬è´¨ä¸Šè¿˜æ˜¯ä¸€ä¸ªTCPListenerã€‚</p>
<h3 id="acceptè§£æ">Acceptè§£æ</h3>
<p>æ¥ç€å½“æˆ‘ä»¬è°ƒç”¨listen.Acceptçš„æ—¶å€™ï¼Œ</p>
<p><img src="https://cdn.syst.top/Xnip2022-04-13_22-50-09.jpg" alt="Xnip2022-04-13_22-50-09"></p>
<p>æœ€ç»ˆnetFDçš„acceptå‡½æ•°ã€‚netFDä¸­é€šè¿‡è°ƒç”¨fd.pfd(å®é™…ä¸Šæ˜¯FD)çš„Acceptå‡½æ•°è·å–åˆ°socket fdã€‚é€šè¿‡è¿™ä¸ªfdåˆ›å»ºæ–°çš„netFDè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ–°è¿æ¥çš„fdã€‚å¹¶ä¸”ä¼šå’ŒListenæ—¶ä¸€æ ·è°ƒç”¨netFD.initåšåˆå§‹åŒ–ï¼Œå› ä¸ºå½“å‰epollå·²ç»åˆå§‹åŒ–ä¸€æ¬¡äº†ï¼Œæ‰€ä»¥è¿™æ¬¡åªæ˜¯æŠŠè¿™ä¸ªæ–°è¿æ¥çš„fdä¹ŸåŠ å…¥åˆ°epolläº‹ä»¶é˜Ÿåˆ—å½“ä¸­ï¼Œç”¨äºç›‘å¬conn fdçš„è¯»å†™I/Oäº‹ä»¶ã€‚</p>
<p>å…·ä½“æˆ‘ä»¬çœ‹FD.Acceptæ˜¯å’‹ä¹ˆæ‰§è¡Œçš„ã€‚</p>
<p><img src="https://cdn.syst.top/Xnip2022-04-13_22-57-56.jpg" alt="Xnip2022-04-13_22-57-56"></p>
<p>é¦–å…ˆæ˜¯ä¸€ä¸ªæ­»å¾ªç¯forï¼Œæ­»å¾ªç¯é‡Œè°ƒç”¨äº†acceptå‡½æ•°ï¼Œæœ¬è´¨ä¸Šé€šè¿‡systcallè°ƒç”¨ç³»ç»Ÿacceptæ¥æ”¶æ–°è¿æ¥ã€‚å½“æœ‰æ–°è¿æ¥æ—¶ï¼Œæœ€ç»ˆè¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦fdã€‚å½“acceptè·å–åˆ°ä¸€ä¸ªfdï¼Œä¼šè°ƒç”¨systcall.SetNonblockæŠŠè¿™ä¸ªfdè®¾ç½®æˆéé˜»å¡çš„I/Oã€‚ç„¶åè¿”å›è¿™ä¸ªè¿æ¥fdã€‚</p>
<p>å› ä¸ºæˆ‘ä»¬åœ¨Listençš„æ—¶å€™å·²ç»æŠŠå¯¹åº”çš„Listener fdè®¾ç½®æˆéé˜»å¡I/Oäº†ã€‚æ‰€ä»¥è°ƒç”¨acceptè¿™ä¸€æ­¥æ˜¯ä¸ä¼šé˜»å¡çš„ã€‚åªæ˜¯ä¸‹é¢ä¼šè¿›è¡Œåˆ¤æ–­ï¼Œæ ¹æ®åˆ¤æ–­ err ==syscall.EAGAIN æ¥è°ƒç”¨fd.pd.waitReadé˜»å¡ä½ç”¨æˆ·ç¨‹åºã€‚</p>
<p>ç›´åˆ°I/Oäº‹ä»¶readyï¼Œè¢«é˜»å¡åœ¨fd.pd.waitReadçš„ä»£ç ä¼šç»§ç»­æ‰§è¡Œcontinueï¼Œé‡æ–°ä¸€è½®çš„accept, æ­¤æ—¶å¯¹åº”fdä¸Šçš„ I/Oå·²ç„¶readyï¼Œæœ€ç»ˆå°±è¿”å›ä¸€ä¸ªconnç±»å‹çš„fdã€‚</p>
<p>æˆ‘åˆšæ‰è¯´çš„è°ƒç”¨fd.pd.waitReadä¼šè¢«é˜»å¡ï¼Œç›´åˆ°å¯¹åº”I/Oäº‹ä»¶readyã€‚æˆ‘ä»¬æ¥çœ‹å®ƒå…·ä½“é€»è¾‘ï¼Œ</p>
<p><img src="https://cdn.syst.top/carbon15.png" alt="carbon (15)"></p>
<p>æœ€ç»ˆåˆ°runtime_pollWaitå‡½æ•°ï¼Œè€å¥—è·¯äº†ï¼Œæˆ‘ä»¬æ‰¾åˆ°å…·ä½“çš„å®ç°å‡½æ•°ã€‚</p>
<p><img src="https://cdn.syst.top/carbon5.png" alt="carbon (3)"></p>
<p>poll_runtime_pollWait é‡Œçš„forå¾ªç¯å°±æ˜¯ä¸ºäº†ç­‰å¾…å¯¹åº”çš„I/O readyæ‰ä¼šè¿”å›ï¼Œå¦åˆ™çš„è¯ä¸€ç›´è°ƒç”¨netpollblockå‡½æ•°ã€‚pollDescç»“æ„æˆ‘ä»¬ä¹‹å‰æåˆ°ï¼Œå®ƒå°±æ˜¯åº•å±‚äº‹ä»¶é©±åŠ¨çš„å°è£…ã€‚å…¶ä¸­æœ‰ä¸¤ä¸ªé‡è¦å­—æ®µ: rgå’Œwgï¼Œéƒ½æ˜¯æŒ‡é’ˆç±»å‹ï¼Œå®é™…è¿™ä¸¤ä¸ªå­—æ®µå­˜å‚¨çš„å°±æ˜¯Goåº•å±‚çš„gï¼Œæ›´å…·ä½“ç‚¹æ˜¯ç­‰å¾…i/O readyçš„gã€‚</p>
<p>æ¯”å¦‚å½“åˆ›å»ºå®Œä¸€ä¸ªListenerï¼Œè°ƒç”¨Acceptå¼€å§‹æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ã€‚å¦‚æœæ²¡æœ‰å¯¹åº”çš„è¯·æ±‚ï¼Œé‚£ä¹ˆæœ€ç»ˆä¼šæŠŠgæ”¾å…¥åˆ°pollDescçš„rgã€‚</p>
<p>å¦‚æœæ˜¯ä¸€ä¸ªconnç±»å‹çš„fdç­‰å¾…å¯å†™I/Oï¼Œé‚£ä¹ˆä¼šæŠŠgæ”¾å…¥åˆ°pollDescçš„wgä¸­ã€‚</p>
<p>å…·ä½“å°±æ˜¯æ ¹æ®modeæ¥åˆ¤æ–­å½“å‰æ˜¯ä»€ä¹ˆç±»å‹çš„ç­‰å¾…äº‹ä»¶ã€‚</p>
<p>netpollblocké‡Œä¹Ÿæœ‰ä¸€ä¸ªforå¾ªç¯ï¼Œå¦‚æœå·²ç»readyäº†ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›ç»™ä¸Šä¸€å±‚å°±è¡Œäº†ã€‚å¦åˆ™çš„è¯ï¼Œè®¾ç½®gppä¸ºç­‰å¾…çŠ¶æ€pdWaitã€‚</p>
<p>è¿™é‡Œè¿˜æœ‰ä¸€ç‚¹atomic.Loaduintptr(gpp)ï¼Œè¿™æ˜¯ä¸ºäº†é˜²æ­¢å¼‚å¸¸æƒ…å†µä¸‹å‡ºç°æ­»å¾ªç¯é—®é¢˜ã€‚æ¯”å¦‚å¦‚æœgppçš„å€¼ä¸æ˜¯pdReadyä¹Ÿä¸æ˜¯0ï¼Œé‚£ä¹ˆæ„å‘³ç€å€¼æ˜¯pdWaitï¼Œé‚£å°±æˆäº†double waitï¼Œå¿…ç„¶å¯¼è‡´æ­»å¾ªç¯ã€‚</p>
<p>å¦‚æœgppæœªreadyä¸”æˆåŠŸè®¾ç½®æˆpdWaitï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œæœ€ç»ˆä¼šè°ƒç”¨goparkï¼Œä¼šæŒ‚èµ·gä¸”æŠŠå¯¹åº”çš„gæ”¾å…¥åˆ°pollDesc çš„wg|rg å½“ä¸­ã€‚</p>
<p>è¿›å…¥goparkã€‚</p>
<p><img src="https://cdn.syst.top/carbon6.png" alt="carbon (6)"></p>
<p>è¿™ä¸€å—ä»£ç ä¸æ˜¯å¾ˆéš¾æ‡‚ï¼ŒåŸºæœ¬çš„å­—æ®µæ‰“äº†å¤‡æ³¨ï¼Œæ ¸å¿ƒè¿˜æ˜¯è¦çœ‹park_mè¿™ä¸ªå‡½æ•°ã€‚</p>
<p><img src="https://cdn.syst.top/carbon9.png" alt="carbon (8)"></p>
<p>park_må‡½æ•°ä¸­ï¼Œé¦–å…ˆä¼šé€šè¿‡CASå¹¶å‘å®‰å…¨çš„ä¿®æ”¹gçš„çŠ¶æ€ã€‚ç„¶åè°ƒç”¨dropgè§£ç»‘gå’Œmçš„å…³ç³»ï¼Œä¹Ÿå°±æ˜¯mæŠŠå½“å‰è¿è¡Œçš„gç½®ç©ºï¼ŒgæŠŠå½“å‰ç»‘å®šçš„mç½®ç©ºã€‚</p>
<p>åé¢çš„ä»£ç æ˜¯æ ¹æ®å½“å‰åœºæ™¯æ¥è§£é‡Šçš„ã€‚æˆ‘ä»¬çŸ¥é“æ­¤æ—¶mçš„waitunlockf å…¶å®å°±æ˜¯netpollblockcommitã€‚</p>
<p><img src="https://cdn.syst.top/carbon7.png" alt="carbon (7)"></p>
<p>netpollblockcommitä¼šæŠŠå½“å‰å·²ç»æ˜¯_GwaitingçŠ¶æ€ä¸‹çš„gèµ‹å€¼ç»™gppã€‚å¦‚æœèµ‹å€¼æˆåŠŸï¼ŒnetpollWaitersä¼šåŠ 1ã€‚è¿™ä¸ªå…¨å±€å˜é‡è¡¨ç¤ºå½“å‰ç­‰å¾…I/Oäº‹ä»¶readyçš„gæ•°é‡ï¼Œè°ƒåº¦å™¨å†è¿›è¡Œè°ƒåº¦çš„æ—¶å€™å¯ä»¥æ ¹æ®æ­¤å˜é‡åˆ¤æ–­æ˜¯å¦å­˜åœ¨ç­‰å¾…I/Oäº‹ä»¶çš„gã€‚</p>
<p>å¦‚æœæ­¤æ—¶å½“å‰gppä¸‹çš„fdçš„I/Oå·²ç»readyã€‚é‚£ä¹ˆgppçš„çŠ¶æ€å¿…ç„¶å·²ä¸æ˜¯pdWaitï¼Œèµ‹å€¼å¤±è´¥ã€‚è¿”å›falseã€‚</p>
<p>å›åˆ°park_mï¼Œ</p>
<p>å¦‚æœnetpollblockcommitè¿”å›trueï¼Œé‚£ä¹ˆç›´æ¥è§¦å‘æ–°ä¸€è½®çš„è°ƒåº¦ã€‚</p>
<p>å¦‚æœnetpollblockcommitè¿”å›falseï¼Œæ„å‘³ç€å½“å‰gå·²ç»ä¸éœ€è¦è¢«æŒ‚èµ·äº†ï¼Œæ‰€ä»¥éœ€è¦æŠŠçŠ¶æ€è°ƒæ•´ä¸º_Grunnableï¼Œç„¶åå®‰æ’gè¿˜æ˜¯åœ¨å½“å‰mä¸Šæ‰§è¡Œã€‚</p>
<p>å½“I/Oäº‹ä»¶readyï¼Œä¼šä¸€å±‚å±‚è¿”å›ï¼Œè·å–åˆ°æ–°çš„socket fdï¼Œåˆ›å»ºconnç±»å‹çš„netFDï¼Œåˆå§‹åŒ–netFD(å…¶å®å°±æ˜¯æŠŠè¿™ä¸ªconnç±»å‹çš„fdä¹ŸåŠ å…¥epolläº‹ä»¶é˜Ÿåˆ—ï¼Œç”¨äºç›‘å¬)ï¼Œæœ€ç»ˆæœ€ä¸Šæ¸¸ä¼šè·å–åˆ°ä¸€ä¸ªConnç±»å‹çš„ç½‘ç»œè¿æ¥ï¼Œå°±å¯ä»¥åŸºäºè¿™ä¸ªè¿æ¥åšReadã€Writeç­‰æ“ä½œäº†ã€‚</p>
<p><img src="https://cdn.syst.top/carbon10.png" alt="carbon (10)"></p>
<h3 id="readwrite-è§£æ">Read/Write è§£æ</h3>
<p>åç»­çš„Conn.Read å’Œ Conn.Write åŸç†å’ŒAccept ç±»ä¼¼ã€‚</p>
<p><img src="https://cdn.syst.top/carbon11.png" alt="carbon (11)"></p>
<p>ç»™å‡ºäº†Writeæ“ä½œï¼Œå¯ä»¥çœ‹å‡ºæ ¸å¿ƒéƒ¨åˆ†å’Œacceptæ“ä½œæ—¶ä¸€æ ·çš„ã€‚å¯¹äºReadæ“ä½œï¼Œå°±ä¸å†é‡å¤äº†ã€‚</p>
<p>ä»ä¸Šé¢çš„åˆ†æä¸­æˆ‘ä»¬å·²ç»çŸ¥é“ï¼ŒGoçš„netpolleråº•å±‚é€šè¿‡å¯¹epoll|kqueue|iocpçš„å°è£…ï¼Œä½¿ç”¨åŒæ­¥çš„ç¼–ç¨‹æ‰‹æ³•è¾¾åˆ°å¼‚æ­¥æ‰§è¡Œçš„æ•ˆæœï¼Œæ— è®ºæ˜¯ä¸€ä¸ªListenerè¿˜æ˜¯ä¸€ä¸ªConnï¼Œå®ƒçš„æ ¸å¿ƒéƒ½æ˜¯netFDï¼ŒnetFDåˆå’Œåº•å±‚çš„PollDescç»“æ„ç»‘å®šï¼Œå½“è¯»å†™å‡ºç°EAGAINé”™è¯¯æ—¶ï¼Œä¼šé€šè¿‡è°ƒç”¨goparkæŠŠå½“å‰gç»™parkä½ï¼ŒåŒæ—¶ä¼šå°†å½“å‰çš„gå­˜å‚¨åˆ°å¯¹åº”netFDçš„PollDescçš„wg|rgå½“ä¸­ï¼Œ ç›´åˆ°è¿™ä¸ªnetFDå†æ¬¡å‘ç”Ÿå¯¹åº”çš„è¯»å†™äº‹ä»¶ï¼Œæ‰ä¼šé‡æ–°æŠŠå½“å‰gæ”¾å…¥åˆ°è°ƒåº¦ç³»ç»Ÿè¿›è¡Œè°ƒåº¦ã€‚</p>
<p>è¿˜æœ‰æœ€åä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å’‹ä¹ˆçŸ¥é“å“ªäº›FDå‘ç”Ÿè¯»å†™äº‹ä»¶äº†ï¼Ÿ</p>
<h3 id="ioå·²å°±ç»ª">I/Oå·²å°±ç»ª</h3>
<p>ç­”æ¡ˆå°±æ˜¯netpoll()å‡½æ•°ã€‚</p>
<p><img src="https://cdn.syst.top/carbon12.png" alt="carbon (12)"></p>
<p>æ­¤å‡½æ•°ä¼šè°ƒç”¨epollwaitå‡½æ•°ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯Linuxä¸­epoll_wait(int epfd, struct epoll_event * events, int maxevents, int timeout)ã€‚</p>
<p>åœ¨ä¹‹å‰è°ƒç”¨epoll_ctlï¼Œæ³¨å†Œfdå¯¹åº”çš„I/Oäº‹ä»¶åˆ°epollå®ä¾‹å½“ä¸­ã€‚è¿™é‡Œçš„epoll_waitå®é™…ä¸Šä¼šé˜»å¡ç›‘å¬epollå®ä¾‹ä¸Šæ‰€æœ‰fdçš„I/Oäº‹ä»¶ï¼Œé€šè¿‡ä¼ å…¥çš„ç¬¬äºŒä¸ªå‚æ•°(ç”¨æˆ·å†…å­˜åœ°å€events)ã€‚</p>
<p>å½“æœ‰å¯¹åº”çš„I/Oäº‹ä»¶åˆ°æ¥æ—¶ï¼Œå†…æ ¸å°±ä¼šæŠŠå‘ç”Ÿäº‹ä»¶å¯¹åº”çš„fdå¤åˆ¶åˆ°è¿™å—ç”¨æˆ·å†…å­˜åœ°å€(events)ã€‚è§£é™¤é˜»å¡ï¼Œç„¶åæˆ‘ä»¬éå†è¿™ä¸ªeventsï¼Œå»è·å–åˆ°å¯¹åº”çš„äº‹ä»¶ç±»å‹ã€pollDescï¼Œå†é€šè¿‡è°ƒç”¨netpollreadyå‡½æ•°è·å–åˆ°pollDescå¯¹åº”è¢«goparkçš„gï¼Œæœ€ç»ˆæŠŠè¿™äº›gåŠ å…¥åˆ°ä¸€ä¸ªé“¾è¡¨å½“ä¸­ï¼Œè¿”å›ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´åªè¦è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å°±èƒ½è·å–åˆ°ä¹‹å‰å› ä¸ºI/Oæœªreadyè€Œè¢«goparkæŒ‚èµ·ï¼Œç°åœ¨I/Oå·²readyçš„gé“¾è¡¨äº†ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å››ä¸ªè°ƒç”¨å¤„ï¼Œå¦‚ä¸‹ï¼Œ</p>
<ul>
<li>startTheWorldWithSema</li>
<li>findrunnable</li>
<li>pollWork</li>
<li>sysmon</li>
</ul>
<p>è¿™å’Œgoçš„è°ƒåº¦æœ‰å…³ï¼Œå½“ç„¶è¿™ä¸æ˜¯æœ¬ç« çš„å†…å®¹ã€‚å½“è¿™å››ç§æ–¹æ³•è°ƒç”¨netpollå‡½æ•°å¾—åˆ°ä¸€ä¸ªå¯è¿è¡Œçš„gé“¾è¡¨æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨åŒä¸€ä¸ªå‡½æ•°injectglistã€‚è¿™ä¸ªå‡½æ•°æœ¬è´¨ä¸Šå°±æ˜¯æŠŠé“¾è¡¨ä¸­æ‰€æœ‰gçš„çŠ¶æ€ä»_Gwaiting-&gt;_Grunnableã€‚ç„¶åæŒ‰ç…§ç­–ç•¥ï¼ŒæŠŠè¿™äº›gæ¨é€åˆ°æœ¬åœ°å¤„ç†å™¨pæˆ–è€…å…¨å®¶è¿è¡Œé˜Ÿåˆ—ä¸­ç­‰å¾…è¢«è°ƒåº¦å™¨æ‰§è¡Œã€‚</p>
<p><img src="https://cdn.syst.top/carbon13.png" alt="carbon (13)"></p>
<p>åˆ°è¿™é‡Œï¼Œæ•´ä¸ªæµç¨‹å°±å·²ç»å‰–æå®Œæ¯•ã€‚ä¸èƒ½å†å†™äº†ã€‚</p>
<h3 id="æœ€å">æœ€å</h3>
<p>Go netpolleré€šè¿‡åœ¨åº•å±‚å¯¹epoll/kqueue/iocpè¿™äº›ä¸åŒå¹³å°ä¸‹å¯¹I/Oå¤šè·¯å¤ç”¨å®ç°çš„å°è£…ï¼ŒåŠ ä¸Šè‡ªå¸¦çš„goroutine(ä¸Šæ–‡æˆ‘ä¸€ç›´ç”¨gè¡¨è¾¾)ï¼Œä»è€Œå®ç°äº†ä½¿ç”¨åŒæ­¥ç¼–ç¨‹æ¨¡å¼è¾¾åˆ°å¼‚æ­¥æ‰§è¡Œçš„æ•ˆæœã€‚ ä»£ç å¾ˆé•¿ï¼Œæ¶‰åŠåˆ°çš„æ¨¡å—ä¹Ÿå¾ˆå¤šï¼Œæ•´ä½“çœ‹å®Œä»£ç è¿˜æ˜¯éå¸¸çˆ½çš„ã€‚</p>
<p>å¦å¤–æ—©æœ‰äººæå‡ºï¼Œç”±äºä¸€ä¸ªè¿æ¥å¯¹åº”ä¸€ä¸ªgoroutineï¼Œç¬æ—¶å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¤§é‡çš„goroutineä¼šè¢«ä¸æ–­åˆ›å»ºã€‚ä¸”åŸç”Ÿnetpolleræ— æ³•æä¾›è¶³å¤Ÿçš„æ€§èƒ½å’Œæ§åˆ¶åŠ›ï¼Œå¦‚æ— æ³•æ„ŸçŸ¥è¿æ¥çŠ¶æ€ã€è¿æ¥æ•°é‡å¤šå¯¼è‡´åˆ©ç”¨ç‡ä½ã€æ— æ³•æ§åˆ¶åç¨‹æ•°é‡ç­‰ã€‚é’ˆå¯¹è¿™äº›é—®é¢˜ï¼Œå¯ä»¥å‚è€ƒä¸‹gnetä»¥åŠ KiteX è¿™ä¸¤ä¸ªé¡¹ç›®çš„ç½‘ç»œæ¨¡å‹ã€‚</p>
<h4 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h4>
<ul>
<li><a href="http://man7.org/linux/man-pages/man7/epoll.7.html">http://man7.org/linux/man-pages/man7/epoll.7.html</a></li>
<li>&laquo;UNIXç½‘ç»œç¼–ç¨‹:å·1&raquo;</li>
<li><a href="https://github.com/panjf2000/gnet">https://github.com/panjf2000/gnet</a></li>
<li><a href="https://strikefreedom.top/go-netpoll-io-multiplexing-reactor">https://strikefreedom.top/go-netpoll-io-multiplexing-reactor</a></li>
<li><a href="https://mp.weixin.qq.com/s/wSaJYg-HqnYY4SdLA2Zzaw">https://mp.weixin.qq.com/s/wSaJYg-HqnYY4SdLA2Zzaw</a></li>
<li><a href="https://ninokop.github.io/2018/02/18/go-net/">https://ninokop.github.io/2018/02/18/go-net/</a></li>
<li><a href="https://github.com/cloudwego/kitex">https://github.com/cloudwego/kitex</a></li>
</ul>
]]></content>
		</item>
		
		<item>
			<title>ä¸€ä¸ªç”¨goå®ç°çš„æœ‰é™çŠ¶æ€æœº </title>
			<link>https://www.syst.top/posts/go/easyfsm/</link>
			<pubDate>Sun, 06 Mar 2022 17:37:22 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/easyfsm/</guid>
			<description>easyfsm ä¹‹å‰çœ‹è¿‡æ–°äº®è€å“¥çš„go-fsm-orderï¼Œæ„Ÿè§‰è¿˜ä¸é”™ã€‚æœ€è¿‘åœ¨è¿ç§»é¡¹ç›®çš„æ—¶å€™ï¼Œå‘ç°æœ‰å¤šå¤„ä¸šåŠ¡å­˜åœ¨ä¸€äº›çŠ¶æ€çš„æµè½¬ï¼Œæ‰€ä»¥å°±åŸºäºgo-fsm-orderåšäº†é‡æ”¹ï¼Œè®©å®ƒå¯ä»¥åœ¨ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ä¸‹ä½¿ç”¨ã€‚
ä¸ºä»€ä¹ˆä¸ä½¿ç”¨looplab/fsmï¼ŒstaræŒºå¤šçš„å•Šã€‚
ä¸æ˜¯ç‰¹åˆ«å–œæ¬¢ï¼Œæ¯æ¬¡å®ä¾‹åŒ–fsméƒ½éœ€è¦é‡æ–°ä¼ é€’å¯¹åº”events(è™½ç„¶æˆ‘ä»¬å¯ä»¥ç»Ÿä¸€å°è£…)ï¼Œæˆ‘æ›´æœŸæœ›åœ¨é¡¹ç›®å¯åŠ¨æ—¶æŠŠæ­¤é¡¹ç›®æ¶‰åŠåˆ°ä¸åŒä¸šåŠ¡çŠ¶æ€æœºæµè½¬æ³¨å†Œåˆ°fsmï¼Œå¯¹åº”:ä¸åŒä¸šåŠ¡-&amp;gt;[çŠ¶æ€]-&amp;gt;[äº‹ä»¶]-&amp;gt;å¤„ç†äº‹ä»¶ä¸»ä½“(åŒ…å«handlerã€paramsã€hooksã€observersç­‰)ã€‚
å½“ä½ å¼€å§‹è¿›è¡ŒçŠ¶æ€æµè½¬æ—¶ï¼Œåªéœ€è¦
fsm:=NewFsm(&amp;#34;ä¸šåŠ¡åç§°&amp;#34;,&amp;#34;å½“å‰çŠ¶æ€&amp;#34;) currentState,err:=fsm.Call(&amp;#34;äº‹ä»¶åç§°&amp;#34;,&amp;#34;å¯¹åº”äº‹ä»¶æ‰€éœ€å‚æ•°å¯é€‰é¡¹&amp;#34;) ä¸ºä»€ä¹ˆéœ€è¦åŒºåˆ†ä¸šåŠ¡ï¼Ÿ
å› ä¸ºç»å¤§å¤šæ•°ä¸šåŠ¡çš„çŠ¶æ€å€¼éƒ½æ˜¯ä»æ•°æ®åº“ä¸­è·å–çš„ï¼Œæ¯”å¦‚è®¢å•è¡¨çš„è®¢å•çŠ¶æ€ï¼Œå•†å“è¡¨ä¸­çš„å•†å“çŠ¶æ€ï¼Œæœ‰å¯èƒ½å€¼æ˜¯ç›¸åŒçš„ã€‚
åŒä¸€ä¸ªä¸šåŠ¡åŒä¸€å±æ€§å¯¹åº”çŠ¶æ€å€¼è¡¨è¾¾å•ä¸€ï¼Œä¸åŒä¸šåŠ¡ä¸‹å±æ€§çŠ¶æ€å¯èƒ½ä¼šå‡ºç°å€¼ç›¸åŒï¼Œä½†æ‰€è¡¨è¾¾çš„å«ä¹‰æ˜¯ä¸åŒçš„ã€‚
æ•´ä½“è®¾è®¡:
ç®€å•è§£é‡Šä¸€ä¸‹ï¼š
 ä¸šåŠ¡:æ¯”å¦‚æœ‰å•†å“çŠ¶æ€ä¸šåŠ¡ã€è®¢å•çŠ¶æ€ä¸šåŠ¡&amp;hellip;.. çŠ¶æ€ï¼šè®¢å•å¾…ä»˜æ¬¾ã€å¾…å‘è´§&amp;hellip;. äº‹ä»¶ï¼šå¯¹åº”çŠ¶æ€ä»…å¯è¾¾äº‹ä»¶é›†åˆã€‚æ¯”å¦‚å¾…ä»˜æ¬¾çŠ¶æ€çš„å¯è¾¾äº‹ä»¶ä»…æœ‰:æ”¯ä»˜äº‹ä»¶å’Œå–æ¶ˆäº‹ä»¶(å–å†³äºè‡ªå·±çš„ä¸šåŠ¡) æ‰§è¡Œäº‹ä»¶ä¸»ä½“ï¼šæ‰§è¡Œè‡ªå®šä¹‰çš„äº‹ä»¶å‡½æ•°,å¦‚æœæœ‰éœ€è¦ï¼Œè¿˜å¯ä»¥è‡ªå®šä¹‰æ‰§è¡Œäº‹ä»¶å‰åhookï¼Œäº‹ä»¶è®¢é˜…è€…(æ¯”å¦‚æ”¯ä»˜äº‹ä»¶å‘ç”Ÿåï¼Œå¼‚æ­¥é€šçŸ¥ç”¨æˆ·ç­‰)  ä½¿ç”¨å§¿åŠ¿ go get -u github.com/wuqinqiang/easyfsm é¦–å…ˆè‡ªå®šä¹‰ä¸šåŠ¡ã€çŠ¶æ€ã€äº‹ä»¶ã€‚
package main import ( &amp;#34;fmt&amp;#34; &amp;#34;github.com/wuqinqiang/easyfsm&amp;#34; ) var ( // ä¸šåŠ¡ 	businessName easyfsm.BusinessName = &amp;#34;order&amp;#34; // å¯¹åº”çŠ¶æ€ 	initState easyfsm.State = 1 // åˆå§‹åŒ– 	paidState easyfsm.State = 2 // å·²ä»˜æ¬¾ 	canceled easyfsm.State = 3 // å·²å–æ¶ˆ  //å¯¹åº”äº‹ä»¶ 	paymentOrderEvent easyfsm.EventName = &amp;#34;paymentOrderEvent&amp;#34; cancelOrderEvent easyfsm.</description>
			<content type="html"><![CDATA[<h3 id="easyfsm">easyfsm</h3>
<p>ä¹‹å‰çœ‹è¿‡æ–°äº®è€å“¥çš„go-fsm-orderï¼Œæ„Ÿè§‰è¿˜ä¸é”™ã€‚æœ€è¿‘åœ¨è¿ç§»é¡¹ç›®çš„æ—¶å€™ï¼Œå‘ç°æœ‰å¤šå¤„ä¸šåŠ¡å­˜åœ¨ä¸€äº›çŠ¶æ€çš„æµè½¬ï¼Œæ‰€ä»¥å°±åŸºäºgo-fsm-orderåšäº†é‡æ”¹ï¼Œè®©å®ƒå¯ä»¥åœ¨ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ä¸‹ä½¿ç”¨ã€‚</p>
<p>ä¸ºä»€ä¹ˆä¸ä½¿ç”¨looplab/fsmï¼ŒstaræŒºå¤šçš„å•Šã€‚</p>
<p>ä¸æ˜¯ç‰¹åˆ«å–œæ¬¢ï¼Œæ¯æ¬¡å®ä¾‹åŒ–fsméƒ½éœ€è¦é‡æ–°ä¼ é€’å¯¹åº”events(è™½ç„¶æˆ‘ä»¬å¯ä»¥ç»Ÿä¸€å°è£…)ï¼Œæˆ‘æ›´æœŸæœ›åœ¨é¡¹ç›®å¯åŠ¨æ—¶æŠŠæ­¤é¡¹ç›®æ¶‰åŠåˆ°ä¸åŒä¸šåŠ¡çŠ¶æ€æœºæµè½¬æ³¨å†Œåˆ°fsmï¼Œå¯¹åº”:ä¸åŒä¸šåŠ¡-&gt;[çŠ¶æ€]-&gt;[äº‹ä»¶]-&gt;å¤„ç†äº‹ä»¶ä¸»ä½“(åŒ…å«handlerã€paramsã€hooksã€observersç­‰)ã€‚</p>
<p>å½“ä½ å¼€å§‹è¿›è¡ŒçŠ¶æ€æµè½¬æ—¶ï¼Œåªéœ€è¦</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">fsm</span><span class="o">:=</span><span class="nf">NewFsm</span><span class="p">(</span><span class="s">&#34;ä¸šåŠ¡åç§°&#34;</span><span class="p">,</span><span class="s">&#34;å½“å‰çŠ¶æ€&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">currentState</span><span class="p">,</span><span class="nx">err</span><span class="o">:=</span><span class="nx">fsm</span><span class="p">.</span><span class="nf">Call</span><span class="p">(</span><span class="s">&#34;äº‹ä»¶åç§°&#34;</span><span class="p">,</span><span class="s">&#34;å¯¹åº”äº‹ä»¶æ‰€éœ€å‚æ•°å¯é€‰é¡¹&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>ä¸ºä»€ä¹ˆéœ€è¦åŒºåˆ†ä¸šåŠ¡ï¼Ÿ</p>
<p>å› ä¸ºç»å¤§å¤šæ•°ä¸šåŠ¡çš„çŠ¶æ€å€¼éƒ½æ˜¯ä»æ•°æ®åº“ä¸­è·å–çš„ï¼Œæ¯”å¦‚è®¢å•è¡¨çš„è®¢å•çŠ¶æ€ï¼Œå•†å“è¡¨ä¸­çš„å•†å“çŠ¶æ€ï¼Œæœ‰å¯èƒ½å€¼æ˜¯ç›¸åŒçš„ã€‚</p>
<p>åŒä¸€ä¸ªä¸šåŠ¡åŒä¸€å±æ€§å¯¹åº”çŠ¶æ€å€¼è¡¨è¾¾å•ä¸€ï¼Œä¸åŒä¸šåŠ¡ä¸‹å±æ€§çŠ¶æ€å¯èƒ½ä¼šå‡ºç°å€¼ç›¸åŒï¼Œä½†æ‰€è¡¨è¾¾çš„å«ä¹‰æ˜¯ä¸åŒçš„ã€‚</p>
<p>æ•´ä½“è®¾è®¡:</p>
<p><img src="https://cdn.syst.top/easyfsm.png" alt="fsm"></p>
<p>ç®€å•è§£é‡Šä¸€ä¸‹ï¼š</p>
<ul>
<li>ä¸šåŠ¡:æ¯”å¦‚æœ‰å•†å“çŠ¶æ€ä¸šåŠ¡ã€è®¢å•çŠ¶æ€ä¸šåŠ¡&hellip;..</li>
<li>çŠ¶æ€ï¼šè®¢å•å¾…ä»˜æ¬¾ã€å¾…å‘è´§&hellip;.</li>
<li>äº‹ä»¶ï¼šå¯¹åº”çŠ¶æ€ä»…å¯è¾¾äº‹ä»¶é›†åˆã€‚æ¯”å¦‚å¾…ä»˜æ¬¾çŠ¶æ€çš„å¯è¾¾äº‹ä»¶ä»…æœ‰:æ”¯ä»˜äº‹ä»¶å’Œå–æ¶ˆäº‹ä»¶(å–å†³äºè‡ªå·±çš„ä¸šåŠ¡)</li>
<li>æ‰§è¡Œäº‹ä»¶ä¸»ä½“ï¼šæ‰§è¡Œè‡ªå®šä¹‰çš„äº‹ä»¶å‡½æ•°,å¦‚æœæœ‰éœ€è¦ï¼Œè¿˜å¯ä»¥è‡ªå®šä¹‰æ‰§è¡Œäº‹ä»¶å‰åhookï¼Œäº‹ä»¶è®¢é˜…è€…(æ¯”å¦‚æ”¯ä»˜äº‹ä»¶å‘ç”Ÿåï¼Œå¼‚æ­¥é€šçŸ¥ç”¨æˆ·ç­‰)</li>
</ul>
<h3 id="ä½¿ç”¨å§¿åŠ¿">ä½¿ç”¨å§¿åŠ¿</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">go</span> <span class="nx">get</span> <span class="o">-</span><span class="nx">u</span>  <span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">wuqinqiang</span><span class="o">/</span><span class="nx">easyfsm</span>
</span></span></code></pre></div><p>é¦–å…ˆè‡ªå®šä¹‰ä¸šåŠ¡ã€çŠ¶æ€ã€äº‹ä»¶ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/wuqinqiang/easyfsm&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ä¸šåŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">businessName</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nx">BusinessName</span> <span class="p">=</span> <span class="s">&#34;order&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// å¯¹åº”çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">initState</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nx">State</span> <span class="p">=</span> <span class="mi">1</span> <span class="c1">// åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">paidState</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nx">State</span> <span class="p">=</span> <span class="mi">2</span> <span class="c1">// å·²ä»˜æ¬¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">canceled</span>  <span class="nx">easyfsm</span><span class="p">.</span><span class="nx">State</span> <span class="p">=</span> <span class="mi">3</span> <span class="c1">// å·²å–æ¶ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">//å¯¹åº”äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">paymentOrderEvent</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nx">EventName</span> <span class="p">=</span> <span class="s">&#34;paymentOrderEvent&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cancelOrderEvent</span>  <span class="nx">easyfsm</span><span class="p">.</span><span class="nx">EventName</span> <span class="p">=</span> <span class="s">&#34;cancelOrderEvent&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><p>è‡ªå®šä¹‰äº‹ä»¶ä¸»ä½“ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// è®¢å•ä¸šåŠ¡æ‰€éœ€å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">orderParam</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">OrderNo</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">// æ”¯ä»˜è®¢å•äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">entity</span> <span class="o">:=</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nf">NewEventEntity</span><span class="p">(</span><span class="nx">paymentOrderEvent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="kd">func</span><span class="p">(</span><span class="nx">opt</span> <span class="o">*</span><span class="nx">easyfsm</span><span class="p">.</span><span class="nx">Param</span><span class="p">)</span> <span class="p">(</span><span class="nx">easyfsm</span><span class="p">.</span><span class="nx">State</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">param</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">Data</span><span class="p">.(</span><span class="nx">orderParam</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;param err&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;param:%+v\n&#34;</span><span class="p">,</span> <span class="nx">param</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// å¤„ç†æ ¸å¿ƒä¸šåŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">return</span> <span class="nx">paidState</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// å–æ¶ˆè®¢å•äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">cancelEntity</span> <span class="o">:=</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nf">NewEventEntity</span><span class="p">(</span><span class="nx">cancelOrderEvent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="kd">func</span><span class="p">(</span><span class="nx">opt</span> <span class="o">*</span><span class="nx">easyfsm</span><span class="p">.</span><span class="nx">Param</span><span class="p">)</span> <span class="p">(</span><span class="nx">easyfsm</span><span class="p">.</span><span class="nx">State</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// å¤„ç†æ ¸å¿ƒä¸šåŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">param</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">Data</span><span class="p">.(</span><span class="nx">orderParam</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;param err&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;param:%+v\n&#34;</span><span class="p">,</span> <span class="nx">param</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">canceled</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span></code></pre></div><p>æ³¨å†Œåˆ°easyfsmã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">	<span class="c1">// æ³¨å†Œåˆ°fsm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">easyfsm</span><span class="p">.</span><span class="nf">RegisterStateMachine</span><span class="p">(</span><span class="nx">businessName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">initState</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">entity</span><span class="p">,</span> <span class="nx">cancelEntity</span><span class="p">)</span>
</span></span></code></pre></div><p>å¼€å§‹ä½¿ç”¨ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">  <span class="c1">// æ­£å¸¸æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ç¬¬ä¸€æ­¥æ ¹æ®ä¸šåŠ¡ï¼Œä»¥åŠå½“å‰çŠ¶æ€ç”Ÿæˆfsm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">fsm</span> <span class="o">:=</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nf">NewFSM</span><span class="p">(</span><span class="nx">businessName</span><span class="p">,</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nf">State</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// ç¬¬äºŒæ­¥ è°ƒç”¨å…·ä½“äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">currentState</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">fsm</span><span class="p">.</span><span class="nf">Call</span><span class="p">(</span><span class="nx">cancelOrderEvent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">easyfsm</span><span class="p">.</span><span class="nf">WithData</span><span class="p">(</span><span class="nx">orderParam</span><span class="p">{</span><span class="nx">OrderNo</span><span class="p">:</span> <span class="s">&#34;wuqinqiang050@gmail.com&#34;</span><span class="p">}))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;[Success]call cancelOrderEvent err:%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;[Success]call cancelOrderEvent state:%v\n&#34;</span><span class="p">,</span> <span class="nx">currentState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="c1">// ç»“æŸ
</span></span></span></code></pre></div><p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/wuqinqiang/easyfsm&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ä¸šåŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">businessName</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nx">BusinessName</span> <span class="p">=</span> <span class="s">&#34;order&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// å¯¹åº”çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">initState</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nx">State</span> <span class="p">=</span> <span class="mi">1</span> <span class="c1">// åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">paidState</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nx">State</span> <span class="p">=</span> <span class="mi">2</span> <span class="c1">// å·²ä»˜æ¬¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">canceled</span>  <span class="nx">easyfsm</span><span class="p">.</span><span class="nx">State</span> <span class="p">=</span> <span class="mi">3</span> <span class="c1">// å·²å–æ¶ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">//å¯¹åº”äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">paymentOrderEventName</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nx">EventName</span> <span class="p">=</span> <span class="s">&#34;paymentOrderEventName&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cancelOrderEventName</span>  <span class="nx">easyfsm</span><span class="p">.</span><span class="nx">EventName</span> <span class="p">=</span> <span class="s">&#34;cancelOrderEventName&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">orderParam</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">OrderNo</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// æ”¯ä»˜è®¢å•äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">entity</span> <span class="o">:=</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nf">NewEventEntity</span><span class="p">(</span><span class="nx">paymentOrderEventName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="kd">func</span><span class="p">(</span><span class="nx">opt</span> <span class="o">*</span><span class="nx">easyfsm</span><span class="p">.</span><span class="nx">Param</span><span class="p">)</span> <span class="p">(</span><span class="nx">easyfsm</span><span class="p">.</span><span class="nx">State</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">param</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">Data</span><span class="p">.(</span><span class="nx">orderParam</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;param err&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;param:%+v\n&#34;</span><span class="p">,</span> <span class="nx">param</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// å¤„ç†æ ¸å¿ƒä¸šåŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">return</span> <span class="nx">paidState</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// å–æ¶ˆè®¢å•äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">cancelEntity</span> <span class="o">:=</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nf">NewEventEntity</span><span class="p">(</span><span class="nx">cancelOrderEventName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="kd">func</span><span class="p">(</span><span class="nx">opt</span> <span class="o">*</span><span class="nx">easyfsm</span><span class="p">.</span><span class="nx">Param</span><span class="p">)</span> <span class="p">(</span><span class="nx">easyfsm</span><span class="p">.</span><span class="nx">State</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// å¤„ç†æ ¸å¿ƒä¸šåŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">param</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">Data</span><span class="p">.(</span><span class="nx">orderParam</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;param err&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;param:%+v\n&#34;</span><span class="p">,</span> <span class="nx">param</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">canceled</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// æ³¨å†Œè®¢å•çŠ¶æ€æœº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">easyfsm</span><span class="p">.</span><span class="nf">RegisterStateMachine</span><span class="p">(</span><span class="nx">businessName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">initState</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">entity</span><span class="p">,</span> <span class="nx">cancelEntity</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// æ­£å¸¸æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ç¬¬ä¸€æ­¥æ ¹æ®ä¸šåŠ¡ï¼Œä»¥åŠå½“å‰çŠ¶æ€ç”Ÿæˆfsm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">fsm</span> <span class="o">:=</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nf">NewFSM</span><span class="p">(</span><span class="nx">businessName</span><span class="p">,</span> <span class="nx">initState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// ç¬¬äºŒæ­¥ è°ƒç”¨å…·ä½“
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">currentState</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">fsm</span><span class="p">.</span><span class="nf">Call</span><span class="p">(</span><span class="nx">cancelOrderEventName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">easyfsm</span><span class="p">.</span><span class="nf">WithData</span><span class="p">(</span><span class="nx">orderParam</span><span class="p">{</span><span class="nx">OrderNo</span><span class="p">:</span> <span class="s">&#34;wuqinqiang050@gmail.com&#34;</span><span class="p">}))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;[Success]call cancelOrderEventName err:%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;[Success]call cancelOrderEventName state:%v\n&#34;</span><span class="p">,</span> <span class="nx">currentState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//å¼‚å¸¸æƒ…å†µ1ï¼Œæ²¡æœ‰å®šä¹‰goodsä¸šåŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">fsm</span> <span class="p">=</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nf">NewFSM</span><span class="p">(</span><span class="s">&#34;goods&#34;</span><span class="p">,</span> <span class="nx">paidState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">currentState</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">fsm</span><span class="p">.</span><span class="nf">Call</span><span class="p">(</span><span class="nx">cancelOrderEventName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">easyfsm</span><span class="p">.</span><span class="nf">WithData</span><span class="p">(</span><span class="nx">orderParam</span><span class="p">{</span><span class="nx">OrderNo</span><span class="p">:</span> <span class="s">&#34;wuqinqiang050@gmail.com&#34;</span><span class="p">}))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;[UnKnowBusiness]faild :%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;[UnKnowBusiness]faild state:%v\n&#34;</span><span class="p">,</span> <span class="nx">currentState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//å¼‚å¸¸æƒ…å†µ1,æ²¡æœ‰å®šä¹‰çŠ¶æ€:2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">fsm</span> <span class="p">=</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nf">NewFSM</span><span class="p">(</span><span class="nx">businessName</span><span class="p">,</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nf">State</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">currentState</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">fsm</span><span class="p">.</span><span class="nf">Call</span><span class="p">(</span><span class="nx">cancelOrderEventName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">easyfsm</span><span class="p">.</span><span class="nf">WithData</span><span class="p">(</span><span class="nx">orderParam</span><span class="p">{</span><span class="nx">OrderNo</span><span class="p">:</span> <span class="s">&#34;wuqinqiang050@gmail.com&#34;</span><span class="p">}))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;[UnKnowState]faild :%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;[UnKnowState]faild state:%v\n&#34;</span><span class="p">,</span> <span class="nx">currentState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//å¼‚å¸¸æƒ…å†µ2:æ²¡æœ‰å®šä¹‰çŠ¶æ€1å¯¹åº”çš„å‘è´§äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">fsm</span> <span class="p">=</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nf">NewFSM</span><span class="p">(</span><span class="nx">businessName</span><span class="p">,</span> <span class="nx">initState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">currentState</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">fsm</span><span class="p">.</span><span class="nf">Call</span><span class="p">(</span><span class="s">&#34;shippingEvent&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">easyfsm</span><span class="p">.</span><span class="nf">WithData</span><span class="p">(</span><span class="nx">orderParam</span><span class="p">{</span><span class="nx">OrderNo</span><span class="p">:</span> <span class="s">&#34;wuqinqiang050@gmail.com&#34;</span><span class="p">}))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;[UnKnowEvent]faild :%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;[UnKnowEvent]faild state:%v\n&#34;</span><span class="p">,</span> <span class="nx">currentState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="hook">Hook</h3>
<p>å¦‚æœæƒ³åœ¨å¤„ç†äº‹ä»¶å‡½æ•°çš„å‰åæ‰§è¡Œä¸€äº›hookï¼Œæˆ–è€…åœ¨äº‹ä»¶æ‰§è¡Œå®Œæ¯•ï¼Œå¼‚æ­¥æ‰§è¡Œä¸€äº›å…¶ä»–ä¸šåŠ¡ï¼Œeasyfsmå®šä¹‰äº†è¿™ä¸¤ä¸ªæ¥å£ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">EventObserver</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">Receive</span><span class="p">(</span><span class="nx">opt</span> <span class="o">*</span><span class="nx">Param</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">EventHook</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">Before</span><span class="p">(</span><span class="nx">opt</span> <span class="o">*</span><span class="nx">Param</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nf">After</span><span class="p">(</span><span class="nx">opt</span> <span class="nx">Param</span><span class="p">,</span> <span class="nx">state</span> <span class="nx">State</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><p>æˆ‘ä»¬å¯ä»¥å®ç°è¿™ä¸¤ä¸ªæ¥å£ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">NotifyExample</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">HookExample</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="nx">HookExample</span><span class="p">)</span> <span class="nf">Before</span><span class="p">(</span><span class="nx">opt</span> <span class="o">*</span><span class="nx">easyfsm</span><span class="p">.</span><span class="nx">Param</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nb">println</span><span class="p">(</span><span class="s">&#34;äº‹ä»¶æ‰§è¡Œå‰&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="nx">HookExample</span><span class="p">)</span> <span class="nf">After</span><span class="p">(</span><span class="nx">opt</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nx">Param</span><span class="p">,</span> <span class="nx">state</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nx">State</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nb">println</span><span class="p">(</span><span class="s">&#34;äº‹ä»¶æ‰§è¡Œå&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">o</span> <span class="nx">NotifyExample</span><span class="p">)</span> <span class="nf">Receive</span><span class="p">(</span><span class="nx">opt</span> <span class="o">*</span><span class="nx">easyfsm</span><span class="p">.</span><span class="nx">Param</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nb">println</span><span class="p">(</span><span class="s">&#34;æ¥æ”¶åˆ°äº‹ä»¶å˜åŠ¨,å‘é€æ¶ˆæ¯&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å®Œæ•´ä»£ç ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/wuqinqiang/easyfsm&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ä¸šåŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">businessName</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nx">BusinessName</span> <span class="p">=</span> <span class="s">&#34;order&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// å¯¹åº”çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">initState</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nx">State</span> <span class="p">=</span> <span class="mi">1</span> <span class="c1">// åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">paidState</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nx">State</span> <span class="p">=</span> <span class="mi">2</span> <span class="c1">// å·²ä»˜æ¬¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">canceled</span>  <span class="nx">easyfsm</span><span class="p">.</span><span class="nx">State</span> <span class="p">=</span> <span class="mi">3</span> <span class="c1">// å·²å–æ¶ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">//å¯¹åº”äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">paymentOrderEventName</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nx">EventName</span> <span class="p">=</span> <span class="s">&#34;paymentOrderEventName&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cancelOrderEventName</span>  <span class="nx">easyfsm</span><span class="p">.</span><span class="nx">EventName</span> <span class="p">=</span> <span class="s">&#34;cancelOrderEventName&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">orderParam</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">OrderNo</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nx">EventObserver</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">NotifyExample</span><span class="p">)(</span><span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nx">EventHook</span>     <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">HookExample</span><span class="p">)(</span><span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">NotifyExample</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">HookExample</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="nx">HookExample</span><span class="p">)</span> <span class="nf">Before</span><span class="p">(</span><span class="nx">opt</span> <span class="o">*</span><span class="nx">easyfsm</span><span class="p">.</span><span class="nx">Param</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nb">println</span><span class="p">(</span><span class="s">&#34;äº‹ä»¶æ‰§è¡Œå‰&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="nx">HookExample</span><span class="p">)</span> <span class="nf">After</span><span class="p">(</span><span class="nx">opt</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nx">Param</span><span class="p">,</span> <span class="nx">state</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nx">State</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nb">println</span><span class="p">(</span><span class="s">&#34;äº‹ä»¶æ‰§è¡Œå&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">o</span> <span class="nx">NotifyExample</span><span class="p">)</span> <span class="nf">Receive</span><span class="p">(</span><span class="nx">opt</span> <span class="o">*</span><span class="nx">easyfsm</span><span class="p">.</span><span class="nx">Param</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nb">println</span><span class="p">(</span><span class="s">&#34;æ¥æ”¶åˆ°äº‹ä»¶å˜åŠ¨,å‘é€æ¶ˆæ¯&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// æ”¯ä»˜è®¢å•äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">entity</span> <span class="o">:=</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nf">NewEventEntity</span><span class="p">(</span><span class="nx">paymentOrderEventName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="kd">func</span><span class="p">(</span><span class="nx">opt</span> <span class="o">*</span><span class="nx">easyfsm</span><span class="p">.</span><span class="nx">Param</span><span class="p">)</span> <span class="p">(</span><span class="nx">easyfsm</span><span class="p">.</span><span class="nx">State</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">param</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">Data</span><span class="p">.(</span><span class="nx">orderParam</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;param err&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;param:%+v\n&#34;</span><span class="p">,</span> <span class="nx">param</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// å¤„ç†æ ¸å¿ƒä¸šåŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">return</span> <span class="nx">paidState</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nf">WithHook</span><span class="p">(</span><span class="nx">HookExample</span><span class="p">{}),</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nf">WithObservers</span><span class="p">(</span><span class="nx">NotifyExample</span><span class="p">{}))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// å–æ¶ˆè®¢å•äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">cancelEntity</span> <span class="o">:=</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nf">NewEventEntity</span><span class="p">(</span><span class="nx">cancelOrderEventName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="kd">func</span><span class="p">(</span><span class="nx">opt</span> <span class="o">*</span><span class="nx">easyfsm</span><span class="p">.</span><span class="nx">Param</span><span class="p">)</span> <span class="p">(</span><span class="nx">easyfsm</span><span class="p">.</span><span class="nx">State</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// å¤„ç†æ ¸å¿ƒä¸šåŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">param</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">Data</span><span class="p">.(</span><span class="nx">orderParam</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;param err&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;param:%+v\n&#34;</span><span class="p">,</span> <span class="nx">param</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">canceled</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nf">WithHook</span><span class="p">(</span><span class="nx">HookExample</span><span class="p">{}))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// æ³¨å†Œè®¢å•çŠ¶æ€æœº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">easyfsm</span><span class="p">.</span><span class="nf">RegisterStateMachine</span><span class="p">(</span><span class="nx">businessName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">initState</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">entity</span><span class="p">,</span> <span class="nx">cancelEntity</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// æ­£å¸¸æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ç¬¬ä¸€æ­¥æ ¹æ®ä¸šåŠ¡ï¼Œä»¥åŠå½“å‰çŠ¶æ€ç”Ÿæˆfsm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">fsm</span> <span class="o">:=</span> <span class="nx">easyfsm</span><span class="p">.</span><span class="nf">NewFSM</span><span class="p">(</span><span class="nx">businessName</span><span class="p">,</span> <span class="nx">initState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// ç¬¬äºŒæ­¥ è°ƒç”¨å…·ä½“
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">currentState</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">fsm</span><span class="p">.</span><span class="nf">Call</span><span class="p">(</span><span class="nx">paymentOrderEventName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">easyfsm</span><span class="p">.</span><span class="nf">WithData</span><span class="p">(</span><span class="nx">orderParam</span><span class="p">{</span><span class="nx">OrderNo</span><span class="p">:</span> <span class="s">&#34;wuqinqiang050@gmail.com&#34;</span><span class="p">}))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;[Success]call paymentOrderEventName err:%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;[Success]call paymentOrderEventName state:%v\n&#34;</span><span class="p">,</span> <span class="nx">currentState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="ç»“æŸ">ç»“æŸ</h3>
<p>å¦‚æœæœ‰å…¶ä»–ä¸ä¸€æ ·çš„éœ€æ±‚ï¼Œæ¬¢è¿å¤§å®¶åœ¨issueç•™è¨€ã€‚</p>
<p>GitHub:<a href="https://github.com/wuqinqiang/easyfsm">easyfsm</a></p>
]]></content>
		</item>
		
		<item>
			<title>ä½ è¿˜ä¸ä½“éªŒæ³›å‹å—</title>
			<link>https://www.syst.top/posts/go/generics/</link>
			<pubDate>Sun, 02 Jan 2022 18:32:00 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/generics/</guid>
			<description>ä»‹ç» ä¹‹å‰æœ‰çœ‹è¿‡å®˜æ–¹å‘å¸ƒçš„ä¸€äº›æ³›å‹æ–‡ç« ï¼Œä½†æ˜¯è‡ªå·±æ²¡åŠ¨æ‰‹ç©è¿‡ã€‚è¿˜æœ‰æ²¡æœ‰æ²¡ç©è¿‡çš„ï¼Œé‚£ä¹ˆæœ€åä¸€ç­è½¦äº†ã€‚
ä¸ç®¡å­¦ä»€ä¹ˆå…¥é—¨å…ˆä»å®˜ç½‘æ‹¿ä¾‹å­ã€‚
è¿™æ®µä»£ç å¾ˆç®€å•ï¼Œå®šä¹‰ä¸¤ä¸ªå‡½æ•°ï¼Œè®¡ç®—å¯¹åº”ä¼ å…¥çš„mapå€¼çš„å’Œã€‚ä¸¤ä¸ªå‡½æ•°æœ€å¤§çš„ä¸åŒåœ¨äºå‡½æ•°å‚æ•°ç±»å‹æœ‰æ‰€ä¸åŒï¼Œä¸€ä¸ªmapçš„å€¼ç±»å‹ä¸ºint64,ä¸€ä¸ªä¸ºfloat64ï¼Œå¯¹åº”è¿”å›å‚æ•°ä¹Ÿæœ‰æ‰€ä¸åŒã€‚
åœ¨æ²¡æœ‰æ³›å‹çš„æƒ…å†µä¸‹ï¼Œæ¯ç§ç±»å‹éƒ½ä¸å¾—ä¸é‡æ–°å®šä¹‰ä¸€ä¸ªå‡½æ•°ã€‚
æœ‰äººå¯èƒ½ä¼šè¯´ï¼Œä¸Šé¢çš„ä»£ç ä½ å¯ä»¥è¿™æ ·å†™åœ¨ä¸€ä¸ªå‡½æ•°é‡Œï¼Œ
ä½ ç¡®è®¤è¿™çœŸçš„å¥½å—ï¼Ÿ
æ³›å‹å‡½æ•° ä½†æ˜¯ï¼Œæœ‰äº†æ³›å‹ä¹‹åï¼Œé‚£å°±ç®€å•å¤šäº†ã€‚
ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œ
å®šä¹‰äº†ä¸€ä¸ªæ–°å‡½æ•°SumIntsOrFloatsï¼Œè¯¥å‡½æ•°å£°æ˜ä¸¤ä¸ªç±»å‹å‚æ•° [K comparable, V int64 | float64]ã€‚å…¶ä¸­KæŒ‡å®šäº†ç±»å‹å¿…é¡»ä¸ºå¯æ¯”è¾ƒ(å³å¯ä»¥ç”¨ä½œæ¯”è¾ƒç¬¦ == å’Œ !=)ã€‚å› ä¸º goä¸­è§„å®šmapçš„keyå¿…é¡»æ˜¯å¯æ¯”è¾ƒç±»å‹ã€‚
æ¯”å¦‚ï¼Œæˆ‘ä»¬ä¸èƒ½è¿™æ ·å£°æ˜ä¸€ä¸ªmapã€‚
æ‰€ä»¥è¿™é‡Œçš„Kå°±ä¸èƒ½ä½¿ç”¨anyå…³é”®å­—ã€‚
å¦ä¸€ä¸ªVå‚æ•°æŒ‡å®šäº†ä¸€ä¸ªçº¦æŸï¼Œè¯¥çº¦æŸç”±int64å’Œfloat64ç»„æˆï¼Œä½¿ç”¨ | æŒ‡å®šäº†è”åˆç±»å‹ã€‚
æ‰€ä»¥è¿™é‡Œmå‚æ•°ä¸ºmap[K]Vç±»å‹ï¼ŒK,Vå³ä¸ºå‚æ•°ç±»å‹æŒ‡å®šçš„ç±»å‹ã€‚
é‚£ä¹ˆï¼Œå¦‚æœä½ ä¼ å…¥çš„mapå€¼çš„ç±»å‹ä¸ºå…¶ä»–ç±»å‹ã€‚æ¯”å¦‚ä¸‹é¢è¿™ç§å°±ä¸è¡Œäº†ã€‚
ç±»å‹çº¦æŸ ä¸Šé¢çœ‹åˆ°çš„æ˜¯æˆ‘ä»¬åœ¨æ–¹æ³•ä¸Šå¯¹å‚æ•°åšä¸€äº›çº¦æŸã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥å£°æ˜ç±»å‹çº¦æŸã€‚
ä¸Šé¢çš„ä»£ç å£°æ˜äº†ä¸€ä¸ªNumberç”¨åšç±»å‹çº¦æŸçš„æ¥å£ç±»å‹ã€‚åœ¨æ¥å£é‡Œå£°æ˜int64å’Œfloat64è”åˆç±»å‹ã€‚
åœ¨SumNumbersä¸­å¦‚æœçº¦æŸç±»å‹ä¸ºint64æˆ–è€… float64ï¼Œé‚£ä¹ˆåªéœ€è¦ä½¿ç”¨Numberç±»å‹çº¦æŸå³å¯ï¼Œå°±ä¸ç”¨æ¯ä¸ªä¸åŒå‡½æ•°å†™ int64 | float64ï¼Œè¾¾åˆ°ä»£ç å¤ç”¨çš„æ•ˆæœã€‚
ä½†æ˜¯å¦‚æœæˆ‘è¿™æ ·ï¼Œ
æˆ‘ä»¬æŠŠmapä¸­çš„å€¼ç±»å‹è°ƒæ•´ä¸ºè‡ªå®šä¹‰çš„otherInt64ç±»å‹ï¼ŒotherInt64çš„åŸºç¡€ç±»å‹ä¹Ÿæ˜¯int64ã€‚ä½†æ˜¯ï¼Œè¿™æ®µä»£ç ç¼–è¯‘ä¼šæŠ¥é”™ã€‚
åŸå› æ˜¯ int64 çº¦æŸä¼šå°†å…¶é™åˆ¶ä¸ºåªèƒ½æ˜¯è¯¥ç±»å‹ï¼Œä¹Ÿå°±æ˜¯åªèƒ½æ˜¯ int64ï¼Œä¸èƒ½æ˜¯åŸºäºæ­¤ç±»å‹å®šä¹‰çš„å…¶ä»–ç±»å‹ã€‚
å¦‚æœæƒ³ä½¿ç”¨otherInt64å’‹ä¹ˆåŠï¼Œå¾ˆç®€å•ï¼Œåªéœ€è¦ä¸€ä¸ªï½ç¬¦å·ï¼Œ
ä½¿ç”¨å¸¦ï½xxtypeä¼šå°†å…¶é™åˆ¶ä¸ºåŸºç¡€ç±»å‹ä¸ºxxtypeçš„æ‰€æœ‰ç±»å‹ã€‚
åº”ç”¨ ä¸Šé¢åªæ˜¯ç®€å•ä»‹ç»äº†ä¸€ä¸‹ä½¿ç”¨å§¿åŠ¿ï¼Œé‚£ä¹ˆå“ªäº›åœºæ™¯ä¸‹å¯ä»¥ä½¿ç”¨æ³›å‹å‘¢ï¼Ÿ
æ¯”å¦‚æ—¥å¸¸å¼€å‘ä¸­ï¼Œåƒsliceã€mapã€channelçš„ä¸€äº›å¤„ç†å‡½æ•°ï¼Œå¯èƒ½é€»è¾‘ç›¸åŒä½†æ˜¯ç±»å‹ä¸åŒå¯¼è‡´copyå¤šä¸ªä¸åŒå‡½æ•°ï¼Œè¿™æ—¶å€™å¯ä»¥ç”¨æ³›å‹è§£å†³ã€‚æ¯”å¦‚ï¼Œ
è¿˜æœ‰ä¸€äº›è¡Œä¸ºæ–¹é¢çš„ã€‚æ¯”å¦‚ go ä¸­çš„æ’åºï¼Œé€šè¿‡æ³›å‹ï¼Œä¸éœ€è¦æ¯ä¸€ä¸ªç»“æ„éƒ½å®ç°(Lenï¼ŒLessï¼ŒSwap)ä¸‰ä¸ªæ–¹æ³•ï¼Œè€Œæ˜¯æŠ½è±¡å‡ºä¾èµ–äºä¸‰ä¸ªæ–¹æ³•çš„è¡Œä¸ºã€‚é‚£ä¹ˆæƒ³è¦å®ç°æ’åºåªéœ€è¦ä¾èµ–å®šä¹‰çš„è¿™ä¸ªæŠ½è±¡å°±è¡Œäº†ã€‚
å…¶ä»–æ–¹é¢çš„åº”ç”¨å¯ä»¥è‡ªè¡Œä½“éªŒã€‚
æ€»ç»“ è¿™ç¯‡æ–‡ç« ä¸»è¦å¸¦ä½ ä»¬ä½“éªŒä¸‹æ³›å‹çš„åŸºæœ¬ä½¿ç”¨ï¼Œä»¥åŠå¯¹åº”çš„ç±»å‹çº¦æŸï¼Œæœ€åè¿˜ç®€å•å®éªŒäº†ä¸¤ä¸ªæ³›å‹çš„åœºæ™¯demoï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡Œä½“éªŒã€‚æ›´å¤šå†…å®¹ï¼Œæ¬¢è¿ç•™è¨€åŒºåŸŸäº¤æµã€‚
é™„å½•  https://go.dev/doc/tutorial/generics https://teivah.medium.com/when-to-use-generics-in-go-36d49c1aeda https://github.com/mattn/go-generics-example  </description>
			<content type="html"><![CDATA[<h3 id="ä»‹ç»">ä»‹ç»</h3>
<p>ä¹‹å‰æœ‰çœ‹è¿‡å®˜æ–¹å‘å¸ƒçš„ä¸€äº›æ³›å‹æ–‡ç« ï¼Œä½†æ˜¯è‡ªå·±æ²¡åŠ¨æ‰‹ç©è¿‡ã€‚è¿˜æœ‰æ²¡æœ‰æ²¡ç©è¿‡çš„ï¼Œé‚£ä¹ˆæœ€åä¸€ç­è½¦äº†ã€‚</p>
<p>ä¸ç®¡å­¦ä»€ä¹ˆå…¥é—¨å…ˆä»å®˜ç½‘æ‹¿ä¾‹å­ã€‚</p>
<p><img src="https://cdn.syst.top/1.png" alt="image-20220102185612332"></p>
<p>è¿™æ®µä»£ç å¾ˆç®€å•ï¼Œå®šä¹‰ä¸¤ä¸ªå‡½æ•°ï¼Œè®¡ç®—å¯¹åº”ä¼ å…¥çš„mapå€¼çš„å’Œã€‚ä¸¤ä¸ªå‡½æ•°æœ€å¤§çš„ä¸åŒåœ¨äºå‡½æ•°å‚æ•°ç±»å‹æœ‰æ‰€ä¸åŒï¼Œä¸€ä¸ªmapçš„å€¼ç±»å‹ä¸ºint64,ä¸€ä¸ªä¸ºfloat64ï¼Œå¯¹åº”è¿”å›å‚æ•°ä¹Ÿæœ‰æ‰€ä¸åŒã€‚</p>
<p>åœ¨æ²¡æœ‰æ³›å‹çš„æƒ…å†µä¸‹ï¼Œæ¯ç§ç±»å‹éƒ½ä¸å¾—ä¸é‡æ–°å®šä¹‰ä¸€ä¸ªå‡½æ•°ã€‚</p>
<p>æœ‰äººå¯èƒ½ä¼šè¯´ï¼Œä¸Šé¢çš„ä»£ç ä½ å¯ä»¥è¿™æ ·å†™åœ¨ä¸€ä¸ªå‡½æ•°é‡Œï¼Œ</p>
<p><img src="https://cdn.syst.top/2.png" alt="image-20220102190814109"></p>
<p>ä½ ç¡®è®¤è¿™çœŸçš„å¥½å—ï¼Ÿ</p>
<h3 id="æ³›å‹å‡½æ•°">æ³›å‹å‡½æ•°</h3>
<p>ä½†æ˜¯ï¼Œæœ‰äº†æ³›å‹ä¹‹åï¼Œé‚£å°±ç®€å•å¤šäº†ã€‚</p>
<p><img src="https://cdn.syst.top/2-2.png" alt="image-20220102191445161"></p>
<p>ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œ</p>
<p>å®šä¹‰äº†ä¸€ä¸ªæ–°å‡½æ•°SumIntsOrFloatsï¼Œè¯¥å‡½æ•°å£°æ˜ä¸¤ä¸ªç±»å‹å‚æ•° [K comparable, V int64 | float64]ã€‚å…¶ä¸­KæŒ‡å®šäº†ç±»å‹å¿…é¡»ä¸ºå¯æ¯”è¾ƒ(å³å¯ä»¥ç”¨ä½œæ¯”è¾ƒç¬¦ == å’Œ !=)ã€‚å› ä¸º goä¸­è§„å®šmapçš„keyå¿…é¡»æ˜¯å¯æ¯”è¾ƒç±»å‹ã€‚</p>
<p>æ¯”å¦‚ï¼Œæˆ‘ä»¬ä¸èƒ½è¿™æ ·å£°æ˜ä¸€ä¸ªmapã€‚</p>
<p><img src="https://cdn.syst.top/3.png" alt="image-20220102200928248"></p>
<p>æ‰€ä»¥è¿™é‡Œçš„Kå°±ä¸èƒ½ä½¿ç”¨anyå…³é”®å­—ã€‚</p>
<p>å¦ä¸€ä¸ªVå‚æ•°æŒ‡å®šäº†ä¸€ä¸ªçº¦æŸï¼Œè¯¥çº¦æŸç”±int64å’Œfloat64ç»„æˆï¼Œä½¿ç”¨ | æŒ‡å®šäº†è”åˆç±»å‹ã€‚</p>
<p>æ‰€ä»¥è¿™é‡Œmå‚æ•°ä¸ºmap[K]Vç±»å‹ï¼ŒK,Vå³ä¸ºå‚æ•°ç±»å‹æŒ‡å®šçš„ç±»å‹ã€‚</p>
<p>é‚£ä¹ˆï¼Œå¦‚æœä½ ä¼ å…¥çš„mapå€¼çš„ç±»å‹ä¸ºå…¶ä»–ç±»å‹ã€‚æ¯”å¦‚ä¸‹é¢è¿™ç§å°±ä¸è¡Œäº†ã€‚</p>
<p><img src="https://cdn.syst.top/4.png" alt="image-20220102194519848"></p>
<h3 id="ç±»å‹çº¦æŸ">ç±»å‹çº¦æŸ</h3>
<p>ä¸Šé¢çœ‹åˆ°çš„æ˜¯æˆ‘ä»¬åœ¨æ–¹æ³•ä¸Šå¯¹å‚æ•°åšä¸€äº›çº¦æŸã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥å£°æ˜ç±»å‹çº¦æŸã€‚</p>
<p><img src="https://cdn.syst.top/4-4.png" alt="image-20220102202446122"></p>
<p>ä¸Šé¢çš„ä»£ç å£°æ˜äº†ä¸€ä¸ªNumberç”¨åšç±»å‹çº¦æŸçš„æ¥å£ç±»å‹ã€‚åœ¨æ¥å£é‡Œå£°æ˜int64å’Œfloat64è”åˆç±»å‹ã€‚</p>
<p>åœ¨SumNumbersä¸­å¦‚æœçº¦æŸç±»å‹ä¸ºint64æˆ–è€… float64ï¼Œé‚£ä¹ˆåªéœ€è¦ä½¿ç”¨Numberç±»å‹çº¦æŸå³å¯ï¼Œå°±ä¸ç”¨æ¯ä¸ªä¸åŒå‡½æ•°å†™ int64 | float64ï¼Œè¾¾åˆ°ä»£ç å¤ç”¨çš„æ•ˆæœã€‚</p>
<p>ä½†æ˜¯å¦‚æœæˆ‘è¿™æ ·ï¼Œ</p>
<p><img src="https://cdn.syst.top/5.png" alt="image-20220102203657206"></p>
<p>æˆ‘ä»¬æŠŠmapä¸­çš„å€¼ç±»å‹è°ƒæ•´ä¸ºè‡ªå®šä¹‰çš„otherInt64ç±»å‹ï¼ŒotherInt64çš„åŸºç¡€ç±»å‹ä¹Ÿæ˜¯int64ã€‚ä½†æ˜¯ï¼Œè¿™æ®µä»£ç ç¼–è¯‘ä¼šæŠ¥é”™ã€‚</p>
<p>åŸå› æ˜¯ int64 çº¦æŸä¼šå°†å…¶é™åˆ¶ä¸ºåªèƒ½æ˜¯è¯¥ç±»å‹ï¼Œä¹Ÿå°±æ˜¯åªèƒ½æ˜¯ int64ï¼Œä¸èƒ½æ˜¯åŸºäºæ­¤ç±»å‹å®šä¹‰çš„å…¶ä»–ç±»å‹ã€‚</p>
<p>å¦‚æœæƒ³ä½¿ç”¨otherInt64å’‹ä¹ˆåŠï¼Œå¾ˆç®€å•ï¼Œåªéœ€è¦ä¸€ä¸ªï½ç¬¦å·ï¼Œ</p>
<p><img src="https://cdn.syst.top/6.png" alt="image-20220102204212141"></p>
<p>ä½¿ç”¨å¸¦ï½xxtypeä¼šå°†å…¶é™åˆ¶ä¸ºåŸºç¡€ç±»å‹ä¸ºxxtypeçš„æ‰€æœ‰ç±»å‹ã€‚</p>
<h3 id="åº”ç”¨">åº”ç”¨</h3>
<p>ä¸Šé¢åªæ˜¯ç®€å•ä»‹ç»äº†ä¸€ä¸‹ä½¿ç”¨å§¿åŠ¿ï¼Œé‚£ä¹ˆå“ªäº›åœºæ™¯ä¸‹å¯ä»¥ä½¿ç”¨æ³›å‹å‘¢ï¼Ÿ</p>
<p>æ¯”å¦‚æ—¥å¸¸å¼€å‘ä¸­ï¼Œåƒsliceã€mapã€channelçš„ä¸€äº›å¤„ç†å‡½æ•°ï¼Œå¯èƒ½é€»è¾‘ç›¸åŒä½†æ˜¯ç±»å‹ä¸åŒå¯¼è‡´copyå¤šä¸ªä¸åŒå‡½æ•°ï¼Œè¿™æ—¶å€™å¯ä»¥ç”¨æ³›å‹è§£å†³ã€‚æ¯”å¦‚ï¼Œ</p>
<p><img src="https://cdn.syst.top/8.png" alt="image-20220102231043331"></p>
<p>è¿˜æœ‰ä¸€äº›è¡Œä¸ºæ–¹é¢çš„ã€‚æ¯”å¦‚ go ä¸­çš„æ’åºï¼Œé€šè¿‡æ³›å‹ï¼Œä¸éœ€è¦æ¯ä¸€ä¸ªç»“æ„éƒ½å®ç°(Lenï¼ŒLessï¼ŒSwap)ä¸‰ä¸ªæ–¹æ³•ï¼Œè€Œæ˜¯æŠ½è±¡å‡ºä¾èµ–äºä¸‰ä¸ªæ–¹æ³•çš„è¡Œä¸ºã€‚é‚£ä¹ˆæƒ³è¦å®ç°æ’åºåªéœ€è¦ä¾èµ–å®šä¹‰çš„è¿™ä¸ªæŠ½è±¡å°±è¡Œäº†ã€‚</p>
<p><img src="https://cdn.syst.top/7.png" alt="image-20220102225615043"></p>
<p>å…¶ä»–æ–¹é¢çš„åº”ç”¨å¯ä»¥è‡ªè¡Œä½“éªŒã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>è¿™ç¯‡æ–‡ç« ä¸»è¦å¸¦ä½ ä»¬ä½“éªŒä¸‹æ³›å‹çš„åŸºæœ¬ä½¿ç”¨ï¼Œä»¥åŠå¯¹åº”çš„ç±»å‹çº¦æŸï¼Œæœ€åè¿˜ç®€å•å®éªŒäº†ä¸¤ä¸ªæ³›å‹çš„åœºæ™¯demoï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡Œä½“éªŒã€‚æ›´å¤šå†…å®¹ï¼Œæ¬¢è¿ç•™è¨€åŒºåŸŸäº¤æµã€‚</p>
<h3 id="é™„å½•"><strong>é™„å½•</strong></h3>
<ul>
<li><a href="https://go.dev/doc/tutorial/generics">https://go.dev/doc/tutorial/generics</a></li>
<li><a href="https://teivah.medium.com/when-to-use-generics-in-go-36d49c1aeda">https://teivah.medium.com/when-to-use-generics-in-go-36d49c1aeda</a></li>
<li><a href="https://github.com/mattn/go-generics-example">https://github.com/mattn/go-generics-example</a></li>
</ul>
]]></content>
		</item>
		
		<item>
			<title>é‚£äº›ç”¨Goå®ç°çš„åˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶</title>
			<link>https://www.syst.top/posts/go/transaction/</link>
			<pubDate>Wed, 08 Dec 2021 22:25:52 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/transaction/</guid>
			<description>å¼€ç¯‡ ä¸çŸ¥ä¸è§‰ç«Ÿç„¶ä¸€ä¸ªæœˆæ²¡æ›´æ–°äº†ï¼Œäººä¸€æ—¦æ‡’ä¸‹æ¥åªä¼šè¶Šæ¥è¶Šæ‡’ã€‚
æœ€è¿‘å¯¹åˆ†å¸ƒå¼äº‹åŠ¡äº§ç”Ÿäº†ä¸€äº›å…´è¶£ï¼ŒæŸ¥é˜…äº†ä¸€äº›æ–‡ç« ä»¥åŠè®ºæ–‡ã€‚è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»æˆ‘çœ‹çš„ä¸¤ä¸ªé¡¹ç›®ï¼Œä¸æ¶‰åŠä¸€äº›ç†è®ºçŸ¥è¯†ã€‚
 é˜¿é‡Œå¼€æºç‰ˆæœ¬çš„Seataï¼Œä¸»è¦çœ‹äº†Goå®ç°çš„seata-golang(è½åjavaç‰ˆ) ä»¥åŠå‰æ®µæ—¶é—´å¾ˆå¤šå…¬ä¼—å·éƒ½å‘çš„dtmã€‚  Seataç®€ä»‹ Seataæ˜¯ç”±é˜¿é‡Œå¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ï¼Œç›®å‰ä¸ºç”¨æˆ·æä¾›äº†ATã€TCCã€SAGAã€XAçš„äº‹åŠ¡æ¨¡å¼ï¼Œæ•´ä½“é‡‡ç”¨çš„æ˜¯ä¸¤é˜¶æ®µæäº¤åè®®ã€‚Goç‰ˆçš„seata-golang ç›®å‰å¥½åƒåªå®ç°äº†mysqlçš„ATã€TCCæ¨¡å¼ï¼Œä½œè€…ç°åœ¨ä¸å’‹æ›´æ–°äº†ã€‚
Seata æœ‰å‡ ä¸ªæ ¸å¿ƒè§’è‰²ï¼š
 TC(Transaction Coordinator) -äº‹åŠ¡åè°ƒè€…ã€‚(ç»´æŠ¤å…¨å±€å’Œåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œé©±åŠ¨å…¨å±€äº‹åŠ¡æäº¤æˆ–å›æ»š) TM(Transaction Manager)-äº‹åŠ¡ç®¡ç†å™¨ã€‚(å®šä¹‰å…¨å±€äº‹åŠ¡çš„èŒƒå›´ï¼šå¼€å§‹å…¨å±€äº‹åŠ¡ã€æäº¤æˆ–å›æ»šå…¨å±€äº‹åŠ¡ã€‚) RM(Resource Manager)-èµ„æºç®¡ç†å™¨ã€‚(ç®¡ç†åˆ†æ”¯äº‹åŠ¡å¤„ç†çš„èµ„æºï¼Œä¸TCäº¤è°ˆä»¥æ³¨å†Œåˆ†æ”¯äº‹åŠ¡å’ŒæŠ¥å‘Šåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œå¹¶é©±åŠ¨åˆ†æ”¯äº‹åŠ¡æäº¤æˆ–å›æ»š)  å½“ç„¶è¿™æ ·çœ‹ï¼Œå¯èƒ½è¿˜ä¸æ˜¯å¾ˆç†è§£ï¼Œæˆ‘æ‹¿ä¸€å¼ å®˜ç½‘çš„å›¾åŠ ä»¥è§£é‡Šã€‚
ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸‰ä¸ªè§’è‰²æ‰€è´Ÿè´£çš„å·¥ä½œå¦‚ä¸‹ï¼Œ
TC
 ç»´æŠ¤å…¨å±€å’Œåˆ†æ”¯äº‹åŠ¡çŠ¶æ€ï¼Œéœ€è¦è¿›è¡Œå­˜å‚¨ã€‚ å½“ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†ç»“æŸï¼Œéœ€è¦é€šçŸ¥åˆ°æ¯ä¸ªRMæ˜¯commitè¿˜æ˜¯rollbackã€‚  TM
 å‘TCè¯·æ±‚å¼€å¯ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå¾—åˆ°ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„åˆ†å¸ƒå¼idã€‚ æ ¹æ®æ¯ä¸ªå‚ä¸åˆ†å¸ƒå¼äº‹åŠ¡çš„RMä¸€é˜¶æ®µçš„åé¦ˆï¼Œå†³å®šäºŒé˜¶æ®µå‘TCè¯·æ±‚æ­¤æ¬¡åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯commitè¿˜æ˜¯rollback(ç»å¤§éƒ¨åˆ†åœºæ™¯ä¸‹ï¼Œä¸€é˜¶æ®µä»»ä¸€RMå¤±è´¥ï¼Œæœ¬æ¬¡åˆ†å¸ƒå¼äº‹åŠ¡å¤±è´¥)  RM
è¯´çš„ç™½ä¸€ç‚¹å°±æ˜¯ç®¡ç†å‚ä¸åˆ†å¸ƒå¼äº‹åŠ¡çš„å„ä¸ªæœåŠ¡(æ¯”å¦‚ç»å…¸ä¸‹å•åœºæ™¯ä¸­æ¶‰åŠåˆ°çš„:è®¢å•æœåŠ¡ã€åº“å­˜æœåŠ¡ã€è¥é”€æœåŠ¡ç­‰)
ps:ä¸ªäººæ„Ÿè§‰ï¼Œè¿™é‡Œçš„RMæœ‰ç‚¹ç±»ä¼¼å¾®æœåŠ¡ä¸­çš„ä¸­é—´å¤„ç†å±‚(ä¸“ä¸šæœ¯è¯­ä»–ä»¬ç®¡è¿™å«bff-&amp;gt;backend for fronted)ã€‚
  ä¸€é˜¶æ®µ prepare è¡Œä¸º(ä¸»åŠ¨)ï¼šæ¯ä¸ªRMè°ƒç”¨ è‡ªå®šä¹‰ çš„ prepare é€»è¾‘ã€‚
  äºŒé˜¶æ®µ commit è¡Œä¸º(è¢«åŠ¨è§¦å‘)ï¼šå¦‚æœæœ¬æ¬¡åˆ†å¸ƒå¼äº‹åŠ¡ç¬¬ä¸€é˜¶æ®µå…¨éƒ¨RMæˆåŠŸï¼ŒTCå¤„ç†å®Œè‡ªèº«çŠ¶æ€å˜æ›´åï¼Œè°ƒç”¨å„ä¸ªRMè‡ªå®šä¹‰ çš„ commit é€»è¾‘ã€‚(ä¸€é˜¶æ®µRMå…¨éƒ¨æˆåŠŸ)
  äºŒé˜¶æ®µ rollback è¡Œä¸º(è¢«åŠ¨è§¦å‘)ï¼šå¦‚æœæœ¬æ¬¡åˆ†å¸ƒå¼äº‹åŠ¡ç¬¬ä¸€é˜¶æ®µä»»ä¸€RMå¤±è´¥ï¼ŒTCå¤„ç†å®Œè‡ªèº«çŠ¶æ€å˜æ›´åï¼Œè°ƒç”¨å„ä¸ªRMè‡ªå®šä¹‰ çš„ rollback é€»è¾‘ã€‚(ä¸€é˜¶æ®µä»»æ„RMå¤±è´¥)
  å¥½äº†ã€‚ä¸‹é¢å¯ä»¥çœ‹çœ‹seata-golang å®ç°çš„ä¸€äº›ç»†èŠ‚äº†ï¼Œseata-golang åº•å±‚é‡‡ç”¨gRPCè¿›è¡Œé€šä¿¡ã€‚
seata-golang æˆ‘ä»¬å…ˆçœ‹RMéƒ¨åˆ†ç»“æ„ã€‚</description>
			<content type="html"><![CDATA[<h3 id="å¼€ç¯‡">å¼€ç¯‡</h3>
<p>ä¸çŸ¥ä¸è§‰ç«Ÿç„¶ä¸€ä¸ªæœˆæ²¡æ›´æ–°äº†ï¼Œäººä¸€æ—¦æ‡’ä¸‹æ¥åªä¼šè¶Šæ¥è¶Šæ‡’ã€‚</p>
<p>æœ€è¿‘å¯¹åˆ†å¸ƒå¼äº‹åŠ¡äº§ç”Ÿäº†ä¸€äº›å…´è¶£ï¼ŒæŸ¥é˜…äº†ä¸€äº›æ–‡ç« ä»¥åŠè®ºæ–‡ã€‚è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»æˆ‘çœ‹çš„ä¸¤ä¸ªé¡¹ç›®ï¼Œä¸æ¶‰åŠä¸€äº›ç†è®ºçŸ¥è¯†ã€‚</p>
<ul>
<li>é˜¿é‡Œå¼€æºç‰ˆæœ¬çš„Seataï¼Œä¸»è¦çœ‹äº†Goå®ç°çš„seata-golang(è½åjavaç‰ˆ)</li>
<li>ä»¥åŠå‰æ®µæ—¶é—´å¾ˆå¤šå…¬ä¼—å·éƒ½å‘çš„dtmã€‚</li>
</ul>
<h3 id="seataç®€ä»‹">Seataç®€ä»‹</h3>
<p>Seataæ˜¯ç”±é˜¿é‡Œå¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ï¼Œç›®å‰ä¸ºç”¨æˆ·æä¾›äº†ATã€TCCã€SAGAã€XAçš„äº‹åŠ¡æ¨¡å¼ï¼Œæ•´ä½“é‡‡ç”¨çš„æ˜¯ä¸¤é˜¶æ®µæäº¤åè®®ã€‚Goç‰ˆçš„seata-golang ç›®å‰å¥½åƒåªå®ç°äº†mysqlçš„ATã€TCCæ¨¡å¼ï¼Œä½œè€…ç°åœ¨ä¸å’‹æ›´æ–°äº†ã€‚</p>
<p>Seata æœ‰å‡ ä¸ªæ ¸å¿ƒè§’è‰²ï¼š</p>
<ul>
<li>TC(Transaction Coordinator) -äº‹åŠ¡åè°ƒè€…ã€‚(ç»´æŠ¤å…¨å±€å’Œåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œé©±åŠ¨å…¨å±€äº‹åŠ¡æäº¤æˆ–å›æ»š)</li>
<li>TM(Transaction Manager)-äº‹åŠ¡ç®¡ç†å™¨ã€‚(å®šä¹‰å…¨å±€äº‹åŠ¡çš„èŒƒå›´ï¼šå¼€å§‹å…¨å±€äº‹åŠ¡ã€æäº¤æˆ–å›æ»šå…¨å±€äº‹åŠ¡ã€‚)</li>
<li>RM(Resource Manager)-èµ„æºç®¡ç†å™¨ã€‚(ç®¡ç†åˆ†æ”¯äº‹åŠ¡å¤„ç†çš„èµ„æºï¼Œä¸TCäº¤è°ˆä»¥æ³¨å†Œåˆ†æ”¯äº‹åŠ¡å’ŒæŠ¥å‘Šåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œå¹¶é©±åŠ¨åˆ†æ”¯äº‹åŠ¡æäº¤æˆ–å›æ»š)</li>
</ul>
<p>å½“ç„¶è¿™æ ·çœ‹ï¼Œå¯èƒ½è¿˜ä¸æ˜¯å¾ˆç†è§£ï¼Œæˆ‘æ‹¿ä¸€å¼ å®˜ç½‘çš„å›¾åŠ ä»¥è§£é‡Šã€‚</p>
<p><img src="https://cdn.syst.top/transaction.png" alt="seata_tcc-1"></p>
<p>ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸‰ä¸ªè§’è‰²æ‰€è´Ÿè´£çš„å·¥ä½œå¦‚ä¸‹ï¼Œ</p>
<p>TC</p>
<ul>
<li>ç»´æŠ¤å…¨å±€å’Œåˆ†æ”¯äº‹åŠ¡çŠ¶æ€ï¼Œéœ€è¦è¿›è¡Œå­˜å‚¨ã€‚</li>
<li>å½“ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†ç»“æŸï¼Œéœ€è¦é€šçŸ¥åˆ°æ¯ä¸ªRMæ˜¯commitè¿˜æ˜¯rollbackã€‚</li>
</ul>
<p>TM</p>
<ul>
<li>å‘TCè¯·æ±‚å¼€å¯ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå¾—åˆ°ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„åˆ†å¸ƒå¼idã€‚</li>
<li>æ ¹æ®æ¯ä¸ªå‚ä¸åˆ†å¸ƒå¼äº‹åŠ¡çš„RMä¸€é˜¶æ®µçš„åé¦ˆï¼Œå†³å®šäºŒé˜¶æ®µå‘TCè¯·æ±‚æ­¤æ¬¡åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯commitè¿˜æ˜¯rollback(ç»å¤§éƒ¨åˆ†åœºæ™¯ä¸‹ï¼Œä¸€é˜¶æ®µä»»ä¸€RMå¤±è´¥ï¼Œæœ¬æ¬¡åˆ†å¸ƒå¼äº‹åŠ¡å¤±è´¥)</li>
</ul>
<p>RM</p>
<p>è¯´çš„ç™½ä¸€ç‚¹å°±æ˜¯ç®¡ç†å‚ä¸åˆ†å¸ƒå¼äº‹åŠ¡çš„å„ä¸ªæœåŠ¡(æ¯”å¦‚ç»å…¸ä¸‹å•åœºæ™¯ä¸­æ¶‰åŠåˆ°çš„:è®¢å•æœåŠ¡ã€åº“å­˜æœåŠ¡ã€è¥é”€æœåŠ¡ç­‰)</p>
<p>ps:ä¸ªäººæ„Ÿè§‰ï¼Œè¿™é‡Œçš„RMæœ‰ç‚¹ç±»ä¼¼å¾®æœåŠ¡ä¸­çš„ä¸­é—´å¤„ç†å±‚(ä¸“ä¸šæœ¯è¯­ä»–ä»¬ç®¡è¿™å«bff-&gt;backend for fronted)ã€‚</p>
<ul>
<li>
<p>ä¸€é˜¶æ®µ prepare è¡Œä¸º(ä¸»åŠ¨)ï¼šæ¯ä¸ªRMè°ƒç”¨ <strong>è‡ªå®šä¹‰</strong> çš„ prepare é€»è¾‘ã€‚</p>
</li>
<li>
<p>äºŒé˜¶æ®µ commit è¡Œä¸º(è¢«åŠ¨è§¦å‘)ï¼šå¦‚æœæœ¬æ¬¡åˆ†å¸ƒå¼äº‹åŠ¡ç¬¬ä¸€é˜¶æ®µå…¨éƒ¨RMæˆåŠŸï¼ŒTCå¤„ç†å®Œè‡ªèº«çŠ¶æ€å˜æ›´åï¼Œè°ƒç”¨å„ä¸ªRM<strong>è‡ªå®šä¹‰</strong> çš„ commit é€»è¾‘ã€‚(ä¸€é˜¶æ®µRMå…¨éƒ¨æˆåŠŸ)</p>
</li>
<li>
<p>äºŒé˜¶æ®µ rollback è¡Œä¸º(è¢«åŠ¨è§¦å‘)ï¼šå¦‚æœæœ¬æ¬¡åˆ†å¸ƒå¼äº‹åŠ¡ç¬¬ä¸€é˜¶æ®µä»»ä¸€RMå¤±è´¥ï¼ŒTCå¤„ç†å®Œè‡ªèº«çŠ¶æ€å˜æ›´åï¼Œè°ƒç”¨å„ä¸ªRM<strong>è‡ªå®šä¹‰</strong> çš„ rollback é€»è¾‘ã€‚(ä¸€é˜¶æ®µä»»æ„RMå¤±è´¥)</p>
</li>
</ul>
<p>å¥½äº†ã€‚ä¸‹é¢å¯ä»¥çœ‹çœ‹seata-golang å®ç°çš„ä¸€äº›ç»†èŠ‚äº†ï¼Œseata-golang åº•å±‚é‡‡ç”¨gRPCè¿›è¡Œé€šä¿¡ã€‚</p>
<h3 id="seata-golang">seata-golang</h3>
<p>æˆ‘ä»¬å…ˆçœ‹RMéƒ¨åˆ†ç»“æ„ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">ResourceManager</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">addressing</span>     <span class="kt">string</span> <span class="c1">//rmåœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">rpcClient</span>      <span class="nx">apis</span><span class="p">.</span><span class="nx">ResourceManagerServiceClient</span> <span class="c1">//rm rpcå®¢æˆ·ç«¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">managers</span>       <span class="kd">map</span><span class="p">[</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchSession_BranchType</span><span class="p">]</span><span class="nx">ResourceManagerInterface</span> <span class="c1">//å­˜å‚¨rmäº‹åŠ¡æ¨¡å¼ï¼ˆæ¯”å¦‚TCCã€ATç­‰ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">branchMessages</span> <span class="kd">chan</span> <span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchMessage</span> <span class="c1">//å­˜å‚¨å°†è¦å‘TCå“åº”çš„æ¶ˆæ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">ResourceManagerServiceClient</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å’Œ TC æµæ•°æ®äº¤äº’æ¥å£
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nf">BranchCommunicate</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="nx">ResourceManagerService_BranchCommunicateClient</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å‘TC æ³¨å†Œåˆ†æ”¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nf">BranchRegister</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">BranchRegisterRequest</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">BranchRegisterResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//.....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>è‡³äºmanagersï¼Œä¿å­˜æ”¯æŒçš„å„å¤§äº‹åŠ¡æ¨¡å¼(TCCç­‰)ï¼Œæ¯ä¸ªæ¨¡å¼åªéœ€è¦å®ç°æ­¤æ¥å£å³å¯ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">ResourceManagerInterface</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// åˆ†æ”¯æäº¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">BranchCommit</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">request</span> <span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchCommitRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchCommitResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="c1">// åˆ†æ”¯å›é€€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">BranchRollback</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">request</span> <span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchRollbackRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchRollbackResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ......
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>å†çœ‹TCéƒ¨åˆ†ç»“æ„(åªä¿ç•™ä¼šæ¶‰åŠçš„å­—æ®µï¼Œå…¶ä»–ç»†èŠ‚å¯ä»¥è‡ªè¡ŒæŸ¥é˜…)ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">TransactionCoordinator</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">holder</span>             <span class="o">*</span><span class="nx">holder</span><span class="p">.</span><span class="nx">SessionHolder</span> <span class="c1">//æ•°æ®å­˜å‚¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// ......
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">futures</span>            <span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">Map</span> <span class="c1">//ä¸´æ—¶å­˜å‚¨RMå“åº”æ•°æ®ï¼Œæœ‰gåœ¨æ¥å—å¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// ......
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">callBackMessages</span>   <span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">Map</span> <span class="c1">//ä¸´æ—¶å­˜å‚¨TCå³å°†å‘RMå‘é€çš„æ¶ˆæ¯,æœ‰æ ¼å¤–gåœ¨å‘é€æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">SessionHolder</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">manager</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">SessionManager</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SessionManager stored the globalTransactions and branchTransactions.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">SessionManager</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Add global session.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">AddGlobalSession</span><span class="p">(</span><span class="nx">session</span> <span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">GlobalSession</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Find global session.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">FindGlobalSession</span><span class="p">(</span><span class="nx">xid</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">GlobalSession</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Find global sessions list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">FindGlobalSessions</span><span class="p">(</span><span class="nx">statuses</span> <span class="p">[]</span><span class="nx">apis</span><span class="p">.</span><span class="nx">GlobalSession_GlobalStatus</span><span class="p">)</span> <span class="p">[]</span><span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">GlobalSession</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>TCå¯¹æ•°æ®çš„å­˜å‚¨ç›®å‰æ”¯æŒmysqlå’Œpgsqlï¼Œå³å®ç°SessionManageræ¥å£ï¼Œç„¶åæ³¨å…¥åˆ°SessionHolderçš„managerã€‚</p>
<p>ä»‹ç»å®Œè¿™ä¸¤ä¸ªåŸºæœ¬ç»“æ„ï¼Œè¿˜è®°å¾—æˆ‘ä»¬ä¸Šé¢è¯´è¿‡ä»–ä»¬ä¹‹é—´çš„å…³ç³»å—ï¼Ÿ</p>
<p>äºŒé˜¶æ®µTCä¼šæ ¹æ®å½“å‰äº‹åŠ¡çŠ¶æ€å»é€šçŸ¥RMæ˜¯commitè¿˜æ˜¯rollbackã€‚</p>
<p>åœ¨åˆå§‹åŒ–ResourceManager çš„æ—¶å€™ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">InitResourceManager</span><span class="p">(</span><span class="nx">addressing</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">client</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">ResourceManagerServiceClient</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">defaultResourceManager</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">ResourceManager</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">addressing</span><span class="p">:</span>     <span class="nx">addressing</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rpcClient</span><span class="p">:</span>      <span class="nx">client</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">managers</span><span class="p">:</span>       <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchSession_BranchType</span><span class="p">]</span><span class="nx">ResourceManagerInterface</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">branchMessages</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchMessage</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">runtime</span><span class="p">.</span><span class="nf">GoWithRecover</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ä¼šå•ç‹¬å¼€å¯ä¸€ä¸ªgè°ƒç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">defaultResourceManager</span><span class="p">.</span><span class="nf">branchCommunicate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">manager</span> <span class="o">*</span><span class="nx">ResourceManager</span><span class="p">)</span> <span class="nf">branchCommunicate</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="c1">//çœç•¥ä»£ç ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">stream</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">rpcClient</span><span class="p">.</span><span class="nf">BranchCommunicate</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// çœç•¥ä»£ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬çœ‹åˆ°æœ€ç»ˆä¼šè°ƒç”¨TCä¸€ä¸ª grpc æ¥å£branchCommunicateã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">	<span class="nf">BranchCommunicate</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="nx">ResourceManagerService_BranchCommunicateClient</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">ResourceManagerService_BranchCommunicateClient</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Send</span><span class="p">(</span><span class="o">*</span><span class="nx">BranchMessage</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Recv</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">BranchMessage</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">grpc</span><span class="p">.</span><span class="nx">ClientStream</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å¯¹åº”åˆ°æœåŠ¡ç«¯ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">rpc</span> <span class="nf">BranchCommunicate</span><span class="p">(</span><span class="nx">stream</span> <span class="nx">BranchMessage</span><span class="p">)</span> <span class="nf">returns</span> <span class="p">(</span><span class="nx">stream</span> <span class="nx">BranchMessage</span><span class="p">);</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">ResourceManagerService_BranchCommunicateServer</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Send</span><span class="p">(</span><span class="o">*</span><span class="nx">BranchMessage</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Recv</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">BranchMessage</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">grpc</span><span class="p">.</span><span class="nx">ServerStream</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬çŸ¥é“gRPCæœ‰å››ç§åŸºç¡€çš„é€šä¿¡æ¨¡å¼ã€‚</p>
<ul>
<li>ä¸€å…ƒæ¨¡å¼ï¼ˆUnary RPCï¼‰</li>
<li>æœåŠ¡å™¨ç«¯æµRPCï¼ˆServer Sreaming RPCï¼‰</li>
<li>å®¢æˆ·ç«¯æµRPCï¼ˆClient Streaming RPCï¼‰</li>
<li>åŒå‘æµRPCï¼ˆBidirectional Streaming RPCï¼‰</li>
</ul>
<p>æƒ³è¦æµçš„å½¢å¼ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨protoæ–¹æ³•å®šä¹‰ä¸­å°†å¯¹åº”çš„è¯·æ±‚|å“åº” å‚æ•°å‰åŠ ä¸Šstreamæ ‡è®°ï¼Œé‚£ä¹ˆè¿™ä¸ªæ¥å£å°±æ˜¯æµå¼ä¼ é€äº†ã€‚è‡³äºæ˜¯å“ªç§æµï¼Œå–å†³äºä½ æŠŠstreamåŠ åœ¨å“ªè¾¹ï¼Œå¦‚æœè¯·æ±‚å’Œå“åº”éƒ½åŠ ï¼Œé‚£ä¹ˆå°±æ˜¯åŒå‘æµäº†ã€‚</p>
<p>å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½å¯ä»¥é€šè¿‡stream.Send å‘é€è¯·æ±‚ï¼Œé€šè¿‡stream.Recv è¯»å–å“åº”ã€‚</p>
<p>å½“RMè°ƒç”¨BranchCommunicateæ—¶ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">manager</span> <span class="o">*</span><span class="nx">ResourceManager</span><span class="p">)</span> <span class="nf">branchCommunicate</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">metadata</span><span class="p">.</span><span class="nf">AppendToOutgoingContext</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="s">&#34;addressing&#34;</span><span class="p">,</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">addressing</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// å¾—åˆ°steam
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">stream</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">rpcClient</span><span class="p">.</span><span class="nf">BranchCommunicate</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// å³-&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1">//      type ResourceManagerService_BranchCommunicateClient interface {
</span></span></span><span class="line"><span class="cl"><span class="c1">//       	Send(*BranchMessage) error
</span></span></span><span class="line"><span class="cl"><span class="c1">//	      Recv() (*BranchMessage, error)
</span></span></span><span class="line"><span class="cl"><span class="c1">//      	grpc.ClientStream
</span></span></span><span class="line"><span class="cl"><span class="c1">//       }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="k">continue</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nx">done</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// å¦å¼€ä¸€ä¸ªgç”¨æ¥å“åº”æ¶ˆæ¯ç»™TC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">runtime</span><span class="p">.</span><span class="nf">GoWithRecover</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// æ­»å¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">done</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">               <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="k">return</span>
</span></span><span class="line"><span class="cl">               <span class="p">}</span>
</span></span><span class="line"><span class="cl">               <span class="c1">// å¦‚æœbranchMessages æœ‰æ•°æ®ï¼Œè¯´æ˜æ˜¯å¤„ç†å®Œtcçš„å“åº”æ•°æ®ï¼Œé€šè¿‡sendå“åº”ç»™tc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">case</span> <span class="nx">msg</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">manager</span><span class="p">.</span><span class="nx">branchMessages</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">               <span class="nx">err</span> <span class="o">:=</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">               <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="k">return</span>
</span></span><span class="line"><span class="cl">               <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// å¦ä¸€ä¸ªæ­»å¾ªç¯æ˜¯ç”¨æ¥æ¥å—ä»tcå‘é€è¿‡æ¥çš„æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// æ¥å—æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="nx">msg</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">Recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">close</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">close</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// åˆ¤æ–­tcå‘é€æ•°æ®çš„ç±»å‹ï¼Œæ˜¯æäº¤åˆ†æ”¯äº‹åŠ¡ç±»å‹è¿˜æ˜¯å›æ»šç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="k">switch</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">BranchMessageType</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// å¦‚æœæ˜¯åˆ†æ”¯æäº¤çš„æ¶ˆæ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="k">case</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">TypeBranchCommit</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nx">request</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchCommitRequest</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">data</span> <span class="o">:=</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetMessage</span><span class="p">().</span><span class="nf">GetValue</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="nx">err</span> <span class="o">:=</span> <span class="nx">request</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">               <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å¤„ç†åˆ†æ”¯æäº¤ï¼Œå¾—åˆ°å¤„ç†ç»“æœ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">response</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">manager</span><span class="p">.</span><span class="nf">BranchCommit</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="nx">content</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">types</span><span class="p">.</span><span class="nf">MarshalAny</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">               <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="c1">// å†æŠŠå¤„ç†å®Œçš„ç»“æœåŒ…è£…ä¸€ä¸‹å¡åˆ°branchMessagesç­‰å¾…å‘é€å‡ºå»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                  <span class="nx">manager</span><span class="p">.</span><span class="nx">branchMessages</span> <span class="o">&lt;-</span> <span class="o">&amp;</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchMessage</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                     <span class="nx">ID</span><span class="p">:</span>                <span class="nx">msg</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                     <span class="nx">BranchMessageType</span><span class="p">:</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">TypeBranchCommitResult</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                     <span class="nx">Message</span><span class="p">:</span>           <span class="nx">content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="p">}</span>
</span></span><span class="line"><span class="cl">               <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1">// å¦‚æœæ˜¯å›æ»šçš„æ¶ˆæ¯ï¼Œæœ¬è´¨ä¸Šæµç¨‹å·®ä¸å¤š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="k">case</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">TypeBranchRollback</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nx">request</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchRollbackRequest</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">data</span> <span class="o">:=</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetMessage</span><span class="p">().</span><span class="nf">GetValue</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="nx">err</span> <span class="o">:=</span> <span class="nx">request</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">               <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">response</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">manager</span><span class="p">.</span><span class="nf">BranchRollback</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="nx">content</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">types</span><span class="p">.</span><span class="nf">MarshalAny</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">               <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="nx">manager</span><span class="p">.</span><span class="nx">branchMessages</span> <span class="o">&lt;-</span> <span class="o">&amp;</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchMessage</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                     <span class="nx">ID</span><span class="p">:</span>                <span class="nx">msg</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                     <span class="nx">BranchMessageType</span><span class="p">:</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">TypeBranchRollBackResult</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                     <span class="nx">Message</span><span class="p">:</span>           <span class="nx">content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="p">}</span>
</span></span><span class="line"><span class="cl">               <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// å…³é—­æµ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">err</span> <span class="p">=</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">CloseSend</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æœ€ç»ˆå¤„ç†åˆ†æ”¯äº‹åŠ¡è°ƒç”¨manager.BranchCommitï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">manager</span> <span class="nx">ResourceManager</span><span class="p">)</span> <span class="nf">BranchCommit</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">request</span> <span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchCommitRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchCommitResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">// æ ¹æ®äº‹åŠ¡æ¨¡å¼è°ƒç”¨å¯¹åº”çš„å¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">rm</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">managers</span><span class="p">[</span><span class="nx">request</span><span class="p">.</span><span class="nx">BranchType</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">rm</span><span class="p">.</span><span class="nf">BranchCommit</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchCommitResponse</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ResultCode</span><span class="p">:</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">ResultCodeFailed</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Message</span><span class="p">:</span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;there is no resource manager for %s&#34;</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">BranchType</span><span class="p">.</span><span class="nf">String</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ç›¸åº”çš„ï¼Œå½“TCè¢«RMè°ƒç”¨BranchCommunicate åï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">tc</span> <span class="o">*</span><span class="nx">TransactionCoordinator</span><span class="p">)</span> <span class="nf">BranchCommunicate</span><span class="p">(</span><span class="nx">stream</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">ResourceManagerService_BranchCommunicateServer</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">addressing</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nx">done</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">Context</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">md</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">metadata</span><span class="p">.</span><span class="nf">FromIncomingContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">//çœç•¥ä¸€äº›æ— å…³ä»£ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//............
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">addressing</span> <span class="p">=</span> <span class="nx">md</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;addressing&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="c1">//è¿™é‡Œå¾ˆå¥½æ‡‚å§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">queue</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">tc</span><span class="p">.</span><span class="nx">callBackMessages</span><span class="p">.</span><span class="nf">LoadOrStore</span><span class="p">(</span><span class="nx">addressing</span><span class="p">,</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchMessage</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">q</span> <span class="o">:=</span> <span class="nx">queue</span><span class="p">.(</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchMessage</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">// å•ç‹¬ä¸€ä¸ªg è¿è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// ç”¨æ¥ä»callBackMessagesä¸­å–æ•°æ®å‘é€ç»™å®¢æˆ·ç«¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">runtime</span><span class="p">.</span><span class="nf">GoWithRecover</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ­»å¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">done</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœèƒ½æ‹¿åˆ°æ•°æ®ï¼Œè¯´æ˜æœ‰æ•°æ®éœ€è¦å‘é€ç»™å®¢æˆ·ç«¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">case</span> <span class="nx">msg</span> <span class="o">:=</span> <span class="o">&lt;-</span> <span class="nx">q</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="nx">err</span> <span class="o">:=</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// ä¸‹é¢çš„æ­»å¾ªç¯é€»è¾‘ä¸»è¦æ˜¯ä»stearm æ¥å—å®¢æˆ·ç«¯å“åº”æ•°æ®ï¼Œç„¶åå¡å…¥åˆ°futureä¸­ï¼Œæ ¹æ®å”¯ä¸€çš„branch_message_Id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">			<span class="nb">close</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">Err</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//æœ‰æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">branchMessage</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">Recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nb">close</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nb">close</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// è¦åŒºåˆ†æ˜¯ä»€ä¹ˆå“åº”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// æ ¹æ®æ˜¯ äº‹åŠ¡commitçš„å“åº”ï¼Œè¿˜æ˜¯å¯¹rollbackçš„å“åº”,äº¤ç»™ä¸åŒé€»è¾‘å¤„ç†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">switch</span> <span class="nx">branchMessage</span><span class="p">.</span><span class="nf">GetBranchMessageType</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// åˆ†æ”¯äº‹åŠ¡æäº¤çš„å“åº”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">case</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">TypeBranchCommitResult</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="nx">response</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchCommitResponse</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">				<span class="nx">data</span> <span class="o">:=</span> <span class="nx">branchMessage</span><span class="p">.</span><span class="nf">GetMessage</span><span class="p">().</span><span class="nf">GetValue</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è§£ææ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nx">err</span> <span class="o">:=</span> <span class="nx">response</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="k">continue</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// è¯´æ˜å‘é€commitçš„åŠ¨ä½œåœ¨ç­‰å¾…å“åº”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nx">resp</span><span class="p">,</span> <span class="nx">loaded</span> <span class="o">:=</span> <span class="nx">tc</span><span class="p">.</span><span class="nx">futures</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="nx">branchMessage</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">loaded</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// èµ‹å€¼å“åº”æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="nx">future</span> <span class="o">:=</span> <span class="nx">resp</span><span class="p">.(</span><span class="o">*</span><span class="nx">common2</span><span class="p">.</span><span class="nx">MessageFuture</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="nx">future</span><span class="p">.</span><span class="nx">Response</span> <span class="p">=</span> <span class="nx">response</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// é€šçŸ¥æ•°æ®åˆ°äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="nx">future</span><span class="p">.</span><span class="nx">Done</span> <span class="o">&lt;-</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">					<span class="nx">tc</span><span class="p">.</span><span class="nx">futures</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">branchMessage</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å’Œä¸Šé¢å·®ä¸å¤šé€»è¾‘é™¤äº†å“åº”æ•°æ®ä¸åŒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">case</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">TypeBranchRollBackResult</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="nx">response</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchRollbackResponse</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">				<span class="nx">data</span> <span class="o">:=</span> <span class="nx">branchMessage</span><span class="p">.</span><span class="nf">GetMessage</span><span class="p">().</span><span class="nf">GetValue</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">				<span class="nx">err</span> <span class="o">:=</span> <span class="nx">response</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="k">continue</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="nx">resp</span><span class="p">,</span> <span class="nx">loaded</span> <span class="o">:=</span> <span class="nx">tc</span><span class="p">.</span><span class="nx">futures</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="nx">branchMessage</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">loaded</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">future</span> <span class="o">:=</span> <span class="nx">resp</span><span class="p">.(</span><span class="o">*</span><span class="nx">common2</span><span class="p">.</span><span class="nx">MessageFuture</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="nx">future</span><span class="p">.</span><span class="nx">Response</span> <span class="p">=</span> <span class="nx">response</span>
</span></span><span class="line"><span class="cl">					<span class="nx">future</span><span class="p">.</span><span class="nx">Done</span> <span class="o">&lt;-</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">					<span class="nx">tc</span><span class="p">.</span><span class="nx">futures</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">branchMessage</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ä¸Šé¢è¦å‘é€ç»™RM é€šçŸ¥commit æˆ–è€… rollback æ•°æ®æ˜¯å’‹ä¹ˆæ¥çš„å‘¢ï¼Ÿ</p>
<p>å½“TCè¦é€šçŸ¥RMè¿›è¡Œåˆ†æ”¯commit çš„æ—¶å€™ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">tc</span> <span class="o">*</span><span class="nx">TransactionCoordinator</span><span class="p">)</span> <span class="nf">branchCommit</span><span class="p">(</span><span class="nx">bs</span> <span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchSession</span><span class="p">)</span> <span class="p">(</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchSession_BranchStatus</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">request</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchCommitRequest</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">XID</span><span class="p">:</span>             <span class="nx">bs</span><span class="p">.</span><span class="nx">XID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">BranchID</span><span class="p">:</span>        <span class="nx">bs</span><span class="p">.</span><span class="nx">BranchID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">ResourceID</span><span class="p">:</span>      <span class="nx">bs</span><span class="p">.</span><span class="nx">ResourceID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">LockKey</span><span class="p">:</span>         <span class="nx">bs</span><span class="p">.</span><span class="nx">LockKey</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">BranchType</span><span class="p">:</span>      <span class="nx">bs</span><span class="p">.</span><span class="nx">Type</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">ApplicationData</span><span class="p">:</span> <span class="nx">bs</span><span class="p">.</span><span class="nx">ApplicationData</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nx">content</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">types</span><span class="p">.</span><span class="nf">MarshalAny</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">bs</span><span class="p">.</span><span class="nx">Status</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="nx">message</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchMessage</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">ID</span><span class="p">:</span>                <span class="nb">int64</span><span class="p">(</span><span class="nx">tc</span><span class="p">.</span><span class="nx">idGenerator</span><span class="p">.</span><span class="nf">Inc</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">      <span class="nx">BranchMessageType</span><span class="p">:</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">TypeBranchCommit</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">Message</span><span class="p">:</span>           <span class="nx">content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">//ä¸Šé¢æ˜¯å°è£…æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">queue</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">tc</span><span class="p">.</span><span class="nx">callBackMessages</span><span class="p">.</span><span class="nf">LoadOrStore</span><span class="p">(</span><span class="nx">bs</span><span class="p">.</span><span class="nx">Addressing</span><span class="p">,</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchMessage</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">   <span class="nx">q</span> <span class="o">:=</span> <span class="nx">queue</span><span class="p">.(</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchMessage</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="c1">// åœ¨è¿™æŠŠæ•°æ®å¡åˆ°callBackMessages
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">case</span> <span class="nx">q</span> <span class="o">&lt;-</span> <span class="nx">message</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">   <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">bs</span><span class="p">.</span><span class="nx">Status</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// è¿™é‡Œåˆ›å»ºäº†RMå“åº”æ ¼å¼ï¼Œæ ¹æ® messageidï¼Œå¡å…¥åˆ°ç»“æœfutures(sync.mapä¸­)ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">resp</span> <span class="o">:=</span> <span class="nx">common2</span><span class="p">.</span><span class="nf">NewMessageFuture</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">tc</span><span class="p">.</span><span class="nx">futures</span><span class="p">.</span><span class="nf">Store</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nx">timer</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTimer</span><span class="p">(</span><span class="nx">tc</span><span class="p">.</span><span class="nx">streamMessageTimeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="c1">// RMå“åº”è¶…æ—¶äº†ï¼ŒGG
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">timer</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="nx">tc</span><span class="p">.</span><span class="nx">futures</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">bs</span><span class="p">.</span><span class="nx">Status</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;wait branch commit response timeout&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">resp</span><span class="p">.</span><span class="nx">Done</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="nx">timer</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// å“åº”æˆåŠŸï¼Œè§£ææ•°æ®å¤„ç†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">response</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Response</span><span class="p">.(</span><span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchCommitResponse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">log</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;rollback response: %v&#34;</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Response</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">bs</span><span class="p">.</span><span class="nx">Status</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;response type not right&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">response</span><span class="p">.</span><span class="nx">ResultCode</span> <span class="o">==</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">ResultCodeSuccess</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">BranchStatus</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="nx">bs</span><span class="p">.</span><span class="nx">Status</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æœ€åä¸€ä¸ªå°±æ˜¯TMï¼Œæ²¡å•¥ç†è§£éš¾åº¦ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// tm request to  tc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">TransactionManagerInterface</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// GlobalStatus_Begin a new global transaction.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Begin</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">timeout</span> <span class="kt">int32</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Global commit.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Commit</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">xid</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">apis</span><span class="p">.</span><span class="nx">GlobalSession_GlobalStatus</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Global rollback.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Rollback</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">xid</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">apis</span><span class="p">.</span><span class="nx">GlobalSession_GlobalStatus</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Get current status of the give transaction.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">GetStatus</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">xid</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">apis</span><span class="p">.</span><span class="nx">GlobalSession_GlobalStatus</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Global report.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">GlobalReport</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">xid</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">globalStatus</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">GlobalSession_GlobalStatus</span><span class="p">)</span> <span class="p">(</span><span class="nx">apis</span><span class="p">.</span><span class="nx">GlobalSession_GlobalStatus</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">TransactionManager</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">addressing</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rpcClient</span>  <span class="nx">apis</span><span class="p">.</span><span class="nx">TransactionManagerServiceClient</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">InitTransactionManager</span><span class="p">(</span><span class="nx">addressing</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">client</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">TransactionManagerServiceClient</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">defaultTransactionManager</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">TransactionManager</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">addressing</span><span class="p">:</span> <span class="nx">addressing</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rpcClient</span><span class="p">:</span>  <span class="nx">client</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å…¶å®seat-golangè¿˜æœ‰åˆ«çš„å¯ä»¥æä¸€æçš„ã€‚</p>
<p>æ¯”å¦‚è¯´ï¼Œå®ƒé‡Œé¢é€šè¿‡goåå°„å®ç°çš„åŠ¨æ€ä»£ç†åŠŸèƒ½(è™½ç„¶æˆ‘è§‰å¾—å®Œå…¨æ²¡å¿…è¦?)ï¼Œæˆ‘æ‡’å¾—å†™äº†ã€‚</p>
<p>è¿™ç¯‡æ–‡ç« å†å†™å°±æ›´é•¿äº†ï¼Œä¸ç»§ç»­å†™dtmäº†ï¼Œæ„Ÿå…´è¶£çš„ç•™ä¸ªè¨€ï¼Œæˆ‘çœ‹çœ‹è¦ä¸è¦å†™ä¸€ç¯‡dtmã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>é‚£äº›ç”¨Goå®ç°çš„åˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶(2)</title>
			<link>https://www.syst.top/posts/go/transaction2/</link>
			<pubDate>Wed, 08 Dec 2021 22:25:52 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/transaction2/</guid>
			<description>å¼€ç¯‡ ä¸Šä¸€ç¯‡æˆ‘ä»¬ä¸»è¦ä»‹ç»çš„æ˜¯seata-golangã€‚ä¸€ä¸ªå¯¹æ ‡seataçš„goè¯­è¨€å®ç°ï¼Œå½“ç„¶ç‰ˆæœ¬è¿˜æ˜¯è½åJavaç‰ˆå¾ˆå¤šçš„ã€‚
è¿™æ¬¡æˆ‘ä»¬æ¥ä»‹ç»ä¸€ä¸‹å¦ä¸€ä¸ªgoå®ç°çš„åˆ†å¸ƒå¼äº‹åŠ¡:dtmã€‚
é¦–å…ˆæ¥çœ‹ä¸‹dtmæ•´ä½“æ¶æ„å›¾(æ¥æºå®˜ç½‘)ã€‚
å†æ¥çœ‹ä¹‹å‰çš„seataæ¶æ„å›¾ã€‚
ä»æ¶æ„ä¸Šæ¥çœ‹ï¼Œå¤§å·®ä¸å·®ã€‚
seataä¸­çš„TCå¯¹æ ‡damçš„TMã€‚
RMä¸¤è¾¹æ„æ€ä¸€è‡´ã€‚
seataä¸­çš„TMå¯¹æ ‡dtmäº‹åŠ¡SDKã€‚ä½œç”¨éƒ½æ˜¯ä¸€æ ·:ç¬¬ä¸€é˜¶æ®µå¼€å¯ä¸€ä¸ªå…¨å±€äº‹åŠ¡,æ‰§è¡Œå„RMåˆ†æ”¯äº‹åŠ¡ï¼Œç¬¬äºŒé˜¶æ®µæ ¹æ®RMç¬¬ä¸€é˜¶æ®µæ‰§è¡Œç»“æœï¼Œå†³å®šè°ƒç”¨TC(seata)|TM(dtm) commitæˆ–è€…rollbackã€‚
æ¶æ„ä¸Šï¼Œä¸ªäººæ„Ÿè§‰åªæ˜¯å› ä¸ºæ¨¡å—åç§°ä»¥åŠå›¾ç”»ä¸ä¸€æ ·çš„å·®åˆ«ã€‚
å½“ç„¶åœ¨å®ç°ç»†èŠ‚ä¸Šè¿˜æ˜¯æœ‰å¾ˆå¤§å·®åˆ«çš„ã€‚
æˆ‘ä»¬å…ˆç®€å•ä»‹ç»ä¸‹DTMå„ä¸ªæ¨¡å—ã€‚
TM TM å±‚åœ¨ä»£ç ä¸­æ˜¯æ²¡æœ‰å…·ä½“çš„ä¸»ä½“ç»“æ„çš„ï¼Œå¼€å§‹éƒ½æ˜¯å‡½æ•°ä¹‹å‰çš„è°ƒç”¨ã€‚
å¯åŠ¨TMå®é™…ä¸Šå¼€å¯äº†ä¸¤ä¸ªæœåŠ¡ï¼Œhttpä»¥åŠgrpcè¿™ä¸¤ä¸ªæœåŠ¡ã€‚
// StartSvr StartSvr func StartSvr() { app := common.GetGinApp() app = httpMetrics(app) addRoute(app) dtmimp.Logf(&amp;#34;dtmsvr listen at: %d&amp;#34;, common.DtmHttpPort) go app.Run(fmt.Sprintf(&amp;#34;:%d&amp;#34;, common.DtmHttpPort)) lis, err := net.Listen(&amp;#34;tcp&amp;#34;, fmt.Sprintf(&amp;#34;:%d&amp;#34;, common.DtmGrpcPort)) dtmimp.FatalIfError(err) s := grpc.NewServer( grpc.UnaryInterceptor(grpc_middleware.ChainUnaryServer( grpc.UnaryServerInterceptor(grpcMetrics), grpc.UnaryServerInterceptor(dtmgimp.GrpcServerLog)), )) dtmgimp.RegisterDtmServer(s, &amp;amp;dtmServer{}) dtmimp.Logf(&amp;#34;grpc listening at %v&amp;#34;, lis.Addr()) go func() { err := s.Serve(lis) dtmimp.FatalIfError(err) }() go updateBranchAsync() // çœç•¥ä»£ç  } httpè·¯ç”±ï¼Œ</description>
			<content type="html"><![CDATA[<h3 id="å¼€ç¯‡">å¼€ç¯‡</h3>
<p>ä¸Šä¸€ç¯‡æˆ‘ä»¬ä¸»è¦ä»‹ç»çš„æ˜¯seata-golangã€‚ä¸€ä¸ªå¯¹æ ‡seataçš„goè¯­è¨€å®ç°ï¼Œå½“ç„¶ç‰ˆæœ¬è¿˜æ˜¯è½åJavaç‰ˆå¾ˆå¤šçš„ã€‚</p>
<p>è¿™æ¬¡æˆ‘ä»¬æ¥ä»‹ç»ä¸€ä¸‹å¦ä¸€ä¸ªgoå®ç°çš„åˆ†å¸ƒå¼äº‹åŠ¡:dtmã€‚</p>
<p>é¦–å…ˆæ¥çœ‹ä¸‹dtmæ•´ä½“æ¶æ„å›¾(æ¥æºå®˜ç½‘)ã€‚</p>
<p><img src="https://cdn.syst.top/arch.8ecd5239.jpg" alt="arch.8ecd5239"></p>
<p>å†æ¥çœ‹ä¹‹å‰çš„seataæ¶æ„å›¾ã€‚</p>
<p><img src="https://cdn.syst.top/transaction.png" alt="seata_tcc-1"></p>
<p>ä»æ¶æ„ä¸Šæ¥çœ‹ï¼Œå¤§å·®ä¸å·®ã€‚</p>
<p>seataä¸­çš„TCå¯¹æ ‡damçš„TMã€‚</p>
<p>RMä¸¤è¾¹æ„æ€ä¸€è‡´ã€‚</p>
<p>seataä¸­çš„TMå¯¹æ ‡dtmäº‹åŠ¡SDKã€‚ä½œç”¨éƒ½æ˜¯ä¸€æ ·:ç¬¬ä¸€é˜¶æ®µå¼€å¯ä¸€ä¸ªå…¨å±€äº‹åŠ¡,æ‰§è¡Œå„RMåˆ†æ”¯äº‹åŠ¡ï¼Œç¬¬äºŒé˜¶æ®µæ ¹æ®RMç¬¬ä¸€é˜¶æ®µæ‰§è¡Œç»“æœï¼Œå†³å®šè°ƒç”¨TC(seata)|TM(dtm) commitæˆ–è€…rollbackã€‚</p>
<p>æ¶æ„ä¸Šï¼Œä¸ªäººæ„Ÿè§‰åªæ˜¯å› ä¸ºæ¨¡å—åç§°ä»¥åŠå›¾ç”»ä¸ä¸€æ ·çš„å·®åˆ«ã€‚</p>
<p>å½“ç„¶åœ¨å®ç°ç»†èŠ‚ä¸Šè¿˜æ˜¯æœ‰å¾ˆå¤§å·®åˆ«çš„ã€‚</p>
<p>æˆ‘ä»¬å…ˆç®€å•ä»‹ç»ä¸‹DTMå„ä¸ªæ¨¡å—ã€‚</p>
<h3 id="tm">TM</h3>
<p>TM å±‚åœ¨ä»£ç ä¸­æ˜¯æ²¡æœ‰å…·ä½“çš„ä¸»ä½“ç»“æ„çš„ï¼Œå¼€å§‹éƒ½æ˜¯å‡½æ•°ä¹‹å‰çš„è°ƒç”¨ã€‚</p>
<p>å¯åŠ¨TMå®é™…ä¸Šå¼€å¯äº†ä¸¤ä¸ªæœåŠ¡ï¼Œhttpä»¥åŠgrpcè¿™ä¸¤ä¸ªæœåŠ¡ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// StartSvr StartSvr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">StartSvr</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">	<span class="nx">app</span> <span class="o">:=</span> <span class="nx">common</span><span class="p">.</span><span class="nf">GetGinApp</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span> <span class="p">=</span> <span class="nf">httpMetrics</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">addRoute</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">dtmimp</span><span class="p">.</span><span class="nf">Logf</span><span class="p">(</span><span class="s">&#34;dtmsvr listen at: %d&#34;</span><span class="p">,</span> <span class="nx">common</span><span class="p">.</span><span class="nx">DtmHttpPort</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="nx">app</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;:%d&#34;</span><span class="p">,</span> <span class="nx">common</span><span class="p">.</span><span class="nx">DtmHttpPort</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">	<span class="nx">lis</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;:%d&#34;</span><span class="p">,</span> <span class="nx">common</span><span class="p">.</span><span class="nx">DtmGrpcPort</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">dtmimp</span><span class="p">.</span><span class="nf">FatalIfError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">grpc</span><span class="p">.</span><span class="nf">UnaryInterceptor</span><span class="p">(</span><span class="nx">grpc_middleware</span><span class="p">.</span><span class="nf">ChainUnaryServer</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="nx">grpc</span><span class="p">.</span><span class="nf">UnaryServerInterceptor</span><span class="p">(</span><span class="nx">grpcMetrics</span><span class="p">),</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">UnaryServerInterceptor</span><span class="p">(</span><span class="nx">dtmgimp</span><span class="p">.</span><span class="nx">GrpcServerLog</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">		<span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">dtmgimp</span><span class="p">.</span><span class="nf">RegisterDtmServer</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">dtmServer</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">dtmimp</span><span class="p">.</span><span class="nf">Logf</span><span class="p">(</span><span class="s">&#34;grpc listening at %v&#34;</span><span class="p">,</span> <span class="nx">lis</span><span class="p">.</span><span class="nf">Addr</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">Serve</span><span class="p">(</span><span class="nx">lis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">dtmimp</span><span class="p">.</span><span class="nf">FatalIfError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="nf">updateBranchAsync</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">// çœç•¥ä»£ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>httpè·¯ç”±ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">addRoute</span><span class="p">(</span><span class="nx">engine</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Engine</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">engine</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/api/dtmsvr/newGid&#34;</span><span class="p">,</span> <span class="nx">common</span><span class="p">.</span><span class="nf">WrapHandler</span><span class="p">(</span><span class="nx">newGid</span><span class="p">))</span> <span class="c1">//å¼€å¯ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå¾—åˆ°åˆ†å¸ƒå¼äº‹åŠ¡å”¯ä¸€id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">engine</span><span class="p">.</span><span class="nf">POST</span><span class="p">(</span><span class="s">&#34;/api/dtmsvr/prepare&#34;</span><span class="p">,</span> <span class="nx">common</span><span class="p">.</span><span class="nf">WrapHandler</span><span class="p">(</span><span class="nx">prepare</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl">	<span class="nx">engine</span><span class="p">.</span><span class="nf">POST</span><span class="p">(</span><span class="s">&#34;/api/dtmsvr/submit&#34;</span><span class="p">,</span> <span class="nx">common</span><span class="p">.</span><span class="nf">WrapHandler</span><span class="p">(</span><span class="nx">submit</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl">	<span class="nx">engine</span><span class="p">.</span><span class="nf">POST</span><span class="p">(</span><span class="s">&#34;/api/dtmsvr/abort&#34;</span><span class="p">,</span> <span class="nx">common</span><span class="p">.</span><span class="nf">WrapHandler</span><span class="p">(</span><span class="nx">abort</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//......
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>gRPCæ¥å£ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// dtmServer is used to implement dtmgimp.DtmServer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">dtmServer</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pb</span><span class="p">.</span><span class="nx">UnimplementedDtmServer</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">dtmServer</span><span class="p">)</span> <span class="nf">NewGid</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">emptypb</span><span class="p">.</span><span class="nx">Empty</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">dtmgimp</span><span class="p">.</span><span class="nx">DtmGidReply</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">dtmgimp</span><span class="p">.</span><span class="nx">DtmGidReply</span><span class="p">{</span><span class="nx">Gid</span><span class="p">:</span> <span class="nf">GenGid</span><span class="p">()},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">dtmServer</span><span class="p">)</span> <span class="nf">Submit</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">DtmRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">emptypb</span><span class="p">.</span><span class="nx">Empty</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">r</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">svcSubmit</span><span class="p">(</span><span class="nf">TransFromDtmRequest</span><span class="p">(</span><span class="nx">in</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">emptypb</span><span class="p">.</span><span class="nx">Empty</span><span class="p">{},</span> <span class="nx">dtmgimp</span><span class="p">.</span><span class="nf">Result2Error</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">dtmServer</span><span class="p">)</span> <span class="nf">Prepare</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">DtmRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">emptypb</span><span class="p">.</span><span class="nx">Empty</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">r</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">svcPrepare</span><span class="p">(</span><span class="nf">TransFromDtmRequest</span><span class="p">(</span><span class="nx">in</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">emptypb</span><span class="p">.</span><span class="nx">Empty</span><span class="p">{},</span> <span class="nx">dtmgimp</span><span class="p">.</span><span class="nf">Result2Error</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">dtmServer</span><span class="p">)</span> <span class="nf">Abort</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">DtmRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">emptypb</span><span class="p">.</span><span class="nx">Empty</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">r</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">svcAbort</span><span class="p">(</span><span class="nf">TransFromDtmRequest</span><span class="p">(</span><span class="nx">in</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">emptypb</span><span class="p">.</span><span class="nx">Empty</span><span class="p">{},</span> <span class="nx">dtmgimp</span><span class="p">.</span><span class="nf">Result2Error</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å³ç„¶æä¾›äº†ä¸¤ä¸ªæœåŠ¡å…¥å£ï¼Œé‚£ç†æ‰€å½“ç„¶æœ‰å…¬å…±å¤„ç†æ ¸å¿ƒä¸šåŠ¡çš„éƒ¨åˆ†ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// æäº¤äº‹åŠ¡è¯·æ±‚æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">svcSubmit</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">TransGlobal</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">db</span> <span class="o">:=</span> <span class="nf">dbGet</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">t</span><span class="p">.</span><span class="nx">Status</span> <span class="p">=</span> <span class="nx">dtmcli</span><span class="p">.</span><span class="nx">StatusSubmitted</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">saveNew</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">errUniqueConflict</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">dbt</span> <span class="o">:=</span> <span class="nf">transFromDb</span><span class="p">(</span><span class="nx">db</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Gid</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">dbt</span><span class="p">.</span><span class="nx">Status</span> <span class="o">==</span> <span class="nx">dtmcli</span><span class="p">.</span><span class="nx">StatusPrepared</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">updates</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">setNextCron</span><span class="p">(</span><span class="nx">cronReset</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">dbr</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Must</span><span class="p">().</span><span class="nf">Model</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">TransGlobal</span><span class="p">{}).</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;gid=? and status=?&#34;</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Gid</span><span class="p">,</span> <span class="nx">dtmcli</span><span class="p">.</span><span class="nx">StatusPrepared</span><span class="p">).</span><span class="nf">Select</span><span class="p">(</span><span class="nb">append</span><span class="p">(</span><span class="nx">updates</span><span class="p">,</span> <span class="s">&#34;status&#34;</span><span class="p">)).</span><span class="nf">Updates</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nf">checkAffected</span><span class="p">(</span><span class="nx">dbr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">dbt</span><span class="p">.</span><span class="nx">Status</span> <span class="o">!=</span> <span class="nx">dtmcli</span><span class="p">.</span><span class="nx">StatusSubmitted</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span><span class="s">&#34;dtm_result&#34;</span><span class="p">:</span> <span class="nx">dtmcli</span><span class="p">.</span><span class="nx">ResultFailure</span><span class="p">,</span> <span class="s">&#34;message&#34;</span><span class="p">:</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;current status &#39;%s&#39;, cannot sumbmit&#34;</span><span class="p">,</span> <span class="nx">dbt</span><span class="p">.</span><span class="nx">Status</span><span class="p">)},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nf">Process</span><span class="p">(</span><span class="nx">db</span><span class="p">),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// å‡†å¤‡äº‹åŠ¡è¯·æ±‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">svcPrepare</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">TransGlobal</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">t</span><span class="p">.</span><span class="nx">Status</span> <span class="p">=</span> <span class="nx">dtmcli</span><span class="p">.</span><span class="nx">StatusPrepared</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">saveNew</span><span class="p">(</span><span class="nf">dbGet</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">  <span class="c1">////.........
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ä¸­æ–­äº‹åŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">svcAbort</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">TransGlobal</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">db</span> <span class="o">:=</span> <span class="nf">dbGet</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">dbt</span> <span class="o">:=</span> <span class="nf">transFromDb</span><span class="p">(</span><span class="nx">db</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Gid</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ......
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// æ³¨å†Œåˆ†æ”¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">svcRegisterBranch</span><span class="p">(</span><span class="nx">branch</span> <span class="o">*</span><span class="nx">TransBranch</span><span class="p">,</span> <span class="nx">data</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">ret</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">rerr</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="o">:=</span> <span class="nf">dbGet</span><span class="p">().</span><span class="nf">Transaction</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">dbt</span> <span class="o">:=</span> <span class="nf">transFromDb</span><span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="nx">branch</span><span class="p">.</span><span class="nx">Gid</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///.......
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>TMå¯¹æ•°æ®çš„å­˜å‚¨ç®¡ç†å¹¶ä¸æ˜¯ä¾èµ–äºæ¥å£ï¼Œè€Œæ˜¯ä¾èµ–äºcommon.DB ç»“æ„ã€‚æ ¹æ®é…ç½®æ–‡ä»¶ä¸­DB.driver çš„å€¼å†³å®šåº•å±‚æ•°æ®åº“æ˜¯mysqlè¿˜æ˜¯postgresä¸¤ç§ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">dbGet</span><span class="p">()</span> <span class="o">*</span><span class="nx">common</span><span class="p">.</span><span class="nx">DB</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="nx">common</span><span class="p">.</span><span class="nf">DbGet</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// DbGet get db connection for specified conf
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">DbGet</span><span class="p">(</span><span class="nx">conf</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">DB</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">dsn</span> <span class="o">:=</span> <span class="nx">dtmimp</span><span class="p">.</span><span class="nf">GetDsn</span><span class="p">(</span><span class="nx">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//.....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// GetDsn get dsn from map config
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">GetDsn</span><span class="p">(</span><span class="nx">conf</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">host</span> <span class="o">:=</span> <span class="nf">MayReplaceLocalhost</span><span class="p">(</span><span class="nx">conf</span><span class="p">[</span><span class="s">&#34;host&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">   <span class="nx">driver</span> <span class="o">:=</span> <span class="nx">conf</span><span class="p">[</span><span class="s">&#34;driver&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="nx">dsn</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;mysql&#34;</span><span class="p">:</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%s:%s@tcp(%s:%s)/%s?charset=utf8mb4&amp;parseTime=true&amp;loc=Local&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="nx">conf</span><span class="p">[</span><span class="s">&#34;user&#34;</span><span class="p">],</span> <span class="nx">conf</span><span class="p">[</span><span class="s">&#34;password&#34;</span><span class="p">],</span> <span class="nx">host</span><span class="p">,</span> <span class="nx">conf</span><span class="p">[</span><span class="s">&#34;port&#34;</span><span class="p">],</span> <span class="nx">conf</span><span class="p">[</span><span class="s">&#34;database&#34;</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;postgres&#34;</span><span class="p">:</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;host=%s user=%s password=%s dbname=&#39;%s&#39; port=%s sslmode=disable&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="nx">host</span><span class="p">,</span> <span class="nx">conf</span><span class="p">[</span><span class="s">&#34;user&#34;</span><span class="p">],</span> <span class="nx">conf</span><span class="p">[</span><span class="s">&#34;password&#34;</span><span class="p">],</span> <span class="nx">conf</span><span class="p">[</span><span class="s">&#34;database&#34;</span><span class="p">],</span> <span class="nx">conf</span><span class="p">[</span><span class="s">&#34;port&#34;</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">   <span class="p">}[</span><span class="nx">driver</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="nf">PanicIf</span><span class="p">(</span><span class="nx">dsn</span> <span class="o">==</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unknow driver: %s&#34;</span><span class="p">,</span> <span class="nx">driver</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="nx">dsn</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å†çœ‹è¿™ä¸ªDBç»“æ„ï¼Œæ‰€ä»¥æœ¬è´¨ä¸Šæ— è®ºåº•å±‚æ˜¯å“ªç§æ•°æ®åº“ï¼Œéƒ½æ˜¯ç›´æ¥ä¾èµ–gormæ¥å¯¹æ•°æ®è¿›è¡Œæ“ä½œçš„ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// DB provide more func over gorm.DB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">DB</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æ¥ç€ï¼Œçœ‹ä¸‹TMæ˜¯å¦‚ä½•é€šçŸ¥å„ä¸ªRMè¿›è¡Œcommitæˆ–è€…rollbackçš„ï¼Ÿ</p>
<p>ä¸¾ä¸€ä¸ªTCCæ¨¡å¼çš„ä¾‹å­ã€‚</p>
<p>TCCçš„ä¸¤ä¸ªé˜¶æ®µã€‚</p>
<ul>
<li>é˜¶æ®µä¸€: tryã€‚å°è¯•æ‰§è¡Œï¼Œè°ƒç”¨å„RMè‡ªå®šä¹‰çš„tryè¡Œä¸ºï¼Œé¢„ç•™å¿…è¦çš„ä¸šåŠ¡èµ„æºã€‚</li>
<li>é˜¶æ®µäºŒ:Confirm(é˜¶æ®µä¸€æ‰€æœ‰å‚ä¸æœ¬æ¬¡äº‹åŠ¡çš„tryè¡Œä¸ºéƒ½æˆåŠŸ)ã€‚è°ƒç”¨å„åˆ†æ”¯äº‹åŠ¡çš„Confirmæ–¹æ³•ï¼ŒçœŸæ­£æ‰§è¡Œä¸šåŠ¡ï¼Œå¹¶ä¸”åªä½¿ç”¨tryé˜¶æ®µé¢„ç•™çš„èµ„æºã€‚</li>
<li>é˜¶æ®µäºŒ:Cancel(é˜¶æ®µä¸€ä»»ä¸€å‚ä¸æœ¬æ¬¡äº‹åŠ¡çš„tryè¡Œä¸ºå¤±è´¥)ã€‚è°ƒç”¨å„åˆ†æ”¯äº‹åŠ¡çš„Cancelæ–¹æ³•ï¼Œé‡Šæ”¾ä¸€é˜¶æ®µtryæ‰€é¢„ç•™çš„èµ„æºã€‚</li>
</ul>
<p>ä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼ŒTCCæ¨¡å¼ä¸‹ï¼ŒTMåœ¨ç¬¬äºŒé˜¶æ®µè¦ä¹ˆé€šçŸ¥å„åˆ†æ”¯äº‹åŠ¡Confirmè¦ä¹ˆCancelã€‚</p>
<p>åœ¨æ³¨å†Œå„RMäº‹åŠ¡åˆ†æ”¯åˆ°TMçš„æ—¶å€™ï¼Œæœ€ç»ˆTMä¼šä¸ºæ¯ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡çš„å‚ä¸è€…(RM)ç”Ÿæˆä¸¤æ¡åˆ†æ”¯ä¿¡æ¯ã€‚</p>
<p>å°±åƒè¿™æ ·ï¼Œ</p>
<pre tabindex="0"><code>gid(åˆ†å¸ƒå¼äº‹åŠ¡id)  url(rmè¯·æ±‚åœ°å€)    data(æ•°æ®)   op(æ“ä½œç±»å‹æ¯”å¦‚:confirmï½œcancel)
520xxx           xxx.com/confirm    xxx.          confirm
520xxx           xxx.com/cancel     xxx           cancel
</code></pre><p>å¯¹ï¼Œå°±æ˜¯æŠŠå¯¹åº”çš„RMèµ„æºæ“ä½œåœ°å€ç›´æ¥å­˜å…¥ã€‚</p>
<p>å½“TMæ¥æ”¶åˆ°commitæˆ–è€…rollbackå‘½ä»¤ï¼Œåœ¨å¤„ç†å®Œè‡ªèº«é€»è¾‘(ä¸€èˆ¬å°±æ˜¯ä¿®æ”¹GloableçŠ¶æ€)ï¼Œå°±éœ€è¦å¼€å§‹å¤„ç†æ¯ä¸€ä¸ªæ³¨å†Œè¿›æ¥çš„åˆ†æ”¯äº‹åŠ¡äº†ï¼Œè¯´ç™½äº†å°±æ˜¯éœ€è¦è°ƒç”¨å„ä¸ªåˆ†æ”¯äº‹åŠ¡å¯¹åº”æ“ä½œçš„æ¥å£ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">TransGlobal</span><span class="p">)</span> <span class="nf">processInner</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">common</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="p">(</span><span class="nx">rerr</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">branches</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">TransBranch</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">db</span><span class="p">.</span><span class="nf">Must</span><span class="p">().</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;gid=?&#34;</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Gid</span><span class="p">).</span><span class="nf">Order</span><span class="p">(</span><span class="s">&#34;id asc&#34;</span><span class="p">).</span><span class="nf">Find</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">branches</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">t</span><span class="p">.</span><span class="nx">lastTouched</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rerr</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">getProcessor</span><span class="p">().</span><span class="nf">ProcessOnce</span><span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="nx">branches</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¿™é‡Œçš„t.getProcessor() æ˜¯éœ€è¦æ ¹æ®å½“å‰äº‹åŠ¡çš„ç±»å‹(TCCã€SAGAã€XA)è·å–åˆ°å¯¹åº”çš„å¤„ç†å™¨æ¥è¿›è¡Œé€»è¾‘çš„å¤„ç†ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">TransGlobal</span><span class="p">)</span> <span class="nf">getProcessor</span><span class="p">()</span> <span class="nx">transProcessor</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">processorFac</span><span class="p">[</span><span class="nx">t</span><span class="p">.</span><span class="nx">TransType</span><span class="p">](</span><span class="nx">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å½“ç„¶ï¼Œæ¯ä¸ªäº‹åŠ¡å¤„ç†å™¨åªéœ€è¦å®ç°æ¥å£ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">transProcessor</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">GenBranches</span><span class="p">()</span> <span class="p">[]</span><span class="nx">TransBranch</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ProcessOnce</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">common</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">branches</span> <span class="p">[]</span><span class="nx">TransBranch</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>çœŸæ­£è°ƒç”¨RMèµ„æºæœåŠ¡åœ°å€çš„æ—¶å€™ï¼Œåˆ†ä¸ºhttpå’Œgrpcï¼Œè¿™æ˜¯ç”±å¼€å‘è€…å†³å®šçš„ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">TransGlobal</span><span class="p">)</span> <span class="nf">getURLResult</span><span class="p">(</span><span class="nx">url</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">branchID</span><span class="p">,</span> <span class="nx">op</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">branchPayload</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Protocol</span> <span class="o">==</span> <span class="s">&#34;grpc&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">dtmimp</span><span class="p">.</span><span class="nf">PanicIf</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nf">HasPrefix</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="s">&#34;http&#34;</span><span class="p">),</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;bad url for grpc: %s&#34;</span><span class="p">,</span> <span class="nx">url</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="nx">server</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dtmdriver</span><span class="p">.</span><span class="nf">GetDriver</span><span class="p">().</span><span class="nf">ParseServerMethod</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">conn</span> <span class="o">:=</span> <span class="nx">dtmgimp</span><span class="p">.</span><span class="nf">MustGetGrpcConn</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">dtmgimp</span><span class="p">.</span><span class="nf">TransInfo2Ctx</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">Gid</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">TransType</span><span class="p">,</span> <span class="nx">branchID</span><span class="p">,</span> <span class="nx">op</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="p">=</span> <span class="nx">conn</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">branchPayload</span><span class="p">,</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">dtmimp</span><span class="p">.</span><span class="nf">PanicIf</span><span class="p">(!</span><span class="nx">strings</span><span class="p">.</span><span class="nf">HasPrefix</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="s">&#34;http&#34;</span><span class="p">),</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;bad url for http: %s&#34;</span><span class="p">,</span> <span class="nx">url</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dtmimp</span><span class="p">.</span><span class="nx">RestyClient</span><span class="p">.</span><span class="nf">R</span><span class="p">().</span><span class="nf">SetBody</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">branchPayload</span><span class="p">)).</span>
</span></span><span class="line"><span class="cl">		<span class="nf">SetQueryParams</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="s">&#34;gid&#34;</span><span class="p">:</span>        <span class="nx">t</span><span class="p">.</span><span class="nx">Gid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="s">&#34;trans_type&#34;</span><span class="p">:</span> <span class="nx">t</span><span class="p">.</span><span class="nx">TransType</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="s">&#34;branch_id&#34;</span><span class="p">:</span>  <span class="nx">branchID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="s">&#34;op&#34;</span><span class="p">:</span>         <span class="nx">op</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">}).</span>
</span></span><span class="line"><span class="cl">		<span class="nf">SetHeader</span><span class="p">(</span><span class="s">&#34;Content-type&#34;</span><span class="p">,</span> <span class="s">&#34;application/json&#34;</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">		<span class="nf">Execute</span><span class="p">(</span><span class="nx">dtmimp</span><span class="p">.</span><span class="nf">If</span><span class="p">(</span><span class="nx">branchPayload</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">t</span><span class="p">.</span><span class="nx">TransType</span> <span class="o">==</span> <span class="s">&#34;xa&#34;</span><span class="p">,</span> <span class="s">&#34;POST&#34;</span><span class="p">,</span> <span class="s">&#34;GET&#34;</span><span class="p">).(</span><span class="kt">string</span><span class="p">),</span> <span class="nx">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">resp</span><span class="p">.</span><span class="nf">String</span><span class="p">(),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>åœ¨v1.6ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œgrpcçš„è¯·æ±‚æ˜¯å¾ˆç®€å•ç²—æš´è§£æåœ°å€æ–¹æ³•ç„¶åè¿æ¥çš„ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//v1.6ä¹‹å‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">TransGlobal</span><span class="p">)</span> <span class="nf">getURLResult</span><span class="p">(</span><span class="nx">url</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">branchID</span><span class="p">,</span> <span class="nx">op</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">branchPayload</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Protocol</span> <span class="o">==</span> <span class="s">&#34;grpc&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">dtmimp</span><span class="p">.</span><span class="nf">PanicIf</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nf">HasPrefix</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="s">&#34;http&#34;</span><span class="p">),</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;bad url for grpc: %s&#34;</span><span class="p">,</span> <span class="nx">url</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="nx">server</span><span class="p">,</span> <span class="nx">method</span> <span class="o">:=</span> <span class="nx">dtmgimp</span><span class="p">.</span><span class="nf">GetServerAndMethod</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">conn</span> <span class="o">:=</span> <span class="nx">dtmgimp</span><span class="p">.</span><span class="nf">MustGetGrpcConn</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">dtmgimp</span><span class="p">.</span><span class="nf">TransInfo2Ctx</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">Gid</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">TransType</span><span class="p">,</span> <span class="nx">branchID</span><span class="p">,</span> <span class="nx">op</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">branchPayload</span><span class="p">,</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">dtmcli</span><span class="p">.</span><span class="nx">ResultSuccess</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//......
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">GetServerAndMethod</span><span class="p">(</span><span class="nx">grpcURL</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fs</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">grpcURL</span><span class="p">,</span> <span class="s">&#34;/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">server</span> <span class="o">:=</span> <span class="nx">fs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="nx">method</span> <span class="o">:=</span> <span class="s">&#34;/&#34;</span> <span class="o">+</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">fs</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s">&#34;/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">server</span><span class="p">,</span> <span class="nx">method</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ç°åœ¨ä¸ºäº†æ”¯æŒé‚£äº›é‡‡ç”¨gRPC Resolver æœºåˆ¶ä¹‹ä¸Šçš„ä¸€äº›å¾®æœåŠ¡æ¡†æ¶æ¥å…¥ï¼Œåšäº†ä¸€å—æŠ½è±¡ã€‚æ„Ÿå…´è¶£å¯ä»¥çœ‹ä¸‹ï¼Œè¿™é‡Œå°±ä¸ä»‹ç»äº†ã€‚</p>
<h3 id="sdk">SDK</h3>
<p>è‡³äºSDKï¼Œæ¯ä¸€ä¸ªäº‹åŠ¡æ¨¡å¼éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œæœ¬è´¨ä¸Šæ˜¯æ²¡æœ‰å…³è”çš„ã€‚æ¯”å¦‚ä¸‹é¢æˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªTCCåˆ†å¸ƒå¼äº‹åŠ¡ã€‚è¿™ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡æ˜¯ç”±ä¸¤ä¸ªæœåŠ¡ç»„æˆï¼Œç®€ç§°+30å’Œ-30çš„æœåŠ¡ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">gid</span> <span class="o">:=</span> <span class="nx">dtmcli</span><span class="p">.</span><span class="nf">MustGenGid</span><span class="p">(</span><span class="nx">DtmHttpServer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">err</span> <span class="o">:=</span> <span class="nx">dtmcli</span><span class="p">.</span><span class="nf">TccGlobalTransaction</span><span class="p">(</span><span class="nx">DtmHttpServer</span><span class="p">,</span> <span class="nx">gid</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">tcc</span> <span class="o">*</span><span class="nx">dtmcli</span><span class="p">.</span><span class="nx">Tcc</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">resty</span><span class="p">.</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tcc</span><span class="p">.</span><span class="nf">CallBranch</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">TransReq</span><span class="p">{</span><span class="nx">Amount</span><span class="p">:</span> <span class="mi">30</span><span class="p">},</span> <span class="nx">Busi</span><span class="o">+</span><span class="s">&#34;/TransOut&#34;</span><span class="p">,</span> <span class="nx">Busi</span><span class="o">+</span><span class="s">&#34;/TransOutConfirm&#34;</span><span class="p">,</span> <span class="nx">Busi</span><span class="o">+</span><span class="s">&#34;/TransOutRevert&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">tcc</span><span class="p">.</span><span class="nf">CallBranch</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">TransReq</span><span class="p">{</span><span class="nx">Amount</span><span class="p">:</span> <span class="mi">30</span><span class="p">},</span> <span class="nx">Busi</span><span class="o">+</span><span class="s">&#34;/TransIn&#34;</span><span class="p">,</span> <span class="nx">Busi</span><span class="o">+</span><span class="s">&#34;/TransInConfirm&#34;</span><span class="p">,</span> <span class="nx">Busi</span><span class="o">+</span><span class="s">&#34;/TransInRevert&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// dtm dtmæœåŠ¡å™¨åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1">// gid å…¨å±€äº‹åŠ¡id
</span></span></span><span class="line"><span class="cl"><span class="c1">// tccFunc tccäº‹åŠ¡å‡½æ•°ï¼Œé‡Œé¢ä¼šå®šä¹‰å…¨å±€äº‹åŠ¡çš„åˆ†æ”¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">TccGlobalTransaction</span><span class="p">(</span><span class="nx">dtm</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">gid</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">tccFunc</span> <span class="nx">TccGlobalFunc</span><span class="p">)</span> <span class="p">(</span><span class="nx">rerr</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tcc</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Tcc</span><span class="p">{</span><span class="nx">TransBase</span><span class="p">:</span> <span class="o">*</span><span class="nx">dtmimp</span><span class="p">.</span><span class="nf">NewTransBase</span><span class="p">(</span><span class="nx">gid</span><span class="p">,</span> <span class="s">&#34;tcc&#34;</span><span class="p">,</span> <span class="nx">dtm</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rerr</span> <span class="p">=</span> <span class="nx">dtmimp</span><span class="p">.</span><span class="nf">TransCallDtm</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">tcc</span><span class="p">.</span><span class="nx">TransBase</span><span class="p">,</span> <span class="nx">tcc</span><span class="p">,</span> <span class="s">&#34;prepare&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">rerr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">rerr</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// å°æ¦‚ç‡æƒ…å†µä¸‹ï¼ŒprepareæˆåŠŸäº†ï¼Œä½†æ˜¯ç”±äºç½‘ç»œçŠ¶å†µå¯¼è‡´ä¸Šé¢Failureï¼Œé‚£ä¹ˆä¸æ‰§è¡Œä¸‹é¢deferçš„å†…å®¹ï¼Œç­‰å¾…è¶…æ—¶åå†å›æ»šæ ‡è®°äº‹åŠ¡å¤±è´¥ï¼Œä¹Ÿæ²¡æœ‰é—®é¢˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">x</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">operation</span> <span class="o">:=</span> <span class="nx">dtmimp</span><span class="p">.</span><span class="nf">If</span><span class="p">(</span><span class="nx">x</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">rerr</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">,</span> <span class="s">&#34;submit&#34;</span><span class="p">,</span> <span class="s">&#34;abort&#34;</span><span class="p">).(</span><span class="kt">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="o">:=</span> <span class="nx">dtmimp</span><span class="p">.</span><span class="nf">TransCallDtm</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">tcc</span><span class="p">.</span><span class="nx">TransBase</span><span class="p">,</span> <span class="nx">tcc</span><span class="p">,</span> <span class="nx">operation</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">rerr</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">rerr</span> <span class="p">=</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">x</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nb">panic</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span><span class="p">,</span> <span class="nx">rerr</span> <span class="p">=</span> <span class="nf">tccFunc</span><span class="p">(</span><span class="nx">tcc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// CallBranch call a tcc branch
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">Tcc</span><span class="p">)</span> <span class="nf">CallBranch</span><span class="p">(</span><span class="nx">body</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">tryURL</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">confirmURL</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">cancelURL</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">resty</span><span class="p">.</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">branchID</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">NewSubBranchID</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">dtmimp</span><span class="p">.</span><span class="nf">TransRegisterBranch</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">t</span><span class="p">.</span><span class="nx">TransBase</span><span class="p">,</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;data&#34;</span><span class="p">:</span>        <span class="nx">dtmimp</span><span class="p">.</span><span class="nf">MustMarshalString</span><span class="p">(</span><span class="nx">body</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;branch_id&#34;</span><span class="p">:</span>   <span class="nx">branchID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">BranchConfirm</span><span class="p">:</span> <span class="nx">confirmURL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">BranchCancel</span><span class="p">:</span>  <span class="nx">cancelURL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="s">&#34;registerTccBranch&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">dtmimp</span><span class="p">.</span><span class="nf">TransRequestBranch</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">t</span><span class="p">.</span><span class="nx">TransBase</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">branchID</span><span class="p">,</span> <span class="nx">BranchTry</span><span class="p">,</span> <span class="nx">tryURL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ä»ä¸Šé¢çš„è°ƒç”¨ä¸­æˆ‘ä»¬è¿˜æ˜¯èƒ½è¿˜åŸå‡ºæ•´ä½“æµç¨‹ã€‚</p>
<ul>
<li>è°ƒç”¨TMï¼Œå¾—åˆ°ä¸€ä¸ªåˆ†å¸ƒå¼id</li>
<li>è°ƒç”¨TccGlobalTransactionå‡½æ•°å¼€å¯åˆ†å¸ƒå¼äº‹åŠ¡ã€‚</li>
<li>è°ƒç”¨TM prepare(è¿™æ­¥åªæ˜¯ä¸ºäº†æŸ¥çœ‹ç¬¬ä¸€æ­¥äº§ç”Ÿçš„é‚£ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡çŠ¶æ€æ˜¯å¦å¤„äºprepareã€‚è¿™é‡Œæ²¡çœ‹æ˜ç™½ï¼Œæ­¤æ—¶è¿˜æœªæ³¨å†Œæ‰§è¡Œåˆ†æ”¯ï¼Œå…¨å±€çŠ¶æ€ä¸æ˜¯åº”è¯¥åªä¼šå­˜åœ¨åˆå§‹åŒ–çŠ¶æ€å—)</li>
<li>ä¸Šä¸€æ­¥æ²¡é—®é¢˜ï¼Œæ‰§è¡Œä¼ å…¥çš„é—­åŒ…å‡½æ•°ï¼Œå³CallBranch å‡½æ•°é‡Œå‘TMæ³¨å†Œå‚ä¸äº‹åŠ¡çš„TMåˆ†æ”¯ã€‚æ³¨å†Œå®Œæˆåï¼Œå¼€å§‹ç¬¬ä¸€é˜¶æ®µè°ƒç”¨å„åˆ†æ”¯çš„tryæœåŠ¡ã€‚</li>
<li>å„åˆ†æ”¯tryæœåŠ¡è°ƒç”¨ç»“æŸï¼Œæ ¹æ®ç¬¬ä¸€é˜¶æ®µç»“æœå†³å®šé€šçŸ¥TMæ˜¯submitè¿˜æ˜¯abortã€‚</li>
</ul>
<p>ä»£ç è¿˜æ˜¯å¾ˆå¥½æ‡‚çš„ã€‚</p>
<p>å¦å¤–æä¸€ç‚¹ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡å¸¸è§çš„ä¸€äº›é—®é¢˜:æ¯”å¦‚ç©ºè¡¥å¿ã€é‡æŒ‚ç­‰é—®é¢˜ã€‚</p>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸šåŠ¡éœ€è¦è‡ªè¡Œå»å¤„ç†è¿™ç§åœºæ™¯ï¼Œä»¥å…é€ æˆä¸å¯æè¿°çš„é”™è¯¯ã€‚</p>
<p>dtmé‡Œé¢æä¾›äº†å¯¹åº”å­äº‹åŠ¡å±éšœæ–¹æ¡ˆã€‚æ ¸å¿ƒå°±åœ¨ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">  <span class="nx">originAffected</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nf">insertBarrier</span><span class="p">(</span><span class="nx">tx</span><span class="p">,</span> <span class="nx">ti</span><span class="p">.</span><span class="nx">TransType</span><span class="p">,</span> <span class="nx">ti</span><span class="p">.</span><span class="nx">Gid</span><span class="p">,</span> <span class="nx">ti</span><span class="p">.</span><span class="nx">BranchID</span><span class="p">,</span> <span class="nx">originType</span><span class="p">,</span> <span class="nx">bid</span><span class="p">,</span> <span class="nx">ti</span><span class="p">.</span><span class="nx">Op</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">currentAffected</span><span class="p">,</span> <span class="nx">rerr</span> <span class="o">:=</span> <span class="nf">insertBarrier</span><span class="p">(</span><span class="nx">tx</span><span class="p">,</span> <span class="nx">ti</span><span class="p">.</span><span class="nx">TransType</span><span class="p">,</span> <span class="nx">ti</span><span class="p">.</span><span class="nx">Gid</span><span class="p">,</span> <span class="nx">ti</span><span class="p">.</span><span class="nx">BranchID</span><span class="p">,</span> <span class="nx">ti</span><span class="p">.</span><span class="nx">Op</span><span class="p">,</span> <span class="nx">bid</span><span class="p">,</span> <span class="nx">ti</span><span class="p">.</span><span class="nx">Op</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">dtmimp</span><span class="p">.</span><span class="nf">Logf</span><span class="p">(</span><span class="s">&#34;originAffected: %d currentAffected: %d&#34;</span><span class="p">,</span> <span class="nx">originAffected</span><span class="p">,</span> <span class="nx">currentAffected</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nx">ti</span><span class="p">.</span><span class="nx">Op</span> <span class="o">==</span> <span class="nx">BranchCancel</span> <span class="o">||</span> <span class="nx">ti</span><span class="p">.</span><span class="nx">Op</span> <span class="o">==</span> <span class="nx">BranchCompensate</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">originAffected</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="c1">// è¿™ä¸ªæ˜¯ç©ºè¡¥å¿
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">currentAffected</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span> <span class="c1">// è¿™ä¸ªæ˜¯é‡å¤è¯·æ±‚æˆ–è€…æ‚¬æŒ‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rerr</span> <span class="p">=</span> <span class="nf">busiCall</span><span class="p">(</span><span class="nx">tx</span><span class="p">)</span>
</span></span></code></pre></div><p>å…¶å®å°±æ˜¯åˆ©ç”¨æ•°æ®åº“çš„å”¯ä¸€ç´¢å¼•æœºåˆ¶ï¼Œå½“ç„¶æ¯ä¸ªRMèµ„æºä½ éƒ½å¾—æ–°å¢ä¸€å¼ è¡¨ã€‚</p>
<p>ä¸Šé¢æåˆ°ï¼Œdtmçš„TMè§’è‰²æœ¬è´¨ä¸Šå°±æ˜¯å¯¹åº” seata ä¸­çš„ TCï¼Œä½†æ˜¯ä»–ä»¬çš„å¤„ç†æ¨¡å¼æ˜¯ä¸åŒçš„ã€‚</p>
<p>dtmä¸­çš„TMä¼šæ ¹æ®æ³¨å†Œæ—¶çš„å„åˆ†æ”¯ä¿å­˜çš„åœ°å€ï¼Œå†³å®šé€šè¿‡httpè¿˜æ˜¯rpcè°ƒç”¨å„RMæ“ä½œï¼Œæ˜¯ç”±TMç›´æ¥å‘èµ·å¯¹RMçš„è¯·æ±‚ã€‚</p>
<p>seata-goçš„å®ç°ä¸­ï¼ŒTCæ˜¯ä¸å‚ä¸ç›´æ¥è°ƒç”¨RMçš„ã€‚</p>
<p>è¿˜è®°å¾—ä¸Šç¯‡æåˆ°ä¸€ä¸ªåŒå‘æµRPCæ¥å£(BranchCommunicate)ã€‚TCé€šè¿‡è¿™ä¸ªæ¥å£æŠŠå¯¹åº”åˆ†æ”¯å¤„ç†ä¿¡æ¯ä¼ é€’ç»™RMç®¡ç†å™¨ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// ........
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">switch</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">BranchMessageType</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// åˆ†æ”¯commitæ¶ˆæ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">case</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">TypeBranchCommit</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="nx">request</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchCommitRequest</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">				<span class="nx">data</span> <span class="o">:=</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">GetMessage</span><span class="p">().</span><span class="nf">GetValue</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">				<span class="nx">err</span> <span class="o">:=</span> <span class="nx">request</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="k">continue</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="nx">response</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">manager</span><span class="p">.</span><span class="nf">BranchCommit</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">content</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">types</span><span class="p">.</span><span class="nf">MarshalAny</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="nx">manager</span><span class="p">.</span><span class="nx">branchMessages</span> <span class="o">&lt;-</span> <span class="o">&amp;</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchMessage</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">							<span class="nx">ID</span><span class="p">:</span>                <span class="nx">msg</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">							<span class="nx">BranchMessageType</span><span class="p">:</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">TypeBranchCommitResult</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">							<span class="nx">Message</span><span class="p">:</span>           <span class="nx">content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">						<span class="p">}</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// åˆ†æ”¯rollbackæ¶ˆæ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">case</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">TypeBranchRollback</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//........
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//....
</span></span></span></code></pre></div><p>ç„¶åç”±RMç®¡ç†å™¨æ ¹æ®äº‹åŠ¡ç±»å‹é€‰æ‹©å¯¹åº”çš„äº‹åŠ¡ç®¡ç†å™¨è¿›è¡Œå¤„ç†ï¼Œæœ€ç»ˆè°ƒç”¨çš„æ˜¯å¯¹åº”äº‹åŠ¡ç±»å‹ç®¡ç†å™¨çš„BranchCommitæ–¹æ³•ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// åˆ†æ”¯commit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">manager</span> <span class="nx">ResourceManager</span><span class="p">)</span> <span class="nf">BranchCommit</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">request</span> <span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchCommitRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchCommitResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rm</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">managers</span><span class="p">[</span><span class="nx">request</span><span class="p">.</span><span class="nx">BranchType</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">rm</span><span class="p">.</span><span class="nf">BranchCommit</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchCommitResponse</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ResultCode</span><span class="p">:</span> <span class="nx">apis</span><span class="p">.</span><span class="nx">ResultCodeFailed</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Message</span><span class="p">:</span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;there is no resource manager for %s&#34;</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">BranchType</span><span class="p">.</span><span class="nf">String</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ä¸‹é¢æ˜¯ä¸€ä¸ªTCCäº‹åŠ¡ç±»å‹ç®¡ç†å™¨çš„å¤„ç†ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// åªç•™æ ¸å¿ƒä»£ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">resourceManager</span> <span class="nx">TCCResourceManager</span><span class="p">)</span> <span class="nf">BranchCommit</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">request</span> <span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchCommitRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">apis</span><span class="p">.</span><span class="nx">BranchCommitResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">resource</span> <span class="o">:=</span> <span class="nx">resourceManager</span><span class="p">.</span><span class="nx">ResourceCache</span><span class="p">[</span><span class="nx">request</span><span class="p">.</span><span class="nx">ResourceID</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">resource</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tccResource</span> <span class="o">:=</span> <span class="nx">resource</span><span class="p">.(</span><span class="o">*</span><span class="nx">TCCResource</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">tccResource</span><span class="p">.</span><span class="nx">CommitMethod</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// .....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">result</span> <span class="o">:=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">	<span class="nx">businessActionContext</span> <span class="o">:=</span> <span class="nf">getBusinessActionContext</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">XID</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">BranchID</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">ResourceID</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">ApplicationData</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">args</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kd">interface</span><span class="p">{},</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">args</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">businessActionContext</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// æœ€ç»ˆæ‰§è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">returnValues</span> <span class="o">:=</span> <span class="nx">proxy</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="nx">tccResource</span><span class="p">.</span><span class="nx">CommitMethod</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>å¯¹åº”çš„äº‹åŠ¡RMç®¡ç†å™¨æ˜¯å¦‚ä½•é€šçŸ¥ã€å¤„ç†å„ä¸ªRMèµ„æºçš„ã€‚åŸç†å°±æ˜¯æˆ‘ä¸Šç¯‡æåˆ°çš„ä½œè€…å®ç°çš„ä¸€ä¸ªå…¨å±€äº‹åŠ¡ä»£ç†æ¨¡å¼ï¼Œæœ¬è´¨ä¸Šæ˜¯åˆ©ç”¨goçš„åå°„å®ç°çš„ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªå·±å»æ‰’ä¸‹æºç ï¼Œä¹Ÿå¯ä»¥çœ‹çœ‹ä½œè€…å¯¹å®ç°å…¨å±€äº‹åŠ¡ä»£ç†çš„ä»‹ç»ã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†dtmå®ç°çš„ä¸€äº›ç»†èŠ‚ï¼Œä»è¿™ä¸¤ç¯‡æ–‡ç« å¤§ä½“èƒ½çœ‹å‡ºå®ç°ä¸Šçš„éƒ¨åˆ†åŒºåˆ«ï¼Œæ›´å¤šçš„ç»†èŠ‚è¿˜å¾—é è‡ªå·±å»æŒ–æ˜ã€‚</p>
<p>æœ€åå†é—®å‡ ä¸ªé—®é¢˜ï¼Œ</p>
<ul>
<li>æ—¥å¸¸å¼€å‘ä¸­ä½ ä»¬å“ªäº›åœºæ™¯æ˜¯ç”¨åˆ°äº†åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿç”¨çš„æ˜¯å“ªä¸ªæ¡†æ¶è¿˜æ˜¯è‡ªç ”çš„ï¼Ÿ</li>
<li>æˆ–è€…è¯´åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œä¸€è‡´æ€§çš„é—®é¢˜ä½ ä»¬æ˜¯å¦‚ä½•è§£å†³çš„ï¼Ÿ</li>
</ul>
<h3 id="ç›¸å…³æ–‡ç« ">ç›¸å…³æ–‡ç« </h3>
<ul>
<li><a href="https://dtm.pub/protocol/support.html">https://dtm.pub/protocol/support.html</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/351391359">https://zhuanlan.zhihu.com/p/351391359</a></li>
</ul>
]]></content>
		</item>
		
		<item>
			<title>channelåŸç†è§£æ(ä¸‰)</title>
			<link>https://www.syst.top/posts/go/channel3/</link>
			<pubDate>Sun, 10 Oct 2021 21:25:52 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/channel3/</guid>
			<description>ä¸Šä¸€ç¯‡æ–‡ç« ä¸»è¦é€šè¿‡ä¸€ä¸ªç°å®ä¾‹å­é—´æ¥åæ˜ channelçš„ä¸€äº›åŸç†ã€‚æœ€åä¸€ç¯‡å¼€å§‹ä»‹ç»ä¸€äº›ç»†èŠ‚ï¼Œä¼šæ¶‰åŠåˆ°æºç ã€‚
è¿˜æ˜¯ä»ä¸€ä¸ªç®€å•çš„ä»£ç ç¨‹åºçœ‹èµ·ã€‚
æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ— ç¼“å†²channelï¼Œç„¶åå¾€è¿™ä¸ªchannelå‘é€æ•°æ®ã€‚å› ä¸ºç¨‹åºä¸­æ²¡æœ‰è¯»æ“ä½œreadyï¼Œæ‰€ä»¥å‘é€çš„æ—¶å€™ä¼šé˜»å¡ã€‚æˆ‘ä»¬é€šè¿‡æ±‡ç¼–ä»£ç çœ‹å®ƒåº•å±‚çš„è°ƒç”¨ã€‚
ä»å›¾ä¸­æˆ‘ä»¬çœ‹åˆ°ï¼Œä¸Šè¿°å‘é€æ“ä½œï¼Œç¨‹åºè¿è¡Œæ—¶å®é™…è°ƒç”¨çš„runtime.chansend1ã€‚
æœ€ç»ˆchansend1æœ€ç»ˆè°ƒç”¨çš„è¿˜æ˜¯chansendï¼Œchansendçš„ç¬¬ä¸‰ä¸ªå‚æ•°blockæ˜¯ä¸ªboolå€¼ï¼Œè¡¨ç¤ºæ“ä½œchannelä¸èƒ½ç«‹å³æˆåŠŸæ—¶æ˜¯å¦éœ€è¦é˜»å¡ã€‚
å…·ä½“å“ªäº›æ“ä½œï¼Ÿ
 å‘æ— ç¼“å†²channelå‘é€æ•°æ®ä¸”å½“å‰æ— æ¥æ”¶è€…readyã€‚ æ¥æ”¶æ— ç¼“å†²channelæ•°æ®ä¸”å½“å‰æ— å‘é€è€…readyã€‚ ç¼“å†²channelå·²æ»¡ï¼Œå¾€channelå‘é€æ•°æ®ã€‚ ç¼“å†²channelä¸ºç©ºï¼Œæ¥æ”¶channelæ•°æ® å‘ä¸€ä¸ªnilçš„channelå‘é€æ•°æ®ã€‚(æ³¨æ„ï¼Œå‘ä¸€ä¸ªnilçš„channelå‘é€æ•°æ®å¹¶ä¸ä¼šå¼•å‘panic)ã€‚ å‘ä¸€ä¸ªnilçš„channelæ¥æ”¶æ•°æ®ã€‚  ç¢°åˆ°ä¸Šé¢çš„æ“ä½œï¼Œå¦‚æœä¸æ˜¯ç‰¹æ®Šå¤„ç†ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¼šè¢«é˜»å¡ï¼Œç›´åˆ°è¢«å”¤é†’ã€‚
å½“ç„¶å¯¹äºå‘nilçš„channelå‘é€|æ¥æ”¶æ•°æ®ï¼Œåç»­å†ä¹Ÿæ²¡æœºä¼šè¢«å”¤é†’äº†ã€‚
é‚£ä¹ˆå¦‚æœæ˜¯å¿«é€Ÿè¯•é”™çš„åœºæ™¯ï¼Œæ˜¯ä¸æ˜¯åªè¦æŠŠblockæ”¹æˆfalseï¼Œåœ¨å¤±è´¥çš„åœºæ™¯ä¸‹å°±ä¸ä¼šè¢«é˜»å¡äº†ã€‚
ç¼–è¯‘è¿™æ®µä»£ç ã€‚
å¯ä»¥çœ‹å‡ºï¼Œä¸Šé¢è¿™æ®µä»£ç ç¼–è¯‘åè°ƒç”¨selectnbsendæœ€ç»ˆå‘é€åŠ¨ä½œè°ƒç”¨çš„è¿˜æ˜¯chansnedï¼Œåªæ˜¯ä¼ å…¥çš„blockæ˜¯falseã€‚è¿™æ ·ä¸€æ—¦æ“ä½œå¤±è´¥ï¼Œç¨‹åºä¸ä¼šè¢«é˜»å¡ã€‚
åŒç†æˆ‘ä»¬å¯ä»¥å¾—å‡ºæ¥æ”¶çš„è°ƒç”¨åŠ¨ä½œã€‚
åˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œ
å‘é€æ•°æ®ï¼Œæœ€ç»ˆè°ƒç”¨çš„runtime.chansendã€‚
æ¥æ”¶æ•°æ®ï¼Œæœ€ç»ˆè°ƒç”¨çš„runtime.chanrecvã€‚
æ¥ä¸‹æ¥æˆ‘ä»¬æ¥è¯´æ˜è¿™ä¸¤ä¸ªå‡½æ•°åº•å±‚æ˜¯å¦‚ä½•æ“ä½œçš„ã€‚
æˆ‘ä»¬è¿˜æ˜¯ä»¥ä¸€ä¸ªæ— ç¼“å†²çš„channelå’Œç¼“å†²channelæ¥è¯´æ˜ã€‚
æ¥çœ‹ä¸€æ®µç®€å•çš„ç¨‹åºã€‚
å€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨Goä¸­ä½¿ç”¨ go funcçš„æ—¶å€™ï¼Œæœ¬è´¨ä¸Šè°ƒç”¨çš„æ˜¯runtime.newprocåˆ›å»ºä¸€ä¸ªgï¼Œç„¶åæŠŠè¿™ä¸ªgäº¤ç»™è°ƒåº¦å™¨è°ƒåº¦ã€‚è‡³äºä»€ä¹ˆæ—¶å€™gè¢«è°ƒåº¦ï¼Œç„¶åæ‰§è¡Œä½ çš„ä»£ç é€»è¾‘ï¼Œé‚£å°±è¦çœ‹è°ƒåº¦å™¨çš„&amp;quot;å¿ƒæƒ…&amp;quot;äº†ã€‚
æ‰€ä»¥ä¸Šé¢åˆ›å»ºçš„ä¸¤ä¸ªg(æš‚ä¸”ç§°ä¸ºg1å’Œg2)ï¼Œå¯ä»¥çœ‹æˆæ˜¯æˆ‘ä»¬å‘è°ƒåº¦å™¨æäº¤äº†ä¸¤ä¸ªä»»åŠ¡gï¼Œæˆ‘ä»¬æ— æ³•ä¿è¯å“ªä¸ªgä¼šè¢«å…ˆè°ƒåº¦å™¨è°ƒåº¦æ‰§è¡Œï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿä¸ç¡®å®šå‘é€å’Œæ¥æ”¶è¿™ä¸¤ä¸ªæ“ä½œï¼Œè°ä¼šå…ˆè¢«æ‰§è¡Œã€‚
å‡è®¾g1å…ˆè¢«è°ƒåº¦å™¨è¿è¡Œï¼Œç„¶åæ‰§è¡Œä»£ç ch&amp;lt;-struct{}{}ã€‚
å¦‚æœg2å…ˆè¢«è°ƒåº¦å™¨è¿è¡Œï¼Œç„¶åæ‰§è¡Œä»£ç &amp;lt;-chã€‚
å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠä¸Šé¢çš„ä»£ç æ¢æˆç”»æˆè¯¦ç»†çš„æ— ç¼“å†²é˜Ÿåˆ—æ ¸å¿ƒæµç¨‹å›¾ã€‚
ç¼“å†²channelå‘é€çš„æ—¶å€™åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼Œæƒ³æƒ³æˆ‘ä»¬ä¸Šç¯‡æ–‡ç« å¿«é€’å‘˜é€å¿«é€’åœºæ™¯ã€‚
 å¦‚æœå¿«é€’æŸœæœªæ»¡ï¼Œç›´æ¥æŠŠå¿«é€’æ”¾å…¥åˆ°å¿«é€’æŸœã€‚(å¯¹åº”ç¼“å†²åŒºæœªæ»¡ï¼ŒæŠŠå‘é€æ•°æ®æ‹·è´åˆ°ç¼“å†²åŒº) å¦‚æœå¿«é€’æŸœæ»¡äº†ï¼Œé‚£å¿«é€’å‘˜åªèƒ½åœ¨é‚£ç­‰å¾…å¿«é€’æŸœç©ºäº†ã€‚(å¯¹åº”æŠŠå½“å‰gå°è£…æˆsudogï¼Œç„¶åæŠŠsudogæ”¾åˆ°ç­‰å¾…å‘é€æ¶ˆæ¯é˜Ÿåˆ—sendqä¸­ï¼Œæœ€åæŒ‚èµ·å½“å‰g) å¦‚æœé€å¿«é€’çš„æ—¶å€™æ­£å¥½å®¢æˆ·åœ¨é‚£é‡Œç­‰ï¼Œé‚£å°±ç›´æ¥æŠŠå¿«é€’ç»™ä»–å°±æ˜¯äº†(å¯¹åº”å¦‚æœå‘é€çš„æ—¶å€™å‘ç°æœ‰ç­‰å¾…è€…ï¼Œç›´æ¥æ•°æ®æ‹·è´ç»™ä»–å‘—)  æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªä¾‹å­ã€‚
æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªç¼“å†²åŒºä¸º7çš„channelã€‚bufferå°±æ˜¯ç”¨æ¥å­˜å‚¨ç¼“å†²å…ƒç´ çš„ï¼Œå®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªç¯å½¢æ•°ç»„ã€‚ä¸ºä»€ä¹ˆæ˜¯ç¯å½¢çš„ï¼Ÿå› ä¸ºè¿™æ ·å°±å¯ä»¥è¾¾åˆ°å¤ç”¨ç©ºé—´çš„æ•ˆæœã€‚
æ­¤æ—¶æ²¡æœ‰å‘é€æ¥æ”¶åŠ¨ä½œï¼Œæ‰€ä»¥qcountä¸º0ï¼Œå‘é€(sendx)å’Œæ¥æ”¶(recvx)çš„ä½ç½®éƒ½ä¸º0ã€‚
æˆ‘ä»¬æ¥çœ‹ä¸Šé¢çš„ç¬¬ä¸€ç§æƒ…å†µã€‚ç¼“å†²åŒºæœªæ»¡ï¼Œ
è¿™å—ä»£ç å°±æ¯”è¾ƒç®€å•äº†ã€‚å¦‚æœç¼“å†²åŒºæœªæ»¡ï¼Œé‚£å°±æŠŠå½“å‰è¦å‘é€çš„æ•°æ®æ‹·è´åˆ°ç¼“å†²åŒºçš„å‘é€ä½ç½®ï¼Œç„¶åå‘é€ä½ç½®sendx+1ï¼Œç„¶åå½“ç„¶channelä¸ªæ•°qcount+1ï¼Œæ•´ä¸ªæµç¨‹å°±ç»“æŸäº†ã€‚
å¦‚æœç¼“å†²æ»¡çš„æƒ…å†µä¸‹ï¼Œå°è£…å½“å‰gæˆsudogï¼ŒæŠŠè¿™ä¸ªsudogå…¥é˜Ÿç­‰å¾…å‘é€é˜Ÿåˆ—ï¼Œæœ€åè°ƒç”¨goparkæŒ‚èµ·å½“å‰gï¼Œä¸Šé¢æ— ç¼“å†²çš„æ—¶å€™æœ‰æåˆ°ã€‚
æœ€åä¸€ç§æƒ…å†µï¼Œå‘é€çš„æ—¶å€™æ­£å¥½æœ‰ç­‰å¾…æ¥æ”¶æ¶ˆæ¯è€…ï¼Œé‚£ä¹ˆå°±ä»recvqä¸­æ‹¿å‡ºæœ€æ—©å¼€å§‹ç­‰å¾…çš„æ¥å—è€…ï¼Œç„¶åæŠŠå‘é€çš„æ•°æ®ç›´æ¥æ‹·è´ç»™ä»–ã€‚
sendæ•´ä½“æœ‰ä¸¤ä¸ªåŠ¨ä½œï¼šæ‹·è´æ•°æ®&amp;mdash;&amp;ndash;&amp;gt;å”¤é†’ç­‰å¾…çš„recvqã€‚
é‚£ä¹ˆå¯¹äºæ¥æ”¶æ“ä½œå‘¢ï¼Ÿ
 å¿«é€’æŸœé‡Œæœ‰æˆ‘çš„å¿«é€’ï¼Œé‚£æˆ‘ç›´æ¥æ‹¿å°±è¡Œäº†ã€‚(å¯¹åº”ç¼“å†²åŒºæœ‰æ•°æ®ï¼Œæ ¹æ®è¯»recvxçš„ä½ç½®æ‹¿æ•°æ®) å¿«é€’æŸœè¿˜æ²¡æˆ‘çš„å¿«é€’ï¼Œä½†æ˜¯å¿«é€’å“¥æ‰“ç”µè¯è¯´å¿«åˆ°äº†ï¼Œé‚£æˆ‘ç°åœ¨æ¥¼ä¸‹è½¬è½¬ã€‚(å¯¹åº”ç¼“å†²åŒºæ— æ•°æ®ï¼ŒæŠŠå½“å‰gå°è£…æˆsudog,ç„¶åæ”¾å…¥åˆ°ç­‰å¾…æ¥æ”¶æ¶ˆæ¯é˜Ÿåˆ—recvqä¸­)ã€‚ å»æ‹¿ä¸€ä¸ªå¿«é€’çš„æ—¶å€™ï¼Œæ­£å¥½ä¸€ä¸ªå¿«é€’å‘˜æ”¾æˆ‘å¦ä¸€ä¸ªå¿«é€’çš„æ—¶å€™å› ä¸ºå¿«é€’æŸœæ»¡äº†ï¼Œåœ¨é‚£ç­‰ç€ã€‚(å¯¹åº”ç¼“å†²åŒºæ»¡äº†ï¼Œä¸”è¿˜æœ‰ç­‰å¾…å‘é€è€…ã€‚æ­¤æ—¶å…ˆåˆ°ç¼“å†²åŒºè·å–å½“å‰è¯»recvxä½ç½®çš„æ•°æ®ï¼Œç„¶åå†ä»ç­‰å¾…å‘é€è€…é˜Ÿåˆ—ä¸­å–å‡ºæœ€æ—©ç­‰å¾…çš„å‘é€è€…ï¼ŒæŠŠä»–è¦å‘é€çš„æ•°æ®æ‹·è´æ‹·è´åˆ°å½“å‰æˆ‘è¯»å–æ•°æ®çš„ä½ç½®(ä¿è¯å…ˆå…¥å…ˆå‡ºçš„é¡ºåº)ï¼Œæœ€åæ›´æ–°å‘é€ä½ç½®å’Œæ›´æ–°ä½ç½®å³å¯)ã€‚  ç¬¬ä¸€ç§æƒ…å†µå°±ç®€å•äº†ã€‚ç›´æ¥é€šè¿‡å½“å‰è¯»ä½ç½®recvxè¯»å–bufferå¯¹åº”çš„å€¼ï¼Œè¿™é‡Œè¿˜éœ€è¦é€šè¿‡åˆ¤æ–­æ˜¯å¦å¿½ç•¥è¿”å›å€¼ï¼Œè€Œå†³å®šéœ€ä¸éœ€è¦å¾€å½“å‰æ¥æ”¶æ“ä½œæ‹·è´æ•°æ®ã€‚ç„¶åç§»åŠ¨recvxä½ç½®ï¼Œå…ƒç´ ä¸ªæ•°qcount-- ï¼Œæœ€åè§£é”å³å¯ã€‚
ç¬¬äºŒç§æƒ…å†µï¼Œå°è£…å½“å‰gæˆsudogï¼ŒæŠŠè¿™ä¸ªsudogå…¥é˜Ÿç­‰å¾…æ¥æ”¶é˜Ÿåˆ—ï¼Œæœ€åè°ƒç”¨goparkæŒ‚èµ·å½“å‰gã€‚ä¸Šé¢æ— ç¼“å†²çš„æ—¶å€™ç”»è¿‡è¿™ä¸ªé€»è¾‘ã€‚
ç¬¬ä¸‰ç§æƒ…å†µæœ‰ç‚¹å¤æ‚ã€‚
è¿™ç§æƒ…å†µä¸‹ï¼Œå½“è·å–åˆ°ä¸€ä¸ªç­‰å¾…å‘é€è€…ï¼Œå¯¹äºæ¥æ”¶è€…æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥æ‹¿å®ƒçš„å‘é€æ•°æ®è¿”å›ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿä¸¾ä¸ªä¾‹å­
ä¸Šå›¾ï¼Œchannelæ»¡äº†ï¼Œä¸”sendqæœ‰ä¸€ä¸ªç­‰å¾…å‘é€è€…(å‡è®¾æ˜¯G8ï¼Œå‘é€æ•°æ®ä¸º800)ï¼Œæ­¤æ—¶æ‰§è¡Œæ¥æ”¶æ“ä½œï¼Œä¹Ÿå°±å‡ºç°ä¸Šè¿°ç¬¬ä¸‰ç§æƒ…å†µã€‚
å¦‚æœæ­¤æ—¶æˆ‘ä»¬ç›´æ¥æ‹¿G8çš„æ•°æ®ï¼Œé‚£ä¹ˆæ•°æ®å°±ä¸èƒ½ä¿è¯å…ˆå…¥å…ˆå‡ºäº†ã€‚
æ‰€ä»¥æ­£ç¡®çš„æ“ä½œæ˜¯ï¼Œè¯»å–å½“å‰recvxä½ç½®(0)bufferå€¼100ï¼Œç„¶åæŠŠG8çš„æ•°æ®800æ‹·è´åˆ°0çš„ä½ç½®ï¼Œæœ€åæŠŠrecvqçš„ä½ç½®å‘å‰ç§»åŠ¨ï¼ŒåŒæ­¥å‘é€ä½ç½®sendxç­‰äºrecvqã€‚è¿™é‡Œï¼Œå¯ä»¥æ€è€ƒä¸‹ä¸ºå•¥ï¼Ÿ
åˆ°è¿™é‡Œç¼“å†²channelçš„æ ¸å¿ƒæµç¨‹å°±è¯´å®Œäº†ã€‚å¦‚å›¾ï¼Œ
å¦å¤–åå°å›å¤channelæœ‰æˆ‘å‡†å¤‡çš„ä¸€ä¸ªå°pptï¼Œå¯ä»¥è·Ÿç€ä¸€èµ·çœ‹ã€‚</description>
			<content type="html"><![CDATA[<p>ä¸Šä¸€ç¯‡æ–‡ç« ä¸»è¦é€šè¿‡ä¸€ä¸ªç°å®ä¾‹å­é—´æ¥åæ˜ <code>channel</code>çš„ä¸€äº›åŸç†ã€‚æœ€åä¸€ç¯‡å¼€å§‹ä»‹ç»ä¸€äº›ç»†èŠ‚ï¼Œä¼šæ¶‰åŠåˆ°æºç ã€‚</p>
<p>è¿˜æ˜¯ä»ä¸€ä¸ªç®€å•çš„ä»£ç ç¨‹åºçœ‹èµ·ã€‚</p>
<p><img src="https://cdn.syst.top/12-1.png" alt="image-20211012211523725"></p>
<p>æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ— ç¼“å†²<code>channel</code>ï¼Œç„¶åå¾€è¿™ä¸ª<code>channel</code>å‘é€æ•°æ®ã€‚å› ä¸ºç¨‹åºä¸­æ²¡æœ‰è¯»æ“ä½œ<code>ready</code>ï¼Œæ‰€ä»¥å‘é€çš„æ—¶å€™ä¼šé˜»å¡ã€‚æˆ‘ä»¬é€šè¿‡æ±‡ç¼–ä»£ç çœ‹å®ƒåº•å±‚çš„è°ƒç”¨ã€‚</p>
<p><img src="https://cdn.syst.top/12-2.png" alt="image-20211012211523725"></p>
<p>ä»å›¾ä¸­æˆ‘ä»¬çœ‹åˆ°ï¼Œä¸Šè¿°å‘é€æ“ä½œï¼Œç¨‹åºè¿è¡Œæ—¶å®é™…è°ƒç”¨çš„<code>runtime.chansend1</code>ã€‚</p>
<p><img src="https://cdn.syst.top/12-3.png" alt="image-20211012211523725"></p>
<p>æœ€ç»ˆ<code>chansend1</code>æœ€ç»ˆè°ƒç”¨çš„è¿˜æ˜¯<code>chansend</code>ï¼Œ<code>chansend</code>çš„ç¬¬ä¸‰ä¸ªå‚æ•°<code>block</code>æ˜¯ä¸ª<code>bool</code>å€¼ï¼Œè¡¨ç¤ºæ“ä½œ<code>channel</code>ä¸èƒ½ç«‹å³æˆåŠŸæ—¶æ˜¯å¦éœ€è¦é˜»å¡ã€‚</p>
<p>å…·ä½“å“ªäº›æ“ä½œï¼Ÿ</p>
<ul>
<li>å‘æ— ç¼“å†²<code>channel</code>å‘é€æ•°æ®ä¸”å½“å‰æ— æ¥æ”¶è€…<code>ready</code>ã€‚</li>
<li>æ¥æ”¶æ— ç¼“å†²<code>channel</code>æ•°æ®ä¸”å½“å‰æ— å‘é€è€…<code>ready</code>ã€‚</li>
<li>ç¼“å†²<code>channel</code>å·²æ»¡ï¼Œå¾€<code>channel</code>å‘é€æ•°æ®ã€‚</li>
<li>ç¼“å†²<code>channel</code>ä¸ºç©ºï¼Œæ¥æ”¶<code>channel</code>æ•°æ®</li>
<li>å‘ä¸€ä¸ª<code>nil</code>çš„<code>channel</code>å‘é€æ•°æ®ã€‚(æ³¨æ„ï¼Œå‘ä¸€ä¸ª<code>nil</code>çš„<code>channel</code>å‘é€æ•°æ®å¹¶ä¸ä¼šå¼•å‘<code>panic</code>)ã€‚</li>
<li>å‘ä¸€ä¸ª<code>nil</code>çš„<code>channel</code>æ¥æ”¶æ•°æ®ã€‚</li>
</ul>
<p>ç¢°åˆ°ä¸Šé¢çš„æ“ä½œï¼Œå¦‚æœä¸æ˜¯ç‰¹æ®Šå¤„ç†ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¼šè¢«é˜»å¡ï¼Œç›´åˆ°è¢«å”¤é†’ã€‚</p>
<p>å½“ç„¶å¯¹äºå‘<code>nil</code>çš„<code>channel</code>å‘é€|æ¥æ”¶æ•°æ®ï¼Œåç»­å†ä¹Ÿæ²¡æœºä¼šè¢«å”¤é†’äº†ã€‚</p>
<p>é‚£ä¹ˆå¦‚æœæ˜¯å¿«é€Ÿè¯•é”™çš„åœºæ™¯ï¼Œæ˜¯ä¸æ˜¯åªè¦æŠŠ<code>block</code>æ”¹æˆ<code>false</code>ï¼Œåœ¨å¤±è´¥çš„åœºæ™¯ä¸‹å°±ä¸ä¼šè¢«é˜»å¡äº†ã€‚</p>
<p>ç¼–è¯‘è¿™æ®µä»£ç ã€‚</p>
<p><img src="https://cdn.syst.top/12-4.png" alt="image-20211012215229617"></p>
<p><img src="https://cdn.syst.top/12-5.png" alt="image-20211012215229617"></p>
<p><img src="https://cdn.syst.top/12-6.png" alt="12-6"></p>
<p>å¯ä»¥çœ‹å‡ºï¼Œä¸Šé¢è¿™æ®µä»£ç ç¼–è¯‘åè°ƒç”¨<code>selectnbsend</code>æœ€ç»ˆå‘é€åŠ¨ä½œè°ƒç”¨çš„è¿˜æ˜¯<code>chansned</code>ï¼Œåªæ˜¯ä¼ å…¥çš„<code>block</code>æ˜¯<code>false</code>ã€‚è¿™æ ·ä¸€æ—¦æ“ä½œå¤±è´¥ï¼Œç¨‹åºä¸ä¼šè¢«é˜»å¡ã€‚</p>
<p>åŒç†æˆ‘ä»¬å¯ä»¥å¾—å‡ºæ¥æ”¶çš„è°ƒç”¨åŠ¨ä½œã€‚</p>
<p><img src="https://cdn.syst.top/12-7.png" alt="12-6"></p>
<p><img src="https://cdn.syst.top/12-8.png" alt="12-6"></p>
<p><img src="https://cdn.syst.top/12-9.png" alt="12-6"></p>
<p><img src="https://cdn.syst.top/12-10.png" alt="12-6"></p>
<p>åˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œ</p>
<p>å‘é€æ•°æ®ï¼Œæœ€ç»ˆè°ƒç”¨çš„<code>runtime.chansend</code>ã€‚</p>
<p>æ¥æ”¶æ•°æ®ï¼Œæœ€ç»ˆè°ƒç”¨çš„<code>runtime.chanrecv</code>ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥è¯´æ˜è¿™ä¸¤ä¸ªå‡½æ•°åº•å±‚æ˜¯å¦‚ä½•æ“ä½œçš„ã€‚</p>
<p>æˆ‘ä»¬è¿˜æ˜¯ä»¥ä¸€ä¸ªæ— ç¼“å†²çš„<code>channel</code>å’Œç¼“å†²<code>channel</code>æ¥è¯´æ˜ã€‚</p>
<p>æ¥çœ‹ä¸€æ®µç®€å•çš„ç¨‹åºã€‚</p>
<p><img src="https://cdn.syst.top/12-11.png" alt="image-20211012221535539"></p>
<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨Goä¸­ä½¿ç”¨ <code>go func</code>çš„æ—¶å€™ï¼Œæœ¬è´¨ä¸Šè°ƒç”¨çš„æ˜¯<code>runtime.newproc</code>åˆ›å»ºä¸€ä¸ª<code>g</code>ï¼Œç„¶åæŠŠè¿™ä¸ª<code>g</code>äº¤ç»™è°ƒåº¦å™¨è°ƒåº¦ã€‚è‡³äºä»€ä¹ˆæ—¶å€™<code>g</code>è¢«è°ƒåº¦ï¼Œç„¶åæ‰§è¡Œä½ çš„ä»£ç é€»è¾‘ï¼Œé‚£å°±è¦çœ‹è°ƒåº¦å™¨çš„&quot;å¿ƒæƒ…&quot;äº†ã€‚</p>
<p>æ‰€ä»¥ä¸Šé¢åˆ›å»ºçš„ä¸¤ä¸ª<code>g</code>(æš‚ä¸”ç§°ä¸ºg1å’Œg2)ï¼Œå¯ä»¥çœ‹æˆæ˜¯æˆ‘ä»¬å‘è°ƒåº¦å™¨æäº¤äº†ä¸¤ä¸ªä»»åŠ¡<code>g</code>ï¼Œæˆ‘ä»¬æ— æ³•ä¿è¯å“ªä¸ª<code>g</code>ä¼šè¢«å…ˆè°ƒåº¦å™¨è°ƒåº¦æ‰§è¡Œï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿä¸ç¡®å®šå‘é€å’Œæ¥æ”¶è¿™ä¸¤ä¸ªæ“ä½œï¼Œè°ä¼šå…ˆè¢«æ‰§è¡Œã€‚</p>
<p>å‡è®¾<code>g1</code>å…ˆè¢«è°ƒåº¦å™¨è¿è¡Œï¼Œç„¶åæ‰§è¡Œä»£ç <code>ch&lt;-struct{}{}</code>ã€‚</p>
<p><img src="https://cdn.syst.top/12-11-2.png" alt="image-20211012223319977"></p>
<p>å¦‚æœ<code>g2</code>å…ˆè¢«è°ƒåº¦å™¨è¿è¡Œï¼Œç„¶åæ‰§è¡Œä»£ç <code>&lt;-ch</code>ã€‚</p>
<p><img src="https://cdn.syst.top/12-13.png" alt="image-20211012230756372"></p>
<p>å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠä¸Šé¢çš„ä»£ç æ¢æˆç”»æˆè¯¦ç»†çš„æ— ç¼“å†²é˜Ÿåˆ—æ ¸å¿ƒæµç¨‹å›¾ã€‚</p>
<p><img src="https://cdn.syst.top/12-12.jpg" alt="12-12"></p>
<p>ç¼“å†²<code>channel</code>å‘é€çš„æ—¶å€™åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼Œæƒ³æƒ³æˆ‘ä»¬ä¸Šç¯‡æ–‡ç« å¿«é€’å‘˜é€å¿«é€’åœºæ™¯ã€‚</p>
<ul>
<li>å¦‚æœå¿«é€’æŸœæœªæ»¡ï¼Œç›´æ¥æŠŠå¿«é€’æ”¾å…¥åˆ°å¿«é€’æŸœã€‚(å¯¹åº”ç¼“å†²åŒºæœªæ»¡ï¼ŒæŠŠå‘é€æ•°æ®æ‹·è´åˆ°ç¼“å†²åŒº)</li>
<li>å¦‚æœå¿«é€’æŸœæ»¡äº†ï¼Œé‚£å¿«é€’å‘˜åªèƒ½åœ¨é‚£ç­‰å¾…å¿«é€’æŸœç©ºäº†ã€‚(å¯¹åº”æŠŠå½“å‰<code>g</code>å°è£…æˆ<code>sudog</code>ï¼Œç„¶åæŠŠsudogæ”¾åˆ°ç­‰å¾…å‘é€æ¶ˆæ¯é˜Ÿåˆ—<code>sendq</code>ä¸­ï¼Œæœ€åæŒ‚èµ·å½“å‰<code>g</code>)</li>
<li>å¦‚æœé€å¿«é€’çš„æ—¶å€™æ­£å¥½å®¢æˆ·åœ¨é‚£é‡Œç­‰ï¼Œé‚£å°±ç›´æ¥æŠŠå¿«é€’ç»™ä»–å°±æ˜¯äº†(å¯¹åº”å¦‚æœå‘é€çš„æ—¶å€™å‘ç°æœ‰ç­‰å¾…è€…ï¼Œç›´æ¥æ•°æ®æ‹·è´ç»™ä»–å‘—)</li>
</ul>
<p>æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªä¾‹å­ã€‚</p>
<p><img src="https://cdn.syst.top/12-14.png" alt="12-14"></p>
<p>æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªç¼“å†²åŒºä¸º7çš„<code>channel</code>ã€‚<code>buffer</code>å°±æ˜¯ç”¨æ¥å­˜å‚¨ç¼“å†²å…ƒç´ çš„ï¼Œå®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªç¯å½¢æ•°ç»„ã€‚ä¸ºä»€ä¹ˆæ˜¯ç¯å½¢çš„ï¼Ÿå› ä¸ºè¿™æ ·å°±å¯ä»¥è¾¾åˆ°å¤ç”¨ç©ºé—´çš„æ•ˆæœã€‚</p>
<p>æ­¤æ—¶æ²¡æœ‰å‘é€æ¥æ”¶åŠ¨ä½œï¼Œæ‰€ä»¥<code>qcount</code>ä¸º0ï¼Œå‘é€(<code>sendx</code>)å’Œæ¥æ”¶(<code>recvx</code>)çš„ä½ç½®éƒ½ä¸º0ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸Šé¢çš„ç¬¬ä¸€ç§æƒ…å†µã€‚ç¼“å†²åŒºæœªæ»¡ï¼Œ</p>
<p><img src="https://cdn.syst.top/12-27.png" alt="12-15"></p>
<p>è¿™å—ä»£ç å°±æ¯”è¾ƒç®€å•äº†ã€‚å¦‚æœç¼“å†²åŒºæœªæ»¡ï¼Œé‚£å°±æŠŠå½“å‰è¦å‘é€çš„æ•°æ®æ‹·è´åˆ°ç¼“å†²åŒºçš„å‘é€ä½ç½®ï¼Œç„¶åå‘é€ä½ç½®<code>sendx+1</code>ï¼Œç„¶åå½“ç„¶<code>channel</code>ä¸ªæ•°<code>qcount+1</code>ï¼Œæ•´ä¸ªæµç¨‹å°±ç»“æŸäº†ã€‚</p>
<p>å¦‚æœç¼“å†²æ»¡çš„æƒ…å†µä¸‹ï¼Œå°è£…å½“å‰<code>g</code>æˆ<code>sudog</code>ï¼ŒæŠŠè¿™ä¸ª<code>sudog</code>å…¥é˜Ÿç­‰å¾…å‘é€é˜Ÿåˆ—ï¼Œæœ€åè°ƒç”¨<code>gopark</code>æŒ‚èµ·å½“å‰<code>g</code>ï¼Œä¸Šé¢æ— ç¼“å†²çš„æ—¶å€™æœ‰æåˆ°ã€‚</p>
<p>æœ€åä¸€ç§æƒ…å†µï¼Œå‘é€çš„æ—¶å€™æ­£å¥½æœ‰ç­‰å¾…æ¥æ”¶æ¶ˆæ¯è€…ï¼Œé‚£ä¹ˆå°±ä»<code>recvq</code>ä¸­æ‹¿å‡ºæœ€æ—©å¼€å§‹ç­‰å¾…çš„æ¥å—è€…ï¼Œç„¶åæŠŠå‘é€çš„æ•°æ®ç›´æ¥æ‹·è´ç»™ä»–ã€‚</p>
<p><img src="https://cdn.syst.top/12-28.png" alt="image-20211015002454895"></p>
<p><img src="https://cdn.syst.top/12-29.png" alt="image-20211014224054936"></p>
<p><code>send</code>æ•´ä½“æœ‰ä¸¤ä¸ªåŠ¨ä½œï¼šæ‹·è´æ•°æ®&mdash;&ndash;&gt;å”¤é†’ç­‰å¾…çš„<code>recvq</code>ã€‚</p>
<p>é‚£ä¹ˆå¯¹äºæ¥æ”¶æ“ä½œå‘¢ï¼Ÿ</p>
<ul>
<li>å¿«é€’æŸœé‡Œæœ‰æˆ‘çš„å¿«é€’ï¼Œé‚£æˆ‘ç›´æ¥æ‹¿å°±è¡Œäº†ã€‚(å¯¹åº”ç¼“å†²åŒºæœ‰æ•°æ®ï¼Œæ ¹æ®è¯»<code>recvx</code>çš„ä½ç½®æ‹¿æ•°æ®)</li>
<li>å¿«é€’æŸœè¿˜æ²¡æˆ‘çš„å¿«é€’ï¼Œä½†æ˜¯å¿«é€’å“¥æ‰“ç”µè¯è¯´å¿«åˆ°äº†ï¼Œé‚£æˆ‘ç°åœ¨æ¥¼ä¸‹è½¬è½¬ã€‚(å¯¹åº”ç¼“å†²åŒºæ— æ•°æ®ï¼ŒæŠŠå½“å‰<code>g</code>å°è£…æˆ<code>sudog</code>,ç„¶åæ”¾å…¥åˆ°ç­‰å¾…æ¥æ”¶æ¶ˆæ¯é˜Ÿåˆ—<code>recvq</code>ä¸­)ã€‚</li>
<li>å»æ‹¿ä¸€ä¸ªå¿«é€’çš„æ—¶å€™ï¼Œæ­£å¥½ä¸€ä¸ªå¿«é€’å‘˜æ”¾æˆ‘å¦ä¸€ä¸ªå¿«é€’çš„æ—¶å€™å› ä¸ºå¿«é€’æŸœæ»¡äº†ï¼Œåœ¨é‚£ç­‰ç€ã€‚(å¯¹åº”ç¼“å†²åŒºæ»¡äº†ï¼Œä¸”è¿˜æœ‰ç­‰å¾…å‘é€è€…ã€‚æ­¤æ—¶å…ˆåˆ°ç¼“å†²åŒºè·å–å½“å‰è¯»<code>recvx</code>ä½ç½®çš„æ•°æ®ï¼Œç„¶åå†ä»ç­‰å¾…å‘é€è€…é˜Ÿåˆ—ä¸­å–å‡ºæœ€æ—©ç­‰å¾…çš„å‘é€è€…ï¼ŒæŠŠä»–è¦å‘é€çš„æ•°æ®æ‹·è´æ‹·è´åˆ°å½“å‰æˆ‘è¯»å–æ•°æ®çš„ä½ç½®(ä¿è¯å…ˆå…¥å…ˆå‡ºçš„é¡ºåº)ï¼Œæœ€åæ›´æ–°å‘é€ä½ç½®å’Œæ›´æ–°ä½ç½®å³å¯)ã€‚</li>
</ul>
<p>ç¬¬ä¸€ç§æƒ…å†µå°±ç®€å•äº†ã€‚ç›´æ¥é€šè¿‡å½“å‰è¯»ä½ç½®<code>recvx</code>è¯»å–<code>buffer</code>å¯¹åº”çš„å€¼ï¼Œè¿™é‡Œè¿˜éœ€è¦é€šè¿‡åˆ¤æ–­æ˜¯å¦å¿½ç•¥è¿”å›å€¼ï¼Œè€Œå†³å®šéœ€ä¸éœ€è¦å¾€å½“å‰æ¥æ”¶æ“ä½œæ‹·è´æ•°æ®ã€‚ç„¶åç§»åŠ¨<code>recvx</code>ä½ç½®ï¼Œå…ƒç´ ä¸ªæ•°<code>qcount--</code> ï¼Œæœ€åè§£é”å³å¯ã€‚</p>
<p><img src="https://cdn.syst.top/12-30.png" alt="image-20211014224602030"></p>
<p>ç¬¬äºŒç§æƒ…å†µï¼Œå°è£…å½“å‰<code>g</code>æˆ<code>sudog</code>ï¼ŒæŠŠè¿™ä¸ª<code>sudog</code>å…¥é˜Ÿç­‰å¾…æ¥æ”¶é˜Ÿåˆ—ï¼Œæœ€åè°ƒç”¨<code>gopark</code>æŒ‚èµ·å½“å‰<code>g</code>ã€‚ä¸Šé¢æ— ç¼“å†²çš„æ—¶å€™ç”»è¿‡è¿™ä¸ªé€»è¾‘ã€‚</p>
<p>ç¬¬ä¸‰ç§æƒ…å†µæœ‰ç‚¹å¤æ‚ã€‚</p>
<p><img src="https://cdn.syst.top/12-31.png" alt="image-20211014230147629"></p>
<p>è¿™ç§æƒ…å†µä¸‹ï¼Œå½“è·å–åˆ°ä¸€ä¸ªç­‰å¾…å‘é€è€…ï¼Œå¯¹äºæ¥æ”¶è€…æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥æ‹¿å®ƒçš„å‘é€æ•°æ®è¿”å›ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿä¸¾ä¸ªä¾‹å­</p>
<p><img src="https://cdn.syst.top/12-32.png" alt="image-20211014230147629"></p>
<p>ä¸Šå›¾ï¼Œ<code>channel</code>æ»¡äº†ï¼Œä¸”<code>sendq</code>æœ‰ä¸€ä¸ªç­‰å¾…å‘é€è€…(å‡è®¾æ˜¯<code>G8</code>ï¼Œå‘é€æ•°æ®ä¸º<code>800</code>)ï¼Œæ­¤æ—¶æ‰§è¡Œæ¥æ”¶æ“ä½œï¼Œä¹Ÿå°±å‡ºç°ä¸Šè¿°ç¬¬ä¸‰ç§æƒ…å†µã€‚</p>
<p>å¦‚æœæ­¤æ—¶æˆ‘ä»¬ç›´æ¥æ‹¿<code>G8</code>çš„æ•°æ®ï¼Œé‚£ä¹ˆæ•°æ®å°±ä¸èƒ½ä¿è¯å…ˆå…¥å…ˆå‡ºäº†ã€‚</p>
<p>æ‰€ä»¥æ­£ç¡®çš„æ“ä½œæ˜¯ï¼Œè¯»å–å½“å‰<code>recvx</code>ä½ç½®(0)<code>buffer</code>å€¼<code>100</code>ï¼Œç„¶åæŠŠ<code>G8</code>çš„æ•°æ®800æ‹·è´åˆ°0çš„ä½ç½®ï¼Œæœ€åæŠŠ<code>recvq</code>çš„ä½ç½®å‘å‰ç§»åŠ¨ï¼ŒåŒæ­¥å‘é€ä½ç½®<code>sendx</code>ç­‰äº<code>recvq</code>ã€‚è¿™é‡Œï¼Œå¯ä»¥æ€è€ƒä¸‹ä¸ºå•¥ï¼Ÿ</p>
<p>åˆ°è¿™é‡Œç¼“å†²<code>channel</code>çš„æ ¸å¿ƒæµç¨‹å°±è¯´å®Œäº†ã€‚å¦‚å›¾ï¼Œ</p>
<p><img src="https://cdn.syst.top/12-33.jpg" alt="image-20211014230147629"></p>
<p>å¦å¤–åå°å›å¤<code>channel</code>æœ‰æˆ‘å‡†å¤‡çš„ä¸€ä¸ªå°<code>ppt</code>ï¼Œå¯ä»¥è·Ÿç€ä¸€èµ·çœ‹ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>channelåŸç†è§£æ(äºŒ)</title>
			<link>https://www.syst.top/posts/go/channel2/</link>
			<pubDate>Sun, 10 Oct 2021 21:25:52 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/channel2/</guid>
			<description>ä¸Šä¸€ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»channelè¿è¡Œæ—¶æ˜¯é€šè¿‡hchanè¡¨ç¤ºçš„ï¼Œä¹Ÿç®€å•è¯´æ˜äº†hchanå„ä¸ªå­—æ®µçš„å«ä¹‰ã€‚
æˆ‘ä»¬æåˆ°ï¼Œå¯¹channelçš„æ“ä½œï¼Œæœ¬è´¨ä¸Šå°±æ˜¯å¯¹hchané‡Œå­—æ®µçš„æ“ä½œã€‚å› ä¸ºåœ¨æ“ä½œçš„è¿‡ç¨‹ä¸­ä½¿ç”¨äº†äº’æ–¥é”ï¼Œæ‰€ä»¥ä¿è¯äº†channelçš„å¹¶å‘å®‰å…¨ã€‚
è¿™ç¯‡æ–‡ç« ä¸»è¦é€šè¿‡ç°å®ç”Ÿæ´»çš„ä¸€äº›ä¾‹å­æ¥è¯´æ˜channelçš„ä¸€äº›åŸç†ï¼Œå½“ç„¶è¿˜æ˜¯ä¸ä¼šæ¶‰åŠè¿‡å¤šæºç ã€‚
æ— ç¼“å†² æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œchannelåˆ†ä¸ºæ— ç¼“å†²å’Œç¼“å†²ã€‚è¿™ä¸¤è€…æœ€å¤§çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ
æˆ‘ä»¬ç”¨ä¸€ä¸ªç°å®ç”Ÿæ´»çš„å¿«é€’ä¾‹å­æ¥è¯´æ˜ã€‚
ä¸Šé¢åœºæ™¯æ˜¯å¿«é€’å‘˜åœ¨ç­‰å°åº“ï¼Œå½“ç„¶åè¿‡æ¥å°åº“ä¹Ÿå¯èƒ½åœ¨ç­‰å¿«é€’å‘˜ã€‚
å¦‚æœæ²¡æœ‰å¿«é€’æŸœï¼Œå¿«é€’å‘˜åœ¨é€å¿«é€’çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå®¶é‡Œæ²¡äººï¼Œä»–å°±å¾—åœ¨é‚£ç­‰ç€ï¼Œç­‰ç€æœ‰äººæ¥ç­¾æ”¶å¿«é€’ï¼Œä»–æ‰é€è´§ç»“æŸã€‚
å®¢æˆ·åœ¨å¿«é€’å‘˜åˆ°æ¥ä¹‹å‰ï¼Œä»–ä¹Ÿä¸èƒ½ç¦»å¼€å®¶ï¼Œä¸ç„¶å¿«é€’æ¥äº†æ²¡äººæ”¶ï¼Œæ‰€ä»¥ä»–ä¹Ÿå¾—ç­‰åˆ°å¿«é€’å‘˜ä¸Šé—¨ï¼Œç­¾å­—æ”¶äº†å¿«é€’ï¼Œä»–æ‰ç®—æ”¶è´§ç»“æŸã€‚
å½“ç„¶ï¼Œå®¢æˆ·ä¸æ­¢æœ‰è¿™å®¶å¿«é€’ï¼Œå¦‚æœå¿«é€’å‘˜Aåœ¨ç­‰çš„æ—¶å€™åˆæ¥ä¸€ä¸ªå¿«é€’å‘˜Bç»™ä»–é€è´§ã€‚è¿™ä¸ªå¿«é€’å‘˜Bä¸ä»…å¾—ç­‰ç€ï¼Œè¿˜å¾—æ’é˜Ÿã€‚ç­‰åˆ°å®¢æˆ·åˆ°å®¶åï¼Œè‚¯å®šæ˜¯å…ˆç­¾æ”¶Açš„å¿«é€’ï¼Œç„¶åå†ç­¾æ”¶Bçš„å¿«é€’ã€‚
å¯¹åº”åˆ°æ— ç¼“å†²channelï¼Œ
å‘é€æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰å¯¹åº”çš„æ¥æ”¶è€…readyï¼Œé‚£ä¹ˆå‘é€è€…å°±è¿›å…¥åˆ°ç­‰å¾…å‘é€é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…æœ‰å¯¹åº”çš„æ¥æ”¶è€…å”¤é†’å®ƒã€‚
æ¥æ”¶æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰å¯¹åº”çš„å‘é€è€…readyï¼Œé‚£ä¹ˆæ¥æ”¶è€…å°±è¿›å…¥åˆ°ç­‰å¾…æ¥æ”¶é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…æœ‰å¯¹åº”çš„å‘é€è€…å”¤é†’å®ƒã€‚
è¿˜è®°å¾—ä¸Šä¸€ç¯‡æ–‡ç« æˆ‘ä»¬ä»‹ç»è¿‡hchançš„ç»“æ„å—ã€‚
å…¶ä¸­recvq è¡¨ç¤ºç­‰å¾…æ¥æ”¶æ¶ˆæ¯çš„é˜Ÿåˆ—ï¼Œsendqè¡¨ç¤ºç­‰å¾…å‘é€æ¶ˆæ¯çš„é˜Ÿåˆ—ã€‚
æˆ‘ä»¬æ¥çœ‹waitqã€‚
æœ¬è´¨ä¸Šwaitqå°±æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œæ›´ç¡®åˆ‡çš„è¯´æ˜¯ä¸€ä¸ªåŒå‘å¾ªç¯çš„é“¾è¡¨ã€‚å…¶ä¸­waitqè®°å½•äº†é“¾è¡¨çš„å¤´å°¾ï¼Œsudogè®°å½•äº†å½“å‰ç­‰å¾…è€…çš„ä¸Šä¸€ä¸ªç­‰å¾…è€…(prev)å’Œä¸‹ä¸€ä¸ªç­‰å¾…è€…(next)ã€‚
è¿™å°±å¥½åƒå°åº“åœ¨ç­¾æ”¶å®ŒAçš„å¿«é€’åå–Šï¼Œä¸‹ä¸€ä¸ªæ˜¯è°å•Šï¼Ÿ
Aä¼šè¯´:æˆ‘çš„ä¸‹ä¸€ä¸ªæ˜¯Bã€‚
Bä¼šè¯´:æ˜¯æˆ‘ã€‚æˆ‘è®°å¾—æˆ‘ä¸Šä¸€ä¸ªæ˜¯Aï¼Œç›®å‰æˆ‘æ²¡æœ‰ä¸‹ä¸€ä¸ªï¼Œæ‰€ä»¥æˆ‘æ˜¯æœ€åä¸€ä¸ªã€‚
ç¼“å†² çœ‹å®Œäº†æ— ç¼“å†²é˜Ÿåˆ—ï¼Œæˆ‘ä»¬å†æ¥çœ‹ç¼“å†²é˜Ÿåˆ—ã€‚è¿˜æ˜¯ç”¨ä¸Šé¢çš„æ•…äº‹ï¼Œ
åªè¦å¿«é€’æŸœæœ‰ç©ºé—²æŸœå­ï¼Œå¿«é€’å‘˜å°±å¯ä»¥ç›´æ¥æŠŠå¿«é€’æ”¾åˆ°æŸœå­é‡Œï¼Œè®©å®¢æˆ·è‡ªå·±å»æŸœå­æ‹¿ã€‚å¦‚æœå‘é€æ²¡æœ‰ç©ºé—²çš„æŸœå­ï¼Œé‚£å°±åªèƒ½ç­‰ï¼Œç­‰åˆ°åˆ«äººå‘Šè¯‰æˆ‘æœ‰ç©ºé—²æŸœå­ï¼Œæˆ‘å†æŠŠå¿«é€’æ”¾åˆ°ç©ºå‡ºæ¥çš„æŸœå­é‡Œã€‚
å¯¹åº”åˆ°ç¼“å†²channelï¼Œä¸Šé¢çš„å¿«é€’æŸœï¼Œå°±æ˜¯ç¼“å†²channelä¸­å­˜å‚¨æ•°æ®çš„bufferã€‚
å¯¹äºå‘é€è€…æ¥è¯´ï¼šåªè¦ç¼“å†²åŒºæœªæ»¡ï¼Œå‘é€è€…å°±å¯ä»¥ç»§ç»­å‘é€æ•°æ®å­˜æ”¾åœ¨ç¼“å†²åŒºã€‚ä¸€æ—¦ç¼“å†²åŒºæ»¡äº†ï¼Œå‘é€è€…å°±åªèƒ½è¿›å…¥åˆ°ç­‰å¾…å‘é€é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…æœ‰å¯¹åº”çš„æ¥æ”¶è€…å”¤é†’å®ƒï¼Œç„¶åå®ƒå†æŠŠæ•°æ®æ”¾å…¥åˆ°åˆšåˆšè¢«å–èµ°æ•°æ®çš„ä½ç½®ã€‚
å¯¹äºæ¥æ”¶è€…æ¥è¯´ï¼šåªè¦ç¼“å†²åŒºä¸ä¸ºç©ºï¼Œæ¥æ”¶è€…å°±å¯ä»¥ç»§ç»­æ¥æ”¶æ•°æ®ã€‚ä¸€æ—¦ç¼“å†²åŒºç©ºäº†ï¼Œé‚£ä¹ˆæ¥æ”¶è€…å°±åªèƒ½è¿›å…¥åˆ°ç­‰å¾…æ¥æ”¶é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…æœ‰å¯¹åº”çš„å‘é€è€…å”¤é†’å®ƒã€‚
ä¸Šé¢è¿˜æœ‰ä»€ä¹ˆé—®é¢˜å—ï¼Ÿè¿˜çœŸæœ‰ã€‚
æˆ‘ä»¬å–å¿«é€’çš„æ—¶å€™ï¼Œä½ ä¸€å®šä¼šæŒ‰ç…§å¿«é€’æ”¾å…¥åˆ°å¿«é€’æŸœçš„å…ˆåé¡ºåºå–å¿«é€’å—ï¼Ÿå’‹ä¹ˆå¯èƒ½ã€‚
ä½†æ˜¯åœ¨channelä¸­ï¼Œæ˜¯ä¼šä¿è¯æ¶ˆæ¯çš„å…ˆè¿›å…ˆå‡º(FIFO)å…³ç³»çš„ã€‚è‡³äºå’‹ä¹ˆä¿è¯çš„ï¼Œæˆ‘ä»¬ç»ˆç»“ç¯‡è§£æä»£ç ç»†èŠ‚çš„æ—¶å€™å†è¯´ã€‚
æ€»ç»“ è¿™ç¯‡æ–‡ç« ä¸»è¦é€šè¿‡ä¸€ä¸ªå¿«é€’çš„ä¾‹å­æ¥ä»‹ç»channelæ“ä½œçš„åŸç†ã€‚ä¸‹ä¸€ç¯‡æˆ‘ä»¬ä»‹ç»channelé’ˆå¯¹ä¸Šè¿°å¤„ç†çš„ç»†èŠ‚é€»è¾‘ã€‚</description>
			<content type="html"><![CDATA[<p>ä¸Šä¸€ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»<code>channel</code>è¿è¡Œæ—¶æ˜¯é€šè¿‡<code>hchan</code>è¡¨ç¤ºçš„ï¼Œä¹Ÿç®€å•è¯´æ˜äº†<code>hchan</code>å„ä¸ªå­—æ®µçš„å«ä¹‰ã€‚</p>
<p>æˆ‘ä»¬æåˆ°ï¼Œå¯¹<code>channel</code>çš„æ“ä½œï¼Œæœ¬è´¨ä¸Šå°±æ˜¯å¯¹<code>hchan</code>é‡Œå­—æ®µçš„æ“ä½œã€‚å› ä¸ºåœ¨æ“ä½œçš„è¿‡ç¨‹ä¸­ä½¿ç”¨äº†äº’æ–¥é”ï¼Œæ‰€ä»¥ä¿è¯äº†<code>channel</code>çš„å¹¶å‘å®‰å…¨ã€‚</p>
<p>è¿™ç¯‡æ–‡ç« ä¸»è¦é€šè¿‡ç°å®ç”Ÿæ´»çš„ä¸€äº›ä¾‹å­æ¥è¯´æ˜<code>channel</code>çš„ä¸€äº›åŸç†ï¼Œå½“ç„¶è¿˜æ˜¯ä¸ä¼šæ¶‰åŠè¿‡å¤šæºç ã€‚</p>
<h3 id="æ— ç¼“å†²">æ— ç¼“å†²</h3>
<p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œ<code>channel</code>åˆ†ä¸ºæ— ç¼“å†²å’Œç¼“å†²ã€‚è¿™ä¸¤è€…æœ€å¤§çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>æˆ‘ä»¬ç”¨ä¸€ä¸ªç°å®ç”Ÿæ´»çš„å¿«é€’ä¾‹å­æ¥è¯´æ˜ã€‚</p>
<p><img src="https://cdn.syst.top/%E6%88%AA%E5%B1%8F2021-10-10%20%E4%B8%8B%E5%8D%8810.38.35.png" alt="image"></p>
<p>ä¸Šé¢åœºæ™¯æ˜¯å¿«é€’å‘˜åœ¨ç­‰å°åº“ï¼Œå½“ç„¶åè¿‡æ¥å°åº“ä¹Ÿå¯èƒ½åœ¨ç­‰å¿«é€’å‘˜ã€‚</p>
<p><img src="https://cdn.syst.top/%E6%88%AA%E5%B1%8F2021-10-10%20%E4%B8%8B%E5%8D%8810.47.13.png" alt="image"></p>
<p>å¦‚æœæ²¡æœ‰å¿«é€’æŸœï¼Œå¿«é€’å‘˜åœ¨é€å¿«é€’çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå®¶é‡Œæ²¡äººï¼Œä»–å°±å¾—åœ¨é‚£ç­‰ç€ï¼Œç­‰ç€æœ‰äººæ¥ç­¾æ”¶å¿«é€’ï¼Œä»–æ‰é€è´§ç»“æŸã€‚</p>
<p>å®¢æˆ·åœ¨å¿«é€’å‘˜åˆ°æ¥ä¹‹å‰ï¼Œä»–ä¹Ÿä¸èƒ½ç¦»å¼€å®¶ï¼Œä¸ç„¶å¿«é€’æ¥äº†æ²¡äººæ”¶ï¼Œæ‰€ä»¥ä»–ä¹Ÿå¾—ç­‰åˆ°å¿«é€’å‘˜ä¸Šé—¨ï¼Œç­¾å­—æ”¶äº†å¿«é€’ï¼Œä»–æ‰ç®—æ”¶è´§ç»“æŸã€‚</p>
<p>å½“ç„¶ï¼Œå®¢æˆ·ä¸æ­¢æœ‰è¿™å®¶å¿«é€’ï¼Œå¦‚æœå¿«é€’å‘˜Aåœ¨ç­‰çš„æ—¶å€™åˆæ¥ä¸€ä¸ªå¿«é€’å‘˜Bç»™ä»–é€è´§ã€‚è¿™ä¸ªå¿«é€’å‘˜Bä¸ä»…å¾—ç­‰ç€ï¼Œè¿˜å¾—æ’é˜Ÿã€‚ç­‰åˆ°å®¢æˆ·åˆ°å®¶åï¼Œè‚¯å®šæ˜¯å…ˆç­¾æ”¶Açš„å¿«é€’ï¼Œç„¶åå†ç­¾æ”¶Bçš„å¿«é€’ã€‚</p>
<p>å¯¹åº”åˆ°æ— ç¼“å†²<code>channel</code>ï¼Œ</p>
<p>å‘é€æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰å¯¹åº”çš„æ¥æ”¶è€…<code>ready</code>ï¼Œé‚£ä¹ˆå‘é€è€…å°±è¿›å…¥åˆ°ç­‰å¾…å‘é€é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…æœ‰å¯¹åº”çš„æ¥æ”¶è€…å”¤é†’å®ƒã€‚</p>
<p>æ¥æ”¶æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰å¯¹åº”çš„å‘é€è€…<code>ready</code>ï¼Œé‚£ä¹ˆæ¥æ”¶è€…å°±è¿›å…¥åˆ°ç­‰å¾…æ¥æ”¶é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…æœ‰å¯¹åº”çš„å‘é€è€…å”¤é†’å®ƒã€‚</p>
<p>è¿˜è®°å¾—ä¸Šä¸€ç¯‡æ–‡ç« æˆ‘ä»¬ä»‹ç»è¿‡<code>hchan</code>çš„ç»“æ„å—ã€‚</p>
<p><img src="https://cdn.syst.top/hchan.png" alt="image"></p>
<p>å…¶ä¸­<code>recvq</code> è¡¨ç¤ºç­‰å¾…æ¥æ”¶æ¶ˆæ¯çš„é˜Ÿåˆ—ï¼Œ<code>sendq</code>è¡¨ç¤ºç­‰å¾…å‘é€æ¶ˆæ¯çš„é˜Ÿåˆ—ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹<code>waitq</code>ã€‚</p>
<p><img src="/Users/wuqinqiang/Desktop/waitq.png" alt="image-20211010230421470"></p>
<p><img src="/Users/wuqinqiang/Desktop/sudog.png" alt="image-20211010230607222"></p>
<p>æœ¬è´¨ä¸Š<code>waitq</code>å°±æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œæ›´ç¡®åˆ‡çš„è¯´æ˜¯ä¸€ä¸ªåŒå‘å¾ªç¯çš„é“¾è¡¨ã€‚å…¶ä¸­<code>waitq</code>è®°å½•äº†é“¾è¡¨çš„å¤´å°¾ï¼Œ<code>sudog</code>è®°å½•äº†å½“å‰ç­‰å¾…è€…çš„ä¸Šä¸€ä¸ªç­‰å¾…è€…(<code>prev</code>)å’Œä¸‹ä¸€ä¸ªç­‰å¾…è€…(<code>next</code>)ã€‚</p>
<p>è¿™å°±å¥½åƒå°åº“åœ¨ç­¾æ”¶å®ŒAçš„å¿«é€’åå–Šï¼Œä¸‹ä¸€ä¸ªæ˜¯è°å•Šï¼Ÿ</p>
<p>Aä¼šè¯´:æˆ‘çš„ä¸‹ä¸€ä¸ªæ˜¯Bã€‚</p>
<p>Bä¼šè¯´:æ˜¯æˆ‘ã€‚æˆ‘è®°å¾—æˆ‘ä¸Šä¸€ä¸ªæ˜¯Aï¼Œç›®å‰æˆ‘æ²¡æœ‰ä¸‹ä¸€ä¸ªï¼Œæ‰€ä»¥æˆ‘æ˜¯æœ€åä¸€ä¸ªã€‚</p>
<h3 id="ç¼“å†²">ç¼“å†²</h3>
<p>çœ‹å®Œäº†æ— ç¼“å†²é˜Ÿåˆ—ï¼Œæˆ‘ä»¬å†æ¥çœ‹ç¼“å†²é˜Ÿåˆ—ã€‚è¿˜æ˜¯ç”¨ä¸Šé¢çš„æ•…äº‹ï¼Œ</p>
<p><img src="/Users/wuqinqiang/Desktop/Xnip2021-10-10_23-40-05.jpg" alt="Xnip2021-10-10_23-40-05"></p>
<p>åªè¦å¿«é€’æŸœæœ‰ç©ºé—²æŸœå­ï¼Œå¿«é€’å‘˜å°±å¯ä»¥ç›´æ¥æŠŠå¿«é€’æ”¾åˆ°æŸœå­é‡Œï¼Œè®©å®¢æˆ·è‡ªå·±å»æŸœå­æ‹¿ã€‚å¦‚æœå‘é€æ²¡æœ‰ç©ºé—²çš„æŸœå­ï¼Œé‚£å°±åªèƒ½ç­‰ï¼Œç­‰åˆ°åˆ«äººå‘Šè¯‰æˆ‘æœ‰ç©ºé—²æŸœå­ï¼Œæˆ‘å†æŠŠå¿«é€’æ”¾åˆ°ç©ºå‡ºæ¥çš„æŸœå­é‡Œã€‚</p>
<p>å¯¹åº”åˆ°ç¼“å†²<code>channel</code>ï¼Œä¸Šé¢çš„å¿«é€’æŸœï¼Œå°±æ˜¯ç¼“å†²<code>channel</code>ä¸­å­˜å‚¨æ•°æ®çš„<code>buffer</code>ã€‚</p>
<p>å¯¹äºå‘é€è€…æ¥è¯´ï¼šåªè¦ç¼“å†²åŒºæœªæ»¡ï¼Œå‘é€è€…å°±å¯ä»¥ç»§ç»­å‘é€æ•°æ®å­˜æ”¾åœ¨ç¼“å†²åŒºã€‚ä¸€æ—¦ç¼“å†²åŒºæ»¡äº†ï¼Œå‘é€è€…å°±åªèƒ½è¿›å…¥åˆ°ç­‰å¾…å‘é€é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…æœ‰å¯¹åº”çš„æ¥æ”¶è€…å”¤é†’å®ƒï¼Œç„¶åå®ƒå†æŠŠæ•°æ®æ”¾å…¥åˆ°åˆšåˆšè¢«å–èµ°æ•°æ®çš„ä½ç½®ã€‚</p>
<p>å¯¹äºæ¥æ”¶è€…æ¥è¯´ï¼šåªè¦ç¼“å†²åŒºä¸ä¸ºç©ºï¼Œæ¥æ”¶è€…å°±å¯ä»¥ç»§ç»­æ¥æ”¶æ•°æ®ã€‚ä¸€æ—¦ç¼“å†²åŒºç©ºäº†ï¼Œé‚£ä¹ˆæ¥æ”¶è€…å°±åªèƒ½è¿›å…¥åˆ°ç­‰å¾…æ¥æ”¶é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…æœ‰å¯¹åº”çš„å‘é€è€…å”¤é†’å®ƒã€‚</p>
<p>ä¸Šé¢è¿˜æœ‰ä»€ä¹ˆé—®é¢˜å—ï¼Ÿè¿˜çœŸæœ‰ã€‚</p>
<p>æˆ‘ä»¬å–å¿«é€’çš„æ—¶å€™ï¼Œä½ ä¸€å®šä¼šæŒ‰ç…§å¿«é€’æ”¾å…¥åˆ°å¿«é€’æŸœçš„å…ˆåé¡ºåºå–å¿«é€’å—ï¼Ÿå’‹ä¹ˆå¯èƒ½ã€‚</p>
<p>ä½†æ˜¯åœ¨<code>channel</code>ä¸­ï¼Œæ˜¯ä¼šä¿è¯æ¶ˆæ¯çš„å…ˆè¿›å…ˆå‡º(FIFO)å…³ç³»çš„ã€‚è‡³äºå’‹ä¹ˆä¿è¯çš„ï¼Œæˆ‘ä»¬ç»ˆç»“ç¯‡è§£æä»£ç ç»†èŠ‚çš„æ—¶å€™å†è¯´ã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>è¿™ç¯‡æ–‡ç« ä¸»è¦é€šè¿‡ä¸€ä¸ªå¿«é€’çš„ä¾‹å­æ¥ä»‹ç»<code>channel</code>æ“ä½œçš„åŸç†ã€‚ä¸‹ä¸€ç¯‡æˆ‘ä»¬ä»‹ç»<code>channel</code>é’ˆå¯¹ä¸Šè¿°å¤„ç†çš„ç»†èŠ‚é€»è¾‘ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>å¯¹CAPç†è®ºçš„ç†è§£</title>
			<link>https://www.syst.top/posts/go/dtm/</link>
			<pubDate>Sun, 10 Oct 2021 21:25:52 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/dtm/</guid>
			<description>ä»‹ç» æœ€è¿‘ç»å¸¸çœ‹åˆ°æœ‰äººå‘ä¸€ä¸ªGoå®ç°çš„åˆ†å¸ƒå¼äº‹åŠ¡ç®¡ç†å™¨ï¼Œçœ‹åˆ°starå¢çš„æŒºçŒ›çš„ï¼Œç´¢æ€§çœ‹çœ‹ä»£ç å®ç°ï¼Œæ¯•ç«Ÿå·¥ä½œä¸­éƒ¨åˆ†åœºæ™¯ä¹Ÿç”¨çš„ä¸Šã€‚
åœ¨å†™æºç åˆ†æä¹‹å‰ï¼Œæˆ‘ä»¬æ¥ç®€å•äº†è§£ä¸€äº›æ¦‚å¿µå‹çš„ä¸œè¥¿ã€‚
CAP åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¾ˆå¤§çš„ä¸€ä¸ªéš¾ç‚¹åœ¨äºå„ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„çŠ¶æ€å¦‚ä½•åŒæ­¥ï¼ŒCAPå°±æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿé¢†åŸŸä¸€æ¡å·²ç»è¢«è¯æ˜çš„å®šå¾‹ã€‚
å…¶ä¸­å„ä¸ªå­—æ¯çš„å«ä¹‰å¦‚ä¸‹ï¼Œ
 Consistency(ä¸€è‡´æ€§) Availability(å¯ç”¨æ€§) Partition tolerance(åˆ†åŒºå®¹å¿æ€§)  ä¸‹é¢æˆ‘ä»¬ç”¨ä¸€äº›ç®€å•çš„ä¾‹å­æ¥è¯´æ˜ã€‚
å‡è®¾æˆ‘ä»¬çš„ç³»ç»Ÿæ˜¯ç”±ä¸¤ä¸ªæœåŠ¡ç»„æˆçš„:G1å’ŒG2ã€‚
G1å’ŒG2ç»´æŠ¤äº†åŒä¸€æ¡è®°å½•V0ã€‚G1å’ŒG2å¯ä»¥ç›¸äº’é€šä¿¡ï¼Œå¤–éƒ¨å®¢æˆ·ç«¯(Client)å¯ä»¥è°ƒç”¨ä»»æ„ä¸€ä¸ªæœåŠ¡ã€‚
å½“ä¸€ä¸ªå®¢æˆ·ç«¯å¯¹ä»»æ„ä¸€ä¸ªæœåŠ¡å‘èµ·è¯»|å†™è¯·æ±‚ï¼Œé‚£ä¹ˆè¢«è¯·æ±‚çš„é‚£ä¸ªæœåŠ¡å™¨æ ¹æ®å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¤„ç†ã€å“åº”ç»“æœã€‚
æ¯”å¦‚å®¢æˆ·ç«¯å‘G1å‘èµ·ä¸€ä¸ªè¯»æ“ä½œï¼Œå®¢æˆ·ç«¯G1å“åº”è¯·æ±‚ã€‚
åˆæ¯”å¦‚å®¢æˆ·ç«¯å‘G1å‘èµ·ä¸€ä¸ªå†™æ“ä½œï¼ŒæŠŠV0ä¿®æ”¹æˆV1ã€‚
Consistency(ä¸€è‡´æ€§) è¿™ä¸ªä¸€è‡´æ€§å’Œäº‹åŠ¡ä¸­ACIDä¸­çš„Cè¿˜æ˜¯æœ‰åŒºåˆ«çš„ã€‚äº‹åŠ¡ä¸­çš„Cæ›´å¤šæ˜¯æŒ‡åœ¨äº‹åŠ¡å¼€å§‹ä¹‹å‰å’Œäº‹åŠ¡ç»“æŸä»¥åï¼Œæ•°æ®åº“çš„å®Œæ•´æ€§æ²¡æœ‰è¢«ç ´åã€‚è¿™é‡Œçš„å®Œæ•´æ€§åŒ…æ‹¬ä¸€äº›å¤–é”®çº¦æŸã€é”®çš„å”¯ä¸€æ€§ç­‰ã€‚
è€Œåˆ†å¸ƒå¼äº‹åŠ¡ä¸­çš„CæŒ‡çš„æ˜¯ï¼Œå†™æ“ä½œä¹‹åçš„è¯»æ“ä½œï¼Œå¿…é¡»è¿”å›è¯¥å€¼ï¼Œè¿™å°±ç­‰åŒäºæ‰€æœ‰èŠ‚ç‚¹è®¿é—®çš„æ˜¯åŒä¸€ä»½æœ€æ–°æ•°æ®çš„å‰¯æœ¬ã€‚
ä¸‹é¢æ˜¯ä¸€ä¸ªéä¸€è‡´æ€§çš„ä¾‹å­ã€‚
å®¢æˆ·ç«¯æˆåŠŸè¯·æ±‚G1æœåŠ¡å™¨å†™V1ã€‚ç”±äºç½‘ç»œåˆ†åŒºï¼Œå¯¼è‡´G1æ•°æ®ä¸èƒ½åŒæ­¥åˆ°G2ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯ä»G2è¯»å–æ•°æ®ï¼Œä¾æ—§è¿”å›V0ã€‚
æ¥çœ‹ä¸€ä¸ªæ»¡è¶³ä¸€è‡´æ€§çš„ä¾‹å­ã€‚
åœ¨è¿™ä¸ªç³»ç»Ÿä¸­ï¼ŒG1æ”¶åˆ°å®¢æˆ·ç«¯å†™V1çš„æ“ä½œï¼ŒG1åœ¨ä¿®æ”¹è‡ªèº«æ•°æ®çš„åŒæ—¶ï¼Œä¼šæŠŠV1æ•°æ®åŒæ­¥åˆ°G2ã€‚G1åœ¨æ”¶åˆ°G2çš„å“åº”åï¼Œæ‰å‘å®¢æˆ·ç«¯å“åº”ç»“æœã€‚è¿™æ ·ï¼Œä¹‹åæ— è®ºå®¢æˆ·ç«¯ä»å“ªä¸ªèŠ‚ç‚¹è¯»å–æ•°æ®ï¼Œéƒ½èƒ½è·å–åˆ°V1å€¼ã€‚
Availability(å¯ç”¨æ€§) å¯ç”¨æ€§æŒ‡çš„æ˜¯ç³»ç»Ÿä¸­éæ•…éšœèŠ‚ç‚¹æ¥æ”¶åˆ°çš„æ¯ä¸€ä¸ªè¯·æ±‚éƒ½å¿…é¡»å“åº”ã€‚
åœ¨ä¸€ä¸ªå¯ç”¨çš„ç³»ç»Ÿä¸­ï¼Œå¦‚æœå®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œé‚£ä¹ˆæœåŠ¡å™¨å¿…é¡»å“åº”å®¢æˆ·ç«¯æ¯ä¸€ä¸ªè¯·æ±‚ï¼Œä¸å…è®¸å¿½ç•¥å®¢æˆ·ç«¯è¯·æ±‚ã€‚
Partition Tolerance(åˆ†åŒºå®¹å¿æ€§) ä»€ä¹ˆåˆ†åŒºï¼Ÿ
 ç½‘ç»œåˆ†åŒºã€‚
 ç½‘ç»œåˆ†åŒºå’‹ä¹ˆç†è§£ï¼Ÿ
 å‡è®¾æœ‰ä¸¤å°æœåŠ¡å™¨Aå’ŒBï¼Œæœ¬æ¥ä»–ä»¬ä¸¤æ˜¯æ­£å¸¸é€šä¿¡çš„ï¼Œä¸çŸ¥é“å•¥åŸå› ï¼Œä»–ä»¬ä¹‹é—´çš„ç½‘ç»œé“¾æ¥æ–­å¼€ï¼Œå¯¼è‡´æ— æ³•æ­£å¸¸é€šä¿¡ã€‚æ­¤æ—¶æœ¬æ¥åœ¨åŒä¸€ä¸ªç½‘ç»œçš„ABï¼Œå‘ç”Ÿäº†ç½‘ç»œåˆ†åŒºã€‚å˜æˆäº†Aæ‰€åœ¨çš„Aç½‘ç»œå’ŒBæ‰€åœ¨çš„Bç½‘ç»œã€‚è¿™å°±æ˜¯ç½‘ç»œåˆ†åŒºã€‚
 å®¹å¿æ€§æ˜¯æŒ‡ä»€ä¹ˆï¼Ÿ
 å½“ä¸€ä¸ªæœåŠ¡çš„å¤šå°æœåŠ¡å™¨å‘ç”Ÿä¸Šè¿°ç½‘ç»œåˆ†åŒºçš„æ—¶å€™ï¼Œç³»ç»Ÿä¾æ—§èƒ½æ­£å¸¸æä¾›æœåŠ¡ã€‚
 å¯¹CAPçš„è¯¯è§£ ç½‘ä¸Šå¾ˆå¤šæ–‡ç« éƒ½æ˜¯è¿™ä¹ˆè¯´çš„ï¼š
 ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿæœ€å¤šåªèƒ½åŒæ—¶æ»¡è¶³ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰å’Œåˆ†åŒºå®¹é”™æ€§ï¼ˆPartition toleranceï¼‰è¿™ä¸‰é¡¹ä¸­çš„ä¸¤é¡¹ï¼Œè¿™è¢«ç§°ä¸ºCAPå®šå¾‹ã€‚
 ä¼¼ä¹CAPè¢«è§£é‡Šæˆä¸€ç§ä¸‰é€‰äºŒçš„å®šå¾‹ã€‚
çœ‹åˆ°ä¸€ç¯‡æ–‡ç« CAP Twelve Years Later: How the &amp;quot;Rules&amp;quot; Have Changedæœ‰ä¸€æ®µCAPçš„å®Œæ•´è¡¨è¿°ï¼š
 The CAP theorem asserts that any netÂ­worked shared-data system can have only two of three desirable propertiesã€‚</description>
			<content type="html"><![CDATA[<h3 id="ä»‹ç»">ä»‹ç»</h3>
<p>æœ€è¿‘ç»å¸¸çœ‹åˆ°æœ‰äººå‘ä¸€ä¸ªGoå®ç°çš„åˆ†å¸ƒå¼äº‹åŠ¡ç®¡ç†å™¨ï¼Œçœ‹åˆ°starå¢çš„æŒºçŒ›çš„ï¼Œç´¢æ€§çœ‹çœ‹ä»£ç å®ç°ï¼Œæ¯•ç«Ÿå·¥ä½œä¸­éƒ¨åˆ†åœºæ™¯ä¹Ÿç”¨çš„ä¸Šã€‚</p>
<p>åœ¨å†™æºç åˆ†æä¹‹å‰ï¼Œæˆ‘ä»¬æ¥ç®€å•äº†è§£ä¸€äº›æ¦‚å¿µå‹çš„ä¸œè¥¿ã€‚</p>
<h3 id="cap">CAP</h3>
<p>åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¾ˆå¤§çš„ä¸€ä¸ªéš¾ç‚¹åœ¨äºå„ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„çŠ¶æ€å¦‚ä½•åŒæ­¥ï¼ŒCAPå°±æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿé¢†åŸŸä¸€æ¡å·²ç»è¢«è¯æ˜çš„å®šå¾‹ã€‚</p>
<p>å…¶ä¸­å„ä¸ªå­—æ¯çš„å«ä¹‰å¦‚ä¸‹ï¼Œ</p>
<ul>
<li><strong>C</strong>onsistency(ä¸€è‡´æ€§)</li>
<li><strong>A</strong>vailability(å¯ç”¨æ€§)</li>
<li><strong>P</strong>artition tolerance(åˆ†åŒºå®¹å¿æ€§)</li>
</ul>
<p>ä¸‹é¢æˆ‘ä»¬ç”¨ä¸€äº›ç®€å•çš„ä¾‹å­æ¥è¯´æ˜ã€‚</p>
<p><img src="https://cdn.syst.top/dtm01.svg" alt="dtm01"></p>
<p>å‡è®¾æˆ‘ä»¬çš„ç³»ç»Ÿæ˜¯ç”±ä¸¤ä¸ªæœåŠ¡ç»„æˆçš„:G1å’ŒG2ã€‚</p>
<p>G1å’ŒG2ç»´æŠ¤äº†åŒä¸€æ¡è®°å½•V0ã€‚G1å’ŒG2å¯ä»¥ç›¸äº’é€šä¿¡ï¼Œå¤–éƒ¨å®¢æˆ·ç«¯(Client)å¯ä»¥è°ƒç”¨ä»»æ„ä¸€ä¸ªæœåŠ¡ã€‚</p>
<p>å½“ä¸€ä¸ªå®¢æˆ·ç«¯å¯¹ä»»æ„ä¸€ä¸ªæœåŠ¡å‘èµ·è¯»|å†™è¯·æ±‚ï¼Œé‚£ä¹ˆè¢«è¯·æ±‚çš„é‚£ä¸ªæœåŠ¡å™¨æ ¹æ®å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¤„ç†ã€å“åº”ç»“æœã€‚</p>
<p>æ¯”å¦‚å®¢æˆ·ç«¯å‘G1å‘èµ·ä¸€ä¸ªè¯»æ“ä½œï¼Œå®¢æˆ·ç«¯G1å“åº”è¯·æ±‚ã€‚</p>
<p><img src="https://cdn.syst.top/dtm02.png" alt="dtm01"></p>
<p>åˆæ¯”å¦‚å®¢æˆ·ç«¯å‘G1å‘èµ·ä¸€ä¸ªå†™æ“ä½œï¼ŒæŠŠV0ä¿®æ”¹æˆV1ã€‚</p>
<p><img src="https://cdn.syst.top/dtm03.png" alt="dtm01"></p>
<h4 id="consistencyä¸€è‡´æ€§">Consistency(ä¸€è‡´æ€§)</h4>
<p>è¿™ä¸ªä¸€è‡´æ€§å’Œäº‹åŠ¡ä¸­ACIDä¸­çš„Cè¿˜æ˜¯æœ‰åŒºåˆ«çš„ã€‚äº‹åŠ¡ä¸­çš„Cæ›´å¤šæ˜¯æŒ‡åœ¨äº‹åŠ¡å¼€å§‹ä¹‹å‰å’Œäº‹åŠ¡ç»“æŸä»¥åï¼Œæ•°æ®åº“çš„å®Œæ•´æ€§æ²¡æœ‰è¢«ç ´åã€‚è¿™é‡Œçš„å®Œæ•´æ€§åŒ…æ‹¬ä¸€äº›å¤–é”®çº¦æŸã€é”®çš„å”¯ä¸€æ€§ç­‰ã€‚</p>
<p>è€Œåˆ†å¸ƒå¼äº‹åŠ¡ä¸­çš„CæŒ‡çš„æ˜¯ï¼Œå†™æ“ä½œä¹‹åçš„è¯»æ“ä½œï¼Œå¿…é¡»è¿”å›è¯¥å€¼ï¼Œè¿™å°±ç­‰åŒäºæ‰€æœ‰èŠ‚ç‚¹è®¿é—®çš„æ˜¯åŒä¸€ä»½æœ€æ–°æ•°æ®çš„å‰¯æœ¬ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªéä¸€è‡´æ€§çš„ä¾‹å­ã€‚</p>
<p><img src="https://cdn.syst.top/dtm04.png" alt="dtm01"></p>
<p>å®¢æˆ·ç«¯æˆåŠŸè¯·æ±‚G1æœåŠ¡å™¨å†™V1ã€‚ç”±äºç½‘ç»œåˆ†åŒºï¼Œå¯¼è‡´G1æ•°æ®ä¸èƒ½åŒæ­¥åˆ°G2ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯ä»G2è¯»å–æ•°æ®ï¼Œä¾æ—§è¿”å›V0ã€‚</p>
<p>æ¥çœ‹ä¸€ä¸ªæ»¡è¶³ä¸€è‡´æ€§çš„ä¾‹å­ã€‚</p>
<p><img src="https://cdn.syst.top/dtm05.png" alt="dtm01"></p>
<p>åœ¨è¿™ä¸ªç³»ç»Ÿä¸­ï¼ŒG1æ”¶åˆ°å®¢æˆ·ç«¯å†™V1çš„æ“ä½œï¼ŒG1åœ¨ä¿®æ”¹è‡ªèº«æ•°æ®çš„åŒæ—¶ï¼Œä¼šæŠŠV1æ•°æ®åŒæ­¥åˆ°G2ã€‚G1åœ¨æ”¶åˆ°G2çš„å“åº”åï¼Œæ‰å‘å®¢æˆ·ç«¯å“åº”ç»“æœã€‚è¿™æ ·ï¼Œä¹‹åæ— è®ºå®¢æˆ·ç«¯ä»å“ªä¸ªèŠ‚ç‚¹è¯»å–æ•°æ®ï¼Œéƒ½èƒ½è·å–åˆ°V1å€¼ã€‚</p>
<h4 id="availabilityå¯ç”¨æ€§">Availability(å¯ç”¨æ€§)</h4>
<p>å¯ç”¨æ€§æŒ‡çš„æ˜¯ç³»ç»Ÿä¸­éæ•…éšœèŠ‚ç‚¹æ¥æ”¶åˆ°çš„æ¯ä¸€ä¸ªè¯·æ±‚éƒ½å¿…é¡»å“åº”ã€‚</p>
<p>åœ¨ä¸€ä¸ªå¯ç”¨çš„ç³»ç»Ÿä¸­ï¼Œå¦‚æœå®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œé‚£ä¹ˆæœåŠ¡å™¨å¿…é¡»å“åº”å®¢æˆ·ç«¯æ¯ä¸€ä¸ªè¯·æ±‚ï¼Œä¸å…è®¸å¿½ç•¥å®¢æˆ·ç«¯è¯·æ±‚ã€‚</p>
<h4 id="partition-toleranceåˆ†åŒºå®¹å¿æ€§">Partition Tolerance(åˆ†åŒºå®¹å¿æ€§)</h4>
<p>ä»€ä¹ˆåˆ†åŒºï¼Ÿ</p>
<blockquote>
<p>ç½‘ç»œåˆ†åŒºã€‚</p>
</blockquote>
<p>ç½‘ç»œåˆ†åŒºå’‹ä¹ˆç†è§£ï¼Ÿ</p>
<blockquote>
<p>å‡è®¾æœ‰ä¸¤å°æœåŠ¡å™¨Aå’ŒBï¼Œæœ¬æ¥ä»–ä»¬ä¸¤æ˜¯æ­£å¸¸é€šä¿¡çš„ï¼Œä¸çŸ¥é“å•¥åŸå› ï¼Œä»–ä»¬ä¹‹é—´çš„ç½‘ç»œé“¾æ¥æ–­å¼€ï¼Œå¯¼è‡´æ— æ³•æ­£å¸¸é€šä¿¡ã€‚æ­¤æ—¶æœ¬æ¥åœ¨åŒä¸€ä¸ªç½‘ç»œçš„ABï¼Œå‘ç”Ÿäº†ç½‘ç»œåˆ†åŒºã€‚å˜æˆäº†Aæ‰€åœ¨çš„Aç½‘ç»œå’ŒBæ‰€åœ¨çš„Bç½‘ç»œã€‚è¿™å°±æ˜¯ç½‘ç»œåˆ†åŒºã€‚</p>
</blockquote>
<p>å®¹å¿æ€§æ˜¯æŒ‡ä»€ä¹ˆï¼Ÿ</p>
<blockquote>
<p>å½“ä¸€ä¸ªæœåŠ¡çš„å¤šå°æœåŠ¡å™¨å‘ç”Ÿä¸Šè¿°ç½‘ç»œåˆ†åŒºçš„æ—¶å€™ï¼Œç³»ç»Ÿä¾æ—§èƒ½æ­£å¸¸æä¾›æœåŠ¡ã€‚</p>
</blockquote>
<h3 id="å¯¹capçš„è¯¯è§£">å¯¹CAPçš„è¯¯è§£</h3>
<p>ç½‘ä¸Šå¾ˆå¤šæ–‡ç« éƒ½æ˜¯è¿™ä¹ˆè¯´çš„ï¼š</p>
<blockquote>
<p>ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿæœ€å¤šåªèƒ½åŒæ—¶æ»¡è¶³ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰å’Œåˆ†åŒºå®¹é”™æ€§ï¼ˆPartition toleranceï¼‰è¿™ä¸‰é¡¹ä¸­çš„ä¸¤é¡¹ï¼Œè¿™è¢«ç§°ä¸ºCAPå®šå¾‹ã€‚</p>
</blockquote>
<p>ä¼¼ä¹CAPè¢«è§£é‡Šæˆä¸€ç§ä¸‰é€‰äºŒçš„å®šå¾‹ã€‚</p>
<p>çœ‹åˆ°ä¸€ç¯‡æ–‡ç« <code>CAP Twelve Years Later: How the &quot;Rules&quot; Have Changed</code>æœ‰ä¸€æ®µCAPçš„å®Œæ•´è¡¨è¿°ï¼š</p>
<blockquote>
<p>The CAP theorem asserts that any netÂ­worked shared-data system can have only two of three desirable propertiesã€‚</p>
</blockquote>
<p>æŒ‰ç…§è¡¨è¿°ï¼Œå‘ç°ç½‘ä¸Šè¿™å¥è¯å­˜åœ¨ä¸€å®šçš„è¯¯å¯¼æ€§ã€‚</p>
<p>CAPå®šå¾‹çš„å‰ææ˜¯P(ç½‘ç»œåˆ†åŒº)ï¼Œå‡ºç°Pä¹‹åæ‰ä¼šæœ‰CAçš„é€‰æ‹©ã€‚</p>
<p>å½“På‘ç”Ÿçš„æ—¶å€™ï¼Œè€Œæˆ‘ä»¬çš„ç³»ç»Ÿç›´æ¥ä¸æœåŠ¡äº†ï¼Œé‚£å°±ä¸å­˜åœ¨é€‰æ‹©ä»€ä¹ˆCAäº†ã€‚</p>
<p>å› æ­¤CAPçš„æ­£å¸¸ç†è§£åº”è¯¥æ˜¯ï¼šå½“P(ç½‘ç»œåˆ†åŒº)å‘ç”Ÿçš„æ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬è¦ç»§ç»­æä¾›æœåŠ¡ï¼Œé‚£ä¹ˆC(å¼ºä¸€è‡´æ€§)å’ŒA(å¯ç”¨æ€§)åªèƒ½2é€‰1äº†ã€‚</p>
<h3 id="consistencyå’Œavailabilityçš„çŸ›ç›¾">Consistencyå’ŒAvailabilityçš„çŸ›ç›¾</h3>
<p>ä¸ºä»€ä¹ˆå½“På‘ç”Ÿæ—¶ï¼ŒCAåªèƒ½äºŒé€‰ä¸€ï¼Ÿ</p>
<p>è¿˜æ˜¯ä¹‹å‰é‚£ä¸ªç®€å•çš„ä¾‹å­ã€‚</p>
<p>å‡è®¾æ­¤æ—¶G1å’ŒG2å‘ç”Ÿäº†ç½‘ç»œåˆ†åŒºã€‚</p>
<p><img src="https://cdn.syst.top/dtm01.svg" alt="dtm01"></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çš„å®¢æˆ·ç«¯è¯·æ±‚G1å†™V1æ•°æ®ã€‚ç”±äºåˆ†åŒºï¼ŒG1ä¸èƒ½åŒæ­¥æ•°æ®åˆ°G2ã€‚</p>
<p><img src="https://cdn.syst.top/dtm06.png" alt="dtm01"></p>
<p><img src="https://cdn.syst.top/dtm07.png" alt=""></p>
<p>å¦‚æœæˆ‘ä»¬ä¿è¯G2çš„å¯ç”¨æ€§ï¼Œé‚£ä¹ˆå½“å®¢æˆ·ç«¯è¯·æ±‚G2æ•°æ®çš„æ—¶å€™ï¼ŒG2èƒ½æ­£å¸¸å“åº”V0æ•°æ®ï¼Œæ•°æ®ä¸ä¸€è‡´ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬ä¿è¯G2çš„ä¸€è‡´æ€§ï¼Œé‚£ä¹ˆåœ¨G1å†™æ“ä½œçš„æ—¶å€™ï¼Œéœ€è¦é”å®šG2çš„è¯»å†™æ“ä½œï¼Œæ­¤æ—¶G2ä¸å¯ç”¨ã€‚</p>
<p>å› æ­¤ï¼ŒConsistencyå’ŒAvailabilityå­˜åœ¨çŸ›ç›¾ã€‚</p>
<h3 id="å‚è€ƒ">å‚è€ƒ</h3>
<ul>
<li>
<p><a href="https://www.infoq.com/articles/cap-twelve-years-later-how-the-rules-have-changed/">https://www.infoq.com/articles/cap-twelve-years-later-how-the-rules-have-changed/</a></p>
</li>
<li>
<p><a href="https://mwhittaker.github.io/blog/an_illustrated_proof_of_the_cap_theorem/">https://mwhittaker.github.io/blog/an_illustrated_proof_of_the_cap_theorem/</a></p>
</li>
<li>
<p><a href="https://www.zhihu.com/question/64778723">https://www.zhihu.com/question/64778723</a></p>
</li>
</ul>
]]></content>
		</item>
		
		<item>
			<title>è¶…å®ç”¨çš„ gRPC å®¢æˆ·ç«¯è°ƒè¯•å·¥å…·</title>
			<link>https://www.syst.top/posts/go/grpc/</link>
			<pubDate>Tue, 27 Jul 2021 10:01:52 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/grpc/</guid>
			<description>ä»‹ç» æ­£å¥½çœ‹åˆ°è‘£æ³½æ¶¦è€å“¥å†™äº†ä¸€ç¯‡å…³äºä½¿ç”¨ WireShark åˆ†æ gRPC æµé‡çš„æ–‡ç« ï¼Œå­¦åˆ°äº†ã€‚
é‚£æˆ‘å°±ä»‹ç»ä¸¤ä¸ªæ—¥å¸¸å¼€å‘ä½¿ç”¨è¿‡çš„ä¸¤æ¬¾ gRPC å®¢æˆ·ç«¯è°ƒè¯•å·¥å…·å§ã€‚
Evans Evans æœ‰ä¸¤ç§æ¨¡å¼ï¼šREPL å’Œ CLIã€‚æ¯”èµ·å…¶ä»– gRPC å®¢æˆ·ç«¯,æ›´å…·æœ‰è¡¨ç°åŠ›ã€‚å¹¶ä¸”å®ƒè¿˜æ”¯æŒè‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ã€‚
å®ƒçš„å®‰è£…éå¸¸æ–¹ä¾¿ï¼Œåœ¨ Mac ä¸Šæˆ‘ä»¬åªéœ€è¦æ‰§è¡Œä»¥ä¸‹ä¸¤è¡Œå‘½ä»¤å³å¯ã€‚
$ brew tap ktr0731/evans $ brew install evans æˆ‘ä»¬æ¥æ“ä½œä¸€ä¸‹ REPL æ¨¡å¼ã€‚
é¦–å…ˆæˆ‘ä»¬éœ€è¦æœ‰ä¸€ä¸ª pb æ–‡ä»¶ï¼Œå‡è®¾ä½ çš„æ–‡ä»¶åœ¨ api/api.protoï¼Œæˆ‘ä»¬åªéœ€è¦è¿™æ ·ï¼š é»˜è®¤åœ°å€ä¸º 127.0.0.1:50051ï¼Œå½“ç„¶ä½ å¯ä»¥é€šè¿‡ --host å’Œ --port æ¥æŒ‡å®šæœåŠ¡å™¨ã€‚ ä¸Šå›¾çš„å‘½ä»¤:
 show package è¯»å– pb åŒ…åï¼Œ show service æ˜¾ç¤ºå¯¹åº”æœåŠ¡åˆ—è¡¨ã€‚ call xxx è°ƒç”¨ grpc æœåŠ¡&amp;hellip;&amp;hellip; &amp;hellip;..  æ›´å¤šå‘½ä»¤å¯è‡ªè¡ŒæŸ¥é˜…å®˜ç½‘ã€‚
é™¤äº†ä¸Šè¿°è¿™ç§ç›´æ¥å¼•å…¥ pb æ–‡ä»¶å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ gRPC åå°„åŒ…(reflection)ï¼Œ å°† grpc.Server æ³¨å†Œåˆ°åå°„æœåŠ¡ä¸­, è¿™æ ·çš„è¯ï¼Œå°±å¯ä»¥é€šè¿‡ reflection æä¾›çš„åå°„æœåŠ¡æŸ¥è¯¢åˆ°å¯¹åº”çš„ gRPC æœåŠ¡æˆ–è€…è°ƒç”¨ gRPC æœåŠ¡ã€‚</description>
			<content type="html"><![CDATA[<h3 id="ä»‹ç»">ä»‹ç»</h3>
<p>æ­£å¥½çœ‹åˆ°è‘£æ³½æ¶¦è€å“¥å†™äº†ä¸€ç¯‡å…³äºä½¿ç”¨ <code>WireShark</code> åˆ†æ <code>gRPC</code> æµé‡çš„æ–‡ç« ï¼Œå­¦åˆ°äº†ã€‚</p>
<p>é‚£æˆ‘å°±ä»‹ç»ä¸¤ä¸ªæ—¥å¸¸å¼€å‘ä½¿ç”¨è¿‡çš„ä¸¤æ¬¾ <code>gRPC</code> å®¢æˆ·ç«¯è°ƒè¯•å·¥å…·å§ã€‚</p>
<h2 id="evans">Evans</h2>
<p><code>Evans</code> æœ‰ä¸¤ç§æ¨¡å¼ï¼š<code>REPL</code> å’Œ <code>CLI</code>ã€‚æ¯”èµ·å…¶ä»– <code>gRPC</code> å®¢æˆ·ç«¯,æ›´å…·æœ‰è¡¨ç°åŠ›ã€‚å¹¶ä¸”å®ƒè¿˜æ”¯æŒè‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ã€‚</p>
<p>å®ƒçš„å®‰è£…éå¸¸æ–¹ä¾¿ï¼Œåœ¨ <code>Mac</code> ä¸Šæˆ‘ä»¬åªéœ€è¦æ‰§è¡Œä»¥ä¸‹ä¸¤è¡Œå‘½ä»¤å³å¯ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="err">$</span> <span class="nx">brew</span> <span class="nx">tap</span> <span class="nx">ktr0731</span><span class="o">/</span><span class="nx">evans</span>
</span></span><span class="line"><span class="cl"><span class="err">$</span> <span class="nx">brew</span> <span class="nx">install</span> <span class="nx">evans</span>
</span></span></code></pre></div><p>æˆ‘ä»¬æ¥æ“ä½œä¸€ä¸‹ <code>REPL</code> æ¨¡å¼ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦æœ‰ä¸€ä¸ª <code>pb</code> æ–‡ä»¶ï¼Œå‡è®¾ä½ çš„æ–‡ä»¶åœ¨ <code>api/api.proto</code>ï¼Œæˆ‘ä»¬åªéœ€è¦è¿™æ ·ï¼š
<img src="https://image.syst.top/image/grpc/1.gif" alt="image"></p>
<p>é»˜è®¤åœ°å€ä¸º <code>127.0.0.1:50051</code>ï¼Œå½“ç„¶ä½ å¯ä»¥é€šè¿‡ <code>--host</code> å’Œ <code>--port</code> æ¥æŒ‡å®šæœåŠ¡å™¨ã€‚
<img src="https://image.syst.top/image/grpc/2.png" alt="image"></p>
<p>ä¸Šå›¾çš„å‘½ä»¤:</p>
<ul>
<li><code>show package</code> è¯»å– <code>pb</code> åŒ…åï¼Œ</li>
<li><code>show service</code> æ˜¾ç¤ºå¯¹åº”æœåŠ¡åˆ—è¡¨ã€‚</li>
<li><code>call xxx</code> è°ƒç”¨ <code>grpc</code> æœåŠ¡&hellip;&hellip;</li>
<li>&hellip;..</li>
</ul>
<p>æ›´å¤šå‘½ä»¤å¯è‡ªè¡ŒæŸ¥é˜…å®˜ç½‘ã€‚</p>
<p>é™¤äº†ä¸Šè¿°è¿™ç§ç›´æ¥å¼•å…¥ <code>pb</code> æ–‡ä»¶å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ <code>gRPC</code> åå°„åŒ…(<code>reflection</code>)ï¼Œ å°† <code>grpc.Server</code> æ³¨å†Œåˆ°åå°„æœåŠ¡ä¸­,
è¿™æ ·çš„è¯ï¼Œå°±å¯ä»¥é€šè¿‡ <code>reflection</code> æä¾›çš„åå°„æœåŠ¡æŸ¥è¯¢åˆ°å¯¹åº”çš„ <code>gRPC</code> æœåŠ¡æˆ–è€…è°ƒç”¨ <code>gRPC</code> æœåŠ¡ã€‚</p>
<p>æ“ä½œèµ·æ¥å¾ˆç®€å•ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;google.golang.org/grpc&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;google.golang.org/grpc/reflection&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">grpcServer</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">reflection</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nx">grpcServer</span><span class="p">)</span>
</span></span></code></pre></div><p>å›åˆ° <code>Evans</code> å·¥å…·ï¼Œ å¦‚æœä¸€ä¸ª <code>gRPC</code> æœåŠ¡å¯åŠ¨äº†åå°„ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ <code>-r (--reflection)</code> é€‰é¡¹æ¥å¯åŠ¨ <code>Evans</code>ã€‚</p>
<p>æ¯”å¦‚åƒä¸‹é¢è¿™æ ·ï¼š
<img src="https://image.syst.top/image/grpc/3.gif" alt="image"></p>
<h3 id="bloomrpc">BloomRPC</h3>
<p><code>BloomRPC</code> æ˜¯ä¸€ä¸ªç®€å•çš„<code>GUI</code> å®¢æˆ·ç«¯å·¥å…·ï¼Œä½¿ç”¨è¿™ä¸ªé‚£å°±æ›´ç®€å•äº†ã€‚</p>
<p>åªéœ€è¦å¯¼å…¥ <code>pb</code> æ–‡ä»¶ï¼Œç„¶åç‚¹ä¸¤ä¸‹å³å¯ã€‚
<img src="https://image.syst.top/image/grpc/4.gif" alt="image"></p>
<p>å½“ç„¶æœ‰ä¸ªä¸å¥½ç‚¹åœ¨äºï¼Œæ¯æ¬¡ä¿®æ”¹äº† <code>pb</code>ï¼Œéƒ½ä¸å¾—ä¸é‡æ–°å¯¼å…¥ã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>ä»¥ä¸Šä»‹ç»äº†ä¸¤æ¬¾ <code>gRPC</code> å®¢æˆ·ç«¯å·¥å…·ã€‚ä¸çŸ¥é“ä½ ä»¬å¹³å¸¸éƒ½ä½¿ç”¨ <code>gRPC</code> å“ªäº›å‘¨è¾¹å·¥å…·ï¼Œæ¬¢è¿ä¸€èµ·è®¨è®ºã€‚å½“ç„¶è°ƒè¯•å·¥å…·å†å¥½ï¼Œæ”¹å†™çš„ <code>test</code> è¿˜æ˜¯é€ƒä¸äº†ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>goå¹¶å‘-å·¥ä½œæ± æ¨¡å¼</title>
			<link>https://www.syst.top/posts/go/worker-pool/</link>
			<pubDate>Thu, 01 Jul 2021 23:37:45 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/worker-pool/</guid>
			<description>å¼€ç¯‡ ä¹‹å‰å†™è¿‡ä¸€ç¯‡æ–‡ç« ï¼Œå®ƒæœ‰ä¸ªå“äº®çš„åå­—: Handling 1 Million Requests per Minute with Goã€‚ è¿™æ˜¯å›½å¤–çš„ä¸€ä¸ªä½œè€…å†™çš„ï¼Œæˆ‘åšäº†ä¸€ç¯‡è¯´æ˜ã€‚èµ·çš„ä¹Ÿæ˜¯è¿™ä¸ªæ ‡é¢˜ï¼Œ é˜…è¯»é‡æ˜¯æˆ‘æœ€å¥½çš„ä¸€ç¯‡ï¼Œæœç„¶æ–‡ç« éƒ½æ˜¯é æ ‡é¢˜å‡ºå½©çš„&amp;hellip;..
ä»Šå¤©å¶ç„¶çœ‹åˆ°å¦ä¸€ç¯‡æ–‡ç« (åŸæ–‡åœ¨æ–‡æœ«)ã€‚ä¸¤ç¯‡æ–‡ç« åŸç†ç›¸ä¼¼:æœ‰ä¸€æ‰¹å·¥ä½œä»»åŠ¡(job)ï¼Œé€šè¿‡å·¥ä½œæ± (worker-pool)çš„æ–¹å¼ï¼Œè¾¾åˆ°å¤š worker å¹¶å‘å¤„ç† job çš„æ•ˆæœã€‚
ä»–ä»¬è¿˜æ˜¯æœ‰å¾ˆå¤šä¸åŒçš„ç‚¹ï¼Œå®ç°ä¸Šå·®åˆ«ä¹Ÿæ˜¯è›®å¤§çš„ã€‚
é¦–å…ˆä¸Šä¸€ç¯‡æ–‡ç« æˆ‘æ”¾äº†ä¸€å¼ å›¾ç‰‡ï¼Œå¤§æ¦‚å°±æ˜¯ä¸Šç¯‡æ•´ä½“çš„å·¥ä½œæµã€‚  æ¯ä¸ª worker å¤„ç†å®Œä»»åŠ¡å°±å¥½ï¼Œä¸å…³å¿ƒç»“æœ,ä¸å¯¹ç»“æœåšè¿›ä¸€æ­¥å¤„ç†ã€‚ åªè¦è¯·æ±‚ä¸åœæ­¢ï¼Œç¨‹åºå°±ä¸ä¼šåœæ­¢ï¼Œæ²¡æœ‰æ§åˆ¶æœºåˆ¶ï¼Œé™¤éå®•æœºã€‚  è¿™ç¯‡æ–‡ç« ä¸åŒç‚¹åœ¨äº:
é¦–å…ˆæ•°æ®ä¼šä» generate (ç”Ÿäº§æ•°æ®)-&amp;gt;å¹¶å‘å¤„ç†æ•°æ®-&amp;gt;å¤„ç†ç»“æœèšåˆã€‚ å›¾å¤§æ¦‚æ˜¯è¿™æ ·çš„, ç„¶åå®ƒå¯ä»¥é€šè¿‡ context.context è¾¾åˆ°æ§åˆ¶å·¥ä½œæ± åœæ­¢å·¥ä½œçš„æ•ˆæœã€‚
æœ€åé€šè¿‡ä»£ç ï¼Œä½ ä¼šå‘ç°å®ƒä¸æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„ worker-poolï¼Œåé¢ä¼šè¯´æ˜ã€‚
ä¸‹å›¾èƒ½æ¸…æ™°è¡¨è¾¾æ•´ä½“æµç¨‹äº†ã€‚ é¡ºä¾¿è¯´ä¸€å¥ï¼Œè¿™ç¯‡æ–‡ç« å®ç°çš„ä»£ç æ¯” Handling 1 Million Requests per Minute with Go çš„ä»£ç ç®€å•å¤šäº†ã€‚
é¦–å…ˆçœ‹ jobã€‚
package wpool import ( &amp;#34;context&amp;#34; ) type JobID string type jobType string type jobMetadata map[string]interface{} type ExecutionFn func(ctx context.Context, args interface{}) (interface{}, error) type JobDescriptor struct { ID JobID JType jobType Metadata map[string]interface{} } type Result struct { Value interface{} Err error Descriptor JobDescriptor } type Job struct { Descriptor JobDescriptor ExecFn ExecutionFn Args interface{} } // å¤„ç† job é€»è¾‘,å¤„ç†ç»“æœåŒ…è£…æˆ Result ç»“æœ func (j Job) execute(ctx context.</description>
			<content type="html"><![CDATA[<h3 id="å¼€ç¯‡">å¼€ç¯‡</h3>
<p>ä¹‹å‰å†™è¿‡ä¸€ç¯‡æ–‡ç« ï¼Œå®ƒæœ‰ä¸ªå“äº®çš„åå­—: <code>Handling 1 Million Requests per Minute with Go</code>ã€‚
è¿™æ˜¯å›½å¤–çš„ä¸€ä¸ªä½œè€…å†™çš„ï¼Œæˆ‘åšäº†ä¸€ç¯‡è¯´æ˜ã€‚èµ·çš„ä¹Ÿæ˜¯è¿™ä¸ªæ ‡é¢˜ï¼Œ
é˜…è¯»é‡æ˜¯æˆ‘æœ€å¥½çš„ä¸€ç¯‡ï¼Œæœç„¶æ–‡ç« éƒ½æ˜¯é æ ‡é¢˜å‡ºå½©çš„&hellip;..</p>
<p>ä»Šå¤©å¶ç„¶çœ‹åˆ°å¦ä¸€ç¯‡æ–‡ç« (åŸæ–‡åœ¨æ–‡æœ«)ã€‚ä¸¤ç¯‡æ–‡ç« åŸç†ç›¸ä¼¼:æœ‰ä¸€æ‰¹å·¥ä½œä»»åŠ¡(job)ï¼Œé€šè¿‡å·¥ä½œæ± (worker-pool)çš„æ–¹å¼ï¼Œè¾¾åˆ°å¤š <code>worker</code> å¹¶å‘å¤„ç† <code>job</code> çš„æ•ˆæœã€‚</p>
<p>ä»–ä»¬è¿˜æ˜¯æœ‰å¾ˆå¤šä¸åŒçš„ç‚¹ï¼Œå®ç°ä¸Šå·®åˆ«ä¹Ÿæ˜¯è›®å¤§çš„ã€‚</p>
<p>é¦–å…ˆä¸Šä¸€ç¯‡æ–‡ç« æˆ‘æ”¾äº†ä¸€å¼ å›¾ç‰‡ï¼Œå¤§æ¦‚å°±æ˜¯ä¸Šç¯‡æ•´ä½“çš„å·¥ä½œæµã€‚
<img src="https://image.syst.top/image/work-pool.png" alt="image"></p>
<ul>
<li>æ¯ä¸ª <code>worker</code> å¤„ç†å®Œä»»åŠ¡å°±å¥½ï¼Œä¸å…³å¿ƒç»“æœ,ä¸å¯¹ç»“æœåšè¿›ä¸€æ­¥å¤„ç†ã€‚</li>
<li>åªè¦è¯·æ±‚ä¸åœæ­¢ï¼Œç¨‹åºå°±ä¸ä¼šåœæ­¢ï¼Œæ²¡æœ‰æ§åˆ¶æœºåˆ¶ï¼Œé™¤éå®•æœºã€‚</li>
</ul>
<p>è¿™ç¯‡æ–‡ç« ä¸åŒç‚¹åœ¨äº:</p>
<p>é¦–å…ˆæ•°æ®ä¼šä» <code>generate</code> (ç”Ÿäº§æ•°æ®)-&gt;å¹¶å‘å¤„ç†æ•°æ®-&gt;å¤„ç†ç»“æœèšåˆã€‚
å›¾å¤§æ¦‚æ˜¯è¿™æ ·çš„,
<img src="https://image.syst.top/image/out.png" alt="image"></p>
<p>ç„¶åå®ƒå¯ä»¥é€šè¿‡ <code>context.context</code> è¾¾åˆ°æ§åˆ¶å·¥ä½œæ± åœæ­¢å·¥ä½œçš„æ•ˆæœã€‚</p>
<p>æœ€åé€šè¿‡ä»£ç ï¼Œä½ ä¼šå‘ç°å®ƒä¸æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„ <code>worker-pool</code>ï¼Œåé¢ä¼šè¯´æ˜ã€‚</p>
<p>ä¸‹å›¾èƒ½æ¸…æ™°è¡¨è¾¾æ•´ä½“æµç¨‹äº†ã€‚
<img src="https://image.syst.top/image/work-pool-2.png" alt="image"></p>
<p>é¡ºä¾¿è¯´ä¸€å¥ï¼Œè¿™ç¯‡æ–‡ç« å®ç°çš„ä»£ç æ¯” <code>Handling 1 Million Requests per Minute with Go</code> çš„ä»£ç ç®€å•å¤šäº†ã€‚</p>
<p>é¦–å…ˆçœ‹ <code>job</code>ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">wpool</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">JobID</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">jobType</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">jobMetadata</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">ExecutionFn</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">args</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">JobDescriptor</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ID</span>       <span class="nx">JobID</span> 
</span></span><span class="line"><span class="cl">	<span class="nx">JType</span>    <span class="nx">jobType</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Metadata</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Result</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Value</span>      <span class="kd">interface</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Err</span>        <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Descriptor</span> <span class="nx">JobDescriptor</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Job</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Descriptor</span> <span class="nx">JobDescriptor</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ExecFn</span>     <span class="nx">ExecutionFn</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Args</span>       <span class="kd">interface</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// å¤„ç† job é€»è¾‘,å¤„ç†ç»“æœåŒ…è£…æˆ Result ç»“æœ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">j</span> <span class="nx">Job</span><span class="p">)</span> <span class="nf">execute</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="nx">Result</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">value</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">j</span><span class="p">.</span><span class="nf">ExecFn</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">j</span><span class="p">.</span><span class="nx">Args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">Result</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Err</span><span class="p">:</span>        <span class="nx">err</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Descriptor</span><span class="p">:</span> <span class="nx">j</span><span class="p">.</span><span class="nx">Descriptor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">Result</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Value</span><span class="p">:</span>      <span class="nx">value</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Descriptor</span><span class="p">:</span> <span class="nx">j</span><span class="p">.</span><span class="nx">Descriptor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¿™ä¸ªå¯ä»¥ç®€å•è¿‡ä¸€ä¸‹ã€‚æœ€ç»ˆæ¯ä¸ª <code>job</code> å¤„ç†å®Œéƒ½ä¼šåŒ…è£…æˆ <code>Result</code> è¿”å›ã€‚</p>
<p>ä¸‹é¢è¿™æ®µå°±æ˜¯æ ¸å¿ƒä»£ç äº†ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">wpool</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;sync&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// è¿è¡Œä¸­çš„æ¯ä¸ªworker
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">worker</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">wg</span> <span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">,</span> <span class="nx">jobs</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="nx">Job</span><span class="p">,</span> <span class="nx">results</span> <span class="kd">chan</span><span class="o">&lt;-</span> <span class="nx">Result</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">job</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">jobs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">results</span> <span class="o">&lt;-</span> <span class="nx">job</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;cancelled worker. Error detail: %v\n&#34;</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">Err</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">			<span class="nx">results</span> <span class="o">&lt;-</span> <span class="nx">Result</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">Err</span><span class="p">:</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">Err</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">WorkerPool</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">workersCount</span> <span class="kt">int</span> <span class="c1">//worker æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">jobs</span>         <span class="kd">chan</span> <span class="nx">Job</span> <span class="c1">// å­˜å‚¨ job çš„ channel 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">results</span>      <span class="kd">chan</span> <span class="nx">Result</span> <span class="c1">// å¤„ç†å®Œæ¯ä¸ª job å¯¹åº”çš„ ç»“æœé›†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Done</span>         <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span> <span class="c1">//æ˜¯å¦ç»“æŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">wcount</span> <span class="kt">int</span><span class="p">)</span> <span class="nx">WorkerPool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">WorkerPool</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">workersCount</span><span class="p">:</span> <span class="nx">wcount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">jobs</span><span class="p">:</span>         <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">Job</span><span class="p">,</span> <span class="nx">wcount</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">results</span><span class="p">:</span>      <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">Result</span><span class="p">,</span> <span class="nx">wcount</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Done</span><span class="p">:</span>         <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}),</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">wp</span> <span class="nx">WorkerPool</span><span class="p">)</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">wp</span><span class="p">.</span><span class="nx">workersCount</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nf">worker</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">wg</span><span class="p">,</span> <span class="nx">wp</span><span class="p">.</span><span class="nx">jobs</span><span class="p">,</span> <span class="nx">wp</span><span class="p">.</span><span class="nx">results</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nb">close</span><span class="p">(</span><span class="nx">wp</span><span class="p">.</span><span class="nx">Done</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nb">close</span><span class="p">(</span><span class="nx">wp</span><span class="p">.</span><span class="nx">results</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">wp</span> <span class="nx">WorkerPool</span><span class="p">)</span> <span class="nf">Results</span><span class="p">()</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="nx">Result</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">wp</span><span class="p">.</span><span class="nx">results</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">wp</span> <span class="nx">WorkerPool</span><span class="p">)</span> <span class="nf">GenerateFrom</span><span class="p">(</span><span class="nx">jobsBulk</span> <span class="p">[]</span><span class="nx">Job</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">jobsBulk</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">wp</span><span class="p">.</span><span class="nx">jobs</span> <span class="o">&lt;-</span> <span class="nx">jobsBulk</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nb">close</span><span class="p">(</span><span class="nx">wp</span><span class="p">.</span><span class="nx">jobs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æ•´ä¸ª <code>WorkerPool</code> ç»“æ„å¾ˆç®€å•ã€‚ <code>jobs</code> æ˜¯ä¸€ä¸ªç¼“å†² <code>channel</code>ã€‚æ¯ä¸€ä¸ªä»»åŠ¡éƒ½ä¼šæ”¾å…¥ <code>jobs</code> ä¸­ç­‰å¾…å¤„ç† <code>woker</code> å¤„ç†ã€‚</p>
<p><code>results</code> ä¹Ÿæ˜¯ä¸€ä¸ªé€šé“ç±»å‹ï¼Œå®ƒçš„ä½œç”¨æ˜¯ä¿å­˜æ¯ä¸ª <code>job</code> å¤„ç†åäº§ç”Ÿçš„ç»“æœ <code>Result</code>ã€‚</p>
<p>é¦–å…ˆé€šè¿‡ <code>New</code> åˆå§‹åŒ–ä¸€ä¸ª <code>worker-pool</code> å·¥ä½œæ± ,ç„¶åæ‰§è¡Œ <code>Run</code> å¼€å§‹è¿è¡Œã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">wcount</span> <span class="kt">int</span><span class="p">)</span> <span class="nx">WorkerPool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">WorkerPool</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">workersCount</span><span class="p">:</span> <span class="nx">wcount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">jobs</span><span class="p">:</span>         <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">Job</span><span class="p">,</span> <span class="nx">wcount</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">results</span><span class="p">:</span>      <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">Result</span><span class="p">,</span> <span class="nx">wcount</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Done</span><span class="p">:</span>         <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}),</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">wp</span> <span class="nx">WorkerPool</span><span class="p">)</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">wp</span><span class="p">.</span><span class="nx">workersCount</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nf">worker</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">wg</span><span class="p">,</span> <span class="nx">wp</span><span class="p">.</span><span class="nx">jobs</span><span class="p">,</span> <span class="nx">wp</span><span class="p">.</span><span class="nx">results</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nb">close</span><span class="p">(</span><span class="nx">wp</span><span class="p">.</span><span class="nx">Done</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nb">close</span><span class="p">(</span><span class="nx">wp</span><span class="p">.</span><span class="nx">results</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>åˆå§‹åŒ–çš„æ—¶å€™ä¼ å…¥ <code>worker</code> æ•°ï¼Œå¯¹åº”æ¯ä¸ª <code>g</code> è¿è¡Œ <code>work(ctx,&amp;wg,wp.jobs,wp.results)</code>,ç»„æˆäº† <code>worker-pool</code>ã€‚
åŒæ—¶é€šè¿‡ <code>sync.WaitGroup</code>,æˆ‘ä»¬å¯ä»¥ç­‰å¾…æ‰€æœ‰ <code>worker</code> å·¥ä½œç»“æŸï¼Œä¹Ÿå°±æ„å‘³ç€ <code>work-pool</code> ç»“æŸå·¥ä½œï¼Œå½“ç„¶å¯èƒ½æ˜¯å› ä¸ºä»»åŠ¡å¤„ç†ç»“æŸï¼Œä¹Ÿå¯èƒ½æ˜¯è¢«åœæ­¢äº†ã€‚</p>
<p>æ¯ä¸ª <code>job</code> æ•°æ®æºæ˜¯å¦‚ä½•æ¥çš„ï¼Ÿ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// jobæ•°æ®æºï¼ŒæŠŠæ¯ä¸ª job æ”¾å…¥åˆ° jobs channel ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">wp</span> <span class="nx">WorkerPool</span><span class="p">)</span> <span class="nf">GenerateFrom</span><span class="p">(</span><span class="nx">jobsBulk</span> <span class="p">[]</span><span class="nx">Job</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">jobsBulk</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">wp</span><span class="p">.</span><span class="nx">jobs</span> <span class="o">&lt;-</span> <span class="nx">jobsBulk</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nb">close</span><span class="p">(</span><span class="nx">wp</span><span class="p">.</span><span class="nx">jobs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å¯¹åº”æ¯ä¸ª <code>worker</code> çš„å·¥ä½œï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">worker</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">wg</span> <span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">,</span> <span class="nx">jobs</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="nx">Job</span><span class="p">,</span> <span class="nx">results</span> <span class="kd">chan</span><span class="o">&lt;-</span> <span class="nx">Result</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">job</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">jobs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">results</span> <span class="o">&lt;-</span> <span class="nx">job</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;cancelled worker. Error detail: %v\n&#34;</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">Err</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">			<span class="nx">results</span> <span class="o">&lt;-</span> <span class="nx">Result</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">Err</span><span class="p">:</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">Err</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æ¯ä¸ª worker éƒ½å°è¯•ä»åŒä¸€ä¸ª <code>jobs</code> è·å–æ•°æ®ï¼Œè¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„ <code>fan-out</code> æ¨¡å¼ã€‚
å½“å¯¹åº”çš„ <code>g</code> è·å–åˆ° <code>job</code> è¿›è¡Œå¤„ç†åï¼Œä¼šæŠŠå¤„ç†ç»“æœå‘é€åˆ°åŒä¸€ä¸ª <code>results channel</code> ä¸­,è¿™åˆæ˜¯ä¸€ä¸ª <code>fan-in</code> æ¨¡å¼ã€‚
å½“ç„¶æˆ‘ä»¬é€šè¿‡ <code>context.Context</code> å¯ä»¥å¯¹æ¯ä¸ª <code>worker</code> åšåœæ­¢è¿è¡Œæ§åˆ¶ã€‚</p>
<p>æœ€åæ˜¯å¤„ç†ç»“æœé›†åˆï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// å¤„ç†ç»“æœé›†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">wp</span> <span class="nx">WorkerPool</span><span class="p">)</span> <span class="nf">Results</span><span class="p">()</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="nx">Result</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">wp</span><span class="p">.</span><span class="nx">results</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>é‚£ä¹ˆæ•´ä½“çš„æµ‹è¯•ä»£ç å°±æ˜¯:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">TestWorkerPool</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">wp</span> <span class="o">:=</span> <span class="nf">New</span><span class="p">(</span><span class="nx">workerCount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithCancel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nf">cancel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="nx">wp</span><span class="p">.</span><span class="nf">GenerateFrom</span><span class="p">(</span><span class="nf">testJobs</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="nx">wp</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">wp</span><span class="p">.</span><span class="nf">Results</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nx">i</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">ParseInt</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Descriptor</span><span class="p">.</span><span class="nx">ID</span><span class="p">),</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">t</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;unexpected error: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nx">val</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Value</span><span class="p">.(</span><span class="kt">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">val</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">t</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;wrong value %v; expected %v&#34;</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">wp</span><span class="p">.</span><span class="nx">Done</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>çœ‹äº†ä»£ç ä¹‹åï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œè¿™å¹¶ä¸æ˜¯ä¸€ä¸ªä¼ ç»Ÿæ„ä¹‰çš„ <code>worker-pool</code>ã€‚å®ƒå¹¶ä¸åƒ <code>Handling 1 Million Requests per Minute with Go</code> è¿™ç¯‡æ–‡ç« ä¸€æ ·ï¼Œ
åˆå§‹åŒ–ä¸€ä¸ªçœŸæ­£çš„ <code>worker-pool</code>ï¼Œä¸€æ—¦æ¥æ”¶åˆ° <code>job</code>,å°±å°è¯•ä»æ± ä¸­è·å–ä¸€ä¸ª <code>worker</code>ï¼Œ
æŠŠå¯¹åº”çš„ <code>job</code> äº¤ç»™è¿™ä¸ª <code>work</code> è¿›è¡Œå¤„ç†ï¼Œç­‰ <code>work</code> å¤„ç†å®Œæ¯•ï¼Œé‡æ–°è¿›è¡Œåˆ°å·¥ä½œæ± ä¸­ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡è¢«åˆ©ç”¨ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>channelåŸç†è§£æ</title>
			<link>https://www.syst.top/posts/go/channel/</link>
			<pubDate>Sun, 25 Apr 2021 22:25:52 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/channel/</guid>
			<description>èººçš„å¤ªä¹…äº†ï¼Œè¯¥èµ·åºŠäº†ã€‚å®å¯æˆ‘å·æ­»åˆ«äººï¼Œä¸èƒ½è®©åˆ«äººå·æˆ‘ã€‚
ä¹‹å‰æ–­æ–­ç»­ç»­çœ‹è¿‡Goå‡ ä¸ªæ¨¡å—çš„æºç ï¼Œå¯ä»æœªä¸‹ç¬”ï¼Œå¯¼è‡´æœ‰äº›ç»†èŠ‚è®°ä¸èµ·æ¥äº†ã€‚æ‰“ç®—å†™ä¸€äº›æ–‡ç« é‡æ–°è®°å½•ã€‚
channelæºç è§£æçš„æ–‡ç« å¤ªå¤šäº†ã€‚åªç”¨ä¸€ç¯‡æ–‡ç« çš„é•¿ç¯‡å¤§è®ºå¤§éƒ¨åˆ†äººæ²¡è€å¿ƒçœ‹å®Œï¼Œæ‰€ä»¥æˆ‘æ‰“ç®—åˆ†å¼€å†™ï¼Œæœ€åé™„ä¸Šå®Œæ•´çš„pptã€‚
å½“ç„¶è¿™å…¶ä¸­ä¸ä¼šæ¶‰åŠè¿‡å¤šç»†èŠ‚æºç ï¼Œå› ä¸ºæœ‰æ—¶å€™ï¼Œç»†èŠ‚æ˜¯é­”é¬¼ã€‚
ä»‹ç» channelä¸€äº›åŸºç¡€ä»‹ç»è¿™é‡Œå°±ä¸è¿‡å¤šæ¶‰åŠäº†ï¼Œéƒ½1202å¹´äº†ï¼Œæˆ‘ä¸ç›¸ä¿¡ç”¨è¿‡Goçš„äººæ²¡ç”¨è¿‡channelã€‚
å½“ç„¶ä¸‹å›¾ä¹Ÿæ¶µç›–äº†å¤§éƒ¨åˆ†ä½¿ç”¨æ–¹æ³•ã€‚æ³¨æ„æ˜¯ä½¿ç”¨å§¿åŠ¿ï¼Œè€Œä¸æ˜¯æ¨¡å¼ã€‚
é¡ºä¾¿å†æä¸€å¥ï¼Œæœ‰ä¸€é“ä½¿ç”¨channelè¿›è¡Œä»»åŠ¡ç¼–æ’çš„ç»å…¸çš„é¢˜ã€‚é¢˜ç›®å¦‚ä¸‹ï¼Œ
æœ‰å››ä¸ªgoroutineï¼Œç¼–å·ä¸º 1ã€2ã€3ã€4ã€‚æ¯ç§’é’Ÿä¼šæœ‰ä¸€ä¸ª goroutineæ‰“å°è‡ªå·±çš„ç¼–å·ã€‚è¯·ä½ å®ç°è¿™ä¸ªç¨‹åºï¼Œè®©è¾“å‡ºçš„ç¼–å·æ€»æ˜¯æŒ‰ç…§ 1ã€2ã€3ã€4ã€1ã€2ã€3ã€4ã€â€¦â€¦çš„é¡ºåºæ‰“å°å‡ºæ¥ã€‚å°±åƒè¿™æ ·ï¼Œ
å¯ä»¥è‡ªå·±å…ˆæ€è€ƒä¸‹ï¼Œä»£ç ä¹Ÿå¯ä»¥é€šè¿‡åå°å›å¤å‡»é¼“ä¼ èŠ±è·å–ã€‚
åŸç†è§£æ ä»ä¸€ä¸ªç®€å•çš„ä¾‹å­è¯´èµ·ã€‚
åˆ›å»ºä¸€ä¸ªmain.goæ–‡ä»¶ï¼Œä»£ç å¦‚ä¸‹ï¼Œ
æˆ‘ä»¬æ¥çœ‹çœ‹è¿™æ®µä»£ç ç¼–è¯‘ä»¥åé•¿å•¥æ ·ã€‚
æƒ³å¾—åˆ°goç¨‹åºçš„æ±‡ç¼–ä»£ç å¹¶ä¸éš¾ã€‚
å¯ä»¥ä½¿ç”¨go tool compile -N -l -S main.goç”Ÿæˆæ±‡ç¼–ä»£ç ï¼š
æˆ–è€…ä½¿ç”¨go tool compile -N -l main.go å…ˆç¼–è¯‘å‡ºä»£ç ï¼Œç„¶åå†ä½¿ç”¨go tool objdump main.oåæ±‡ç¼–å‡ºä»£ç ã€‚
å½“ç„¶ï¼Œé€šè¿‡go build -gcflags -S main.goåŒæ ·å¯ä»¥å¾—åˆ°æ±‡ç¼–çš„ä»£ç ã€‚
ä¸Šé¢ä¸¤ç§æˆ‘å°±ä¸æ¼”ç¤ºäº†ï¼Œå¯ä»¥è‡ªè¡Œå®éªŒã€‚ä»–ä»¬ä¹‹ä¸­flagçš„å…·ä½“å«ä¹‰ä¹Ÿå¯ä»¥è‡ªè¡Œäº†è§£ã€‚
å¦‚æœä½ è§‰å¾—ä¸Šé¢è¦è‡ªå·±æ•²ä»£ç æ¯”è¾ƒéº»çƒ¦ï¼Œæˆ‘æ¨èä¸€ä¸ªæ›´åŠ ç›´æ¥å¯è§†åŒ–çš„å·¥å…·ã€‚
ç»¼ä¸Šï¼Œä»ç¼–è¯‘çš„ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œä¸Šè¿°åˆå§‹åŒ–ä¸€ä¸ªchannel,
ch := make(chan struct{}) å®é™…ä¸Šè°ƒç”¨çš„æ˜¯runtime.makechanã€‚æˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹runtime.makechanã€‚
ä»å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬èƒ½çŸ¥é“æœ€ç»ˆè¿”å›ä¸€ä¸ªruntime.hchançš„æŒ‡é’ˆã€‚
runtime.hchanç»“æ„ã€‚
æˆ‘ä»¬å…ˆæ¥è§£é‡Šhchanç»“æ„ä½“å„ä¸ªå­—æ®µçš„å«ä¹‰ï¼Œä¹‹ååœ¨æ¡ˆä¾‹ä»‹ç»ä¸­ä¼šæ›´åŠ è¯¦ç»†çš„è¯´æ˜ä»–ä»¬çš„ä½œç”¨ã€‚
æˆ‘ä»¬å…ˆæ¥çœ‹qcountå’Œdataqsizæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
ä½ å»é“¶è¡ŒåŠäº‹ï¼Œé“¶è¡Œæœ‰5ä¸ªåŠäº‹çª—å£ï¼Œé‚£ä¹ˆdataqsizå°±ç­‰äº5ã€‚åœ¨è¿™é‡Œä½“ç°çš„æ˜¯channelçš„å®¹é‡ä¸º5ã€‚å»é“¶è¡Œçš„æ—¶å€™ï¼Œå½“å‰æœ‰3ä¸ªçª—å£æœ‰äººæ­£åœ¨åŠäº‹ï¼Œé‚£ä¹ˆqcountå°±ç­‰äº3ï¼Œä½“ç°channelå½“å‰æœ‰3ä¸ªæ•°æ®å…ƒç´ ã€‚é‚£ä¹ˆæ­¤æ—¶é“¶è¡Œè¿˜å¯ä»¥å†æ¥å¾…2ä¸ªå®¢æˆ·ï¼Œå¯¹åº”è¿˜å¯ä»¥å¾€channelå‘é€2ä¸ªæ•°æ®å…ƒç´ ã€‚
å…¶ä»–å­—æ®µç°åœ¨çœ‹çœ‹è¯´æ˜å°±è¡Œäº†ï¼Œåé¢ä¼šç»†è®²ã€‚
åˆ°è¿™é‡Œæˆ‘ä»¬å°±çŸ¥é“åˆ›å»ºä¸€ä¸ªchannelæœ¬è´¨ä¸Šå°±æ˜¯å¾—åˆ°ä¸€ä¸ªruntime.hchançš„æŒ‡é’ˆï¼Œåç»­å¯¹æ­¤chançš„æ“ä½œï¼Œæ— éå°±æ˜¯å¯¹ç»“æ„ä½“å­—æ®µè¿›è¡Œç›¸å¯¹åº”çš„æ“ä½œã€‚
åŒæ—¶æˆ‘ä»¬ä¹Ÿèƒ½çŒœå‡ºï¼Œä¸ºå•¥channelèƒ½åœ¨ä¸åŒçš„gä¸­ä¼ é€’æ¶ˆæ¯ï¼Œè€Œå¯¹äºä½¿ç”¨è€…æ¥è¯´ä¸ç”¨æ‹…å¿ƒå¹¶å‘çš„é—®é¢˜ï¼Œå…¶å®å°±æ˜¯hchanå†…éƒ¨ä½¿ç”¨äº’æ–¥é”æ¥ä¿è¯äº†å¹¶å‘å®‰å…¨ã€‚
æœ€åæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹runtime.makechanå‡½æ•°æ ¸å¿ƒå®ç°ï¼Œå½“ç„¶æ³¨é‡Šå·²ç»å¾ˆæ˜ç™½äº†ã€‚
å¯ä»¥çœ‹åˆ°åˆ›å»ºçš„æ—¶å€™æœ‰ä¸€æ®µswitchåˆ†æ”¯ä»£ç ï¼Œé‚£ä¹ˆä»€ä¹ˆæƒ…å†µä¸‹ä¼šèµ°å¯¹åº”çš„caseå‘¢?
æ ¹æ®ä¸Šé¢çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºï¼Œ
 å¦‚æœåˆ›å»ºä¸€ä¸ªæ— ç¼“å†²channel ï¼Œé‚£ä¹ˆåªéœ€è¦ä¸ºruntime.hchanæœ¬èº«åˆ†é…ä¸€æ®µå†…å­˜ç©ºé—´å³å¯ã€‚ å¦‚æœåˆ›å»ºçš„ç¼“å†²channel å­˜å‚¨çš„ç±»å‹ä¸æ˜¯æŒ‡é’ˆç±»å‹ï¼Œä¼šä¸ºå½“å‰ channel å’Œå­˜å‚¨ç±»å‹å…ƒç´ çš„ç¼“å†²åŒºï¼Œåˆ†é…ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´ã€‚ åœ¨é»˜è®¤æƒ…å†µä¸‹(ç¼“å†²channelå­˜å‚¨ç±»å‹åŒ…å«æŒ‡é’ˆ)ï¼Œä¼šå•ç‹¬ä¸ºruntime.hchanå’Œç¼“å†²åŒºåˆ†é…å†…å­˜ã€‚  æ€»ç»“ è¿™ç¯‡æˆ‘ä»¬ä¸»è¦ä»‹ç»äº†å¦‚ä½•è·å–goç¨‹åºçš„æ±‡ç¼–ä»£ç ï¼Œé€šè¿‡æ±‡ç¼–ä»£ç çŸ¥é“åˆ›å»ºchannelçš„å…·ä½“å‡½æ•°runtime.makechanï¼ŒåŒæ—¶æˆ‘ä»¬è¿˜çŸ¥é“ä¸åŒçš„åˆ›å»ºå§¿åŠ¿ä¼šå¯¼è‡´èµ°å‘ä¸åŒçš„å†…å­˜ç©ºé—´åˆ†é…ã€‚æœ€åé€šè¿‡åˆ›å»ºå‡½æ•°æˆ‘ä»¬çŸ¥é“channelåœ¨ç¨‹åºè¿è¡Œæ—¶ä½¿ç”¨runtime.hchanæ¥è¡¨ç¤ºã€‚</description>
			<content type="html"><![CDATA[<p>èººçš„å¤ªä¹…äº†ï¼Œè¯¥èµ·åºŠäº†ã€‚å®å¯æˆ‘å·æ­»åˆ«äººï¼Œä¸èƒ½è®©åˆ«äººå·æˆ‘ã€‚</p>
<p>ä¹‹å‰æ–­æ–­ç»­ç»­çœ‹è¿‡<code>Go</code>å‡ ä¸ªæ¨¡å—çš„æºç ï¼Œå¯ä»æœªä¸‹ç¬”ï¼Œå¯¼è‡´æœ‰äº›ç»†èŠ‚è®°ä¸èµ·æ¥äº†ã€‚æ‰“ç®—å†™ä¸€äº›æ–‡ç« é‡æ–°è®°å½•ã€‚</p>
<p><code>channel</code>æºç è§£æçš„æ–‡ç« å¤ªå¤šäº†ã€‚åªç”¨ä¸€ç¯‡æ–‡ç« çš„é•¿ç¯‡å¤§è®ºå¤§éƒ¨åˆ†äººæ²¡è€å¿ƒçœ‹å®Œï¼Œæ‰€ä»¥æˆ‘æ‰“ç®—åˆ†å¼€å†™ï¼Œæœ€åé™„ä¸Šå®Œæ•´çš„<code>ppt</code>ã€‚</p>
<p>å½“ç„¶è¿™å…¶ä¸­ä¸ä¼šæ¶‰åŠè¿‡å¤šç»†èŠ‚æºç ï¼Œå› ä¸ºæœ‰æ—¶å€™ï¼Œç»†èŠ‚æ˜¯é­”é¬¼ã€‚</p>
<h3 id="ä»‹ç»">ä»‹ç»</h3>
<p><code>channel</code>ä¸€äº›åŸºç¡€ä»‹ç»è¿™é‡Œå°±ä¸è¿‡å¤šæ¶‰åŠäº†ï¼Œéƒ½1202å¹´äº†ï¼Œæˆ‘ä¸ç›¸ä¿¡ç”¨è¿‡<code>Go</code>çš„äººæ²¡ç”¨è¿‡<code>channel</code>ã€‚</p>
<p>å½“ç„¶ä¸‹å›¾ä¹Ÿæ¶µç›–äº†å¤§éƒ¨åˆ†ä½¿ç”¨æ–¹æ³•ã€‚æ³¨æ„æ˜¯ä½¿ç”¨å§¿åŠ¿ï¼Œè€Œä¸æ˜¯æ¨¡å¼ã€‚</p>
<p><img src="https://cdn.syst.top/use-channel.png" alt="image"></p>
<p>é¡ºä¾¿å†æä¸€å¥ï¼Œæœ‰ä¸€é“ä½¿ç”¨<code>channel</code>è¿›è¡Œä»»åŠ¡ç¼–æ’çš„ç»å…¸çš„é¢˜ã€‚é¢˜ç›®å¦‚ä¸‹ï¼Œ</p>
<p>æœ‰å››ä¸ª<code>goroutine</code>ï¼Œç¼–å·ä¸º 1ã€2ã€3ã€4ã€‚æ¯ç§’é’Ÿä¼šæœ‰ä¸€ä¸ª <code>goroutine</code>æ‰“å°è‡ªå·±çš„ç¼–å·ã€‚è¯·ä½ å®ç°è¿™ä¸ªç¨‹åºï¼Œè®©è¾“å‡ºçš„ç¼–å·æ€»æ˜¯æŒ‰ç…§ 1ã€2ã€3ã€4ã€1ã€2ã€3ã€4ã€â€¦â€¦çš„é¡ºåºæ‰“å°å‡ºæ¥ã€‚å°±åƒè¿™æ ·ï¼Œ</p>
<p><img src="https://cdn.syst.top/channel-gif.gif" alt="image"></p>
<p>å¯ä»¥è‡ªå·±å…ˆæ€è€ƒä¸‹ï¼Œä»£ç ä¹Ÿå¯ä»¥é€šè¿‡åå°å›å¤<code>å‡»é¼“ä¼ èŠ±</code>è·å–ã€‚</p>
<h3 id="åŸç†è§£æ">åŸç†è§£æ</h3>
<p>ä»ä¸€ä¸ªç®€å•çš„ä¾‹å­è¯´èµ·ã€‚</p>
<p>åˆ›å»ºä¸€ä¸ª<code>main.go</code>æ–‡ä»¶ï¼Œä»£ç å¦‚ä¸‹ï¼Œ</p>
<p><img src="https://cdn.syst.top/ch-send.png" alt="image"></p>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹è¿™æ®µä»£ç ç¼–è¯‘ä»¥åé•¿å•¥æ ·ã€‚</p>
<p>æƒ³å¾—åˆ°<code>go</code>ç¨‹åºçš„æ±‡ç¼–ä»£ç å¹¶ä¸éš¾ã€‚</p>
<p>å¯ä»¥ä½¿ç”¨<code>go tool compile -N -l -S main.go</code>ç”Ÿæˆæ±‡ç¼–ä»£ç ï¼š</p>
<p><img src="https://cdn.syst.top/compile-channel.png" alt="image"></p>
<p>æˆ–è€…ä½¿ç”¨<code>go tool compile -N -l main.go</code> å…ˆç¼–è¯‘å‡ºä»£ç ï¼Œç„¶åå†ä½¿ç”¨<code>go tool objdump main.o</code>åæ±‡ç¼–å‡ºä»£ç ã€‚</p>
<p>å½“ç„¶ï¼Œé€šè¿‡<code>go build -gcflags -S main.go</code>åŒæ ·å¯ä»¥å¾—åˆ°æ±‡ç¼–çš„ä»£ç ã€‚</p>
<p>ä¸Šé¢ä¸¤ç§æˆ‘å°±ä¸æ¼”ç¤ºäº†ï¼Œå¯ä»¥è‡ªè¡Œå®éªŒã€‚ä»–ä»¬ä¹‹ä¸­<code>flag</code>çš„å…·ä½“å«ä¹‰ä¹Ÿå¯ä»¥è‡ªè¡Œäº†è§£ã€‚</p>
<p>å¦‚æœä½ è§‰å¾—ä¸Šé¢è¦è‡ªå·±æ•²ä»£ç æ¯”è¾ƒéº»çƒ¦ï¼Œæˆ‘æ¨èä¸€ä¸ªæ›´åŠ ç›´æ¥å¯è§†åŒ–çš„å·¥å…·ã€‚</p>
<p><img src="https://cdn.syst.top/compile-show.png" alt="image"></p>
<p>ç»¼ä¸Šï¼Œä»ç¼–è¯‘çš„ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œä¸Šè¿°åˆå§‹åŒ–ä¸€ä¸ª<code>channel</code>,</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">	<span class="nx">ch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
</span></span></code></pre></div><p>å®é™…ä¸Šè°ƒç”¨çš„æ˜¯<code>runtime.makechan</code>ã€‚æˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹<code>runtime.makechan</code>ã€‚</p>
<p><img src="https://cdn.syst.top/makechannel.png" alt="image"></p>
<p>ä»å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬èƒ½çŸ¥é“æœ€ç»ˆè¿”å›ä¸€ä¸ª<code>runtime.hchan</code>çš„æŒ‡é’ˆã€‚</p>
<p><code>runtime.hchan</code>ç»“æ„ã€‚</p>
<p><img src="https://cdn.syst.top/hchan.png" alt="image"></p>
<p>æˆ‘ä»¬å…ˆæ¥è§£é‡Š<code>hchan</code>ç»“æ„ä½“å„ä¸ªå­—æ®µçš„å«ä¹‰ï¼Œä¹‹ååœ¨æ¡ˆä¾‹ä»‹ç»ä¸­ä¼šæ›´åŠ è¯¦ç»†çš„è¯´æ˜ä»–ä»¬çš„ä½œç”¨ã€‚</p>
<p><img src="https://cdn.syst.top/hchan-detail2.png" alt="image"></p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹<code>qcount</code>å’Œ<code>dataqsiz</code>æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p>
<p>ä½ å»é“¶è¡ŒåŠäº‹ï¼Œé“¶è¡Œæœ‰5ä¸ªåŠäº‹çª—å£ï¼Œé‚£ä¹ˆ<code>dataqsiz</code>å°±ç­‰äº5ã€‚åœ¨è¿™é‡Œä½“ç°çš„æ˜¯<code>channel</code>çš„å®¹é‡ä¸º5ã€‚å»é“¶è¡Œçš„æ—¶å€™ï¼Œå½“å‰æœ‰3ä¸ªçª—å£æœ‰äººæ­£åœ¨åŠäº‹ï¼Œé‚£ä¹ˆ<code>qcount</code>å°±ç­‰äº3ï¼Œä½“ç°<code>channel</code>å½“å‰æœ‰3ä¸ªæ•°æ®å…ƒç´ ã€‚é‚£ä¹ˆæ­¤æ—¶é“¶è¡Œè¿˜å¯ä»¥å†æ¥å¾…2ä¸ªå®¢æˆ·ï¼Œå¯¹åº”è¿˜å¯ä»¥å¾€<code>channel</code>å‘é€2ä¸ªæ•°æ®å…ƒç´ ã€‚</p>
<p>å…¶ä»–å­—æ®µç°åœ¨çœ‹çœ‹è¯´æ˜å°±è¡Œäº†ï¼Œåé¢ä¼šç»†è®²ã€‚</p>
<p>åˆ°è¿™é‡Œæˆ‘ä»¬å°±çŸ¥é“åˆ›å»ºä¸€ä¸ª<code>channel</code>æœ¬è´¨ä¸Šå°±æ˜¯å¾—åˆ°ä¸€ä¸ª<code>runtime.hchan</code>çš„æŒ‡é’ˆï¼Œåç»­å¯¹æ­¤<code>chan</code>çš„æ“ä½œï¼Œæ— éå°±æ˜¯å¯¹ç»“æ„ä½“å­—æ®µè¿›è¡Œç›¸å¯¹åº”çš„æ“ä½œã€‚</p>
<p>åŒæ—¶æˆ‘ä»¬ä¹Ÿèƒ½çŒœå‡ºï¼Œä¸ºå•¥<code>channel</code>èƒ½åœ¨ä¸åŒçš„<code>g</code>ä¸­ä¼ é€’æ¶ˆæ¯ï¼Œè€Œå¯¹äºä½¿ç”¨è€…æ¥è¯´ä¸ç”¨æ‹…å¿ƒå¹¶å‘çš„é—®é¢˜ï¼Œå…¶å®å°±æ˜¯<code>hchan</code>å†…éƒ¨ä½¿ç”¨äº’æ–¥é”æ¥ä¿è¯äº†å¹¶å‘å®‰å…¨ã€‚</p>
<p>æœ€åæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<code>runtime.makechan</code>å‡½æ•°æ ¸å¿ƒå®ç°ï¼Œå½“ç„¶æ³¨é‡Šå·²ç»å¾ˆæ˜ç™½äº†ã€‚</p>
<p><img src="https://cdn.syst.top/makechan2.png" alt="image-20211009084700993"></p>
<p>å¯ä»¥çœ‹åˆ°åˆ›å»ºçš„æ—¶å€™æœ‰ä¸€æ®µ<code>switch</code>åˆ†æ”¯ä»£ç ï¼Œé‚£ä¹ˆä»€ä¹ˆæƒ…å†µä¸‹ä¼šèµ°å¯¹åº”çš„<code>case</code>å‘¢?</p>
<p><img src="https://cdn.syst.top/make-zi.png" alt="image-20211009084700993"></p>
<p>æ ¹æ®ä¸Šé¢çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºï¼Œ</p>
<ul>
<li>å¦‚æœåˆ›å»ºä¸€ä¸ªæ— ç¼“å†²<code>channel</code> ï¼Œé‚£ä¹ˆåªéœ€è¦ä¸º<code>runtime.hchan</code>æœ¬èº«åˆ†é…ä¸€æ®µå†…å­˜ç©ºé—´å³å¯ã€‚</li>
<li>å¦‚æœåˆ›å»ºçš„ç¼“å†²<code>channel</code> å­˜å‚¨çš„ç±»å‹ä¸æ˜¯æŒ‡é’ˆç±»å‹ï¼Œä¼šä¸ºå½“å‰ <code>channel</code> å’Œå­˜å‚¨ç±»å‹å…ƒç´ çš„ç¼“å†²åŒºï¼Œåˆ†é…ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´ã€‚</li>
<li>åœ¨é»˜è®¤æƒ…å†µä¸‹(ç¼“å†²<code>channel</code>å­˜å‚¨ç±»å‹åŒ…å«æŒ‡é’ˆ)ï¼Œä¼šå•ç‹¬ä¸º<code>runtime.hchan</code>å’Œç¼“å†²åŒºåˆ†é…å†…å­˜ã€‚</li>
</ul>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>è¿™ç¯‡æˆ‘ä»¬ä¸»è¦ä»‹ç»äº†å¦‚ä½•è·å–<code>go</code>ç¨‹åºçš„æ±‡ç¼–ä»£ç ï¼Œé€šè¿‡æ±‡ç¼–ä»£ç çŸ¥é“åˆ›å»º<code>channel</code>çš„å…·ä½“å‡½æ•°<code>runtime.makechan</code>ï¼ŒåŒæ—¶æˆ‘ä»¬è¿˜çŸ¥é“ä¸åŒçš„åˆ›å»ºå§¿åŠ¿ä¼šå¯¼è‡´èµ°å‘ä¸åŒçš„å†…å­˜ç©ºé—´åˆ†é…ã€‚æœ€åé€šè¿‡åˆ›å»ºå‡½æ•°æˆ‘ä»¬çŸ¥é“<code>channel</code>åœ¨ç¨‹åºè¿è¡Œæ—¶ä½¿ç”¨<code>runtime.hchan</code>æ¥è¡¨ç¤ºã€‚</p>
<p>ä¸‹ä¸€ç¯‡æˆ‘ä»¬ç»§ç»­ã€‚</p>
<p><img src="/Users/wuqinqiang/Desktop/image-20211009180357516.png" alt="image-20211009180357516"></p>
]]></content>
		</item>
		
		<item>
			<title>iota åœ¨ Go ä¸­çš„ä½¿ç”¨ </title>
			<link>https://www.syst.top/posts/go/enum/</link>
			<pubDate>Sun, 25 Apr 2021 22:25:52 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/enum/</guid>
			<description>ä»‹ç» Go è¯­è¨€å®é™…ä¸Šæ²¡æœ‰ç›´æ¥æ”¯æŒæšä¸¾çš„å…³é”®å­—ã€‚ä¸€èˆ¬æˆ‘ä»¬éƒ½æ˜¯é€šè¿‡ const + iota å®ç°æšä¸¾çš„èƒ½åŠ›ã€‚
æœ‰äººè¦é—®äº†ï¼Œä¸ºä»€ä¹ˆä¸€å®šè¦ä½¿ç”¨æšä¸¾å‘¢ï¼Ÿstackoverflow ä¸Šæœ‰ä¸€ä¸ªé«˜èµçš„å›ç­”ï¼Œå¦‚ä¸‹:
You should always use enums when a variable (especially a method parameter) can only take one out of a small set of possible values. Examples would be things like type constants (contract status: &amp;#34;permanent&amp;#34;, &amp;#34;temp&amp;#34;, &amp;#34;apprentice&amp;#34;), or flags (&amp;#34;execute now&amp;#34;, &amp;#34;defer execution&amp;#34;). If you use enums instead of integers (or String codes), you increase compile-time checking and avoid errors from passing in invalid constants, and you document which values are legal to use.</description>
			<content type="html"><![CDATA[<h3 id="ä»‹ç»">ä»‹ç»</h3>
<p>Go è¯­è¨€å®é™…ä¸Šæ²¡æœ‰ç›´æ¥æ”¯æŒæšä¸¾çš„å…³é”®å­—ã€‚ä¸€èˆ¬æˆ‘ä»¬éƒ½æ˜¯é€šè¿‡ <code>const</code> + <code>iota</code> å®ç°æšä¸¾çš„èƒ½åŠ›ã€‚</p>
<p>æœ‰äººè¦é—®äº†ï¼Œä¸ºä»€ä¹ˆä¸€å®šè¦ä½¿ç”¨æšä¸¾å‘¢ï¼Ÿ<code>stackoverflow</code> ä¸Šæœ‰ä¸€ä¸ªé«˜èµçš„å›ç­”ï¼Œå¦‚ä¸‹:</p>
<pre tabindex="0"><code>You should always use enums when a variable (especially a method parameter) can only take one out of a small set of possible values. Examples would be things like type constants (contract status: &#34;permanent&#34;, &#34;temp&#34;, &#34;apprentice&#34;), or flags (&#34;execute now&#34;, &#34;defer execution&#34;).

If you use enums instead of integers (or String codes), you increase compile-time checking and avoid errors from passing in invalid constants, and you document which values are legal to use.

BTW, overuse of enums might mean that your methods do too much (it&#39;s often better to have several separate methods, rather than one method that takes several flags which modify what it does), but if you have to use flags or type codes, enums are the way to go.
</code></pre><p>ç®€å•ç¿»è¯‘ä¸€ä¸‹ï¼Œ ä¸¤ç‚¹å¾ˆé‡è¦ã€‚</p>
<ul>
<li>å½“ä¸€ä¸ªå˜é‡(å°¤å…¶æ˜¯æ–¹æ³•å‚æ•°) åªèƒ½ä»ä¸€å°éƒ¨åˆ†å¯èƒ½çš„å€¼ä¸­å–å‡ºä¸€ä¸ªæ—¶ï¼Œç†åº”ä½¿ç”¨æšä¸¾ã€‚
ä¾‹å¦‚ç±»å‹å¸¸é‡(åˆåŒçŠ¶æ€ï¼šæ°¸ä¹…ã€ä¸´æ—¶å·¥ã€å­¦å¾’)ï¼Œ æˆ–è€…åœ¨åšä»»åŠ¡ç¨‹åºæ—¶ï¼Œæ˜¯ç«‹å³æ‰§è¡Œè¿˜æ˜¯å»¶è¿Ÿæ‰§è¡Œçš„æ ‡è®°ã€‚</li>
<li>å¦‚æœä½¿ç”¨æšä¸¾è€Œä¸æ˜¯æ•´å½¢ï¼Œåˆ™ä¼šå¢åŠ ç¼–è¯‘æ—¶çš„æ£€æŸ¥ï¼Œé¿å…é”™è¯¯æ— æ•ˆå€¼çš„ä¼ å…¥ï¼Œè®°å½•å“ªäº›å€¼æ˜¯åˆæ³•ä½¿ç”¨çš„ã€‚</li>
</ul>
<h3 id="å¦‚ä½•å®ç°æšä¸¾">å¦‚ä½•å®ç°æšä¸¾</h3>
<p><code>iota</code> æ˜¯ Go ä¸­é¢„å£°æ˜çš„ä¸€ä¸ªç‰¹æ®Šå¸¸é‡ã€‚å®ƒä¼šè¢«é¢„å£°æ˜ä¸º0ï¼Œä½†æ˜¯å®ƒçš„å€¼åœ¨ç¼–è¯‘é˜¶æ®µå¹¶éæ˜¯å›ºå®šçš„ï¼Œå½“é¢„å£°æ˜çš„ <code>iota</code> å‡ºç°åœ¨ä¸€ä¸ªå¸¸é‡å£°æ˜ä¸­çš„æ—¶å€™ï¼Œå®ƒçš„å€¼åœ¨ç¬¬nä¸ªå¸¸é‡æè¿°ä¸­çš„å€¼ä¸ºn(ä»0å¼€å§‹)ã€‚æ‰€ä»¥å®ƒåªåœ¨åŒç±»å‹å¤šä¸ªå¸¸é‡å£°æ˜çš„æƒ…å†µä¸‹æ‰æ˜¾å¾—æœ‰æ„ä¹‰ã€‚</p>
<p>æ¯”å¦‚ï¼Œå¤§å®¶éƒ½äº†è§£çš„ç”µå•†ï¼Œè®¢å•ç³»ç»Ÿä¸€å®šä¼šæ¶‰åŠåˆ°è®¢å•çŠ¶æ€çš„æµè½¬ã€‚é‚£ä¹ˆè¿™æ—¶å€™ï¼Œæˆ‘ä»¬ä¸€èˆ¬å¯ä»¥è¿™æ ·åš:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">OrderStatus</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Cancelled</span> <span class="nx">OrderStatus</span> <span class="p">=</span> <span class="kc">iota</span> <span class="c1">//è®¢å•å·²å–æ¶ˆ 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">NoPay</span>     <span class="nx">OrderStatus</span> <span class="p">=</span> <span class="kc">iota</span> <span class="c1">//æœªæ”¯ä»˜  1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">PendIng</span>   <span class="nx">OrderStatus</span> <span class="p">=</span> <span class="kc">iota</span> <span class="c1">// æœªå‘è´§ 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Delivered</span> <span class="nx">OrderStatus</span> <span class="p">=</span> <span class="kc">iota</span> <span class="c1">// å·²å‘è´§ 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Received</span>  <span class="nx">OrderStatus</span> <span class="p">=</span> <span class="kc">iota</span> <span class="c1">// å·²æ”¶è´§ 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">Cancelled</span><span class="p">,</span> <span class="nx">NoPay</span><span class="p">)</span> <span class="c1">// æ‰“å°:0,1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>å½“ç„¶ï¼Œè¿™æ ·çœ‹ç€å¥½éº»çƒ¦ã€‚å…¶å®ï¼Œå…¶ä»–å¸¸é‡å¯ä»¥é‡å¤ä¸Šä¸€è¡Œ <code>iota</code> è¡¨è¾¾å¼ï¼Œæˆ‘ä»¬å¯ä»¥æ”¹æˆè¿™æ ·ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">OrderStatus</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Cancelled</span> <span class="nx">OrderStatus</span> <span class="p">=</span> <span class="kc">iota</span> <span class="c1">//è®¢å•å·²å–æ¶ˆ 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">NoPay</span>                        <span class="c1">//æœªæ”¯ä»˜ 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">PendIng</span>                      <span class="c1">// æœªå‘è´§ 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Delivered</span>                    <span class="c1">// å·²å‘è´§ 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Received</span>                     <span class="c1">// å·²æ”¶è´§ 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">Cancelled</span><span class="p">,</span> <span class="nx">NoPay</span><span class="p">)</span> <span class="c1">// æ‰“å°:0,1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>æœ‰äººä¼šç”¨ 0 çš„å€¼æ¥è¡¨ç¤ºçŠ¶æ€å—ï¼Ÿä¸€èˆ¬éƒ½ä¸ä¼šï¼Œæˆ‘ä»¬æƒ³ä»¥1å¼€å¤´ï¼Œé‚£ä¹ˆå¯ä»¥è¿™æ ·ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">OrderStatus</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Cancelled</span> <span class="nx">OrderStatus</span> <span class="p">=</span> <span class="kc">iota</span><span class="o">+</span><span class="mi">1</span> <span class="c1">//è®¢å•å·²å–æ¶ˆ 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">NoPay</span>                        <span class="c1">//æœªæ”¯ä»˜ 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">PendIng</span>                      <span class="c1">// æœªå‘è´§ 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Delivered</span>                    <span class="c1">// å·²å‘è´§ 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Received</span>                     <span class="c1">// å·²æ”¶è´§ 5
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">Cancelled</span><span class="p">,</span> <span class="nx">NoPay</span><span class="p">)</span> <span class="c1">// æ‰“å°:1,2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬è¿˜æƒ³åœ¨ <code>Delivered</code> åè·³è¿‡ä¸€ä¸ªæ•°å­—ï¼Œæ‰æ˜¯ <code>Received</code> çš„å€¼,ä¹Ÿå°±æ˜¯ <code>Received=6</code>ï¼Œé‚£ä¹ˆå¯ä»¥å€ŸåŠ© <code>_</code> ç¬¦å·ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">OrderStatus</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Cancelled</span> <span class="nx">OrderStatus</span> <span class="p">=</span> <span class="kc">iota</span><span class="o">+</span><span class="mi">1</span> <span class="c1">//è®¢å•å·²å–æ¶ˆ 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">NoPay</span>                        <span class="c1">//æœªæ”¯ä»˜ 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">PendIng</span>                      <span class="c1">// æœªå‘è´§ 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Delivered</span>                    <span class="c1">// å·²å‘è´§ 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">_</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Received</span>                     <span class="c1">// å·²æ”¶è´§ 6
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">Received</span><span class="p">)</span> <span class="c1">// æ‰“å°:6
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>é¡ºç€æ¥å¯ä»¥ï¼Œå€’ç€å½“ç„¶ä¹Ÿè¡Œã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">OrderStatus</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Max</span> <span class="p">=</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Received</span>  <span class="nx">OrderStatus</span> <span class="p">=</span> <span class="nx">Max</span> <span class="o">-</span> <span class="kc">iota</span> <span class="c1">// å·²æ”¶è´§  5
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Delivered</span>                          <span class="c1">// å·²å‘è´§ 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">PendIng</span>                            <span class="c1">// æœªå‘è´§ 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">NoPay</span>                              <span class="c1">//æœªæ”¯ä»˜ 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Cancelled</span>                          <span class="c1">//è®¢å•å·²å–æ¶ˆ 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">Received</span><span class="p">,</span><span class="nx">Delivered</span><span class="p">)</span> <span class="c1">// æ‰“å°:5,4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>ä½ è¿˜å¯ä»¥ä½¿ç”¨ä½è¿ç®—ï¼Œæ¯”å¦‚åœ¨ go æºç ä¸­çš„åŒ… <code>sync</code> ä¸­çš„é”ä¸Šé¢æœ‰è¿™ä¹ˆä¸€æ®µä»£ç ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mutexLocked</span> <span class="p">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="kc">iota</span>  <span class="c1">//1&lt;&lt;0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mutexWoken</span>               <span class="c1">//1&lt;&lt;1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mutexStarving</span>            <span class="c1">//1&lt;&lt;2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mutexWaiterShift</span> <span class="p">=</span> <span class="kc">iota</span>  <span class="c1">//3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;mutexLockedçš„å€¼&#34;</span><span class="p">,</span><span class="nx">mutexLocked</span><span class="p">)</span> <span class="c1">//æ‰“å°ï¼š1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;mutexWokençš„å€¼&#34;</span><span class="p">,</span><span class="nx">mutexWoken</span><span class="p">)</span> <span class="c1">//æ‰“å°ï¼š2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;mutexStarvingçš„å€¼&#34;</span><span class="p">,</span><span class="nx">mutexStarving</span><span class="p">)</span> <span class="c1">//æ‰“å°ï¼š4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;mutexWaiterShiftçš„å€¼&#34;</span><span class="p">,</span><span class="nx">mutexWaiterShift</span><span class="p">)</span> <span class="c1">// æ‰“å°ï¼š3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>å¯èƒ½æœ‰äººå¹³å¸¸æ˜¯ç›´æ¥å®šä¹‰å¸¸é‡å€¼æˆ–è€…ç”¨å­—ç¬¦ä¸²æ¥è¡¨ç¤ºçš„ã€‚</p>
<p>æ¯”å¦‚ï¼Œä¸Šé¢è¿™äº›æˆ‘å®Œå…¨å¯ä»¥ç”¨ <code>string</code> æ¥è¡¨ç¤ºï¼Œæˆ‘è¿˜çœŸè§è¿‡ç”¨å­—ç¬¦ä¸²æ¥è¡¨ç¤ºè®¢å•çŠ¶æ€çš„ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Cancelled</span> <span class="p">=</span> <span class="s">&#34;cancelled&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">NoPay</span>     <span class="p">=</span> <span class="s">&#34;noPay&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">PendIng</span>   <span class="p">=</span> <span class="s">&#34;pendIng&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Delivered</span> <span class="p">=</span> <span class="s">&#34;delivered&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Received</span>  <span class="p">=</span> <span class="s">&#34;received&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">OrderStatusMsg</span> <span class="p">=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Cancelled</span><span class="p">:</span> <span class="s">&#34;è®¢å•å·²å–æ¶ˆ&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">NoPay</span><span class="p">:</span>     <span class="s">&#34;æœªä»˜æ¬¾&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">PendIng</span><span class="p">:</span>   <span class="s">&#34;æœªå‘è´§&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Delivered</span><span class="p">:</span> <span class="s">&#34;å·²å‘è´§&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Received</span><span class="p">:</span>  <span class="s">&#34;å·²æ”¶è´§&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">OrderStatusMsg</span><span class="p">[</span><span class="nx">Cancelled</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æˆ–è€…ç›´æ¥å®šä¹‰æ•´å½¢å¸¸é‡å€¼ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Cancelled</span> <span class="p">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="nx">NoPay</span>     <span class="p">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">	<span class="nx">PendIng</span>   <span class="p">=</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Delivered</span> <span class="p">=</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Received</span>  <span class="p">=</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">OrderStatusMsg</span> <span class="p">=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Cancelled</span><span class="p">:</span> <span class="s">&#34;è®¢å•å·²å–æ¶ˆ&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">NoPay</span><span class="p">:</span>     <span class="s">&#34;æœªä»˜æ¬¾&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">PendIng</span><span class="p">:</span>   <span class="s">&#34;æœªå‘è´§&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Delivered</span><span class="p">:</span> <span class="s">&#34;å·²å‘è´§&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Received</span><span class="p">:</span>  <span class="s">&#34;å·²æ”¶è´§&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">OrderStatusMsg</span><span class="p">[</span><span class="nx">Cancelled</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å…¶å®ä¸Šè¿°ä¸¤ç§éƒ½å¯ä»¥ï¼Œä½†æ˜¯ç›¸æ¯”ä¹‹ä¸‹ä½¿ç”¨ <code>iota</code> æ›´æœ‰ä¼˜åŠ¿ã€‚</p>
<ul>
<li>èƒ½ä¿è¯ä¸€ç»„å¸¸é‡çš„å”¯ä¸€æ€§ï¼Œäººå·¥å®šä¹‰çš„ä¸èƒ½ä¿è¯ã€‚</li>
<li>å¯ä»¥ä¸ºä¸€ç»„åŠ¨ä½œåˆ†äº«åŒä¸€ç§è¡Œä¸ºã€‚</li>
<li>é¿å…æ— æ•ˆå€¼ã€‚</li>
<li>æé«˜ä»£ç é˜…è¯»æ€§ä»¥åŠç»´æŠ¤ã€‚</li>
</ul>
<h3 id="å»¶ä¼¸">å»¶ä¼¸</h3>
<p>æŒ‰ç…§ä¸Šé¢æˆ‘ä»¬æ‰€æ¼”ç¤ºçš„ï¼Œæœ€åæˆ‘ä»¬å¯ä»¥è¿™æ ·æ“ä½œã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">OrderStatus</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Cancelled</span> <span class="nx">OrderStatus</span> <span class="p">=</span> <span class="kc">iota</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1">//è®¢å•å·²å–æ¶ˆ 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">NoPay</span>                            <span class="c1">//æœªæ”¯ä»˜ 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">PendIng</span>                          <span class="c1">// æœªå‘è´§ 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Delivered</span>                        <span class="c1">// å·²å‘è´§ 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Received</span>                         <span class="c1">// å·²æ”¶è´§ 5
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//å…¬å…±è¡Œä¸º èµ‹äºˆç±»å‹ String() å‡½æ•°ï¼Œæ–¹ä¾¿æ‰“å°å€¼å«ä¹‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">order</span> <span class="nx">OrderStatus</span><span class="p">)</span> <span class="nf">String</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;cancelled&#34;</span><span class="p">,</span> <span class="s">&#34;noPay&#34;</span><span class="p">,</span> <span class="s">&#34;pendIng&#34;</span><span class="p">,</span> <span class="s">&#34;delivered&#34;</span><span class="p">,</span> <span class="s">&#34;received&#34;</span><span class="p">}[</span><span class="nx">order</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//åˆ›å»ºå…¬å…±è¡Œä¸º èµ‹äºˆç±»å‹ int å‡½æ•° EnumIndex()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">order</span> <span class="nx">OrderStatus</span><span class="p">)</span> <span class="nf">EnumIndex</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nx">order</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">order</span> <span class="nx">OrderStatus</span> <span class="p">=</span> <span class="nx">Received</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">order</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>    <span class="c1">// æ‰“å°:received
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">order</span><span class="p">.</span><span class="nf">EnumIndex</span><span class="p">())</span> <span class="c1">// æ‰“å°:5
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº† <code>Golang</code> ä¸­å¯¹ <code>iota</code> çš„ä½¿ç”¨ä»‹ç»ï¼Œä»¥åŠæˆ‘ä»¬ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å®ƒã€‚</p>
<p>ä¸çŸ¥é“å¤§å®¶å¹³å¸¸å¯¹äºæ­¤ç±»åœºæ™¯æ˜¯ç”¨çš„ä»€ä¹ˆæ‹›æ•°ï¼Œæ¬¢è¿ä¸‹æ–¹ç•™è¨€äº¤æµã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>åŸæ¥sync.Onceè¿˜èƒ½è¿™ä¹ˆç”¨</title>
			<link>https://www.syst.top/posts/go/synconce/</link>
			<pubDate>Sun, 25 Apr 2021 22:25:52 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/synconce/</guid>
			<description>ä»‹ç» sync.Onceä¼°è®¡å¤§å®¶éƒ½ä¸é™Œç”Ÿï¼Œå®˜æ–¹ä»‹ç»ä¸­ï¼Œ
 Once is an object that will perform exactly one action
 æ­£æ˜¯å› ä¸ºè¿™ä¸ªç‰¹æ€§ï¼ŒOnceå¸¸å¸¸è¢«ç”¨äºå•ä¾‹å¯¹è±¡çš„åˆå§‹åŒ–åœºæ™¯ã€‚
ä¹Ÿæ­£æ˜¯å› ä¸ºè¿™ä¸ªç‰¹æ€§ï¼Œå…¶å®å®ƒè¿˜èƒ½åšä¸€äº›å…¶ä»–çš„äº‹æƒ…ã€‚
ç¼“å­˜å‡»ç©¿ æ—¥å¸¸èƒŒè¯µå…«è‚¡æ–‡ï¼Œæˆ‘ç›¸ä¿¡ä½ ä»¬å¯¹ç¼“å­˜å‡»ç©¿è¿™ä¸ªè¯ç‰¹åˆ«ç†Ÿæ‚‰ã€‚
ç¼“å­˜å‡»ç©¿ä¸€èˆ¬å¾…æŒ‡çƒ­ç‚¹keyç¼“å­˜å¤±æ•ˆ(åˆ°æœŸ|åˆ äº†)ï¼ŒåŒä¸€æ—¶åˆ»å¤§é‡å¯¹çƒ­ç‚¹keyçš„å¹¶å‘è¯·æ±‚ã€‚ç¼“å­˜æ‰¾ä¸åˆ°æ•°æ®ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½æ‰“å…¥åˆ°DBå±‚ã€‚æ­¤æ—¶ï¼Œèº«ä¸ºå¼€å‘çš„ä½ ï¼Œæ˜å¤©å’Œæ„å¤–å°±ä¸çŸ¥é“å“ªä¸ªå…ˆåˆ°äº†ã€‚
ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µå‘ç”Ÿï¼Œé’ˆå¯¹ç›¸åŒkeyçš„è¯·æ±‚ï¼Œåªéœ€è¦ä¸€ä¸ªè¯·æ±‚(A)åˆ°è¾¾DBå±‚å–æ•°æ®ï¼Œå…¶ä»–è¯·æ±‚ç­‰å¾…Aé€šçŸ¥å°±è¡Œäº†ã€‚
å°±åƒè¿™æ ·ï¼Œ
â€‹ å›¾ç‰‡æ¥æº:caching
singleflight Goé‡Œæœ‰å¾ˆå¤šé˜²ç¼“å­˜å‡»ç©¿çš„å·¥å…·ï¼Œæ¯”å¦‚singleflightåº“ã€‚
type call struct { wg sync.WaitGroup val interface{} err error forgotten bool //.....çœç•¥éƒ¨åˆ†å­—æ®µ } type Group struct { mu sync.Mutex m map[string]*call } é€šè¿‡ä¸Šé¢ç®€å•çš„ä»£ç å¤§æ¦‚èƒ½çœ‹å‡ºï¼Œå…¶å®å°±æ˜¯å¯¹keyåšäº†ç¼“å­˜ã€‚
æŠŠä¸€ä¸ªkeyå¯¹åº”callç»“æ„å­˜å‚¨åœ¨mapä¸­ã€‚ä¿è¯åªæœ‰ä¸€ä¸ªkeyçœŸæ­£æ‰§è¡Œfn()æœåŠ¡ ï¼Œå…¶ä»–è¯·æ±‚åˆ™é€šè¿‡sync.waitGroupçš„waitç­‰å¾…ç»“æœã€‚
è‡³äºg.docall(c,key,fn)ï¼Œ
å½“å¸¦ç€å…¨æ‘äººå¸Œæœ›çš„é‚£ä¸ªè¯·æ±‚ï¼Œè·å–åˆ°æ•°æ®ï¼Œç»™å¯¹åº”keyçš„callèµ‹å€¼ï¼Œæœ€ç»ˆæ‰§è¡Œdoneï¼Œé€šçŸ¥ç­‰å¾…è¿™ä¸ªkeyå…¨æ‘çš„æ‘æ°‘è·å–æ•°æ®ã€‚
ä»£ç å¹¶ä¸å¤æ‚ã€‚
è‡ªå®šä¹‰singleflight æˆ‘ä»¬ä¹Ÿå¯ä»¥å®ç°ä¸€ä¸ªç®€æ˜“ç‰ˆæœ¬çš„ã€‚
package main import ( &amp;#34;fmt&amp;#34; &amp;#34;sync&amp;#34; &amp;#34;time&amp;#34; ) type CacheEntry struct { data []byte err error wait chan struct{} } type OrderSever struct { cache map[string]*CacheEntry mutex sync.</description>
			<content type="html"><![CDATA[<h3 id="ä»‹ç»">ä»‹ç»</h3>
<p><code>sync.Once</code>ä¼°è®¡å¤§å®¶éƒ½ä¸é™Œç”Ÿï¼Œå®˜æ–¹ä»‹ç»ä¸­ï¼Œ</p>
<blockquote>
<p>Once is an object that will perform exactly one action</p>
</blockquote>
<p>æ­£æ˜¯å› ä¸ºè¿™ä¸ªç‰¹æ€§ï¼Œ<code>Once</code>å¸¸å¸¸è¢«ç”¨äºå•ä¾‹å¯¹è±¡çš„åˆå§‹åŒ–åœºæ™¯ã€‚</p>
<p>ä¹Ÿæ­£æ˜¯å› ä¸ºè¿™ä¸ªç‰¹æ€§ï¼Œå…¶å®å®ƒè¿˜èƒ½åšä¸€äº›å…¶ä»–çš„äº‹æƒ…ã€‚</p>
<h3 id="ç¼“å­˜å‡»ç©¿">ç¼“å­˜å‡»ç©¿</h3>
<p>æ—¥å¸¸èƒŒè¯µå…«è‚¡æ–‡ï¼Œæˆ‘ç›¸ä¿¡ä½ ä»¬å¯¹<strong>ç¼“å­˜å‡»ç©¿</strong>è¿™ä¸ªè¯ç‰¹åˆ«ç†Ÿæ‚‰ã€‚</p>
<p><strong>ç¼“å­˜å‡»ç©¿</strong>ä¸€èˆ¬å¾…æŒ‡çƒ­ç‚¹<code>key</code>ç¼“å­˜å¤±æ•ˆ(åˆ°æœŸ|åˆ äº†)ï¼ŒåŒä¸€æ—¶åˆ»å¤§é‡å¯¹çƒ­ç‚¹<code>key</code>çš„å¹¶å‘è¯·æ±‚ã€‚ç¼“å­˜æ‰¾ä¸åˆ°æ•°æ®ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½æ‰“å…¥åˆ°<code>DB</code>å±‚ã€‚æ­¤æ—¶ï¼Œèº«ä¸ºå¼€å‘çš„ä½ ï¼Œæ˜å¤©å’Œæ„å¤–å°±ä¸çŸ¥é“å“ªä¸ªå…ˆåˆ°äº†ã€‚</p>
<p>ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µå‘ç”Ÿï¼Œé’ˆå¯¹ç›¸åŒ<code>key</code>çš„è¯·æ±‚ï¼Œåªéœ€è¦ä¸€ä¸ªè¯·æ±‚(A)åˆ°è¾¾<code>DB</code>å±‚å–æ•°æ®ï¼Œå…¶ä»–è¯·æ±‚ç­‰å¾…<code>A</code>é€šçŸ¥å°±è¡Œäº†ã€‚</p>
<p>å°±åƒè¿™æ ·ï¼Œ</p>
<p><img src="https://cdn.syst.top/%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF.png" alt="ç¼“å­˜å‡»ç©¿"></p>
<p>â€‹                                 å›¾ç‰‡æ¥æº:<a href="https://medium.com/codex/caching-system-stability-766bf5fff69f">caching</a></p>
<h3 id="singleflight">singleflight</h3>
<p><code>Go</code>é‡Œæœ‰å¾ˆå¤šé˜²ç¼“å­˜å‡»ç©¿çš„å·¥å…·ï¼Œæ¯”å¦‚<code>singleflight</code>åº“ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">call</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
</span></span><span class="line"><span class="cl">	<span class="nx">val</span> <span class="kd">interface</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nx">forgotten</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//.....çœç•¥éƒ¨åˆ†å­—æ®µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Group</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">mu</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>       
</span></span><span class="line"><span class="cl">	<span class="nx">m</span>  <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">call</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><img src="https://cdn.syst.top/once-1.png" alt=""></p>
<p>é€šè¿‡ä¸Šé¢ç®€å•çš„ä»£ç å¤§æ¦‚èƒ½çœ‹å‡ºï¼Œå…¶å®å°±æ˜¯å¯¹<code>key</code>åšäº†ç¼“å­˜ã€‚</p>
<p>æŠŠä¸€ä¸ª<code>key</code>å¯¹åº”<code>call</code>ç»“æ„å­˜å‚¨åœ¨<code>map</code>ä¸­ã€‚ä¿è¯åªæœ‰ä¸€ä¸ª<code>key</code>çœŸæ­£æ‰§è¡Œ<code>fn()</code>æœåŠ¡ ï¼Œå…¶ä»–è¯·æ±‚åˆ™é€šè¿‡<code>sync.waitGroup</code>çš„<code>wait</code>ç­‰å¾…ç»“æœã€‚</p>
<p>è‡³äº<code>g.docall(c,key,fn)</code>ï¼Œ</p>
<p><img src="https://cdn.syst.top/once-2.png" alt=""></p>
<p>å½“å¸¦ç€å…¨æ‘äººå¸Œæœ›çš„é‚£ä¸ªè¯·æ±‚ï¼Œè·å–åˆ°æ•°æ®ï¼Œç»™å¯¹åº”<code>key</code>çš„<code>call</code>èµ‹å€¼ï¼Œæœ€ç»ˆæ‰§è¡Œ<code>done</code>ï¼Œé€šçŸ¥ç­‰å¾…è¿™ä¸ª<code>key</code>å…¨æ‘çš„æ‘æ°‘è·å–æ•°æ®ã€‚</p>
<p>ä»£ç å¹¶ä¸å¤æ‚ã€‚</p>
<h3 id="è‡ªå®šä¹‰singleflight"><strong>è‡ªå®šä¹‰</strong>singleflight</h3>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥å®ç°ä¸€ä¸ªç®€æ˜“ç‰ˆæœ¬çš„ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;sync&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">CacheEntry</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span>  <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nx">wait</span> <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">OrderSever</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cache</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">CacheEntry</span>
</span></span><span class="line"><span class="cl">	<span class="nx">mutex</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">order</span> <span class="o">*</span><span class="nx">OrderSever</span><span class="p">)</span> <span class="nf">Query</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">order</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">order</span><span class="p">.</span><span class="nx">cache</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">order</span><span class="p">.</span><span class="nx">cache</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">CacheEntry</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">//å·²ç»æœ‰å…¶ä»–å…„å¼Ÿè¯·æ±‚äº†ï¼Œä½ ç­‰ç­‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">entry</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">order</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">order</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="o">&lt;-</span><span class="nx">entry</span><span class="p">.</span><span class="nx">wait</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">entry</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">CacheEntry</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">data</span><span class="p">:</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">wait</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}),</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">order</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="p">=</span> <span class="nx">entry</span>
</span></span><span class="line"><span class="cl">	<span class="nx">order</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// è¯·æ±‚æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">entry</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">err</span> <span class="p">=</span> <span class="nf">getOrder</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// è¯·æ±‚æ•°æ®å®Œæ¯•ï¼Œé€šçŸ¥å…¶ä»–å…„å¼Ÿå¯ä»¥æ‹¿æ•°æ®äº†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nb">close</span><span class="p">(</span><span class="nx">entry</span><span class="p">.</span><span class="nx">wait</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//å¤–éƒ¨æœåŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">getOrder</span><span class="p">()</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">50</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;hello world&#34;</span><span class="p">),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ä»£ç æ•´ä½“ä¸éš¾ï¼Œä¸»è¦çš„ç‚¹åœ¨äºæˆ‘ä»¬æ˜¯é€šè¿‡é€šé“æ¥å®ç°é€šçŸ¥è‡ªå®¶å…„å¼Ÿå–æ•°æ®ã€‚</p>
<p>æœ€åï¼Œè®©æˆ‘ä»¬ä½¿ç”¨<code>Once</code>æ¥è¾¾åˆ°åŒæ ·çš„æ•ˆæœï¼Œä¸ç„¶æ ‡é¢˜ä¸ç™½èµ·äº†å˜›ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;sync&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">CacheEntry</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span>  <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nx">once</span> <span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">Once</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">OrderSever</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cache</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">CacheEntry</span>
</span></span><span class="line"><span class="cl">	<span class="nx">mutex</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">order</span> <span class="o">*</span><span class="nx">OrderSever</span><span class="p">)</span> <span class="nf">Query</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">order</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">order</span><span class="p">.</span><span class="nx">cache</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">order</span><span class="p">.</span><span class="nx">cache</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">CacheEntry</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">entry</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">order</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">// æ‰¾ä¸åˆ°å°±åˆå§‹åŒ–ä¸€ä¸ª
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">entry</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">CacheEntry</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">data</span><span class="p">:</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">			<span class="nx">err</span><span class="p">:</span>  <span class="kc">nil</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">once</span><span class="p">:</span> <span class="nb">new</span><span class="p">(</span><span class="nx">sync</span><span class="p">.</span><span class="nx">Once</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">order</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="p">=</span> <span class="nx">entry</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">order</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">// æˆ‘åªæ‰§è¡Œä¸€æ¬¡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">entry</span><span class="p">.</span><span class="nx">once</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">entry</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">err</span> <span class="p">=</span> <span class="nf">getOrder</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//æ•°æ®è¢«èµ‹å€¼äº†ï¼Œè¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">getOrder</span><span class="p">()</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">50</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;hello world&#34;</span><span class="p">),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ä¸Šé¢æ ¸å¿ƒä»£ç éƒ½å†™å‡ºæ¥äº†ï¼Œå®é™…å¼€å‘ä¸­éœ€è¦å¯¹è¯·æ±‚èµ„æºåšä¸€äº›è¶…æ—¶æ§åˆ¶ç­‰æ“ä½œã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>å¹³å¸¸å¯¹<code>Once</code>çš„ä½¿ç”¨åªåœç•™åœ¨åˆå§‹åŒ–å·¥ä½œä¸Šï¼Œè€Œå¼±åŒ–äº†å®ƒçš„ä½¿ç”¨åœºæ™¯ã€‚å¯¹äºå…¶ä»–å·¥å…·ä¹Ÿæ˜¯ä¸€ä¸ªé“ç†ï¼Œè¿™å°±éœ€è¦å»ç§¯ç´¯å’ŒæŒ–æ˜äº†ã€‚</p>
<h3 id="é™„å½•"><strong>é™„å½•</strong></h3>
<p>[1]https://medium.com/codex/caching-system-stability-766bf5fff69f</p>
<p><a href="https://blog.chuie.io/posts/synconce/">https://blog.chuie.io/posts/synconce/</a></p>
]]></content>
		</item>
		
		<item>
			<title>æ¨èä¸¤æ¬¾goå¼€å‘ä¸­æé«˜æ•ˆç‡å·¥å…·</title>
			<link>https://www.syst.top/posts/go/go-tool/</link>
			<pubDate>Sun, 25 Apr 2021 22:25:52 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/go-tool/</guid>
			<description>ä»‹ç» æ¨èä¸¤æ¬¾ go å¼€å‘ä¸­ç”¨çš„è¿˜è¡Œçš„å·¥å…·ã€‚
ä¸ºä»€ä¹ˆæ¨èå·¥å…·ï¼Ÿæ˜¯ä¸ºäº†è®©è¯„è®ºåŒºçš„å¤§ä½¬ä»‹ç»å…¶ä»–æ›´å¥½ç”¨çš„å·¥å…·ï¼Œè§£æ”¾æˆ‘çš„åŒæ‰‹ã€‚
é¡ºä¾¿é—®é—®ï¼Œæœ‰æ²¡æœ‰åªè¯´è¯å°±èƒ½è‡ªåŠ¨æ‰“å®Œä»£ç çš„å·¥å…·ï¼Ÿ
JSON-To-Stuct è¿™ä¸ªå·¥å…·å¯ä»¥æŠŠ json æ ¼å¼çš„æ•°æ®è½¬æ¢æˆ go çš„ structã€‚æ¯”å¦‚ä½ åœ¨å¯¹æ¥ç¬¬ä¸‰æ–¹çš„æ—¶å€™ï¼Œå°±ä¸éœ€è¦æ ¹æ®å¯¹æ–¹çš„æ¥å£ä¸€ä¸ªä¸ªå®šä¹‰ struct å­—æ®µã€‚ä¸‹é¢ç¤ºä¾‹å¤åˆ¶çš„å¾®ä¿¡å°å•†åº—å•†å“ json æ•°æ®åˆ°ç½‘ç«™çš„å·¦æ¡†å³å¯ï¼Œå½“ç„¶è‡ªå·±è¿˜æ˜¯éœ€è¦åšä¸€äº›å±€éƒ¨çš„è°ƒæ•´ã€‚
å…¶å®è¿™ä¸ªåŠŸèƒ½ 21 ç‰ˆçš„ goland ä¹Ÿæ”¯æŒäº†ã€‚åœ¨ goland ä¸­ä½ åªéœ€è¦è¿™æ ·,
Table-To-Stuct è¢«ä¸šåŠ¡ç¼ èº«çš„åŒå­¦æ¯å¤©å…ä¸äº† CURDã€‚CURD ä¹‹å‰æ€»å¾—å»ºè¡¨å§ã€‚å»ºè¡¨ä¹‹åæ€»å¾—åœ¨ä»£ç ä¸­å®šä¹‰æ¨¡å‹å§ã€‚æ€»ä¸èƒ½åˆä¸€ä¸ªä¸ªå­—æ®µå®šä¹‰ï¼Œé‚£ä¹ˆä¸‹é¢è¿™ä¸ªå·¥å…·å¯èƒ½ç®¡ç”¨ã€‚
å‡è®¾ä½ æœ‰ä¸€ä¸ªåº“ dreamï¼Œåº“é‡Œæœ‰ä¸€ä¸ªè¡¨ categoryï¼Œç»“æ„å¦‚ä¸‹ï¼Œ
CREATETABLE`category`(`id`int(11)unsignedNOTNULLAUTO_INCREMENT,`name`varchar(20)NOTNULLDEFAULT&amp;#39;&amp;#39;,`parent_id`int(11)unsignedNOTNULLDEFAULT&amp;#39;0&amp;#39;,`created_at`timestampNOTNULLDEFAULTCURRENT_TIMESTAMP,`updated_at`timestampNOTNULLDEFAULTCURRENT_TIMESTAMP,PRIMARYKEY(`id`),UNIQUEKEY`name`(`name`))ENGINE=InnoDBAUTO_INCREMENT=23DEFAULTCHARSET=utf8mb4;ä½ åªéœ€å¼•å…¥åŒ… github.com/gohouse/converter ,ç„¶åå†™è¿™æ ·çš„ä»£ç ï¼Œå°±å¯ä»¥å®ç° table-to-go åŠŸèƒ½ã€‚
package main import ( &amp;#34;fmt&amp;#34; &amp;#34;github.com/gohouse/converter&amp;#34; ) func main() { // åˆå§‹åŒ– 	t2t := converter.NewTable2Struct() // ä¸ªæ€§åŒ–é…ç½® 	t2t.Config(&amp;amp;converter.T2tConfig{ // å¦‚æœå­—æ®µé¦–å­—æ¯æœ¬æ¥å°±æ˜¯å¤§å†™, å°±ä¸æ·»åŠ tag, é»˜è®¤falseæ·»åŠ , trueä¸æ·»åŠ  	RmTagIfUcFirsted: false, // tagçš„å­—æ®µåå­—æ˜¯å¦è½¬æ¢ä¸ºå°å†™, å¦‚æœæœ¬èº«æœ‰å¤§å†™å­—æ¯çš„è¯, é»˜è®¤falseä¸è½¬ 	TagToLower: false, // å­—æ®µé¦–å­—æ¯å¤§å†™çš„åŒæ—¶, æ˜¯å¦è¦æŠŠå…¶ä»–å­—æ¯è½¬æ¢ä¸ºå°å†™,é»˜è®¤falseä¸è½¬æ¢ 	UcFirstOnly: false, //// æ¯ä¸ªstructæ”¾å…¥å•ç‹¬çš„æ–‡ä»¶,é»˜è®¤false,æ”¾å…¥åŒä¸€ä¸ªæ–‡ä»¶(æš‚æœªæä¾›) 	//SeperatFile: false, 	}) // å¼€å§‹è¿ç§»è½¬æ¢ 	err := t2t.</description>
			<content type="html"><![CDATA[<h3 id="ä»‹ç»">ä»‹ç»</h3>
<p>æ¨èä¸¤æ¬¾ <code>go</code> å¼€å‘ä¸­ç”¨çš„è¿˜è¡Œçš„å·¥å…·ã€‚</p>
<p>ä¸ºä»€ä¹ˆæ¨èå·¥å…·ï¼Ÿæ˜¯ä¸ºäº†è®©è¯„è®ºåŒºçš„å¤§ä½¬ä»‹ç»å…¶ä»–æ›´å¥½ç”¨çš„å·¥å…·ï¼Œè§£æ”¾æˆ‘çš„åŒæ‰‹ã€‚</p>
<p>é¡ºä¾¿é—®é—®ï¼Œæœ‰æ²¡æœ‰åªè¯´è¯å°±èƒ½è‡ªåŠ¨æ‰“å®Œä»£ç çš„å·¥å…·ï¼Ÿ</p>
<h3 id="json-to-stuct">JSON-To-Stuct</h3>
<p>è¿™ä¸ªå·¥å…·å¯ä»¥æŠŠ <code>json</code> æ ¼å¼çš„æ•°æ®è½¬æ¢æˆ <code>go</code> çš„ <code>struct</code>ã€‚æ¯”å¦‚ä½ åœ¨å¯¹æ¥ç¬¬ä¸‰æ–¹çš„æ—¶å€™ï¼Œå°±ä¸éœ€è¦æ ¹æ®å¯¹æ–¹çš„æ¥å£ä¸€ä¸ªä¸ªå®šä¹‰ <code>struct</code> å­—æ®µã€‚ä¸‹é¢ç¤ºä¾‹å¤åˆ¶çš„å¾®ä¿¡å°å•†åº—å•†å“ <code>json</code> æ•°æ®åˆ°ç½‘ç«™çš„å·¦æ¡†å³å¯ï¼Œå½“ç„¶è‡ªå·±è¿˜æ˜¯éœ€è¦åšä¸€äº›å±€éƒ¨çš„è°ƒæ•´ã€‚</p>
<p><img src="https://image.syst.top/image/go-tool/1.png" alt="image"></p>
<p>å…¶å®è¿™ä¸ªåŠŸèƒ½ 21 ç‰ˆçš„ <code>goland</code> ä¹Ÿæ”¯æŒäº†ã€‚åœ¨ <code>goland</code> ä¸­ä½ åªéœ€è¦è¿™æ ·,</p>
<p><img src="https://image.syst.top/image/go-tool/2.gif" alt="image"></p>
<h3 id="table-to-stuct">Table-To-Stuct</h3>
<p>è¢«ä¸šåŠ¡ç¼ èº«çš„åŒå­¦æ¯å¤©å…ä¸äº† <code>CURD</code>ã€‚<code>CURD</code> ä¹‹å‰æ€»å¾—å»ºè¡¨å§ã€‚å»ºè¡¨ä¹‹åæ€»å¾—åœ¨ä»£ç ä¸­å®šä¹‰æ¨¡å‹å§ã€‚æ€»ä¸èƒ½åˆä¸€ä¸ªä¸ªå­—æ®µå®šä¹‰ï¼Œé‚£ä¹ˆä¸‹é¢è¿™ä¸ªå·¥å…·å¯èƒ½ç®¡ç”¨ã€‚</p>
<p>å‡è®¾ä½ æœ‰ä¸€ä¸ªåº“ <code>dream</code>ï¼Œåº“é‡Œæœ‰ä¸€ä¸ªè¡¨ <code>category</code>ï¼Œç»“æ„å¦‚ä¸‹ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">category</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">parent_id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">created_at</span><span class="o">`</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">updated_at</span><span class="o">`</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">23</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>ä½ åªéœ€å¼•å…¥åŒ… <code>github.com/gohouse/converter</code> ,ç„¶åå†™è¿™æ ·çš„ä»£ç ï¼Œå°±å¯ä»¥å®ç° <code>table-to-go</code> åŠŸèƒ½ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/gohouse/converter&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">t2t</span> <span class="o">:=</span> <span class="nx">converter</span><span class="p">.</span><span class="nf">NewTable2Struct</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ä¸ªæ€§åŒ–é…ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">t2t</span><span class="p">.</span><span class="nf">Config</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">converter</span><span class="p">.</span><span class="nx">T2tConfig</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// å¦‚æœå­—æ®µé¦–å­—æ¯æœ¬æ¥å°±æ˜¯å¤§å†™, å°±ä¸æ·»åŠ tag, é»˜è®¤falseæ·»åŠ , trueä¸æ·»åŠ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">RmTagIfUcFirsted</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// tagçš„å­—æ®µåå­—æ˜¯å¦è½¬æ¢ä¸ºå°å†™, å¦‚æœæœ¬èº«æœ‰å¤§å†™å­—æ¯çš„è¯, é»˜è®¤falseä¸è½¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">TagToLower</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// å­—æ®µé¦–å­—æ¯å¤§å†™çš„åŒæ—¶, æ˜¯å¦è¦æŠŠå…¶ä»–å­—æ¯è½¬æ¢ä¸ºå°å†™,é»˜è®¤falseä¸è½¬æ¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">UcFirstOnly</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//// æ¯ä¸ªstructæ”¾å…¥å•ç‹¬çš„æ–‡ä»¶,é»˜è®¤false,æ”¾å…¥åŒä¸€ä¸ªæ–‡ä»¶(æš‚æœªæä¾›)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">//SeperatFile: false,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// å¼€å§‹è¿ç§»è½¬æ¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">t2t</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// æŒ‡å®šæŸä¸ªè¡¨,å¦‚æœä¸æŒ‡å®š,åˆ™é»˜è®¤å…¨éƒ¨è¡¨éƒ½è¿ç§»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">Table</span><span class="p">(</span><span class="s">&#34;category&#34;</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//// è¡¨å‰ç¼€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">//Prefix(&#34;prefix_&#34;).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// æ˜¯å¦æ·»åŠ json tag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">EnableJsonTag</span><span class="p">(</span><span class="kc">true</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// ç”Ÿæˆstructçš„åŒ…å(é»˜è®¤ä¸ºç©ºçš„è¯, åˆ™å–åä¸º: package model)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">PackageName</span><span class="p">(</span><span class="s">&#34;model&#34;</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// tagå­—æ®µçš„keyå€¼,é»˜è®¤æ˜¯orm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">TagKey</span><span class="p">(</span><span class="s">&#34;orm&#34;</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// æ˜¯å¦æ·»åŠ ç»“æ„ä½“æ–¹æ³•è·å–è¡¨å
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">RealNameMethod</span><span class="p">(</span><span class="s">&#34;TableName&#34;</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// ç”Ÿæˆçš„ç»“æ„ä½“ä¿å­˜è·¯å¾„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">SavePath</span><span class="p">(</span><span class="s">&#34;model/category.go&#34;</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// æ•°æ®åº“dsn,è¿™é‡Œå¯ä»¥ä½¿ç”¨ t2t.DB() ä»£æ›¿,å‚æ•°ä¸º *sql.DB å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">Dsn</span><span class="p">(</span><span class="s">&#34;root:Passw0rd@tcp(localhost:3306)/dream?charset=utf8&#34;</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// æ‰§è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">Run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¿è¡Œè¿™æ®µä»£ç ï¼Œæœ€åä¼šæ ¹æ®è®¾ç½®çš„ <code>SavePath</code> é‡Œçš„åœ°å€(å°šæœªå­˜åœ¨çš„ç›®å½•éœ€è¦å…ˆè‡ªè¡Œåˆ›å»º)ï¼Œç”Ÿæˆ <code>category.go</code> æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">model</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Category</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Id</span>        <span class="kt">int</span>    <span class="s">`orm:&#34;id&#34; json:&#34;id&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Name</span>      <span class="kt">string</span> <span class="s">`orm:&#34;name&#34; json:&#34;name&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ParentId</span>  <span class="kt">int</span>    <span class="s">`orm:&#34;parent_id&#34; json:&#34;parent_id&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">CreatedAt</span> <span class="kt">string</span> <span class="s">`orm:&#34;created_at&#34; json:&#34;created_at&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">UpdatedAt</span> <span class="kt">string</span> <span class="s">`orm:&#34;updated_at&#34; json:&#34;updated_at&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="o">*</span><span class="nx">Category</span><span class="p">)</span> <span class="nf">TableName</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="s">&#34;category&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ç›¸åº”çš„å†è¿›è¡Œè°ƒæ•´å³å¯ã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>ä»Šå¤©ä¸»è¦åˆ†äº«çš„æ˜¯ <code>json-to-stuct</code>ã€<code>table-to-stuct</code> è¿™ä¸¤æ¬¾æ—¥å¸¸ä¼šç”¨ä¸Šçš„å·¥å…·ã€‚</p>
<p>å¥½äº†ï¼Œç°åœ¨å¼€å§‹ä½ ä»¬ç»™æˆ‘ä»‹ç»è¶æ‰‹çš„å·¥å…·äº†ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>æ— é™ç¼“å†²çš„channel(1)</title>
			<link>https://www.syst.top/posts/go/unlimited/</link>
			<pubDate>Sun, 25 Apr 2021 22:25:52 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/unlimited/</guid>
			<description>ä»‹ç» äº‹æƒ…çš„èµ·å› æ˜¯å‰å‡ å‘¨çœ‹åˆ°é¸Ÿçªå†™äº†ä¸€ç¯‡å…³äºå®ç°æ— é™ç¼“å†² channel çš„æ–‡ç« ï¼Œå½“æ—¶å¿™ç€å’Œå°å§å§èŠå¤©æ²¡çœ‹ï¼Œä»Šå¤©æƒ³èµ·æ¥äº†ã€‚
ä¸è¿‡è¿™ç¯‡æ–‡ç« ä¸ä¼šæ¶‰åŠåˆ°é¸Ÿçªè‡ªå·±å®ç°çš„ chanxï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸‹ä¸€ç¯‡æåˆ°ã€‚
æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œchannel æœ‰ä¸¤ç§ç±»å‹:æ— ç¼“å†²å’Œæœ‰ç¼“å†²çš„ã€‚
å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæœ‰ç¼“å†²çš„é€šé“å¹¶æŒ‡å®šäº†å®¹é‡ï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªé€šé“çš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œæˆ‘ä»¬å°†å†ä¹Ÿæ— æ³•æ”¹å˜å®ƒçš„å®¹é‡ã€‚
æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“ä¹Ÿæ— æ³•é¢„ä¼°å†™å…¥é€šé“çš„æ•°é‡è§„æ¨¡ã€‚å¦‚æœæ­¤æ—¶é€šé“çš„å†™å…¥é€Ÿåº¦è¿œè¿œè¶…è¿‡è¯»å–é€Ÿåº¦ï¼Œé‚£ä¹ˆå¿…ç„¶ä¼šåœ¨æŸä¸ªæ—¶é—´ç‚¹å¡æ»¡é€šé“ï¼Œå¯¼è‡´å†™å…¥é˜»å¡ã€‚ æ¯”å¦‚ä¹‹å‰æˆ‘ç¿»è¯‘çš„ä¸€ç¯‡æ–‡ç«  ä½¿ç”¨ Go æ¯åˆ†é’Ÿå¤„ç†ç™¾ä¸‡è¯·æ±‚ ä¸­ï¼Œä½œè€…å°±å‡ºç°å¤„ç†é€Ÿåº¦å¤ªæ…¢ï¼Œå¯¼è‡´é€šé“å¡æ»¡ï¼Œå…¶ä»–è¯·æ±‚è¢«é˜»å¡ï¼Œå“åº”æ—¶é—´æ…¢æ…¢å¢åŠ ã€‚
æ­¤æ—¶æœ‰äººå°±ä¼šæåˆ°ï¼Œèƒ½ä¸èƒ½æä¾›ä¸€ä¸ªæ— é™ç¼“å†²(Unbounded or Unlimited)çš„é€šé“ã€‚
è¿™ä¸ªé—®é¢˜æ—©åœ¨ 2017 å¹´å°±æœ‰äººæè¿‡ issuesï¼Œæœ€ç»ˆ go å®˜æ–¹æ²¡æœ‰å®ç°è¿™ä¸ªææ¡ˆã€‚
ä¸è¿‡ï¼Œè¿™ä¸ª issues ä¸‹é¢æ€»å…±äº§ç”Ÿäº† 67 ä¸ª commentsï¼Œè¯„è®ºå¾ˆç²¾å½©ã€‚ æ¯”å¦‚æœ‰äººæåˆ°:
cznic:Unlimited capacity channels ask for a machine with unlimited memory. rsc:The limited capacity of channels is an important source of backpressure in a set of communicating goroutines. It is typically a mistake to use an unbounded channel, because you lose that backpressure.</description>
			<content type="html"><![CDATA[<h2 id="ä»‹ç»">ä»‹ç»</h2>
<p>äº‹æƒ…çš„èµ·å› æ˜¯å‰å‡ å‘¨çœ‹åˆ°é¸Ÿçªå†™äº†ä¸€ç¯‡å…³äºå®ç°æ— é™ç¼“å†² <code>channel</code> çš„æ–‡ç« ï¼Œå½“æ—¶å¿™ç€å’Œå°å§å§èŠå¤©æ²¡çœ‹ï¼Œä»Šå¤©æƒ³èµ·æ¥äº†ã€‚</p>
<p>ä¸è¿‡è¿™ç¯‡æ–‡ç« ä¸ä¼šæ¶‰åŠåˆ°é¸Ÿçªè‡ªå·±å®ç°çš„ <code>chanx</code>ï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸‹ä¸€ç¯‡æåˆ°ã€‚</p>
<p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œ<code>channel</code> æœ‰ä¸¤ç§ç±»å‹:æ— ç¼“å†²å’Œæœ‰ç¼“å†²çš„ã€‚</p>
<p>å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæœ‰ç¼“å†²çš„é€šé“å¹¶æŒ‡å®šäº†å®¹é‡ï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªé€šé“çš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œæˆ‘ä»¬å°†å†ä¹Ÿæ— æ³•æ”¹å˜å®ƒçš„å®¹é‡ã€‚</p>
<p>æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“ä¹Ÿæ— æ³•é¢„ä¼°å†™å…¥é€šé“çš„æ•°é‡è§„æ¨¡ã€‚å¦‚æœæ­¤æ—¶é€šé“çš„å†™å…¥é€Ÿåº¦è¿œè¿œè¶…è¿‡è¯»å–é€Ÿåº¦ï¼Œé‚£ä¹ˆå¿…ç„¶ä¼šåœ¨æŸä¸ªæ—¶é—´ç‚¹å¡æ»¡é€šé“ï¼Œå¯¼è‡´å†™å…¥é˜»å¡ã€‚
æ¯”å¦‚ä¹‹å‰æˆ‘ç¿»è¯‘çš„ä¸€ç¯‡æ–‡ç«  <a href="https://www.syst.top/posts/go/handle-million-requests/">ä½¿ç”¨ Go æ¯åˆ†é’Ÿå¤„ç†ç™¾ä¸‡è¯·æ±‚</a> ä¸­ï¼Œä½œè€…å°±å‡ºç°å¤„ç†é€Ÿåº¦å¤ªæ…¢ï¼Œå¯¼è‡´é€šé“å¡æ»¡ï¼Œå…¶ä»–è¯·æ±‚è¢«é˜»å¡ï¼Œå“åº”æ—¶é—´æ…¢æ…¢å¢åŠ ã€‚</p>
<p>æ­¤æ—¶æœ‰äººå°±ä¼šæåˆ°ï¼Œèƒ½ä¸èƒ½æä¾›ä¸€ä¸ªæ— é™ç¼“å†²(Unbounded or Unlimited)çš„é€šé“ã€‚</p>
<p>è¿™ä¸ªé—®é¢˜æ—©åœ¨ 2017 å¹´å°±æœ‰äººæè¿‡ issuesï¼Œæœ€ç»ˆ go å®˜æ–¹æ²¡æœ‰å®ç°è¿™ä¸ªææ¡ˆã€‚</p>
<p>ä¸è¿‡ï¼Œè¿™ä¸ª issues ä¸‹é¢æ€»å…±äº§ç”Ÿäº† 67 ä¸ª commentsï¼Œè¯„è®ºå¾ˆç²¾å½©ã€‚
<img src="https://image.syst.top/image/unlimited/unlimit-1.png" alt="image"></p>
<p>æ¯”å¦‚æœ‰äººæåˆ°:</p>
<pre tabindex="0"><code>cznic:Unlimited capacity channels ask for a machine with unlimited memory.

rsc:The limited capacity of channels is an important source of backpressure in a set of communicating goroutines. It is typically a mistake to use an unbounded channel, because you lose that backpressure. If one goroutine falls sufficiently behind, you usually want to take some action in response, not just queue its messages forever. The appropriate response varies by situation: maybe you want to drop messages, maybe you want to keep summary messages, maybe you want to take different responses as the goroutine falls further and further behind. Making it trivial to reach for unbounded channels keeps developers from thinking about this, which I believe is a strong disadvantage.
</code></pre><p>é‚£ä¹ˆå¦‚ä½•å®ç°ä¸€ä¸ªæ— é™ç¼“å†²çš„é€šé“å‘¢ï¼Ÿ</p>
<p>é’ˆå¯¹è¿™ç±»éœ€æ±‚ï¼Œæœ‰å¾ˆå¤šç‰ˆæœ¬çš„å®ç°ï¼Œæˆ‘ä»¬æ¥çœ‹å…¶ä¸­çš„ä¸€ä¸ªå®ç°ã€‚é¸Ÿçªçš„ chanx å°±æ˜¯åœ¨è¿™ä¸ªåŸºç¡€ä¸Šåšä¿®æ”¹çš„ã€‚</p>
<p>æˆ‘ä»¬ä¸€æ­¥æ­¥è¿˜åŸå®ƒçš„å®ç°ï¼Œè¿™å…¶ä¸­è¿˜èƒ½çŸ¥é“ä½œè€…çš„æ€è€ƒè¿‡ç¨‹ã€‚</p>
<h2 id="ä»£ç ">ä»£ç </h2>
<p>ç¬¬ä¸€ç‰ˆ,</p>
<p><img src="https://image.syst.top/image/unlimited/unlimit-2.png" alt="image"></p>
<p><code>MakeInfinite</code> å‡½æ•°è¿”å›ä¸¤ä¸ªé€šé“ï¼Œç¬¬ä¸€ä¸ªç”¨äºæ•°æ®çš„å†™å…¥ï¼Œç¬¬äºŒä¸ªç”¨äºæ•°æ®çš„è¯»å–ã€‚</p>
<p>æ³¨æ„çœ‹è¿™é‡Œçš„ç»†èŠ‚ï¼Œåœ¨è¿”å›çš„æ—¶å€™å°±çº¦æŸäº†é€šé“çš„æ“ä½œç±»å‹:ä¸€ä¸ªåªå†™ï¼Œä¸€ä¸ªåªè¯»ï¼Œè¿™æ ·é¿å…äº†ç”¨æˆ·ç ´åé€šé“çš„æ“ä½œæµç¨‹ã€‚
è¿™é‡Œé¢çš„ä»£ç ä¹Ÿç®€å•ï¼Œåªè¦å†™å…¥é€šé“ <code>in</code> æœªè¢«å…³é—­ï¼Œé‚£ä¹ˆå°±æŠŠä» <code>in</code> é€šé“ä¸­è¯»å–çš„å€¼ <code>append</code> åˆ° <code>inQueue</code> åˆ‡ç‰‡ä¸­ã€‚
<code>inQueue</code> åœ¨è¿™é‡Œå°±æ˜¯å®ç°æ— é™ç¼“å†²çš„ä¸­é—´å±‚ã€‚</p>
<p>ç„¶åæœ‰ä¸ª testã€‚</p>
<p><img src="https://image.syst.top/image/unlimited/unlimit-3.png" alt="image"></p>
<p><img src="https://image.syst.top/image/unlimited/unlimit-4.png" alt="image"></p>
<p>å½“èµ°åˆ°ç¬¬äºŒä¸ª <code>case</code> çš„æ—¶å€™ï¼Œç”±äº <code>inQueue</code> ä¸€å¼€å§‹æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆå¿…ç„¶ä¼šå‡ºç°  <code>index out</code>ã€‚
ä¸ä»…æ˜¯ä¸€å¼€å§‹ï¼Œåœ¨è¿è¡Œä¸­ï¼Œå¦‚æœè¯»å–æ¯”å†™å…¥å¿«ï¼Œé‚£ä¹ˆå¿…ç„¶ä¹Ÿä¼šå¯¼è‡´ç›¸åŒçš„æƒ…å†µã€‚</p>
<p><img src="https://image.syst.top/image/unlimited/unlimit-5.jpg" alt="image">
<img src="https://image.syst.top/image/unlimited/unlimit-6.png" alt="image"></p>
<p>åœ¨ <code>inQueue</code> æ²¡æœ‰å€¼çš„æ—¶å€™ï¼Œæˆ‘ä»¬æŠŠ <code>nil</code> ä¹Ÿå†™å…¥åˆ°é€šé“ï¼Œ
ç„¶åæµ‹è¯•ä»£ç ä¸­æˆ‘ä»¬ä» <code>out channel</code> è¯»å–æ•°å€¼è¯•å›¾æŠŠå€¼æ–­è¨€ <code>int</code> å¤±è´¥äº†ã€‚ é‚£ä¹ˆï¼Œå½“é˜Ÿåˆ—ä¸­æ²¡æœ‰æ•°æ®æ—¶ï¼Œæˆ‘ä»¬ä¸åº”è¯¥å†™å…¥ <code>out</code> é€šé“ã€‚</p>
<p><img src="https://image.syst.top/image/unlimited/unlimit-7.jpg" alt="image">
ä½œè€…ä½¿ç”¨äº†ä¸€ä¸ªæŠ€å·§ï¼Œå¦‚æœ <code>inQueue</code> æ²¡æœ‰æ•°æ®ï¼Œé‚£ä¹ˆå°è¯•å†™å…¥ä¸€ä¸ª <code>nil</code> é€šé“å°†æ°¸è¿œé˜»å¡ã€‚
é€šå¸¸ï¼Œæ°¸ä¹…é˜»å¡æ˜¯ä¸€ä¸ªä¸å¥½çš„è¡Œä¸ºï¼Œä½†æ˜¯è¿™ä¸ªæ˜¯åŒ…å«åœ¨ <code>select</code> è¯­å¥ä¸­çš„ï¼Œæ‰€ä»¥é—®é¢˜ä¸å¤§ã€‚</p>
<p><img src="https://image.syst.top/image/unlimited/unlimit-8.png" alt="image"></p>
<p>è¿˜æœ‰é—®é¢˜ã€‚åŸå› å¾ˆç®€å•ï¼Œæˆ‘ä»¬å†å‘é€å®Œæ•°æ®å°±é©¬ä¸Šå…³é—­äº† <code>in</code> é€šé“ã€‚éšå <code>break loop</code>ã€‚æ¥ä¸‹æ¥å…³é—­ <code>out</code> é€šé“ï¼Œç¨‹åºè¿è¡Œç»“æŸã€‚
æ­¤æ—¶ <code>inQueue</code> è¿˜æœ‰å€¼æœªè¢«å–å‡ºã€‚</p>
<p>åªè¦å†™æ¯”è¯»å¿«ï¼Œé‚£ä¹ˆå°±æ°¸è¿œå­˜åœ¨è¿™ä¸ªé—®é¢˜ã€‚æˆ‘ä»¬éœ€è¦ä¿è¯åœ¨é€šé“å…³é—­çš„æ—¶å€™ï¼Œ<code>inQueue</code> å·²ä¸ºç©ºã€‚
<img src="https://image.syst.top/image/unlimited/unlimit-9.jpg" alt="image"></p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>ä¸Šé¢æ˜¯å¦‚ä½•å®ç°ä¸€ä¸ªæ— é™ç¼“å†²çš„ <code>channel</code>ï¼Ÿ</p>
<p>å€ŸåŠ©äº†ä¸€ä¸ªä¸´æ—¶å­˜å‚¨æ•°æ®çš„ä¸­é—´å±‚ã€‚</p>
<p>ä¸Šé¢çš„å®ç°æœ‰æ²¡æœ‰å“ªäº›åœ°æ–¹å¯ä»¥æ”¹è¿›ï¼Ÿ</p>
<p><code>inQueue</code> ä½œä¸ºä¸­é—´å±‚ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªåˆ‡ç‰‡ã€‚æ˜æ˜ <code>inQueue</code> å·²ç»æ‰©å®¹åˆ°å¾ˆå¤§çš„å€¼äº†ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å¯¹åº”çš„ <code>reset</code>ã€‚ä¼šå¯¼è‡´ <code>inQueue</code> æŒ‡å‘è¿˜åœ¨åº•å±‚æ•°ç»„é åçš„ä½ç½®ï¼Œå¹¶ä¸èƒ½å¤ç”¨æ•°ç»„å‰é¢çš„ç©ºé—´ï¼Œé€ æˆæµªè´¹ã€‚</p>
<p><code>chanx</code> æ˜¯å’‹ä¹ˆæ”¹è¿›çš„ï¼Ÿ</p>
<p>ä¸‹ä¸€ç¯‡</p>
]]></content>
		</item>
		
		<item>
			<title>æ— é™ç¼“å†²çš„channel(2)</title>
			<link>https://www.syst.top/posts/go/unlimited-2/</link>
			<pubDate>Sun, 25 Apr 2021 22:25:52 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/unlimited-2/</guid>
			<description>chanx ä¸Šç¯‡æ–‡ç« æˆ‘ä»¬æåˆ°ï¼Œå½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæœ‰ç¼“å†²çš„é€šé“å¹¶æŒ‡å®šäº†å®¹é‡ï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªé€šé“çš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œæˆ‘ä»¬å°†å†ä¹Ÿæ— æ³•æ”¹å˜å®ƒçš„å®¹é‡ã€‚ ç”±æ­¤å¼•å‘äº†å…³äºæ— é™ç¼“å­˜çš„ channel è¯é¢˜è®¨è®ºã€‚ æˆ‘ä»¬åˆ†æäº†ä¸€ä¸ªå®ç°æ— é™ç¼“å†²çš„ä»£ç ã€‚ æœ€åï¼Œæˆ‘ä»¬ä¹Ÿæåˆ°äº†å®ƒè¿˜å¯ä»¥ç»§ç»­ä¼˜åŒ–çš„ç‚¹ã€‚
é¸Ÿçªçš„ chanx æ­£æ˜¯åŸºäºæ­¤æ–¹æ¡ˆæ”¹é€ è€Œæˆçš„ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä»–ä¿©çš„ä¸åŒä¹‹å¤„ã€‚
ä¸Šç¯‡æ–‡ç« è¯´è¿‡ï¼Œæ‰€è°“çš„æ— é™ç¼“å†²ï¼Œæ— éæ˜¯å€ŸåŠ©ä¸€ä¸ªä¸­é—´å±‚çš„æ•°æ®ç»“æ„ï¼Œæš‚å­˜ä¸´æ—¶æ•°æ®ã€‚
åœ¨ chanx ä¸­ï¼Œç»“æ„æ˜¯è¿™æ ·çš„:
type UnboundedChan struct { In chan&amp;lt;- T // channel for write 	Out &amp;lt;-chan T // channel for read 	buffer *RingBuffer // buffer } in å’Œ out çš„èŒè´£åœ¨ä¸Šç¯‡æ–‡ç« å·²ç»è¯´æ˜ï¼Œè¿™é‡Œçš„ buffer å°±æ˜¯æˆ‘ä»¬æ‰€è°“çš„ä¸­é—´ä¸´æ—¶å­˜å‚¨å±‚ã€‚å…¶ä¸­çš„ RingBuffer ç»“æ„æˆ‘ä»¬åé¢å†è¯´ã€‚
func NewUnboundedChan(initCapacity int) UnboundedChan { return NewUnboundedChanSize(initCapacity, initCapacity, initCapacity) } func NewUnboundedChanSize(initInCapacity, initOutCapacity, initBufCapacity int) UnboundedChan { in := make(chan T, initInCapacity) out := make(chan T, initOutCapacity) ch := UnboundedChan{In: in, Out: out, buffer: NewRingBuffer(initBufCapacity)} go process(in, out, ch) return ch } å®ƒæä¾›äº†ä¸¤ä¸ªåˆå§‹åŒ– UnboundedChan çš„æ–¹æ³•ï¼Œä»ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥æ˜æ˜¾çš„çœ‹å‡º,NewUnboundedChanSize å¯ä»¥ç»™æ¯ä¸ªå±æ€§è‡ªå®šä¹‰è‡ªå·±çš„å®¹é‡å¤§å°ã€‚ä»…æ­¤è€Œå·²ã€‚</description>
			<content type="html"><![CDATA[<h2 id="chanx">chanx</h2>
<p>ä¸Šç¯‡æ–‡ç« æˆ‘ä»¬æåˆ°ï¼Œå½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæœ‰ç¼“å†²çš„é€šé“å¹¶æŒ‡å®šäº†å®¹é‡ï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªé€šé“çš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œæˆ‘ä»¬å°†å†ä¹Ÿæ— æ³•æ”¹å˜å®ƒçš„å®¹é‡ã€‚ ç”±æ­¤å¼•å‘äº†å…³äºæ— é™ç¼“å­˜çš„ <code>channel</code> è¯é¢˜è®¨è®ºã€‚
æˆ‘ä»¬åˆ†æäº†ä¸€ä¸ªå®ç°æ— é™ç¼“å†²çš„ä»£ç ã€‚ æœ€åï¼Œæˆ‘ä»¬ä¹Ÿæåˆ°äº†å®ƒè¿˜å¯ä»¥ç»§ç»­ä¼˜åŒ–çš„ç‚¹ã€‚</p>
<p>é¸Ÿçªçš„ <code>chanx</code> æ­£æ˜¯åŸºäºæ­¤æ–¹æ¡ˆæ”¹é€ è€Œæˆçš„ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä»–ä¿©çš„ä¸åŒä¹‹å¤„ã€‚</p>
<p>ä¸Šç¯‡æ–‡ç« è¯´è¿‡ï¼Œæ‰€è°“çš„æ— é™ç¼“å†²ï¼Œæ— éæ˜¯å€ŸåŠ©ä¸€ä¸ªä¸­é—´å±‚çš„æ•°æ®ç»“æ„ï¼Œæš‚å­˜ä¸´æ—¶æ•°æ®ã€‚</p>
<p>åœ¨ <code>chanx</code> ä¸­ï¼Œç»“æ„æ˜¯è¿™æ ·çš„:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">UnboundedChan</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">In</span>     <span class="kd">chan</span><span class="o">&lt;-</span> <span class="nx">T</span>    <span class="c1">// channel for write
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Out</span>    <span class="o">&lt;-</span><span class="kd">chan</span> <span class="nx">T</span>    <span class="c1">// channel for read
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">buffer</span> <span class="o">*</span><span class="nx">RingBuffer</span> <span class="c1">// buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p><code>in</code> å’Œ <code>out</code> çš„èŒè´£åœ¨ä¸Šç¯‡æ–‡ç« å·²ç»è¯´æ˜ï¼Œè¿™é‡Œçš„ <code>buffer</code> å°±æ˜¯æˆ‘ä»¬æ‰€è°“çš„ä¸­é—´ä¸´æ—¶å­˜å‚¨å±‚ã€‚å…¶ä¸­çš„ <code>RingBuffer</code> ç»“æ„æˆ‘ä»¬åé¢å†è¯´ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewUnboundedChan</span><span class="p">(</span><span class="nx">initCapacity</span> <span class="kt">int</span><span class="p">)</span> <span class="nx">UnboundedChan</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">NewUnboundedChanSize</span><span class="p">(</span><span class="nx">initCapacity</span><span class="p">,</span> <span class="nx">initCapacity</span><span class="p">,</span> <span class="nx">initCapacity</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewUnboundedChanSize</span><span class="p">(</span><span class="nx">initInCapacity</span><span class="p">,</span> <span class="nx">initOutCapacity</span><span class="p">,</span> <span class="nx">initBufCapacity</span> <span class="kt">int</span><span class="p">)</span> <span class="nx">UnboundedChan</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">in</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">T</span><span class="p">,</span> <span class="nx">initInCapacity</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">out</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">T</span><span class="p">,</span> <span class="nx">initOutCapacity</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ch</span> <span class="o">:=</span> <span class="nx">UnboundedChan</span><span class="p">{</span><span class="nx">In</span><span class="p">:</span> <span class="nx">in</span><span class="p">,</span> <span class="nx">Out</span><span class="p">:</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">:</span> <span class="nf">NewRingBuffer</span><span class="p">(</span><span class="nx">initBufCapacity</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="nf">process</span><span class="p">(</span><span class="nx">in</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">ch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">ch</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å®ƒæä¾›äº†ä¸¤ä¸ªåˆå§‹åŒ– <code>UnboundedChan</code> çš„æ–¹æ³•ï¼Œä»ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥æ˜æ˜¾çš„çœ‹å‡º,<code>NewUnboundedChanSize</code> å¯ä»¥ç»™æ¯ä¸ªå±æ€§è‡ªå®šä¹‰è‡ªå·±çš„å®¹é‡å¤§å°ã€‚ä»…æ­¤è€Œå·²ã€‚</p>
<p><code>chanx</code> ä¸­ å…³äº <code>in</code> å’Œ <code>out</code> éƒ½æ˜¯å¸¦ç¼“å†²çš„é€šé“ï¼Œè€Œä¸Šç¯‡æ–‡ç« ä¸­çš„ <code>in</code> å’Œ <code>out</code> éƒ½æ˜¯æ— ç¼“å†²çš„é€šé“ã€‚
è¿™å’Œä»–ä»¬å¯¹æ•°æ®çš„æµè½¬å¤„ç†æœ‰å¾ˆå¤§å…³ç³»ã€‚</p>
<p>æˆ‘ä»¬æ¥ä¸‹å»çœ‹ <code>process(in,out,ch)</code> æœ€æ ¸å¿ƒçš„æ–¹æ³•ã€‚
<img src="https://image.syst.top/image/unlimited-2/unlimit-1.jpg" alt="image"></p>
<p>è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å†æ”¾ä¸Šä¸€ç¯‡æ ¸å¿ƒä»£ç ã€‚</p>
<p><img src="https://image.syst.top/image/unlimited/unlimit-7.jpg" alt="image"></p>
<p>å¯ä»¥å¾ˆæ˜æ˜¾ä»–ä»¬çœ‹å‡ºå®ƒä¿©çš„åŒºåˆ«ã€‚</p>
<p>ä¸Šç¯‡ä» <code>in</code> é€šé“è¯»æ•°æ®ä¼šå…ˆ <code>append</code> åˆ° <code>buffer</code>ï¼Œç„¶åä» <code>buffer</code> ä¸­å–æ•°æ®å†™å…¥ <code>out</code> é€šé“ã€‚
è€Œ <code>chanx</code> ä» <code>in</code> é€šé“å–å‡ºæ•°æ®å…ˆå°è¯•å†™å…¥ <code>out</code>(æ²¡æœ‰ä¸­é—´å•†èµšå·®ä»·?)ï¼Œåªæœ‰åœ¨ <code>out</code> å·²ç»æ»¡çš„æƒ…å†µä¸‹ï¼Œæ‰å¡å…¥åˆ° <code>buffer</code>ã€‚</p>
<p><code>chanx</code> è¿˜æœ‰ä¸€æ®µå°ç»†èŠ‚ä»£ç ã€‚
<img src="https://image.syst.top/image/unlimited-2/unlimit-2.jpg" alt="image"></p>
<p>èƒ½èµ°åˆ°è¿™é‡Œï¼Œä¸€å®šæ˜¯å› ä¸º <code>out</code> é€šé“æ»¡äº†ã€‚æˆ‘ä»¬æŠŠå€¼è¿½åŠ åˆ° <code>buffer</code> çš„åŒæ—¶ï¼Œéœ€è¦å°è¯•æŠŠ <code>buffer</code> ä¸­çš„æ•°æ®å†™å…¥ <code>out</code> ã€‚
æ­¤æ—¶ <code>in</code> é€šé“ä¹Ÿè®¸è¿˜åœ¨æŒç»­çš„å†™å…¥æ•°æ®ï¼Œ ä¸ºäº†é¿å… <code>in</code> é€šé“å¡æ»¡ï¼Œé˜»å¡ä¸šåŠ¡å†™å…¥ï¼Œæˆ‘ä»¬åŒæ—¶éœ€è¦å°è¯•ä» <code>in</code> é€šé“ä¸­è¯»æ•°æ®è¿½åŠ åˆ° <code>buffer</code>ã€‚</p>
<h2 id="buffer">buffer</h2>
<p>ä¸Šç¯‡æ–‡ç« æˆ‘æåˆ°äº†å…³äº <code>buffer</code> ä¼˜åŒ–çš„ç‚¹ã€‚</p>
<p><code>chanx</code> æ˜¯å¦‚ä½•ä¼˜åŒ–çš„?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// type T interface{}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">RingBuffer</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">buf</span>         <span class="p">[]</span><span class="nx">T</span> 
</span></span><span class="line"><span class="cl">	<span class="nx">initialSize</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">	<span class="nx">size</span>        <span class="kt">int</span>
</span></span><span class="line"><span class="cl">	<span class="nx">r</span>           <span class="kt">int</span> <span class="c1">// read pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">w</span>           <span class="kt">int</span> <span class="c1">// write pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>è¿™æ˜¯ <code>buffer</code> çš„ç»“æ„ï¼Œå…¶ä¸­</p>
<ul>
<li><code>buf</code> å…·ä½“å­˜å‚¨æ•°æ®çš„ç»“æ„ã€‚</li>
<li><code>initialSize</code> åˆå§‹åŒ–åŒ– <code>buf</code> çš„é•¿åº¦</li>
<li><code>size</code> å½“å‰ <code>buf</code> çš„é•¿åº¦</li>
<li><code>r</code> å½“å‰è¯»æ•°æ®ä½ç½®</li>
<li><code>w</code> å½“å‰å†™å…¥æ•°æ®ä½ç½®</li>
</ul>
<p><code>buffer</code> æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªç¯å½¢çš„é˜Ÿåˆ—ï¼Œç›®çš„æ˜¯è¾¾åˆ°èµ„æºçš„å¤ç”¨ã€‚
å¹¶ä¸”å½“ <code>buffer</code> æ»¡æ—¶ï¼Œæä¾›è‡ªåŠ¨æ‰©å®¹çš„åŠŸèƒ½ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹å…·ä½“æŠŠæ•°æ®å†™å…¥ <code>buffer</code> çš„æºç ã€‚
<img src="https://image.syst.top/image/unlimited-2/unlimit-3.png" alt="image"></p>
<p>æ¥ç€çœ‹æ‰©å®¹ã€‚
<img src="https://image.syst.top/image/unlimited-2/unlimit-4.png" alt="image"></p>
<p>è¿™æ®µä»£ç å”¯ä¸€éš¾ç†è§£çš„å°±æ˜¯æ•°æ®è¿ç§»äº†ã€‚è¿™é‡Œçš„æ•°æ®è¿ç§»ç›®çš„æ˜¯ä¸ºäº†ä¿è¯å…ˆå…¥å…ˆå‡ºçš„åŸåˆ™ã€‚</p>
<p>å¯èƒ½åŠ äº†æ³¨é‡Šæœ‰äº›äººä¹Ÿæ— æ³•ç†è§£ï¼Œé‚£ä¹ˆå°±å†åŠ ä¸€ä¸ªè‰ç‡å›¾ã€‚</p>
<p>å‡è®¾æˆ‘ä»¬ <code>buffer</code> çš„é•¿åº¦æ˜¯ 8ã€‚ å½“å‰è¯»å’Œå†™çš„ <code>index</code> éƒ½æ˜¯5ã€‚è¯´æ˜ <code>buffer</code> æ»¡äº†ï¼Œè§¦å‘è‡ªåŠ¨æ‰©å®¹è§„åˆ™ï¼Œè¿›è¡Œæ•°æ®è¿ç§»ã€‚</p>
<p>é‚£ä¹ˆè¿ç§»çš„è¿‡ç¨‹å°±æ˜¯ä¸‹å›¾è¿™æ ·çš„ã€‚</p>
<p><img src="https://image.syst.top/image/unlimited-2/unlimit-5.png" alt="image"></p>
<p>è¿˜æœ‰ï¼Œå½“ <code>buffer</code> ä¸ºç©ºå¹¶ä¸”å½“å‰çš„ <code>size</code> æ¯”åˆå§‹åŒ– <code>size</code> è¿˜å¤§ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘é‡ç½® <code>buffer</code> äº†ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//if ch.buffer.IsEmpty() &amp;&amp; ch.buffer.size &gt; ch.buffer.initialSize { 
</span></span></span><span class="line"><span class="cl"><span class="c1">//						ch.buffer.Reset()
</span></span></span><span class="line"><span class="cl"><span class="c1">//					}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">RingBuffer</span><span class="p">)</span> <span class="nf">Reset</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nx">r</span><span class="p">.</span><span class="nx">r</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nx">r</span><span class="p">.</span><span class="nx">w</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nx">r</span><span class="p">.</span><span class="nx">size</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">initialSize</span>
</span></span><span class="line"><span class="cl"><span class="nx">r</span><span class="p">.</span><span class="nx">buf</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">T</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">initialSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å‰©ä¸‹çš„ä»£ç ,å°±æ²¡ä»€ä¹ˆå¥½è¯´çš„äº†ã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>ç»§ä¸Šç¯‡æ–‡ç« åï¼Œè¿™ç¯‡æ–‡ç« æˆ‘ä»¬ä¸»è¦è®²è§£äº† <code>chanx</code> æ˜¯å¦‚ä½•å®ç°æ— é™ç¼“å†²çš„ <code>channel</code>ã€‚
å…¶ä¸­æœ€é‡è¦çš„ä¸€ä¸ªç‚¹åœ¨äº <code>chanx</code> ä¸­ <code>buffer</code> å®ç°é‡‡ç”¨çš„æ˜¯ <code>ringbuffer</code>ï¼Œè¾¾åˆ°èµ„æºå¤ç”¨çš„åŒæ—¶è¿˜èƒ½è‡ªåŠ¨æ‰©å®¹ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>hystrix-goä½¿ç”¨ä¸åŸç†(äºŒ)</title>
			<link>https://www.syst.top/posts/go/hystrix-go%E4%BA%8C/</link>
			<pubDate>Wed, 21 Apr 2021 23:54:52 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/hystrix-go%E4%BA%8C/</guid>
			<description>å¼€ç¯‡ ä¸Šç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº† hystrix-go çš„ä½¿ç”¨ä»¥åŠåŸç†ï¼Œè¿™ç¯‡æ–‡ç« è®©æˆ‘ä»¬å…¨é¢çš„è§£ææºç ã€‚æœ¬æ–‡å¾ˆé•¿ï¼Œè¯·è€å¿ƒçœ‹å®Œã€‚å¦å¤–ï¼Œç”±äºç›´æ¥æ”¾æºç å¾ˆæ˜¯å½±å“æ‰‹æœºé˜…è¯»ä½“éªŒï¼Œæˆ‘æŠŠæºç éƒ½æˆªæˆå›¾ç‰‡äº†ã€‚
è¿˜æ˜¯ä¸Šç¯‡çš„ä¾‹å­
å¤§éƒ¨åˆ†æ–‡ç« åªæ˜¯è¯´æ˜æ¯ä¸ªæ¨¡å—çš„èŒè´£å’ŒåŠŸèƒ½ï¼Œè€ƒè™‘åˆ°å¦‚æœåªæ˜¯å•çº¯è¯´æ˜ï¼Œè¯»è€…è¿˜æ˜¯å¾ˆéš¾æŠŠæ•´ä½“çš„æµç¨‹è¿æ¥èµ·æ¥ã€‚å› æ­¤æˆ‘æ‰“ç®—ä»è¿™ä¸ªä¾‹å­ä¸€æ­¥æ­¥è§£æã€‚ å°±ç›´æ¥ä»å¼€å¤´ hystrix.ConfigureCommand å¼€å§‹å§ã€‚ ä¸Šç¯‡æ–‡ç« æè¿‡ï¼Œè¿™ä¸ªæ“ä½œä¸»è¦æ˜¯ä¸ºæ¯ä¸ª commandName è‡ªå®šä¹‰è‡ªå·±çš„è§„åˆ™é…ç½®ã€‚å¦‚æœæœªè‡ªå®šä¹‰ï¼Œé‚£ä¹ˆä¼šä½¿ç”¨é»˜è®¤å€¼ã€‚ æœ€ç»ˆä¼šæŠŠé…ç½®å€¼å­˜å‚¨åœ¨ circuitSettings è¿™ä¸ª mapç±»å‹ä¸­ï¼Œå®ƒçš„åˆå§‹åŒ–æ“ä½œæ˜¯åœ¨ init()æ‰§è¡Œçš„ã€‚ æ¥ä¸‹æ¥æ‰§è¡Œ hystrix.Doï¼Œ	Do æ˜¯ä¸€ä¸ªåŒæ­¥çš„æ“ä½œï¼Œå®ƒä¼šé˜»å¡ç­‰å¾…ï¼Œç›´åˆ°æ‰§è¡Œå‡½æ•°ç»“æŸæˆ–è€…ç†”æ–­å™¨è¿”å›é”™è¯¯ï¼Œå¦‚:æ–­è·¯å™¨å¼€å¯ã€è¶…å‡ºæœ€å¤§å¹¶å‘æ•°ã€‚ æ­¤å‡½æ•°éœ€è¦ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤º commandName çš„åç§°ï¼Œç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯æ­£å¸¸çš„ä¸šåŠ¡çš„åŒ¿åå‡½æ•°ï¼Œæ¯”å¦‚åœ¨å‡½æ•°ä¸­è¿›è¡Œå¤–éƒ¨æœåŠ¡è°ƒç”¨ã€‚å¦‚æœè°ƒç”¨å¤±è´¥ï¼Œé‚£ä¹ˆå°±ä¼šæ‰§è¡Œç¬¬ä¸‰ä¸ªå‚æ•°çš„æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥ç§°ä¹‹ä¸ºä¿åº•æ“ä½œï¼Œå½“ç†”æ–­å™¨å¼€å¯çš„æ—¶å€™ï¼Œç³»ç»Ÿä¹Ÿæ˜¯ä¼šç›´æ¥è°ƒç”¨æ­¤å‡½æ•°ã€‚è¿™ä¸¤ä¸ªå‚æ•°çš„ç±»å‹åˆ†åˆ«æ˜¯åŒ¿åå‡½æ•°å’Œé—­åŒ…å‡½æ•°ã€‚ ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼ŒDo å‡½æ•°åªæ˜¯æŠŠä¼ å…¥çš„åä¸¤ä¸ªå‚æ•°è¿›ä¸€æ­¥å°è£…æˆå‡½æ•°ã€‚ç„¶åè°ƒç”¨ DoCã€‚
Doc å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸Šä¸‹æ–‡ context.Contextã€‚context.Context ä¸€èˆ¬å‡ºç°åœ¨ä¸åŒ Goroutine ä¹‹é—´åŒæ­¥æŒ‡å®šæ•°æ®ã€‚å¦‚æœä½ ä½¿ç”¨è¿‡ gin æ¡†æ¶ï¼Œç»å¸¸å’Œå®ƒæ‰“äº¤é“ã€‚
ç¬¬ä¸‰å’Œç¬¬å››çš„å‚æ•°å³ Do ä¸­è¿›ä¸€æ­¥åŒ…è£…çš„ä¸¤ä¸ªé—­åŒ…å‡½æ•°ã€‚æ‰€è°“é—­åŒ…ï¼Œæˆ‘çš„ç†è§£æ˜¯:å­˜åœ¨è‡ªç”±çš„å˜é‡ã€‚è¿™ä¸ªè‡ªç”±çš„å˜é‡å–å†³äºè¿è¡Œé—­åŒ…å‡½æ•°æ—¶çš„ç¯å¢ƒï¼Œåœ¨ DoCä¸­, runFunc å’Œ fallbackFuncC ç±»å‹ ä¹Ÿå°±æ˜¯è¯´è¿™ä¸¤ä¸ªé—­åŒ…çš„è‡ªç”±å˜é‡æ˜¯ context.Contextã€‚
Docå‡½æ•°ä¸­ å˜é‡ r å’Œ f ä¸å†è§£é‡Šã€‚ç”±äºæˆ‘ä»¬åœ¨è°ƒç”¨ Doå‡½æ•°æ—¶ä¼ é€’äº†ç¬¬ä¸‰ä¸ªå‚æ•°,å› æ­¤æ‰§è¡Œ errChan = GoC(ctx, name, r, f)ã€‚æœ€ä¸‹é¢ä½¿ç”¨select å¯ä»¥ç›‘æ§å¤š channelã€‚å½“æŸä¸ª channel æœ‰æ•°æ®æ—¶ï¼Œä»å…¶ä¸­è¯»å–ã€‚æˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹ GoCã€‚
Gocæ˜¯æ ¸å¿ƒä»£ç å—ã€‚å®ƒæ˜¯çœŸæ­£æ‰§è¡Œä½ çš„æ ¸å¿ƒä¸šåŠ¡å‡½æ•°çš„åœ°æ–¹ã€‚æˆ‘å…ˆå¤§ä½“ä»‹ç»ä¸€äº›è¿™ä¸ªå‡½æ•°æ ¸å¿ƒåŠŸèƒ½ã€‚ å®ƒä¼šå…ˆå»éªŒè¯ä¸€äº›è§„åˆ™ï¼Œæ¯”å¦‚åˆ¤æ–­ç†”æ–­å™¨æ˜¯å¦å¼€å¯ï¼Œå†³å®šå½“å‰æ˜¯å¦å¯ä»¥æ‰§è¡Œä½ çš„ä¸šåŠ¡ã€‚åˆ¤æ–­æ˜¯å¦å¯ä»¥è·å–è®¿é—®ä»¤ç‰Œã€‚å¦‚æœå¯ä»¥ï¼Œæ‰§è¡Œä½ çš„ä¸šåŠ¡é€»è¾‘ï¼ŒæˆåŠŸäº†ä¸ŠæŠ¥æˆåŠŸçš„çŠ¶æ€ï¼Œå¤±è´¥äº†ï¼Œé™¤äº†ä¸ŠæŠ¥çŠ¶æ€ï¼Œå¦‚æœä¼ å…¥äº†å¼‚å¸¸å¤„ç†çš„å‡½æ•°ï¼Œé‚£ä¹ˆæ‰§è¡Œå¼‚å¸¸å¤„ç†çš„å‡½æ•°ã€‚å¦å¤–è¿˜æœ‰ä¸€äº›å½’è¿˜ä»¤ç‰Œç­‰æ“ä½œã€‚æˆ‘ä»¬æ¥çœ‹ä»£ç ã€‚ è¿™æ®µä»£ç å°±ä¸è§£é‡Šäº†å§ã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥æ¥çœ‹çœ‹ command ç»“æ„ä½“ä¸­è¿˜æœ‰å•¥å‚æ•°ã€‚ command é‡Œé¢ï¼Œå…³é”®çš„ä¸¤ä¸ªå­—æ®µæ˜¯ events å’Œ circuitã€‚å…¶å® events ä¸»è¦æ˜¯å­˜å‚¨äº‹ä»¶ç±»å‹ä¿¡æ¯ï¼Œæ¯”å¦‚æ‰§è¡ŒæˆåŠŸçš„ successï¼Œæˆ–è€…å¤±è´¥çš„ timeoutã€context_canceled ç­‰ã€‚ circuit æ˜¯æŒ‡é’ˆç±»å‹ CircuitBreaker, CircuitBreakerå°±æ˜¯çœŸæ­£çš„ç†”æ–­å™¨ ã€‚command ä¸»è¦æ˜¯è®°å½•å•ä¸ªæ‰§è¡Œçš„çŠ¶æ€ä»¥åŠå’Œç†”æ–­å™¨è¿›è¡Œä¸€äº›è¿è¡Œäº¤äº’ã€‚äº¤äº’ä»€ä¹ˆ?</description>
			<content type="html"><![CDATA[<h3 id="å¼€ç¯‡">å¼€ç¯‡</h3>
<p>ä¸Šç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº† <code>hystrix-go</code> çš„ä½¿ç”¨ä»¥åŠåŸç†ï¼Œè¿™ç¯‡æ–‡ç« è®©æˆ‘ä»¬å…¨é¢çš„è§£ææºç ã€‚æœ¬æ–‡å¾ˆé•¿ï¼Œè¯·è€å¿ƒçœ‹å®Œã€‚å¦å¤–ï¼Œç”±äºç›´æ¥æ”¾æºç å¾ˆæ˜¯å½±å“æ‰‹æœºé˜…è¯»ä½“éªŒï¼Œæˆ‘æŠŠæºç éƒ½æˆªæˆå›¾ç‰‡äº†ã€‚</p>
<p>è¿˜æ˜¯ä¸Šç¯‡çš„ä¾‹å­</p>
<p><img src="https://cdn.learnku.com/uploads/images/202012/29/26855/kfaOfFI9ez.png!large" alt="">
å¤§éƒ¨åˆ†æ–‡ç« åªæ˜¯è¯´æ˜æ¯ä¸ªæ¨¡å—çš„èŒè´£å’ŒåŠŸèƒ½ï¼Œè€ƒè™‘åˆ°å¦‚æœåªæ˜¯å•çº¯è¯´æ˜ï¼Œè¯»è€…è¿˜æ˜¯å¾ˆéš¾æŠŠæ•´ä½“çš„æµç¨‹è¿æ¥èµ·æ¥ã€‚å› æ­¤æˆ‘æ‰“ç®—ä»è¿™ä¸ªä¾‹å­ä¸€æ­¥æ­¥è§£æã€‚
å°±ç›´æ¥ä»å¼€å¤´ <code>hystrix.ConfigureCommand</code> å¼€å§‹å§ã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/29/26855/Twv8QvPbyR.png!large" alt=""></p>
<p>ä¸Šç¯‡æ–‡ç« æè¿‡ï¼Œè¿™ä¸ªæ“ä½œä¸»è¦æ˜¯ä¸ºæ¯ä¸ª <code>commandName</code> è‡ªå®šä¹‰è‡ªå·±çš„è§„åˆ™é…ç½®ã€‚å¦‚æœæœªè‡ªå®šä¹‰ï¼Œé‚£ä¹ˆä¼šä½¿ç”¨é»˜è®¤å€¼ã€‚ æœ€ç»ˆä¼šæŠŠé…ç½®å€¼å­˜å‚¨åœ¨ <code>circuitSettings</code> è¿™ä¸ª <code>map</code>ç±»å‹ä¸­ï¼Œå®ƒçš„åˆå§‹åŒ–æ“ä½œæ˜¯åœ¨ <code>init()</code>æ‰§è¡Œçš„ã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/29/26855/4j1xoqVqzB.png!large" alt="">
æ¥ä¸‹æ¥æ‰§è¡Œ <code>hystrix.Do</code>ï¼Œ	<code>Do</code> æ˜¯ä¸€ä¸ªåŒæ­¥çš„æ“ä½œï¼Œå®ƒä¼šé˜»å¡ç­‰å¾…ï¼Œç›´åˆ°æ‰§è¡Œå‡½æ•°ç»“æŸæˆ–è€…ç†”æ–­å™¨è¿”å›é”™è¯¯ï¼Œå¦‚:æ–­è·¯å™¨å¼€å¯ã€è¶…å‡ºæœ€å¤§å¹¶å‘æ•°ã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/29/26855/ENUcELdfsT.png!large" alt="">
æ­¤å‡½æ•°éœ€è¦ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤º <code>commandName</code> çš„åç§°ï¼Œç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯æ­£å¸¸çš„ä¸šåŠ¡çš„åŒ¿åå‡½æ•°ï¼Œæ¯”å¦‚åœ¨å‡½æ•°ä¸­è¿›è¡Œå¤–éƒ¨æœåŠ¡è°ƒç”¨ã€‚å¦‚æœè°ƒç”¨å¤±è´¥ï¼Œé‚£ä¹ˆå°±ä¼šæ‰§è¡Œç¬¬ä¸‰ä¸ªå‚æ•°çš„æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥ç§°ä¹‹ä¸ºä¿åº•æ“ä½œï¼Œå½“ç†”æ–­å™¨å¼€å¯çš„æ—¶å€™ï¼Œç³»ç»Ÿä¹Ÿæ˜¯ä¼šç›´æ¥è°ƒç”¨æ­¤å‡½æ•°ã€‚è¿™ä¸¤ä¸ªå‚æ•°çš„ç±»å‹åˆ†åˆ«æ˜¯åŒ¿åå‡½æ•°å’Œé—­åŒ…å‡½æ•°ã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/29/26855/Vn1Yot5vsx.png!large" alt="">
ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œ<code>Do</code> å‡½æ•°åªæ˜¯æŠŠä¼ å…¥çš„åä¸¤ä¸ªå‚æ•°è¿›ä¸€æ­¥å°è£…æˆå‡½æ•°ã€‚ç„¶åè°ƒç”¨ <code>DoC</code>ã€‚</p>
<p><img src="https://cdn.learnku.com/uploads/images/202012/29/26855/eJ89Y8YEHw.png!large" alt=""></p>
<p><code>Doc</code> å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸Šä¸‹æ–‡ <code>context.Context</code>ã€‚<code>context.Context</code> ä¸€èˆ¬å‡ºç°åœ¨ä¸åŒ <code>Goroutine</code> ä¹‹é—´åŒæ­¥æŒ‡å®šæ•°æ®ã€‚å¦‚æœä½ ä½¿ç”¨è¿‡ <code>gin</code> æ¡†æ¶ï¼Œç»å¸¸å’Œå®ƒæ‰“äº¤é“ã€‚</p>
<p>ç¬¬ä¸‰å’Œç¬¬å››çš„å‚æ•°å³ <code>Do</code> ä¸­è¿›ä¸€æ­¥åŒ…è£…çš„ä¸¤ä¸ªé—­åŒ…å‡½æ•°ã€‚æ‰€è°“é—­åŒ…ï¼Œæˆ‘çš„ç†è§£æ˜¯:å­˜åœ¨è‡ªç”±çš„å˜é‡ã€‚è¿™ä¸ªè‡ªç”±çš„å˜é‡å–å†³äºè¿è¡Œé—­åŒ…å‡½æ•°æ—¶çš„ç¯å¢ƒï¼Œåœ¨ <code>DoC</code>ä¸­,<code> runFunc</code> å’Œ <code>fallbackFuncC</code> ç±»å‹
<img src="https://cdn.learnku.com/uploads/images/202012/29/26855/12x0zgb6ll.png!large" alt="hystrix-go æºç è§£æ">
ä¹Ÿå°±æ˜¯è¯´è¿™ä¸¤ä¸ªé—­åŒ…çš„è‡ªç”±å˜é‡æ˜¯ <code>context.Context</code>ã€‚</p>
<p><code>Doc</code>å‡½æ•°ä¸­ å˜é‡ <code>r</code> å’Œ <code>f</code> ä¸å†è§£é‡Šã€‚ç”±äºæˆ‘ä»¬åœ¨è°ƒç”¨ <code>Do</code>å‡½æ•°æ—¶ä¼ é€’äº†ç¬¬ä¸‰ä¸ªå‚æ•°,å› æ­¤æ‰§è¡Œ <code>errChan = GoC(ctx, name, r, f)</code>ã€‚æœ€ä¸‹é¢ä½¿ç”¨<code>select</code> å¯ä»¥ç›‘æ§å¤š <code>channel</code>ã€‚å½“æŸä¸ª  <code>channel</code> æœ‰æ•°æ®æ—¶ï¼Œä»å…¶ä¸­è¯»å–ã€‚æˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹ <code>GoC</code>ã€‚</p>
<p><code>Goc</code>æ˜¯æ ¸å¿ƒä»£ç å—ã€‚å®ƒæ˜¯çœŸæ­£æ‰§è¡Œä½ çš„æ ¸å¿ƒä¸šåŠ¡å‡½æ•°çš„åœ°æ–¹ã€‚æˆ‘å…ˆå¤§ä½“ä»‹ç»ä¸€äº›è¿™ä¸ªå‡½æ•°æ ¸å¿ƒåŠŸèƒ½ã€‚
å®ƒä¼šå…ˆå»éªŒè¯ä¸€äº›è§„åˆ™ï¼Œæ¯”å¦‚åˆ¤æ–­ç†”æ–­å™¨æ˜¯å¦å¼€å¯ï¼Œå†³å®šå½“å‰æ˜¯å¦å¯ä»¥æ‰§è¡Œä½ çš„ä¸šåŠ¡ã€‚åˆ¤æ–­æ˜¯å¦å¯ä»¥è·å–è®¿é—®ä»¤ç‰Œã€‚å¦‚æœå¯ä»¥ï¼Œæ‰§è¡Œä½ çš„ä¸šåŠ¡é€»è¾‘ï¼ŒæˆåŠŸäº†ä¸ŠæŠ¥æˆåŠŸçš„çŠ¶æ€ï¼Œå¤±è´¥äº†ï¼Œé™¤äº†ä¸ŠæŠ¥çŠ¶æ€ï¼Œå¦‚æœä¼ å…¥äº†å¼‚å¸¸å¤„ç†çš„å‡½æ•°ï¼Œé‚£ä¹ˆæ‰§è¡Œå¼‚å¸¸å¤„ç†çš„å‡½æ•°ã€‚å¦å¤–è¿˜æœ‰ä¸€äº›å½’è¿˜ä»¤ç‰Œç­‰æ“ä½œã€‚æˆ‘ä»¬æ¥çœ‹ä»£ç ã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/29/26855/2zG2xABgMO.png!large" alt="">
è¿™æ®µä»£ç å°±ä¸è§£é‡Šäº†å§ã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥æ¥çœ‹çœ‹ <code>command</code> ç»“æ„ä½“ä¸­è¿˜æœ‰å•¥å‚æ•°ã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/29/26855/fpbWU6cyKp.png!large" alt="">
<code>command</code> é‡Œé¢ï¼Œå…³é”®çš„ä¸¤ä¸ªå­—æ®µæ˜¯ <code>events</code> å’Œ <code>circuit</code>ã€‚å…¶å® <code>events</code> ä¸»è¦æ˜¯å­˜å‚¨äº‹ä»¶ç±»å‹ä¿¡æ¯ï¼Œæ¯”å¦‚æ‰§è¡ŒæˆåŠŸçš„ <code>success</code>ï¼Œæˆ–è€…å¤±è´¥çš„ <code>timeout</code>ã€<code>context_canceled</code> ç­‰ã€‚ circuit æ˜¯æŒ‡é’ˆç±»å‹ <code>CircuitBreaker</code>, <code>CircuitBreaker</code>å°±æ˜¯çœŸæ­£çš„ç†”æ–­å™¨ ã€‚<code>command</code> ä¸»è¦æ˜¯è®°å½•å•ä¸ªæ‰§è¡Œçš„çŠ¶æ€ä»¥åŠå’Œç†”æ–­å™¨è¿›è¡Œä¸€äº›è¿è¡Œäº¤äº’ã€‚äº¤äº’ä»€ä¹ˆ? ä¸»è¦å‘ <code>CircuitBreaker</code> ä¸ŠæŠ¥æ‰§è¡ŒçŠ¶æ€äº‹ä»¶ã€‚</p>
<p>æ¥ä¸‹æ¥çœ‹ä¸‹é¢çš„ä»£ç 
<img src="https://cdn.learnku.com/uploads/images/202012/29/26855/vwYVVDHUsQ.png!large" alt="">
<code>GetCircuit(name)</code>ï¼Œä»å‡½æ•°åå°±çŸ¥é“æ˜¯é€šè¿‡åç§°è·å–ä¸€ä¸ªç†”æ–­å™¨ã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/30/26855/fgMesgzwlm.png!large" alt="">
è¿™ä¸ªå‡½æ•°ä»£ç å¾ˆæ¸…æ™°ï¼Œå¦‚æœæ²¡æœ‰ä» <code>circuitBreakers</code>ä¸­æŸ¥è¯¢åˆ°å¯¹åº”çš„ <code>CircuitBreaker</code>ï¼Œé‚£ä¹ˆå°±åˆ›å»ºä¸€ä¸ªã€‚</p>
<p>è¿™é‡Œçš„ä»£ç æœ‰ç‚¹å°ç»†èŠ‚ã€‚é¦–å…ˆ <code>circuitBreakers</code>æ˜¯ <code>map</code> ç±»å‹ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ <code>map</code> å¹¶ä¸æ˜¯å¹¶å‘å®‰å…¨çš„ã€‚æ‰€ä»¥åœ¨æŸ¥æ‰¾çš„çš„æ—¶å€™åŠ äº†è¯»é”ã€‚å¦‚æœæ²¡æ‰¾åˆ°å€¼ï¼Œé‚£ä¹ˆè§£é™¤è¯»é”ã€‚å°è¯•è·å–å†™é”ï¼Œæˆ‘ä»¬åœ¨å†™é”é‡Œé¢ï¼Œåˆè¿›ä¸€æ­¥ç¡®è®¤æ˜¯å¦å­˜åœ¨<code>circuitBreakers</code>ï¼Œä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·æ“ä½œ? è¿™æ˜¯å› ä¸ºåœ¨æˆ‘ä»¬é‡Šæ”¾è¯»é”åˆ°è·å–å†™é”è¿‡ç¨‹ä¸­æœ‰å¯èƒ½å­˜åœ¨å…¶ä»–çš„ <code>Goroutine</code> æŠ¢å…ˆä¸€æ­¥åˆ›å»ºã€‚æ‰€ä»¥è¿™é‡Œéœ€è¦è¿›ä¸€æ­¥ç¡®è®¤ï¼Œæ­¤æ—¶ä¸å­˜åœ¨ï¼Œé‚£å°±çœŸçš„ä¸å­˜åœ¨ï¼Œé€šè¿‡ <code>name</code> ç”Ÿæˆä¸€ä¸ª <code>circuitBreakers</code>ã€‚å…·ä½“çœ‹ä¸‹ <code>newCircuitBreaker(name)</code> å‡½æ•°ã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/30/26855/aWyPBGteD6.png!large" alt="">
ä¸»è¦æ˜¯åˆå§‹åŒ–åˆ›å»ºä¸€ä¸ªç†”æ–­å™¨ <code>CircuitBreaker</code>æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹ <code>CircuitBreaker</code> éƒ½æœ‰å“ªäº›å­—æ®µã€‚</p>
<p><img src="https://cdn.learnku.com/uploads/images/202012/30/26855/frqN8a2tWj.png!large" alt="ä¸€æ–‡è¯»æ‡‚ hystrix-go æºç ">
ä¸»è¦è¯´æ˜å‡ ä¸ªå­—æ®µï¼Œ<code>open</code> è¡¨ç¤ºå½“å‰ç†”æ–­å™¨æ˜¯å¦å¼€å¯ï¼Œ<code>executorPool</code> æ˜¯æµé‡æ§åˆ¶ä¸­å¿ƒï¼Œæ‰€æœ‰çš„è¯·æ±‚éƒ½éœ€è¦å…ˆè·å–åˆ°ä»¤ç‰Œã€‚<code>metrics</code> çš„ç±»å‹æ˜¯ <code>*metricExchange</code>,å¯ä»¥çœ‹æˆæ˜¯ä¸ŠæŠ¥æ‰§è¡ŒçŠ¶æ€äº‹ä»¶çš„è½½ä½“ã€‚é€šè¿‡å®ƒæŠŠæ‰§è¡ŒçŠ¶æ€ä¿¡æ¯å­˜å‚¨åˆ°å®é™…ç†”æ–­å™¨æ‰§è¡Œå„ä¸ªç»´åº¦çŠ¶æ€(æˆåŠŸæ¬¡æ•°ï¼Œå¤±è´¥æ¬¡æ•°ï¼Œè¶…æ—¶&hellip;&hellip;)çš„æ•°æ®é›†åˆä¸­ã€‚</p>
<p><code>newCircuitBreaker(name)</code> åˆå§‹åŒ–çš„åŒæ—¶ä¹Ÿåˆå§‹åŒ–äº† <code>executorPool</code> å’Œ <code>metrics</code>ã€‚</p>
<p>å…ˆçœ‹ <code>newMetricExchange(name)</code>ã€‚çœ‹çœ‹å®ƒ <code>metricExchange</code> ç»“æ„
<img src="https://cdn.learnku.com/uploads/images/202012/30/26855/VkJb7VQ41k.png!large" alt="">
<code>Updates</code> æ˜¯ä¸€ä¸ª <code>channel</code> ç±»å‹ï¼Œé€šè¿‡ <code>Updates</code> ä¸ŠæŠ¥æ‰§è¡Œäº‹ä»¶é›†åˆã€‚<code>metricCollectors</code> å­˜å‚¨çš„æ˜¯ <code>metricCollector.MetricCollector</code> åˆ‡ç‰‡ï¼Œè€Œ <code>metricCollector.MetricCollector</code> æ˜¯ä¸€ä¸ªæ¥å£ç±»å‹ã€‚</p>
<p><img src="https://cdn.learnku.com/uploads/images/202012/30/26855/36K9RaCfiC.png!large" alt="ä¸€æ–‡è¯»æ‡‚ hystrix-go æºç "></p>
<p><code>newMetricExchange(name)</code> ä¸­ï¼Œ
<img src="https://cdn.learnku.com/uploads/images/202012/30/26855/QMt69SGi7l.png!large" alt="">
å¯ä»¥çœ‹åˆ°ï¼Œåˆå§‹åŒ– <code>Updates</code> é€šé“çš„çš„å®¹é‡æ˜¯ <code>2000</code>ã€‚åˆå§‹åŒ– <code>metricCollectors</code> ä¸»è¦é€»è¾‘åœ¨ <code>InitializeMetricCollectors</code>ã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/30/26855/2J1yday7lA.png!large" alt="">
å…³é”®çš„åœ°æ–¹æˆ‘æ ‡æ˜äº†ã€‚å†çœ‹çœ‹ <code>newDefaultMetricCollector</code>
<img src="https://cdn.learnku.com/uploads/images/202012/30/26855/JWj5RbQxEf.png!large" alt="">
æ­¤å‡½æ•°è¿”å›ä¸€ä¸ª <code>MetricCollector</code> ç±»å‹ï¼Œç»“æ„ä½“ <code>DefaultMetricCollector</code> å®ç°äº† <code>MetricCollector</code> æ‰€æœ‰æ–¹æ³•ã€‚å†çœ‹çœ‹ <code>DefaultMetricCollector</code>ï¼Œä¸æ­£æ˜¯å­˜å‚¨ç†”æ–­å™¨æ‰§è¡ŒçŠ¶æ€æ‰€æœ‰ä¿¡æ¯å˜›ã€‚çœ‹çœ‹æŒ‡é’ˆç±»å‹ <code>rolling.Number</code>ï¼š
<img src="https://cdn.learnku.com/uploads/images/202012/30/26855/MEeJ15Zk69.png!large" alt="">
<code>rolling.Number</code> æ˜¯çœŸæ­£å­˜å‚¨å„ä¸ªæ‰§è¡Œäº‹ä»¶çŠ¶æ€ä¿¡æ¯çš„åº•å±‚å­˜å‚¨ç»“æ„ã€‚å®ƒæ˜¯å¦‚ä½•åªä¿å­˜ <code>10</code> ç§’å†…çš„ä¿¡æ¯çš„ã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/30/26855/vkVXeOEHOe.png!large" alt="">
æƒŠä¸æƒŠå–œï¼Ÿ
<code>newMetricExchange(name)</code> è¿˜æœ‰ä¸€ä¸ªç»†èŠ‚ï¼Œä¼šå•ç‹¬å¼€å¯ä¸€ä¸ª <code>g</code> è¿è¡Œ  <code>go m.Monitor()</code>  å»æ¥æ”¶ <code>channel</code> ç±»å‹çš„ <code>Updates</code> ä¿¡æ¯ï¼Œå³æ‰§è¡Œäº‹ä»¶çŠ¶æ€ä¿¡æ¯ã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/30/26855/oNJhRa2nEr.png!large" alt="">
åœ¨æ¥æ”¶åˆ°äº‹ä»¶ä¿¡æ¯åï¼Œè°ƒç”¨ <code>IncrementMetrics</code> å…ˆåšçŠ¶æ€ä¿¡æ¯çš„æ•´åˆï¼Œæœ€ç»ˆæŠŠæ•´åˆåçš„æ‰§è¡ŒçŠ¶æ€äº‹ä»¶ä¿¡æ¯ä¸ŠæŠ¥ <code>collector.Update(r)</code>ã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/30/26855/L1CUsHg6NP.png!large" alt=""></p>
<p><img src="https://cdn.learnku.com/uploads/images/202012/30/26855/iw35u2p7Vg.png!large" alt=""></p>
<p>æ¥ç€å›å¤´çœ‹åˆå§‹åŒ–æµé‡æ§åˆ¶ä¸­å¿ƒ <code>newExecutorPool(name)</code>ã€‚å…ˆçœ‹çœ‹ <code>executorPool</code>ç»“æ„ã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/30/26855/oJf8DzKrYA.png!large" alt="">
ä¸»è¦å…³æ³¨ä¸¤ä¸ªå­—æ®µï¼Œ<code>Tickets</code>è¡¨ç¤ºçš„å°±æ˜¯è®¿é—®ä»¤ç‰Œå¸¦ç¼“å†²é€šé“çš„ <code>channel</code> ï¼Œåˆå§‹åŒ– <code>channel</code> å®¹é‡å–å†³äºä¸€å¼€å§‹ä½ è®¾ç½®çš„<code>MaxConcurrentRequests </code>ã€‚å½“æœ‰è¯·æ±‚åˆ°æ¥æ—¶ï¼Œä» <code>channel</code> ä¸­æ‹¿å‡ºä¸€ä¸ªä»¤ç‰Œï¼Œè°ƒç”¨åé‡æ–°å½’è¿˜ã€‚ <code>poolMetrics</code> å°±æ˜¯æµé‡æ§åˆ¶çš„å…·ä½“æŒ‡æ ‡ã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/30/26855/Tl4WyBnbah.png!large" alt=""></p>
<p><code>Executed</code>è¡¨ç¤ºå½“å‰æ¡¶å·²ç»å¤„ç†çš„è¯·æ±‚æ•°é‡ã€‚æ­¤å¤–åœ¨ <code>newExecutorPool(name)</code> å‡½æ•°ä¸­ï¼Œå’Œåˆšæ‰å¥—è·¯ä¸€æ ·ï¼Œå¯åŠ¨ä¸€ä¸ª <code>go m.Monitor()</code>   ä¸“é—¨å»æ›´æ–°å½“å‰æ¡¶çš„æœ€å¤§å€¼ã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/30/26855/UQaHVMIHKw.png!large" alt="">
<img src="https://cdn.learnku.com/uploads/images/202012/30/26855/I1FTB6RksV.png!large" alt=""></p>
<p>åˆ°è¿™é‡Œï¼Œ<code>GetCircuit(name)</code> è·å–ä¸€ä¸ªç†”æ–­å™¨çš„ä»£ç è®²å®Œäº†ã€‚
å›åˆ° <code>GoC</code> ï¼Œæˆ‘ä»¬å¾—åˆ°ä¸€ä¸ª <code>circuitBreakers</code> çš„æŒ‡é’ˆã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/30/26855/HCMq26mFlm.png!large" alt="">
æ¥ä¸‹æ¥æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ¡ä»¶å˜é‡ <code>sync.NewCond</code>ã€‚æ¡ä»¶å˜é‡çš„åœºæ™¯æ˜¯å½“å…±äº«èµ„æºå‘ç”Ÿå˜åŒ–æ—¶ï¼Œé€šçŸ¥é‚£äº›è¢«äº’æ–¥é”é”ä½çš„çº¿ç¨‹ã€‚
åœ¨è¿™é‡Œå®ƒæ˜¯ç”¨æ¥åè°ƒé€šçŸ¥ä½ å¯ä»¥å½’è¿˜è®¿é—®ä»¤ç‰Œäº†ã€‚</p>
<p>æ¥ç€æœ‰ä¸€å¥ <code>returnOnce := &amp;sync.Once{}</code>,å…³äº <code>sync.Once</code>,ä¹‹å‰è§£æè¿‡ä¸€ç¯‡æ–‡ç« <a href="https://mp.weixin.qq.com/s?__biz=MzU3Mzc5NTU2MQ==&amp;tempkey=MTA5NF95VUwzVkc5bUNoWkNzZWtwQ1A1dXlPNGZTazVBS3RUZ3FOTDVxRmlGR3M3Tnk0YmJmLURhc1JkQTlkVFhEQ3FxQWRvUXFjeExXS0hBZ2ttVWNFdjR5cGRrUW5HbzJZdTZ2TzkyM2lfT0FIQU9wNzJOVmRHVWNMaTF2eF9odGppb0xVTEU3UzhLRTdieVlEY29NXzliODU3YWJsczhjc3BZblV0bVFRfn4%3D&amp;chksm=7d3d7a344a4af322ddae8dc18b7944c97eca68df27d7f7ff926ee59c89d6b5ba8b5f2de5a8e4#rd" title="ä½ çœŸçš„äº†è§£ sync.Once å—">ä½ çœŸçš„äº†è§£ sync.Once å—</a>ã€‚è¿™é‡Œå®ƒå­˜åœ¨çš„æ„ä¹‰æ˜¯ä»€ä¹ˆ? æˆ‘ä»¬å¾€ä¸‹çœ‹ï¼Œå°±ä¼šå‘ç°å…¶å®åˆ°åé¢å¼€å¯äº†ä¸¤ä¸ª <code>Goroutine</code>ã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/30/26855/r87TmWEEGW.png!large" alt="">
å®ƒçš„ä½œç”¨æ˜¯ç¡®ä¿ç”±æœ€å¿«é‚£ä¸ª <code>Goroutine</code> è¿è¡Œ <code>errWithFallback()</code> å’Œ <code>reportAllEvent()</code>ï¼Œè€Œä¸”ä¿è¯åªä¼šæ‰§è¡Œä¸€æ¬¡ã€‚</p>
<p>æ¥ç€å¾€ä¸‹çœ‹ï¼Œ
<img src="https://cdn.learnku.com/uploads/images/202012/30/26855/UMDw3GhSuW.png!large" alt="ä¸€æ–‡è¯»æ‡‚ hystrix-go æºç ">
è¿™ä¸ªå‡½æ•°å°±æ˜¯å°±æ˜¯ç”¨æ¥ä¸ŠæŠ¥æ‰§è¡Œäº‹ä»¶çš„ã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/30/26855/DlLsJohHro.png!large" alt=""></p>
<p>å‰é¢éƒ½å¥½æ‡‚ï¼Œæˆ‘ä»¬ä»è¿™æ®µå¼€å§‹çœ‹ï¼š
<img src="https://cdn.learnku.com/uploads/images/202012/30/26855/3XV3I8nHPG.png!large" alt="">
è¿™é‡Œæ“ä½œè¿™å¥è¯æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿå› ä¸ºå­˜åœ¨ä¸€ç§æƒ…å†µï¼šå½“å‰ç†”æ–­å™¨æ˜¯å¼€å¯çš„ï¼Œå¹¶ä¸”å·²ç»è¿‡äº† <code>SleepWindow</code> æ—¶é—´ï¼Œæ­¤æ—¶è¯·æ±‚å°±å±äºåŠå¼€çš„çŠ¶æ€ï¼Œå…è®¸å°è¯•æ‰§è¡Œï¼Œå¦‚æœæ‰§è¡ŒæˆåŠŸï¼Œé‚£ä¹ˆå°±è¯´æ˜æœåŠ¡æ¢å¤äº†ï¼Œå¯ä»¥å…³é—­ç†”æ–­å™¨äº†ã€‚æ¥ä¸‹æ¥ï¼Œ
<img src="https://cdn.learnku.com/uploads/images/202012/30/26855/xo6FXuJjxA.png!large" alt="">
ç»„è£…æ‰§è¡ŒçŠ¶æ€çŠ¶æ€äº‹ä»¶ï¼Œç„¶åå¡è¿› <code>Updates</code> é€šé“ä¸­ã€‚æ­£å¥½è¢«åˆå§‹åŒ– <code>metricExchange</code> å¦å¼€çš„ <code>Goroutine</code> æ¥æ”¶ï¼Œè¿™æ ·ï¼Œè¿™ä¸ªä¸ŠæŠ¥æµç¨‹å°±å¯¹åº”ä¸Šäº†ã€‚</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯åˆšæ‰æˆªå›¾çš„ä¸¤ä¸ª <code>Goroutine</code>,æˆ‘ä»¬å…ˆçœ‹ç¬¬ä¸€ä¸ªã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/30/26855/kSrIBnzDZp.png!large" alt=""></p>
<p>æˆªå›¾äº†ä¸Šå‰åŠéƒ¨åˆ†ã€‚ä¸Šæ¥ä¸€ä¸ª <code>defer func() { cmd.finished &lt;- true }()</code> ä½œä¸ºæ­£å¸¸è¿è¡Œç»“æŸçš„é€šçŸ¥ã€‚ç„¶åå°±æ˜¯ <code>cmd.circuit.AllowRequest()</code>åˆ¤æ–­æ˜¯å¦èƒ½è¯·æ±‚ã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/30/26855/nTLNWvkzEE.png!large" alt="">
æœ‰ä¸¤ç§æƒ…å†µå¯ä»¥å¾€ä¸‹èµ°ï¼Œç¬¬ä¸€ç§ç†”æ–­å™¨æ˜¯å…³é—­çš„ã€‚å¯¹åº” <code>circuit.IsOpen()</code>ã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/30/26855/Mq6gtXmpGu.png!large" alt="">
é¦–å…ˆåˆ¤æ–­ç†”æ–­å™¨æ˜¯å¦è¢«å¼ºåˆ¶å¼€å¯æˆ–è€…å·²ç»å¼€å¯ï¼Œå¦‚æœæ˜¯ï¼Œç›´æ¥è¿”å› <code>true</code>ã€‚å¦åˆ™è¯´æ˜æ˜¯å½“å‰ç†”æ–­å™¨å¤„äºå…³é—­ã€‚æ¥ç€åˆ¤æ–­è¿‡å»åç§’å†…å„ä¸ªæ¡¶å€¼çš„å’Œæ˜¯å¦å°äºè®¾ç½®çš„ <code>RequestVolumeThreshold </code>å€¼ï¼Œå¦‚æœå°äºï¼Œè¯´æ˜ç†”æ–­å™¨è¿˜åº”è¯¥æ˜¯å…³é—­çŠ¶æ€ï¼Œè¿”å› <code>false</code> ã€‚å¦‚æœå¤§äºç­‰äºï¼Œé‚£ä¹ˆåº”è¯¥è¿›ä¸€æ­¥å»åˆ¤æ–­é”™è¯¯ç™¾åˆ†æ¯” æ˜¯å¦è¶…å‡ºè‡ªå·±çš„è®¾ç½®çš„<code>ErrorPercentThreshold </code>ã€‚å¦‚æœè¶…å‡ºäº†ï¼Œé‚£ä¹ˆè¯´æ˜é”™è¯¯ç‡è¿‡é«˜ï¼Œæ­¤æ—¶éœ€è¦å¼€å¯ç†”æ–­å™¨ã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/30/26855/tZ1MK9ICVI.png!large" alt="">
è¿™æ®µä»£ç å¾ˆå¥½æ‡‚ï¼Œæœ‰æ„æ€çš„æ˜¯ <code>int(errPct + 0.5)</code>ã€‚<code>+0.5</code> æ˜¯ä¸ºäº†å››èˆäº”å…¥ï¼Œå¦‚æœç›´æ¥æµ®ç‚¹æ•°è½¬æ¢æˆæ•´å½¢ï¼Œé‚£ä¹ˆå¿…ç„¶å°±æ˜¯å»é™¤å°æ•°ç‚¹ã€‚åŠ äº† <code>0.5</code>ï¼Œé‚£ä¹ˆå‡è®¾ <code>ErrorPercentThreshold</code>è®¾ç½® <code>50</code>ï¼Œå¦‚æœæ˜¯ <code>&lt;45.5</code>,ç†”æ–­å™¨å°±ç»§ç»­å…³é—­,å¦åˆ™å¼€å¯ç†”æ–­å™¨ã€‚</p>
<p>å¦‚æœ<code>circuit.IsOpen()</code>ä¸ç¬¦åˆï¼Œé‚£ä¹ˆå†çœ‹ <code>circuit.allowSingleTest()</code>ã€‚è™½ç„¶ç†”æ–­å™¨æ˜¯å¼€å¯çš„ï¼Œä½†æ˜¯å¦‚æœå½“å‰çš„æ—¶é—´å·²ç»å¤§äº ï¼ˆä¸Šæ¬¡å¼€å¯ç†”æ–­å™¨çš„æ—¶é—´+<code>SleepWindow </code> çš„æ—¶é—´ï¼‰ï¼Œè¿™æ—¶å€™ç†”æ–­å™¨å±äºåŠå¼€çš„çŠ¶æ€ï¼Œå¯ä»¥æ‰§è¡Œä¸‹ä¸€æ­¥ã€‚é‚£ä¹ˆå°±ä¼šè¿”å› <code>true</code>ã€‚</p>
<p>å¦‚æœ <code>cmd.circuit.AllowRequest</code> è¿”å› <code>false</code>ï¼Œé‚£ä¹ˆå°±æ˜¯æ‰§è¡Œ <code>returnTicket</code> å½’è¿˜ä»¤ç‰Œ(å°½ç®¡è¿™æ—¶å€™è¿˜æ²¡æœ‰ä»¤ç‰Œå¯è¨€)ã€‚è¿™æ®µä»£ç å¾ˆæœ‰è¶£ï¼Œé€šè¿‡å˜é‡  <code>ticketChecked</code>  åŠ  <code>sync.NewCond</code> å®ç°çš„é€»è¾‘ã€‚<code>cmd.errorWithFallback()</code>ï¼Œä¸ŠæŠ¥ç†”æ–­å™¨å·²å¼€å¯äº‹ä»¶(<code>circuit open</code>)ä»¥åŠè¿è¡Œ <code>fallBakck</code> ä¿åº•å‡½æ•°(å¦‚æœå­˜åœ¨çš„è¯)ï¼Œæ‰§è¡Œç»“æŸï¼Œå“åº”ã€‚</p>
<p><img src="https://cdn.learnku.com/uploads/images/202012/30/26855/UaVlqg18CJ.png!large" alt=""></p>
<p>å¦‚æœè¿”å› <code>true</code>ï¼Œæ¥ç€ç©ä¸‹èµ°ï¼Œ</p>
<p><img src="https://cdn.learnku.com/uploads/images/202012/30/26855/beu0NFqgrd.png!large" alt="">
å¦‚æœæ‹¿ä¸åˆ°è®¿é—®ä»¤ç‰Œï¼Œé‚£ä¹ˆå’Œåˆšæ‰ä¸€æ ·ï¼Œä¸ŠæŠ¥å½“å‰è¯·æ±‚å·²è¶…è¿‡å¹¶å‘æ•°äº‹ä»¶(<code>max concurrency</code>)ï¼Œè¿è¡Œä¿åº•æ“ä½œï¼Œå“åº”ã€‚</p>
<p>å¦‚æœæ‹¿åˆ°è®¿é—®ä»¤ç‰Œï¼Œé‚£ä¹ˆçœŸæ­£æ‰§è¡Œè‡ªå·±çš„ä¸šåŠ¡ä»£ç  <code>run(ctx)</code>ã€‚å¥—è·¯å’Œä¸Šé¢ç›¸ä¼¼ã€‚
å†çœ‹ç¬¬äºŒä¸ª <code>Goroutine</code>
<img src="https://cdn.learnku.com/uploads/images/202012/30/26855/bMP0fZPdsi.png!large" alt="">
ä¸‰ä¸ª <code>case</code>åˆ†åˆ«è¡¨ç¤º:æ­£å¸¸æ‰§è¡Œç»“æŸã€ä¸šåŠ¡æ‰§è¡Œè¢«å–æ¶ˆä»¥åŠè¶…æ—¶ã€‚è‡³äºä¸ºä»€ä¹ˆè¯´ <code>Do</code>æ˜¯åŒæ­¥æ“ä½œï¼Œå› ä¸ºåœ¨ <code>Doc</code> æœ€å,
<img src="https://cdn.learnku.com/uploads/images/202012/30/26855/HBZXgbhOxA.png!large" alt="">ï¼Œè€Œ <code>Go</code> åˆ™æ˜¯ä¸€ä¸ªå¼‚æ­¥è¿‡ç¨‹ã€‚
åˆ°è¿™é‡Œï¼Œä» <code>Do</code> å¼€å§‹æ‰§è¡Œçš„å¤§ä½“æµç¨‹å°±èµ°å®Œäº†ã€‚
æœ€åæˆ‘ä»¬å¯ä»¥ç›´æ¥ç»™å‡ºå®ƒçš„å¤§ä½“æµç¨‹å›¾ã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/30/26855/YGB2gucOJF.png!large" alt="">
ä»–ä»¬ç»“æ„ä½“ä¹‹é—´çš„ä¸€äº›å…³ç³»å›¾ã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/30/26855/56cG9Ir6NW.png!large" alt="">
åˆ†äº« ä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„ä¸œè¥¿</p>
<p><img src="https://cdn.learnku.com/uploads/images/202012/12/26855/d1Y1mxQjr9.webp!large" alt="å›¾ç‰‡"></p>
<p>ğŸ‘† é•¿æŒ‰å…³æ³¨åº“é‡Œçš„æ·±å¤œé£Ÿå ‚</p>
]]></content>
		</item>
		
		<item>
			<title>ä¸ºä»€ä¹ˆæŠŠ dig è¿ç§»åˆ° wire</title>
			<link>https://www.syst.top/posts/go/why-dig-to-wire/</link>
			<pubDate>Wed, 21 Apr 2021 23:54:52 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/why-dig-to-wire/</guid>
			<description>å¼€ç¯‡ dig å’Œ wire éƒ½æ˜¯ Go ä¾èµ–æ³¨å…¥çš„å·¥å…·ï¼Œé‚£ä¹ˆï¼Œæœ¬è´¨ä¸ŠåŠŸèƒ½ç›¸ä¼¼çš„æ¡†æ¶ï¼Œä¸ºä»€ä¹ˆè¦ä» dig åˆ‡æ¢æˆ wireï¼Ÿ
åœºæ™¯ æˆ‘ä»¬ä»åœºæ™¯å‡ºå‘ã€‚
å‡è®¾æˆ‘ä»¬çš„é¡¹ç›®åˆ†å±‚æ˜¯:router-&amp;gt;controller-&amp;gt;service-&amp;gt;daoã€‚
å¤§æ¦‚å°±é•¿è¿™æ ·:
ç°åœ¨æˆ‘ä»¬éœ€è¦å¯¹å¤–æš´éœ²ä¸€ä¸ªè®¢å•æœåŠ¡çš„æ¥å£ã€‚
é¦–é¡µçœ‹ main.go æ–‡ä»¶ã€‚
package main import ( &amp;#34;fmt&amp;#34; &amp;#34;github.com/gin-gonic/gin&amp;#34; &amp;#34;github.com/wuqinqiang/digvswire/dig&amp;#34; &amp;#34;github.com/wuqinqiang/digvswire/router&amp;#34; ) func main() { serverStart() } func serverStart() { defer func() { if err := recover(); err != nil { fmt.Printf(&amp;#34;init app err:%v\n&amp;#34;, err) } }() e := gin.Default() di := dig.ContainerByDig() err := router.RegisterRouter(e, di) if err != nil { fmt.Printf(&amp;#34;register router err:%v&amp;#34;, err) } _ = e.</description>
			<content type="html"><![CDATA[<h3 id="å¼€ç¯‡">å¼€ç¯‡</h3>
<p><code>dig</code> å’Œ <code>wire</code> éƒ½æ˜¯ <code>Go</code> ä¾èµ–æ³¨å…¥çš„å·¥å…·ï¼Œé‚£ä¹ˆï¼Œæœ¬è´¨ä¸ŠåŠŸèƒ½ç›¸ä¼¼çš„æ¡†æ¶ï¼Œä¸ºä»€ä¹ˆè¦ä» <code>dig</code> åˆ‡æ¢æˆ <code>wire</code>ï¼Ÿ</p>
<h3 id="åœºæ™¯">åœºæ™¯</h3>
<p>æˆ‘ä»¬ä»åœºæ™¯å‡ºå‘ã€‚</p>
<p>å‡è®¾æˆ‘ä»¬çš„é¡¹ç›®åˆ†å±‚æ˜¯:<code>router-&gt;controller-&gt;service-&gt;dao</code>ã€‚</p>
<p>å¤§æ¦‚å°±é•¿è¿™æ ·:</p>
<p><img src="https://image.syst.top/image/dig-to-wire/1.png" alt="image"></p>
<p>ç°åœ¨æˆ‘ä»¬éœ€è¦å¯¹å¤–æš´éœ²ä¸€ä¸ªè®¢å•æœåŠ¡çš„æ¥å£ã€‚</p>
<p>é¦–é¡µçœ‹ <code>main.go</code> æ–‡ä»¶ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/wuqinqiang/digvswire/dig&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/wuqinqiang/digvswire/router&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">serverStart</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">serverStart</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;init app err:%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">e</span> <span class="o">:=</span> <span class="nx">gin</span><span class="p">.</span><span class="nf">Default</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">di</span> <span class="o">:=</span> <span class="nx">dig</span><span class="p">.</span><span class="nf">ContainerByDig</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">router</span><span class="p">.</span><span class="nf">RegisterRouter</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">di</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;register router err:%v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s">&#34;:8090&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¿™é‡Œä½¿ç”¨äº† <code>gin</code> å¯åŠ¨é¡¹ç›®ã€‚ ç„¶åæˆ‘ä»¬æŸ¥çœ‹ <code>dig.ContainerByDig()</code>ï¼Œ</p>
<h3 id="dig">dig</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">dig</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/wuqinqiang/digvswire/controller&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/wuqinqiang/digvswire/dao&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/wuqinqiang/digvswire/server&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;go.uber.org/dig&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">ContainerByDig</span><span class="p">()</span> <span class="o">*</span><span class="nx">dig</span><span class="p">.</span><span class="nx">Container</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">d</span> <span class="o">:=</span> <span class="nx">dig</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span> <span class="p">=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">Provide</span><span class="p">(</span><span class="nx">dao</span><span class="p">.</span><span class="nx">NewOrderDao</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span> <span class="p">=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">Provide</span><span class="p">(</span><span class="nx">server</span><span class="p">.</span><span class="nx">NewOrderServer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span> <span class="p">=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">Provide</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">NewOrderHandler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">d</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>é¦–å…ˆé€šè¿‡ <code>dig.New()</code> åˆ›å»ºä¸€ä¸ª <code>di</code> å®¹å™¨ã€‚
<code>Provide</code> å‡½æ•°ç”¨äºæ·»åŠ æœåŠ¡æä¾›è€…ï¼Œ  <code>Provide</code> å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå‡½æ•°ã€‚ä¸€ä¸ªå‘Šè¯‰å®¹å™¨ &ldquo;æˆ‘èƒ½æä¾›ä»€ä¹ˆï¼Œä¸ºäº†æä¾›å®ƒï¼Œæˆ‘éœ€è¦ä»€ä¹ˆï¼Ÿ&rdquo; çš„å‡½æ•°ã€‚</p>
<p>æ¯”å¦‚æˆ‘ä»¬çœ‹ç¬¬äºŒä¸ª <code>server.NewOrderServer</code>,</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">server</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/wuqinqiang/digvswire/dao&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">_</span> <span class="nx">OrderServerInterface</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">OrderServer</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">OrderServerInterface</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">GetUserOrderList</span><span class="p">(</span><span class="nx">userId</span> <span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="nx">dao</span><span class="p">.</span><span class="nx">Order</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">OrderServer</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">orderDao</span> <span class="nx">dao</span><span class="p">.</span><span class="nx">OrderDao</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewOrderServer</span><span class="p">(</span><span class="nx">order</span> <span class="nx">dao</span><span class="p">.</span><span class="nx">OrderDao</span><span class="p">)</span> <span class="nx">OrderServerInterface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">OrderServer</span><span class="p">{</span><span class="nx">orderDao</span><span class="p">:</span> <span class="nx">order</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">o</span> <span class="o">*</span><span class="nx">OrderServer</span><span class="p">)</span> <span class="nf">GetUserOrderList</span><span class="p">(</span><span class="nx">userId</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">orderList</span> <span class="p">[]</span><span class="nx">dao</span><span class="p">.</span><span class="nx">Order</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">o</span><span class="p">.</span><span class="nx">orderDao</span><span class="p">.</span><span class="nf">GetOrderListById</span><span class="p">(</span><span class="nx">userId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¿™é‡Œçš„ <code>NewOrderServer(xxx)</code> åœ¨ <code>Provide</code> ä¸­çš„è¯­æ„å°±æ˜¯ &ldquo;æˆ‘èƒ½æä¾›ä¸€ä¸ª <code>OrderServerInterface</code> æœåŠ¡ï¼Œä½†æ˜¯æˆ‘éœ€è¦ä¾èµ–ä¸€ä¸ª <code>dao.OrderDao</code>&quot;ã€‚</p>
<p>åˆšæ‰çš„ä»£ç ä¸­ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">_</span> <span class="p">=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">Provide</span><span class="p">(</span><span class="nx">dao</span><span class="p">.</span><span class="nx">NewOrderDao</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">_</span> <span class="p">=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">Provide</span><span class="p">(</span><span class="nx">server</span><span class="p">.</span><span class="nx">NewOrderServer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">_</span> <span class="p">=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">Provide</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">NewOrderHandler</span><span class="p">)</span>
</span></span></code></pre></div><p>å› ä¸ºæˆ‘ä»¬çš„è°ƒç”¨é“¾æ˜¯ <code>controller-&gt;server-&gt;dao</code>ï¼Œé‚£ä¹ˆæœ¬è´¨ä¸Šä»–ä»¬çš„ä¾èµ–æ˜¯ <code>controller&lt;-server&lt;-dao</code>ï¼Œåªæ˜¯ä¾èµ–çš„ä¸æ˜¯å…·ä½“çš„å®ç°ï¼Œè€Œæ˜¯æŠ½è±¡çš„æ¥å£ã€‚</p>
<p>æ‰€ä»¥ä½ çœ‹åˆ° <code>Provide</code> æ˜¯æŒ‰ç…§ä¾èµ–å…³ç³»é¡ºåºå†™çš„ã€‚</p>
<p>å…¶å®å®Œå…¨æ²¡æœ‰å¿…è¦ï¼Œå› ä¸ºè¿™ä¸€æ­¥ <code>dig</code> åªä¼šå¯¹è¿™äº›å‡½æ•°è¿›è¡Œåˆ†æï¼Œæå–å‡½æ•°çš„å½¢å‚ä»¥åŠè¿”å›å€¼ã€‚ç„¶åæ ¹æ®è¿”å›çš„å‚æ•°æ¥ç»„ç»‡å®¹å™¨ç»“æ„ã€‚
å¹¶ä¸ä¼šåœ¨è¿™ä¸€æ­¥æ‰§è¡Œä¼ å…¥çš„å‡½æ•°ï¼Œæ‰€ä»¥åœ¨ <code>Provide</code> é˜¶æ®µå‰åé¡ºåºå¹¶ä¸é‡è¦ï¼Œåªè¦ç¡®ä¿ä¸é—æ¼ä¾èµ–é¡¹å³å¯ã€‚</p>
<p>ä¸‡äº‹ä¿±å¤‡ï¼Œæˆ‘ä»¬å¼€å§‹æ³¨å†Œä¸€ä¸ªèƒ½è·å–è®¢å•çš„è·¯ç”±ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">err</span> <span class="o">:=</span> <span class="nx">router</span><span class="p">.</span><span class="nf">RegisterRouter</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// router.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">RegisterRouter</span><span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Engine</span><span class="p">,</span> <span class="nx">dig</span> <span class="o">*</span><span class="nx">dig</span><span class="p">.</span><span class="nx">Container</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">dig</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">handle</span> <span class="o">*</span><span class="nx">controller</span><span class="p">.</span><span class="nx">OrderHandler</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">e</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/user/orders&#34;</span><span class="p">,</span> <span class="nx">handle</span><span class="p">.</span><span class="nx">GetUserOrderList</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æ­¤æ—¶ï¼Œè°ƒç”¨ <code>invoke</code>ï¼Œ æ‰æ˜¯çœŸæ­£éœ€è¦è·å– <code>*controller.OrderHandler</code> å¯¹è±¡ã€‚</p>
<p>è°ƒç”¨ <code>invoke</code> æ–¹æ³•ï¼Œä¼šå¯¹ä¼ å…¥çš„å‚æ•°åšåˆ†æï¼Œå‚æ•°ä¸­å­˜åœ¨ <code>handle *controller.OrderHandler</code>, å°±ä¼šå»å®¹å™¨ä¸­å¯»æ‰¾å“ªä¸ª <code>Provide</code> è¿›æ¥çš„å‡½æ•°è¿”å›ç±»å‹æ˜¯ <code>handle *controller.OrderHandler</code>,</p>
<p>å°±èƒ½å¯¹åº”æ‰¾åˆ°,</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">_</span> <span class="p">=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">Provide</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">NewOrderHandler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// å¯¹åº”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewOrderHandler</span><span class="p">(</span><span class="nx">server</span> <span class="nx">server</span><span class="p">.</span><span class="nx">OrderServerInterface</span><span class="p">)</span> <span class="o">*</span><span class="nx">OrderHandler</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">OrderHandler</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">server</span><span class="p">:</span> <span class="nx">server</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å‘ç°è¿™ä¸ªå‡½æ•°æœ‰å½¢å‚ <code>server.OrderServerInterface</code>,é‚£å°±å»æ‰¾å¯¹åº”è¿”å›æ­¤ç±»å‹çš„å‡½æ•°ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">_</span> <span class="p">=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">Provide</span><span class="p">(</span><span class="nx">server</span><span class="p">.</span><span class="nx">NewOrderServer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">//å¯¹åº”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewOrderServer</span><span class="p">(</span><span class="nx">order</span> <span class="nx">dao</span><span class="p">.</span><span class="nx">OrderDao</span><span class="p">)</span> <span class="nx">OrderServerInterface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">OrderServer</span><span class="p">{</span><span class="nx">orderDao</span><span class="p">:</span> <span class="nx">order</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>åˆå‘ç°å½¢å‚ <code>ï¼ˆorder dao.OrderDao)</code>,</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">_</span> <span class="p">=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">Provide</span><span class="p">(</span><span class="nx">dao</span><span class="p">.</span><span class="nx">NewOrderDao</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">//å¯¹åº”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewOrderDao</span><span class="p">()</span> <span class="nx">OrderDao</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">new</span><span class="p">(</span><span class="nx">OrderDaoImpl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æœ€åå‘ç° <code>NewOrderDao</code> æ²¡æœ‰ä¾èµ–ï¼Œä¸éœ€è¦å†æŸ¥è¯¢ä¾èµ–ã€‚å¼€å§‹æ‰§è¡Œå‡½æ•°çš„è°ƒç”¨ <code>NewOrderDao()</code>ï¼ŒæŠŠè¿”å›çš„ <code>OrderDao</code> ä¼ å…¥åˆ°ä¸Šå±‚çš„ <code>NewOrderServer(order dao.OrderDao)</code> è¿›è¡Œå‡½æ•°è°ƒç”¨ï¼Œ
<code>NewOrderServer(order dao.OrderDao)</code> è¿”å›çš„ <code>OrderServerInterface</code> ç»§ç»­è¿”å›åˆ°ä¸Šå±‚ <code>NewOrderHandler(server server.OrderServerInterface)</code> æ‰§è¡Œè°ƒç”¨ï¼Œæœ€åå†æŠŠå‡½æ•°è°ƒç”¨è¿”å›çš„ <code>*OrderHandler</code> ä¼ é€’ç»™ <code>dig.Invoke(func(handle *controller.OrderHandler) {}</code>,</p>
<p>æ•´ä¸ªé“¾è·¯å°±é€šäº†ã€‚ç”¨ä¸€ä¸ªç®€é™‹çš„å›¾æ¥æè¿°è¿™ä¸ªè¿‡ç¨‹
<img src="https://image.syst.top/image/dig-to-wire/2.png" alt="image"></p>
<p><code>dig</code> çš„æ•´ä¸ªæµç¨‹é‡‡ç”¨çš„æ˜¯åå°„æœºåˆ¶ï¼Œåœ¨è¿è¡Œæ—¶è®¡ç®—ä¾èµ–å…³ç³»ï¼Œæ„é€ ä¾èµ–å¯¹è±¡ã€‚</p>
<p>è¿™æ ·ä¼šå­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼Ÿ</p>
<p>å‡è®¾æˆ‘ç°åœ¨æ³¨é‡Šæ‰ <code>Provide</code> çš„ä¸€è¡Œä»£ç ï¼Œæ¯”å¦‚,</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">ContainerByDig</span><span class="p">()</span> <span class="o">*</span><span class="nx">dig</span><span class="p">.</span><span class="nx">Container</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">d</span> <span class="o">:=</span> <span class="nx">dig</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//_ = d.Provide(dao.NewOrderDao)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">_</span> <span class="p">=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">Provide</span><span class="p">(</span><span class="nx">server</span><span class="p">.</span><span class="nx">NewOrderServer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span> <span class="p">=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">Provide</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">NewOrderHandler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">d</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬åœ¨ç¼–è¯‘é¡¹ç›®çš„æ—¶å€™å¹¶ä¸ä¼šæŠ¥ä»»ä½•é”™è¯¯ï¼Œåªä¼šåœ¨è¿è¡Œæ—¶æ‰å‘ç°ç¼ºå°‘äº†ä¾èµ–é¡¹ã€‚
<img src="https://image.syst.top/image/dig-to-wire/3.png" alt="image"></p>
<h3 id="wire">wire</h3>
<p>è¿˜æ˜¯ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>wire</code> ä½œä¸ºæˆ‘ä»¬çš„ <code>DI</code> å®¹å™¨ã€‚</p>
<p><code>wire</code> ä¹Ÿæœ‰ä¸¤ä¸ªæ ¸å¿ƒæ¦‚å¿µ: <code>Provider</code> å’Œ <code>Injector</code>ã€‚</p>
<p>å…¶ä¸­ <code>Provider</code> çš„æ¦‚å¿µå’Œ <code>dig</code> çš„æ¦‚å¿µæ˜¯ä¸€æ ·çš„:&ldquo;æˆ‘èƒ½æä¾›ä»€ä¹ˆï¼Ÿæˆ‘éœ€è¦ä»€ä¹ˆä¾èµ–&rdquo;ã€‚</p>
<p>æ¯”å¦‚ä¸‹é¢ <code>wire.go</code> ä¸­çš„ä»£ç ,</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//+build wireinject
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">wire</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/google/wire&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/wuqinqiang/digvswire/controller&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/wuqinqiang/digvswire/dao&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/wuqinqiang/digvswire/server&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">orderSet</span> <span class="p">=</span> <span class="nx">wire</span><span class="p">.</span><span class="nf">NewSet</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">dao</span><span class="p">.</span><span class="nx">NewOrderDao</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">server</span><span class="p">.</span><span class="nx">NewOrderServer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">controller</span><span class="p">.</span><span class="nx">NewOrderHandler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">ContainerByWire</span><span class="p">()</span> <span class="o">*</span><span class="nx">controller</span><span class="p">.</span><span class="nx">OrderHandler</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">wire</span><span class="p">.</span><span class="nf">Build</span><span class="p">(</span><span class="nx">orderSet</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">controller</span><span class="p">.</span><span class="nx">OrderHandler</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å…¶ä¸­ï¼Œ<code>dao.NewOrderDao</code> ã€<code>server.NewOrderServer</code> ä»¥åŠ <code>controller.NewOrderHandler</code> å°±æ˜¯ <code>Provider</code>ã€‚</p>
<p>ä½ ä¼šå‘ç°è¿™é‡Œè¿˜è°ƒç”¨ <code>wire.NewSet</code> æŠŠä»–ä»¬æ•´åˆåœ¨ä¸€èµ·ï¼Œèµ‹å€¼ç»™äº†ä¸€ä¸ªå˜é‡ <code>orderSet</code>ã€‚</p>
<p>å…¶å®æ˜¯ç”¨åˆ° <code>ProviderSet</code> çš„æ¦‚å¿µã€‚åŸç†å°±æ˜¯æŠŠä¸€ç»„ç›¸å…³çš„ <code>Provider</code> è¿›è¡Œæ‰“åŒ…ã€‚</p>
<p>è¿™æ ·çš„å¥½å¤„æ˜¯:</p>
<ul>
<li>ç»“æ„ä¾èµ–æ¸…æ™°ï¼Œä¾¿äºé˜…è¯»ã€‚</li>
<li>ä»¥ç»„çš„å½¢å¼ï¼Œå‡å°‘ <code>injector</code> é‡Œçš„ <code>Build</code>ã€‚</li>
</ul>
<p>è‡³äº <code>injector</code>ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯æŒ‰ç…§ä¾èµ–å…³ç³»è°ƒç”¨ <code>Provider</code> çš„å‡½æ•°ï¼Œç„¶åæœ€ç»ˆç”Ÿæˆæˆ‘ä»¬æƒ³è¦çš„å¯¹è±¡(æœåŠ¡)ã€‚</p>
<p>æ¯”å¦‚ä¸Šé¢çš„ <code>ContainerByWire()</code> å°±æ˜¯ä¸€ä¸ª <code>injector</code>ã€‚</p>
<p>é‚£ä¹ˆ <code>wire.go</code> æ–‡ä»¶æ•´ä½“çš„æ€è·¯å°±æ˜¯:å®šä¹‰å¥½ <code>injector</code>ï¼Œç„¶åå®ç°æ‰€éœ€çš„ <code>Provider</code>ã€‚</p>
<p>æœ€ååœ¨å½“å‰ <code>wire.go</code> æ–‡ä»¶å¤¹ä¸‹æ‰§è¡Œ <code>wire</code> å‘½ä»¤åï¼Œ</p>
<p>æ­¤æ—¶å¦‚æœä½ çš„ä¾èµ–é¡¹å­˜åœ¨é—®é¢˜ï¼Œé‚£ä¹ˆå°±ä¼šæŠ¥é”™æç¤ºã€‚æ¯”å¦‚æˆ‘ç°åœ¨éšè—ä¸Šé¢çš„ <code>dao.NewOrderDao</code>,é‚£ä¹ˆä¼šå‡ºç°
<img src="https://image.syst.top/image/dig-to-wire/4.png" alt="image"></p>
<p>å¦‚æœä¾èµ–ä¸å­˜åœ¨é—®é¢˜ï¼Œæœ€ç»ˆä¼šç”Ÿæˆä¸€ä¸ª <code>wire_gen.go</code> æ–‡ä»¶ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Code generated by Wire. DO NOT EDIT.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//go:generate go run github.com/google/wire/cmd/wire
</span></span></span><span class="line"><span class="cl"><span class="c1">//+build !wireinject
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">wire</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/google/wire&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/wuqinqiang/digvswire/controller&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/wuqinqiang/digvswire/dao&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/wuqinqiang/digvswire/server&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Injectors from wire.go:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">ContainerByWire</span><span class="p">()</span> <span class="o">*</span><span class="nx">controller</span><span class="p">.</span><span class="nx">OrderHandler</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">orderDao</span> <span class="o">:=</span> <span class="nx">dao</span><span class="p">.</span><span class="nf">NewOrderDao</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">orderServerInterface</span> <span class="o">:=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">NewOrderServer</span><span class="p">(</span><span class="nx">orderDao</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">orderHandler</span> <span class="o">:=</span> <span class="nx">controller</span><span class="p">.</span><span class="nf">NewOrderHandler</span><span class="p">(</span><span class="nx">orderServerInterface</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">orderHandler</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// wire.go:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">orderSet</span> <span class="p">=</span> <span class="nx">wire</span><span class="p">.</span><span class="nf">NewSet</span><span class="p">(</span><span class="nx">dao</span><span class="p">.</span><span class="nx">NewOrderDao</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">NewOrderServer</span><span class="p">,</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">NewOrderHandler</span><span class="p">)</span>
</span></span></code></pre></div><p>éœ€è¦æ³¨æ„ä¸Šé¢ä¸¤ä¸ªæ–‡ä»¶ã€‚æˆ‘ä»¬çœ‹åˆ° <code>wire.go</code> ä¸­ç¬¬ä¸€è¡Œ <code>//+build wireinject</code> ï¼Œè¿™ä¸ª <code>build tag</code> ç¡®ä¿åœ¨å¸¸è§„ç¼–è¯‘æ—¶å¿½ç•¥ <code>wire.go</code> æ–‡ä»¶ã€‚
è€Œä¸ä¹‹ç›¸å¯¹çš„ <code>wire_gen.go</code> ä¸­çš„ <code>//+build !wireinject</code>ã€‚ ä¸¤ä¸ªå¯¹ç«‹çš„ <code>build tag</code> æ˜¯ä¸ºäº†ç¡®ä¿åœ¨ä»»æ„æƒ…å†µä¸‹ï¼Œä¸¤ä¸ªæ–‡ä»¶åªæœ‰ä¸€ä¸ªæ–‡ä»¶ç”Ÿæ•ˆï¼Œ
é¿å…å‡ºç° &ldquo;<code>ContainerByWire()</code> æ–¹æ³•è¢«é‡æ–°å®šä¹‰&rdquo; çš„ç¼–è¯‘é”™è¯¯ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥çœŸæ­£ä½¿ç”¨ <code>injector</code> äº†ï¼Œæˆ‘ä»¬åœ¨å…¥å£æ–‡ä»¶ä¸­æ›¿æ¢æˆ <code>dig</code>ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">serverStart</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;init app err:%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">e</span> <span class="o">:=</span> <span class="nx">gin</span><span class="p">.</span><span class="nf">Default</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">router</span><span class="p">.</span><span class="nf">RegisterRouterByWire</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">wire</span><span class="p">.</span><span class="nf">ContainerByWire</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s">&#34;:8090&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">RegisterRouterByWire</span><span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Engine</span><span class="p">,</span> <span class="nx">handler</span> <span class="o">*</span><span class="nx">controller</span><span class="p">.</span><span class="nx">OrderHandler</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">e</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/v2/user/orders&#34;</span><span class="p">,</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">GetUserOrderList</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ä¸€åˆ‡æ­£å¸¸ã€‚</p>
<p>å½“ç„¶ <code>wire</code> æœ‰ä¸€ä¸ªç‚¹éœ€è¦æ³¨æ„ï¼Œåœ¨ <code>wire.go</code> æ–‡ä»¶ä¸­å¼€å¤´å‡ è¡Œ:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//+build wireinject
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">wire</span>
</span></span></code></pre></div><p><code>build tag</code> å’Œ <code>package</code> ä»–ä»¬ä¹‹é—´æ˜¯æœ‰ç©ºè¡Œçš„ï¼Œå¦‚æœæ²¡æœ‰ç©ºè¡Œï¼Œ<code>build tag</code> è¯†åˆ«ä¸äº†ï¼Œé‚£ä¹ˆç¼–è¯‘çš„æ—¶å€™å°±ä¼šæŠ¥é‡å¤å£°æ˜çš„é”™è¯¯ï¼š
<img src="https://image.syst.top/image/dig-to-wire/5.png" alt="image"></p>
<p>è¿˜æœ‰å¾ˆå¤šé«˜çº§çš„æ“ä½œå¯ä»¥è‡ªè¡Œäº†è§£ã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>ä»¥ä¸Šå¤§ä½“ä»‹ç»äº† go ä¸­ <code>dig</code> å’Œ <code>wire</code> ä¸¤ä¸ª <code>DI</code> å·¥å…·ã€‚å…¶ä¸­ <code>dig</code> æ˜¯é€šè¿‡è¿è¡Œæ—¶åå°„å®ç°çš„ä¾èµ–æ³¨å…¥ã€‚
è€Œ <code>wire</code> æ˜¯æ ¹æ®è‡ªå®šä¹‰çš„ä»£ç ï¼Œé€šè¿‡å‘½ä»¤ï¼Œç”Ÿæˆç›¸åº”çš„ä¾èµ–æ³¨å…¥ä»£ç ï¼Œåœ¨ç¼–è¯‘æœŸå°±å®Œæˆä¾èµ–æ³¨å…¥ï¼Œæ— éœ€åå°„æœºåˆ¶ã€‚
è¿™æ ·çš„å¥½å¤„æ˜¯ï¼š</p>
<ul>
<li>æ–¹ä¾¿æ’æŸ¥ï¼Œå¦‚æœå­˜åœ¨ä¾èµ–é”™è¯¯ï¼Œç¼–è¯‘æ—¶å°±èƒ½å‘ç°ã€‚è€Œ <code>dig</code> åªèƒ½åœ¨è¿è¡Œæ—¶æ‰èƒ½å‘ç°ä¾èµ–é”™è¯¯ã€‚</li>
<li>é¿å…ä¾èµ–è†¨èƒ€ï¼Œ<code>wire</code> ç”Ÿæˆçš„ä»£ç åªåŒ…å«è¢«ä¾èµ–çš„ï¼Œè€Œ <code>dig</code> å¯èƒ½ä¼šå­˜åœ¨å¥½å¤šæ— ç”¨ä¾èµ–ã€‚</li>
<li>ä¾èµ–å…³ç³»é™æ€å­˜åœ¨æºç ï¼Œä¾¿äºå·¥å…·åˆ†æã€‚</li>
</ul>
<h3 id="reference">Reference</h3>
<p>[1]
<a href="https://github.com/google/wire">https://github.com/google/wire</a></p>
<p>[2]
<a href="https://github.com/uber-go/dig">https://github.com/uber-go/dig</a></p>
<p>[3]
<a href="https://medium.com/@dche423/master-wire-cn-d57de86caa1b">https://medium.com/@dche423/master-wire-cn-d57de86caa1b</a></p>
<p>[4]
<a href="https://www.cnblogs.com/li-peng/p/14708132.html">https://www.cnblogs.com/li-peng/p/14708132.html</a></p>
]]></content>
		</item>
		
		<item>
			<title>åœ¨Goä¸­ä½ çŠ¯è¿‡çš„é”™</title>
			<link>https://www.syst.top/posts/go/mistake/</link>
			<pubDate>Wed, 21 Apr 2021 23:54:52 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/mistake/</guid>
			<description>åœ¨è¿­ä»£å™¨å˜é‡ä¸Šä½¿ç”¨ goroutine è¿™ç®—é«˜é¢‘å§ã€‚
package main import ( &amp;#34;fmt&amp;#34; &amp;#34;sync&amp;#34; ) func main() { var wg sync.WaitGroup items := []int{1, 2, 3, 4, 5} for index, _ := range items { wg.Add(1) go func() { defer wg.Done() fmt.Printf(&amp;#34;item:%v\n&amp;#34;, items[index]) }() } wg.Wait() } ä¸€ä¸ªå¾ˆç®€å•çš„åˆ©ç”¨ sync.waitGroup åšä»»åŠ¡ç¼–æ’çš„åœºæ™¯ï¼Œçœ‹ä¸€ä¸‹å¥½åƒæ²¡å•¥é—®é¢˜ï¼Œè¿è¡Œçœ‹çœ‹ç»“æœã€‚
ä¸ºå•¥ä¸æ˜¯1-5(å½“ç„¶ä¸æ˜¯é¡ºåºçš„)ã€‚
åŸå› å¾ˆç®€å•ï¼Œå¾ªç¯å™¨ä¸­çš„ i å®é™…ä¸Šæ˜¯ä¸€ä¸ªå•å˜é‡ï¼Œgo func é‡Œçš„é—­åŒ…åªç»‘å®šåœ¨ä¸€ä¸ªå˜é‡ä¸Šï¼Œ æ¯ä¸ª goroutine å¯èƒ½è¦ç­‰åˆ°å¾ªç¯ç»“æŸæ‰çœŸæ­£çš„è¿è¡Œï¼Œè¿™æ—¶å€™è¿è¡Œçš„ i å€¼å¤§æ¦‚ç‡å°±æ˜¯5äº†, æ²¡äººèƒ½ä¿è¯è¿™ä¸ªè¿‡ç¨‹ï¼Œæœ‰çš„åªæ˜¯æ‰‹æ®µã€‚
æ­£ç¡®çš„åšæ³•
func main() { var wg sync.WaitGroup items := []int{1, 2, 3, 4, 5} for index, _ := range items { wg.</description>
			<content type="html"><![CDATA[<h3 id="åœ¨è¿­ä»£å™¨å˜é‡ä¸Šä½¿ç”¨-goroutine">åœ¨è¿­ä»£å™¨å˜é‡ä¸Šä½¿ç”¨ goroutine</h3>
<p>è¿™ç®—é«˜é¢‘å§ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;sync&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
</span></span><span class="line"><span class="cl">	<span class="nx">items</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">items</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;item:%v\n&#34;</span><span class="p">,</span> <span class="nx">items</span><span class="p">[</span><span class="nx">index</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">		<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ä¸€ä¸ªå¾ˆç®€å•çš„åˆ©ç”¨ <code>sync.waitGroup</code> åšä»»åŠ¡ç¼–æ’çš„åœºæ™¯ï¼Œçœ‹ä¸€ä¸‹å¥½åƒæ²¡å•¥é—®é¢˜ï¼Œè¿è¡Œçœ‹çœ‹ç»“æœã€‚</p>
<p><img src="https://image.syst.top/image/mistake/mistake-1.png" alt="image"></p>
<p>ä¸ºå•¥ä¸æ˜¯1-5(å½“ç„¶ä¸æ˜¯é¡ºåºçš„)ã€‚</p>
<p>åŸå› å¾ˆç®€å•ï¼Œå¾ªç¯å™¨ä¸­çš„ i å®é™…ä¸Šæ˜¯ä¸€ä¸ªå•å˜é‡ï¼Œ<code>go func</code>  é‡Œçš„é—­åŒ…åªç»‘å®šåœ¨ä¸€ä¸ªå˜é‡ä¸Šï¼Œ
æ¯ä¸ª <code>goroutine</code> å¯èƒ½è¦ç­‰åˆ°å¾ªç¯ç»“æŸæ‰çœŸæ­£çš„è¿è¡Œï¼Œè¿™æ—¶å€™è¿è¡Œçš„ i å€¼å¤§æ¦‚ç‡å°±æ˜¯5äº†,
æ²¡äººèƒ½ä¿è¯è¿™ä¸ªè¿‡ç¨‹ï¼Œæœ‰çš„åªæ˜¯æ‰‹æ®µã€‚</p>
<p>æ­£ç¡®çš„åšæ³•</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">items</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">items</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">i</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;item:%v\n&#34;</span><span class="p">,</span> <span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">		<span class="p">}(</span><span class="nx">index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>é€šè¿‡å°† <code>i</code>  ä½œä¸ºä¸€ä¸ªå‚æ•°ä¼ å…¥é—­åŒ…ä¸­ï¼Œi æ¯æ¬¡è¿­ä»£éƒ½ä¼šè¢«æ±‚å€¼ï¼Œ
å¹¶æ”¾ç½®åœ¨ <code>goroutine</code> çš„å †æ ˆä¸­ï¼Œå› æ­¤æ¯ä¸ªåˆ‡ç‰‡å…ƒç´ æœ€ç»ˆéƒ½ä¼šè¢«æ‰§è¡Œæ‰“å°ã€‚</p>
<p>æˆ–è€…è¿™æ ·ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">for</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">items</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">i</span><span class="o">:=</span><span class="nx">index</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;item:%v\n&#34;</span><span class="p">,</span> <span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">		<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span></code></pre></div><h3 id="waitgroup">WaitGroup</h3>
<p>ä¸Šé¢çš„ä¾‹å­æœ‰ç”¨åˆ° <code>sync.waitGroup</code>ï¼Œä½¿ç”¨ä¸å½“ï¼Œä¹Ÿä¼šçŠ¯é”™ã€‚</p>
<p>æˆ‘æŠŠä¸Šé¢çš„ä¾‹å­ç¨å¾®æ”¹åŠ¨å¤æ‚ä¸€ç‚¹ç‚¹ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;errors&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/prometheus/common/log&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;sync&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">User</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">userId</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">userList</span> <span class="p">[]</span><span class="nx">User</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">userList</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">userList</span><span class="p">,</span> <span class="nx">User</span><span class="p">{</span><span class="nx">userId</span><span class="p">:</span> <span class="nx">i</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">userList</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">item</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">Do</span><span class="p">(</span><span class="nx">userList</span><span class="p">[</span><span class="nx">item</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">log</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;err message:%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}(</span><span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// å¤„ç†å…¶ä»–äº‹åŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Do</span><span class="p">(</span><span class="nx">user</span> <span class="nx">User</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// å¤„ç†æ‚ä¸ƒæ‚å…«çš„ä¸šåŠ¡....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">user</span><span class="p">.</span><span class="nx">userId</span> <span class="o">==</span> <span class="mi">9</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// æ­¤äººæ˜¯éæ³•ç”¨æˆ·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="s">&#34;å¤±è´¥&#34;</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;éæ³•ç”¨æˆ·&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="s">&#34;æˆåŠŸ&#34;</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å‘ç°é—®é¢˜ä¸¥é‡æ€§äº†å—ï¼Ÿ</p>
<p>å½“ç”¨æˆ·<code>id</code>ç­‰äº9çš„æ—¶å€™ï¼Œ<code>err !=nil</code> ç›´æ¥ <code>return</code> äº†ï¼Œå¯¼è‡´ <code>waitGroup</code> è®¡æ•°å™¨æ ¹æœ¬æ²¡æœºä¼šå‡1ï¼Œ
æœ€ç»ˆ <code>wait</code> ä¼šé˜»å¡ï¼Œå¤šä¹ˆå¯æ€•çš„ <code>bug</code>ã€‚</p>
<p>åœ¨ç»å¤§å¤šæ•°çš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éƒ½å¿…é¡»è¿™æ ·:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">userList</span> <span class="p">[]</span><span class="nx">User</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">userList</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">userList</span><span class="p">,</span> <span class="nx">User</span><span class="p">{</span><span class="nx">userId</span><span class="p">:</span> <span class="nx">i</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">userList</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">item</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">//....ä¸šåŠ¡ä»£ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">//....ä¸šåŠ¡ä»£ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">Do</span><span class="p">(</span><span class="nx">userList</span><span class="p">[</span><span class="nx">item</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">log</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;err message:%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}(</span><span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="é‡ç”Ÿ-goroutine">é‡ç”Ÿ goroutine</h3>
<p>æˆ‘ä¸çŸ¥é“ä½ ä»¬å…¬å¸æ˜¯å’‹ä¹ˆå¤„ç†å¼‚æ­¥æ“ä½œçš„ï¼Œæ˜¯ä¸‹é¢è¿™æ ·å—</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// doSomething
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// doSomething
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬ä¸ºäº†é˜²æ­¢ç¨‹åºä¸­å‡ºç°ä¸å¯é¢„çŸ¥çš„ <code>panic</code>ï¼Œå¯¼è‡´ç¨‹åºç›´æ¥æŒ‚æ‰ï¼Œéƒ½ä¼šåŠ å…¥ <code>recover</code>ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;å¤„ç†å¤±è´¥&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ä½†æ˜¯å¦‚æœè¿™æ—¶å€™æˆ‘ä»¬ç›´æ¥å¼€å¯ä¸€ä¸ª <code>goroutine</code>ï¼Œåœ¨è¿™ä¸ª <code>goroutine</code> é‡Œé¢å‘ç”Ÿäº†  <code>panic</code>ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;å¤„ç†å¤±è´¥&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æ­¤æ—¶æœ€å¤–å±‚çš„ <code>recover</code> å¹¶ä¸èƒ½æ•è·ï¼Œç¨‹åºä¼šç›´æ¥æŒ‚æ‰ã€‚
<img src="https://image.syst.top/image/mistake/mistake-2.png" alt="image"></p>
<p>ä½†æ˜¯ä½ æ€»ä¸èƒ½æ¯æ¬¡å¼€å¯ä¸€ä¸ªæ–°çš„ <code>goroutine</code> å°±åœ¨é‡Œé¢ <code>recover</code>,</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// func1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}()</span>
</span></span><span class="line"><span class="cl">		<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;é”™è¯¯å¤±è´¥&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// func2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}()</span>
</span></span><span class="line"><span class="cl">		<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;è¯·æ±‚é”™è¯¯&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å¤šè ¢å•Šã€‚æ‰€ä»¥åŸºæœ¬ä¸Šå¤§å®¶éƒ½ä¼šåŒ…ä¸€å±‚ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// func1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Go</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;é”™è¯¯å¤±è´¥&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// func2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Go</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;è¯·æ±‚é”™è¯¯&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Go</span><span class="p">(</span><span class="nx">fn</span> <span class="kd">func</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="nf">RunSafe</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">RunSafe</span><span class="p">(</span><span class="nx">fn</span> <span class="kd">func</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;é”™è¯¯:%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="nf">fn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å½“ç„¶æˆ‘è¿™é‡Œåªæ˜¯ç®€å•éƒ½æ‰“å°ä¸€äº›æ—¥å¿—ä¿¡æ¯ï¼Œä¸€èˆ¬è¿˜ä¼šå¸¦ä¸Šå †æ ˆéƒ½ä¿¡æ¯ã€‚</p>
<h3 id="channel">channel</h3>
<p><code>channel</code> åœ¨ <code>go</code> ä¸­çš„åœ°ä½å®åœ¨å¤ªé«˜äº†ï¼Œå„å¤§å¼€æºé¡¹ç›®åˆ°å¤„éƒ½æ˜¯ <code>channel</code> çš„å½±å­ï¼Œ
ä»¥è‡³äºä½ åœ¨å·¥ä¸šçº§çš„é¡¹ç›® issues ä¸­æœç´¢ <code>channel</code> ï¼Œèƒ½çœ‹åˆ°å¾ˆå¤šçš„ <code>bug</code>ï¼Œ
æ¯”å¦‚ etcd è¿™ä¸ª <code>issue</code>,
<img src="https://image.syst.top/image/mistake/mistake-3.png" alt="image"></p>
<p>ä¸€ä¸ªå¾€å·²å…³é—­çš„ <code>channel</code> ä¸­å‘é€æ•°æ®å¼•å‘çš„ <code>panic</code>,ç­‰ç­‰ç±»ä¼¼åœºæ™¯å¾ˆå¤šã€‚</p>
<p>è¿™ä¸ªæ•…äº‹å‘Šè¯‰æˆ‘ä»¬ï¼Œå¦ç®¡å¤§ä¸å¤§ä½¬ï¼Œæ”¹å†™çš„ <code>bug</code> è¿˜æ˜¯ä¼šå†™ï¼Œæ‰‹åŠ¨ç‹—å¤´ã€‚</p>
<p><code>channel</code> é™¤äº†ä¸Šè¿°é«˜é¢‘å‡ºç°çš„é”™è¯¯ï¼Œè¿˜æœ‰ä»¥ä¸‹å‡ ç‚¹:</p>
<h4 id="ç›´æ¥å…³é—­ä¸€ä¸ª-nil-å€¼-channel-ä¼šå¼•å‘-panic">ç›´æ¥å…³é—­ä¸€ä¸ª nil å€¼ channel ä¼šå¼•å‘ panic</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">ch</span> <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="nb">close</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="å…³é—­ä¸€ä¸ªå·²å…³é—­çš„-channel-ä¼šå¼•å‘-panic">å…³é—­ä¸€ä¸ªå·²å…³é—­çš„ channel ä¼šå¼•å‘ panicã€‚</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">  <span class="nb">close</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nb">close</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å¦å¤–ï¼Œæœ‰æ—¶å€™ä½¿ç”¨ <code>channel</code> ä¸å°å¿ƒä¼šå¯¼è‡´ <code>goroutine</code> æ³„éœ²ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ç§æƒ…å†µ,</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cx</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ch</span> <span class="o">&lt;-</span> <span class="kd">struct</span><span class="p">{}{}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;goroutine ç»“æŸ&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ch</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;res&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">cx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;timeout&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å¯åŠ¨ä¸€ä¸ª <code>goroutine</code> å»å¤„ç†ä¸šåŠ¡ï¼Œä¸šåŠ¡éœ€è¦æ‰§è¡Œ2ç§’ï¼Œè€Œæˆ‘ä»¬è®¾ç½®çš„è¶…æ—¶æ—¶é—´æ˜¯1ç§’ã€‚
è¿™å°±ä¼šå¯¼è‡´ <code>channel</code> ä»æœªè¢«è¯»å–ï¼Œ
æˆ‘ä»¬çŸ¥é“æ²¡æœ‰ç¼“å†²çš„ <code>channel</code> å¿…é¡»ç­‰å‘é€æ–¹å’Œæ¥æ”¶æ–¹éƒ½å‡†å¤‡å¥½æ‰èƒ½æ“ä½œã€‚
æ­¤æ—¶ <code>goroutine</code> ä¼šè¢«æ°¸ä¹…é˜»å¡åœ¨  <code>ch &lt;- struct{}{}</code> è¿™è¡Œä»£ç ï¼Œé™¤éç¨‹åºç»“æŸã€‚
è€Œè¿™å°±æ˜¯ <code>goroutine</code> æ³„éœ²ã€‚</p>
<p>è§£å†³è¿™ä¸ªä¹Ÿå¾ˆç®€å•ï¼ŒæŠŠæ— ç¼“å†²çš„ <code>channel</code> æ”¹æˆç¼“å†²ä¸º1ã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†ä½¿ç”¨ <code>Go</code> åœ¨æ—¥å¸¸å¼€å‘ä¸­å®¹æ˜“çŠ¯ä¸‹çš„é”™ã€‚
å½“ç„¶è¿˜è¿œè¿œä¸æ­¢è¿™äº›ï¼Œä½ å¯ä»¥åœ¨ä¸‹æ–¹ç•™è¨€ä¸­è¡¥å……ä½ çŠ¯è¿‡çš„é”™ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>å¦‚ä½•ä¼˜é›…åœ°å®ç°å¹¶å‘ç¼–æ’ä»»åŠ¡</title>
			<link>https://www.syst.top/posts/go/mr/</link>
			<pubDate>Wed, 21 Apr 2021 23:54:52 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/mr/</guid>
			<description>ä¸šåŠ¡åœºæ™¯ åœ¨åšä»»åŠ¡å¼€å‘çš„æ—¶å€™ï¼Œä½ ä»¬ä¸€å®šä¼šç¢°åˆ°ä»¥ä¸‹åœºæ™¯:
åœºæ™¯1ï¼šè°ƒç”¨ç¬¬ä¸‰æ–¹æ¥å£çš„æ—¶å€™ï¼Œ ä¸€ä¸ªéœ€æ±‚ä½ éœ€è¦è°ƒç”¨ä¸åŒçš„æ¥å£ï¼Œåšæ•°æ®ç»„è£…ã€‚ åœºæ™¯2:ä¸€ä¸ªåº”ç”¨é¦–é¡µå¯èƒ½ä¾æ‰˜äºå¾ˆå¤šæœåŠ¡ã€‚é‚£å°±æ¶‰åŠåˆ°åœ¨åŠ è½½é¡µé¢æ—¶éœ€è¦åŒæ—¶è¯·æ±‚å¤šä¸ªæœåŠ¡çš„æ¥å£ã€‚è¿™ä¸€æ­¥å¾€å¾€æ˜¯ç”±åç«¯ç»Ÿä¸€è°ƒç”¨ç»„è£…æ•°æ®å†è¿”å›ç»™å‰ç«¯ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„ BFF(Backend For Frontend) å±‚ã€‚
é’ˆå¯¹ä»¥ä¸Šä¸¤ç§åœºæ™¯ï¼Œå‡è®¾åœ¨æ²¡æœ‰å¼ºä¾èµ–å…³ç³»ä¸‹ï¼Œé€‰æ‹©ä¸²è¡Œè°ƒç”¨ï¼Œé‚£ä¹ˆæ€»è€—æ—¶å³:
time=s1+s2+....sn æŒ‰ç…§å½“ä»£ç§’å…¥ç™¾ä¸‡çš„æœ‰ä¸ºé’å¹´ï¼Œè¿™ä¹ˆé•¿æ—¶é—´æ—©å°±æŠŠä½ ç¥–å®—åå…«ä»£é—®å€™äº†ä¸€éã€‚
ä¸ºäº†ä¼Ÿå¤§çš„KPIï¼Œæˆ‘ä»¬å¾€å¾€ä¼šé€‰æ‹©å¹¶å‘åœ°è°ƒç”¨è¿™äº›ä¾èµ–æ¥å£ã€‚é‚£ä¹ˆæ€»è€—æ—¶å°±æ˜¯:
time=max(s1,s2,s3.....,sn) å½“ç„¶å¼€å§‹å †ä¸šåŠ¡çš„æ—¶å€™å¯ä»¥å…ˆä¸²è¡ŒåŒ–ï¼Œç­‰åˆ°ä¸Šé¢çš„äººç€æ€¥çš„æ—¶å€™ï¼Œäº®å‡ºç»æ‹›ã€‚
è¿™æ ·ï¼Œå¹´åº• PPT å°±å¯ä»¥åŠ ä¸Šæµ“é‡çš„ä¸€ç¬”æµæ°´è´¦:ä¸ºä¸šåŠ¡æŸä¸ªæ¥å£æé«˜ç™¾åˆ†ä¹‹XXXæ€§èƒ½ï¼Œé—´æ¥äº§ç”ŸXXXä»·å€¼ã€‚
å½“ç„¶è¿™ä¸€åˆ‡çš„å‰ææ˜¯ï¼Œåšè€æ¿ä¸æ‡‚æŠ€æœ¯ï¼ŒåšæŠ€æœ¯â€æ‡‚â€ä½ ã€‚
è¨€å½’æ­£ä¼ ,å¦‚æœä¿®æ”¹æˆå¹¶å‘è°ƒç”¨ï¼Œä½ å¯èƒ½ä¼šè¿™ä¹ˆå†™ï¼Œ
package main import ( &amp;#34;fmt&amp;#34; &amp;#34;sync&amp;#34; &amp;#34;time&amp;#34; ) func main() { var wg sync.WaitGroup wg.Add(2) var userInfo *User var productList []Product go func() { defer wg.Done() userInfo, _ = getUser() }() go func() { defer wg.Done() productList, _ = getProductList() }() wg.Wait() fmt.Printf(&amp;#34;ç”¨æˆ·ä¿¡æ¯:%+v\n&amp;#34;, userInfo) fmt.Printf(&amp;#34;å•†å“ä¿¡æ¯:%+v\n&amp;#34;, productList) } /********ç”¨æˆ·æœåŠ¡**********/ type User struct { Name string Age uint8 } func getUser() (*User, error) { time.</description>
			<content type="html"><![CDATA[<h3 id="ä¸šåŠ¡åœºæ™¯">ä¸šåŠ¡åœºæ™¯</h3>
<p>åœ¨åšä»»åŠ¡å¼€å‘çš„æ—¶å€™ï¼Œä½ ä»¬ä¸€å®šä¼šç¢°åˆ°ä»¥ä¸‹åœºæ™¯:</p>
<p>åœºæ™¯1ï¼šè°ƒç”¨ç¬¬ä¸‰æ–¹æ¥å£çš„æ—¶å€™ï¼Œ ä¸€ä¸ªéœ€æ±‚ä½ éœ€è¦è°ƒç”¨ä¸åŒçš„æ¥å£ï¼Œåšæ•°æ®ç»„è£…ã€‚
åœºæ™¯2:ä¸€ä¸ªåº”ç”¨é¦–é¡µå¯èƒ½ä¾æ‰˜äºå¾ˆå¤šæœåŠ¡ã€‚é‚£å°±æ¶‰åŠåˆ°åœ¨åŠ è½½é¡µé¢æ—¶éœ€è¦åŒæ—¶è¯·æ±‚å¤šä¸ªæœåŠ¡çš„æ¥å£ã€‚è¿™ä¸€æ­¥å¾€å¾€æ˜¯ç”±åç«¯ç»Ÿä¸€è°ƒç”¨ç»„è£…æ•°æ®å†è¿”å›ç»™å‰ç«¯ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„ BFF(Backend For Frontend) å±‚ã€‚</p>
<p>é’ˆå¯¹ä»¥ä¸Šä¸¤ç§åœºæ™¯ï¼Œå‡è®¾åœ¨æ²¡æœ‰å¼ºä¾èµ–å…³ç³»ä¸‹ï¼Œé€‰æ‹©ä¸²è¡Œè°ƒç”¨ï¼Œé‚£ä¹ˆæ€»è€—æ—¶å³:</p>
<pre tabindex="0"><code>time=s1+s2+....sn
</code></pre><p>æŒ‰ç…§å½“ä»£ç§’å…¥ç™¾ä¸‡çš„æœ‰ä¸ºé’å¹´ï¼Œè¿™ä¹ˆé•¿æ—¶é—´æ—©å°±æŠŠä½ ç¥–å®—åå…«ä»£é—®å€™äº†ä¸€éã€‚</p>
<p>ä¸ºäº†ä¼Ÿå¤§çš„KPIï¼Œæˆ‘ä»¬å¾€å¾€ä¼šé€‰æ‹©å¹¶å‘åœ°è°ƒç”¨è¿™äº›ä¾èµ–æ¥å£ã€‚é‚£ä¹ˆæ€»è€—æ—¶å°±æ˜¯:</p>
<pre tabindex="0"><code>time=max(s1,s2,s3.....,sn)
</code></pre><p>å½“ç„¶å¼€å§‹å †ä¸šåŠ¡çš„æ—¶å€™å¯ä»¥å…ˆä¸²è¡ŒåŒ–ï¼Œç­‰åˆ°ä¸Šé¢çš„äººç€æ€¥çš„æ—¶å€™ï¼Œäº®å‡ºç»æ‹›ã€‚</p>
<p>è¿™æ ·ï¼Œå¹´åº• PPT å°±å¯ä»¥åŠ ä¸Šæµ“é‡çš„ä¸€ç¬”æµæ°´è´¦:ä¸ºä¸šåŠ¡æŸä¸ªæ¥å£æé«˜ç™¾åˆ†ä¹‹XXXæ€§èƒ½ï¼Œé—´æ¥äº§ç”ŸXXXä»·å€¼ã€‚</p>
<p>å½“ç„¶è¿™ä¸€åˆ‡çš„å‰ææ˜¯ï¼Œåšè€æ¿ä¸æ‡‚æŠ€æœ¯ï¼ŒåšæŠ€æœ¯â€æ‡‚â€ä½ ã€‚</p>
<p>è¨€å½’æ­£ä¼ ,å¦‚æœä¿®æ”¹æˆå¹¶å‘è°ƒç”¨ï¼Œä½ å¯èƒ½ä¼šè¿™ä¹ˆå†™ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;sync&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
</span></span><span class="line"><span class="cl">	<span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">userInfo</span> <span class="o">*</span><span class="nx">User</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">productList</span> <span class="p">[]</span><span class="nx">Product</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">userInfo</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nf">getUser</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">productList</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nf">getProductList</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;ç”¨æˆ·ä¿¡æ¯:%+v\n&#34;</span><span class="p">,</span> <span class="nx">userInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;å•†å“ä¿¡æ¯:%+v\n&#34;</span><span class="p">,</span> <span class="nx">productList</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/********ç”¨æˆ·æœåŠ¡**********/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">User</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Name</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Age</span>  <span class="kt">uint8</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">getUser</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">500</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">u</span> <span class="nx">User</span>
</span></span><span class="line"><span class="cl">	<span class="nx">u</span><span class="p">.</span><span class="nx">Name</span> <span class="p">=</span> <span class="s">&#34;wuqinqiang&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">u</span><span class="p">.</span><span class="nx">Age</span> <span class="p">=</span> <span class="mi">18</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">u</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/********å•†å“æœåŠ¡**********/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Product</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Title</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Price</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">getProductList</span><span class="p">()</span> <span class="p">([]</span><span class="nx">Product</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">400</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">list</span> <span class="p">[]</span><span class="nx">Product</span>
</span></span><span class="line"><span class="cl">	<span class="nx">list</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">list</span><span class="p">,</span> <span class="nx">Product</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Title</span><span class="p">:</span> <span class="s">&#34;SHib&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Price</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">list</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å…ˆä¸ç®¡å…¶ä»–é—®é¢˜ã€‚ä»å®ç°ä¸Šæ¥è¯´ï¼Œéœ€è¦å¤šå°‘æœåŠ¡ï¼Œä½ ä¼šå¼€å¤šå°‘ä¸ª <code>G</code>ï¼Œåˆ©ç”¨ <code>sync.WaitGroup</code> çš„ç‰¹æ€§ï¼Œ
å®ç°å¹¶å‘ç¼–æ’ä»»åŠ¡çš„æ•ˆæœã€‚</p>
<p>å¥½åƒï¼Œé—®é¢˜ä¸å¤§ã€‚</p>
<p>ä½†æ˜¯éšç€ä»£å· <code>996</code> ä¸šåŠ¡åœºæ™¯çš„å¢åŠ ï¼Œä½ ä¼šå‘ç°ï¼Œå¥½å¤šæ¨¡å—éƒ½æœ‰ç›¸ä¼¼çš„åŠŸèƒ½ï¼Œåªæ˜¯å¯¹åº”çš„ä¸šåŠ¡åœºæ™¯ä¸åŒè€Œå·²ã€‚</p>
<p>é‚£ä¹ˆæˆ‘ä»¬èƒ½ä¸èƒ½æŠ½åƒå‡ºä¸€å¥—é’ˆå¯¹æ­¤ä¸šåŠ¡åœºæ™¯çš„å·¥å…·ï¼Œè€ŒæŠŠå…·ä½“ä¸šåŠ¡å®ç°äº¤ç»™ä¸šåŠ¡æ–¹ã€‚</p>
<p>å®‰æ’ã€‚</p>
<h3 id="ä½¿ç”¨">ä½¿ç”¨</h3>
<p>æœ¬ç€ä¸é‡å¤é€ è½®å­çš„åŸåˆ™ï¼Œå»æœäº†ä¸‹å¼€æºé¡¹ç›®ï¼Œæœ€ç»ˆçœ‹ä¸Šäº† <code>go-zero</code> é‡Œé¢çš„ä¸€ä¸ªå·¥å…· <code>mapreduce</code>ã€‚
ä»æ–‡ä»¶åæˆ‘ä»¬èƒ½çœ‹å‡ºæ¥æ˜¯ä»€ä¹ˆäº†ï¼Œå¯ä»¥è‡ªè¡Œ <code>Google</code> è¿™ä¸ªåè¯ã€‚</p>
<p>ä½¿ç”¨å¾ˆç®€å•ã€‚æˆ‘ä»¬é€šè¿‡å®ƒæ”¹é€ ä¸€ä¸‹ä¸Šé¢çš„ä»£ç :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/tal-tech/go-zero/core/mr&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">userInfo</span> <span class="o">*</span><span class="nx">User</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">productList</span> <span class="p">[]</span><span class="nx">Product</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span> <span class="p">=</span> <span class="nx">mr</span><span class="p">.</span><span class="nf">Finish</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">userInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">getUser</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="kd">func</span><span class="p">()</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">productList</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">getProductList</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;ç”¨æˆ·ä¿¡æ¯:%+v\n&#34;</span><span class="p">,</span> <span class="nx">userInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;å•†å“ä¿¡æ¯:%+v\n&#34;</span><span class="p">,</span> <span class="nx">productList</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><pre tabindex="0"><code>ç”¨æˆ·ä¿¡æ¯:&amp;{Name:wuqinqiang Age:18}
å•†å“ä¿¡æ¯:[{Title:SHib Price:10}]
</code></pre><p>æ˜¯ä¸æ˜¯èˆ’æœå¤šäº†ã€‚</p>
<p>ä½†æ˜¯è¿™é‡Œè¿˜éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œå‡è®¾ä½ è°ƒç”¨çš„å…¶ä¸­ä¸€ä¸ªæœåŠ¡é”™è¯¯ï¼Œå¹¶ä¸”ä½  <code>return err</code> å¯¹åº”çš„é”™è¯¯ï¼Œé‚£ä¹ˆå…¶ä»–è°ƒç”¨çš„æœåŠ¡ä¼šè¢«å–æ¶ˆã€‚
æ¯”å¦‚æˆ‘ä»¬ä¿®æ”¹ getProductList ç›´æ¥å“åº”é”™è¯¯ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">getProductList</span><span class="p">()</span> <span class="p">([]</span><span class="nx">Product</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;test error&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//æ‰“å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">ç”¨æˆ·ä¿¡æ¯</span><span class="p">:&lt;</span><span class="kc">nil</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">å•†å“ä¿¡æ¯</span><span class="p">:[]</span>
</span></span></code></pre></div><p>é‚£ä¹ˆæœ€ç»ˆæ‰“å°çš„æ—¶å€™è¿ç”¨æˆ·ä¿¡æ¯éƒ½ä¼šä¸ºç©ºï¼Œå› ä¸ºå‡ºç°ä¸€ä¸ªæœåŠ¡é”™è¯¯ï¼Œç”¨æˆ·æœåŠ¡è¯·æ±‚è¢«å–æ¶ˆäº†ã€‚</p>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåœ¨è¯·æ±‚æœåŠ¡é”™è¯¯çš„æ—¶å€™æˆ‘ä»¬ä¼šæœ‰ä¿åº•æ“ä½œï¼Œä¸€ä¸ªæœåŠ¡é”™è¯¯ä¸èƒ½å½±å“å…¶ä»–è¯·æ±‚çš„ç»“æœã€‚
æ‰€ä»¥åœ¨ä½¿ç”¨çš„æ—¶å€™å…·ä½“å¤„ç†å–å†³äºä¸šåŠ¡åœºæ™¯ã€‚</p>
<h3 id="æºç ">æºç </h3>
<p>æ—¢ç„¶ç”¨äº†ï¼Œé‚£ä¹ˆå°±è¿½ä¸‹æºç å§ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Finish</span><span class="p">(</span><span class="nx">fns</span> <span class="o">...</span><span class="kd">func</span><span class="p">()</span> <span class="kt">error</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">fns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">MapReduceVoid</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">source</span> <span class="kd">chan</span><span class="o">&lt;-</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">fn</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">fns</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">source</span> <span class="o">&lt;-</span> <span class="nx">fn</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="kd">func</span><span class="p">(</span><span class="nx">item</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">writer</span> <span class="nx">Writer</span><span class="p">,</span> <span class="nx">cancel</span> <span class="kd">func</span><span class="p">(</span><span class="kt">error</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fn</span> <span class="o">:=</span> <span class="nx">item</span><span class="p">.(</span><span class="kd">func</span><span class="p">()</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">fn</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">cancel</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="kd">func</span><span class="p">(</span><span class="nx">pipe</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">cancel</span> <span class="kd">func</span><span class="p">(</span><span class="kt">error</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">drain</span><span class="p">(</span><span class="nx">pipe</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="nf">WithWorkers</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">fns</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">MapReduceVoid</span><span class="p">(</span><span class="nx">generator</span> <span class="nx">GenerateFunc</span><span class="p">,</span> <span class="nx">mapper</span> <span class="nx">MapperFunc</span><span class="p">,</span> <span class="nx">reducer</span> <span class="nx">VoidReducerFunc</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">Option</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">MapReduce</span><span class="p">(</span><span class="nx">generator</span><span class="p">,</span> <span class="nx">mapper</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">input</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">writer</span> <span class="nx">Writer</span><span class="p">,</span> <span class="nx">cancel</span> <span class="kd">func</span><span class="p">(</span><span class="kt">error</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">reducer</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">cancel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nf">drain</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// We need to write a placeholder to let MapReduce to continue on reducer done,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// otherwise, all goroutines are waiting. The placeholder will be discarded by MapReduce.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">writer</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">lang</span><span class="p">.</span><span class="nx">Placeholder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å¯¹äº <code>MapReduceVoid</code>å‡½æ•°ï¼Œä¸»è¦æŸ¥çœ‹ä¸‰ä¸ªé—­åŒ…å‚æ•°ã€‚</p>
<ul>
<li>ç¬¬ä¸€ä¸ª <code>GenerateFunc</code> ç”¨äºç”Ÿäº§æ•°æ®ã€‚</li>
<li><code>MapperFunc</code> è¯»å–ç”Ÿäº§å‡ºçš„æ•°æ®ï¼Œè¿›è¡Œå¤„ç†ã€‚</li>
<li><code>VoidReducerFunc</code> è¿™é‡Œè¡¨ç¤ºä¸å¯¹ <code>mapper</code> åçš„æ•°æ®åšèšåˆè¿”å›ã€‚æ‰€ä»¥è¿™ä¸ªé—­åŒ…åœ¨æ­¤æ“ä½œå‡ ä¹0ä½œç”¨ã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">MapReduce</span><span class="p">(</span><span class="nx">generate</span> <span class="nx">GenerateFunc</span><span class="p">,</span> <span class="nx">mapper</span> <span class="nx">MapperFunc</span><span class="p">,</span> <span class="nx">reducer</span> <span class="nx">ReducerFunc</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">Option</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">source</span> <span class="o">:=</span> <span class="nf">buildSource</span><span class="p">(</span><span class="nx">generate</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">MapReduceWithSource</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">mapper</span><span class="p">,</span> <span class="nx">reducer</span><span class="p">,</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">buildSource</span><span class="p">(</span><span class="nx">generate</span> <span class="nx">GenerateFunc</span><span class="p">)</span> <span class="kd">chan</span> <span class="kd">interface</span><span class="p">{}</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">source</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">interface</span><span class="p">{})</span><span class="c1">// åˆ›å»ºæ— ç¼“å†²é€šé“
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">threading</span><span class="p">.</span><span class="nf">GoSafe</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nb">close</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nf">generate</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span> <span class="c1">//å¼€å§‹ç”Ÿäº§æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">source</span> <span class="c1">//è¿”å›æ— ç¼“å†²é€šé“
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p><code>buildSource</code>å‡½æ•°ä¸­ï¼Œè¿”å›ä¸€ä¸ªæ— ç¼“å†²çš„é€šé“ã€‚å¹¶å¼€å¯ä¸€ä¸ª <code>G</code> è¿è¡Œ <code>generate(source)</code>ï¼Œå¾€æ— ç¼“å†²é€šé“å¡æ•°æ®ã€‚ è¿™ä¸ª<code>generate(source)</code> ä¸å°±æ˜¯ä¸€å¼€å§‹ <code>Finish</code> ä¼ é€’çš„ç¬¬ä¸€ä¸ªé—­åŒ…å‚æ•°ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">return</span> <span class="nf">MapReduceVoid</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">source</span> <span class="kd">chan</span><span class="o">&lt;-</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// å°±è¿™ä¸ª
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">fn</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">fns</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">source</span> <span class="o">&lt;-</span> <span class="nx">fn</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span></code></pre></div><p>ç„¶åæŸ¥çœ‹ <code>MapReduceWithSource</code> å‡½æ•°,</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">MapReduceWithSource</span><span class="p">(</span><span class="nx">source</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">mapper</span> <span class="nx">MapperFunc</span><span class="p">,</span> <span class="nx">reducer</span> <span class="nx">ReducerFunc</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">opts</span> <span class="o">...</span><span class="nx">Option</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">options</span> <span class="o">:=</span> <span class="nf">buildOptions</span><span class="p">(</span><span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//ä»»åŠ¡æ‰§è¡Œç»“æŸé€šçŸ¥ä¿¡å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">output</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">interface</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//å°†mapperå¤„ç†å®Œçš„æ•°æ®å†™å…¥collector
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">collector</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">options</span><span class="p">.</span><span class="nx">workers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å–æ¶ˆæ“ä½œä¿¡å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">done</span> <span class="o">:=</span> <span class="nx">syncx</span><span class="p">.</span><span class="nf">NewDoneChan</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">writer</span> <span class="o">:=</span> <span class="nf">newGuardedWriter</span><span class="p">(</span><span class="nx">output</span><span class="p">,</span> <span class="nx">done</span><span class="p">.</span><span class="nf">Done</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">closeOnce</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Once</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">retErr</span> <span class="nx">errorx</span><span class="p">.</span><span class="nx">AtomicError</span>
</span></span><span class="line"><span class="cl">	<span class="nx">finish</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">closeOnce</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">done</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nb">close</span><span class="p">(</span><span class="nx">output</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cancel</span> <span class="o">:=</span> <span class="nf">once</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">retErr</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">retErr</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">ErrCancelWithNil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">drain</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nf">finish</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">r</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">();</span> <span class="nx">r</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nf">cancel</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%v&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nf">finish</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}()</span>
</span></span><span class="line"><span class="cl">		<span class="nf">reducer</span><span class="p">(</span><span class="nx">collector</span><span class="p">,</span> <span class="nx">writer</span><span class="p">,</span> <span class="nx">cancel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nf">drain</span><span class="p">(</span><span class="nx">collector</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// çœŸæ­£ä»ç”Ÿæˆå™¨é€šé“å–æ•°æ®æ‰§è¡ŒMapper
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">go</span> <span class="nf">executeMappers</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">item</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">w</span> <span class="nx">Writer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">mapper</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">cancel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">collector</span><span class="p">,</span> <span class="nx">done</span><span class="p">.</span><span class="nf">Done</span><span class="p">(),</span> <span class="nx">options</span><span class="p">.</span><span class="nx">workers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">value</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">output</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">retErr</span><span class="p">.</span><span class="nf">Load</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">value</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">ErrReduceNoOutput</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¿™æ®µä»£ç æŒºé•¿çš„ï¼Œæˆ‘ä»¬è¯´ä¸‹æ ¸å¿ƒçš„ç‚¹ã€‚æˆ‘ä»¬çœ‹åˆ°ä½¿ç”¨ä¸€ä¸ª<code>G</code> è°ƒç”¨ <code>executeMappers</code> æ–¹æ³•ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">go</span> <span class="nf">executeMappers</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">item</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">w</span> <span class="nx">Writer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">mapper</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">cancel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">collector</span><span class="p">,</span> <span class="nx">done</span><span class="p">.</span><span class="nf">Done</span><span class="p">(),</span> <span class="nx">options</span><span class="p">.</span><span class="nx">workers</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">executeMappers</span><span class="p">(</span><span class="nx">mapper</span> <span class="nx">MapFunc</span><span class="p">,</span> <span class="nx">input</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">collector</span> <span class="kd">chan</span><span class="o">&lt;-</span> <span class="kd">interface</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">	<span class="nx">done</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="nx">lang</span><span class="p">.</span><span class="nx">PlaceholderType</span><span class="p">,</span> <span class="nx">workers</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œæ¯•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// å…³é—­é€šé“
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nb">close</span><span class="p">(</span><span class="nx">collector</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//æ ¹æ®æŒ‡å®šæ•°é‡åˆ›å»º workeræ± 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">pool</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">lang</span><span class="p">.</span><span class="nx">PlaceholderType</span><span class="p">,</span> <span class="nx">workers</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">	<span class="nx">writer</span> <span class="o">:=</span> <span class="nf">newGuardedWriter</span><span class="p">(</span><span class="nx">collector</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">done</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">pool</span> <span class="o">&lt;-</span> <span class="nx">lang</span><span class="p">.</span><span class="nx">Placeholder</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// ä»buildSource() è¿”å›çš„æ— ç¼“å†²é€šé“å–æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">item</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">input</span> 
</span></span><span class="line"><span class="cl">			<span class="c1">// å½“é€šé“å…³é—­ï¼Œç»“æŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="o">&lt;-</span><span class="nx">pool</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// better to safely run caller defined method
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">threading</span><span class="p">.</span><span class="nf">GoSafe</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">					<span class="o">&lt;-</span><span class="nx">pool</span>
</span></span><span class="line"><span class="cl">				<span class="p">}()</span>
</span></span><span class="line"><span class="cl">				<span class="c1">//çœŸæ­£è¿è¡Œé—­åŒ…å‡½æ•°çš„åœ°æ–¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>               <span class="c1">// func(item interface{}, w Writer) {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>               <span class="c1">//    mapper(item, w, cancel)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>               <span class="c1">//    }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nf">mapper</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">writer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">})</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å…·ä½“çš„é€»è¾‘å·²å¤‡æ³¨ï¼Œä»£ç å¾ˆå®¹æ˜“æ‡‚ã€‚</p>
<p>ä¸€æ—¦ <code>executeMappers</code> å‡½æ•°è¿”å›ï¼Œå…³é—­ <code>collector</code> é€šé“ï¼Œé‚£ä¹ˆæ‰§è¡Œ <code>reducer</code> ä¸å†é˜»å¡ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">r</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">();</span> <span class="nx">r</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nf">cancel</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%v&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nf">finish</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}()</span>
</span></span><span class="line"><span class="cl">		<span class="nf">reducer</span><span class="p">(</span><span class="nx">collector</span><span class="p">,</span> <span class="nx">writer</span><span class="p">,</span> <span class="nx">cancel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//è¿™é‡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">drain</span><span class="p">(</span><span class="nx">collector</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span></code></pre></div><p>è¿™é‡Œçš„ <code>reducer(collector, writer, cancel)</code> å…¶å®å°±æ˜¯ä» <code>MapReduceVoid</code> ä¼ é€’çš„ç¬¬ä¸‰ä¸ªé—­åŒ…å‡½æ•°ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">MapReduceVoid</span><span class="p">(</span><span class="nx">generator</span> <span class="nx">GenerateFunc</span><span class="p">,</span> <span class="nx">mapper</span> <span class="nx">MapperFunc</span><span class="p">,</span> <span class="nx">reducer</span> <span class="nx">VoidReducerFunc</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">Option</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">MapReduce</span><span class="p">(</span><span class="nx">generator</span><span class="p">,</span> <span class="nx">mapper</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">input</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">writer</span> <span class="nx">Writer</span><span class="p">,</span> <span class="nx">cancel</span> <span class="kd">func</span><span class="p">(</span><span class="kt">error</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">reducer</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">cancel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//è¿™é‡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">drain</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// We need to write a placeholder to let MapReduce to continue on reducer done,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// otherwise, all goroutines are waiting. The placeholder will be discarded by MapReduce.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">writer</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">lang</span><span class="p">.</span><span class="nx">Placeholder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ç„¶åè¿™ä¸ªé—­åŒ…å‡½æ•°åˆæ‰§è¡Œäº† <code>reducer(input, cancel)</code>ï¼Œè¿™é‡Œçš„ <code>reducer</code> å°±æ˜¯æˆ‘ä»¬ä¸€å¼€å§‹è§£é‡Šè¿‡çš„ <code>VoidReducerFunc</code>ï¼Œä» <code>Finish() è€Œæ¥</code>ã€‚</p>
<p><img src="https://image.syst.top/image/mr/mr.png" alt="image"></p>
<p>ç­‰ç­‰,çœ‹åˆ°ä¸Šé¢ä¸‰ä¸ªåœ°æ–¹çš„ <code>drain(input)</code>äº†å—ï¼Ÿ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// drain drains the channel.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">drain</span><span class="p">(</span><span class="nx">channel</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// drain the channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="k">range</span> <span class="nx">channel</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å…¶å®å°±æ˜¯ä¸€ä¸ªæ’ç©º <code>channel</code> çš„æ“ä½œï¼Œä½†æ˜¯ä¸‰ä¸ªåœ°æ–¹éƒ½å¯¹åŒä¸€ä¸ª <code>channel</code>,ä¹Ÿæ˜¯è®©æˆ‘è´¹è§£ã€‚</p>
<p>è¿˜æœ‰æ›´é‡è¦çš„ä¸€ç‚¹ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">r</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">();</span> <span class="nx">r</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nf">cancel</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%v&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nf">finish</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}()</span>
</span></span><span class="line"><span class="cl">		<span class="nf">reducer</span><span class="p">(</span><span class="nx">collector</span><span class="p">,</span> <span class="nx">writer</span><span class="p">,</span> <span class="nx">cancel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nf">drain</span><span class="p">(</span><span class="nx">collector</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span></code></pre></div><p>ä¸Šé¢çš„ä»£ç ï¼Œå‡å¦‚æ‰§è¡Œ <code>reducer</code>ï¼Œ<code>writer</code> å†™å…¥å¼•å‘ <code>panic</code>,é‚£ä¹ˆ<code>drain(collector)</code> ä¼šç›´æ¥å¡ä½ã€‚</p>
<p>ä¸è¿‡ä½œè€…å·²ç»ä¿®å¤äº†è¿™ä¸ªé—®é¢˜ï¼Œç›´æ¥æŠŠ <code>drain(collector)</code> æ”¾å…¥åˆ° <code>defer</code>ã€‚
<img src="https://image.syst.top/image/mr/mr-2.png" alt="image"></p>
<p>å…·ä½“ issues[1]ã€‚</p>
<p>åˆ°è¿™é‡Œï¼Œå…³äº <code>Finish</code> çš„æºç ä¹Ÿå°±ç»“æŸäº†ã€‚æ„Ÿå…´è¶£çš„å¯ä»¥çœ‹çœ‹å…¶ä»–æºç ã€‚</p>
<p>å¾ˆå–œæ¬¢ <code>go-zero</code> é‡Œçš„ä¸€äº›å·¥å…·ï¼Œä½†æ˜¯å¾€å¾€ç”¨çš„ä¸€äº›å·¥å…·å¹¶ä¸ç‹¬ç«‹ï¼Œ
ä¾èµ–äºå…¶ä»–æ–‡ä»¶åŒ…ï¼Œå¯¼è‡´æ˜æ˜åªæƒ³ä½¿ç”¨å…¶ä¸­ä¸€ä¸ªå·¥å…·å´éœ€è¦å®‰è£…æ•´ä¸ªåŒ…ã€‚
æ‰€ä»¥æœ€ç»ˆçš„ç»“æœå°±æ˜¯æ‰’æºç ï¼Œåˆ›å»ºæ— ä¾èµ–åº“å·¥å…·é›†ï¼Œéµå¾ª <code>MIT</code> å³å¯ã€‚</p>
<p>é™„å½•
[1]
<a href="https://github.com/tal-tech/go-zero/issues/676">https://github.com/tal-tech/go-zero/issues/676</a></p>
]]></content>
		</item>
		
		<item>
			<title>hystrix-goä½¿ç”¨ä¸åŸç†(ä¸€)</title>
			<link>https://www.syst.top/posts/go/hystrix-go/</link>
			<pubDate>Sat, 17 Apr 2021 22:24:32 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/hystrix-go/</guid>
			<description>å¼€ç¯‡ è¿™å‘¨åœ¨çœ‹å†…éƒ¨ä¸€ä¸ªç†”æ–­é™æµåŒ…æ—¶ï¼Œå‘ç°å®ƒæ˜¯åŸºäºä¸€ä¸ªå¼€æºé¡¹ç›® hystrix-go å®ç°äº†ï¼Œå› æ­¤æœ‰äº†è¿™ç¯‡æ–‡ç« ã€‚
Hystrix Hystrix æ˜¯ç”± Netflex  å¼€å‘çš„ä¸€æ¬¾å¼€æºç»„ä»¶ï¼Œæä¾›äº†åŸºç¡€çš„ç†”æ–­åŠŸèƒ½ã€‚ Hystrix å°†é™çº§çš„ç­–ç•¥å°è£…åœ¨ Command ä¸­ï¼Œæä¾›äº† run å’Œ fallback ä¸¤ä¸ªæ–¹æ³•ï¼Œå‰è€…è¡¨ç¤ºæ­£å¸¸çš„é€»è¾‘ï¼Œæ¯”å¦‚å¾®æœåŠ¡ä¹‹é—´çš„è°ƒç”¨&amp;hellip;&amp;hellip;ï¼Œå¦‚æœå‘ç”Ÿäº†æ•…éšœï¼Œå†æ‰§è¡Œ fallbackæ–¹æ³•è¿”å›ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒç†è§£æˆä¿åº•æ“ä½œã€‚å¦‚æœæ­£å¸¸é€»è¾‘åœ¨çŸ­æ—¶é—´å†…é¢‘ç¹å‘ç”Ÿæ•…éšœï¼Œé‚£ä¹ˆå¯èƒ½ä¼šè§¦å‘çŸ­è·¯ï¼Œä¹Ÿå°±æ˜¯ä¹‹åçš„è¯·æ±‚ä¸å†æ‰§è¡Œ run,è€Œæ˜¯ç›´æ¥æ‰§è¡Œ fallbackã€‚æ›´å¤šå…³äº Hystrix çš„ä¿¡æ¯å¯ä»¥æŸ¥çœ‹ https://github.com/Netflix/Hystrixï¼Œè€Œ hystrix-go åˆ™æ˜¯ç”¨ go å®ç°çš„ hystrix ç‰ˆï¼Œæ›´ç¡®åˆ‡çš„è¯´ï¼Œæ˜¯ç®€åŒ–ç‰ˆã€‚åªæ˜¯ä¸Šä¸€æ¬¡æ›´æ–°è¿˜æ˜¯ 2018å¹´ çš„ä¸€æ¬¡ pr,ä¹Ÿå°±æ¯•ä¸šäº†ï¼Ÿ
ä¸ºä»€ä¹ˆéœ€è¦è¿™äº›å·¥å…·ï¼Ÿ æ¯”å¦‚ä¸€ä¸ªå¾®æœåŠ¡åŒ–çš„äº§å“çº¿ä¸Šï¼Œæ¯ä¸€ä¸ªæœåŠ¡éƒ½ä¸“æ³¨äºè‡ªå·±çš„ä¸šåŠ¡ï¼Œå¹¶å¯¹å¤–æä¾›ç›¸åº”çš„æœåŠ¡æ¥å£ï¼Œæˆ–è€…ä¾èµ–äºå¤–éƒ¨æœåŠ¡çš„æŸä¸ªé€»è¾‘æ¥å£ï¼Œå°±åƒä¸‹é¢è¿™æ ·ã€‚ å‡è®¾æˆ‘ä»¬å½“å‰æ˜¯ æœåŠ¡Aï¼Œæœ‰éƒ¨åˆ†é€»è¾‘ä¾èµ–äº æœåŠ¡Cï¼ŒæœåŠ¡C åˆä¾èµ–äº æœåŠ¡E,å½“å‰å¾®æœåŠ¡ä¹‹é—´è¿›è¡Œ rpcæˆ–è€… httpé€šä¿¡ï¼Œå‡è®¾æ­¤æ—¶ æœåŠ¡C è°ƒç”¨ æœåŠ¡E å¤±è´¥,æ¯”å¦‚ç”±äºç½‘ç»œæ³¢åŠ¨å¯¼è‡´è¶…æ—¶æˆ–è€…æœåŠ¡Eç”±äºè¿‡è½½ï¼Œç³»ç»ŸE å·²ç»downæ‰äº†ã€‚ è°ƒç”¨å¤±è´¥ï¼Œä¸€èˆ¬ä¼šæœ‰å¤±è´¥é‡è¯•ç­‰æœºåˆ¶ã€‚ä½†æ˜¯å†æƒ³æƒ³ï¼Œå‡è®¾æœåŠ¡Eå·²ç„¶ä¸å¯ç”¨çš„æƒ…å†µä¸‹ï¼Œæ­¤æ—¶æ–°çš„è°ƒç”¨ä¸æ–­äº§ç”Ÿï¼ŒåŒæ—¶ä¼´éšç€è°ƒç”¨ç­‰å¾…å’Œå¤±è´¥é‡è¯•ï¼Œä¼šå¯¼è‡´ æœåŠ¡Cå¯¹æœåŠ¡Eçš„è°ƒç”¨è€Œäº§ç”Ÿå¤§é‡çš„ç§¯å‹ï¼Œæ…¢æ…¢ä¼šè€—å°½æœåŠ¡Cçš„èµ„æºï¼Œè¿›è€Œå¯¼è‡´æœåŠ¡Cä¹Ÿdownæ‰ï¼Œè¿™æ ·æ¶æ€§å¾ªç¯ä¸‹ï¼Œä¼šå½±å“åˆ°æ•´ä¸ªå¾®æœåŠ¡ä½“ç³»ï¼Œäº§ç”Ÿé›ªå´©æ•ˆåº”ã€‚ è™½ç„¶å¯¼è‡´é›ªå´©çš„å‘ç”Ÿä¸ä»…ä»…è¿™ä¸€ç§ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦é‡‡å–ä¸€å®šçš„æªæ–½ï¼Œæ¥ä¿è¯ä¸è®©è¿™ä¸ªå™©æ¢¦å‘ç”Ÿã€‚è€Œ hystrix-goå°±å¾ˆå¥½çš„æä¾›äº† ç†”æ–­å’Œé™çº§çš„æªæ–½ã€‚å®ƒçš„ä¸»è¦æ€æƒ³åœ¨äºï¼Œè®¾ç½®ä¸€äº›é˜€å€¼ï¼Œæ¯”å¦‚æœ€å¤§å¹¶å‘æ•°(å½“å¹¶å‘æ•°å¤§äºè®¾ç½®çš„å¹¶å‘æ•°ï¼Œæ‹¦æˆª)ï¼Œé”™è¯¯ç‡ç™¾åˆ†æ¯”(è¯·æ±‚æ•°é‡å¤§äºç­‰äºè®¾ç½® çš„é˜€å€¼ï¼Œå¹¶ä¸”é”™è¯¯ç‡è¾¾åˆ°è®¾ç½®çš„ç™¾åˆ†æ¯”æ—¶ï¼Œè§¦å‘ç†”æ–­)ä»¥åŠç†”æ–­å°è¯•æ¢å¤æ—¶é—´ç­‰ ã€‚
ä½¿ç”¨ hystrix-go çš„ä½¿ç”¨éå¸¸ç®€å•ï¼Œä½ å¯ä»¥è°ƒç”¨å®ƒçš„ Go æˆ–è€… Doæ–¹æ³•ï¼Œåªæ˜¯ Go æ–¹æ³•æ˜¯å¼‚æ­¥çš„æ–¹å¼ã€‚è€Œ Do æ–¹æ³•æ˜¯åŒæ­¥æ–¹å¼ã€‚æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„ä¾‹å­å¼€å¯ã€‚
_ = hystrix.Do(&amp;#34;wuqq&amp;#34;, func() error { // talk to other services 	_, err := http.</description>
			<content type="html"><![CDATA[<h2 id="å¼€ç¯‡">å¼€ç¯‡</h2>
<p>è¿™å‘¨åœ¨çœ‹å†…éƒ¨ä¸€ä¸ªç†”æ–­é™æµåŒ…æ—¶ï¼Œå‘ç°å®ƒæ˜¯åŸºäºä¸€ä¸ªå¼€æºé¡¹ç›® <code>hystrix-go</code> å®ç°äº†ï¼Œå› æ­¤æœ‰äº†è¿™ç¯‡æ–‡ç« ã€‚</p>
<h3 id="hystrix">Hystrix</h3>
<p><code>Hystrix</code> æ˜¯ç”± <code>Netflex </code> å¼€å‘çš„ä¸€æ¬¾å¼€æºç»„ä»¶ï¼Œæä¾›äº†åŸºç¡€çš„ç†”æ–­åŠŸèƒ½ã€‚ <code>Hystrix</code> å°†é™çº§çš„ç­–ç•¥å°è£…åœ¨ <code>Command</code> ä¸­ï¼Œæä¾›äº† <code>run</code> å’Œ <code>fallback</code> ä¸¤ä¸ªæ–¹æ³•ï¼Œå‰è€…è¡¨ç¤ºæ­£å¸¸çš„é€»è¾‘ï¼Œæ¯”å¦‚å¾®æœåŠ¡ä¹‹é—´çš„è°ƒç”¨&hellip;&hellip;ï¼Œå¦‚æœå‘ç”Ÿäº†æ•…éšœï¼Œå†æ‰§è¡Œ <code>fallback</code>æ–¹æ³•è¿”å›ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒç†è§£æˆä¿åº•æ“ä½œã€‚å¦‚æœæ­£å¸¸é€»è¾‘åœ¨çŸ­æ—¶é—´å†…é¢‘ç¹å‘ç”Ÿæ•…éšœï¼Œé‚£ä¹ˆå¯èƒ½ä¼šè§¦å‘çŸ­è·¯ï¼Œä¹Ÿå°±æ˜¯ä¹‹åçš„è¯·æ±‚ä¸å†æ‰§è¡Œ <code>run</code>,è€Œæ˜¯ç›´æ¥æ‰§è¡Œ  <code>fallback</code>ã€‚æ›´å¤šå…³äº <code>Hystrix</code> çš„ä¿¡æ¯å¯ä»¥æŸ¥çœ‹ <code>https://github.com/Netflix/Hystrix</code>ï¼Œè€Œ
<code>hystrix-go</code> åˆ™æ˜¯ç”¨ <code>go</code> å®ç°çš„ <code>hystrix</code> ç‰ˆï¼Œæ›´ç¡®åˆ‡çš„è¯´ï¼Œæ˜¯ç®€åŒ–ç‰ˆã€‚åªæ˜¯ä¸Šä¸€æ¬¡æ›´æ–°è¿˜æ˜¯ 2018å¹´ çš„ä¸€æ¬¡ <code>pr</code>,ä¹Ÿå°±æ¯•ä¸šäº†ï¼Ÿ</p>
<p>ä¸ºä»€ä¹ˆéœ€è¦è¿™äº›å·¥å…·ï¼Ÿ
æ¯”å¦‚ä¸€ä¸ªå¾®æœåŠ¡åŒ–çš„äº§å“çº¿ä¸Šï¼Œæ¯ä¸€ä¸ªæœåŠ¡éƒ½ä¸“æ³¨äºè‡ªå·±çš„ä¸šåŠ¡ï¼Œå¹¶å¯¹å¤–æä¾›ç›¸åº”çš„æœåŠ¡æ¥å£ï¼Œæˆ–è€…ä¾èµ–äºå¤–éƒ¨æœåŠ¡çš„æŸä¸ªé€»è¾‘æ¥å£ï¼Œå°±åƒä¸‹é¢è¿™æ ·ã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/27/26855/vZWmoZYanE.png!large" alt=""></p>
<p>å‡è®¾æˆ‘ä»¬å½“å‰æ˜¯ <code>æœåŠ¡A</code>ï¼Œæœ‰éƒ¨åˆ†é€»è¾‘ä¾èµ–äº <code>æœåŠ¡C</code>ï¼Œ<code>æœåŠ¡C</code> åˆä¾èµ–äº <code>æœåŠ¡E</code>,å½“å‰å¾®æœåŠ¡ä¹‹é—´è¿›è¡Œ <code>rpc</code>æˆ–è€… <code>http</code>é€šä¿¡ï¼Œå‡è®¾æ­¤æ—¶ <code>æœåŠ¡C</code> è°ƒç”¨ æœåŠ¡E å¤±è´¥,æ¯”å¦‚ç”±äºç½‘ç»œæ³¢åŠ¨å¯¼è‡´è¶…æ—¶æˆ–è€…æœåŠ¡Eç”±äºè¿‡è½½ï¼Œç³»ç»ŸE å·²ç»downæ‰äº†ã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/27/26855/0IuLV2g9Pk.png!large" alt=""></p>
<p>è°ƒç”¨å¤±è´¥ï¼Œä¸€èˆ¬ä¼šæœ‰å¤±è´¥é‡è¯•ç­‰æœºåˆ¶ã€‚ä½†æ˜¯å†æƒ³æƒ³ï¼Œå‡è®¾æœåŠ¡Eå·²ç„¶ä¸å¯ç”¨çš„æƒ…å†µä¸‹ï¼Œæ­¤æ—¶æ–°çš„è°ƒç”¨ä¸æ–­äº§ç”Ÿï¼ŒåŒæ—¶ä¼´éšç€è°ƒç”¨ç­‰å¾…å’Œå¤±è´¥é‡è¯•ï¼Œä¼šå¯¼è‡´ æœåŠ¡Cå¯¹æœåŠ¡Eçš„è°ƒç”¨è€Œäº§ç”Ÿå¤§é‡çš„ç§¯å‹ï¼Œæ…¢æ…¢ä¼šè€—å°½æœåŠ¡Cçš„èµ„æºï¼Œè¿›è€Œå¯¼è‡´æœåŠ¡Cä¹Ÿdownæ‰ï¼Œè¿™æ ·æ¶æ€§å¾ªç¯ä¸‹ï¼Œä¼šå½±å“åˆ°æ•´ä¸ªå¾®æœåŠ¡ä½“ç³»ï¼Œäº§ç”Ÿé›ªå´©æ•ˆåº”ã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/27/26855/OChf6d4cTz.png!large" alt=""></p>
<p>è™½ç„¶å¯¼è‡´é›ªå´©çš„å‘ç”Ÿä¸ä»…ä»…è¿™ä¸€ç§ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦é‡‡å–ä¸€å®šçš„æªæ–½ï¼Œæ¥ä¿è¯ä¸è®©è¿™ä¸ªå™©æ¢¦å‘ç”Ÿã€‚è€Œ <code>hystrix-go</code>å°±å¾ˆå¥½çš„æä¾›äº† ç†”æ–­å’Œé™çº§çš„æªæ–½ã€‚å®ƒçš„ä¸»è¦æ€æƒ³åœ¨äºï¼Œè®¾ç½®ä¸€äº›é˜€å€¼ï¼Œæ¯”å¦‚æœ€å¤§å¹¶å‘æ•°(å½“å¹¶å‘æ•°å¤§äºè®¾ç½®çš„å¹¶å‘æ•°ï¼Œæ‹¦æˆª)ï¼Œé”™è¯¯ç‡ç™¾åˆ†æ¯”(è¯·æ±‚æ•°é‡å¤§äºç­‰äºè®¾ç½® çš„é˜€å€¼ï¼Œå¹¶ä¸”é”™è¯¯ç‡è¾¾åˆ°è®¾ç½®çš„ç™¾åˆ†æ¯”æ—¶ï¼Œè§¦å‘ç†”æ–­)ä»¥åŠç†”æ–­å°è¯•æ¢å¤æ—¶é—´ç­‰ ã€‚</p>
<h3 id="ä½¿ç”¨">ä½¿ç”¨</h3>
<p><code>hystrix-go</code> çš„ä½¿ç”¨éå¸¸ç®€å•ï¼Œä½ å¯ä»¥è°ƒç”¨å®ƒçš„ <code>Go</code> æˆ–è€… <code>Do</code>æ–¹æ³•ï¼Œåªæ˜¯ <code>Go</code> æ–¹æ³•æ˜¯å¼‚æ­¥çš„æ–¹å¼ã€‚è€Œ <code>Do</code>  æ–¹æ³•æ˜¯åŒæ­¥æ–¹å¼ã€‚æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„ä¾‹å­å¼€å¯ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">_</span> <span class="p">=</span> <span class="nx">hystrix</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="s">&#34;wuqq&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// talk to other services
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;https://www.baidu.com/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;get error:%v&#34;</span><span class="p">,</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="kd">func</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;handle  error:%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span></code></pre></div><p><code>Do</code> å‡½æ•°éœ€è¦ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•° <code>commmand</code> åç§°ï¼Œä½ å¯ä»¥æŠŠæ¯ä¸ªåç§°å½“æˆä¸€ä¸ªç‹¬ç«‹å½“æœåŠ¡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å¤„ç†æ­£å¸¸çš„é€»è¾‘ï¼Œæ¯”å¦‚ <code>http</code> è°ƒç”¨æœåŠ¡ï¼Œè¿”å›å‚æ•°æ˜¯ <code>err</code>ã€‚å¦‚æœå¤„ç†|è°ƒç”¨å¤±è´¥ï¼Œé‚£ä¹ˆå°±æ‰§è¡Œç¬¬ä¸‰ä¸ªå‚æ•°é€»è¾‘ï¼Œ æˆ‘ä»¬ç§°ä¸ºä¿åº•æ“ä½œã€‚ç”±äºæœåŠ¡é”™è¯¯ç‡è¿‡é«˜å¯¼è‡´ç†”æ–­å™¨å¼€å¯ï¼Œé‚£ä¹ˆä¹‹åçš„è¯·æ±‚ä¹Ÿç›´æ¥å›è°ƒæ­¤å‡½æ•°ã€‚</p>
<p>æ—¢ç„¶ç†”æ–­å™¨æ˜¯æŒ‰ç…§é…ç½®çš„è§„åˆ™è€Œè¿›è¡Œæ˜¯å¦å¼€å¯çš„æ“ä½œï¼Œé‚£ä¹ˆæˆ‘ä»¬å½“ç„¶å¯ä»¥è®¾ç½®æˆ‘ä»¬æƒ³è¦çš„å€¼ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">hystrix</span><span class="p">.</span><span class="nf">ConfigureCommand</span><span class="p">(</span><span class="s">&#34;wuqq&#34;</span><span class="p">,</span> <span class="nx">hystrix</span><span class="p">.</span><span class="nx">CommandConfig</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Timeout</span><span class="p">:</span>                <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">MaxConcurrentRequests</span><span class="p">:</span>  <span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">SleepWindow</span><span class="p">:</span>            <span class="mi">5000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">RequestVolumeThreshold</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ErrorPercentThreshold</span><span class="p">:</span>  <span class="mi">30</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span> <span class="p">=</span> <span class="nx">hystrix</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="s">&#34;wuqq&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// talk to other services
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;https://www.baidu.com/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;get error:%v&#34;</span><span class="p">,</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="kd">func</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;handle  error:%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span></code></pre></div><p>ç¨å¾®è§£é‡Šä¸€ä¸‹ä¸Šé¢é…ç½®çš„å€¼å«ä¹‰:</p>
<ul>
<li>Timeout: æ‰§è¡Œ <code>command</code> çš„è¶…æ—¶æ—¶é—´ã€‚</li>
<li>MaxConcurrentRequestsï¼š<code>command</code> çš„æœ€å¤§å¹¶å‘é‡ ã€‚</li>
<li>SleepWindowï¼šå½“ç†”æ–­å™¨è¢«æ‰“å¼€åï¼Œ<code>SleepWindow</code> çš„æ—¶é—´å°±æ˜¯æ§åˆ¶è¿‡å¤šä¹…åå»å°è¯•æœåŠ¡æ˜¯å¦å¯ç”¨äº†ã€‚</li>
<li>RequestVolumeThresholdï¼š ä¸€ä¸ªç»Ÿè®¡çª—å£10ç§’å†…è¯·æ±‚æ•°é‡ã€‚è¾¾åˆ°è¿™ä¸ªè¯·æ±‚æ•°é‡åæ‰å»åˆ¤æ–­æ˜¯å¦è¦å¼€å¯ç†”æ–­</li>
<li>ErrorPercentThresholdï¼šé”™è¯¯ç™¾åˆ†æ¯”ï¼Œè¯·æ±‚æ•°é‡å¤§äºç­‰äº<code>RequestVolumeThreshold</code>å¹¶ä¸”é”™è¯¯ç‡åˆ°è¾¾è¿™ä¸ªç™¾åˆ†æ¯”åå°±ä¼šå¯åŠ¨<code>ç†”æ–­</code></li>
</ul>
<p>å½“ç„¶ä½ ä¸è®¾ç½®çš„è¯ï¼Œé‚£ä¹ˆè‡ªåŠ¨èµ°çš„é»˜è®¤å€¼ã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/27/26855/VX87CNHDs1.png!large" alt=""></p>
<p>æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">   <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="s">&#34;github.com/afex/hystrix-go/hystrix&#34;</span> <span class="s">&#34;net/http&#34;</span> <span class="s">&#34;time&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Handle</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">Handle</span><span class="p">)</span> <span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">r</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">request</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">h</span><span class="p">.</span><span class="nf">Common</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">Handle</span><span class="p">)</span> <span class="nf">Common</span><span class="p">(</span><span class="nx">r</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">request</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">hystrix</span><span class="p">.</span><span class="nf">ConfigureCommand</span><span class="p">(</span><span class="s">&#34;mycommand&#34;</span><span class="p">,</span> <span class="nx">hystrix</span><span class="p">.</span><span class="nx">CommandConfig</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">Timeout</span><span class="p">:</span>                <span class="nb">int</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nx">MaxConcurrentRequests</span><span class="p">:</span>  <span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">SleepWindow</span><span class="p">:</span>            <span class="mi">5000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">RequestVolumeThreshold</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">ErrorPercentThreshold</span><span class="p">:</span>  <span class="mi">30</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="p">})</span>
</span></span><span class="line"><span class="cl">   <span class="nx">msg</span> <span class="o">:=</span> <span class="s">&#34;success&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">_</span> <span class="p">=</span> <span class="nx">hystrix</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="s">&#34;mycommand&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;https://www.baidu.com&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;è¯·æ±‚å¤±è´¥:%v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span> <span class="kd">func</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;handle  error:%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">msg</span> <span class="p">=</span> <span class="s">&#34;error&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">   <span class="nx">r</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">msg</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8090&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">Handle</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬å¼€å¯äº†ä¸€ä¸ª <code>http</code> æœåŠ¡ï¼Œç›‘å¬ç«¯å£å· <code>8090</code>ï¼Œæ‰€æœ‰è¯·æ±‚çš„å¤„ç†é€»è¾‘éƒ½åœ¨  <code>Common </code> æ–¹æ³•ä¸­ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦æ˜¯å‘èµ·ä¸€æ¬¡ <code>http</code>è¯·æ±‚ï¼Œè¯·æ±‚æˆåŠŸå“åº”<code> success</code>,å¦‚æœå¤±è´¥ï¼Œå“åº”å¤±è´¥åŸå› ã€‚</p>
<p>æˆ‘ä»¬å†å†™å¦ä¸€ä¸ªç®€å•ç¨‹åºï¼Œå¹¶å‘ <code>11</code> æ¬¡çš„è¯·æ±‚ <code>8090</code> ç«¯å£ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;io/ioutil&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;net/http&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;sync&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Client</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tr</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Transport</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">MaxIdleConns</span><span class="p">:</span>    <span class="mi">100</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">IdleConnTimeout</span><span class="p">:</span> <span class="mi">1</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">client</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Client</span><span class="p">{</span><span class="nx">Transport</span><span class="p">:</span> <span class="nx">tr</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">info</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Data</span> <span class="kd">interface</span><span class="p">{}</span> <span class="s">`json:&#34;data&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">11</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">int2</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">req</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">NewRequest</span><span class="p">(</span><span class="s">&#34;GET&#34;</span><span class="p">,</span> <span class="s">&#34;http://localhost:8090&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;åˆå§‹åŒ–httpå®¢æˆ·ç«¯å¤„é”™è¯¯:%v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;åˆå§‹åŒ–httpå®¢æˆ·ç«¯å¤„é”™è¯¯:%v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">defer</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">nByte</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadAll</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;è¯»å–httpæ•°æ®å¤±è´¥:%v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;æ¥æ”¶åˆ°åˆ°å€¼:%v\n&#34;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">nByte</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">}(</span><span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;è¯·æ±‚å®Œæ¯•\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ç”±äºæˆ‘ä»¬é…ç½® <code>MaxConcurrentRequests</code> ä¸º10ï¼Œé‚£ä¹ˆæ„å‘³ç€è¿˜æœ‰ä¸ª g è¯·æ±‚ä¼šå¤±è´¥:
<img src="https://cdn.learnku.com/uploads/images/202012/27/26855/lUriDTdjlP.png!large" alt="">
å’Œæˆ‘ä»¬æƒ³çš„ä¸€æ ·ã€‚</p>
<p>æ¥ç€æˆ‘ä»¬æŠŠç½‘ç»œæ–­å¼€ï¼Œå¹¶å‘è¯·æ±‚æ”¹æˆ10æ¬¡ã€‚å†æ¬¡è¿è¡Œç¨‹åºå¹¶å‘è¯·æ±‚ <code>8090</code> ç«¯å£ï¼Œæ­¤æ—¶ç”±äºç½‘ç»œå·²å…³é—­ï¼Œå¯¼è‡´è¯·æ±‚ç™¾åº¦å¤±è´¥ï¼š
<img src="https://cdn.learnku.com/uploads/images/202012/27/26855/I2axDFfuxj.png!large" alt="">
æ¥ç€ç»§ç»­è¯·æ±‚ï¼š
<img src="https://cdn.learnku.com/uploads/images/202012/27/26855/LzJiOB1FZb.png!large" alt="">
ç†”æ–­å™¨å·²å¼€å¯ï¼Œä¸Šé¢æˆ‘ä»¬é…ç½®çš„<code>RequestVolumeThreshold</code> å’Œ <code>ErrorPercentThreshold</code> ç”Ÿæ•ˆã€‚</p>
<p>ç„¶åæˆ‘ä»¬æŠŠç½‘è¿ä¸Šï¼Œäº”ç§’å (<code>SleepWindow</code>çš„å€¼)ç»§ç»­å¹¶å‘è°ƒç”¨ï¼Œå½“å‰ç†”æ–­å™¨å¤„äºåŠå¼€çš„çŠ¶æ€ï¼Œæ­¤æ—¶è¯·æ±‚å…è®¸è°ƒç”¨ä¾èµ–ï¼Œå¦‚æœæˆåŠŸåˆ™å…³é—­ï¼Œå¤±è´¥åˆ™ç»§ç»­å¼€å¯ç†”æ–­å™¨ã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/27/26855/BqrjYC5RJW.png!large" alt="">
å¯ä»¥çœ‹åˆ°ï¼Œæœ‰ä¸€ä¸ªæˆåŠŸäº†ï¼Œé‚£ä¹ˆæ­¤æ—¶ç†”æ–­å™¨å·²å…³é—­ï¼Œæ¥ä¸‹æ¥ç»§ç»­è¿è¡Œå‡½æ•°å¹¶å‘è°ƒç”¨ï¼š
<img src="https://cdn.learnku.com/uploads/images/202012/27/26855/yMb2jZVBOl.png!large" alt="">
å¯ä»¥çœ‹åˆ°ï¼Œ10ä¸ªéƒ½å·²ç»æ˜¯æ­£å¸¸æˆåŠŸçš„çŠ¶æ€äº†ã€‚</p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œä¸ºä»€ä¹ˆæœ€ä¸Šé¢çš„å›¾åªæœ‰ä¸€ä¸ªæ˜¯æˆåŠŸçš„ï¼Ÿ5ç§’å·²ç»è¿‡äº†ï¼Œå¹¶ä¸”å½“å‰ç½‘ç»œæ­£å¸¸ï¼Œåº”è¯¥æ˜¯10ä¸ªè¯·æ±‚éƒ½æˆåŠŸï¼Œä½†æ˜¯æˆ‘ä»¬çœ‹åˆ°çš„åªæœ‰ä¸€ä¸ªæ˜¯æˆåŠŸçŠ¶æ€ã€‚é€šè¿‡æºç æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ç­”æ¡ˆ:
å…·ä½“é€»è¾‘åœ¨åˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯å¦å¯ä»¥è°ƒç”¨ä¾èµ–</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">!</span><span class="nx">cmd</span><span class="p">.</span><span class="nx">circuit</span><span class="p">.</span><span class="nf">AllowRequest</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="o">......</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">circuit</span> <span class="o">*</span><span class="nx">CircuitBreaker</span><span class="p">)</span> <span class="nf">AllowRequest</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="p">!</span><span class="nx">circuit</span><span class="p">.</span><span class="nf">IsOpen</span><span class="p">()</span> <span class="o">||</span> <span class="nx">circuit</span><span class="p">.</span><span class="nf">allowSingleTest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">circuit</span> <span class="o">*</span><span class="nx">CircuitBreaker</span><span class="p">)</span> <span class="nf">allowSingleTest</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">circuit</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">circuit</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">now</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">UnixNano</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">openedOrLastTestedTime</span> <span class="o">:=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">LoadInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">circuit</span><span class="p">.</span><span class="nx">openedOrLastTestedTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">circuit</span><span class="p">.</span><span class="nx">open</span> <span class="o">&amp;&amp;</span> <span class="nx">now</span> <span class="p">&gt;</span> <span class="nx">openedOrLastTestedTime</span><span class="o">+</span><span class="nf">getSettings</span><span class="p">(</span><span class="nx">circuit</span><span class="p">.</span><span class="nx">Name</span><span class="p">).</span><span class="nx">SleepWindow</span><span class="p">.</span><span class="nf">Nanoseconds</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">/</span>
</span></span><span class="line"><span class="cl">		<span class="nx">swapped</span> <span class="o">:=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">CompareAndSwapInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">circuit</span><span class="p">.</span><span class="nx">openedOrLastTestedTime</span><span class="p">,</span> <span class="nx">openedOrLastTestedTime</span><span class="p">,</span> <span class="nx">now</span><span class="p">)</span> <span class="c1">//è¿™ä¸€å¥æ‰æ˜¯å…³é”®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">swapped</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;hystrix-go: allowing single test to possibly close circuit %v&#34;</span><span class="p">,</span> <span class="nx">circuit</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">swapped</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¿™æ®µä»£ç é¦–å…ˆåˆ¤æ–­äº†ç†”æ–­å™¨æ˜¯å¦å¼€å¯ï¼Œå¹¶ä¸”å½“å‰æ—¶é—´å¤§äº ä¸Šä¸€æ¬¡å¼€å¯ç†”æ–­å™¨çš„æ—¶é—´+ <code>SleepWindow</code> çš„æ—¶é—´ï¼Œå¦‚æœæ¡ä»¶éƒ½ç¬¦åˆçš„è¯ï¼Œæ›´æ–°æ­¤ç†”æ–­å™¨æœ€æ–°çš„ <code>openedOrLastTestedTime </code> ,æ˜¯é€šè¿‡  <code>CompareAndSwapInt64 </code> åŸå­æ“ä½œå®Œæˆçš„ï¼Œæ„å¤–ç€å¿…ç„¶åªä¼šæœ‰ä¸€ä¸ªæˆåŠŸã€‚
æ­¤æ—¶ç†”æ–­å™¨è¿˜æ˜¯åŠå¼€çš„çŠ¶æ€ï¼Œæ¥ç€å¦‚æœèƒ½æ‹¿åˆ°ä»¤ç‰Œï¼Œæ‰§è¡Œ<code>run</code> å‡½æ•°ï¼ˆä¹Ÿå°±æ˜¯Doä¼ å…¥çš„ç¬¬äºŒä¸ªç®€å•å°è£…åçš„å‡½æ•°ï¼‰ï¼Œå‘èµ· <code>http</code> è¯·æ±‚ï¼Œå¦‚æœæˆåŠŸï¼Œä¸ŠæŠ¥æˆåŠŸçŠ¶æ€ï¼Œå…³é—­ç†”æ–­å™¨ã€‚å¦‚æœå¤±è´¥ï¼Œé‚£ä¹ˆç†”æ–­å™¨ä¾æ—§å¼€å¯ã€‚
<img src="https://cdn.learnku.com/uploads/images/202012/27/26855/sLDxoIvR4J.png!large" alt=""></p>
<p><img src="https://cdn.learnku.com/uploads/images/202012/27/26855/ChLKeOHULy.png!large" alt="hystrix-goæºç è§£æ"></p>
<p>ä»¥ä¸Šå°±æ˜¯å¤§ä½“çš„æµç¨‹è®²è§£ï¼Œä¸‹ä¸€ç¯‡æ–‡ç« å°†è§£è¯»æ ¸å¿ƒæºç ä»¥åŠè¿›ä¸€æ­¥å½“æ€è€ƒã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>etcd å®æˆ˜åŸºç¡€ç¯‡(ä¸€) </title>
			<link>https://www.syst.top/posts/go/etcd-2021-04-10/</link>
			<pubDate>Sat, 10 Apr 2021 09:54:52 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/etcd-2021-04-10/</guid>
			<description>æœ€è¿‘ä¸€ç›´åœ¨çœ‹ etcd ç›¸å…³çš„ä¸œè¥¿ï¼Œä¸ºäº†ä¸&amp;quot;ç™½çœ‹&amp;quot;ï¼ŒåŠ æ·±ç†è§£ï¼Œéšå³å¼€å¯æ­¤ç³»åˆ—çš„è¾“å‡ºã€‚
Etcdæ˜¯ä»€ä¹ˆ Etcd æ˜¯ç”± Go ç¼–å†™çš„ã€‚å®ƒæ˜¯ä¸€ä¸ªå¼ºä¸€è‡´æ€§çš„åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨ï¼Œæä¾›ä¸€ç§å¯é çš„æ–¹å¼æ¥å­˜å‚¨éœ€è¦ç”±åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–è€…æœºå™¨é›†ç¾¤è®¿é—®çš„æ•°æ®ã€‚ åŒæ—¶ Etcd å„èŠ‚ç‚¹ä¸­çš„é€šä¿¡æ˜¯é€šè¿‡ Raft ä¸€è‡´æ€§ç®—æ³•æ¥å¤„ç†çš„ã€‚ æœ‰å¾ˆå¤šå¤§å‹å¼€æºé¡¹ç›®çš„åº•å±‚éƒ½åŸºäº Etcdï¼Œä¸¾å‡ ä¸ªæ¯”è¾ƒæœ‰åçš„å·¥ä¸šçº§é¡¹ç›®:kubernetesã€ CoreDNSã€ROOK&amp;hellip;&amp;hellip;
Etcd çš„åœºæ™¯  æœåŠ¡å‘ç°ã€‚(å¯ä»¥æŠŠæœåŠ¡å­˜å‚¨åˆ°æŸä¸ª prefix å¼€å¤´çš„ keyä¸­ï¼Œç„¶åæ¶ˆè´¹ç«¯æˆ–è€…æœåŠ¡ä¿¡æ¯ä»¥è°ƒç”¨ï¼Œ åŒæ—¶æ¶ˆè´¹è€…ä¹Ÿå¯ä»¥é€šè¿‡ watch è·å¾— key çš„å˜åŒ–) æ¶ˆæ¯åˆ†å¸ƒå’Œè®¢é˜… åˆ†å¸ƒå¼é” Leader é€‰ä¸¾ åˆ†å¸ƒå¼é˜Ÿåˆ— è´Ÿè½½å‡è¡¡ &amp;hellip;&amp;hellip;  å’Œ redis çš„åŒºåˆ« é¢è¯•çš„æ—¶å€™å¯èƒ½æœ‰é¢è¯•å®˜å–œæ¬¢é—®ï¼Œ
 redis çš„æ•°æ®ç±»å‹æ›´ä¸°å¯Œ(string, hash, set ,zset, list)ï¼Œetcd ä»…ä»…å°±æ˜¯ key-valã€‚ etcd çš„åº•å±‚æ˜¯ Raft ç®—æ³•ï¼Œå¯ä»¥ä¿è¯æ•°æ®çš„å¼ºä¸€è‡´æ€§ã€‚è€Œ redis æ•°æ®å¤åˆ¶ä¸Šæ˜¯ä¸»å¤‡å¼‚æ­¥å¤åˆ¶ï¼Œåªèƒ½æœ€ç»ˆä¸€è‡´æ€§ã€‚ è¯»å†™æ€§èƒ½ä¸Šï¼Œå› ä¸º etcd ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œæ‰€ä»¥ä¼šæ¯” redis å·®ã€‚ å­˜å‚¨æ–¹é¢ï¼Œetcd ä½¿ç”¨çš„æ˜¯æŒä¹…åŒ–å­˜å‚¨boltdbï¼Œè€Œ redis çš„æ–¹æ¡ˆæ˜¯å¯æŒä¹…åŒ–çš„ aof/rdb -&amp;hellip;&amp;hellip;  ç¯å¢ƒä¸è¯´æ˜ ç›´æ¥ä¸‹è½½ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¹Ÿå¥½ï¼Œè¿˜æ˜¯è‡ªå·±ä¸‹è½½æºç ç¼–è¯‘è¿è¡Œï¼Œå…ˆå¼€å¯ä¸€ä¸ªå•èŠ‚ç‚¹æœåŠ¡å°±è¡Œã€‚æˆ‘æœ¬åœ°ä½¿ç”¨ goreman æ­å»ºäº†ä¸‰ä¸ªå®ä¾‹ã€‚ è¿™é‡Œç¨å¾®è¯´æ˜ä¸€ä¸‹:PEER ADDRS æŒ‡çš„æ˜¯å‘å…¶ä»– etcd server æš´éœ²çš„é€šä¿¡åœ°å€,æ¯”å¦‚ä¸Šå›¾ name=infra1 è¦è°ƒç”¨ infra2ï¼Œ è°ƒç”¨çš„å°±æ˜¯ http://127.</description>
			<content type="html"><![CDATA[<p>æœ€è¿‘ä¸€ç›´åœ¨çœ‹ etcd ç›¸å…³çš„ä¸œè¥¿ï¼Œä¸ºäº†ä¸&quot;ç™½çœ‹&quot;ï¼ŒåŠ æ·±ç†è§£ï¼Œéšå³å¼€å¯æ­¤ç³»åˆ—çš„è¾“å‡ºã€‚</p>
<h3 id="etcdæ˜¯ä»€ä¹ˆ">Etcdæ˜¯ä»€ä¹ˆ</h3>
<p>Etcd æ˜¯ç”± Go ç¼–å†™çš„ã€‚å®ƒæ˜¯ä¸€ä¸ªå¼ºä¸€è‡´æ€§çš„åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨ï¼Œæä¾›ä¸€ç§å¯é çš„æ–¹å¼æ¥å­˜å‚¨éœ€è¦ç”±åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–è€…æœºå™¨é›†ç¾¤è®¿é—®çš„æ•°æ®ã€‚ åŒæ—¶ Etcd å„èŠ‚ç‚¹ä¸­çš„é€šä¿¡æ˜¯é€šè¿‡ Raft ä¸€è‡´æ€§ç®—æ³•æ¥å¤„ç†çš„ã€‚
æœ‰å¾ˆå¤šå¤§å‹å¼€æºé¡¹ç›®çš„åº•å±‚éƒ½åŸºäº Etcdï¼Œä¸¾å‡ ä¸ªæ¯”è¾ƒæœ‰åçš„å·¥ä¸šçº§é¡¹ç›®:kubernetesã€ CoreDNSã€ROOK&hellip;&hellip;</p>
<h3 id="etcd-çš„åœºæ™¯">Etcd çš„åœºæ™¯</h3>
<ul>
<li>æœåŠ¡å‘ç°ã€‚(å¯ä»¥æŠŠæœåŠ¡å­˜å‚¨åˆ°æŸä¸ª prefix å¼€å¤´çš„ keyä¸­ï¼Œç„¶åæ¶ˆè´¹ç«¯æˆ–è€…æœåŠ¡ä¿¡æ¯ä»¥è°ƒç”¨ï¼Œ åŒæ—¶æ¶ˆè´¹è€…ä¹Ÿå¯ä»¥é€šè¿‡ watch è·å¾— key çš„å˜åŒ–)</li>
<li>æ¶ˆæ¯åˆ†å¸ƒå’Œè®¢é˜…</li>
<li>åˆ†å¸ƒå¼é”</li>
<li>Leader é€‰ä¸¾</li>
<li>åˆ†å¸ƒå¼é˜Ÿåˆ—</li>
<li>è´Ÿè½½å‡è¡¡</li>
<li>&hellip;&hellip;</li>
</ul>
<h3 id="å’Œ-redis-çš„åŒºåˆ«">å’Œ redis çš„åŒºåˆ«</h3>
<p>é¢è¯•çš„æ—¶å€™å¯èƒ½æœ‰é¢è¯•å®˜å–œæ¬¢é—®ï¼Œ</p>
<ul>
<li>redis çš„æ•°æ®ç±»å‹æ›´ä¸°å¯Œ(string, hash, set ,zset, list)ï¼Œetcd ä»…ä»…å°±æ˜¯ key-valã€‚</li>
<li>etcd çš„åº•å±‚æ˜¯ Raft ç®—æ³•ï¼Œå¯ä»¥ä¿è¯æ•°æ®çš„å¼ºä¸€è‡´æ€§ã€‚è€Œ redis æ•°æ®å¤åˆ¶ä¸Šæ˜¯ä¸»å¤‡å¼‚æ­¥å¤åˆ¶ï¼Œåªèƒ½æœ€ç»ˆä¸€è‡´æ€§ã€‚</li>
<li>è¯»å†™æ€§èƒ½ä¸Šï¼Œå› ä¸º etcd ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œæ‰€ä»¥ä¼šæ¯” redis å·®ã€‚</li>
<li>å­˜å‚¨æ–¹é¢ï¼Œetcd ä½¿ç”¨çš„æ˜¯æŒä¹…åŒ–å­˜å‚¨boltdbï¼Œè€Œ redis çš„æ–¹æ¡ˆæ˜¯å¯æŒä¹…åŒ–çš„ aof/rdb
-&hellip;&hellip;</li>
</ul>
<h3 id="ç¯å¢ƒä¸è¯´æ˜">ç¯å¢ƒä¸è¯´æ˜</h3>
<p>ç›´æ¥ä¸‹è½½ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¹Ÿå¥½ï¼Œè¿˜æ˜¯è‡ªå·±ä¸‹è½½æºç ç¼–è¯‘è¿è¡Œï¼Œå…ˆå¼€å¯ä¸€ä¸ªå•èŠ‚ç‚¹æœåŠ¡å°±è¡Œã€‚æˆ‘æœ¬åœ°ä½¿ç”¨ goreman æ­å»ºäº†ä¸‰ä¸ªå®ä¾‹ã€‚
<img src="https://image.syst.top/image/etcd/peer.png" alt="image">
è¿™é‡Œç¨å¾®è¯´æ˜ä¸€ä¸‹:<code>PEER ADDRS</code> æŒ‡çš„æ˜¯å‘å…¶ä»– <code>etcd server</code> æš´éœ²çš„é€šä¿¡åœ°å€,æ¯”å¦‚ä¸Šå›¾ <code>name=infra1</code> è¦è°ƒç”¨ <code>infra2</code>ï¼Œ
è°ƒç”¨çš„å°±æ˜¯ <code>http://127.0.0.1:22380</code>ã€‚ è€Œ <code>CLIENT ADDRS</code> æ˜¯å¯¹å®¢æˆ·ç«¯æš´éœ²çš„åœ°å€ã€‚æ¯”å¦‚æ¥ä¸‹æ¥æˆ‘ä»¬çš„å®¢æˆ·ç«¯è¿æ¥çš„æ˜¯ <code>infra1</code>ï¼Œä½¿ç”¨çš„å°±æ˜¯ <code>http://127.0.0.1:2379</code>ã€‚</p>
<p>ç›®å‰ç½‘ä¸Šçš„æ•™ç¨‹å¤§å¤šä½¿ç”¨ç¼–è¯‘å¥½çš„ etcdctl è¿™æ ·çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œé€šè¿‡å‘½ä»¤è¡Œæ¥è¿›è¡Œæ“ä½œ,ç®€å•ç›´è§‚ã€‚æ¯”å¦‚:
<img src="https://image.syst.top/image/etcd/etcd-ctl.png" alt="image"></p>
<p>ä½†æ˜¯ä¹Ÿä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼Œä½ å¹¶ä¸çŸ¥é“å®¢æˆ·ç«¯åº•å±‚æ˜¯å¦‚ä½•è¿è¡Œçš„ï¼Œè¿™ä¸­é—´åˆæ¶‰åŠäº†å“ªäº›æ¥å£ï¼Œå¯¹åº”çš„æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆæ ·çš„ã€‚ æ‰€ä»¥ä¸ºäº†ä¸€æ­¥æ­¥æ·±å…¥ etcdï¼Œæˆ‘ä»¬ä»ä»£ç å±‚é¢æ“ä½œ etcd å®¢æˆ·ç«¯ã€‚</p>
<p>ä»¥ä¸‹æ˜¯æœ¬ç¯‡æ–‡ç« æ¶‰åŠåˆ°çš„å…¨éƒ¨ä»£ç ,ä¸‹é¢æˆ‘ä»¬å¼€å§‹åˆ†å—è®²è§£.</p>
<h3 id="åˆå§‹åŒ–-etcd-å®¢æˆ·ç«¯">åˆå§‹åŒ– etcd å®¢æˆ·ç«¯</h3>
<p>æˆ‘ä»¬å…ˆåˆå§‹åŒ–ä¸€ä¸ª etcd å®¢æˆ·ç«¯</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">addr</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;addr&#34;</span><span class="p">,</span> <span class="s">&#34;http://127.0.0.1:2379&#34;</span><span class="p">,</span> <span class="s">&#34;etcd address&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">cli</span> <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">Client</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// åˆå§‹åŒ–etcd å®¢æˆ·ç«¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// è§£æetcdçš„åœ°å€ï¼Œç¼–ç¨‹[]string
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">endpoints</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="o">*</span><span class="nx">addr</span><span class="p">,</span> <span class="s">&#34;,&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// åˆ›å»ºä¸€ä¸ª etcd çš„å®¢æˆ·ç«¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">cli</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span><span class="nx">Endpoints</span><span class="p">:</span> <span class="nx">endpoints</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">DialTimeout</span><span class="p">:</span> <span class="mi">5</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;åˆå§‹åŒ–å®¢æˆ·ç«¯å¤±è´¥:%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="put-æ“ä½œ">put æ“ä½œ</h3>
<p>å‘½ä»¤è¡Œ <code>etcdctl put key val</code> å¯¹åº”æ“ä½œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// è®¾ç½®key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">PutKey</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">value</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">resp</span> <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">PutResponse</span>
</span></span><span class="line"><span class="cl">	<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;è®¾ç½® key å¤±è´¥:%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;æ“ä½œç»“æœï¼š%v\n&#34;</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>é™¤äº†ç®€å•çš„è®¾ç½®ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ç§ç§Ÿçº¦æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯è®¾ç½®ä¸€ä¸ªkeyçš„æœ‰æ•ˆæœŸï¼Œåœ¨æœ‰æ•ˆæœŸä¹‹å†…å¯ä»¥è¿›è¡Œç»­ç§Ÿï¼Œå¦‚æœæ²¡ç»­ç§Ÿåˆ°æœŸå°±è¿‡æœŸã€‚ å¯¹åº”çš„å‘½ä»¤è¡Œæ˜¯åˆ†ä¸¤æ®µ:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">etcdctl</span> <span class="nx">lease</span> <span class="nx">grant</span> <span class="mi">200</span>
</span></span><span class="line"><span class="cl"><span class="c1">// lease 326978bac638650a granted with TTL(200s)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">etcdctl</span> <span class="nx">put</span> <span class="nx">hello</span> <span class="nx">world</span> <span class="o">--</span><span class="nx">lease</span><span class="p">=</span><span class="mi">326978</span><span class="nx">bac638650a</span>
</span></span></code></pre></div><p>å¯¹åº”æ“ä½œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// è®¾ç½®ä¼šè¿‡æœŸçš„key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">PutKeyLease</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">value</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">ttl</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">resp</span> <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">PutResponse</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// åˆ›å»ºä¸€ä¸ªç§Ÿçº¦å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">lease</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nx">Lease</span>
</span></span><span class="line"><span class="cl">	<span class="nx">lease</span> <span class="p">=</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nf">NewLease</span><span class="p">(</span><span class="nx">cli</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">leaseResp</span> <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">LeaseGrantResponse</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// æ ¹æ®æ—¶é—´ï¼Œç”Ÿæˆä¸€ä¸ªç§Ÿçº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">leaseResp</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">lease</span><span class="p">.</span><span class="nf">Grant</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">ttl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;è®¾ç½® ç§Ÿçº¦ å¤±è´¥:%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nf">WithLease</span><span class="p">(</span><span class="nx">leaseResp</span><span class="p">.</span><span class="nx">ID</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;è®¾ç½® key å¤±è´¥:%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;æ“ä½œç»“æœï¼š%v\n&#34;</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>etcd çš„ç§Ÿçº¦æ¨¡å¼ï¼Œç®€å•çš„è¯´ï¼Œ å½“ Lease server æ”¶åˆ° client è¯·æ±‚ï¼Œæ¯”å¦‚ä¸Šé¢åˆ›å»ºä¸€ä¸ªæœ‰æ•ˆæœŸ200ç§’çš„è¯·æ±‚ï¼Œä¼šé€šè¿‡ Raft
æ¨¡å—å®Œæˆæ—¥å¿—åŒæ­¥ï¼Œ éšå Apply æ¨¡å—çš„ Grant æ¥å£æ‰§è¡Œæ—¥å¿—æ¡ç›®å†…å®¹ã€‚è¿™æ˜¯åç»­æˆ‘ä»¬è¦ç ”ç©¶çš„ï¼Œè¿™é‡Œç•¥å¾®æä¸€ä¸‹ã€‚</p>
<p>é¦–å…ˆä½ å¾—åˆ›å»ºä¸€ä¸ª Lease(ç§Ÿçº¦)ï¼Œè·å–åˆ°ä¸€ä¸ª Lease å”¯ä¸€idï¼Œç„¶å put çš„æ—¶å€™å¸¦ä¸Šè¿™ä¸ª idã€‚å½“ä¸€ä¸ª key æŒ‡å®šä¸€ä¸ª Lease çš„æ—¶å€™ï¼Œ
åº•å±‚æœ€ç»ˆæ˜¯ä¼šæŠŠè¿™ä¸ª key å…³è”åˆ° Lease çš„å†…å­˜é›†åˆä¸­ã€‚æ‰€ä»¥æœ¬è´¨ä¸Šï¼Œä¸€ä¸ª Lease å¯ä»¥ å…³è” n ä¸ª keyã€‚è€Œæˆ‘ä»¬å¹³å¸¸ä½¿ç”¨çš„ç¼“å­˜ key è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œä¸€èˆ¬æ˜¯æŠŠ key å’Œè¿‡æœŸæ—¶é—´ä¸€å¯¹ä¸€ç»‘å®šã€‚</p>
<p>å¯èƒ½æœ‰äººè¿˜è¦é—®ï¼ŒLease åˆ°æœŸäº†æ˜¯å¦‚ä½•åˆ é™¤æ‰å…³è”çš„ keyï¼Ÿ</p>
<p>å…¶å®åŸç†è¯´èµ·æ¥ä¹Ÿå¾ˆç®€å•ã€‚Lease åœ¨åº•å±‚å­˜å‚¨çš„ç»“æ„æ˜¯å †ã€‚ç”±ä¸€ä¸ªå¼‚æ­¥çš„ G ä¸“é—¨è´Ÿè´£çš„å»æ·˜æ±°è¿‡æœŸçš„ Leaseã€‚å®šæ—¶ä»æœ€å°å †ä¸­å–å‡ºå·²ç»åˆ°æœŸçš„ Leaseã€‚ ç„¶ååˆ é™¤ Lease ä»¥åŠ åˆ é™¤é€šè¿‡ LeaseId å…³è”ä¸Šæ­¤ Lease çš„
key åˆ—è¡¨ã€‚åé¢æˆ‘ä»¬åˆ†ææºç çš„æ—¶å€™ä¸“é—¨è®¨è®ºè¿™å—ã€‚</p>
<p>è¿™é‡Œæˆ‘è¿˜è¦è¯´ä¸€ç‚¹ï¼Œä½ å¯ä»¥çœ‹åˆ°ï¼Œä¸ç®¡æ˜¯ put ä¸€ä¸ªæ™®é€šçš„ keyï¼Œè¿˜æ˜¯ä¸€ä¸ªå¸¦æœ‰ç§Ÿçº¦çš„ keyï¼Œè°ƒç”¨çš„éƒ½æ˜¯åŒä¸€ä¸ªæ–¹æ³•ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// æ™®é€šçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// ç§Ÿçº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nf">WithLease</span><span class="p">(</span><span class="nx">leaseResp</span><span class="p">.</span><span class="nx">ID</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"><span class="c1">// æºç é‡Œé¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">OpOption</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">Op</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">WithLease</span><span class="p">(</span><span class="nx">leaseID</span> <span class="nx">LeaseID</span><span class="p">)</span> <span class="nx">OpOption</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">op</span> <span class="o">*</span><span class="nx">Op</span><span class="p">)</span> <span class="p">{</span> <span class="nx">op</span><span class="p">.</span><span class="nx">leaseID</span> <span class="p">=</span> <span class="nx">leaseID</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">op</span> <span class="o">*</span><span class="nx">Op</span><span class="p">)</span> <span class="nf">applyOpts</span><span class="p">(</span><span class="nx">opts</span> <span class="p">[]</span><span class="nx">OpOption</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">opt</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">opts</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">opt</span><span class="p">(</span><span class="nx">op</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>çœ‹å‡ºæ¥äº†å—ï¼Ÿä¸€ä¸ªå¾ˆå¸¸è§çš„è®¾è®¡æ¨¡å¼ï¼Œè£…é¥°å™¨ã€‚</p>
<h3 id="get-æ“ä½œ">Get æ“ä½œ</h3>
<p>å‘½ä»¤è¡Œ <code>etcdctl get key</code> å¯¹åº”æ“ä½œ,</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">GetKey</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">res</span> <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">GetResponse</span>
</span></span><span class="line"><span class="cl">	<span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;è·å– key å¤±è´¥ :%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;key %v çš„å€¼æ˜¯ï¼š%+v\n&#34;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œetcdä» v3 å¼€å§‹ï¼Œåº•å±‚å®ç°äº† MVCC æœºåˆ¶ã€‚æ‰€ä»¥åœ¨ etcd ä¸­çš„ key æ˜¯å­˜åœ¨å¤šä¸ªå†å²ç‰ˆæœ¬çš„ã€‚
æˆ‘ä»¬ä¼šåœ¨å‘½ä»¤è¡Œä¸­ <code>etcdctl get hello --rev=?</code>,æ¯”å¦‚
<img src="https://image.syst.top/image/etcd/rev-1.png" alt="image">
å¯ä»¥çœ‹åˆ°ï¼Œä¸åŒç‰ˆæœ¬çš„ key(&ldquo;hello&rdquo;)çš„å€¼æ˜¯ä¸ä¸€æ ·çš„ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// è·å–æŒ‡å®šç‰ˆæœ¬çš„key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">GetKeyByVersion</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">version</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">res</span> <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">GetResponse</span>
</span></span><span class="line"><span class="cl">	<span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nf">WithRev</span><span class="p">(</span><span class="nx">version</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;åˆ é™¤ key:%v å¤±è´¥:%v&#34;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;è¯·æ±‚key:%v,è¯·æ±‚ç‰ˆæœ¬:%v,è·å–ç»“æœï¼š%+v\n&#34;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">version</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span>
</span></span></code></pre></div><p>ä¸€æ ·çš„å¥—è·¯ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥è¿è¡Œè¿™æ®µä»£ç æ¼”ç¤ºä¸€ä¸‹ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">src</span><span class="p">.</span><span class="nf">GetKeyByVersion</span><span class="p">(</span><span class="s">&#34;hello&#34;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">src</span><span class="p">.</span><span class="nf">GetKeyByVersion</span><span class="p">(</span><span class="s">&#34;hello&#34;</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span>
</span></span></code></pre></div><p><img src="https://image.syst.top/image/etcd/rev-2.png" alt="image">
å…¶ä»–å‚æ•°æš‚æ—¶å¿½ç•¥ï¼Œä¸»è¦çœ‹ Kvs é‡Œé¢çš„ç»“æœã€‚</p>
<h3 id="watch-æ“ä½œ">Watch æ“ä½œ</h3>
<p>å‘½ä»¤è¡Œ <code>./etcdctl watch hello</code></p>
<p>ä¸ºäº†é¿å…å®¢æˆ·ç«¯çš„åå¤è½®è¯¢ï¼Œ etcd æä¾›äº† event æœºåˆ¶ã€‚å®¢æˆ·ç«¯å¯ä»¥è®¢é˜…ä¸€ç³»åˆ—çš„ event ï¼Œç”¨äº watch æŸäº› key ã€‚
å½“è¿™äº›è¢« watch çš„ key æ›´æ–°æ—¶ï¼Œ etcd å°±ä¼šé€šçŸ¥å®¢æˆ·ç«¯ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// ç›‘å¬key å˜åŠ¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">WatchKey</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">watch</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nx">WatchChan</span>
</span></span><span class="line"><span class="cl">	<span class="nx">watch</span> <span class="p">=</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">res</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">watch</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;key:%vå˜åŠ¨é€šçŸ¥ï¼š%+v\n&#34;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;å€¼:%+v\n&#34;</span><span class="p">,</span> <span class="o">*</span><span class="nx">res</span><span class="p">.</span><span class="nx">Events</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å¯ä»¥ä»ä¸Šé¢è¿™æ®µä»£ç çœ‹å‡ºï¼Œwatch æ˜¯é€šè¿‡ channel çš„æ–¹å¼æ¥è¿›è¡Œé€šçŸ¥çš„</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// å¼€å¯ä¸€ä¸ª G
</span></span></span><span class="line"><span class="cl"><span class="c1">//	go src.WatchKey(&#34;hello&#34;)
</span></span></span></code></pre></div><p>ç„¶åæˆ‘ä»¬è¿è¡Œè¿™æ®µç¨‹åºï¼Œåœ¨å‘½ä»¤è¡Œä¸Šæ“ä½œ hello è¿™ä¸ª keyï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="p">.</span><span class="o">/</span><span class="nx">etcdctl</span> <span class="nx">lease</span> <span class="nx">grant</span> <span class="mi">30</span>
</span></span><span class="line"><span class="cl"><span class="nx">lease</span> <span class="mi">326978</span><span class="nx">bac638651e</span> <span class="nx">granted</span> <span class="nx">with</span> <span class="nf">TTL</span><span class="p">(</span><span class="mi">30</span><span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="o">/</span><span class="nx">etcdctl</span> <span class="nx">put</span> <span class="nx">hello</span> <span class="nx">world</span><span class="o">-</span><span class="nx">age</span> <span class="o">--</span><span class="nx">lease</span><span class="p">=</span><span class="mi">326978</span><span class="nx">bac638651e</span>
</span></span></code></pre></div><p><img src="https://image.syst.top/image/etcd/watch.png" alt="image">
å¯ä»¥çœ‹åˆ°æ¥æ”¶åˆ°ä¸¤ä¸ªäº‹ä»¶ï¼Œä¸€ä¸ªæ˜¯ putï¼Œä¸€ä¸ªæ˜¯ç§Ÿçº¦åˆ°æœŸ deleteã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>ä»¥ä¸‹æ˜¯è¿™ç¯‡æ–‡ç« å…¨éƒ¨ä»£ç </p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">src</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;flag&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/coreos/etcd/clientv3&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;strings&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">addr</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;addr&#34;</span><span class="p">,</span> <span class="s">&#34;http://127.0.0.1:2379&#34;</span><span class="p">,</span> <span class="s">&#34;etcd address&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">cli</span> <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">Client</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// åˆå§‹åŒ–etcd å®¢æˆ·ç«¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// è§£æetcdçš„åœ°å€ï¼Œç¼–ç¨‹[]string
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">endpoints</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="o">*</span><span class="nx">addr</span><span class="p">,</span> <span class="s">&#34;,&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// åˆ›å»ºä¸€ä¸ª etcd çš„å®¢æˆ·ç«¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">cli</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span><span class="nx">Endpoints</span><span class="p">:</span> <span class="nx">endpoints</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">DialTimeout</span><span class="p">:</span> <span class="mi">5</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;åˆå§‹åŒ–å®¢æˆ·ç«¯å¤±è´¥:%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// è®¾ç½®key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">PutKey</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">value</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">resp</span> <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">PutResponse</span>
</span></span><span class="line"><span class="cl">	<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;è®¾ç½® key å¤±è´¥:%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;æ“ä½œç»“æœï¼š%v\n&#34;</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// è®¾ç½®ä¼šè¿‡æœŸçš„key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">PutKeyLease</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">value</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">ttl</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">resp</span> <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">PutResponse</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// åˆ›å»ºä¸€ä¸ªç§Ÿçº¦å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">lease</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nx">Lease</span>
</span></span><span class="line"><span class="cl">	<span class="nx">lease</span> <span class="p">=</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nf">NewLease</span><span class="p">(</span><span class="nx">cli</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">leaseResp</span> <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">LeaseGrantResponse</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// æ ¹æ®æ—¶é—´ï¼Œç”Ÿæˆä¸€ä¸ªç§Ÿçº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">leaseResp</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">lease</span><span class="p">.</span><span class="nf">Grant</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">ttl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;è®¾ç½® ç§Ÿçº¦ å¤±è´¥:%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nf">WithLease</span><span class="p">(</span><span class="nx">leaseResp</span><span class="p">.</span><span class="nx">ID</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;è®¾ç½® key å¤±è´¥:%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;æ“ä½œç»“æœï¼š%v\n&#34;</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// è·å–key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">GetKey</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">res</span> <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">GetResponse</span>
</span></span><span class="line"><span class="cl">	<span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;è·å– key å¤±è´¥ :%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;key %v çš„å€¼æ˜¯ï¼š%+v\n&#34;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// è·å–æŒ‡å®šç‰ˆæœ¬çš„key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">GetKeyByVersion</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">version</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">res</span> <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">GetResponse</span>
</span></span><span class="line"><span class="cl">	<span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nf">WithRev</span><span class="p">(</span><span class="nx">version</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;åˆ é™¤ key:%v å¤±è´¥:%v&#34;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;è¯·æ±‚key:%v,è¯·æ±‚ç‰ˆæœ¬:%v,è·å–ç»“æœï¼š%+v\n&#34;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">version</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// åˆ é™¤key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">DeleteKey</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">res</span> <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">DeleteResponse</span>
</span></span><span class="line"><span class="cl">	<span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;åˆ é™¤ key:%v å¤±è´¥:%v&#34;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;æ“ä½œç»“æœï¼š%+v\n&#34;</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ç›‘å¬key å˜åŠ¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">WatchKey</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">watch</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nx">WatchChan</span>
</span></span><span class="line"><span class="cl">	<span class="nx">watch</span> <span class="p">=</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nf">WithRev</span><span class="p">(</span><span class="mi">21</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">res</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">watch</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;key:%vå˜åŠ¨é€šçŸ¥ï¼š%+v\n&#34;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;å€¼:%+v\n&#34;</span><span class="p">,</span> <span class="o">*</span><span class="nx">res</span><span class="p">.</span><span class="nx">Events</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†etcdè¿™ä¸ªåˆ†å¸ƒå¼å­˜å‚¨å·¥å…·ï¼ŒåŒ…æ‹¬å®ƒçš„åº”ç”¨åœºæ™¯ä»¥åŠå®æˆ˜åŸºæœ¬çš„æ“ä½œã€‚
ä¸Šé¢å…¶å®è¿˜æœ‰å¾ˆå¤šçš„å®ä¾‹æ²¡æœ‰å†™å‡ºæ¥ï¼Œä¸€ä¸ªæ˜¯å› ä¸ºæ‡’ï¼Œæ²¡å¿…è¦ä¸€ä¸ªä¸ªæ¼”ç¤ºä¸€éï¼Œå¦ä¸€ä¸ªåŸå› æ˜¯ç•™ç»™ä½ ä»¬è‡ªè¡Œå®ç°ã€‚
æˆ‘ä»¬ä»¥è¿™ä¸ªä¸ºå¼€å§‹ï¼Œä¸€æ­¥æ­¥æ•²å¼€ etcd çš„å¤§é—¨ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>etcd å®æˆ˜åŸºç¡€ç¯‡(äºŒ) </title>
			<link>https://www.syst.top/posts/go/etcd-2021-04-15/</link>
			<pubDate>Sat, 10 Apr 2021 09:54:52 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/etcd-2021-04-15/</guid>
			<description>ä¸Šä¸€ç¯‡æˆ‘ä»¬ä¸»è¦ä»‹ç»äº† etcd ä½¿ç”¨åœºæ™¯ä»¥åŠæœ€åŸºç¡€æ€§çš„ä¸€äº›æ“ä½œ(putã€getã€watch)ã€‚ è¿™ä¸€ç¯‡æˆ‘ä»¬æ¥ç€å®æˆ˜etcdå…¶ä»–ä¸šåŠ¡åœºæ™¯ã€‚
åŸºäº etcd çš„åˆ†å¸ƒå¼é” åŸºäº etcd å®ç°ä¸€ä¸ªåˆ†å¸ƒå¼é”ç‰¹åˆ«ç®€å•ã€‚etcd æä¾›äº†å¼€ç®±å³ç”¨çš„åŒ… concurrencyï¼Œå‡ è¡Œä»£ç å°±å®ç°ä¸€ä¸ªåˆ†å¸ƒå¼é”ã€‚
package src import ( &amp;#34;context&amp;#34; &amp;#34;flag&amp;#34; &amp;#34;fmt&amp;#34; &amp;#34;github.com/coreos/etcd/clientv3&amp;#34; &amp;#34;github.com/coreos/etcd/clientv3/concurrency&amp;#34; &amp;#34;log&amp;#34; &amp;#34;strings&amp;#34; &amp;#34;time&amp;#34; ) var addr = flag.String(&amp;#34;addr&amp;#34;, &amp;#34;http://127.0.0.1:2379&amp;#34;, &amp;#34;etcd address&amp;#34;) // åˆå§‹åŒ–etcdå®¢æˆ·ç«¯ func initEtcdClient() *clientv3.Client { var client *clientv3.Client var err error // è§£æetcdçš„åœ°å€ï¼Œç¼–ç¨‹[]string 	endpoints := strings.Split(*addr, &amp;#34;,&amp;#34;) // åˆ›å»ºä¸€ä¸ª etcd çš„å®¢æˆ·ç«¯ 	client, err = clientv3.New(clientv3.Config{Endpoints: endpoints, DialTimeout: 5 * time.Second}) if err != nil { fmt.</description>
			<content type="html"><![CDATA[<p>ä¸Šä¸€ç¯‡æˆ‘ä»¬ä¸»è¦ä»‹ç»äº† etcd ä½¿ç”¨åœºæ™¯ä»¥åŠæœ€åŸºç¡€æ€§çš„ä¸€äº›æ“ä½œ(putã€getã€watch)ã€‚ è¿™ä¸€ç¯‡æˆ‘ä»¬æ¥ç€å®æˆ˜etcdå…¶ä»–ä¸šåŠ¡åœºæ™¯ã€‚</p>
<h3 id="åŸºäº-etcd-çš„åˆ†å¸ƒå¼é”">åŸºäº etcd çš„åˆ†å¸ƒå¼é”</h3>
<p>åŸºäº etcd å®ç°ä¸€ä¸ªåˆ†å¸ƒå¼é”ç‰¹åˆ«ç®€å•ã€‚etcd æä¾›äº†å¼€ç®±å³ç”¨çš„åŒ… <code>concurrency</code>ï¼Œå‡ è¡Œä»£ç å°±å®ç°ä¸€ä¸ªåˆ†å¸ƒå¼é”ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">src</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;flag&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/coreos/etcd/clientv3&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/coreos/etcd/clientv3/concurrency&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;strings&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">addr</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;addr&#34;</span><span class="p">,</span> <span class="s">&#34;http://127.0.0.1:2379&#34;</span><span class="p">,</span> <span class="s">&#34;etcd address&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// åˆå§‹åŒ–etcdå®¢æˆ·ç«¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">initEtcdClient</span><span class="p">()</span> <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">Client</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">Client</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// è§£æetcdçš„åœ°å€ï¼Œç¼–ç¨‹[]string
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">endpoints</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="o">*</span><span class="nx">addr</span><span class="p">,</span> <span class="s">&#34;,&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// åˆ›å»ºä¸€ä¸ª etcd çš„å®¢æˆ·ç«¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span><span class="nx">Endpoints</span><span class="p">:</span> <span class="nx">endpoints</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">DialTimeout</span><span class="p">:</span> <span class="mi">5</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;åˆå§‹åŒ–å®¢æˆ·ç«¯å¤±è´¥:%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">client</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Lock</span><span class="p">(</span><span class="nx">id</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">lockName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">client</span> <span class="o">:=</span> <span class="nf">initEtcdClient</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// åˆ›å»ºä¸€ä¸ª session,å¦‚æœç¨‹åºå®•æœºå¥”æºƒï¼Œetcdå¯ä»¥çŸ¥é“
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">concurrency</span><span class="p">.</span><span class="nf">NewSession</span><span class="p">(</span><span class="nx">client</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">s</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// åˆ›å»ºä¸€ä¸ªetcd  locker
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">locker</span> <span class="o">:=</span> <span class="nx">concurrency</span><span class="p">.</span><span class="nf">NewLocker</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">lockName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;idï¼š%v å°è¯•è·å–é”%v&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">lockName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">locker</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;id:%vå–å¾—é”%v&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">lockName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// æ¨¡æ‹Ÿä¸šåŠ¡è€—æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span> <span class="o">*</span> <span class="mi">300</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">locker</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;id:%vé‡Šæ”¾é”%v&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">lockName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬å†å†™ä¸ªè„šæœ¬è¿è¡Œï¼Œçœ‹çœ‹ç»“æœã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;etcd-test/src&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;sync&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">lockName</span> <span class="p">=</span> <span class="s">&#34;locker-test&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">item</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">src</span><span class="p">.</span><span class="nf">Lock</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">lockName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}(</span><span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬å‘èµ·äº†10ä¸ªå¹¶å‘æŠ¢åŒä¸€ä¸ª key é”çš„å‘½ä»¤ã€‚è¿è¡Œç»“æœå¦‚ä¸‹ï¼Œ
<img src="https://image.syst.top/image/etcd/lock.png" alt="image"></p>
<p>ä»å›¾ç‰‡å¯ä»¥çœ‹åˆ°ï¼ŒåŒä¸€æ—¶åˆ»ä¸€å®šåªæœ‰ä¸€ä¸ª G å¾—åˆ°é”ï¼Œä¸€ä¸ª G è·å–åˆ°ä¸€ä¸ªé”çš„å‰æä¸€å®šæ˜¯å½“å‰ key æœªè¢«é”ã€‚</p>
<p>æœ‰äººè¦é—®äº†ï¼Œå½“ä¸€ä¸ªé”è§£å¼€æ—¶ï¼Œä¹‹å‰æœªè·å–åˆ°é”è€Œå‘ç”Ÿç­‰å¾…çš„å®¢æˆ·ç«¯è°å…ˆè·å–åˆ°è¿™æŠŠé”ï¼Ÿ è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åç»­åˆ†æåŸç†çš„æ—¶å€™å†æ­æ™“ã€‚</p>
<p>è¯´åˆ°åˆ†å¸ƒå¼é”ï¼Œä¸å¾—ä¸æèµ· redisã€‚å®ƒæœ‰ä¸€ä¸ªçœ‹ä¼¼å®‰å…¨å®é™…ä¸€ç‚¹éƒ½ä¸å®‰å…¨çš„åˆ†å¸ƒå¼é”ã€‚å®ƒçš„å‘½ä»¤æ¨¡å¼æ˜¯</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">set</span> <span class="nx">key</span> <span class="nx">value</span> <span class="p">[</span><span class="nx">EX</span> <span class="nx">seconds</span><span class="p">]</span> <span class="p">[</span><span class="nx">PX</span> <span class="nx">milliseconds</span><span class="p">]</span> <span class="p">[</span><span class="nx">NX</span><span class="p">|</span><span class="nx">XX</span><span class="p">]</span>
</span></span></code></pre></div><p>è¿™å…¶ä¸­ï¼Œä»‹ç»ä¸¤ä¸ªå…³é”®çš„å±æ€§:</p>
<ul>
<li>EX æ ‡ç¤ºè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå•ä½æ˜¯ç§’ã€‚</li>
<li>NX è¡¨ç¤º å½“å¯¹åº”çš„ key ä¸å­˜åœ¨æ—¶ï¼Œæ‰åˆ›å»ºã€‚</li>
</ul>
<p>æˆ‘ä»¬åœ¨ä½¿ç”¨ redis åšåˆ†å¸ƒå¼é”çš„æ—¶å€™ä¼šè¿™ä¹ˆå†™ã€‚(ä»£ç ç”¨äº†åŒ… <code>https://github.com/go-redis/redis</code>)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">RedisLock</span><span class="p">(</span><span class="nx">item</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rdb</span> <span class="p">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">redis</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Addr</span><span class="p">:</span>     <span class="s">&#34;127.0.0.1:6379&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Password</span><span class="p">:</span> <span class="s">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">DB</span><span class="p">:</span>       <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;item:%v å°è¯•è·å–é”,æ—¶é—´:%v\n&#34;</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">String</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="nx">res</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">rdb</span><span class="p">.</span><span class="nf">SetNX</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;key&#34;</span><span class="p">,</span> <span class="s">&#34;value&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">).</span><span class="nf">Result</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">res</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;item:%v å°è¯•è·å–é”å¤±è´¥\n&#34;</span><span class="p">,</span> <span class="nx">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;item:%v è·å–åˆ°é”,æ—¶é—´:%v\n&#34;</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">String</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span> <span class="c1">//æ¨¡æ‹Ÿä¸šåŠ¡è€—æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;item:%v é‡Šæ”¾é”ï¼Œæ—¶é—´:%v\n&#34;</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">String</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rdb</span><span class="p">.</span><span class="nf">Del</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;key&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">rdb</span><span class="p">.</span><span class="nf">SetNX</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;key&#34;</span><span class="p">,</span> <span class="s">&#34;value&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span></code></pre></div><p>æˆ‘ä»¬è§„å®šé”çš„è¿‡æœŸæ—¶é—´æ˜¯2ç§’ï¼Œä¸‹é¢æœ‰ä¸€å¥ <code>time.Sleep(1 * time.Second) </code> ç”¨æ¥æ¨¡æ‹Ÿå¤„ç†ä¸šåŠ¡çš„è€—æ—¶ã€‚ä¸šåŠ¡å¤„ç†ç»“æŸï¼Œæˆ‘ä»¬åˆ é™¤ key <code>rdb.Del(ctx, &quot;key&quot;)</code> ã€‚</p>
<p>æˆ‘ä»¬å†™ä¸ªç®€å•çš„è„šæœ¬ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">item</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nf">RedisLock</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}(</span><span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬å¼€å¯åä¸ª G å¹¶å‘çš„è°ƒç”¨ <code>RedisLock</code> å‡½æ•°ã€‚æ¯æ¬¡è°ƒç”¨ï¼Œå‡½æ•°å†…éƒ¨éƒ½ä¼šæ–°å»ºä¸€ä¸ª redis å®¢æˆ·ç«¯ï¼Œæœ¬è´¨ä¸Šæ˜¯10ä¸ªå®¢æˆ·ç«¯ã€‚</p>
<p>è¿è¡Œè¿™æ®µç¨‹åºï¼Œ</p>
<p><img src="https://image.syst.top/image/redis/lock-1.png" alt="image"></p>
<p>ä»å›¾ä¸­çœ‹å‡ºï¼ŒåŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯è·å–åˆ°é”ï¼Œå¹¶ä¸”åœ¨ä¸€ç§’çš„ä»»åŠ¡å¤„ç†åï¼Œé‡Šæ”¾äº†é”ï¼Œå¥½åƒæ²¡å¤ªå¤§çš„é—®é¢˜ã€‚</p>
<p>é‚£ä¹ˆï¼Œæˆ‘å†å†™ä¸€ä¸ªç®€å•çš„ä¾‹å­ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/go-redis/redis/v8&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;sync&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">rdb</span> <span class="o">*</span><span class="nx">redis</span><span class="p">.</span><span class="nx">Client</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
</span></span><span class="line"><span class="cl">	<span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nf">ExampleLock</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nf">ExampleLock</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">ExampleLock</span><span class="p">(</span><span class="nx">item</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">timeSleep</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rdb</span> <span class="p">=</span> <span class="nx">redis</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">redis</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Addr</span><span class="p">:</span>     <span class="s">&#34;127.0.0.1:6379&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Password</span><span class="p">:</span> <span class="s">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">DB</span><span class="p">:</span>       <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">timeSleep</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="nx">timeSleep</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;item:%v å°è¯•è·å–é”,æ—¶é—´:%v\n&#34;</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">String</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="nx">res</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">rdb</span><span class="p">.</span><span class="nf">SetNX</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;key&#34;</span><span class="p">,</span> <span class="s">&#34;value&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">).</span><span class="nf">Result</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">res</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;item:å°è¯•è·å–é”å¤±è´¥:%v\n&#34;</span><span class="p">,</span> <span class="nx">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;item:%v è·å–åˆ°é”,æ—¶é—´:%v\n&#34;</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">String</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">7</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;item:%v é‡Šæ”¾é”ï¼Œæ—¶é—´:%v\n&#34;</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">String</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rdb</span><span class="p">.</span><span class="nf">Del</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;key&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬è®¾ç½®é”çš„è¿‡æœŸæ—¶é—´æ˜¯ 3 ç§’ï¼Œè€Œè·å–é”ä¹‹åçš„ä»»åŠ¡å¤„ç†æ—¶é—´ä¸º 7 ç§’ã€‚</p>
<p>ç„¶åæˆ‘ä»¬å¼€å¯ä¸¤ä¸ª Gã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nf">ExampleLock</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">ExampleLock</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span></span></code></pre></div><p>å…¶ä¸­ç¬¬äºŒè¡Œæ•°å­—5ï¼Œä»ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ˜¯æŒ‡å¯åŠ¨ G åè¿‡5ç§’å»è·å–é”ã€‚</p>
<p>è¿™æ®µä»£ç æ•´ä½“æµç¨‹æ˜¯è¿™æ ·çš„:G(1) è·å–åˆ°é”åï¼Œè®¾ç½®çš„é”æŒæœ‰æ—¶é—´æ˜¯3ç§’ï¼Œç”±äºä»»åŠ¡æ‰§è¡Œéœ€è¦7ç§’çš„æ—¶é—´ï¼Œå› æ­¤åœ¨3ç§’è¿‡åé”ä¼šè‡ªåŠ¨é‡Šæ”¾ã€‚
G(2) å¯ä»¥åœ¨ç¬¬5ç§’çš„æ—¶å€™è·å–åˆ°é”ï¼Œç„¶åå®ƒæ‰§è¡Œä»»åŠ¡ä¹Ÿå¾—7ç§’ã€‚æœ€åï¼ŒG(1)åœ¨è·å–é”å7ç§’æ‰§è¡Œé‡Šæ”¾é”çš„æ“ä½œï¼ŒG(2)åŒç†ã€‚</p>
<p><img src="https://image.syst.top/image/redis/lock-2.png" alt="image"></p>
<p>å‘ç°é—®é¢˜äº†å—ï¼Ÿ</p>
<p>G(1) çš„é”åœ¨3ç§’åå·²ç»è‡ªåŠ¨é‡Šæ”¾äº†ã€‚ä½†æ˜¯åœ¨ä»»åŠ¡å¤„ç†ç»“æŸååˆæ‰§è¡Œäº†è§£é”çš„æ“ä½œ,å¯æ­¤æ—¶è¿™ä¸ªé”æ˜¯ G(2) çš„å‘€ã€‚</p>
<p>é‚£ä¹ˆæ¥ä¸‹æ¥ç”±äº G(1) è¯¯è§£äº† G(2) çš„é”ï¼Œå¦‚æœæ­¤æ—¶æœ‰å…¶ä»–çš„ Gï¼Œé‚£ä¹ˆå°±å¯ä»¥è·å–åˆ°é”ã€‚</p>
<p>ç­‰ G(2) ä»»åŠ¡æ‰§è¡Œç»“æŸï¼ŒåŒç†åˆä¼šè¯¯è§£å…¶ä»– G çš„é”ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¶æ€§å¾ªç¯ã€‚
è¿™ä¹Ÿæ˜¯æ˜é‡‘ä¸€ç¯‡ç”± redis åˆ†å¸ƒå¼é”é€ æˆèŒ…å°è¶…å–é‡å¤§äº‹æ•…çš„åŸå› ä¹‹ä¸€ã€‚</p>
<p>è‡³äºå…¶ä»–çš„ï¼Œå¯ä»¥è‡ªè¡ŒæŸ¥çœ‹è¿™ç¯‡æ–‡ç« [1]ã€‚</p>
<h3 id="åŸºäº-etcd-çš„åˆ†å¸ƒå¼é˜Ÿåˆ—">åŸºäº etcd çš„åˆ†å¸ƒå¼é˜Ÿåˆ—</h3>
<p>å¯¹é˜Ÿåˆ—æ›´å¤šçš„ç†è®ºçŸ¥è¯†å°±ä¸åŠ ä»¥ä»‹ç»äº†ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œé˜Ÿåˆ—æ˜¯ä¸€ç§å…ˆè¿›å…ˆå‡ºçš„æ•°æ®ç»“æ„ï¼Œä¸€èˆ¬ä¹Ÿåªæœ‰å…¥é˜Ÿå’Œå‡ºé˜Ÿä¸¤ç§æ“ä½œã€‚
æˆ‘ä»¬å¸¸å¸¸åœ¨å•æœºçš„åº”ç”¨ä¸­ä½¿ç”¨åˆ°é˜Ÿåˆ—ã€‚</p>
<p>é‚£ä¹ˆï¼Œå¦‚ä½•å®ç°ä¸€ä¸ªåˆ†å¸ƒå¼çš„é˜Ÿåˆ—å‘¢?ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ etcd å¼€ç®±å³ç”¨çš„å·¥å…·ï¼Œåœ¨ <code>etcd</code> åº•å±‚ <code>recipe</code> åŒ…é‡Œç»“æ„ <code>Queue</code>ï¼Œå®ç°äº†ä¸€ä¸ªå¤šè¯»å¤šå†™çš„åˆ†å¸ƒå¼é˜Ÿåˆ—ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Queue</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">client</span> <span class="o">*</span><span class="nx">v3</span><span class="p">.</span><span class="nx">Client</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ctx</span>    <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">keyPrefix</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewQueue</span><span class="p">(</span><span class="nx">client</span> <span class="o">*</span><span class="nx">v3</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span> <span class="nx">keyPrefix</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">Queue</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">q</span> <span class="o">*</span><span class="nx">Queue</span><span class="p">)</span> <span class="nf">Dequeue</span><span class="p">()</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">q</span> <span class="o">*</span><span class="nx">Queue</span><span class="p">)</span> <span class="nf">Enqueue</span><span class="p">(</span><span class="nx">val</span> <span class="kt">string</span><span class="p">)</span>
</span></span></code></pre></div><p>æˆ‘ä»¬åŸºäºæ­¤åŒ…å¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">src</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/coreos/etcd/clientv3&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">recipe</span> <span class="s">&#34;github.com/coreos/etcd/contrib/recipes&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;strconv&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;strings&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;sync&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">addr</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;addr&#34;</span><span class="p">,</span> <span class="s">&#34;http://127.0.0.1:2379&#34;</span><span class="p">,</span> <span class="s">&#34;etcd address&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// åˆå§‹åŒ–etcdå®¢æˆ·ç«¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">initEtcdClient</span><span class="p">()</span> <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">Client</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">Client</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// è§£æetcdçš„åœ°å€ï¼Œç¼–ç¨‹[]string
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">endpoints</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="o">*</span><span class="nx">addr</span><span class="p">,</span> <span class="s">&#34;,&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// åˆ›å»ºä¸€ä¸ª etcd çš„å®¢æˆ·ç«¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span><span class="nx">Endpoints</span><span class="p">:</span> <span class="nx">endpoints</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">DialTimeout</span><span class="p">:</span> <span class="mi">5</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;åˆå§‹åŒ–å®¢æˆ·ç«¯å¤±è´¥:%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">client</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Push</span><span class="p">(</span><span class="nx">keyName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">client</span> <span class="o">:=</span> <span class="nf">initEtcdClient</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">q</span> <span class="o">:=</span> <span class="nx">recipe</span><span class="p">.</span><span class="nf">NewQueue</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">keyName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">j</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="p">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">item</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">				<span class="nx">err</span> <span class="o">:=</span> <span class="nx">q</span><span class="p">.</span><span class="nf">Enqueue</span><span class="p">(</span><span class="nx">strconv</span><span class="p">.</span><span class="nf">Itoa</span><span class="p">(</span><span class="nx">item</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;push err:%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}(</span><span class="nx">j</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Pop</span><span class="p">(</span><span class="nx">keyName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">client</span> <span class="o">:=</span> <span class="nf">initEtcdClient</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">q</span> <span class="o">:=</span> <span class="nx">recipe</span><span class="p">.</span><span class="nf">NewQueue</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">keyName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">q</span><span class="p">.</span><span class="nf">Dequeue</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;æ¥æ”¶å€¼:%v\n&#34;</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>åœ¨ <code>push</code> ä¸­ï¼Œæˆ‘ä»¬å¼€å¯3è½®å‘é€å€¼å…¥é˜Ÿï¼Œæ¯æ¬¡å‘é€10ä¸ªï¼Œå‘é€ä¸€è½®ä¼‘æ¯2ç§’ã€‚
åœ¨ <code>pop</code> ä¸­ï¼Œé€šè¿‡æ­»å¾ªç¯è·å–é˜Ÿåˆ—ä¸­çš„å€¼ã€‚</p>
<p>è¿è¡Œè„šæœ¬ç¨‹åºå¦‚ä¸‹ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;etcd-test/src&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">key</span> <span class="o">:=</span> <span class="s">&#34;test-queue&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="nx">src</span><span class="p">.</span><span class="nf">Pop</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="nx">src</span><span class="p">.</span><span class="nf">Push</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">20</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬ä½¿ç”¨ä¸¤ä¸ª <code>G</code> ä»£è¡¨ åˆ†åˆ«è¿è¡Œ <code>push</code> å’Œ <code>pop</code> æ“ä½œã€‚
åŒæ—¶ä¸ºäº†è¾¾åˆ°è¿è¡Œæ•ˆæœï¼Œæˆ‘ä»¬å…ˆè¿è¡Œ <code>pop</code> ç­‰å¾…æœ‰å…¥é˜Ÿçš„å…ƒç´ ã€‚
è¿è¡Œç»“æœåŠ¨ç”»å¦‚ä¸‹,</p>
<p><img src="https://image.syst.top/image/etcd/queue.gif" alt="image"></p>
<p><code>etcd</code> è¿˜æä¾›äº†ä¼˜å…ˆçº§çš„åˆ†å¸ƒå¼çš„é˜Ÿåˆ—ã€‚å’Œä¸Šé¢çš„ç”¨æ³•ç›¸ä¼¼ã€‚åªæ˜¯åœ¨å…¥é˜Ÿçš„æ—¶å€™ï¼Œä¸ä»…ä»…éœ€è¦æä¾›ä¸€ä¸ªå€¼ï¼Œè¿˜éœ€è¦æä¾›ä¸€ä¸ªæ•´æ•°ï¼Œæ¥è¡¨ç¤ºå½“å‰ <code>push</code> å€¼çš„ä¼˜å…ˆçº§ã€‚æ•°å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ã€‚</p>
<p>æˆ‘ä»¬æ”¹åŠ¨ä¸€ä¸‹ä¸Šè¿°çš„ä»£ç ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">src</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/coreos/etcd/clientv3&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">recipe</span> <span class="s">&#34;github.com/coreos/etcd/contrib/recipes&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;strconv&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;strings&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;sync&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">addr</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;addr&#34;</span><span class="p">,</span> <span class="s">&#34;http://127.0.0.1:2379&#34;</span><span class="p">,</span> <span class="s">&#34;etcd address&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// åˆå§‹åŒ–etcdå®¢æˆ·ç«¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">initEtcdClient</span><span class="p">()</span> <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">Client</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">Client</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// è§£æetcdçš„åœ°å€ï¼Œç¼–ç¨‹[]string
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">endpoints</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="o">*</span><span class="nx">addr</span><span class="p">,</span> <span class="s">&#34;,&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// åˆ›å»ºä¸€ä¸ª etcd çš„å®¢æˆ·ç«¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span><span class="nx">Endpoints</span><span class="p">:</span> <span class="nx">endpoints</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">DialTimeout</span><span class="p">:</span> <span class="mi">5</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;åˆå§‹åŒ–å®¢æˆ·ç«¯å¤±è´¥:%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">client</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">PriorityPush</span><span class="p">(</span><span class="nx">keyName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">client</span> <span class="o">:=</span> <span class="nf">initEtcdClient</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">q</span> <span class="o">:=</span> <span class="nx">recipe</span><span class="p">.</span><span class="nf">NewPriorityQueue</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">keyName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">j</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="p">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">item</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">err</span> <span class="o">:=</span> <span class="nx">q</span><span class="p">.</span><span class="nf">Enqueue</span><span class="p">(</span><span class="nx">strconv</span><span class="p">.</span><span class="nf">Itoa</span><span class="p">(</span><span class="nx">item</span><span class="p">),</span> <span class="nb">uint16</span><span class="p">(</span><span class="nx">item</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;push err:%v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}(</span><span class="nx">j</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">PriorityPop</span><span class="p">(</span><span class="nx">keyName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">client</span> <span class="o">:=</span> <span class="nf">initEtcdClient</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">q</span> <span class="o">:=</span> <span class="nx">recipe</span><span class="p">.</span><span class="nf">NewPriorityQueue</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">keyName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">q</span><span class="p">.</span><span class="nf">Dequeue</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;æ¥æ”¶å€¼:%v\n&#34;</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ç„¶åä»¥ä¸‹æ˜¯æˆ‘ä»¬çš„æµ‹è¯•ä»£ç :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;etcd-test/src&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;sync&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">key</span> <span class="o">:=</span> <span class="s">&#34;test-queue&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
</span></span><span class="line"><span class="cl">	<span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">src</span><span class="p">.</span><span class="nf">PriorityPush</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="nx">src</span><span class="p">.</span><span class="nf">PriorityPop</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">20</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æˆ‘ä»¬æŠŠ0åˆ°9çš„æ•°å¹¶å‘çš„ <code>push</code> åˆ°é˜Ÿåˆ—ä¸­ï¼Œå¯¹åº”çš„ä¼˜å…ˆçº§æ•´æ•°å€¼å°±æ˜¯å®ƒæœ¬èº«ï¼Œ<code>push</code> å®Œæ¯•ï¼Œæˆ‘ä»¬è¿è¡Œ <code>PriorityPop</code> å‡½æ•°ï¼Œçœ‹æœ€ç»ˆç»“æœæ˜¾ç¤ºå°±æ˜¯ä»0åˆ°9ã€‚</p>
<p><img src="https://image.syst.top/image/etcd/queue-2.gif" alt="image"></p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨ etcd å®ç°åˆ†å¸ƒå¼é”ä»¥åŠåˆ†å¸ƒå¼é˜Ÿåˆ—ã€‚å…¶ä»–etcdçš„åœºæ™¯ï¼Œå¯ä»¥è‡ªè¡Œå®è·µã€‚</p>
<h3 id="é™„å½•">é™„å½•</h3>
<p>[1]
<a href="https://juejin.cn/post/6854573212831842311">https://juejin.cn/post/6854573212831842311</a></p>
]]></content>
		</item>
		
		<item>
			<title>ä½¿ç”¨ Go æ¯åˆ†é’Ÿå¤„ç†ç™¾ä¸‡è¯·æ±‚ </title>
			<link>https://www.syst.top/posts/go/handle-million-requests/</link>
			<pubDate>Mon, 05 Apr 2021 22:25:52 +0800</pubDate>
			
			<guid>https://www.syst.top/posts/go/handle-million-requests/</guid>
			<description>ä»‹ç» å¶ç„¶é—´çœ‹åˆ°ä¸€ç¯‡å†™äº15å¹´çš„æ–‡ç« ï¼Œè¯´å®è¯ï¼Œæ ‡é¢˜ç¡®å®å¸å¼•äº†æˆ‘ï¼Œä¸è¿‡çœ‹äº†å‡ éä¹‹åï¼Œç¡®å®ç²¾å½©ã€‚ å…³äºè¿™ç¯‡æ–‡ç« ï¼Œæˆ‘å°±ä¸ç›´æ¥ç¿»è¯‘äº†ã€‚ é¡¹ç›®çš„éœ€æ±‚å°±æ˜¯ å®¢æˆ·ç«¯å‘é€è¯·æ±‚ï¼ŒæœåŠ¡ç«¯æ¥æ”¶è¯·æ±‚å¤„ç†æ•°æ®(åŸæ–‡æ˜¯æŠŠèµ„æºä¸Šä¼ è‡³ Amazon S3 èµ„æºä¸­)ã€‚æœ¬è´¨ä¸Šå°±æ˜¯è¿™æ ·, æˆ‘ç¨å¾®æ”¹åŠ¨äº†åŸæ–‡çš„ä¸šåŠ¡ä»£ç ï¼Œä½†æ˜¯å¹¶ä¸å½±å“æ ¸å¿ƒæ¨¡å—ã€‚åœ¨ç¬¬ä¸€ç‰ˆä¸­ï¼Œæ¯æ”¶åˆ°ä¸€ä¸ª Request,å¼€å¯ä¸€ä¸ª G è¿›è¡Œå¤„ç†ï¼Œå¿«é€Ÿå“åº”ï¼Œå¾ˆå¸¸è§„çš„æ“ä½œã€‚
ä»£ç å¦‚ä¸‹
åˆç‰ˆ package main import ( &amp;#34;fmt&amp;#34; &amp;#34;log&amp;#34; &amp;#34;net/http&amp;#34; &amp;#34;time&amp;#34; ) type Payload struct { // ä¼ å•¥ä¸é‡è¦ } func (p *Payload) UpdateToS3() error { //å­˜å‚¨é€»è¾‘,æ¨¡æ‹Ÿæ“ä½œè€—æ—¶ 	time.Sleep(500 * time.Millisecond) fmt.Println(&amp;#34;ä¸Šä¼ æˆåŠŸ&amp;#34;) return nil } func payloadHandler(w http.ResponseWriter, r *http.Request) { // ä¸šåŠ¡è¿‡æ»¤ 	// è¯·æ±‚bodyè§£æ...... 	var p Payload go p.UpdateToS3() w.Write([]byte(&amp;#34;æ“ä½œæˆåŠŸ&amp;#34;)) } func main() { http.HandleFunc(&amp;#34;/payload&amp;#34;, payloadHandler) log.Fatal(http.ListenAndServe(&amp;#34;:8099&amp;#34;, nil)) } è¿™æ ·æ“ä½œå­˜åœ¨ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ²¡ä»€ä¹ˆé—®é¢˜ã€‚ä½†æ˜¯å¦‚æœæ˜¯é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œä¸å¯¹Gæ•°è¿›è¡Œæ§åˆ¶ï¼Œä½ çš„ CPU ä½¿ç”¨ç‡æš´æ¶¨ï¼Œå†…å­˜å ç”¨æš´æ¶¨ï¼Œç›´è‡³ç¨‹åºå¥”æºƒã€‚</description>
			<content type="html"><![CDATA[<h3 id="ä»‹ç»">ä»‹ç»</h3>
<p>å¶ç„¶é—´çœ‹åˆ°ä¸€ç¯‡å†™äº15å¹´çš„æ–‡ç« ï¼Œè¯´å®è¯ï¼Œæ ‡é¢˜ç¡®å®å¸å¼•äº†æˆ‘ï¼Œä¸è¿‡çœ‹äº†å‡ éä¹‹åï¼Œç¡®å®ç²¾å½©ã€‚ å…³äºè¿™ç¯‡æ–‡ç« ï¼Œæˆ‘å°±ä¸ç›´æ¥ç¿»è¯‘äº†ã€‚ é¡¹ç›®çš„éœ€æ±‚å°±æ˜¯ å®¢æˆ·ç«¯å‘é€è¯·æ±‚ï¼ŒæœåŠ¡ç«¯æ¥æ”¶è¯·æ±‚å¤„ç†æ•°æ®(åŸæ–‡æ˜¯æŠŠèµ„æºä¸Šä¼ è‡³ Amazon S3 èµ„æºä¸­)ã€‚æœ¬è´¨ä¸Šå°±æ˜¯è¿™æ ·,
<img src="https://image.syst.top/image/handle-million.png" alt="image"></p>
<p>æˆ‘ç¨å¾®æ”¹åŠ¨äº†åŸæ–‡çš„ä¸šåŠ¡ä»£ç ï¼Œä½†æ˜¯å¹¶ä¸å½±å“æ ¸å¿ƒæ¨¡å—ã€‚åœ¨ç¬¬ä¸€ç‰ˆä¸­ï¼Œæ¯æ”¶åˆ°ä¸€ä¸ª Request,å¼€å¯ä¸€ä¸ª G è¿›è¡Œå¤„ç†ï¼Œå¿«é€Ÿå“åº”ï¼Œå¾ˆå¸¸è§„çš„æ“ä½œã€‚</p>
<p>ä»£ç å¦‚ä¸‹</p>
<h3 id="åˆç‰ˆ">åˆç‰ˆ</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;net/http&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Payload</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ä¼ å•¥ä¸é‡è¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Payload</span><span class="p">)</span> <span class="nf">UpdateToS3</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//å­˜å‚¨é€»è¾‘,æ¨¡æ‹Ÿæ“ä½œè€—æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">500</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;ä¸Šä¼ æˆåŠŸ&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">payloadHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ä¸šåŠ¡è¿‡æ»¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// è¯·æ±‚bodyè§£æ......
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">p</span> <span class="nx">Payload</span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="nx">p</span><span class="p">.</span><span class="nf">UpdateToS3</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;æ“ä½œæˆåŠŸ&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">http</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/payload&#34;</span><span class="p">,</span> <span class="nx">payloadHandler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8099&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¿™æ ·æ“ä½œå­˜åœ¨ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ²¡ä»€ä¹ˆé—®é¢˜ã€‚ä½†æ˜¯å¦‚æœæ˜¯é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œä¸å¯¹Gæ•°è¿›è¡Œæ§åˆ¶ï¼Œä½ çš„ CPU ä½¿ç”¨ç‡æš´æ¶¨ï¼Œå†…å­˜å ç”¨æš´æ¶¨ï¼Œç›´è‡³ç¨‹åºå¥”æºƒã€‚</p>
<p>å¦‚æœæ­¤æ“ä½œè½åœ°è‡³æ•°æ®åº“ï¼Œä¾‹å¦‚mysql,é‚£ä¹ˆç›¸åº”çš„ï¼Œä½ æ•°æ®åº“çš„æœåŠ¡å™¨ç£ç›˜IOã€ç½‘ç»œå¸¦å®½
ã€CPUè´Ÿè½½ã€å†…å­˜æ¶ˆè€—éƒ½ä¼šè¾¾åˆ°éå¸¸é«˜çš„æƒ…å†µï¼Œä¸€å¹¶å¥”æºƒã€‚æ‰€ä»¥ï¼Œä¸€æ—¦ç¨‹åºä¸­å‡ºç°ä¸å¯æ§çš„äº‹ç‰©ï¼Œå¾€å¾€æ˜¯å±é™©çš„ä¿¡å·ã€‚</p>
<h3 id="ä¸­ç‰ˆ">ä¸­ç‰ˆ</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;net/http&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="nx">MaxQueue</span> <span class="p">=</span> <span class="mi">400</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">Queue</span> <span class="kd">chan</span> <span class="nx">Payload</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Queue</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">Payload</span><span class="p">,</span> <span class="nx">MaxQueue</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Payload</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ä¼ å•¥ä¸é‡è¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Payload</span><span class="p">)</span> <span class="nf">UpdateToS3</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//å­˜å‚¨é€»è¾‘,æ¨¡æ‹Ÿæ“ä½œè€—æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">500</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;ä¸Šä¼ æˆåŠŸ&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">payloadHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ä¸šåŠ¡è¿‡æ»¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// è¯·æ±‚bodyè§£æ......
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">p</span> <span class="nx">Payload</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//go p.UpdateToS3()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Queue</span> <span class="o">&lt;-</span> <span class="nx">p</span>
</span></span><span class="line"><span class="cl">	<span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;æ“ä½œæˆåŠŸ&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// å¤„ç†ä»»åŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">StartProcessor</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">payload</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">Queue</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">payload</span><span class="p">.</span><span class="nf">UpdateToS3</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">http</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/payload&#34;</span><span class="p">,</span> <span class="nx">payloadHandler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//å•ç‹¬å¼€ä¸€ä¸ªgæ¥æ”¶ä¸å¤„ç†ä»»åŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">go</span> <span class="nf">StartProcessor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8099&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¿™ä¸€ç‰ˆå€ŸåŠ©å¸¦ buffered çš„ channel æ¥å®Œæˆè¿™ä¸ªåŠŸèƒ½ï¼Œè¿™æ ·æ§åˆ¶ä½äº†æ— é™åˆ¶çš„Gï¼Œä½†æ˜¯ä¾ç„¶æ²¡æœ‰è§£å†³é—®é¢˜ã€‚</p>
<p>å¤„ç†è¯·æ±‚æ˜¯ä¸€ä¸ªåŒæ­¥çš„æ“ä½œï¼Œæ¯æ¬¡åªä¼šå¤„ç†ä¸€ä¸ªä»»åŠ¡ï¼Œç„¶è€Œé«˜å¹¶å‘ä¸‹è¯·æ±‚è¿›æ¥çš„é€Ÿåº¦è¿œè¿œè¶…è¿‡äº†å¤„ç†çš„é€Ÿåº¦ã€‚è¿™ç§æƒ…å†µï¼Œä¸€æ—¦ channel
æ»¡äº†ä¹‹åï¼Œ åç»­çš„è¯·æ±‚å°†ä¼šè¢«é˜»å¡ç­‰åœ°å•Šã€‚ç„¶åä½ ä¼šå‘ç°ï¼Œå“åº”çš„æ—¶é—´ä¼šå¤§å¹…åº¦çš„å¼€å§‹å¢åŠ ï¼Œ ç”šè‡³ä¸å†æœ‰ä»»ä½•çš„å“åº”ã€‚</p>
<h3 id="ç»ˆç‰ˆ">ç»ˆç‰ˆ</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;net/http&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">MaxWorker</span> <span class="p">=</span> <span class="mi">100</span> <span class="c1">//éšä¾¿è®¾ç½®å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">MaxQueue</span>  <span class="p">=</span> <span class="mi">200</span> <span class="c1">// éšä¾¿è®¾ç½®å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ä¸€ä¸ªå¯ä»¥å‘é€å·¥ä½œè¯·æ±‚çš„ç¼“å†² channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">JobQueue</span> <span class="kd">chan</span> <span class="nx">Job</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">JobQueue</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">Job</span><span class="p">,</span> <span class="nx">MaxQueue</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Payload</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Job</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">PayLoad</span> <span class="nx">Payload</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Worker</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">WorkerPool</span> <span class="kd">chan</span> <span class="kd">chan</span> <span class="nx">Job</span>
</span></span><span class="line"><span class="cl">	<span class="nx">JobChannel</span> <span class="kd">chan</span> <span class="nx">Job</span>
</span></span><span class="line"><span class="cl">	<span class="nx">quit</span>       <span class="kd">chan</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewWorker</span><span class="p">(</span><span class="nx">workerPool</span> <span class="kd">chan</span> <span class="kd">chan</span> <span class="nx">Job</span><span class="p">)</span> <span class="nx">Worker</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">Worker</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">WorkerPool</span><span class="p">:</span> <span class="nx">workerPool</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">JobChannel</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">Job</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">quit</span><span class="p">:</span>       <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Start æ–¹æ³•å¼€å¯ä¸€ä¸ª worker å¾ªç¯ï¼Œç›‘å¬é€€å‡º channelï¼Œå¯æŒ‰éœ€åœæ­¢è¿™ä¸ªå¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="nx">Worker</span><span class="p">)</span> <span class="nf">Start</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// å°†å½“å‰çš„ worker æ³¨å†Œåˆ° worker é˜Ÿåˆ—ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">w</span><span class="p">.</span><span class="nx">WorkerPool</span> <span class="o">&lt;-</span> <span class="nx">w</span><span class="p">.</span><span class="nx">JobChannel</span>
</span></span><span class="line"><span class="cl">			<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nx">job</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">w</span><span class="p">.</span><span class="nx">JobChannel</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// 	çœŸæ­£ä¸šåŠ¡çš„åœ°æ–¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="c1">//	æ¨¡æ‹Ÿæ“ä½œè€—æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">500</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;ä¸Šä¼ æˆåŠŸ:%v\n&#34;</span><span class="p">,</span> <span class="nx">job</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">w</span><span class="p">.</span><span class="nx">quit</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="nx">Worker</span><span class="p">)</span> <span class="nf">stop</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">w</span><span class="p">.</span><span class="nx">quit</span> <span class="o">&lt;-</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// åˆå§‹åŒ–æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Dispatcher</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// æ³¨å†Œåˆ° dispatcher çš„ worker channel æ± 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">WorkerPool</span> <span class="kd">chan</span> <span class="kd">chan</span> <span class="nx">Job</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewDispatcher</span><span class="p">(</span><span class="nx">maxWorkers</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="nx">Dispatcher</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pool</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">chan</span> <span class="nx">Job</span><span class="p">,</span> <span class="nx">maxWorkers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">Dispatcher</span><span class="p">{</span><span class="nx">WorkerPool</span><span class="p">:</span> <span class="nx">pool</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">Dispatcher</span><span class="p">)</span> <span class="nf">Run</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// å¼€å§‹è¿è¡Œ n ä¸ª worker
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">MaxWorker</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">worker</span> <span class="o">:=</span> <span class="nf">NewWorker</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">WorkerPool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">worker</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="nx">d</span><span class="p">.</span><span class="nf">dispatch</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">Dispatcher</span><span class="p">)</span> <span class="nf">dispatch</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">job</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">JobQueue</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">job</span> <span class="nx">Job</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// å°è¯•è·å–ä¸€ä¸ªå¯ç”¨çš„ worker job channelï¼Œé˜»å¡ç›´åˆ°æœ‰å¯ç”¨çš„ worker
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nx">jobChannel</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">d</span><span class="p">.</span><span class="nx">WorkerPool</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// åˆ†å‘ä»»åŠ¡åˆ° worker job channel ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nx">jobChannel</span> <span class="o">&lt;-</span> <span class="nx">job</span>
</span></span><span class="line"><span class="cl">			<span class="p">}(</span><span class="nx">job</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// æ¥æ”¶è¯·æ±‚ï¼ŒæŠŠä»»åŠ¡ç­›å…¥JobQueueã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">payloadHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">work</span> <span class="o">:=</span> <span class="nx">Job</span><span class="p">{</span><span class="nx">PayLoad</span><span class="p">:</span> <span class="nx">Payload</span><span class="p">{}}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">JobQueue</span> <span class="o">&lt;-</span> <span class="nx">work</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;æ“ä½œæˆåŠŸ&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// é€šè¿‡è°ƒåº¦å™¨åˆ›å»ºworkerï¼Œç›‘å¬æ¥è‡ª JobQueueçš„ä»»åŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">d</span> <span class="o">:=</span> <span class="nf">NewDispatcher</span><span class="p">(</span><span class="nx">MaxWorker</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">d</span><span class="p">.</span><span class="nf">Run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">http</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/payload&#34;</span><span class="p">,</span> <span class="nx">payloadHandler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8099&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æœ€ç»ˆé‡‡ç”¨çš„æ˜¯ä¸¤çº§ channelï¼Œä¸€çº§æ˜¯å°†ç”¨æˆ·è¯·æ±‚æ•°æ®æ”¾å…¥åˆ° chan Job ä¸­ï¼Œè¿™ä¸ª channel job ç›¸å½“äºå¾…å¤„ç†çš„ä»»åŠ¡é˜Ÿåˆ—ã€‚</p>
<p>å¦ä¸€çº§ç”¨æ¥å­˜æ”¾å¯ä»¥å¤„ç†ä»»åŠ¡çš„ work ç¼“å­˜é˜Ÿåˆ—ï¼Œç±»å‹ä¸º chan chan Jobã€‚è°ƒåº¦å™¨æŠŠå¾…å¤„ç†çš„ä»»åŠ¡æ”¾å…¥ä¸€ä¸ªç©ºé—²çš„ç¼“å­˜é˜Ÿåˆ—å½“ä¸­ï¼Œwork ä¼šä¸€ç›´å¤„ç†å®ƒçš„ç¼“å­˜é˜Ÿåˆ—ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå®ç°äº†ä¸€ä¸ª worker æ± ã€‚å¤§è‡´ç”»äº†ä¸€ä¸ªå›¾å¸®åŠ©ç†è§£
<img src="https://image.syst.top/image/work-pool.png" alt="image"></p>
<p>é¦–å…ˆæˆ‘ä»¬åœ¨æ¥æ”¶åˆ°ä¸€ä¸ªè¯·æ±‚åï¼Œåˆ›å»º Job ä»»åŠ¡ï¼ŒæŠŠå®ƒæ”¾å…¥åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ç­‰å¾… work æ± å¤„ç†ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">payloadHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">work</span> <span class="o">:=</span> <span class="nx">Job</span><span class="p">{</span><span class="nx">PayLoad</span><span class="p">:</span> <span class="nx">Payload</span><span class="p">{}}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">JobQueue</span> <span class="o">&lt;-</span> <span class="nx">work</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;æ“ä½œæˆåŠŸ&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è°ƒåº¦å™¨åˆå§‹åŒ–workæ± åï¼Œåœ¨ dispatch ä¸­ï¼Œä¸€æ—¦æˆ‘ä»¬æ¥æ”¶åˆ° JobQueue çš„ä»»åŠ¡ï¼Œå°±å»å°è¯•è·å–ä¸€ä¸ªå¯ç”¨çš„ workerï¼Œåˆ†å‘ä»»åŠ¡ç»™ worker çš„ job channel ä¸­ã€‚ æ³¨æ„è¿™ä¸ªè¿‡ç¨‹ä¸æ˜¯åŒæ­¥çš„ï¼Œè€Œæ˜¯æ¯æ¥æ”¶åˆ°ä¸€ä¸ª jobï¼Œå°±å¼€å¯ä¸€ä¸ª G å»å¤„ç†ã€‚è¿™æ ·å¯ä»¥ä¿è¯ JobQueue ä¸éœ€è¦è¿›è¡Œé˜»å¡ï¼Œå¯¹åº”çš„å¾€ JobQueue ç†è®ºä¸Šä¹Ÿä¸éœ€è¦é˜»å¡åœ°å†™å…¥ä»»åŠ¡ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">Dispatcher</span><span class="p">)</span> <span class="nf">Run</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// å¼€å§‹è¿è¡Œ n ä¸ª worker
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">MaxWorker</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">worker</span> <span class="o">:=</span> <span class="nf">NewWorker</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">WorkerPool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">worker</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="nx">d</span><span class="p">.</span><span class="nf">dispatch</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">Dispatcher</span><span class="p">)</span> <span class="nf">dispatch</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">job</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">JobQueue</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">job</span> <span class="nx">Job</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// å°è¯•è·å–ä¸€ä¸ªå¯ç”¨çš„ worker job channelï¼Œé˜»å¡ç›´åˆ°æœ‰å¯ç”¨çš„ worker
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nx">jobChannel</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">d</span><span class="p">.</span><span class="nx">WorkerPool</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// åˆ†å‘ä»»åŠ¡åˆ° worker job channel ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nx">jobChannel</span> <span class="o">&lt;-</span> <span class="nx">job</span>
</span></span><span class="line"><span class="cl">			<span class="p">}(</span><span class="nx">job</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¿™é‡Œ&quot;ä¸å¯æ§&quot;çš„ G å’Œä¸Šé¢è¿˜æ˜¯åˆæ‰€ä¸åŒçš„ã€‚ä»…ä»…æçŸ­æ—¶é—´å†…å¤„äºé˜»å¡è¯» Chan çŠ¶æ€ï¼Œ å½“æœ‰ç©ºé—²çš„ worker è¢«å”¤é†’ï¼Œç„¶ååˆ†å‘ä»»åŠ¡ï¼Œæ•´ä¸ªç”Ÿå‘½å‘¨æœŸè¿œè¿œçŸ­äºä¸Šé¢çš„æ“ä½œã€‚</p>
<p>æœ€åï¼Œå¼ºçƒˆå»ºè®®çœ‹ä¸€ä¸‹åŸæ–‡ï¼ŒåŸæ–‡åœ°å€åœ¨ï¼šhttp://marcio.io/2015/07/handling-1-million-requests-per-minute-with-golang/</p>
<h3 id="æœ€ç»ˆæ–¹æ¡ˆ">æœ€ç»ˆæ–¹æ¡ˆ</h3>
]]></content>
		</item>
		
	</channel>
</rss>
